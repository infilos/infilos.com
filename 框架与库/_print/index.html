<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>框架库 | infilos.com</title><meta property="og:title" content="框架库">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="框架库">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="框架库">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>框架库</h1>
<ul>
<li>1: <a href=#pg-2ec71341b8ce816d988919fa56fdc511>Spring</a></li>
<ul>
<li>1.1: <a href=#pg-0b0012bf149a4cf96b8074281a8541a8>CH01-IOC</a></li>
<li>1.2: <a href=#pg-2a6c4c04bf13071ae484b315e9244cd2>CH02-Spring IOC</a></li>
<li>1.3: <a href=#pg-7202eaa44b8f3d3daee17478a4ca42ec>CH03-Bean加载</a></li>
<li>1.4: <a href=#pg-a8a1a8038660c1cf3b1cbee6a84a454c>CH04-IOC源码</a></li>
<li>1.5: <a href=#pg-7f4178b3d93842e955c6e1949a1a8205>CH05-循环依赖</a></li>
<li>1.6: <a href=#pg-c6fbf53ed8e298648885933a5a812487>CH07-动态代理</a></li>
<li>1.7: <a href=#pg-0460c594127706aa4329eb8831b746b4>CH08-接口定义</a></li>
<li>1.8: <a href=#pg-914aed954c02642f85974bcb8e314a42>CH09-请求过程</a></li>
<li>1.9: <a href=#pg-f318ab73b27584f92427d5fdaeaa969e>CH10-配置注入</a></li>
<li>1.10: <a href=#pg-edd784317807198b5ce95957ab1805fa>CH11-配置绑定</a></li>
<li>1.11: <a href=#pg-72976b5fc4d547c63c1244ea27bda80b>CH12-环境变量</a></li>
</ul>
<li>2: <a href=#pg-039b5c839fd17f348bd6285b0e09c8a0>Spring IOC</a></li>
<ul>
<li>2.1: <a href=#pg-058d34bd471ff0fb89f33ccbc6c6f744>CH01-获取单例 Bean</a></li>
<li>2.2: <a href=#pg-f162112b468f360d336fef678e9e61c1>CH02-创建单例 Bean</a></li>
<li>2.3: <a href=#pg-134a7abbdac972a86f3f7920807642b0>CH03-创建原始 Bean 对象</a></li>
<li>2.4: <a href=#pg-f226756c00275a43d5e85dc95b38990e>CH04-解决循环依赖</a></li>
<li>2.5: <a href=#pg-d9a521069fb4cad9079c5b918a21c5a1>CH05-原始 Bean 属性填充</a></li>
<li>2.6: <a href=#pg-af78074eb9a0b37dec4c27ffbf65a82b>CH06-后续初始化工作</a></li>
<li>2.7: <a href=#pg-df482e7d67cbcb67a71beecf0e6e8c46>CH07-生命周期扩展</a></li>
<li>2.8: <a href=#pg-b51917ad9041bab714580f7b22d13d9b>CH08-控制加载顺序</a></li>
</ul>
<li>3: <a href=#pg-8cd9b12dd975c73df503ba9175609189>Spring AOP</a></li>
<ul>
<li>3.1: <a href=#pg-f1cf3ad474cbe8e0f22061af8a0afc86>AOP 理论</a></li>
<li>3.2: <a href=#pg-6cd40205393a6545176585a42ce0a584>AOP 实战</a></li>
</ul>
<li>4: <a href=#pg-29e1458ad73683edde81bbb86dd3cdec>Mybatis</a></li>
<ul>
<li>4.1: <a href=#pg-dd52fe1a10710f0961ee3c2e2b522a33>CH01-整体架构</a></li>
<li>4.2: <a href=#pg-773d776c2e66e11b838e4ab33514e4c1>CH02-反射模块</a></li>
<li>4.3: <a href=#pg-499db58c0f961451e8ac888520e1c5fa>CH03-基础支持模块</a></li>
<li>4.4: <a href=#pg-5b7e738c6d50dab8aea897b0c9b16a6f>CH04-运行配置解析</a></li>
<li>4.5: <a href=#pg-125a1275eb4845ae03d56a1d156b0d92>CH05-通用配置解析</a></li>
<li>4.6: <a href=#pg-a9c6c53bbe0dedfdf1ef1b445f90dcb1>CH06-语句解析</a></li>
<li>4.7: <a href=#pg-76dd90616bec5587f31bc2e5f663b91b>CH07-接口层</a></li>
<li>4.8: <a href=#pg-c2f0467d2acc81697b3d21a42afa4ddb>CH08-执行器</a></li>
<li>4.9: <a href=#pg-dd0af738f6f6eeb4e6c0c4aeb3162eaa>CH09-集成 Spring</a></li>
<li>4.10: <a href=#pg-08516932d642ae0a720b5753a346bba3>CH10-整体流程</a></li>
<li>4.11: <a href=#pg-14222f79d12931239488c3ab405189f6>CH11-插件机制</a></li>
<li>4.12: <a href=#pg-68611e2d64eb5f1709d53542acbd61f4>CH12-代码生成</a></li>
<li>4.13: <a href=#pg-1b4c6af1cc9c41504ec2b73cde59980f>CH13-多数据源</a></li>
<li>4.14: <a href=#pg-6381d54b4f53832189fba7dda04feff4>CH14-常用片段</a></li>
</ul>
<li>5: <a href=#pg-c1e8f2365fc6e91852aa984062de81f7>Hikari</a></li>
<ul>
<li>5.1: <a href=#pg-4044b0e6448e84d3abca221838625d38>基本概念</a></li>
<li>5.2: <a href=#pg-d65e1cea2e403108cd2bf982d6f46006>开源实现</a></li>
<li>5.3: <a href=#pg-bf5289a54cb90ff13efab472717f661d>配置参数</a></li>
<li>5.4: <a href=#pg-69b3ca93e755caee774ee61d37a37b29>JDBC API</a></li>
<li>5.5: <a href=#pg-4b9d150e32675cf552baf43c5f76029b>性能原理</a></li>
<li>5.6: <a href=#pg-15ec1a8762b47ae9a5a642074c2fb45b>优化原理</a></li>
<li>5.7: <a href=#pg-a68d253e10a456aa43583ccceb08ed00>参数解析</a></li>
<li>5.8: <a href=#pg-0571ba633db8293a9c18653c90e33707>动态代理</a></li>
<li>5.9: <a href=#pg-563c823956cc6c18f29bf3dac344c4ed>应用实践</a></li>
<li>5.10: <a href=#pg-fd9d53e36c38a6c8387036a57dd6ad34>监控度量</a></li>
<li>5.11: <a href=#pg-d0760fe5aebcb44b4fb0547d4e258a2f>常见问题</a></li>
<li>5.12: <a href=#pg-132362e06a52e754bd5f4df7fdd855b0>扩展技术</a></li>
</ul>
<li>6: <a href=#pg-3d1e7c2a6f7ffc9f4f8eab6963ee28b0>Udf Modeling</a></li>
<ul>
<li>6.1: <a href=#pg-44b7f71194b5e8e3e24267b6e8584135>Transport UDF at Linkedin</a></li>
<li>6.2: <a href=#pg-7b184dd3e82373d1771186dcbfbbe498>Flink Type System</a></li>
</ul>
<li>7: <a href=#pg-87d04a505f4113248f48de1fa6ff0993>Parboiled</a></li>
<ul>
<li>7.1: <a href=#pg-9128c2dc49c622f7600933c8d1ea1035>CH01-Motivation</a></li>
<li>7.2: <a href=#pg-05a361d8cd94e1828f1031c78fe17a96>CH02-Features</a></li>
<li>7.3: <a href=#pg-c01e1d6286ccead6f7f8fe20b1de6a82>CH03-Java Example</a></li>
<li>7.4: <a href=#pg-58a76c5a3dcaf6862a60be2d58ff89be>CH04-Scala Example</a></li>
<li>7.5: <a href=#pg-aefd071109bac895cd9af8eb4428de7d>CH05-Comparison</a></li>
<li>7.6: <a href=#pg-0b8da0caaa67951e41a357509aa1eb83>CH06-Concepts</a></li>
<li>7.7: <a href=#pg-63d9481a39ef551c7e8a0cb56828ef77>CH07-Java APIs</a></li>
<li>7.8: <a href=#pg-e7fc3f9332a7db16b99b057d62a76d6f>CH08-Scala APIs</a></li>
<li>7.9: <a href=#pg-d172300b36f276e75efe2961e9416e8d>CH09-Advanced Topics</a></li>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-2ec71341b8ce816d988919fa56fdc511>1 - Spring</h1>
</div>
<div class=td-content>
<h1 id=pg-0b0012bf149a4cf96b8074281a8541a8>1.1 - CH01-IOC</h1>
<h2 id=ioc-是什么>IOC 是什么</h2>
<p>**IoC，是 Inversion of Control 的缩写，即控制反转。*<em>他还有一个别名叫*<em>依赖注入</em></em>（Dependency Injection）有些资料也称依赖注入是IOC的一种常见方式。</p>
<p>IoC 不是什么技术，而是一种设计思想。在 Java 开发中，IoC 意味着将你设计好的对象交给容器控制，而不是传统的在你的对象内部直接控制。如何理解 Ioc 呢？理解 Ioc 的关键是要明确“谁控制谁，控制什么，为何是反转（有反转就应该有正转了），哪些方面反转了”，那我们来深入分析一下：</p>
<ul>
<li>**谁控制谁，控制什么：**传统 JavaSE 程序设计，我们直接在对象内部通过 new 进行创建对象，是程序主动去创建依赖对象；而 IoC 是有专门一个容器来创建这些对象，即由 IoC 容器来控制对象的创建；谁控制谁？当然是 IoC 容器控制了对象；控制什么？那就是主要控制了外部资源获取（不只是对象包括比如文件等）。</li>
<li>**为何是反转，哪些方面反转了：**有反转就有正转，传统应用程序是由我们自己在对象中主动控制去直接获取依赖对象，也就是正转；而反转则是由容器来帮忙创建及注入依赖对象；为何是反转？因为由容器帮我们查找及注入依赖对象，对象只是被动的接受依赖对象，所以是反转；哪些方面反转了？依赖对象的获取方式被反转了。</li>
</ul>
<h2 id=ioc-能做什么>IOC 能做什么</h2>
<p>IoC 不是一种技术，只是一种思想，一个重要的面向对象编程的法则，它能指导我们如何设计出松耦合、更优良的程序。传统应用程序都是由我们在类内部主动创建依赖对象，从而导致类与类之间高耦合，难于测试；有了 IoC 容器后，把创建和查找依赖对象的控制权交给了容器，由容器进行注入组合对象，所以对象与对象之间是松散耦合，这样也方便测试，利于功能复用，更重要的是使得程序的整个体系结构变得非常灵活。</p>
<p>其实 IoC 对编程带来的最大改变不是从代码上，而是从思想上，发生了“主从换位”的变化。应用程序原本是老大，要获取什么资源都是主动出击，但是在 IoC/DI 思想中，应用程序就变成被动的了，被动的等待 IoC 容器来创建并注入它所需要的资源了。</p>
<p>IoC 很好的体现了面向对象设计法则之一—— 好莱坞法则：“Don&rsquo;t call us,we will call you”；即由 IoC 容器帮对象找相应的依赖对象并注入，而不是由对象主动去找。</p>
<h3 id=依赖注入>依赖注入</h3>
<p>DI，是 <strong>Dependency Injection</strong> 的缩写，即依赖注入。依赖注入是 IoC 的最常见形式。</p>
<p>容器全权负责的组件的装配，它会把符合依赖关系的对象通过 JavaBean 属性或者构造函数传递给需要的对象。</p>
<p>DI 是组件之间依赖关系由容器在运行期决定，形象的说，即由容器动态的将某个依赖关系注入到组件之中。依赖注入的目的并非为软件系统带来更多功能，而是为了提升组件重用的频率，并为系统搭建一个灵活、可扩展的平台。通过依赖注入机制，我们只需要通过简单的配置，而无需任何代码就可指定目标需要的资源，完成自身的业务逻辑，而不需要关心具体的资源来自何处，由谁实现。</p>
<p>理解 DI 的关键是：“谁依赖谁，为什么需要依赖，谁注入谁，注入了什么”，那我们来深入分析一下：</p>
<ul>
<li>**谁依赖于谁：**当然是应用程序依赖于 IoC 容器；</li>
<li>**为什么需要依赖：**应用程序需要 IoC 容器来提供对象需要的外部资源；</li>
<li>**谁注入谁：**很明显是 IoC 容器注入应用程序某个对象，应用程序依赖的对象；</li>
<li><strong>注入了什么</strong>：就是注入某个对象所需要的外部资源（包括对象、资源、常量数据）。</li>
</ul>
<h3 id=ioc-与-di>IOC 与 DI</h3>
<p>其实它们是同一个概念的不同角度描述，由于控制反转概念比较含糊（可能只是理解为容器控制对象这一个层面，很难让人想到谁来维护对象关系），所以 2004 年大师级人物 Martin Fowler 又给出了一个新的名字：“依赖注入”，相对 IoC 而言，“依赖注入”明确描述了“被注入对象依赖 IoC 容器配置依赖对象”。</p>
<blockquote>
<p><a href=http://www.martinfowler.com/articles/injection.html>Martin Fowler—Inversion of Control Containers and the Dependency Injection pattern</a></p>
</blockquote>
<h3 id=ioc-容器>IOC 容器</h3>
<p>IoC 容器就是具有依赖注入功能的容器。IoC 容器负责实例化、定位、配置应用程序中的对象及建立这些对象间的依赖。应用程序无需直接在代码中 new 相关的对象，应用程序由 IoC 容器进行组装。在 Spring 中 BeanFactory 是 IoC 容器的实际代表者。</p>
<p>Spring IoC 容器如何知道哪些是它管理的对象呢？这就需要配置文件，Spring IoC 容器通过读取配置文件中的配置元数据，通过元数据对应用中的各个对象进行实例化及装配。一般使用基于 xml 配置文件进行配置元数据，而且 Spring 与配置文件完全解耦的，可以使用其他任何可能的方式进行配置元数据，比如注解、基于 java 文件的、基于属性文件的配置都可以</p>
<p>那 Spring IoC 容器管理的对象叫什么呢？</p>
<h3 id=bean>Bean</h3>
<p>JavaBean 是一种JAVA语言写成的可重用组件。为写成JavaBean，类必须是具体的和公共的，并且具有<strong>无参数的构造器</strong>。JavaBean 通过提供符合一致性设计模式的公共方法（getter / setter 方法）将内部域暴露成员属性。众所周知，属性名称符合这种模式，其他Java 类可以通过自省机制发现和操作这些JavaBean 的属性。</p>
<p>一个javaBean由三部分组成：<strong>属性、方法、事件</strong></p>
<p>JavaBean的任务就是: “Write once, run anywhere, reuse everywhere”，即“一次性编写，任何地方执行，任何地方重用”。</p>
<p>由 IoC 容器管理的那些组成你应用程序的对象我们就叫它 Bean。Bean 就是由 Spring 容器初始化、装配及管理的对象，除此之外，bean 就与应用程序中的其他对象没有什么区别了。</p>
<h2 id=ioc-容器-1>IOC 容器</h2>
<h3 id=核心接口>核心接口</h3>
<p><code>org.springframework.beans</code> 和 <code>org.springframework.context</code> 是 IoC 容器的基础。</p>
<p>在 Spring 中，有两种 IoC 容器：<code>BeanFactory</code> 和 <code>ApplicationContext</code>。</p>
<ul>
<li><code>BeanFactory</code>：Spring 实例化、配置和管理对象的最基本接口。</li>
<li><code>ApplicationContext</code>：BeanFactory 的子接口。它还扩展了其他一些接口，以支持更丰富的功能，如：国际化、访问资源、事件机制、更方便的支持 AOP、在 web 应用中指定应用层上下文等。</li>
</ul>
<p>实际开发中，更推荐使用 <code>ApplicationContext</code> 作为 IoC 容器的操作入口，因为它的功能远多于 <code>FactoryBean</code>。</p>
<p>常见 <code>ApplicationContext</code> 实现：</p>
<ul>
<li><strong>ClassPathXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从 classpath 获取配置文件；
<ul>
<li><code>new ClassPathXmlApplicationContext("classpath.xml");</code></li>
</ul>
</li>
<li><strong>FileSystemXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从文件系统获取配置文件。
<ul>
<li><code>new FileSystemXmlApplicationContext("fileSystemConfig.xml");</code></li>
</ul>
</li>
</ul>
<h3 id=应用流程>应用流程</h3>
<p>使用 IoC 容器可分为三步骤：</p>
<ol>
<li>配置元数据：需要配置一些元数据来告诉 Spring，你希望容器如何工作，具体来说，就是如何去初始化、配置、管理 JavaBean 对象。</li>
<li>实例化容器：由 IoC 容器解析配置的元数据。IoC 容器的 Bean Reader 读取并解析配置文件，根据定义生成 BeanDefinition 配置元数据对象，IoC 容器根据 BeanDefinition 进行实例化、配置及组装 Bean。</li>
<li>使用容器：由客户端实例化容器，获取需要的 Bean。</li>
</ol>
<h3 id=配置元数据>配置元数据</h3>
<blockquote>
<p><strong>元数据（Metadata）</strong> 又称中介数据、中继数据，为描述数据的数据（data about data），主要是描述数据属性（property）的信息。</p>
</blockquote>
<p>配置元数据的方式：</p>
<ul>
<li>
<p><strong>基于 xml 配置</strong>：Spring 的传统配置方式。在 <code>&lt;beans></code> 标签中配置元数据内容。</p>
<p>缺点是当 JavaBean 过多时，产生的配置文件足以让你眼花缭乱。</p>
</li>
<li>
<p><strong>基于注解配置</strong>：Spring2.5 引入。可以大大简化你的配置。</p>
</li>
<li>
<p><strong>基于 Java 配置</strong>：可以使用 Java 类来定义 JavaBean 。</p>
<p>为了使用这个新特性，需要用到 <code>@Configuration</code> 、<code>@Bean</code> 、<code>@Import</code> 和 <code>@DependsOn</code> 注解。</p>
</li>
</ul>
<h3 id=bean-概述>Bean 概述</h3>
<p>一个 Spring 容器管理一个或多个 bean。 这些 bean 根据你配置的元数据（比如 xml 形式）来创建。 Spring IoC 容器本身，并不能识别你配置的元数据。为此，要将这些配置信息转为 Spring 能识别的格式——BeanDefinition 对象。</p>
<h4 id=命名-bean>命名 Bean</h4>
<p>指定 id 和 name 属性不是必须的。 Spring 中，并非一定要指定 id 和 name 属性。实际上，Spring 会自动为其分配一个特殊名。 如果你需要引用声明的 bean，这时你才需要一个标识。官方推荐驼峰命名法来命名。</p>
<h4 id=支持别名>支持别名</h4>
<p>可能存在这样的场景，不同系统中对于同一 bean 的命名方式不一样。 为了适配，Spring 支持 <code>&lt;alias></code> 为 bean 添加别名的功能。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;subsystemA-dataSource&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;subsystemB-dataSource&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;subsystemA-dataSource&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;myApp-dataSource&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h4 id=实例化-bean>实例化 Bean</h4>
<p><strong>构造器方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;exampleBean&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;examples.ExampleBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p><strong>静态工厂方法</strong></p>
<h3 id=依赖>依赖</h3>
<p>依赖注入 依赖注入有两种主要方式：</p>
<ul>
<li>构造器注入</li>
<li>Setter 注入 构造器注入有可能出现循环注入的错误。如：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>B</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>){}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>B</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>){}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>依赖和配置细节</strong> 使用 depends-on Lazy-initialized Bean 自动装配 方法注入。</p>
<h2 id=ioc-容器配置>IoC 容器配置</h2>
<p>IoC 容器的配置有三种方式：</p>
<ul>
<li>基于 xml 配置</li>
<li>基于注解配置</li>
<li>基于 Java 配置</li>
</ul>
<p>作为 Spring 传统的配置方式，xml 配置方式一般为大家所熟知。</p>
<p>如果厌倦了 xml 配置，Spring 也提供了注解配置方式或 Java 配置方式来简化配置。</p>
<h3 id=xml-配置>Xml 配置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>         http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;resource1.xml&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;bean1&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;bean2&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;bean2&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;bean3&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;bean2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;resource2.xml&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</code></pre></div><p>标签说明：</p>
<ul>
<li><code>&lt;beans></code> 是 Spring 配置文件的根节点。</li>
<li><code>&lt;bean></code> 用来定义一个 JavaBean。<code>id</code> 属性是它的标识，在文件中必须唯一；<code>class</code> 属性是它关联的类。</li>
<li><code>&lt;alias></code> 用来定义 Bean 的别名。</li>
<li><code>&lt;import></code> 用来导入其他配置文件的 Bean 定义。这是为了加载多个配置文件，当然也可以把这些配置文件构造为一个数组（new String[] {“config1.xml”, config2.xml}）传给 <code>ApplicationContext</code> 实现类进行加载多个配置文件，那一个更适合由用户决定；这两种方式都是通过调用 Bean Definition Reader 读取 Bean 定义，内部实现没有任何区别。<code>&lt;import></code> 标签可以放在 <code>&lt;beans></code> 下的任何位置，没有顺序关系。</li>
</ul>
<h4 id=实例化容器>实例化容器</h4>
<p>实例化容器的过程： 定位资源（XML 配置文件） 读取配置信息(Resource) 转化为 Spring 可识别的数据形式（BeanDefinition）</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;services.xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;daos.xml&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
</code></pre></div><p>组合 xml 配置文件 配置的 Bean 功能各不相同，都放在一个 xml 文件中，不便管理。 Java 设计模式讲究职责单一原则。配置其实也是如此，功能不同的 JavaBean 应该被组织在不同的 xml 文件中。然后使用 import 标签把它们统一导入。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;classpath:spring/applicationContext.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;/WEB-INF/spring/service.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h4 id=使用容器>使用容器</h4>
<p>使用容器的方式就是通过<code>getBean</code>获取 IoC 容器中的 JavaBean。 Spring 也有其他方法去获得 JavaBean，但是 Spring 并不推荐其他方式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// create and configure beans
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;services.xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;daos.xml&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#8f5902;font-style:italic>// retrieve configured instance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>PetStoreService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;petStore&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PetStoreService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// use configured instance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>userList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsernameList</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=注解配置>注解配置</h3>
<p>Spring2.5 引入了注解。 <strong>优点</strong>：大大减少了配置，并且可以使配置更加精细——类，方法，字段都可以用注解去标记。 <strong>缺点</strong>：使用注解，不可避免产生了侵入式编程，也产生了一些问题。</p>
<ul>
<li>你需要将注解加入你的源码并编译它；</li>
<li>注解往往比较分散，不易管控。</li>
</ul>
<blockquote>
<p>注：spring 中，先进行注解注入，然后才是 xml 注入，因此如果注入的目标相同，后者会覆盖前者。</p>
</blockquote>
<h4 id=启动注解>启动注解</h4>
<p>Spring 默认是不启用注解的。如果想使用注解，需要先在 xml 中启动注解。 启动方式：在 xml 中加入一个标签，很简单吧。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context:annotation-config/&gt;</span>
</code></pre></div><blockquote>
<p>注：<code>&lt;context:annotation-config/></code> 只会检索定义它的上下文。什么意思呢？就是说，如果你 为 DispatcherServlet 指定了一个<code>WebApplicationContext</code>，那么它只在 controller 中查找<code>@Autowired</code>注解，而不会检查其它的路径。</p>
</blockquote>
<h4 id=spring-注解>Spring 注解</h4>
<ul>
<li><strong><code>@Required</code></strong>：只能用于修饰 bean 属性的 setter 方法。受影响的 bean 属性必须在配置时被填充在 xml 配置文件中，否则容器将抛出<code>BeanInitializationException</code>。</li>
<li><strong><code>@Autowired</code></strong>：可用于修饰属性、setter 方法、构造方法。
<ul>
<li>可以使用 JSR330 的注解<code>@Inject</code>来替代<code>@Autowired</code>。</li>
</ul>
</li>
<li><strong><code>@Qualifier</code></strong>：如果发现有多个候选的 bean 都符合修饰类型，指定 bean 名称来锁定真正需要的那个 bean。</li>
<li>JSR 250 注解
<ul>
<li><code>@Resource</code></li>
<li><strong><code>@PostConstruct</code> 和 <code>@PreDestroy</code></strong></li>
</ul>
</li>
<li>JSR 330 注解
<ul>
<li><code>@Inject</code></li>
</ul>
</li>
</ul>
<h3 id=java-配置>Java 配置</h3>
<p>基于 Java 配置 Spring IoC 容器，实际上是 Spring 允许用户定义一个类，在这个类中去管理 IoC 容器的配置。</p>
<p>为了让 Spring 识别这个定义类为一个 Spring 配置类，需要用到两个注解：<code>@Configuration</code> 和 <code>@Bean</code>。</p>
<p>如果你熟悉 Spring 的 xml 配置方式，你可以将 <code>@Configuration</code> 等价于 <code>&lt;beans></code> 标签；将 <code>@Bean</code> 等价于 <code>&lt;bean></code> 标签。</p>
<h4 id=bean-1>@Bean</h4>
<ul>
<li>
<p>@Bean 的修饰目标只能是方法或注解。</p>
</li>
<li>
<p>@Bean 只能定义在@Configuration 或@Component 注解修饰的类中。</p>
</li>
<li>
<p>@Configuration 类允许在同一个类中通过@Bean 定义内部 bean 依赖。</p>
</li>
<li>
<p>声明一个 bean，只需要在 bean 属性的 set 方法上标注@Bean 即可。</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotationConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Job</span> <span style=color:#000>getPolice</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Police</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Job</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Component</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;police&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Police</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Job</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;抓罪犯&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=configuration>@Configuration</h4>
<p><code>@Configuration</code> 是一个类级别的注解，用来标记被修饰类的对象是一个<code>BeanDefinition</code>。</p>
<p><code>@Configuration</code> 声明 bean 是通过被 <code>@Bean</code> 修饰的公共方法。此外，<code>@Configuration</code> 允许在同一个类中通过 <code>@Bean</code> 定义内部 bean 依赖。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyService</span> <span style=color:#000>myService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyServiceImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2a6c4c04bf13071ae484b315e9244cd2>1.2 - CH02-Spring IOC</h1>
<h2 id=基本概念>基本概念</h2>
<p>IoC（Inverse of Control:控制反转）是一种<strong>设计思想</strong>，就是 <strong>将原本在程序中手动创建对象的控制权，交由Spring框架来管理</strong>。 IoC 在其他语言中也有应用，并非 Spring 特有。 <strong>IoC 容器是 Spring 用来实现 IoC 的载体， IoC 容器实际上就是个Map（key，value），Map 中存放的是各种对象</strong>。</p>
<p>将对象之间的相互依赖关系交给 IoC 容器来管理，并由 IoC 容器完成对象的注入。这样可以很大程度上简化应用的开发，把应用从复杂的依赖关系中解放出来。 <strong>IoC 容器就像是一个工厂一样，当我们需要创建一个对象的时候，只需要配置好配置文件/注解即可，完全不用考虑对象是如何被创建出来的。</strong> 在实际项目中一个 Service 类可能有几百甚至上千个类作为它的底层，假如我们需要实例化这个 Service，你可能要每次都要搞清这个 Service 所有底层类的构造函数，这可能会把人逼疯。如果利用 IoC 的话，你只需要配置好，然后在需要的地方引用就行了，这大大增加了项目的可维护性且降低了开发难度。</p>
<p>Spring IOC 通过引入 xml 配置，由 IOC 容器来管理对象的生命周期，依赖关系等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503105756.png style=display:block;width:50% alt=NAME align=center> </div>
<p>从图中可以看出，我们以前获取两个有依赖关系的对象，要用 set 方法，而用容器之后，它们之间的关系就由容器来管理。</p>
<h2 id=什么是-spring-ioc-容器>什么是 Spring IOC 容器？</h2>
<p>Spring 框架的核心是 Spring 容器。容器创建对象，将它们装配在一起，配置它们并管理它们的完整生命周期。Spring 容器使用<strong>依赖注入</strong>来管理组成应用程序的组件。容器通过读取提供的配置元数据来接收对象进行实例化，配置和组装的指令。该元数据可以通过 XML，Java 注解或 Java 代码提供。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503105847.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=什么是依赖注入>什么是依赖注入？</h2>
<p><strong>依赖注入（DI,Dependency Injection）是在编译阶段尚未知所需的功能是来自哪个的类的情况下，将其他对象所依赖的功能对象实例化的模式</strong>。这就需要一种机制用来激活相应的组件以提供特定的功能，所以<strong>依赖注入是控制反转的基础</strong>。否则如果在组件不受框架控制的情况下，框架又怎么知道要创建哪个组件？</p>
<p>依赖注入有以下三种实现方式：</p>
<ol>
<li>构造器注入</li>
<li>Setter方法注入（属性注入）</li>
<li>接口注入</li>
</ol>
<h2 id=spring-中有多少种-ioc-容器>Spring 中有多少种 IOC 容器？</h2>
<p>在 Spring IOC 容器读取 Bean 配置创建 Bean 实例之前，必须对它进行实例化。只有在容器实例化后， 才可以从 IOC 容器里获取 Bean 实例并使用。</p>
<p>Spring 提供了两种类型的 IOC 容器实现</p>
<ul>
<li><strong>BeanFactory</strong>：IOC 容器的基本实现</li>
<li><strong>ApplicationContext</strong>：提供了更多的高级特性，是 BeanFactory 的子接口</li>
</ul>
<p>BeanFactory 是 Spring 框架的基础设施，面向 Spring 本身；ApplicationContext 面向使用 Spring 框架的开发者，几乎所有的应用场合都直接使用 ApplicationContext 而非底层的 BeanFactory；</p>
<p>无论使用何种方式，配置文件是相同的。</p>
<h2 id=beanfactory>BeanFactory</h2>
<p>BeanFactory，从名字上可以看出来它是 bean 的工厂，它负责生产和管理各个 bean 实例。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503110013.png style=display:block;width:50% alt=NAME align=center> </div>
<p>大概了解下这里提到的几个类：</p>
<ul>
<li><strong>ListableBeanFactory</strong>：这个 Listable 的意思就是，通过这个接口，我们可以获取多个 Bean，大家看源码会发现，最顶层 BeanFactory 接口的方法都是获取单个 Bean 的。</li>
<li><strong>HierarchicalBeanFactory</strong>：Hierarchical 单词本身已经能说明问题了，也就是说我们可以在应用中起多个 BeanFactory，然后可以将各个 BeanFactory 设置为父子关系。</li>
<li><strong>AutowireCapableBeanFactory</strong>： 这个名字中的 Autowire 大家都非常熟悉，它就是用来自动装配 Bean 用的，但是仔细看上图，ApplicationContext 并没有继承它，不过不用担心，不使用继承，不代表不可以使用组合，如果你看到 ApplicationContext 接口定义中的最后一个方法 getAutowireCapableBeanFactory() 就知道了。</li>
<li><strong>ConfigurableListableBeanFactory</strong> ：也是一个特殊的接口，看图，特殊之处在于它继承了第二层所有的三个接口，而 ApplicationContext 没有。这点之后会用到。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7202eaa44b8f3d3daee17478a4ca42ec>1.3 - CH03-Bean加载</h1>
<h2 id=解析流程>解析流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503121759.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=获取流程>获取流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503122924.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=创建流程>创建流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503123004.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a8a1a8038660c1cf3b1cbee6a84a454c>1.4 - CH04-IOC源码</h1>
<h2 id=applicationcontext-实例化-bean-的过程>ApplicationContext 实例化 Bean 的过程</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:applicationContext.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>ac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sayHello</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。</p>
<p>当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120343.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=启动过程分析>启动过程分析</h3>
<p>第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>setConfigLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，就是 <code>refresh()</code>，这里简单说下为什么是 <code>refresh()</code>，而不是 <code>init()</code> 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 <code>refresh()</code> 这个方法重建的，<code>refresh()</code> 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Prepare this context for refreshing.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Tell the subclass to refresh the internal bean factory.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Prepare the bean factory for use in this context.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Allows post-processing of the bean factory in context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//提供给子类实现一些postProcess的注册，如AbstractRefreshableWebApplicationContext注册一些Servlet相关的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Invoke factory processors registered as beans in the context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//调用所有BeanFactoryProcessor的postProcessBeanFactory()方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Register bean processors that intercept bean creation.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册BeanPostProcessor，BeanPostProcessor作用是用于拦截Bean的创建
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Initialize message source for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化消息Bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize event multicaster for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化上下文的事件多播组建，ApplicationEvent触发时由multicaster通知给ApplicationListener
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize other special beans in specific context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//ApplicationContext初始化一些特殊的bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Check for listener beans and register them.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册事件监听器，事件监听Bean统一注册到multicaster里头，ApplicationEvent事件触发后会由multicaster广播
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Instantiate all remaining (non-lazy-init) singletons.(重点)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 非延迟加载的单例Bean实例化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Last step: publish corresponding event.(最后，广播事件，ApplicationContext 初始化完成)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Propagate exception to caller.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面，我们开始一步步来肢解这个 <code>refresh()</code> 方法。</p>
<h3 id=创建-bean-容器前的准备工作>创建 Bean 容器前的准备工作</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Prepare this context for refreshing, setting its startup date and
</span><span style=color:#8f5902;font-style:italic> * active flag as well as performing any initialization of property sources.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// Switch to active.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupDate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>active</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Refreshing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize any placeholder property sources in the context environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initPropertySources</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Validate that all properties marked as required are resolvable:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// see ConfigurablePropertyResolver#setRequiredProperties
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 校验 xml 配置文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>validateRequiredProperties</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Store pre-refresh ApplicationListeners...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Reset local application listeners to pre-refresh state.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Allow for the collection of early ApplicationEvents,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// to be published once the multicaster is available...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationEvents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-bean-容器加载并注册-bean>创建 Bean 容器，加载并注册 Bean</h3>
<p>我们回到 <code>refresh()</code> 方法中的下一行 <code>obtainFreshBeanFactory()</code>。</p>
<p>注意，这个方法是全文最重要的部分之一，这里将会初始化 BeanFactory、加载 Bean、注册 Bean 等等。</p>
<p>当然，这步结束后，Bean 并没有完成初始化。这里指的是 Bean 实例并未在这一步生成。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 关闭旧的 BeanFactory (如果有)，创建新的 BeanFactory，加载 Bean 定义、注册 Bean 等等
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 返回刚刚创建的 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean factory for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>// AbstractRefreshableApplicationContext.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 如果 ApplicationContext 中已经加载过 BeanFactory 了，销毁所有 Bean，关闭 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意，应用中 BeanFactory 本来就是可以多个的，这里可不是说应用全局是否有 BeanFactory，而是当前
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// ApplicationContext 是否有 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanFactory</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 初始化一个 DefaultListableBeanFactory，为什么用这个，我们马上说。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 用于 BeanFactory 的序列化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSerializationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#8f5902;font-style:italic>// 下面这两个方法很重要，别跟丢了，具体细节之后说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的两个配置属性：是否允许 Bean 覆盖、是否允许循环引用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 加载 Bean 到 BeanFactory 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactoryMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O error parsing bean definition source for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>看到这里的时候，我觉得读者就应该站在高处看 ApplicationContext 了，ApplicationContext 继承自 BeanFactory，但是它不应该被理解为 BeanFactory 的实现类，而是说其内部持有一个实例化的 BeanFactory（DefaultListableBeanFactory）。以后所有的 BeanFactory 相关的操作其实是委托给这个实例来处理的。</p>
</blockquote>
<p>我们说说为什么选择实例化 <strong>DefaultListableBeanFactory</strong> ？前面我们说了有个很重要的接口 ConfigurableListableBeanFactory，它实现了 BeanFactory 下面一层的所有三个接口，我把之前的继承图再拿过来大家再仔细看一下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120653.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们可以看到 ConfigurableListableBeanFactory 只有一个实现类 DefaultListableBeanFactory，而且实现类 DefaultListableBeanFactory 还通过实现右边的 AbstractAutowireCapableBeanFactory 通吃了右路。所以结论就是，最底下这个家伙 DefaultListableBeanFactory 基本上是最牛的 BeanFactory 了，这也是为什么这边会使用这个类来实例化的原因。</p>
<blockquote>
<p>如果你想要在程序运行的时候动态往 Spring IOC 容器注册新的 bean，就会使用到这个类。那我们怎么在运行时获得这个实例呢？</p>
<p>之前我们说过 ApplicationContext 接口能获取到 AutowireCapableBeanFactory，就是最右上角那个，然后它向下转型就能得到 DefaultListableBeanFactory 了。</p>
</blockquote>
<p>在继续往下之前，我们需要先了解 BeanDefinition。<strong>我们说 BeanFactory 是 Bean 容器，那么 Bean 又是什么呢？</strong></p>
<p>这里的 BeanDefinition 就是我们所说的 Spring 的 Bean，我们自己定义的各个 Bean 其实会转换成一个个 BeanDefinition 存在于 Spring 的 BeanFactory 中。</p>
<p>所以，如果有人问你 Bean 是什么的时候，你要知道 Bean 在代码层面上可以认为是 BeanDefinition 的实例。</p>
<blockquote>
<p>BeanDefinition 中保存了我们的 Bean 信息，比如这个 Bean 指向的是哪个类、是否是单例的、是否懒加载、这个 Bean 依赖了哪些 Bean 等等。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120722.png style=display:block;width:50% alt=NAME align=center> </div>
<p>BeanDefinition 是一个接口，用于属性承载，比如 <bean> 元素标签拥有 class、scope、lazy-init 等配置。bean的定义方式有千千万万种，无论是何种标签，无论是何种资源定义，无论是何种容器，只要按照 Spring 的规范编写xml配置文件，最终的 bean 定义内部表示都将转换为内部的唯一结构：BeanDefinition。当 BeanDefinition 注册完毕以后，Spring 的 BeanFactory 就可以随时根据需要进行实例化了。</p>
<h5 id=beandefinition-接口定义>BeanDefinition 接口定义</h5>
<p>我们来看下 BeanDefinition 的接口定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanDefinition</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AttributeAccessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 我们可以看到，默认只提供 sington 和 prototype 两种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 很多读者可能知道还有 request, session, globalSession, application, websocket 这几种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 不过，它们属于基于 web 的扩展。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>SCOPE_SINGLETON</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_SINGLETON</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>String</span> <span style=color:#000>SCOPE_PROTOTYPE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_PROTOTYPE</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 比较不重要，直接跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_APPLICATION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_SUPPORT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_INFRASTRUCTURE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 设置父 Bean，这里涉及到 bean 继承，不是 java 继承。请参见附录的详细介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：继承父 Bean 的配置信息而已
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>parentName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取父 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getParentName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 Bean 的类名称，将来是要通过反射来生成实例的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanClassName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取 Bean 的类名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 bean 的 scope
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>);</span>
   
   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#000>String</span> <span style=color:#000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置是否懒加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLazyInit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInit</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 依赖的所有的 Bean，注意，这里的依赖不是指属性依赖(如 @Autowire 标记的)，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 是 depends-on=&#34;&#34; 属性设置的值。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 返回该 Bean 的所有依赖
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 是否可以注入到其他 Bean 中，只对根据类型注入有效，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果根据名称注入，即使这边设置了 false，也是可以的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireCandidate</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 该 Bean 是否可以注入到其他 Bean 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 主要的。同一接口的多个实现，如果不指定名字的话，Spring 会优先选择设置 primary 为 true 的 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPrimary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>primary</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 是否是 primary 的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrimary</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果该 Bean 采用工厂方法生成，指定工厂名称。对工厂不熟悉的读者，请参加附录
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：有些实例不是用反射生成的，而是用工厂模式生成的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 指定工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryMethodName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 构造器参数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Bean 中的属性值，后面给 bean 注入属性值的时候会说到
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 singleton
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 prototype
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrototype</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果这个 Bean 是被设置为 abstract，那么不能实例化，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 常用于作为 父bean 用于继承，其实也很少用......
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAbstract</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getRole</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>BeanDefinition</span> <span style=color:#000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>这个 BeanDefinition 其实已经包含很多的信息了，暂时不清楚所有的方法对应什么东西没关系，希望看完本文后读者可以彻底搞清楚里面的所有东西。</p>
<p>这里接口虽然那么多，但是没有类似 getInstance() 这种方法来获取我们定义的类的实例，真正的我们定义的类生成的实例到哪里去了呢？别着急，这个要很后面才能讲到。</p>
</blockquote>
<p>有了 BeanDefinition 的概念以后，我们再往下看 <code>refreshBeanFactory()</code> 方法中的剩余部分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=customizebeanfactory>customizeBeanFactory()</h4>
<p>customizeBeanFactory(beanFactory) 比较简单，就是配置是否允许 BeanDefinition 覆盖、是否允许循环引用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 定义覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 间的循环依赖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowCircularReferences</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span><span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BeanDefinition 的覆盖问题可能会有开发者碰到这个坑，就是在配置文件中定义 bean 时使用了相同的 id 或 name，默认情况下，allowBeanDefinitionOverriding 属性为 null，如果在同一配置文件中重复了，会抛错，但是如果不是同一配置文件中，会发生覆盖。</p>
<p>循环引用也很好理解：A 依赖 B，而 B 依赖 A。或 A 依赖 B，B 依赖 C，而 C 依赖 A。</p>
<p>默认情况下，Spring 允许循环依赖，当然如果你在 A 的构造方法中依赖 B，在 B 的构造方法中依赖 A 是不行的。</p>
<p>至于这两个属性怎么配置？我在附录中进行了介绍，尤其对于覆盖问题，很多人都希望禁止出现 Bean 覆盖，可是 Spring 默认是不同文件的时候可以覆盖的。</p>
<p>之后的源码中还会出现这两个属性，先有个印象就可以了。</p>
<h4 id=loadbeandefinitions加载-bean>loadBeanDefinitions()：加载 Bean</h4>
<p>接下来是最重要的 <code>loadBeanDefinitions(beanFactory)</code> 方法了，这个方法将根据配置，加载各个 Bean，然后放到 BeanFactory 中。</p>
<p>读取配置的操作在 XmlBeanDefinitionReader 中，其负责加载配置、解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 我们可以看到，此方法将通过一个 XmlBeanDefinitionReader 实例来加载各个 Bean。*/</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 给这个 BeanFactory 实例化一个 XmlBeanDefinitionReader
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>beanDefinitionReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XmlBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// Configure the bean definition reader with this context&#39;s
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// resource loading environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 初始化 BeanDefinitionReader，其实这个是提供给子类覆写的，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我看了一下，没有类覆写这个方法，我们姑且当做不重要吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 重点来了，继续往下
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在还在这个类中，接下来用刚刚初始化的 Reader 开始来加载 xml 配置，这块代码读者可以选择性跳过，不是很重要。也就是说，下面这个代码块，读者可以很轻松地略过。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigResources</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigLocations</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 上面虽然有两个分支，不过第二个分支很快通过解析路径转换为 Resource 以后也会进到这里
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Resource array must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 注意这里是个 for 循环，也就是每个文件是一个 resource
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 继续往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 最后返回 counter，表示总共加载了多少的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 303
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 314
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EncodedResource</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;EncodedResource must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading XML bean definitions from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 用一个 ThreadLocal 来存放配置文件资源
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;Detected cyclic loading of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; - check your import definitions!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEncoding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#8f5902;font-style:italic>// 核心部分是这里，往下面看
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;IOException parsing XML document from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 388 行
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这里就不看了，将 xml 文件转换为 Document 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Document</span> <span style=color:#000>doc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doLoadDocument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 继续
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 505 行
</span><span style=color:#8f5902;font-style:italic>// 返回值：返回从当前配置文件加载了多少数量的 Bean
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>BeanDefinitionDocumentReader</span> <span style=color:#000>documentReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinitionDocumentReader</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>countBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 这里
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>documentReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>createReaderContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>countBefore</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XmlReaderContext</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading bean definitions&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Element</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDocumentElement</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 从 xml 根节点开始解析文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>经过漫长的链路，一个配置文件终于转换为一颗 DOM 树了，注意，这里指的是其中一个配置文件，不是所有的，读者可以看到上面有个 for 循环的。下面开始从根节点开始解析：</p>
<h4 id=doregisterbeandefinitions>doRegisterBeanDefinitions()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 我们看名字就知道，BeanDefinitionParserDelegate 必定是一个重要的类，它负责解析 Bean 定义，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里为什么要定义一个 parent? 看到后面就知道了，是递归问题，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 因为 &lt;beans /&gt; 内部是可以定义 &lt;beans /&gt; 的，所以这个方法的 root 其实不一定就是 xml 的根节点，也可以是嵌套在里面的 &lt;beans /&gt; 节点，从源码分析的角度，我们当做根节点就好了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这块说的是根节点 &lt;beans ... profile=&#34;dev&#34; /&gt; 中的 profile 是否是当前环境需要的，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果当前环境配置的 profile 不包含此 profile，那就直接 return 了，不对此 &lt;beans /&gt; 解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 不熟悉 profile 为何物，不熟悉怎么配置 profile 读者的请移步附录区
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PROFILE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specifiedProfiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>acceptsProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specifiedProfiles</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Skipped XML bean definition file due to specified profiles [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] not matching: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>preProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>postProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>preProcessXml(root)</code> 和 <code>postProcessXml(root)</code> 是给子类用的钩子方法，鉴于没有被使用到，也不是我们的重点，我们直接跳过。</p>
<p>这里涉及到了 profile 的问题，对于不了解的读者，我在附录中对 profile 做了简单的解释，读者可以参考一下。接下来，看核心解析方法</p>
<h4 id=parsebeandefinitionsroot-thisdelegate>parseBeanDefinitions(root, this.delegate)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// default namespace 涉及到的就四个标签 &lt;import /&gt;、&lt;alias /&gt;、&lt;bean /&gt; 和 &lt;beans /&gt;，
</span><span style=color:#8f5902;font-style:italic>// 其他的属于 custom 的
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>NodeList</span> <span style=color:#000>nl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Element</span> <span style=color:#000>ele</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析 default namespace 下面的几个元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析其他 namespace 的元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码，我们可以看到，对于每个配置来说，分别进入到 <code>parseDefaultElement(ele, delegate);</code> 和 <code>delegate.parseCustomElement(ele);</code> 这两个分支了。</p>
<p><code>parseDefaultElement(ele, delegate)</code> 代表解析的节点是 <code>&lt;import /></code>、<code>&lt;alias /></code>、<code>&lt;bean /></code>、<code>&lt;beans /></code> 这几个。</p>
<blockquote>
<p>这里的四个标签之所以是 default 的，是因为它们是处于这个 namespace 下定义的：</p>
<p><a href=http://www.springframework.org/schema/beans>http://www.springframework.org/schema/beans</a></p>
<p>又到初学者科普时间，不熟悉 namespace 的读者请看下面贴出来的 xml，这里的第二行 <strong>xmlns</strong> 就是咯。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>            http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>          http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span>
       <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div><p>而对于其他的标签，将进入到 <code>delegate.parseCustomElement(element)</code> 这个分支。如我们经常会使用到的 <code>&lt;mvc /></code>、<code>&lt;task /></code>、<code>&lt;context /></code>、<code>&lt;aop /></code>等。</p>
<p>这些属于扩展，如果需要使用上面这些 ”非 default“ 标签，那么上面的 xml 头部的地方也要引入相应的 namespace 和 .xsd 文件的路径，如下所示。同时代码中需要提供相应的 parser 来解析，如 MvcNamespaceHandler、TaskNamespaceHandler、ContextNamespaceHandler、AopNamespaceHandler 等。</p>
<p>假如读者想分析 <code>&lt;context:property-placeholder location="classpath:xx.properties" /></code> 的实现原理，就应该到 ContextNamespaceHandler 中找答案。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
      <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
      <span style=color:#c4a000>xmlns:context=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/context&#34;</span>
      <span style=color:#c4a000>xmlns:mvc=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/mvc&#34;</span>
      <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans 
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans/spring-beans.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context/spring-context.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc   
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc/spring-mvc.xsd  
</span><span style=color:#4e9a06>       &#34;</span>
      <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div></blockquote>
<p>回过神来，看看处理 default 标签的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IMPORT_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;import /&gt; 标签
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>importBeanDefinitionResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ALIAS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;alias /&gt; 标签定义
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// &lt;alias name=&#34;fromName&#34; alias=&#34;toName&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processAliasRegistration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BEAN_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;bean /&gt; 标签定义，这也算是我们的重点吧
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NESTED_BEANS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果碰到的是嵌套的 &lt;beans /&gt; 标签，需要递归
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果每个标签都说，那我不吐血，你们都要吐血了。我们挑我们的重点 <code>&lt;bean /></code> 标签出来说。</p>
<h4 id=processbeandefinition-解析-bean-标签>processBeanDefinition 解析 bean 标签</h4>
<p>下面是 processBeanDefinition 解析 <code>&lt;bean /></code> 标签：</p>
<p>// DefaultBeanDefinitionDocumentReader.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点中的信息提取出来，然后封装到一个 BeanDefinitionHolder 中，细节往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 下面的几行先不要看，跳过先，跳过先，跳过先，后面会继续说的
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Register the final decorated instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// Send registration event.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继续往下看怎么解析之前，我们先看下 <code>&lt;bean /></code> 标签中可以定义哪些属性：</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>类的全限定名</td>
</tr>
<tr>
<td>name</td>
<td>可指定 id、name(用逗号、分号、空格分隔)</td>
</tr>
<tr>
<td>scope</td>
<td>作用域</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>指定构造参数</td>
</tr>
<tr>
<td>properties</td>
<td>设置属性的值</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(默认值)、byName、byType、 constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>是否懒加载(如果被非懒加载的bean依赖了那么其实也就不能懒加载了)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean 属性设置完成后，会调用这个方法</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean 销毁后的回调方法</td>
</tr>
</tbody>
</table>
<p>上面表格中的内容我想大家都非常熟悉吧，如果不熟悉，那就是你不够了解 Spring 的配置了。</p>
<p>简单地说就是像下面这样子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;exampleBean&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name1, name2, name3&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.javadoop.ExampleBean&#34;</span>
      <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;singleton&#34;</span> <span style=color:#c4a000>lazy-init=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;init&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;cleanup&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- 可以用下面三种形式指定构造参数 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;years&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- property 的几种情况 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanOne&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;ref</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;anotherExampleBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanTwo&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;yetAnotherBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;integerProperty&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>当然，除了上面举例出来的这些，还有 factory-bean、factory-method、<code>&lt;lockup-method /></code>、<code>&lt;replaced-method /></code>、<code>&lt;meta /></code>、<code>&lt;qualifier /></code> 这几个，大家是不是熟悉呢？自己检验一下自己对 Spring 中 bean 的了解程度。</p>
<p>有了以上这些知识以后，我们再继续往里看怎么解析 bean 元素，是怎么转换到 BeanDefinitionHolder 的。</p>
<p>// BeanDefinitionParserDelegate.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>String</span> <span style=color:#000>nameAttr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NAME_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

   <span style=color:#8f5902;font-style:italic>// 将 name 属性的定义按照 “逗号、分号、空格” 切分，形成一个 别名列表数组，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 当然，如果你不定义 name 属性的话，就是空的了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中简单介绍了一下 id 和 name 的配置，大家可以看一眼，有个20秒就可以了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>nameArr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameArr</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有指定id, 那么用别名列表的第一个名字作为beanName
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No XML &#39;id&#39; specified - using &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; as bean name and &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; as aliases&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>checkNameUniqueness</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 根据 &lt;bean ...&gt;...&lt;/bean&gt; 中的配置创建 BeanDefinition，然后把配置中的信息都设置到实例中,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 细节后面细说，先知道下面这行结束后，一个 BeanDefinition 实例就出来了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 到这里，整个 &lt;bean /&gt; 标签就算解析结束了，一个 BeanDefinition 就形成了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果都没有设置 id 和 name，那么此时的 beanName 就会为 null，进入下面这块代码产生
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果读者不感兴趣的话，我觉得不需要关心这块代码，对本文源码分析来说，这些东西不重要
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 按照我们的思路，这里 containingBean 是 null 的
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span>
                     <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 如果我们不定义 id 和 name，那么我们引言里的那个例子：
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   1. beanName 为：com.javadoop.example.MessageServiceImpl#0
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   2. beanClassName 为：com.javadoop.example.MessageServiceImpl
</span><span style=color:#8f5902;font-style:italic></span>
               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>

               <span style=color:#000>String</span> <span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isBeanNameInUse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#8f5902;font-style:italic>// 把 beanClassName 设置为 Bean 的别名
</span><span style=color:#8f5902;font-style:italic></span>                  <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Neither XML &#39;id&#39; nor &#39;name&#39; specified - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;using generated bean name [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliasesArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 返回 BeanDefinitionHolder
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliasesArray</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后，我们再看看怎么根据配置创建 BeanDefinition 实例的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#000>String</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 创建 BeanDefinition，然后设置类信息而已，很简单，就不贴代码了
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanDefinition 的一堆属性，这些属性定义在 AbstractBeanDefinition 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseBeanDefinitionAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDescription</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DomUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildElementValueByTagName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DESCRIPTION_ELEMENT</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>       * 下面的一堆是解析 &lt;bean&gt;......&lt;/bean&gt; 内部的子元素，
</span><span style=color:#8f5902;font-style:italic>       * 解析出来以后的信息都放到 bd 的属性中
</span><span style=color:#8f5902;font-style:italic>       */</span>

      <span style=color:#8f5902;font-style:italic>// 解析 &lt;meta /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseMetaElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;lookup-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseLookupOverrideSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;replaced-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseReplacedMethodSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 解析 &lt;constructor-arg /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseConstructorArgElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;property /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parsePropertyElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;qualifier /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseQualifierElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extractSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoClassDefFoundError</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Class that bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] depends on not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unexpected failure during bean definition parsing&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pop</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经完成了根据 <code>&lt;bean /></code> 配置创建了一个 BeanDefinitionHolder 实例。注意，是一个。</p>
<p>我们回到解析 <code>&lt;bean /></code> 的入口方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点转换为 BeanDefinitionHolder，就是上面说的一堆
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果有自定义属性的话，进行相应的解析，先忽略
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 我们把这步叫做 注册Bean 吧
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 注册完成后，发送事件，本文不展开说这个
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家再仔细看一下这块吧，我们后面就不回来说这个了。这里已经根据一个 <code>&lt;bean /></code> 标签产生了一个 BeanDefinitionHolder 的实例，这个实例里面也就是一个 BeanDefinition 的实例和它的 beanName、aliases 这三个信息，注意，我们的关注点始终在 BeanDefinition 上：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>然后我们准备注册这个 BeanDefinition，最后，把这个注册事件发送出去。</p>
<p>下面，我们开始说说注册 Bean 吧。</p>
<h3 id=注册-bean>注册 Bean</h3>
<p>// BeanDefinitionReaderUtils.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 注册这个 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 如果还有别名的话，也要根据别名全部注册一遍，不然根据别名就会找不到 Bean 了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAliases</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// alias -&gt; beanName 保存它们的别名信息，这个很简单，用一个 map 保存一下就可以了，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 获取的时候，会先将 alias 转换为 beanName，然后再查找
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>别名注册的放一边，毕竟它很简单，我们看看怎么注册 Bean。</p>
<p>// DefaultListableBeanFactory.java 793</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Bean name must not be empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;BeanDefinition must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(...);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// old? 还记得 “允许 bean 覆盖” 这个配置吗？allowBeanDefinitionOverriding
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinition</span> <span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 之后会看到，所有的 Bean 注册后会放入这个 beanDefinitionMap 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 处理重复名称的 Bean 定义的情况
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 如果不允许覆盖的话，抛异常
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()...</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用框架定义的 Bean 覆盖用户自定义的 Bean 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用新的 Bean 覆盖旧的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用同等的 Bean 覆盖旧的 Bean，这里指的是 equals 方法返回 true 的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 判断是否已经有其他的 Bean 开始初始化了.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注意，&#34;注册Bean&#34; 这个动作结束，Bean 依然还没有初始化，我们后面会有大篇幅说初始化过程，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 在 Spring 容器启动的最后，会 预初始化 所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanCreationStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Cannot modify startup-time collection elements anymore (for stable iteration)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedSingletons</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 最正常的应该是进到这个分支。
</span><span style=color:#8f5902;font-style:italic></span>
         <span style=color:#8f5902;font-style:italic>// 将 BeanDefinition 放到这个 map 中，这个 map 保存了所有的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 ArrayList，所以会按照 bean 配置的顺序保存每一个注册的 Bean 的名字
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 LinkedHashSet，代表的是手动注册的 singleton bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 注意这里是 remove 方法，到这里的 Bean 当然不是手动注册的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 手动指的是通过调用以下方法注册的 bean ：
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//     registerSingleton(String beanName, Object singletonObject)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这不是重点，解释只是为了不让大家疑惑。Spring 会在后面&#34;手动&#34;注册一些 Bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 如 &#34;environment&#34;、&#34;systemProperties&#34; 等 bean，我们自己也可以在运行时注册 Bean 到容器中的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 这个不重要，在预初始化的时候会用到，不必管它。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>frozenBeanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>resetBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>总结一下，到这里已经初始化了 Bean 容器，<code>&lt;bean /></code> 配置也相应的转换为了一个个 BeanDefinition，然后注册了各个 BeanDefinition 到注册中心，并且发送了注册事件。</p>
<blockquote>
<p>到这里是一个分水岭，前面的内容都还算比较简单，大家要清楚地知道前面都做了哪些事情。</p>
</blockquote>
<h3 id=bean-容器实例化完成后>Bean 容器实例化完成后</h3>
<p>说到这里，我们回到 refresh() 方法，我重新贴了一遍代码，看看我们说到哪了。是的，我们才说完 <code>obtainFreshBeanFactory()</code> 方法。</p>
<p>考虑到篇幅，这里开始大幅缩减掉没必要详细介绍的部分，大家直接看下面的代码中的注释就好了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
     
      <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 这块待会会展开说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 【这里需要知道 BeanFactoryPostProcessor 这个知识点，Bean 如果实现了此接口，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 那么在容器初始化以后，Spring 会负责调用里面的 postProcessBeanFactory 方法。】
</span><span style=color:#8f5902;font-style:italic></span>        
         <span style=color:#8f5902;font-style:italic>// 这里是提供给子类的扩展点，到这里的时候，所有的 Bean 都加载、注册完成了，但是都还没有初始化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这步的时候添加一些特殊的 BeanFactoryPostProcessor 的实现类或做点什么事
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 回调方法
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>          
         
          

         <span style=color:#8f5902;font-style:italic>// 注册 BeanPostProcessor 的实现类，注意看和 BeanFactoryPostProcessor 的区别
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 此接口两个方法: postProcessBeforeInitialization 和 postProcessAfterInitialization
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 两个方法分别在 Bean 初始化之前和初始化之后得到执行。这里仅仅是注册，之后会看到回调这两方法的时机
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的 MessageSource，国际化这里就不展开说了，不然没完没了了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的事件广播器，这里也不展开了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 从方法名就可以知道，典型的模板方法(钩子方法)，不展开说
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这里初始化一些特殊的 Bean（在初始化 singleton beans 之前）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 注册事件监听器，监听器需要实现 ApplicationListener 接口。这也不是我们的重点，过
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 重点，重点，重点
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 初始化所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//（lazy-init 的除外）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 最后，广播事件，ApplicationContext 初始化完成，不展开
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                  <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>

         <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 销毁已经初始化的 singleton 的 Beans，以免有些 bean 会一直占用资源
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 把异常往外抛
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=准备-bean-容器-preparebeanfactory>准备 Bean 容器: prepareBeanFactory</h3>
<p>之前我们说过，Spring 把我们在 xml 配置的 bean 都注册以后，会"手动"注册一些特殊的 bean。</p>
<p>这里简单介绍下 <code>prepareBeanFactory(factory)</code> 方法：</p>
<h3 id=preparebeanfactoryfactory>prepareBeanFactory(factory)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Configure the factory&#39;s standard context characteristics,
</span><span style=color:#8f5902;font-style:italic> * such as the context&#39;s ClassLoader and post-processors.
</span><span style=color:#8f5902;font-style:italic> * @param beanFactory the BeanFactory to configure
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，我们知道 BeanFactory 需要加载类，也就需要类加载器，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里设置为加载当前 ApplicationContext 类的类加载器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 设置 BeanExpressionResolver
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StandardBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>()));</span>

   <span style=color:#8f5902;font-style:italic>// 添加一个 BeanPostProcessor，这个 processor 比较简单：
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 实现了 Aware 接口的 beans 在初始化的时候，这个 processor 负责回调，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这个我们很常用，如我们会为了获取 ApplicationContext 而 implement ApplicationContextAware
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意：它不仅仅回调 ApplicationContextAware，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//   还会负责回调 EnvironmentAware、ResourceLoaderAware 等，看下源码就清楚了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 下面几行的意思就是，如果某个 bean 依赖于以下几个接口的实现类，在自动装配的时候忽略它们，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// Spring 会通过其他方式来处理这些依赖。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnvironmentAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageSourceAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 下面几行就是为特殊的几个 bean 赋值，如果有 bean 依赖了以下几个，会注入这边相应的值，
</span><span style=color:#8f5902;font-style:italic>    * 之前我们说过，&#34;当前 ApplicationContext 持有一个 BeanFactory&#34;，这里解释了第一行
</span><span style=color:#8f5902;font-style:italic>    * ApplicationContext 还继承了 ResourceLoader、ApplicationEventPublisher、MessageSource
</span><span style=color:#8f5902;font-style:italic>    * 所以对于这几个依赖，可以赋值为 this，注意 this 是一个 ApplicationContext
</span><span style=color:#8f5902;font-style:italic>    * 那这里怎么没看到为 MessageSource 赋值呢？那是因为 MessageSource 被注册成为了一个普通的 bean
</span><span style=color:#8f5902;font-style:italic>    */</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 这个 BeanPostProcessor 也很简单，在 bean 实例化后，如果是 ApplicationListener 的子类，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 那么将其添加到 listener 列表中，可以理解成：注册 事件监听器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationListenerDetector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 这里涉及到特殊的 bean，名为：loadTimeWeaver，这不是我们的重点，忽略它
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// tips: ltw 是 AspectJ 的概念，指的是在运行期进行织入，这个和 Spring AOP 不一样，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//    感兴趣的读者请参考我写的关于 AspectJ 的另一篇文章 https://www.javadoop.com/post/aspectj
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOAD_TIME_WEAVER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// Set a temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextTypeMatchClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 从下面几行代码我们可以知道，Spring 往往很 &#34;智能&#34; 就是因为它会帮我们默认注册一些有用的 bean，
</span><span style=color:#8f5902;font-style:italic>    * 我们也可以选择覆盖
</span><span style=color:#8f5902;font-style:italic>    */</span>

   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;environment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemProperties&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemEnvironment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面这块代码中，Spring 对一些特殊的 bean 进行了处理，读者如果暂时还不能消化它们也没有关系，慢慢往下看。</p>
<h3 id=初始化所有的-singleton-beans>初始化所有的 singleton beans</h3>
<p>我们的重点当然是 <code>finishBeanFactoryInitialization(beanFactory);</code> 这个巨头了，这里会负责初始化所有的 singleton beans。</p>
<p>注意，后面的描述中，我都会使用<strong>初始化</strong>或<strong>预初始化</strong>来代表这个阶段，Spring 会在这个阶段完成所有的 singleton beans 的实例化。</p>
<p>我们来总结一下，到目前为止，应该说 BeanFactory 已经创建完成，并且所有的实现了 BeanFactoryPostProcessor 接口的 Bean 都已经初始化并且其中的 postProcessBeanFactory(factory) 方法已经得到回调执行了。而且 Spring 已经“手动”注册了一些特殊的 Bean，如 ‘environment’、‘systemProperties’ 等。</p>
<p>剩下的就是初始化 singleton beans 了，我们知道它们是单例的，如果没有设置懒加载，那么 Spring 会在接下来初始化所有的 singleton beans。</p>
<p>// AbstractApplicationContext.java 834</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 初始化剩余的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 首先，初始化名字为 conversionService 的 Bean。本着送佛送到西的精神，我在附录中简单介绍了一下 ConversionService，因为这实在太实用了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 什么，看代码这里没有初始化 Bean 啊！
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意了，初始化的动作包装在 beanFactory.getBean(...) 中，这里先不说细节，先往下看吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConversionService</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register a default embedded value resolver if no bean post-processor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// (such as a PropertyPlaceholderConfigurer bean) registered any before:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// at this point, primarily for resolution in annotation attribute values.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringValueResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>resolveStringValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolvePlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 先初始化 LoadTimeWeaverAware 类型的 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 之前也说过，这是 AspectJ 相关的内容，放心跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>weaverAwareNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoadTimeWeaverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>weaverAwareName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>weaverAwareNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weaverAwareName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Stop using the temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 没什么别的目的，因为到这一步的时候，Spring 已经开始预初始化 singleton beans 了，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 肯定不希望这个时候还出现 bean 定义解析、加载、注册。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>freezeConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 开始初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面最后一行往里看，我们就又回到 DefaultListableBeanFactory 这个类了，这个类大家应该都不陌生了吧。</p>
<p>// DefaultListableBeanFactory.java 728</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pre-instantiating singletons in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// this.beanDefinitionNames 保存了所有的 beanNames
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 触发所有的非懒加载的 singleton beans 的初始化操作
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 合并父 Bean 中的配置，注意 &lt;bean id=&#34;&#34; class=&#34;&#34; parent=&#34;&#34; /&gt; 中的 parent，用的不多吧，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 考虑到这可能会影响大家的理解，我在附录中解释了一下 &#34;Bean 继承&#34;，不了解的请到附录中看一下
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 非抽象、非懒加载的 singletons。如果配置了 &#39;abstract = true&#39;，那是不需要初始化的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 处理 FactoryBean(读者如果不熟悉 FactoryBean，请移步附录区了解)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// FactoryBean 的话，在 beanName 前面加上 ‘&amp;’ 符号。再调用 getBean，getBean 方法别急
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FACTORY_BEAN_PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 判断当前 FactoryBean 是否是 SmartFactoryBean 的实现，此处忽略，直接跳过
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#5c35cc;font-weight:700>@Override</span>
                  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 对于普通的 Bean，只要调用 getBean(beanName) 这个方法就可以进行初始化了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>


   <span style=color:#8f5902;font-style:italic>// 到这里说明所有的非懒加载的 singleton beans 已经完成了初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果我们定义的 bean 是实现了 SmartInitializingSingleton 接口的，那么在这里得到回调，忽略
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>singletonInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SmartInitializingSingleton</span> <span style=color:#000>smartSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>singletonInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#5c35cc;font-weight:700>@Override</span>
               <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，我们就进入到 getBean(beanName) 方法了，这个方法我们经常用来从 BeanFactory 中获取一个 Bean，而初始化的过程也封装到了这个方法里。</p>
<h2 id=获取-bean>获取 Bean</h2>
<p>容器和 Bean 已经准备好了，接着就是获取 Bean 去使用了。</p>
<h3 id=俯瞰-getbeanstring-源码>俯瞰 getBean(String) 源码</h3>
<p>在本小节，我们先从战略上俯瞰 getBean(String) 方法的实现源码。代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// getBean 是一个空壳方法，所有的逻辑都封装在 doGetBean 方法中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 通过 name 获取 beanName。这里不使用 name 直接作为 beanName 有两点原因：
</span><span style=color:#8f5902;font-style:italic>     * 1. name 可能会以 &amp; 字符开头，表明调用者想获取 FactoryBean 本身，而非 FactoryBean 
</span><span style=color:#8f5902;font-style:italic>     *    实现类所创建的 bean。在 BeanFactory 中，FactoryBean 的实现类和其他的 bean 存储
</span><span style=color:#8f5902;font-style:italic>     *    方式是一致的，即 &lt;beanName, bean&gt;，beanName 中是没有 &amp; 这个字符的。所以我们需要
</span><span style=color:#8f5902;font-style:italic>     *    将 name 的首字符 &amp; 移除，这样才能从缓存里取到 FactoryBean 实例。
</span><span style=color:#8f5902;font-style:italic>     * 2. 若 name 是一个别名，则应将别名转换为具体的实例名，也就是 beanName。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 注意跟着这个，这个是返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 从缓存中获取单例 bean。Spring 是使用 Map 作为 beanName 和 bean 实例的缓存的，所以这
</span><span style=color:#8f5902;font-style:italic>     * 里暂时可以把 getSingleton(beanName) 等价于 beanMap.get(beanName)。当然，实际的
</span><span style=color:#8f5902;font-style:italic>     * 逻辑并非如此简单，后面再细说。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。
</span><span style=color:#8f5902;font-style:italic>     * BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取 
</span><span style=color:#8f5902;font-style:italic>     * bean 时再实例化，也就是懒加载。
</span><span style=color:#8f5902;font-style:italic>     * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取
</span><span style=color:#8f5902;font-style:italic>     * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数
</span><span style=color:#8f5902;font-style:italic>     * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有
</span><span style=color:#8f5902;font-style:italic>     * 用了，BeanFactory 不会多次实例化单例 bean。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果 
</span><span style=color:#8f5902;font-style:italic>         * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的 
</span><span style=color:#8f5902;font-style:italic>         * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回
</span><span style=color:#8f5902;font-style:italic>         * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean 
</span><span style=color:#8f5902;font-style:italic>     * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例
</span><span style=color:#8f5902;font-style:italic>     * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 如果 sharedInstance = null，则到父容器中查找 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 name 对应的 beanName，如果 name 是以 &amp; 字符开头，则返回 &amp; + beanName
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 根据 args 是否为空，以决定调用父容器哪个方法获取 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 返回父容器的查询结果
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> 
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

       <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>       * 稍稍总结一下：
</span><span style=color:#8f5902;font-style:italic>       * 到这里的话，要准备创建 Bean 了，对于 singleton 的 Bean 来说，容器中还没创建过此 Bean；
</span><span style=color:#8f5902;font-style:italic>       * 对于 prototype 的 Bean 来说，本来就是要创建一个新的 Bean。
</span><span style=color:#8f5902;font-style:italic>       */</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并父 BeanDefinition 与子 BeanDefinition，后面会单独分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，
</span><span style=color:#8f5902;font-style:italic>                     * B 又依赖 A，他们的配置如下：
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanA&#34; class=&#34;BeanA&#34; depends-on=&#34;beanB&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanB&#34; class=&#34;BeanB&#34; depends-on=&#34;beanA&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   
</span><span style=color:#8f5902;font-style:italic>                     * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它
</span><span style=color:#8f5902;font-style:italic>                     * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接
</span><span style=color:#8f5902;font-style:italic>                     * 抛出异常
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; and &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 注册依赖记录
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 先初始化被依赖项 加载 depends-on 依赖 
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> 
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过 
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法会在内部调用 
</span><span style=color:#8f5902;font-style:italic>                 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，
</span><span style=color:#8f5902;font-style:italic>                 * 将 bean 放入缓存中。关于 getSingleton 方法的分析，本文先不展开，我会在
</span><span style=color:#8f5902;font-style:italic>                 * 后面的文章中进行分析
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
                <span style=color:#8f5902;font-style:italic>// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 prototype 类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建其他类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@Override</span>
                        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Scope &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 如果需要进行类型转换，则在此处进行转换。类型转换这一块我没细看，就不多说了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQualifiedName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=createbean>createBean</h3>
<p>大家应该也猜到了，接下来当然是分析 createBean 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>第三个参数 args 数组代表创建实例需要的参数，不就是给构造方法用的参数，或者是工厂 Bean 的参数嘛，不过要注意，在我们的初始化阶段，args 是 null。</p>
<p>这回我们要到一个新的类了 AbstractAutowireCapableBeanFactory，看类名，AutowireCapable？类名是不是也说明了点问题了。</p>
<p>主要是为了以下场景，采用 @Autowired 注解注入属性值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserService</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;messageService&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;com.example.MessageServiceImpl&#34;</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</code></pre></div><p>以上这种属于混用了 xml 和 注解 两种方式的配置方式，Spring 会处理这种情况。</p>
<p>好了，读者要知道这么回事就可以了，继续向前。</p>
<p>// AbstractAutowireCapableBeanFactory.java 447</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Central method of this class: creates a bean instance,
</span><span style=color:#8f5902;font-style:italic> * populates the bean instance, applies post-processors, etc.
</span><span style=color:#8f5902;font-style:italic> * @see #doCreateBean
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 确保 BeanDefinition 中的 Class 被加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 准备方法覆写，这里又涉及到一个概念：MethodOverrides，它来自于 bean 定义中的 &lt;lookup-method /&gt; 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 和 &lt;replaced-method /&gt;，如果读者感兴趣，回到 bean 解析的地方看看对这两个标签的解析。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中也对这两个标签的相关知识点进行了介绍，读者可以移步去看看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Validation of method overrides failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 让 InstantiationAwareBeanPostProcessor 在这一步有机会返回代理，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span> 
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 重头戏，创建 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finished creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们继续往里看 doCreateBean 这个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// Instantiate the bean.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanInstanceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 说明不是 FactoryBean，这里实例化 Bean，这里非常关键，细节之后再说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 这个就是 Bean 里面的 我们定义的类 的实例，很多地方我直接描述成 &#34;bean 实例&#34;
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 类型
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedTargetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 建议跳过吧，涉及接口：MergedBeanDefinitionPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// MergedBeanDefinitionPostProcessor，这个我真不展开说了，直接跳过吧，很少用的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                  <span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Eagerly cache singletons to be able to resolve circular references
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// even when triggered by lifecycle interfaces like BeanFactoryAware.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 下面这块代码是为了解决循环依赖的问题
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize the bean instance.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这一步也是非常关键的，这一步负责属性装配，因为前面的实例只是实例化了，并没有设值，这里就是设值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 还记得 init-method 吗？还有 InitializingBean 接口？还有 BeanPostProcessor 接口？
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这里就是处理 bean 初始化完成后的各种回调
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowRawInjectionDespiteWrapping</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#4e9a06>&#34;Bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collectionToCommaDelimitedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register bean as disposable.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经分析完了 doCreateBean 方法，总的来说，我们已经说完了整个初始化流程。</p>
<p>接下来我们挑 doCreateBean 中的三个细节出来说说。</p>
<p>一个是创建 Bean 实例的 createBeanInstance 方法，一个是依赖注入的 populateBean 方法，还有就是回调方法 initializeBean。</p>
<p>注意了，接下来的这三个方法要认真说那也是极其复杂的，很多地方我就点到为止了，感兴趣的读者可以自己往里看，最好就是碰到不懂的，自己写代码去调试它。</p>
<h4 id=创建-bean-实例>创建 Bean 实例</h4>
<p>我们先看看 createBeanInstance 方法。需要说明的是，这个方法如果每个分支都分析下去，必然也是极其复杂冗长的，我们挑重点说。此方法的目的就是实例化我们指定的类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 确保已经加载了此 class
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 校验一下这个类的访问权限
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;Bean class isn&#39;t public, and non-public access not allowed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 采用工厂方法实例化，不熟悉这个概念的读者请看附录，注意，不是 FactoryBean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateUsingFactoryMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 如果不是第一次创建，比如第二次创建 prototype bean。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这种情况下，我们可以从第一次创建知道，采用无参构造函数，还是构造函数依赖注入 来完成实例化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowireNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 判断是否采用有参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineConstructorsFromBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 调用无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>挑个简单的<strong>无参构造函数</strong>构造实例来看看：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 实例化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 包装一下，返回
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到，关键的地方在于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里会进行实际的实例化过程，我们进去看看:</p>
<p>// SimpleInstantiationStrategy 59</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 如果不存在方法覆写，那就使用 java 反射进行实例化，否则使用 CGLIB,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 方法覆写 请参见附录&#34;方法注入&#34;中对 lookup-method 和 replaced-method 的介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Specified class is an interface&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#5c35cc;font-weight:700>@Override</span>
                     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                     <span style=color:#ce5c00;font-weight:700>}</span>
                  <span style=color:#ce5c00;font-weight:700>});</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No default constructor found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 利用构造方法进行实例化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存在方法覆写，利用 CGLIB 来完成实例化，需要依赖于 CGLIB 生成子类，这里就不展开了。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// tips: 因为如果不使用 CGLIB 的话，存在 override 的情况 JDK 并没有提供相应的实例化支持
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateWithMethodInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们就算实例化完成了。我们开始说怎么进行属性注入。</p>
<h4 id=bean-属性注入>bean 属性注入</h4>
<p>看完了 createBeanInstance(&mldr;) 方法，我们来看看 populateBean(&mldr;) 方法，该方法负责进行属性设值，处理依赖。</p>
<p>// AbstractAutowireCapableBeanFactory 1203</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// bean 实例的所有属性都在这里了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Cannot apply property values to null instance&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Skip property population phase for null instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 到这步的时候，bean 实例化完成（通过工厂方法或构造方法），但是还没开始属性设值，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// InstantiationAwareBeanPostProcessor 的实现类可以在这里对 bean 进行状态修改，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我也没找到有实际的使用，所以我们暂且忽略这块吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 如果返回 false，代表不需要进行后续的属性设值，也不需要再经过其他的 BeanPostProcessor 的处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>continueWithPropertyPopulation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>newPvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 通过名字找到所有属性值，如果是 bean 依赖，先初始化依赖的 bean。记录依赖关系
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// 通过类型装配。复杂一些
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsDepCheck</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyCheck</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPENDENCY_CHECK_NONE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredPds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>filterPropertyDescriptorsForDependencyCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCaching</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#8f5902;font-style:italic>// 这里有个非常有用的 BeanPostProcessor 进到这里: AutowiredAnnotationBeanPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>// 对采用 @Autowired、@Value 注解的依赖进行设值，这里的内容也是非常丰富的，不过本文不会展开说了，感兴趣的读者请自行研究
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>checkDependencies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 设置 bean 实例的属性值
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=initializebean>initializeBean</h4>
<p>属性注入完成后，这一步其实就是处理各种回调了，这块代码比较简单。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果 bean 实现了 BeanNameAware、BeanClassLoaderAware 或 BeanFactoryAware 接口，回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>Object</span> <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessBeforeInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 bean 中定义的 init-method，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 或者如果 bean 实现了 InitializingBean 接口，调用 afterPropertiesSet() 方法
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invocation of init method failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessAfterInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家发现没有，BeanPostProcessor 的两个回调都发生在这边，只不过中间处理了 init-method，是不是和读者原来的认知有点不一样了？</p>
<h2 id=相关疑问>相关疑问</h2>
<h4 id=spring-的-bean-在什么时候实例化>Spring 的 bean 在什么时候实例化?</h4>
<p>如果你使用BeanFactory，如 XmlBeanFactory 作为 Spring Bean 的工厂类，则所有的 bean 都是在第一次使用该bean 的时候实例化 。</p>
<p>如果你使用 ApplicationContext 作为 Spring Bean 的工厂类，则又分为以下几种情况：</p>
<ol>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 false（默认是false，所以可以不用设置），则ApplicationContext 启动的时候就实例化该 bean，并且将实例化的 bean 放在一个线程安全的 ConcurrentHashMap 结构的缓存中，下次再使用该 Bean 的时候，直接从这个缓存中取</li>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 true，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化</li>
<li>如果 bean 的 scope 是 prototype 的，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化 。</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7f4178b3d93842e955c6e1949a1a8205>1.5 - CH05-循环依赖</h1>
<h2 id=创建过程>创建过程</h2>
<p>Java 对象的创建步骤很多，可以 <code>new XXX</code>、序列化、<code>clone()</code> 等等， 只是 Spring 是通过反射 + 工厂的方式创建对象并放在容器的，创建好的对象我们一般还会对对象属性进行赋值，才去使用，可以理解是分了两个步骤。</p>
<h2 id=什么是循环依赖>什么是循环依赖</h2>
<p>所谓的循环依赖是指，A 依赖 B，B 又依赖 A，它们之间形成了循环依赖。或者是 A 依赖 B，B 依赖 C，C 又依赖 A，形成了循环依赖。更或者是自己依赖自己。它们之间的依赖关系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134049.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这里以两个类直接相互依赖为例，他们的实现代码可能如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanB</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanA</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanB</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置信息如下（用注解方式注入同理，只是为了方便理解，用了配置文件）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanA&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanB&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>Spring 启动后，读取如上的配置文件，会按顺序先实例化 A，但是创建的时候又发现它依赖了 B，接着就去实例化 B ，同样又发现它依赖了 A ，这尼玛咋整？无限循环呀</p>
<p>Spring “肯定”不会让这种事情发生的，如前言我们说的 Spring 实例化对象分两步，第一步会先创建一个原始对象，只是没有设置属性，可以理解为"半成品"—— 官方叫 A 对象的早期引用（EarlyBeanReference），所以当实例化 B 的时候发现依赖了 A， B 就会把这个“半成品”设置进去先完成实例化，既然 B 完成了实例化，所以 A 就可以获得 B 的引用，也完成实例化了，这其实就是 Spring 解决循环依赖的思想。</p>
<h2 id=源码实现>源码实现</h2>
<p>在 Spring IOC 容器读取 Bean 配置创建 Bean 实例之前, 必须对它进行实例化。只有在容器实例化后，才可以从 IOC 容器里获取 Bean 实例并使用，循环依赖问题也就是发生在实例化 Bean 的过程中的，所以我们先回顾下获取 Bean 的过程。</p>
<h3 id=获取-bean-流程>获取 Bean 流程</h3>
<p>Spring IOC 容器中获取 bean 实例的简化版流程如下（排除了各种包装和检查的过程）</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134307.png style=display:block;width:50% alt=NAME align=center> </div>
<p>大概的流程顺序：</p>
<ol>
<li>流程从 <code>getBean</code> 方法开始，<code>getBean</code> 是个空壳方法，所有逻辑直接到 <code>doGetBean</code> 方法中</li>
<li><code>transformedBeanName</code> 将 name 转换为真正的 beanName（name 可能是 FactoryBean 以 & 字符开头或者有别名的情况，所以需要转化下）</li>
<li>然后通过 <code>getSingleton(beanName)</code> 方法尝试从缓存中查找是不是有该实例 sharedInstance（单例在 Spring 的同一容器只会被创建一次，后续再获取 bean，就直接从缓存获取即可）</li>
<li>如果有的话，sharedInstance 可能是完全实例化好的 bean，也可能是一个原始的 bean，所以再经 <code>getObjectForBeanInstance</code> 处理即可返回</li>
<li>当然 sharedInstance 也可能是 null，这时候就会执行创建 bean 的逻辑，将结果返回</li>
</ol>
<p>第三步的时候我们提到了一个缓存的概念，这个就是 Spring 为了解决单例的循环依赖问题而设计的 <strong>三级缓存</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** Cache of singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>singletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>256</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>singletonFactories</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of early singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>earlySingletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这三级缓存的作用分别是：</p>
<ul>
<li><code>singletonObjects</code>：完成初始化的单例对象的 cache，这里的 bean 经历过 <code>实例化->属性填充->初始化</code> 以及各种后置处理（一级缓存）</li>
<li><code>earlySingletonObjects</code>：存放原始的 bean 对象（<strong>完成实例化但是尚未填充属性和初始化</strong>），仅仅能作为指针提前曝光，被其他 bean 所引用，用于解决循环依赖的 （二级缓存）</li>
<li><code>singletonFactories</code>：在 bean 实例化完之后，属性填充以及初始化之前，如果允许提前曝光，Spring 会将实例化后的 bean 提前曝光，也就是把该 bean 转换成 <code>beanFactory</code> 并加入到 <code>singletonFactories</code>（三级缓存）</li>
</ul>
<p>我们首先从缓存中试着获取 bean，就是从这三级缓存中查找：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从 singletonObjects 获取实例，singletonObjects 中的实例都是准备好的 bean 实例，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//isSingletonCurrentlyInCreation() 判断当前单例bean是否正在创建中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 一级缓存没有，就去二级缓存找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 二级缓存也没有，就去三级缓存找
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 三级缓存有的话，就把他移动到二级缓存,.getObject() 后续会讲到
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果缓存没有的话，我们就要创建了，接着我们以单例对象为例，再看下创建 bean 的逻辑（大括号表示内部类调用方法）：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134749.png style=display:block;width:50% alt=NAME align=center> </div>
<ol>
<li>
<p>创建 bean 从以下代码开始，一个匿名内部类方法参数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>getSingleton()</code> 方法内部主要有两个方法</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建 singletonObject
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 将 singletonObject 放入缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p><code>getObject()</code> 匿名内部类的实现真正调用的又是 <code>createBean(beanName, mbd, args)</code></p>
</li>
<li>
<p>往里走，主要的实现逻辑在 <code>doCreateBean</code>方法，先通过 <code>createBeanInstance</code> 创建一个原始 bean 对象</p>
</li>
<li>
<p>接着 <code>addSingletonFactory</code> 添加 bean 工厂对象到 singletonFactories 缓存（三级缓存）</p>
</li>
<li>
<p>通过 <code>populateBean</code> 方法向原始 bean 对象中填充属性，并解析依赖，假设这时候创建 A 之后填充属性时发现依赖 B，然后创建依赖对象 B 的时候又发现依赖 A，还是同样的流程，又去 <code>getBean(A)</code>，这个时候三级缓存已经有了 beanA 的“半成品”，这时就可以把 A 对象的原始引用注入 B 对象（并将其移动到二级缓存）来解决循环依赖问题。这时候 <code>getObject()</code> 方法就算执行结束了，返回完全实例化的 bean</p>
</li>
<li>
<p>最后调用 <code>addSingleton</code> 把完全实例化好的 bean 对象放入 singletonObjects 缓存（一级缓存）中</p>
</li>
</ol>
<h2 id=spring-解决循环依赖>Spring 解决循环依赖</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134858.png style=display:block;width:50% alt=NAME align=center> </div>
<p>流程其实上边都已经说过了，结合着上图我们再看下具体细节，用大白话再捋一捋：</p>
<ol>
<li>Spring 创建 bean 主要分为两个步骤，创建原始 bean 对象，接着去填充对象属性和初始化</li>
<li>每次创建 bean 之前，我们都会从缓存中查下有没有该 bean，因为是单例，只能有一个</li>
<li>当我们创建 beanA 的原始对象后，并把它放到三级缓存中，接下来就该填充对象属性了，这时候发现依赖了 beanB，接着就又去创建 beanB，同样的流程，创建完 beanB 填充属性时又发现它依赖了 beanA，又是同样的流程，不同的是，这时候可以在三级缓存中查到刚放进去的原始对象 beanA，所以不需要继续创建，用它注入 beanB，完成 beanB 的创建</li>
<li>既然 beanB 创建好了，所以 beanA 就可以完成填充属性的步骤了，接着执行剩下的逻辑，闭环完成</li>
</ol>
<p>但是为什么需要三级缓存，二级缓存不够用吗？</p>
<p>跟源码的时候，发现在创建 beanB 需要引用 beanA 这个“半成品”的时候，就会触发"前期引用"，即如下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 三级缓存有的话，就把他移动到二级缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>singletonFactory.getObject()</code> 是一个接口方法，这里具体的实现方法在</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 这么一大段就这句话是核心，也就是当bean要进行提前曝光时，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 给一个机会，通过重写后置处理器的getEarlyBeanReference方法，来自定义操作bean
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 值得注意的是，如果提前曝光了，但是没有被提前引用，则该后置处理器并不生效!!!
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 这也正式三级缓存存在的意义，否则二级缓存就可以解决循环依赖的问题
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>它的目的是为了后置处理，如果没有 AOP 后置处理，就不会走进 if 语句，直接返回了 exposedObject ，相当于啥都没干，二级缓存就够用了。</p>
<p>所以又得出结论，这个三级缓存应该和 AOP 有关系，继续。</p>
<p>在 Spring 的源码中<code>getEarlyBeanReference</code> 是 <code>SmartInstantiationAwareBeanPostProcessor</code> 接口的默认方法，真正实现这个方法的只有**<code>AbstractAutoProxyCreator</code>** 这个类，用于提前曝光的 AOP 代理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyProxyReferences</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 对bean进行提前Spring AOP代理
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这么说有点干，来个小 demo 吧，我们都知道 <strong>Spring AOP、事务</strong>等都是通过代理对象来实现的，而<strong>事务</strong>的代理对象是由自动代理创建器来自动完成的。也就是说 Spring 最终给我们放进容器里面的是一个代理对象，<strong>而非原始对象</strong>，假设我们有如下一段业务代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>HelloService</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#5c35cc;font-weight:700>@Autowired</span>
   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HelloService</span> <span style=color:#000>helloService</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#5c35cc;font-weight:700>@Override</span>
   <span style=color:#5c35cc;font-weight:700>@Transactional</span>
   <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Hello JavaKeeper&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此 <code>Service</code> 类使用到了事务，所以最终会生成一个 JDK 动态代理对象 <code>Proxy</code>。刚好它又存在<strong>自己引用自己</strong>的循环依赖，完美符合我们的场景需求。</p>
<p>我们再自定义一个后置处理，来看下效果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;提前曝光了：&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，调用方法栈中有我们自己实现的 <code>HelloProcessor</code>，说明这个 bean 会通过 AOP 代理处理。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503135143.png style=display:block;width:50% alt=NAME align=center> </div>
<p>再从源码看下这个自己循环自己的 bean 的创建流程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>){</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
	
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 需要提前暴露（支持循环依赖），就注册一个ObjectFactory到三级缓存
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#8f5902;font-style:italic>// 添加 bean 工厂对象到 singletonFactories 缓存中，并获取原始对象的早期引用
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//匿名内部方法 getEarlyBeanReference 就是后置处理器	
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// SmartInstantiationAwareBeanPostProcessor 的一个方法，
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 它的功效为：保证自己被循环依赖的时候，即使被别的Bean @Autowire进去的也是代理对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// 此处注意：如果此处自己被循环依赖了  那它会走上面的getEarlyBeanReference，从而创建一个代理对象从		三级缓存转移到二级缓存里
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// 注意此时候对象还在二级缓存里，并没有在一级缓存。并且此时后续的这两步操作还是用的 exposedObject，它仍旧是原始对象~~~
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// 因为事务的AOP自动代理创建器在getEarlyBeanReference 创建代理后，initializeBean 就不会再重复创建了，二选一的）
</span><span style=color:#8f5902;font-style:italic></span>    	
	<span style=color:#8f5902;font-style:italic>// 所以经过这两大步后，exposedObject 还是原始对象，通过 getEarlyBeanReference 创建的代理对象还在三级缓存呢
</span><span style=color:#8f5902;font-style:italic></span>	
	<span style=color:#ce5c00;font-weight:700>...</span>
	
	<span style=color:#8f5902;font-style:italic>// 循环依赖校验
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 注意此处第二个参数传的false，表示不去三级缓存里再去调用一次getObject()方法了~~~，此时代理对象还在二级缓存，所以这里拿出来的就是个 代理对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 最后赋值给exposedObject  然后return出去，进而最终被addSingleton()添加进一级缓存里面去  
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 这样就保证了我们容器里 最终实际上是代理对象，而非原始对象~~~~~
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
				<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>...</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=非单例循环依赖>非单例循环依赖</h3>
<p>看完了单例模式的循环依赖，我们再看下非单例的情况，假设我们的配置文件是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanA&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanB&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>启动 Spring，结果如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span> <span style=color:#000>defined</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>path</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xml</span><span style=color:#ce5c00;font-weight:700>]:</span> <span style=color:#000>Cannot</span> <span style=color:#000>resolve</span> <span style=color:#000>reference</span> <span style=color:#000>to</span> <span style=color:#000>bean</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000>setting</span> <span style=color:#000>bean</span> <span style=color:#000>property</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span> <span style=color:#000>defined</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>path</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xml</span><span style=color:#ce5c00;font-weight:700>]:</span> <span style=color:#000>Cannot</span> <span style=color:#000>resolve</span> <span style=color:#000>reference</span> <span style=color:#000>to</span> <span style=color:#000>bean</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000>setting</span> <span style=color:#000>bean</span> <span style=color:#000>property</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>Caused</span> <span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Requested</span> <span style=color:#000>bean</span> <span style=color:#000>is</span> <span style=color:#000>currently</span> <span style=color:#000>in</span> <span style=color:#000>creation</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Is</span> <span style=color:#000>there</span> <span style=color:#000>an</span> <span style=color:#000>unresolvable</span> <span style=color:#000>circular</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>?</span>
</code></pre></div><p>对于 <code>prototype</code> 作用域的 bean，Spring 容器无法完成依赖注入，因为 Spring 容器不进行缓存 <code>prototype</code> 作用域的 bean ，因此无法提前暴露一个创建中的bean 。</p>
<p>原因也挺好理解的，原型模式每次请求都会创建一个实例对象，即使加了缓存，循环引用太多的话，就比较麻烦了就，所以 Spring 不支持这种方式，直接抛出异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=构造器循环依赖>构造器循环依赖</h3>
<p>如果您主要使用构造器注入，循环依赖场景是无法解决的。建议你用 setter 注入方式代替构造器注入</p>
<p>其实也不是说只要是构造器注入就会有循环依赖问题，Spring 在创建 Bean 的时候默认是<strong>按照自然排序来进行创建的</strong>，我们暂且把先创建的 bean 叫主 bean，上文的 A 即主 bean，<strong>只要主 bean 注入依赖 bean 的方式是 setter 方式，依赖 bean 的注入方式无所谓，都可以解决，反之亦然</strong></p>
<p>所以上文我们 AB 循环依赖问题，只要 A 的注入方式是 setter ，就不会有循环依赖问题。</p>
<blockquote>
<p><strong>Spring 解决循环依赖依靠的是 Bean 的“中间态”这个概念，而这个中间态指的是已经实例化，但还没初始化的状态。实例化的过程又是通过构造器创建的，如果 A 还没创建好出来，怎么可能提前曝光，所以构造器的循环依赖无法解决，我一直认为应该先有鸡才能有蛋</strong>。</p>
</blockquote>
<h2 id=总结>总结</h2>
<h4 id=b-中提前注入了一个没有经过初始化的-a-类型对象不会有问题吗>B 中提前注入了一个没有经过初始化的 A 类型对象不会有问题吗？</h4>
<p>虽然在创建 B 时会提前给 B 注入了一个还未初始化的 A 对象，但是在创建 A 的流程中一直使用的是注入到 B 中的 A 对象的引用，之后会根据这个引用对 A 进行初始化，所以这是没有问题的。</p>
<h4 id=spring-是如何解决的循环依赖>Spring 是如何解决的循环依赖？</h4>
<p>Spring 为了解决单例的循环依赖问题，使用了三级缓存。其中一级缓存为单例池（<code>singletonObjects</code>），二级缓存为提前曝光对象（<code>earlySingletonObjects</code>），三级缓存为提前曝光对象工厂（<code>singletonFactories</code>）。</p>
<p>假设A、B循环引用，实例化 A 的时候就将其放入三级缓存中，接着填充属性的时候，发现依赖了 B，同样的流程也是实例化后放入三级缓存，接着去填充属性时又发现自己依赖 A，这时候从缓存中查找到早期暴露的 A，没有 AOP 代理的话，直接将 A 的原始对象注入 B，完成 B 的初始化后，进行属性填充和初始化，这时候 B 完成后，就去完成剩下的 A 的步骤，如果有 AOP 代理，就进行 AOP 处理获取代理后的对象 A，注入 B，走剩下的流程。</p>
<h4 id=为什么要使用三级缓存呢二级缓存能解决循环依赖吗>为什么要使用三级缓存呢？二级缓存能解决循环依赖吗？</h4>
<p>如果没有 AOP 代理，二级缓存可以解决问题，但是有 AOP 代理的情况下，只用二级缓存就意味着所有 Bean 在实例化后就要完成 AOP 代理，这样违背了 Spring 设计的原则，Spring 在设计之初就是通过 <code>AnnotationAwareAspectJAutoProxyCreator</code> 这个后置处理器来在 Bean 生命周期的最后一步来完成 AOP 代理，而不是在实例化后就立马进行 AOP 代理。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c6fbf53ed8e298648885933a5a812487>1.6 - CH07-动态代理</h1>
<p>代理模式是一种设计模式，能够使得在不修改源目标的前提下，额外扩展源目标的功能。即通过访问源目标的代理类，再由代理类去访问源目标。这样一来，要扩展功能，就无需修改源目标的代码了。只需要在代理类上增加就可以了。</p>
<p>其实代理模式的核心思想就是这么简单，在java中，代理又分静态代理和动态代理2种，其中动态代理根据不同实现又区分基于接口的的动态代理和基于子类的动态代理。</p>
<p>其中静态代理由于比较简单，面试中也没啥问的，在代理模式一块，问的最多就是动态代理，而且动态代理也是spring aop的核心思想，spring其他很多功能也是通过动态代理来实现的，比如拦截器，事务控制等。</p>
<p>熟练掌握动态代理技术，能让你业务代码更加精简而优雅。如果你需要写一些中间件的话，那动态代理技术更是必不可少的技能包。</p>
<h2 id=静态代理>静态代理</h2>
<p>在说动态代理前，还是先说说静态代理。</p>
<p>所谓静态代理，就是通过声明一个明确的代理类来访问源对象。</p>
<p>我们有2个接口，Person和Animal。每个接口各有2个实现类，UML如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235143.png style=display:block;width:80% alt=NAME align=center> </div>
<p>每个实现类中代码都差不多一致，用Student来举例（其他类和这个几乎一模一样）</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Student</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wakeup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StrUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;学生[{}]早晨醒来啦&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StrUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;学生[{}]晚上睡觉啦&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>假设我们现在要做一件事，就是在所有的实现类调用<code>wakeup()</code>前增加一行输出<code>早安~</code>，调用<code>sleep()</code>前增加一行输出<code>晚安~</code>。那我们只需要编写2个代理类<code>PersonProxy</code>和<code>AnimalProxy</code>：</p>
<p><strong>PersonProxy:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PersonProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Person</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PersonProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Person</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wakeup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>AnimalProxy:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnimalProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Animal</span> <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnimalProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Animal</span> <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>animal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wakeup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>最终执行代码为：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Person</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>PersonProxy</span> <span style=color:#000>studentProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>studentProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>studentProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Person</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>PersonProxy</span> <span style=color:#000>doctorProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>doctorProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctorProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Animal</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>AnimalProxy</span> <span style=color:#000>dogProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnimalProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>dogProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dogProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Animal</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>AnimalProxy</span> <span style=color:#000>catProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnimalProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>catProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>catProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>学生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>张三</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>学生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>张三</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
<span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>医生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>王教授</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>医生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>王教授</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
<span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小狗</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>旺旺</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小狗</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>旺旺</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
<span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小猫</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>咪咪</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小猫</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>咪咪</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
</code></pre></div><p><strong>结论：</strong></p>
<p>静态代理的代码相信已经不用多说了，代码非常简单易懂。这里用了2个代理类，分别代理了<code>Person</code>和<code>Animal</code>接口。</p>
<p>这种模式虽然好理解，但是缺点也很明显：</p>
<ul>
<li>会存在大量的冗余的代理类，这里演示了2个接口，如果有10个接口，就必须定义10个代理类。</li>
<li>不易维护，一旦接口更改，代理类和目标类都需要更改。</li>
</ul>
<h2 id=jdk-动态代理>JDK 动态代理</h2>
<p>动态代理，通俗点说就是：无需声明式的创建java代理类，而是在运行过程中生成"虚拟"的代理类，被ClassLoader加载。从而避免了静态代理那样需要声明大量的代理类。</p>
<p>JDK从1.3版本就开始支持动态代理类的创建。主要核心类只有2个：<code>java.lang.reflect.Proxy</code>和<code>java.lang.reflect.InvocationHandler</code>。</p>
<p>还是前面那个例子，用JDK动态代理类去实现的代码如下：</p>
<p><strong>创建一个JdkProxy类，用于统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JdkProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>JdkProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Person</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Person</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Animal</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Animal</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>可以看到，相对于静态代理类来说，无论有多少接口，这里只需要一个代理类。核心代码也很简单。唯一需要注意的点有以下2点：</p>
<ul>
<li>
<p>JDK动态代理是需要声明接口的，创建一个动态代理类必须得给这个”虚拟“的类一个接口。可以看到，这时候经动态代理类创造之后的每个bean已经不是原来那个对象了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235402.png style=display:block;width:80% alt=NAME align=center> </div>
</li>
<li>
<p>为什么这里<code>JdkProxy</code>还需要构造传入原有的bean呢？因为处理完附加的功能外，需要执行原有bean的方法，以完成<code>代理</code>的职责。</p>
<p>这里<code>JdkProxy</code>最核心的方法就是</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span>
</code></pre></div><p>其中proxy为代理过之后的对象(并不是原对象)，method为被代理的方法，args为方法的参数。</p>
<p>如果你不传原有的bean，直接用<code>method.invoke(proxy, args)</code>的话，那么就会陷入一个死循环。</p>
</li>
</ul>
<p><strong>可以代理什么</strong></p>
<p>JDK的动态代理是也平时大家使用的最多的一种代理方式。也叫做接口代理。前几天有一个小伙伴在群里问我，动态代理是否一次可以代理一个类，多个类可不可以。</p>
<p>JDK动态代理说白了只是根据接口”凭空“来生成类，至于具体的执行，都被代理到了<code>InvocationHandler</code> 的实现类里。上述例子我是需要继续执行原有bean的逻辑，才将原有的bean构造进来。只要你需要，你可以构造进任何对象到这个代理实现类。也就是说，你可以传入多个对象，或者说你什么类都不代理。只是为某一个接口”凭空“的生成多个代理实例，这多个代理实例最终都会进入<code>InvocationHandler</code>的实现类来执行某一个段共同的代码。</p>
<p>所以，在以往的项目中的一个实际场景就是，我有多个以yaml定义的规则文件，通过对yaml文件的扫描，来为每个yaml规则文件生成一个动态代理类。而实现这个，我只需要事先定义一个接口，和定义<code>InvocationHandler</code>的实现类就可以了，同时把yaml解析过的对象传入。最终这些动态代理类都会进入<code>invoke</code>方法来执行某个共同的逻辑。</p>
<h2 id=cglib-动态代理>Cglib 动态代理</h2>
<p>Spring在5.X之前默认的动态代理实现一直是jdk动态代理。但是从5.X开始，spring就开始默认使用Cglib来作为动态代理实现。并且springboot从2.X开始也转向了Cglib动态代理实现。</p>
<p>是什么导致了spring体系整体转投Cglib呢，jdk动态代理又有什么缺点呢？</p>
<p>那么我们现在就要来说下Cglib的动态代理。</p>
<p>Cglib是一个开源项目，它的底层是字节码处理框架ASM，Cglib提供了比jdk更为强大的动态代理。主要相比jdk动态代理的优势有：</p>
<ul>
<li>jdk动态代理只能基于接口，代理生成的对象只能赋值给接口变量，而Cglib就不存在这个问题，Cglib是通过生成子类来实现的，代理对象既可以赋值给实现类，又可以赋值给接口。</li>
<li>Cglib速度比jdk动态代理更快，性能更好。</li>
</ul>
<p>那何谓通过子类来实现呢？</p>
<p>还是前面那个例子，我们要实现相同的效果。代码如下</p>
<p><strong>创建CglibProxy类，用于统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CglibProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MethodInterceptor</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Enhancer</span> <span style=color:#000>enhancer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Enhancer</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#8f5902;font-style:italic>//设置需要创建子类的类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//通过字节码技术动态创建子类实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//实现MethodInterceptor接口方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodProxy</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//调用原bean的方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>CglibProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Student</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Doctor</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Cat</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>在这里用Cglib作为代理，其思路和jdk动态代理差不多。也需要把原始bean构造传入。原因上面有说，这里不多赘述。</p>
<p>关键的代码在这里</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//设置需要创建子类的类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>//通过字节码技术动态创建子类实例
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>可以看到，Cglib"凭空"的创造了一个原bean的子类，并把Callback指向了this，也就是当前对象，也就是这个proxy对象。从而会调用<code>intercept</code>方法。而在<code>intercept</code>方法里，进行了附加功能的执行，最后还是调用了原始bean的相应方法。</p>
<p>在debug这个生成的代理对象时，我们也能看到，Cglib是凭空生成了原始bean的子类：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235506.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=javassist-动态代理>javassist 动态代理</h2>
<p>Javassist是一个开源的分析、编辑和创建Java字节码的类库，可以直接编辑和生成Java生成的字节码。相对于bcel, asm等这些工具，开发者不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成类。</p>
<p>在日常使用中，javassit通常被用来动态修改字节码。它也能用来实现动态代理的功能。</p>
<p>话不多说，还是一样的例子，我用javassist动态代理来实现一遍</p>
<p><strong>创建JavassitProxy，用作统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JavassitProxy</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InstantiationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ProxyFactory</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProxyFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>ListUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()));</span>

        <span style=color:#000>Class</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createClass</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>MethodHandler</span> <span style=color:#000>mi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proceed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#000>Object</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mi</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>JavassitProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Student</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Doctor</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Cat</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>熟悉的配方，熟悉的味道，大致思路也是类似的。同样把原始bean构造传入。可以看到，javassist也是用”凭空“生成子类的方式类来解决，代码的最后也是调用了原始bean的目标方法完成代理。</p>
<p>javaassit比较有特点的是，可以对所需要代理的方法用filter来设定，里面可以像Criteria构造器那样进行构造。其他的代码，如果你仔细看了之前的代码演示，应该能很轻易看懂了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235531.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=bytebuddy-动态代理>ByteBuddy 动态代理</h2>
<p>ByteBuddy，字节码伙计，一听就很牛逼有不。</p>
<p>ByteBuddy也是一个大名鼎鼎的开源库，和Cglib一样，也是基于ASM实现。还有一个名气更大的库叫Mockito，相信不少人用过这玩意写过测试用例，其核心就是基于ByteBuddy来实现的，可以动态生成mock类，非常方便。另外ByteBuddy另外一个大的应用就是java agent，其主要作用就是在class被加载之前对其拦截，插入自己的代码。</p>
<p>ByteBuddy非常强大，是一个神器。可以应用在很多场景。但是这里，只介绍用ByteBuddy来做动态代理，关于其他使用方式，可能要专门写一篇来讲述，这里先给自己挖个坑。</p>
<p>来，还是熟悉的例子，熟悉的配方。用ByteBuddy我们再来实现一遍前面的例子</p>
<p><strong>创建ByteBuddyProxy，做统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ByteBuddyProxy</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>subclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementMatchers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>namedOneOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationHandlerAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AopInvocationHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>make</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLoaded</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AopInvocationHandler</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AopInvocationHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ByteBuddyProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Student</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Doctor</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Cat</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>思路和之前还是一样，通过仔细观察代码，ByteBuddy也是采用了创造子类的方式来实现动态代理。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235556.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=性能对比>性能对比</h2>
<p>前面介绍了4种动态代理对于同一例子的实现。对于代理的模式可以分为2种：</p>
<ul>
<li>JDK动态代理采用接口代理的模式，代理对象只能赋值给接口，允许多个接口</li>
<li>Cglib，Javassist，ByteBuddy这些都是采用了子类代理的模式，代理对象既可以赋值给接口，又可以复制给具体实现类</li>
</ul>
<p>Spring5.X，Springboot2.X只有都采用了Cglib作为动态代理的实现，那是不是cglib性能是最好的呢？</p>
<p>我这里做了一个简单而粗暴的实验，直接把上述4段执行代码进行单线程同步循环多遍，用耗时来确定他们4个的性能。应该能看出些端倪。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=color:#204a87>JDK</span> PROXY循环10000遍所耗时:0.714970125秒
<span style=color:#a40000>Cglib循环10000遍所耗时:0</span>.<span style=color:#a40000>434937833秒</span>
<span style=color:#a40000>Javassist循环10000遍所耗时:1</span>.<span style=color:#a40000>294194708秒</span>
<span style=color:#a40000>ByteBuddy循环10000遍所耗时:9</span>.<span style=color:#a40000>731999042秒</span>
</code></pre></div><p>执行的结果如上</p>
<p>从执行结果来看，的确是cglib效果最好。至于为什么ByteBuddy执行那么慢，不一定是ByteBuddy性能差，也有可能是我测试代码写的有问题，没有找到正确的方式。所以这只能作为一个大致的参考。</p>
<p>看来Spring选择Cglib还是有道理的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0460c594127706aa4329eb8831b746b4>1.7 - CH08-接口定义</h1>
<h2 id=接口参数>接口参数</h2>
<p><code>SpringMVC</code>中处理控制器参数的接口是<code>HandlerMethodArgumentResolver</code>，此接口有众多子类，分别处理不同(注解类型)的参数，下面只列举几个子类：</p>
<ul>
<li><code>RequestParamMethodArgumentResolver</code>：解析处理使用了<code>@RequestParam</code>注解的参数、<code>MultipartFile</code>类型参数和<code>Simple</code>类型(如<code>long</code>、<code>int</code>等类型)参数。</li>
<li><code>RequestResponseBodyMethodProcessor</code>：解析处理<code>@RequestBody</code>注解的参数。</li>
<li><code>PathVariableMapMethodArgumentResolver</code>：解析处理<code>@PathVariable</code>注解的参数。</li>
</ul>
<p>实际上，一般在解析一个控制器的请求参数的时候，用到的是<code>HandlerMethodArgumentResolverComposite</code>，里面装载了所有启用的<code>HandlerMethodArgumentResolver</code>子类。而<code>HandlerMethodArgumentResolver</code>子类在解析参数的时候使用到<code>HttpMessageConverter</code>（实际上也是一个列表，进行遍历匹配解析）子类进行匹配解析，常见的如<code>MappingJackson2HttpMessageConverter</code>（使用<code>Jackson</code>进行序列化和反序列化）。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221024.png style=display:block;width:80% alt=NAME align=center> </div>
<p>而<code>HandlerMethodArgumentResolver</code>子类到底依赖什么<code>HttpMessageConverter</code>实例实际上是由请求头中的<code>Content-Type</code>（在<code>SpringMVC</code>中统一命名为<code>MediaType</code>，见<code>org.springframework.http.MediaType</code>）决定的，因此我们在处理控制器的请求参数之前必须要明确外部请求的<code>Content-Type</code>到底是什么。上面的逻辑可以直接看源码<code>AbstractMessageConverterMethodArgumentResolver#readWithMessageConverters</code>，思路是比较清晰的。在<code>@RequestMapping</code>注解中，<code>produces</code>和<code>consumes</code>属性就是和请求的<code>Accept</code>或者响应的<code>Content-Type</code>相关的：</p>
<ul>
<li><code>consumes</code>属性：指定处理请求的提交内容类型（<code>Content-Type</code>），例如<code>application/json</code>、<code>text/html</code>等等，只有命中了对应的<code>Content-Type</code>的值才会接受该请求。</li>
<li><code>produces</code>属性：指定返回的内容类型，仅当某个请求的请求头中的（<code>Accept</code>）类型中包含该指定类型才返回，如果返回的是<code>JSON</code>数据一般考虑使用<code>application/json;charset=UTF-8</code>。</li>
</ul>
<p>另外提一点，<code>SpringMVC</code>中默认使用<code>Jackson</code>作为<code>JSON</code>的工具包，如果不是完全理解透整套源码的运作，一般不是十分建议修改默认使用的<code>MappingJackson2HttpMessageConverter</code>（例如有些人喜欢使用<code>FastJson</code>，实现<code>HttpMessageConverter</code>引入<code>FastJson</code>做<code>HTTP</code>消息转换器，其实这种做法并不推荐）。</p>
<h2 id=请求参数接收>请求参数接收</h2>
<p>其实一般的表单或者<code>JSON</code>数据的请求都是相对简单的，一些复杂的处理主要包括<code>URL</code>路径参数、文件上传、数组或者列表类型数据等。另外，关于参数类型中存在日期类型属性（例如<code>java.util.Date</code>、<code>java.sql.Date</code>、<code>java.time.LocalDate</code>、<code>java.time.LocalDateTime</code>、<code>java.time.ZonedDateTime</code>等等），解析的时候一般需要自定义实现的逻辑实现<code>String-->日期类型</code>的转换。其实道理很简单，日期相关的类型对于每个国家、每个时区甚至每个使用者来说认知都不一定相同，所以<code>SpringMVC</code>并没有对于日期时间类型的解析提供一个通用的解决方案。在演示一些例子可能用到下面的模特类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Contact</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contacts</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Contact</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面主要以<code>HTTP</code>的<code>GET</code>方法和<code>POST</code>方法提交在<code>SpringMVC</code>体系中正确处理参数的例子进行分析，还会花精力整理<code>SpringMVC</code>体系中<strong>独有的<code>URL</code>路径参数</strong>处理的一些技巧以及最常见的<strong>日期参数</strong>处理的合理实践（对于<code>GET</code>方法和<code>POST</code>方法提交的参数处理，基本囊括了其他如<code>DELETE</code>、<code>PUT</code>等方法的参数处理，随机应变即可）。</p>
<h3 id=get-方法请求参数处理>GET 方法请求参数处理</h3>
<p><code>HTTP(s)</code>协议使用<code>GET</code>方法进行请求的时候，提交的参数位于<code>URL</code>模式的<code>Query</code>部分，也就是<code>URL</code>的<code>?</code>标识符之后的参数，格式是<code>key1=value1&key2=value2</code>。<code>GET</code>方法请求参数可以有多种方法获取：</p>
<ol>
<li>使用<code>@RequestParam</code>注解处理。</li>
<li>使用对象接收，注意对象的属性名称要和<code>Query</code>中的参数名称一致。</li>
<li>使用<code>HttpServletRequest</code>实例提供的方法（<strong>不推荐，存在硬编码</strong>）。</li>
</ol>
<p>假设请求的<code>URL</code>为<code>http://localhost:8080/get?name=doge&age=26</code>，那么控制器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Slf4j</span>
<span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SampleController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/get1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>get1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name:{},age:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/get2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>get2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserVo</span> <span style=color:#000>vo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name:{},age:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>vo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>vo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAge</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/get3&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>get3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>String</span> <span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name:{},age:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Data</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserVo</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=表单参数>表单参数</h3>
<p>表单参数，一般对应于页面上<code>&lt;form></code>标签内的所有<code>&lt;input></code>标签的<code>name-value</code>聚合而成的参数，一般<code>Content-Type</code>指定为<code>application/x-www-form-urlencoded</code>，表单参数值也就是会进行（<code>URL</code>）编码。下面介绍几种常见的表单参数提交的参数形式。</p>
<ul>
<li>【非对象】- 非对象类型单个参数接收。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221348.png style=display:block;width:80% alt=NAME align=center> </div>
<p>对应的控制器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/post&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>post</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,age = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>说实话，如果有毅力的话，所有的复杂参数的提交最终都可以转化为多个单参数接收，不过这样做会产生十分多冗余的代码，而且可维护性比较低。这种情况下，用到的参数处理器是<code>RequestParamMapMethodArgumentResolver</code>。</p>
<ul>
<li>【对象】 - 对象类型参数接收。</li>
</ul>
<p>我们接着写一个接口用于提交用户信息，用到的是上面提到的模特类，主要包括用户姓名、年龄和联系人信息列表，这个时候，我们目标的控制器最终编码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>saveUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>加入强行指定<code>Content-Type</code>为<code>application/x-www-form-urlencoded</code>，需要构造请求参数格式如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221439.png style=display:block;width:80% alt=NAME align=center> </div>
<p>因为没有使用注解，最终的参数处理器为<code>ServletModelAttributeMethodProcessor</code>，主要是把<code>HttpServletRequest</code>中的表单参数封装到<code>MutablePropertyValues</code>实例中，再通过参数类型实例化（通过构造反射创建<code>User</code>实例），反射匹配属性进行值的填充。另外，请求复杂参数里面的列表属性请求参数看起来比较奇葩，实际上和在<code>.properties</code>文件中添加最终映射到<code>Map</code>类型的参数的写法是一致的，所以对于嵌套数组或者列表类型的第一层索引要写成<code>firstLevel[index].fieldName</code>的形式。那么，能不能把整个请求参数塞在一个字段中提交呢？</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221551.png style=display:block;width:80% alt=NAME align=center> </div>
<p>直接这样做是不行的，因为实际提交的<code>Form</code>表单，<code>key</code>是<code>user</code>字符串，<code>value</code>实际上也是一个字符串，缺少一个<code>String->User</code>类型的转换器，实际上<code>RequestParamMethodArgumentResolver</code>依赖<code>WebConversionService</code>中<code>Converter</code>实例列表进行参数转换，而默认的<code>Converter</code>列表中肯定不会存在自定义转换<code>String->User</code>类型的转换器：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221613.png style=display:block;width:80% alt=NAME align=center> </div>
<p>解决办法还是有的，添加一个自定义的<code>org.springframework.core.convert.converter.Converter</code>实现即可：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringUserConverter</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Converter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowaired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ObjectMapper</span> <span style=color:#000>objectMapper</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>objectMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面这种做法属于曲线救国的做法，不推荐使用在生产环境，但是<strong>如果有些第三方接口的对接无法避免这种参数</strong>（这个还真碰到多，有一些远古的遗留系统比较容易出现各种奇葩的操作），可以选择这种实现方式。</p>
<ul>
<li>【数组】 - 列表或者数组类型参数。</li>
</ul>
<p>极度不推荐使用在<code>application/x-www-form-urlencoded</code>这种媒体类型的表单提交的形式下强行使用列表或者数组类型参数，除非是为了兼容处理历史遗留系统的参数提交处理。例如提交的参数形式是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;string-1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;string-2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;string-3&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>那么表单参数的形式要写成：</p>
<table>
<thead>
<tr>
<th style=text-align:center>name</th>
<th style=text-align:center>value</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>list[0]</td>
<td style=text-align:center>string-1</td>
</tr>
<tr>
<td style=text-align:center>list[1]</td>
<td style=text-align:center>string-2</td>
</tr>
<tr>
<td style=text-align:center>list[2]</td>
<td style=text-align:center>string-3</td>
</tr>
</tbody>
</table>
<p>控制器的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/list&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;list&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>一个更加复杂的例子如下，假设想要提交的报文格式如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>user = [{&#34;name&#34;:&#34;doge-1&#34;,&#34;age&#34;: 21},{&#34;name&#34;:&#34;doge-2&#34;,&#34;age&#34;: 22}]
</code></pre></div><p>那么表单参数的形式要写成：</p>
<table>
<thead>
<tr>
<th style=text-align:center>name</th>
<th style=text-align:center>value</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>user[0].name</td>
<td style=text-align:center>doge-1</td>
</tr>
<tr>
<td style=text-align:center>user[0].age</td>
<td style=text-align:center>21</td>
</tr>
<tr>
<td style=text-align:center>user[1].name</td>
<td style=text-align:center>doge-2</td>
</tr>
<tr>
<td style=text-align:center>user[1].age</td>
<td style=text-align:center>22</td>
</tr>
</tbody>
</table>
<p>控制器的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>saveUsers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种传参格式其实并不灵活，甚至有可能降低开发效率和参数可读性。</p>
<h3 id=json-参数>JSON 参数</h3>
<p>一般来说，直接在<code>POST</code>请求中的请求体提交一个<code>JSON</code>字符串这种方式对于<code>SpringMVC</code>来说是比较友好的，只需要把<code>Content-Type</code>设置为<code>application/json</code>，然后直接上传一个原始的<code>JSON</code>字符串即可，控制器方法参数使用<code>@RequestBody</code>注解处理：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221750.png style=display:block;width:80% alt=NAME align=center> </div>
<p>后端控制器的代码也比较简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user-2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>saveUser2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为使用了<code>@RequestBody</code>注解，最终使用到的参数处理器为<code>RequestResponseBodyMethodProcessor</code>，实际上会用到<code>MappingJackson2HttpMessageConverter</code>进行参数类型的转换，底层依赖到<code>Jackson</code>相关的包。<strong>推荐使用这种方式，这是最常用也是最稳健的<code>JSON</code>参数处理方式</strong>。</p>
<h2 id=url-路径参数>URL 路径参数</h2>
<p><code>URL</code>路径参数，或者叫请求路径参数是基于<code>URL</code>模板获取到的参数，例如<code>/user/{userId}</code>是一个<code>URL</code>模板（<code>URL</code>模板中的参数占位符是<code>{}</code>），实际请求的<code>URL</code>为<code>/user/1</code>，那么通过匹配实际请求的<code>URL</code>和<code>URL</code>模板就能提取到<code>userId</code>为1。在<code>SpringMVC</code>中，<code>URL</code>模板中的路径参数叫做<code>Path Variable</code>，对应注解<code>@PathVariable</code>，对应的参数处理器为<code>PathVariableMethodArgumentResolver</code>。<strong>注意一点是，@PathVariable的解析是按照value(name)属性进行匹配，和URL参数的顺序是无关的</strong>。举个简单的例子：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221851.png style=display:block;width:80% alt=NAME align=center> </div>
<p>后台的控制器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user/{name}/{age}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>findUser1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,age = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种用法被广泛使用于<code>Representational State Transfer(REST)</code>的软件架构风格，个人觉得这种风格是比较灵活和清晰的（从<code>URL</code>和请求方法就能完全理解接口的意义和功能）。下面再介绍两种相对特殊的使用方式。</p>
<ul>
<li>带条件的<code>URL</code>参数。</li>
</ul>
<p>其实路径参数支持正则表达式，例如我们在使用<code>/sex/{sex}</code>接口的时候，要求<code>sex</code>必须是<code>F(Female)</code>或者<code>M(Male)</code>，那么我们的URL模板可以定义为<code>/sex/{sex:M|F}</code>，代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/sex/{sex:M|F}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>findUser2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;sex&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>sex</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sex</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>只有<code>/sex/F</code>或者<code>/sex/M</code>的请求才会进入<code>findUser2()</code>控制器方法，其他该路径前缀的请求都是非法的，会返回404状态码。这里仅仅是介绍了一个最简单的<code>URL</code>参数正则表达式的使用方式，更强大的用法可以自行摸索。</p>
<ul>
<li><code>@MatrixVariable</code>的使用。</li>
</ul>
<p><code>MatrixVariable</code>也是<code>URL</code>参数的一种，对应注解<code>@MatrixVariable</code>，不过它并不是<code>URL</code>中的一个值(这里的值指定是两个"/&ldquo;之间的部分)，而是值的一部分，它通过&rdquo;;&ldquo;进行分隔，通过&rdquo;=&ldquo;进行K-V设置。说起来有点抽象，举个例子：假如我们需要打电话给一个名字为doge，性别是男，分组是码畜的程序员，<code>GET</code>请求的<code>URL</code>可以表示为：<code>/call/doge;gender=male;group=programmer</code>，我们设计的控制器方法如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/call/{name}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#5c35cc;font-weight:700>@MatrixVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;gender&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>gender</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#5c35cc;font-weight:700>@MatrixVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;group&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,gender = %s,group = %s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>gender</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当然，如果你按照上面的例子写好代码，尝试请求一下该接口发现是报错的：<code>400 Bad Request - Missing matrix variable 'gender' for method parameter of type String</code>。这是因为<code>@MatrixVariable</code>注解的使用是不安全的，在<code>SpringMVC</code>中默认是关闭对其支持。要开启对<code>@MatrixVariable</code>的支持，需要设置<code>RequestMappingHandlerMapping#setRemoveSemicolonContent</code>方法为<code>false</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CustomMvcConfiguration</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InitializingBean</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>RequestMappingHandlerMapping</span> <span style=color:#000>requestMappingHandlerMapping</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>requestMappingHandlerMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemoveSemicolonContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>除非有很特殊的需要，否则不建议使用<code>@MatrixVariable</code>。</p>
<h2 id=文件上传>文件上传</h2>
<p>文件上传在使用<code>POSTMAN</code>模拟请求的时候需要选择<code>form-data</code>，<code>POST</code>方式进行提交：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222026.png style=display:block;width:80% alt=NAME align=center> </div>
<p>假设在电脑的磁盘<code>D</code>盘根目录有一个图片文件叫<code>doge.jpg</code>，现在要通过本地服务接口把文件上传，控制器的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/file1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestPart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>MultipartFile</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,originName = %s,size = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOriginalFilename</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>控制台输出是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>originName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doge</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>jpg</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>68727</span>
</code></pre></div><p>可能有点疑惑，参数是怎么来的，我们可以用<code>Fildder</code>软件抓个包看下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222119.png style=display:block;width:80% alt=NAME align=center> </div>
<p>可知<code>MultipartFile</code>实例的主要属性分别来自<code>Content-Disposition</code>、<code>Content-Type</code>和<code>Content-Length</code>，另外，<code>InputStream</code>用于读取请求体的最后部分(文件的字节序列)。参数处理器用到的是<code>RequestPartMethodArgumentResolver</code>（记住一点，使用了<code>@RequestPart</code>和<code>MultipartFile</code>一定是使用此参数处理器）。在其他情况下，使用<code>@RequestParam</code>和<code>MultipartFile</code>或者仅仅使用<code>MultipartFile</code>（参数的名字必须和<code>POST</code>表单中的<code>Content-Disposition</code>描述的<code>name</code>一致）也可以接收上传的文件数据，主要是通过<code>RequestParamMethodArgumentResolver</code>进行解析处理的，它的功能比较强大，具体可以看其<code>supportsParameter</code>方法，这两种情况的控制器方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/file2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>file2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MultipartFile</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,originName = %s,size = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOriginalFilename</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/file3&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>file3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>MultipartFile</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,originName = %s,size = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOriginalFilename</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=其他参数>其他参数</h2>
<p>其他参数主要包括请求头、<code>Cookie</code>、<code>Model</code>、<code>Map</code>等相关参数，还有一些并不是很常用或者一些相对原生的属性值获取（例如<code>HttpServletRequest</code>、<code>HttpServletResponse</code>或者它们内置的实例方法等）不做讨论。</p>
<h3 id=请求头>请求头</h3>
<p>请求头的值主要通过<code>@RequestHeader</code>注解的参数获取，参数处理器是<code>RequestHeaderMethodArgumentResolver</code>，需要在注解中指定请求头的<code>Key</code>。简单实用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222207.png style=display:block;width:80% alt=NAME align=center> </div>
<p>控制器方法代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/header&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Content-Type&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=cookie>Cookie</h3>
<p><code>Cookie</code>的值主要通过<code>@CookieValue</code>注解的参数获取，参数处理器为<code>ServletCookieValueMethodArgumentResolver</code>，需要在注解中指定<code>Cookie</code>的<code>Key</code>。控制器方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/cookie&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>cookie</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@CookieValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;JSESSIONID&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>sessionId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sessionId</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=model-类型参数>Model 类型参数</h3>
<p><code>Model</code>类型参数的处理器是<code>ModelMethodProcessor</code>，实际上处理此参数是直接返回<code>ModelAndViewContainer</code>实例中的<code>Model</code>（具体是<code>ModelMap</code>类型），因为要桥接不同的接口和类的功能，因此回调的实例是<code>BindingAwareModelMap</code>类型，此类型继承自<code>ModelMap</code>同时实现了<code>Model</code>接口。举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/model&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ModelMap</span> <span style=color:#000>modelMap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>model</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>modelMap</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意调用此接口，控制台输出<code>INFO</code>日志内容为：<code>true</code>。还要注意一点：<code>ModelMap</code>或者<code>Model</code>中添加的属性项会附加到<code>HttpRequestServlet</code>实例中带到页面中进行渲染，使用模板引擎的前提下可以直接在模板文件内容中直接使用占位符提取这些属性值。</p>
<h3 id=modelattribute-参数>@ModelAttribute 参数</h3>
<p><code>@ModelAttribute</code>注解处理的参数处理器为<code>ModelAttributeMethodProcessor</code>，<code>@ModelAttribute</code>的功能源码的注释如下：</p>
<blockquote>
<p>Annotation that binds a method parameter or method return value to a named model attribute, exposed to a web view.</p>
</blockquote>
<p>简单来说，就是通过<code>key-value</code>形式绑定方法参数或者方法返回值到<code>Model(Map)</code>中，区别下面三种情况：</p>
<ol>
<li><code>@ModelAttribute</code>使用在方法（返回值）上，方法没有返回值（<code>void</code>类型）， <code>Model(Map)</code>参数需要自行设置。</li>
<li><code>@ModelAttribute</code>使用在方法（返回值）上，方法有返回值（非<code>void</code>类型），返回值会添加到<code>Model(Map)</code>参数，<code>key</code>由<code>@ModelAttribute</code>的<code>value</code>指定，否则会使用返回值类型字符串（首写字母变为小写，如返回值类型为<code>Integer</code>，则<code>key</code>为<code>integer</code>）。</li>
<li><code>@ModelAttribute</code>使用在方法参数中，则可以获取同一个控制器中的已经设置的<code>@ModelAttribute</code>对应的值。</li>
</ol>
<p>在一个控制器（使用了<code>@Controller</code>的<code>Spring</code>组件）中，如果存在一到多个使用了<code>@ModelAttribute</code>的方法，这些方法总是在进入控制器方法之前执行，并且执行顺序是由加载顺序决定的（具体的顺序是带参数的优先，并且按照方法首字母升序排序），举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Slf4j</span>
<span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ModelAttributeController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;beforeValue&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;beforeArg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>beforeArg</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beforeArg..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;beforeArgValue&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/modelAttribute&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>modelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;beforeArg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>beforeArg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;modelAttribute..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beforeArg..........{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beforeArg</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>after</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;afterValue&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;afterArg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>afterArg</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;afterArg..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;afterArgValue&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调用此接口，控制台输出日志如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>after..........
before..........
afterArg..........
beforeArg..........
modelAttribute..........
beforeArg..........beforeArgValue
{after=afterValue, before=beforeValue, afterArg=afterArgValue, beforeArg=beforeArgValue}
</code></pre></div><p>可以印证排序规则和参数设置、获取的结果和前面的分析是一致的。</p>
<h3 id=errors-或-bindingresult-参数>Errors 或 BindingResult 参数</h3>
<p><code>Errors</code>其实是<code>BindingResult</code>的父接口，<code>BindingResult</code>主要用于回调<code>JSR</code>参数校验异常的属性项，如果<code>JSR303</code>校验异常，一般会抛出<code>MethodArgumentNotValidException</code>异常，并且会返回<code>400(Bad Request)</code>，见全局异常处理器<code>DefaultHandlerExceptionResolver</code>。<code>Errors</code>类型的参数处理器为<code>ErrorsMethodArgumentResolver</code>。举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/errors&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#5c35cc;font-weight:700>@Validated</span> <span style=color:#000>ErrorsModel</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BindingResult</span> <span style=color:#000>bindingResult</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bindingResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectError</span> <span style=color:#000>objectError</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>bindingResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name={},message={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>objectError</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>objectError</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//ErrorsModel
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#5c35cc;font-weight:700>@NoArgsConstructor</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ErrorsModel</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@NotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;id must not be null!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@NotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;errors name must not be empty!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调用接口控制台<code>Warn</code>日志如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>name=errors,message=errors name must not be empty!
</code></pre></div><p>一般情况下，不建议用这种方式处理JSR校验异常的属性项，因为会涉及到大量的重复的硬编码工作，建议：方式一直接继承<code>ResponseEntityExceptionHandler</code>覆盖对应的方法或者方式二同时使用<code>@ExceptionHandler</code>和<code>@(Rest)ControllerAdvice</code>注解进行异常处理。例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RestControllerAdvice</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationRestControllerAdvice</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BusinessException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>handleBusinessException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BusinessException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#8f5902;font-style:italic>// 这里处理异常和返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodArgumentNotValidException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>handleMethodArgumentNotValidException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodArgumentNotValidException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#8f5902;font-style:italic>// 这里处理异常和返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>值得注意的是，SpringBoot某个版本之后，把JSR303相关的依赖抽离到spring-boot-starter-validation依赖中，如果要使用JSR303相关相关校验功能，必须独立引入此starter</p>
</blockquote>
<h3 id=value-参数>@Value 参数</h3>
<p>控制器方法的参数可以是<code>@Value</code>注解修饰的参数，会从<code>Environment</code>实例中装配和转换属性值到对应的参数中（也就是参数的来源并不是请求体，而是上下文中已经加载和处理完成的环境属性值），参数处理器为<code>ExpressionValueMethodArgumentResolver</code>。举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/value&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${spring.application.name}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;spring.application.name={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>spring.application.name</code>属性一般在配置文件中指定，在加载配置文件属性的时候添加到全局的<code>Environment</code>中。</p>
<h3 id=map-类型参数>Map 类型参数</h3>
<p><code>Map</code>类型参数的范围相对比较广，对应一系列的参数处理器，注意区别使用了上面提到的部分注解的<code>Map</code>类型和完全不使用注解的<code>Map</code>类型参数，两者的处理方式不相同。下面列举几个相对典型的<code>Map</code>类型参数处理例子。</p>
<h4 id=不使用任何注解的mapstringobject参数><strong>不使用任何注解的<code>Map&lt;String,Object></code>参数</strong></h4>
<p>这种情况下参数实际上直接回调<code>ModelAndViewContainer</code>中的<code>ModelMap</code>实例，参数处理器为<code>MapMethodProcessor</code>，往<code>Map</code>参数中添加的属性将会带到页面中。</p>
<h4 id=使用requestparam注解的mapstringobject参数><strong>使用@RequestParam注解的<code>Map&lt;String,Object></code>参数</strong></h4>
<p>这种情况下的参数处理器为<code>RequestParamMapMethodArgumentResolver</code>，使用的请求方式需要指定<code>Content-Type</code>为<code>x-www-form-urlencoded</code>，不能使用<code>application/json</code>的方式：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222630.png style=display:block;width:80% alt=NAME align=center> </div>
<p>控制器代码为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/map&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>mapArgs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=使用requestheader注解的mapstringobject参数><strong>使用@RequestHeader注解的Map&lt;String,Object>参数</strong></h4>
<p>这种情况下的参数处理器为<code>RequestHeaderMapMethodArgumentResolver</code>，作用是获取请求的所有请求头的<code>Key-Value</code>。</p>
<h4 id=使用pathvariable注解的mapstringobject参数><strong>使用@PathVariable注解的Map&lt;String,Object>参数</strong></h4>
<p>这种情况下的参数处理器为<code>PathVariableMapMethodArgumentResolver</code>，作用是获取所有路径参数封装为<code>Key-Value</code>结构。</p>
<h3 id=multipartfile-集合批量文件上传>MultipartFile 集合：批量文件上传</h3>
<p>批量文件上传的时候，我们一般需要接收一个<code>MultipartFile</code>集合，可以有两种选择：</p>
<ol>
<li>使用<code>MultipartHttpServletRequest</code>参数，直接调用<code>getFiles</code>方法获取<code>MultipartFile</code>列表。</li>
<li>使用<code>@RequestParam</code>注解修饰<code>MultipartFile</code>列表，参数处理器是<code>RequestParamMethodArgumentResolver</code>，其实就是第1种方式的封装而已。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222724.png style=display:block;width:80% alt=NAME align=center> </div>
<p>控制器方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/parts&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>partArgs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MultipartFile</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parts</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parts</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=日期类型参数处理>日期类型参数处理</h2>
<p>日期参数处理个人认为是请求参数处理中最复杂的，因为一般日期处理的逻辑不是通用的，过多的定制化处理导致很难有一个统一的标准处理逻辑去处理和转换日期类型的参数。不过，这里介绍几个通用的方法，以应对各种奇葩的日期格式。下面介绍的例子中全部使用<code>JDK8</code>中引入的日期时间<code>API</code>，围绕<code>java.util.Date</code>为核心的日期时间<code>API</code>的使用方式类同。</p>
<h3 id=统一以字符串形式接收>统一以字符串形式接收</h3>
<p>这种是最原始但是最奏效的方式，统一以字符串形式接收，然后自行处理类型转换，下面给个小例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateTimeFormatter</span> <span style=color:#000>FORMATTER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>UserDto</span> <span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>UserEntity</span> <span style=color:#000>userEntity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUserId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBirthdayTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBirthdayTime</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FORMATTER</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setGraduationTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGraduationTime</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FORMATTER</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserEntity</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用字符串接收后再转换的缺点就是模板代码太多，编码风格不够简洁，重复性工作太多，如果有代码洁癖或者类似笔者这样是一个节能主义者，一般不会选用这种方式。</p>
<h3 id=使用注解-datetimeformat-或-jsonformat>使用注解 @DateTimeFormat 或 @JsonFormat</h3>
<p><code>@DateTimeFormat</code>注解配合<code>@RequestBody</code>的参数使用的时候，会发现抛出<code>InvalidFormatException</code>异常，提示转换失败，这是因为在处理此注解的时候，只支持<code>Form</code>表单提交(<code>Content-Type</code>为<code>x-www-form-urlencoded</code>)，例子如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto2</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserDto2</span> <span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//或者像下面这样
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;userId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;birthdayTime&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;graduationTime&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>而<code>@JsonFormat</code>注解可使用在<code>Form</code>表单或者<code>JSON</code>请求参数的场景，因此更推荐使用<code>@JsonFormat</code>注解，不过注意需要指定时区(<code>timezone</code>属性，例如在中国是东八区<code>GMT+8</code>)，否则有可能导致出现<strong>时差</strong>，举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>UserDto2</span> <span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto2</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timezone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;GMT+8&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timezone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;GMT+8&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>一般选用LocalDateTime作为日期字段参数的类型，因为它的转换相对于其他JDK8的日期时间类型简单</p>
</blockquote>
<h3 id=jackson-序列化和反序列化定制>Jackson 序列化和反序列化定制</h3>
<p>因为<code>SpringMVC</code>默认使用<code>Jackson</code>处理<code>@RequestBody</code>的参数转换，因此可以通过定制序列化器和反序列化器来实现日期类型的转换，这样我们就可以使用<code>application/json</code>的形式提交请求参数。这里的例子是转换请求<code>JSON</code>参数中的字符串为<code>LocalDateTime</code>类型，属于<code>JSON</code>反序列化，因此需要定制反序列化器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date3&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>UserDto3</span> <span style=color:#000>userDto3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto3</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonDeserialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>using</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonDeserialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>using</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>LocalDateTimeDeserializer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=最佳实践>最佳实践</h3>
<p>前面三种方式都存在硬编码等问题，其实最佳实践是直接修改<code>MappingJackson2HttpMessageConverter</code>中的<code>ObjectMapper</code>对于日期类型处理默认的序列化器和反序列化器，这样就能全局生效，不需要再使用其他注解或者定制序列化方案（当然，有些时候需要特殊处理定制），或者说，在需要特殊处理的场景才使用其他注解或者定制序列化方案。使用钩子接口<code>Jackson2ObjectMapperBuilderCustomizer</code>可以实现对容器中的<code>ObjectMapper</code>单例中的属性定制：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Bean</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Jackson2ObjectMapperBuilderCustomizer</span> <span style=color:#000>jackson2ObjectMapperBuilderCustomizer</span><span style=color:#ce5c00;font-weight:700>(){</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>customizer</span><span style=color:#ce5c00;font-weight:700>-&gt;{</span>
		<span style=color:#000>customizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serializerByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LocalDateTimeSerializer</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)));</span>
		<span style=color:#000>customizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deserializerByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)));</span>
	<span style=color:#ce5c00;font-weight:700>};</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样就能定制化<code>MappingJackson2HttpMessageConverter</code>中持有的<code>ObjectMapper</code>，上面的<code>LocalDateTime</code>序列化和反序列化器对全局生效。</p>
<h2 id=请求-url-匹配>请求 URL 匹配</h2>
<p>前面基本介绍完了主流的请求参数处理，其实<code>SpringMVC</code>中还会按照<code>URL</code>的模式进行匹配，使用的是<code>Ant</code>路径风格，处理工具类为<code>org.springframework.util.AntPathMatcher</code>，从此类的注释来看，匹配规则主要包括下面四点
：</p>
<ol>
<li><code>?</code>匹配1个字符。</li>
<li><code>*</code>匹配0个或者多个<strong>字符</strong>。</li>
<li><code>**</code>匹配路径中0个或者多个<strong>目录</strong>。</li>
<li>正则支持，如<code>{spring:[a-z]+}</code>将正则表达式[a-z]+匹配到的值，赋值给名为<strong>spring</strong>的路径变量。</li>
</ol>
<p>举些例子：</p>
<p><strong>'?&lsquo;形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern?&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patternd</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patterndd</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patternd</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
</code></pre></div><p><strong>'*&lsquo;形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern*&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patternd</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>a</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
</code></pre></div><p><strong>'**&lsquo;形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/**/p&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>p</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>p</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>p</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
</code></pre></div><p><strong>{spring:[a-z]+}形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/{key:[a-c]+}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;key&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>a</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>ab</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>abc</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>abcd</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
</code></pre></div><p>上面的四种URL模式可以组合使用，千变万化。</p>
<p><code>URL</code>匹配还遵循<strong>精确匹配原则</strong>，也就是存在两个模式对同一个<code>URL</code>都能够匹配成功，则<strong>选取最精确的<code>URL</code>匹配</strong>，进入对应的控制器方法，举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/**/p&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/p&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern2</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面两个控制器，如果请求<code>URL</code>为<code>/pattern/p</code>，最终进入的方法为<code>pattern2</code>。上面的例子只是列举了<code>SpringMVC</code>中<code>URL</code>匹配的典型例子，并没有深入展开。</p>
<p>最后，<code>org.springframework.util.AntPathMatcher</code>作为一个工具类，可以单独使用，不仅仅可以用于匹配<code>URL</code>，也可以用于匹配系统文件路径，不过需要使用其带参数构造改变内部的<code>pathSeparator</code>变量，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>AntPathMatcher</span> <span style=color:#000>antPathMatcher</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AntPathMatcher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>separator</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-914aed954c02642f85974bcb8e314a42>1.8 - CH09-请求过程</h1>
<p>Spring MVC是Spring系列框架中使用频率最高的部分。不管是Spring Boot还是传统的Spring项目，只要是Web项目都会使用到Spring MVC部分。因此程序员一定要熟练掌握MVC部分。本篇博客简要分析Spring MVC处理一个请求的流程。</p>
<p>一个请求从客户端发出到达服务器，然后被处理的整个过程其实是非常复杂的。本博客主要介绍请求到达服务器被核心组件 DispatcherServlet 处理的整理流程（不包括Filter的处理流程）。</p>
<h2 id=处理流程分析>处理流程分析</h2>
<p>Servlet处理一个请求时会调用service()方法，所以DispatcherServlet处理请求的方式也是从service()方法开始（debug的话建议从DispatcherServlet的service方法开始debug）。FrameworkServlet重写了HttpServlet的service方法，这个service方法后面又调用了FrameworkServlet的processRequest()方法，processRequest()调用了DispatcherServlet的doService()方法,最后调用到DispatcherServlet的doDispatcher()方法。整合处理请求的方法调用流程如上，下面看下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>HttpMethod</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HttpMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PATCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//这边调用了HttpServlet的service（）方法，但由于FrameWorkServle重写了doGet、doPost等方法，所以最终还是会调用到processRequest方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>再看看FrameworkServlet的processRequest()方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span>
    		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    	<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#000>Throwable</span> <span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    	<span style=color:#000>LocaleContext</span> <span style=color:#000>previousLocaleContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LocaleContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocaleContext</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#000>LocaleContext</span> <span style=color:#000>localeContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildLocaleContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    	<span style=color:#000>RequestAttributes</span> <span style=color:#000>previousAttributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestAttributes</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#000>ServletRequestAttributes</span> <span style=color:#000>requestAttributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildRequestAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    	<span style=color:#000>WebAsyncManager</span> <span style=color:#000>asyncManager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WebAsyncUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAsyncManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerCallableInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FrameworkServlet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestBindingInterceptor</span><span style=color:#ce5c00;font-weight:700>());</span>
    
    	<span style=color:#000>initContextHolders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localeContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//这边调用DispatcherServlet的doService()方法
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>doService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedServletException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Request processing failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    
    	<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>resetContextHolders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousLocaleContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
    		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestAttributes</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    			<span style=color:#000>requestAttributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestCompleted</span><span style=color:#ce5c00;font-weight:700>();</span>
    		<span style=color:#ce5c00;font-weight:700>}</span>
    
    		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not complete request&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>failureCause</span><span style=color:#ce5c00;font-weight:700>);</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConcurrentHandlingStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Leaving response open for concurrent processing&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    				<span style=color:#ce5c00;font-weight:700>}</span>
    				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Successfully completed request&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    				<span style=color:#ce5c00;font-weight:700>}</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    		<span style=color:#ce5c00;font-weight:700>}</span>
    
    		<span style=color:#000>publishRequestHandledEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>failureCause</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>doService()方法的具体内容会在后面讲到，这边描述下doDispatcher()的内容，参考了<a href=http://www.cnblogs.com/fangjian0423/p/springMVC-dispatcherServlet.html>博客</a>:</p>
<blockquote>
<p>首先根据请求的路径找到HandlerMethod(带有Method反射属性，也就是对应Controller中的方法)，然后匹配路径对应的拦截器，有了HandlerMethod和拦截器构造个HandlerExecutionChain对象。HandlerExecutionChain对象的获取是通过HandlerMapping接口提供的方法中得到。有了HandlerExecutionChain之后，通过HandlerAdapter对象进行处理得到ModelAndView对象，HandlerMethod内部handle的时候，使用各种HandlerMethodArgumentResolver实现类处理HandlerMethod的参数，使用各种HandlerMethodReturnValueHandler实现类处理返回值。 最终返回值被处理成ModelAndView对象，这期间发生的异常会被HandlerExceptionResolver接口实现类进行处理。</p>
</blockquote>
<p>总结下Spring MVC处理一个请求的过程：</p>
<ul>
<li>首先，搜索应用的上下文对象 WebApplicationContext 并把它作为一个属性（attribute）绑定到该请求上，以便控制器和其他组件能够使用它。</li>
<li>将地区（locale）解析器绑定到请求上，以便其他组件在处理请求（渲染视图、准备数据等）时可以获取区域相关的信息。如果你的应用不需要解析区域相关的信息；</li>
<li>将主题（theme）解析器绑定到请求上，以便其他组件（比如视图等）能够了解要渲染哪个主题文件。同样，如果你不需要使用主题相关的特性，忽略它即可如果你配置了multipart文件处理器，那么框架将查找该文件是不是multipart（分为多个部分连续上传）的。若是，则将该请求包装成一个 MultipartHttpServletRequest 对象，以便处理链中的其他组件对它做进一步的处理。关于Spring对multipart文件传输处理的支持；</li>
<li>为该请求查找一个合适的处理器。如果可以找到对应的处理器，则与该处理器关联的整条执行链（前处理器、后处理器、控制器等）都会被执行，以完成相应模型的准备或视图的渲染如果处理器返回的是一个模型（model），那么框架将渲染相应的视图。若没有返回任何模型（可能是因为前后的处理器出于某些原因拦截了请求等，比如，安全问题），则框架不会渲染任何视图，此时认为对请求的处理可能已经由处理链完成了（这个过程就是doService()和doDispatcher()做的事情）</li>
</ul>
<p>1、 首先用户发送请求——>DispatcherServlet，前端控制器收到请求后自己不进行处理，而是委托给其他的解析器进行处理，作为统一访问点，进行全局的流程控制；</p>
<p>2、 DispatcherServlet——>HandlerMapping，HandlerMapping将会把请求映射为HandlerExecutionChain对象（包含一个Handler处理器（页面控制器）对象、多个HandlerInterceptor拦截器）对象，通过这种策略模式，很容易添加新的映射策略；</p>
<p>3、 DispatcherServlet——>HandlerAdapter，HandlerAdapter将会把处理器包装为适配器，从而支持多种类型的处理器，即适配器设计模式的应用，从而很容易支持很多类型的处理器；</p>
<p>4、 HandlerAdapter——>处理器功能处理方法的调用，HandlerAdapter将会根据适配的结果调用真正的处理器的功能处理方法，完成功能处理；并返回一个ModelAndView对象（包含模型数据、逻辑视图名）；</p>
<p>5、 ModelAndView的逻辑视图名——> ViewResolver，ViewResolver将把逻辑视图名解析为具体的View，通过这种策略模式，很容易更换其他视图技术；</p>
<p>6、 View——>渲染，View会根据传进来的Model模型数据进行渲染，此处的Model实际是一个Map数据结构，因此很容易支持其他视图技术；</p>
<p>7、返回控制权给DispatcherServlet，由DispatcherServlet返回响应给用户，到此一个流程结束。</p>
<h2 id=请求流程图>请求流程图</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211015001538.png style=display:block;width:100% alt=NAME align=center> </div>
<p>还是这个图比较清楚。发现根据代码不太能把这个流程说清楚。而且整个流程很长，代码很多，我就不贴代码了。这里根据这个图再把整个流程中组件的功能总结下：</p>
<ul>
<li>
<p><code>DispatcherServlet</code>：核心控制器，所有请求都会先进入<code>DispatcherServlet</code>进行统一分发，是不是感觉有点像外观模式的感觉；</p>
</li>
<li>
<p><code>HandlerMapping</code>：这个组件的作用就是将用户请求的URL映射成一个<code>HandlerExecutionChain</code>。这个<code>HandlerExecutionChain</code>是<code>HandlerMethod</code>和<code>HandlerInterceptor</code>的组合。Spring在启动的时候会默认注入很多<code>HandlerMapping</code>组件，其中最常用的组件就是<code>RequestMappingHandlerMapping</code>。</p>
<p>上面的<code>HandlerMethod</code>和<code>HandlerInterceptor</code>组件分别对应我们Controller中的方法和拦截器。<strong>拦截器会在HandlerMethod方法执行之前执行</strong></p>
</li>
<li>
<p><code>HandlerAdapter</code>组件，这个组件的主要作用是用来对<code>HandlerMethod</code>中参数的转换，对方法的执行，以及对返回值的转换等等。这里面涉及的细节就很多了，包括<code>HandlerMethodArgumentResolver</code>、<code>HandlerMethodReturnValueHandler</code> 、<code>RequestResponseBodyMethodProcessor</code> 、和<code>HttpMessageConvert</code>等组件。</p>
<p>当<code>HandlerAdapter</code>组件执行完成之后会得到一个<code>ModleAndView</code>组件，这个组件代表视图模型。</p>
</li>
<li>
<p>得到<code>ModleAndView</code>后会执行拦截器的<code>postHandle</code>方法。</p>
</li>
<li>
<p>如果在上面的执行过程中发生任何异常，会由HandlerExceptionResolver进行统一处理。</p>
</li>
<li>
<p>最后模型解析器会对上面的到的<code>ModleAndView</code>进行解析，得到一个一个View返回给客户端。在返回客户端之前还会执行拦截器的<code>afterCompletion</code>方法。</p>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f318ab73b27584f92427d5fdaeaa969e>1.9 - CH10-配置注入</h1>
<h2 id=直接注入>直接注入</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.userName=someone
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.userName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=默认值>默认值</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>@Value(value = &#34;${susan.test.userName:susan}&#34;)
private String userName;
</code></pre></div><h2 id=静态变量>静态变量</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.userName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setUserName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>UserService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>userName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=变量类型>变量类型</h2>
<p>在 Java 中的基本数据类型有4类8种，然我们一起回顾一下：</p>
<ul>
<li>整型：byte、short、int、long</li>
<li>浮点型：float、double</li>
<li>布尔型：boolean</li>
<li>字符型：char</li>
</ul>
<p>相对应地提供了8种包装类：</p>
<ul>
<li>整型：Byte、Short、Integer、Long</li>
<li>浮点型：Float、Double</li>
<li>布尔型：Boolean</li>
<li>字符型：Character</li>
</ul>
<p>@Value 注解对这8中基本类型和相应的包装类，有非常良好的支持，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.a:1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.b:100}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>short</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.c:3000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.d:4000000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.e:5.2}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.f:6.1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.g:false}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.h:h}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.a:1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.b:100}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Short</span> <span style=color:#000>b1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.c:3000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>c1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.d:4000000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Long</span> <span style=color:#000>d1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.e:5.2}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Float</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.f:6.1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Double</span> <span style=color:#000>f1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.g:false}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Boolean</span> <span style=color:#000>g1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.h:h}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Character</span> <span style=color:#000>h1</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=数组类型>数组类型</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.array:1,2,3,4,5}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=集合类型>集合类型</h2>
<h3 id=list>List</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.list[0]=10
susan.test.list[1]=11
susan.test.list[2]=12
susan.test.list[3]=13
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;susan.test&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.list}&#39;.split(&#39;,&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=set>Set</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.set=10,11,12,13
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.set}&#39;.split(&#39;,&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>支持空值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.set:}&#39;.empty ? null : &#39;${susan.test.set:}&#39;.split(&#39;,&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=map>Map</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.map={&#34;name&#34;:&#34;苏三&#34;, &#34;age&#34;:&#34;18&#34;}
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.map:}&#39;.empty ? null : &#39;${susan.test.map:}&#39;}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=注入-bean>注入 Bean</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RoleService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DEFAULT_AGE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>18</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getRoleName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;管理员&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getParentId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>2000</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myAge</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.id}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.getRoleName()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myRoleName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.getParentId()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myParentId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myAge</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myRoleName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myParentId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=静态类>静态类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{T(java.io.File).separator}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{T(java.lang.Math).random()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>randomValue</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=逻辑运算>逻辑运算</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.roleName + &#39;&#39; + roleService.DEFAULT_AGE}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE &gt; 16 and roleService.roleName.equals(&#39;苏三&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE &gt; 16 ? roleService.roleName: &#39;苏三&#39; }&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>realRoleName</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=-与-><code>${}</code> 与 <code>#{}</code></h2>
<h3 id=heading><code>${}</code></h3>
<p>用于获取配置文件中的系统属性值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${susan.test.userName:susan}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>通过 <code>:</code> 可以设置默认值。如果在配置文件中找不到susan.test.userName的配置，则注入时用默认值。</p>
<h3 id=heading-1><code>#{}</code></h3>
<p>主要用于通过spring的EL表达式，获取bean的属性，或者调用bean的某个方法。还有调用类的静态常量和静态方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myAge</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.id}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.getRoleName()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myRoleName</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{T(java.lang.Math).random()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>randomValue</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>如果是调用类的静态方法，则需要加T(包名 + 方法名称)。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-edd784317807198b5ce95957ab1805fa>1.10 - CH11-配置绑定</h1>
<p>使用 <code>@Value("${property}")</code> 注释注入配置属性有时会很麻烦，尤其是当你使用多个属性或你的数据是分层的时候。</p>
<p>Spring Boot 引入了一个可替换的方案 —— @ConfigurationProperties 来注入属性。</p>
<h2 id=javabean-属性绑定>JavaBean 属性绑定</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 我们可以简单地用一个值初始化一个字段来定义一个默认值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Security</span> <span style=color:#000>security</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Security</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Data</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Security</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果这个属性配置的话，默认是“USER”
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;USER&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在配置文件中进行如下配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>my</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>remoteAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>security</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>csx</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passwoed</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>role1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>role2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>最后生成的 Bean 的属性如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;enabled&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;remoteAddress&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;security&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;username&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;csx&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;passwoed&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;roles&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
      <span style=color:#4e9a06>&#34;role1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#4e9a06>&#34;role2&#34;</span>
    <span style=color:#000;font-weight:700>]</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>以上的绑定当时需要提供默认的构造函数，以及get/setter方法。</p>
<p>并且不支持 JavaBean 中的静态成员变量的数据绑定</p>
</blockquote>
<p>另外，@ConfigurationProperties 还有两个其他属性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>ignoreInvalidFields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>ignoreUnknownFields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>ignoreInvalidFields：是否忽略非法值，比如将一个字符串 “foo” 赋值给 bool 值，不忽略的话会报启动异常。</p>
<p>ignoreUnknownFields：对于多余的配置是否会报异常。</p>
<h2 id=构造函数绑定>构造函数绑定</h2>
<p>有些情况下，我们需要绑定的 JavaBean 是不可变的（防止配置注入 Bean 以后，开发者在程序中错误地将配置改掉了）。这种情况下我们可以使用构造函数形式的绑定，只提供 getter 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Getter</span>
<span style=color:#5c35cc;font-weight:700>@ConstructorBinding</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Security</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Security</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Getter</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Security</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Security</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@DefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>password</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>@DefaultValue 可以指定默认值。</p>
<blockquote>
<p>使用构造函数绑定的方式，只能 @EnableConfigurationProperties 或者 @ConfigurationPropertiesScan 的方式激活 Bean。而不能使用 @Component、@Bean 或者 @Import 的方式进行数据绑定。</p>
</blockquote>
<p>如果你的类有多个构造函数，可以直接指定使用哪个。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ConstructorBinding</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Security</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=激活方式>激活方式</h2>
<p><strong>方式一：添加 @Component 注解</strong></p>
<p>上面的方式需要保证 MyProperties 能被 Spring 扫到。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>方式二：通过 @Bean 方法</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyProperties</span> <span style=color:#000>myProperties</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>方式三：@EnableConfigurationProperties（推荐）</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@EnableConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>方式四：@ConfigurationPropertiesScan</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@SpringBootApplication</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationPropertiesScan</span><span style=color:#ce5c00;font-weight:700>({</span> <span style=color:#4e9a06>&#34;com.example.app&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.example.another&#34;</span> <span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyApplication</span> <span style=color:#ce5c00;font-weight:700>{</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=引用方式>引用方式</h2>
<p>我们通过配置在 Spring 容器中生成了配置 Bean，那么需要怎么使用他们呢？</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 依赖注入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MyProperties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRemoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MyProperties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 通过构造函数注入，一般推荐这种方式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyProperties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRemoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=给第三方类绑定值>给第三方类绑定值</h2>
<p>假如某些类不是你自己开发的，你也想使用 @ConfigurationProperties 的方式给他绑定值，那么可以进行下面的方式进行配置。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyBeanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThirdPartyConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;another&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnotherComponent</span> <span style=color:#000>anotherComponent</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnotherComponent</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=宽松绑定原则relaxed-binding>宽松绑定原则（Relaxed Binding）</h2>
<p>所谓的宽松绑定原则是指：并不是 JavaBean 中的属性必须要和配置文件中的一致才能绑定数据，context-path 也能绑定到 contextPath 属性上。下面举个列子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;my.main-project.person&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyPersonProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFirstName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面的几种方式，都能将配置文件或者环境变量中的值绑定到 firstName 上。</p>
<table>
<thead>
<tr>
<th>形式</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>my.main-project.person.first-name</code></td>
<td>推荐使用在 <code>.properties</code> and <code>.yml</code> files.</td>
</tr>
<tr>
<td><code>my.main-project.person.firstName</code></td>
<td>Standard camel case syntax.</td>
</tr>
<tr>
<td><code>my.main-project.person.first_name</code></td>
<td>推荐使用在 <code>.properties</code> and <code>.yml</code> files.</td>
</tr>
<tr>
<td><code>MY_MAINPROJECT_PERSON_FIRSTNAME</code></td>
<td>推荐使用在系统环境变量读取配置时使用</td>
</tr>
</tbody>
</table>
<h2 id=和-value-对比>和 @Value 对比</h2>
<p>@Value 是 Spring Framework 中的注解，而 @ConfigurationProperties 是在 Spring Boot 中引入的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211015002016.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-72976b5fc4d547c63c1244ea27bda80b>1.11 - CH12-环境变量</h1>
<h2 id=environment-接口介绍>Environment 接口介绍</h2>
<p>在 Spring 中，Environment 接口主要管理应用程序两个方面的内容：profile 和 properties。</p>
<p>profile 可以简单的等同于环境，比如说平时项目中常见的环境有开发（dev）、测试（stg）和生产（prod），Spring 启动的时候可以设置激活具体的环境。<strong>当然，这个 profile 我们还可以为其赋予很多含义，这个主要看你的业务。比如说，你开发的软件会交付给客户A，也会交付给客户B，那么这个 profile 也可以定义成客户的含义</strong>。</p>
<p>properties 是配置，配置的来源有很多，可以是配置文件、JVM 的参数、系统的环境变量、JNDI、Sevlet Contxet 参数以及 Map 对象等，使用 Environment 接口，可以方便的获取这些配置。</p>
<h2 id=bean-definition-profiles>Bean Definition Profiles</h2>
<h3 id=使用-profile>使用 @Profile</h3>
<p>Spring 容器可以根据不同的 profile 配置不同的 Bean。这个特性可以帮助你实现很多灵活的功能，比如：</p>
<ul>
<li>开发环境使用内存数据库，测试和生产环境才使用关系型数据库，比如 Mysql 和 Oracle 等</li>
<li>交互给客户 A 的软件使用 A 特性，交付给客户 B 的软件使用 B 特性</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@Profile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StandaloneDataConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EmbeddedDatabaseBuilder</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmbeddedDatabaseType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>HSQL</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addScript</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/schema.sql&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addScript</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/test-data.sql&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@Profile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;production&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JndiDataConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>destroyMethod</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Context</span> <span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InitialContext</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lookup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java:comp/env/jdbc/datasource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对比上面的两个配置，我们发现 @Profile 非常适合在两个环境下，Bean 的定义完全不一样的情况，如果两个 Bean 的定义是一样的，只是一些参数不一样的话，我们完全可以使用配置文件的方式实现。</p>
<p>@Profile 注解后面的表达式可以是一个简单的字符串，也可以是一个逻辑运算符。@Profile 支持如下的逻辑运算符。</p>
<ul>
<li>!: A logical “not” of the profile</li>
<li>&: A logical “and” of the profiles</li>
<li>|: A logical “or” of the profiles</li>
</ul>
<p>说明：</p>
<blockquote>
<p>If a <code>@Configuration</code> class is marked with <code>@Profile</code>, all of the <code>@Bean</code> methods and <code>@Import</code> annotations associated with that class are bypassed unless one or more of the specified profiles are active. If a <code>@Component</code> or <code>@Configuration</code> class is marked with <code>@Profile({"p1", "p2"})</code>, that class is not registered or processed unless profiles &lsquo;p1&rsquo; or &lsquo;p2&rsquo; have been activated.</p>
</blockquote>
<h3 id=使用-xml-方式配置>使用 xml 方式配置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns:jdbc=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/jdbc&#34;</span>
       <span style=color:#c4a000>xmlns:jee=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/jee&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;...&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- other bean definitions --&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;jdbc:embedded-database</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;jdbc:script</span> <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/schema.sql&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;jdbc:script</span> <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/test-data.sql&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/jdbc:embedded-database&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;production&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;jee:jndi-lookup</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span> <span style=color:#c4a000>jndi-name=</span><span style=color:#4e9a06>&#34;java:comp/env/jdbc/datasource&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</code></pre></div><h3 id=激活-profile>激活 profile</h3>
<p><strong>1. API 方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>AnnotationConfigApplicationContext</span> <span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#8f5902;font-style:italic>// 设置激活的 profile
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setActiveProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SomeConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StandaloneDataConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JndiDataConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p><strong>2. 命令行方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>-Dspring.profiles.active=&#34;profile1,profile2&#34;
</code></pre></div><p><strong>3. 配置文件方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>profiles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>active</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dev</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=默认的-profile>默认的 profile</h3>
<p>Spring 默认的 profile 是 <code>default</code>，可以通过 Environment 的 API 进行修改。</p>
<h2 id=propertysource-接口>PropertySource 接口</h2>
<p>PropertySource 接口是对任何形式的 key-value 键值对的抽象。</p>
<h2 id=propertysource>@PropertySource</h2>
<p>@PropertySource 这个注解的作用是将配置文件中的键值对放入Environment。这个注解的作用和传统配置方式中的 context:place-hold一致。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@PropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:/com/myco/app.properties&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#000>Environment</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TestBean</span> <span style=color:#000>testBean</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>TestBean</span> <span style=color:#000>testBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TestBean</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>testBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;testbean.name&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>testBean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>经过上面这样的配置，我们就可以使用 <code>${key}</code> 这种形式来取变量的值。<strong>有时如果我们没配置 key 的值，Spring 会抛异常。这时我们可以使用 <code>${key:defaultvalue} </code>这种形式配置默认值</strong>。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-039b5c839fd17f348bd6285b0e09c8a0>2 - Spring IOC</h1>
<h2 id=spring-模块结构>Spring 模块结构</h2>
<p>Spring 是分模块开发的，Spring 包含了很多模块，其中最为核心的是 bean 容器相关模块。像 AOP、MVC、Data 等模块都要依赖 bean 容器。这里先看一下 Spring 框架的结构图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010163540.png style=display:block;width:80% alt=NAME align=center> </div>
<p>从上图中可以看出Core Container处于整个框架的最底层（忽略 Test 模块），在其之上有 AOP、Data、Web 等模块。既然 Spring 容器是最核心的部分，那么大家如果要读 Spring 的源码，容器部分必须先弄懂。</p>
<h2 id=spring-ioc-特性介绍>Spring IOC 特性介绍</h2>
<h3 id=alias>alias</h3>
<p>alias 的中文意思是“别名”，在 Spring 中，我们可以使用 alias 标签给 bean 起个别名。比如下面的配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.Hello&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;content&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;alias-hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;alias-hello&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;double-alias-hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>这里我们给<code>hello</code>这个 beanName 起了一个别名<code>alias-hello</code>，然后又给别名<code>alias-hello</code>起了一个别名<code>double-alias-hello</code>。我们可以通过这两个别名获取到<code>hello</code>这个 bean 实例，比如下面的测试代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testAlias</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-alias.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;    alias-hello -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;alias-hello&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;double-alias-hello -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;double-alias-hello&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=autowire>autowire</h3>
<p>autowire 即自动注入的意思，通过使用 autowire 特性，我们就不用再显式的配置 bean 之间的依赖了。把依赖的发现和注入都交给 Spring 去处理，省时又省力。autowire 几个可选项，比如 byName、byType 和 constructor 等。autowire 是一个常用特性，相信大家都比较熟悉了，所以本节我们就 byName 为例，快速结束 autowire 特性的介绍。</p>
<p>当 bean 配置中的 autowire = byName 时，Spring 会首先通过反射获取该 bean 所依赖 bean 的名字（beanName），然后再通过调用 BeanFactory.getName(beanName) 方法即可获取对应的依赖实例。autowire = byName 原理大致就是这样，接下来我们来演示一下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Service</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Dao</span> <span style=color:#000>mysqlDao</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Dao</span> <span style=color:#000>mongoDao</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 忽略 getter/setter
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\n\t\t\t\t\t{&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
            <span style=color:#4e9a06>&#34;mysqlDao=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mysqlDao</span> <span style=color:#ce5c00;font-weight:700>+</span>
            <span style=color:#4e9a06>&#34;, mongoDao=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mongoDao</span> <span style=color:#ce5c00;font-weight:700>+</span>
            <span style=color:#4e9a06>&#39;}&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Dao</span> <span style=color:#ce5c00;font-weight:700>{}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MySqlDao</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Dao</span> <span style=color:#ce5c00;font-weight:700>{}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MongoDao</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Dao</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mongoDao&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.MongoDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mysqlDao&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.MySqlDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

<span style=color:#8f5902;font-style:italic>&lt;!-- 非自动注入，手动配置依赖 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;service-without-autowire&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.Service&#34;</span> <span style=color:#c4a000>autowire=</span><span style=color:#4e9a06>&#34;no&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mysqlDao&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;mysqlDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mongoDao&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;mongoDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#8f5902;font-style:italic>&lt;!-- 通过设置 autowire 属性，我们就不需要像上面那样显式配置依赖了 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;service-with-autowire&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.Service&#34;</span> <span style=color:#c4a000>autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-autowire.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-without-autowire -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-without-autowire&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-with-autowire -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-with-autowire&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</code></pre></div><p>两种方式配置方式都能完成解决 bean 之间的依赖问题。只不过使用 autowire 会更加省力一些，配置文件也不会冗长。这里举的例子比较简单，假使一个 bean 依赖了十几二十个 bean，再手动去配置，恐怕就很难受了。</p>
<h3 id=factorybean>FactoryBean</h3>
<p>FactoryBean？看起来是不是很像 BeanFactory 孪生兄弟。不错，他们看起来很像，但是他们是不一样的。FactoryBean 是一种工厂 bean，与普通的 bean 不一样，FactoryBean 是一种可以产生 bean 的 bean，好吧说起来很绕嘴。FactoryBean 是一个接口，我们可以实现这个接口。下面演示一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloFactoryBean</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Hello</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getObjectType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;helloFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.HelloFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testFactoryBean</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-factory-bean.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;helloFactory -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;helloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&amp;helloFactory -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&amp;helloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当我们调用 getBean(&ldquo;helloFactory&rdquo;) 时，ApplicationContext 会返回一个 Hello 对象，该对象是 HelloFactoryBean 的 getObject 方法所创建的。如果我们想获取 HelloFactoryBean 本身，则可以在 helloFactory 前加上一个前缀<code>&</code>，即<code>&helloFactory</code>。</p>
<h3 id=factory-method>factory-method</h3>
<p>介绍完 FactoryBean，本节再来看看了一个和工厂相关的特性 &ndash; factory-method。factory-method 可用于标识静态工厂的工厂方法（工厂方法是静态的），直接举例说明吧：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StaticHelloFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Hello</span> <span style=color:#000>getHello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;created by StaticHelloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;staticHelloFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.StaticHelloFactory&#34;</span> <span style=color:#c4a000>factory-method=</span><span style=color:#4e9a06>&#34;getHello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testFactoryMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-factory-method.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;staticHelloFactory -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;staticHelloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于非静态工厂，需要使用 factory-bean 和 factory-method 两个属性配合。关于 factory-bean 这里就不继续说了，留给大家自己去探索吧。</p>
<h3 id=lookup-method>lookup-method</h3>
<p>我们通过 BeanFactory getBean 方法获取 bean 实例时，对于 singleton 类型的 bean，BeanFactory 每次返回的都是同一个 bean。对于 prototype 类型的 bean，BeanFactory 则会返回一个新的 bean。</p>
<p>现在考虑这样一种情况，一个 singleton 类型的 bean 中有一个 prototype 类型的成员变量。BeanFactory 在实例化 singleton 类型的 bean 时，会向其注入一个 prototype 类型的实例。但是 singleton 类型的 bean 只会实例化一次，那么它内部的 prototype 类型的成员变量也就不会再被改变。</p>
<p>但如果我们每次从 singleton bean 中获取这个 prototype 成员变量时，都想获取一个新的对象。这个时候怎么办？</p>
<p>举个例子，我们有一个新闻提供类（NewsProvider），这个类中有一个新闻类（News）成员变量。我们每次调用 getNews 方法都想获取一条新的新闻。这里我们有两种方式实现这个需求，一种方式是让 NewsProvider 类实现 ApplicationContextAware 接口（实现 BeanFactoryAware 接口也是可以的），每次调用 NewsProvider 的 getNews 方法时，都从 ApplicationContext 中获取一个新的 News 实例，返回给调用者。第二种方式就是这里的 lookup-method 了，Spring 会在运行时对 NewsProvider 进行增强，使其 getNews 可以每次都返回一个新的实例。说完了背景和解决方案，接下来就来写点测试代码验证一下。</p>
<p>在演示两种处理方式前，我们先来看看不使用任何处理方式，BeanFactory 所返回的 bean 实例情况。相关类定义如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>News</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 仅演示使用，News 类中无成员变量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NewsProvider</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>News</span> <span style=color:#000>getNews</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNews</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>news</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置信息如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;news&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.News&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.NewsProvider&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;news&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;news&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-lookup-method.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>NewsProvider</span> <span style=color:#000>newsProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NewsProvider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>从测试结果中可以看出，newsProvider.getNews() 方法两次返回的结果都是一样的，这个是不满足要求的。</p>
<h4 id=实现-applicationcontextaware-接口>实现 ApplicationContextAware 接口</h4>
<p>我们让 NewsProvider 实现 ApplicationContextAware 接口，实现代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NewsProvider</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationContextAware</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/** 每次都从 applicationContext 中获取一个新的 bean */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>News</span> <span style=color:#000>getNews</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;news&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>News</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNews</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>news</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=使用-lookup-method-特性>使用 lookup-method 特性</h4>
<p>使用 lookup-method 特性，配置文件需要改一下。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;news&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.News&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.NewsProvider&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;lookup-method</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;getNews&#34;</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;news&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>NewsProvider 的代码沿用 4.5.1 小节之前贴的代码。测试代码稍微变一下，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-lookup-method.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>NewsProvider</span> <span style=color:#000>newsProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NewsProvider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;newsProvider -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;news 1 -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;news 2 -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><h3 id=depends-on>depends-on</h3>
<p>当一个 bean 直接依赖另一个 bean，可以使用 <code>&lt;ref/></code> 标签进行配置。不过如某个 bean 并不直接依赖于 其他 bean，但又需要其他 bean 先实例化好，这个时候就需要使用 depends-on 特性了。depends-on 特性比较简单，就不演示了。仅贴一下配置文件的内容，如下：</p>
<p>这里有两个简单的类，其中 Hello 需要 World 在其之前完成实例化。相关配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.depnedson.Hello&#34;</span> <span style=color:#c4a000>depends-on=</span><span style=color:#4e9a06>&#34;world&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;world&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.depnedson.World&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h3 id=beanpostprocessor>BeanPostProcessor</h3>
<p>BeanPostProcessor 是 bean 实例化时的后置处理器，包含两个方法，其源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// bean 初始化前的回调方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// bean 初始化后的回调方法    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BeanPostProcessor 是 Spring 框架的一个扩展点，通过实现 BeanPostProcessor 接口，我们就可插手 bean 实例化的过程。比如大家熟悉的 AOP 就是在 bean 实例后期间将切面逻辑织入 bean 实例中的，AOP 也正是通过 BeanPostProcessor 和 IOC 容器建立起了联系。这里我来演示一下 BeanPostProcessor 的使用方式，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 日志后置处理器，将会在 bean 创建前、后打印日志
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LoggerBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#000;font-weight:700>{</span>

    <span style=color:#a40000>@</span><span style=color:#000>Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>Object</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>String</span> <span style=color:#000>beanName</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Before &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; Initialization&#34;</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#a40000>@</span><span style=color:#000>Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>Object</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>String</span> <span style=color:#000>beanName</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;After &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; Initialization&#34;</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;xyz.coolblog.beanpostprocessor.LoggerBeanPostProcessor&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
    
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#204a87;font-weight:700>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.Hello&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;world&#34;</span> <span style=color:#204a87;font-weight:700>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.World&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#000;font-weight:700>{</span>

    <span style=color:#a40000>@</span><span style=color:#000>Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testBeanPostProcessor</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-bean-post-processor.xml&#34;</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>与 BeanPostProcessor 类似的还有一个叫 BeanFactoryPostProcessor 拓展点，顾名思义，用户可以通过这个拓展点插手容器启动的过程。不过这个不属于本系列文章范畴，暂时先不细说了。</p>
<h3 id=beanfactoryaware>BeanFactoryAware</h3>
<p>Spring 中定义了一些列的 Aware 接口，比如这里的 BeanFactoryAware，以及 BeanNameAware 和 BeanClassLoaderAware 等等。通过实现这些 Aware 接口，我们可以在运行时获取一些配置信息或者其他一些信息。比如实现 BeanNameAware 接口，我们可以获取 bean 的配置名称（beanName）。通过实现 BeanFactoryAware 接口，我们可以在运行时获取 BeanFactory 实例。关于 Aware 类型接口的使用，可以参考<code>实现 ApplicationContextAware 接口</code>一节中的叙述，这里就不演示了。</p>
<h2 id=reference>Reference</h2>
<ul>
<li>原文链接：<a href=https://cloud.tencent.com/developer/article/1138679>https://cloud.tencent.com/developer/article/1138679</a></li>
<li>原文链接：<a href=https://segmentfault.com/a/1190000023033670>https://segmentfault.com/a/1190000023033670</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-058d34bd471ff0fb89f33ccbc6c6f744>2.1 - CH01-获取单例 Bean</h1>
<h2 id=getbean>getBean</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// getBean 是一个空壳方法，所有的逻辑都封装在 doGetBean 方法中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 通过 name 获取 beanName。这里不使用 name 直接作为 beanName 有两点原因：
</span><span style=color:#8f5902;font-style:italic>     * 1. name 可能会以 &amp; 字符开头，表明调用者想获取 FactoryBean 本身，而非 FactoryBean 
</span><span style=color:#8f5902;font-style:italic>     *    实现类所创建的 bean。在 BeanFactory 中，FactoryBean 的实现类和其他的 bean 存储
</span><span style=color:#8f5902;font-style:italic>     *    方式是一致的，即 &lt;beanName, bean&gt;，beanName 中是没有 &amp; 这个字符的。所以我们需要
</span><span style=color:#8f5902;font-style:italic>     *    将 name 的首字符 &amp; 移除，这样才能从缓存里取到 FactoryBean 实例。
</span><span style=color:#8f5902;font-style:italic>     * 2. 若 name 是一个别名，则应将别名转换为具体的实例名，也就是 beanName。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 从缓存中获取单例 bean。Spring 是使用 Map 作为 beanName 和 bean 实例的缓存的，所以这
</span><span style=color:#8f5902;font-style:italic>     * 里暂时可以把 getSingleton(beanName) 等价于 beanMap.get(beanName)。当然，实际的
</span><span style=color:#8f5902;font-style:italic>     * 逻辑并非如此简单，后面再细说。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。
</span><span style=color:#8f5902;font-style:italic>     * BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取 
</span><span style=color:#8f5902;font-style:italic>     * bean 时再实例化，也就是懒加载。
</span><span style=color:#8f5902;font-style:italic>     * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取
</span><span style=color:#8f5902;font-style:italic>     * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数
</span><span style=color:#8f5902;font-style:italic>     * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有
</span><span style=color:#8f5902;font-style:italic>     * 用了，BeanFactory 不会多次实例化单例 bean。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果 
</span><span style=color:#8f5902;font-style:italic>         * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的 
</span><span style=color:#8f5902;font-style:italic>         * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回
</span><span style=color:#8f5902;font-style:italic>         * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean 
</span><span style=color:#8f5902;font-style:italic>     * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例
</span><span style=color:#8f5902;font-style:italic>     * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 如果 sharedInstance = null，则到父容器中查找 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 name 对应的 beanName，如果 name 是以 &amp; 字符开头，则返回 &amp; + beanName
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 根据 args 是否为空，以决定调用父容器哪个方法获取 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> 
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并父 BeanDefinition 与子 BeanDefinition，后面会单独分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，
</span><span style=color:#8f5902;font-style:italic>                     * B 又依赖 A，他们的配置如下：
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanA&#34; class=&#34;BeanA&#34; depends-on=&#34;beanB&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanB&#34; class=&#34;BeanB&#34; depends-on=&#34;beanA&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   
</span><span style=color:#8f5902;font-style:italic>                     * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它
</span><span style=color:#8f5902;font-style:italic>                     * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接
</span><span style=color:#8f5902;font-style:italic>                     * 抛出异常
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; and &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 注册依赖记录
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 加载 depends-on 依赖
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> 
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过 
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法会在内部调用 
</span><span style=color:#8f5902;font-style:italic>                 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，
</span><span style=color:#8f5902;font-style:italic>                 * 将 bean 放入缓存中。关于 getSingleton 方法的分析，本文先不展开，我会在
</span><span style=color:#8f5902;font-style:italic>                 * 后面的文章中进行分析
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
                <span style=color:#8f5902;font-style:italic>// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 prototype 类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建其他类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@Override</span>
                        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Scope &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 如果需要进行类型转换，则在此处进行转换。类型转换这一块我没细看，就不多说了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQualifiedName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=执行流程>执行流程</h2>
<ol>
<li>转换 beanName</li>
<li>从缓存中获取实例</li>
<li>如果实例不为空，且 args=null，调用 getObjectForBeanInstance 方法，并按 name 规则返回相应 bean 实例</li>
<li>如果实例为空，则到父容器中查找 beanName 对应的 bean 实例，存在则直接返回</li>
<li>如果父容器中不存在，则进行下一步操作——合并 BeanDefinition</li>
<li>处理 depends-on 依赖</li>
<li>创建并缓存 bean</li>
<li>调用 getObjectForBeanInstance 方法，并按那么规则返回对应 bean 实例</li>
<li>按需转换 bean 类型，并返回转换后的 bean 实例</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011224524.png style=display:block;width:60% alt=NAME align=center> </div>
<h2 id=beanname-转换>beanName 转换</h2>
<p>在获取 bean 实例之前，Spring 第一件要做的事情是对参数 name 进行转换。转换的目的主要是为了解决两个问题，第一个是处理以字符 & 开头的 name，防止 BeanFactory 无法找到与 name 对应的 bean 实例。第二个是处理别名问题，Spring 不会存储 &lt;别名, bean 实例> 这种映射，仅会存储 &lt;beanName, bean>。所以，同样是为了避免 BeanFactory 找不到 name 对应的 bean 的实例，对于别名也要进行转换。接下来，我们来简单分析一下转换的过程，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>String</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 这里调用了两个方法：BeanFactoryUtils.transformedBeanName(name) 和 canonicalName
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/** 该方法用于处理 &amp; 字符 */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#39;name&#39; must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 循环处理 &amp; 字符。比如 name = &#34;&amp;&amp;&amp;&amp;&amp;helloService&#34;，最终会被转成 helloService
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FACTORY_BEAN_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FACTORY_BEAN_PREFIX</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/** 该方法用于转换别名 */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>canonicalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>resolvedName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 这里使用 while 循环进行处理，原因是：可能会存在多重别名的问题，即别名指向别名。比如下面
</span><span style=color:#8f5902;font-style:italic>     * 的配置：
</span><span style=color:#8f5902;font-style:italic>     *   &lt;bean id=&#34;hello&#34; class=&#34;service.Hello&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>     *   &lt;alias name=&#34;hello&#34; alias=&#34;aliasA&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>     *   &lt;alias name=&#34;aliasA&#34; alias=&#34;aliasB&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * 上面的别名指向关系为 aliasB -&gt; aliasA -&gt; hello，对于上面的别名配置，aliasMap 中数据
</span><span style=color:#8f5902;font-style:italic>     * 视图为：aliasMap = [&lt;aliasB, aliasA&gt;, &lt;aliasA, hello&gt;]。通过下面的循环解析别名
</span><span style=color:#8f5902;font-style:italic>     * aliasB 最终指向的 beanName
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aliasMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>canonicalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedName</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=从缓存获取-bean-实例>从缓存获取 bean 实例</h2>
<p>对于单例 bean，Spring 容器只会实例化一次。后续再次获取时，只需直接从缓存里获取即可，无需且不能再次实例化（否则单例就没意义了）。从缓存中取 bean 实例的方法是<code>getSingleton(String)</code>，下面我们就来看看这个方法实现方式吧。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 这里解释一下 allowEarlyReference 参数，allowEarlyReference 表示是否允许其他 bean 引用
</span><span style=color:#8f5902;font-style:italic> * 正在创建中的 bean，用于处理循环引用的问题。关于循环引用，这里先简单介绍一下。先看下面的配置：
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> *   &lt;bean id=&#34;hello&#34; class=&#34;xyz.coolblog.service.Hello&#34;&gt;
</span><span style=color:#8f5902;font-style:italic> *       &lt;property name=&#34;world&#34; ref=&#34;world&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic> *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic> *   &lt;bean id=&#34;world&#34; class=&#34;xyz.coolblog.service.World&#34;&gt;
</span><span style=color:#8f5902;font-style:italic> *       &lt;property name=&#34;hello&#34; ref=&#34;hello&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic> *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic> * 
</span><span style=color:#8f5902;font-style:italic> * 如上所示，hello 依赖 world，world 又依赖于 hello，他们之间形成了循环依赖。Spring 在构建 
</span><span style=color:#8f5902;font-style:italic> * hello 这个 bean 时，会检测到它依赖于 world，于是先去实例化 world。实例化 world 时，发现 
</span><span style=color:#8f5902;font-style:italic> * world 依赖 hello。这个时候容器又要去初始化 hello。由于 hello 已经在初始化进程中了，为了让 
</span><span style=color:#8f5902;font-style:italic> * world 能完成初始化，这里先让 world 引用正在初始化中的 hello。world 初始化完成后，hello 
</span><span style=color:#8f5902;font-style:italic> * 就可引用到 world 实例，这样 hello 也就能完成初始了。关于循环依赖，我后面会专门写一篇文章讲
</span><span style=color:#8f5902;font-style:italic> * 解，这里先说这么多。
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从 singletonObjects 获取实例，singletonObjects 中缓存的实例都是完全实例化好的 bean，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 singletonObject = null，表明还没创建，或者还没完全创建好。
</span><span style=color:#8f5902;font-style:italic>     * 这里判断 beanName 对应的 bean 是否正在创建中
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从 earlySingletonObjects 中获取提前曝光的 bean，用于处理循环引用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 如果如果 singletonObject = null，且允许提前曝光 bean 实例，则从相应的 ObjectFactory 获取一个原始的（raw）bean（尚未填充属性）
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获取相应的工厂类
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 提前曝光 bean 实例，用于解决循环依赖
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 放入缓存中，如果还有其他 bean 依赖当前 bean，其他 bean 可以直接从 earlySingletonObjects 取结果
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码虽然不长，但是涉及到了好几个缓存集合。如果不知道这些缓存的用途是什么，上面源码可能就很难弄懂了。这几个缓存集合用的很频繁，在后面的代码中还会出现，所以这里介绍一下。如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>缓存</th>
<th style=text-align:left>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>singletonObjects</td>
<td style=text-align:left>用于存放完全初始化好的 bean，从该缓存中取出的 bean 可以直接使用</td>
</tr>
<tr>
<td style=text-align:left>earlySingletonObjects</td>
<td style=text-align:left>用于存放还在初始化中的 bean，用于解决循环依赖</td>
</tr>
<tr>
<td style=text-align:left>singletonFactories</td>
<td style=text-align:left>用于存放 bean 工厂。bean 工厂所产生的 bean 是还未完成初始化的 bean。如代码所示，bean 工厂所生成的对象最终会被缓存到 earlySingletonObjects 中</td>
</tr>
</tbody>
</table>
<h2 id=合并-beandefinition>合并 BeanDefinition</h2>
<p>Spring 支持配置继承，在 <bean> 标签中可以使用<code>parent</code>属性配置父类 bean。这样子类 bean 可以继承父类 bean 的配置信息，同时也可覆盖父类中的配置。比如下面的配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.innerbean.Hello&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;content&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello-child&#34;</span> <span style=color:#c4a000>parent=</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;content&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;I`m hello-child&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>如上所示，hello-child 配置继承自 hello。hello-child 未配置 class 属性，这里我们让它继承父配置中的 class 属性。然后我们写点代码测试一下，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-parent-bean.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello-child -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello-child&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</code></pre></div><p>hello-child 在未配置 class 的属性下也可以实例化成功，表明它成功继承了父配置的 class 属性。</p>
<p>看完代码演示，接下来我们来看看源码吧。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 检查缓存中是否存在“已合并的 BeanDefinition”，若有直接返回即可
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 调用重载方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 继续调用重载方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 我暂时还没去详细了解 containingBd 的用途，尽管从方法的注释上可以知道 containingBd 的大致用途，但没经过详细分析，就不多说了。见谅
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// bd.getParentName() == null，表明无父配置，这时直接将当前的 BeanDefinition 升级为 RootBeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>cloneBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>BeanDefinition</span> <span style=color:#000>pbd</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>parentBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentName</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 判断父类 beanName 与子类 beanName 名称是否相同。若相同，则父类 bean 一定
</span><span style=color:#8f5902;font-style:italic>                     * 在父容器中。原因也很简单，容器底层是用 Map 缓存 &lt;beanName, bean&gt; 键值对
</span><span style=color:#8f5902;font-style:italic>                     * 的。同一个容器下，使用同一个 beanName 映射两个 bean 实例显然是不合适的。
</span><span style=color:#8f5902;font-style:italic>                     * 有的朋友可能会觉得可以这样存储：&lt;beanName, [bean1, bean2]&gt; ，似乎解决了
</span><span style=color:#8f5902;font-style:italic>                     * 一对多的问题。但是也有问题，调用 getName(beanName) 时，到底返回哪个 bean 
</span><span style=color:#8f5902;font-style:italic>                     * 实例好呢？
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                         * 这里再次调用 getMergedBeanDefinition，只不过参数值变为了 
</span><span style=color:#8f5902;font-style:italic>                         * parentBeanName，用于合并父 BeanDefinition 和爷爷辈的 
</span><span style=color:#8f5902;font-style:italic>                         * BeanDefinition。如果爷爷辈的 BeanDefinition 仍有父 
</span><span style=color:#8f5902;font-style:italic>                         * BeanDefinition，则继续合并
</span><span style=color:#8f5902;font-style:italic>                         */</span>
                        <span style=color:#000>pbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 获取父容器，并判断，父容器的类型，若不是 ConfigurableBeanFactory 则判抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>pbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchBeanDefinitionException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#4e9a06>&#34;Parent name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>parentBeanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is equal to bean name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                                    <span style=color:#4e9a06>&#34;&#39;: cannot be resolved without an AbstractBeanFactory parent&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Could not resolve parent bean definition &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 以父 BeanDefinition 的配置信息为蓝本创建 RootBeanDefinition，也就是“已合并的 BeanDefinition”
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 用子 BeanDefinition 中的属性覆盖父 BeanDefinition 中的属性
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>overrideFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 如果用户未配置 scope 属性，则默认将该属性配置为 singleton
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_SINGLETON</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isCacheBeanMetadata</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 缓存合并后的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=factorybean-获取-bean>FactoryBean 获取 bean</h2>
<p>在经过前面这么多的步骤处理后，到这里差不多就接近 doGetBean 方法的尾声了。在本节中，我们来看看从 FactoryBean 实现类中获取 bean 实例的过程。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 如果 name 以 &amp; 开头，但 beanInstance 却不是 FactoryBean，则认为有问题。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFactoryDereference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>beanInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanIsNotAFactoryException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的判断通过了，表明 beanInstance 可能是一个普通的 bean，也可能是一个 
</span><span style=color:#8f5902;font-style:italic>     * FactoryBean。如果是一个普通的 bean，这里直接返回 beanInstance 即可。如果是 
</span><span style=color:#8f5902;font-style:italic>     * FactoryBean，则要调用工厂方法生成一个 bean 实例。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFactoryDereference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 mbd 为空，则从缓存中加载 bean。FactoryBean 生成的单例 bean 会被缓存
</span><span style=color:#8f5902;font-style:italic>         * 在 factoryBeanObjectCache 集合中，不用每次都创建
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCachedObjectForFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 经过前面的判断，到这里可以保证 beanInstance 是 FactoryBean 类型的，所以可以进行类型转换
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果 mbd 为空，则判断是否存在名字为 beanName 的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// synthetic 字面意思是&#34;合成的&#34;。通过全局查找，我发现在 AOP 相关的类中会将该属性设为 true。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 所以我觉得该字段可能表示某个 bean 是不是被 AOP 增强过，也就是 AOP 基于原始类合成了一个新的代理类。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 不过目前只是猜测，没有深究。如果有朋友知道这个字段的具体意义，还望不吝赐教
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>synthetic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#8f5902;font-style:italic>// 调用 getObjectFromFactoryBean 方法继续获取实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>synthetic</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldPostProcess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * FactoryBean 也有单例和非单例之分，针对不同类型的 FactoryBean，这里有两种处理方式：
</span><span style=color:#8f5902;font-style:italic>     *   1. 单例 FactoryBean 生成的 bean 实例也认为是单例类型。需放入缓存中，供后续重复使用
</span><span style=color:#8f5902;font-style:italic>     *   2. 非单例 FactoryBean 生成的 bean 实例则不会被放入缓存中，每次都会创建新的实例
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getSingletonMutex</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从缓存中取 bean 实例，避免多次创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanObjectCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 使用工厂对象中创建实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>Object</span> <span style=color:#000>alreadyThere</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanObjectCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alreadyThere</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>alreadyThere</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// shouldPostProcess 等价于上一个方法中的 !synthetic，用于表示是否应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>shouldPostProcess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#000>beforeSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>postProcessObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#4e9a06>&#34;Post-processing of FactoryBean&#39;s singleton object failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>afterSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 这里的 beanName 对应于 FactoryBean 的实现类， FactoryBean 的实现类也会被实例化，并被缓存在 singletonObjects 中
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// FactoryBean 所创建的实例会被缓存在 factoryBeanObjectCache 中，供后续调用使用
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanObjectCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NULL_OBJECT</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 获取非单例实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 从工厂类中获取实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>shouldPostProcess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>postProcessObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Post-processing of FactoryBean&#39;s object failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// if 分支的逻辑是 Java 安全方面的代码，可以忽略，直接看 else 分支的代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>AccessControlContext</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PrivilegedActionException</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 调用工厂方法生成 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBeanNotInitializedException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;FactoryBean threw exception on object creation&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;FactoryBean which is currently in creation returned null from getObject&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>getObjectForBeanInstance 及它所调用的方法主要做了如下几件事情：</p>
<ol>
<li>检测参数 beanInstance 的类型，如果是非 FactoryBean 类型的 bean，直接返回</li>
<li>检测 FactoryBean 实现类是否单例类型，针对单例和非单例类型进行不同处理</li>
<li>对于单例 FactoryBean，先从缓存里获取 FactoryBean 生成的实例</li>
<li>若缓存未命中，则调用 FactoryBean.getObject() 方法生成实例，并放入缓存中</li>
<li>对于非单例的 FactoryBean，每次直接创建新的实例即可，无需缓存</li>
<li>如果 shouldPostProcess = true，不管是单例还是非单例 FactoryBean 生成的实例，都要进行后置处理</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f162112b468f360d336fef678e9e61c1>2.2 - CH02-创建单例 Bean</h1>
<p>对于已实例化好的单例 bean，getBean(String) 方法并不会再一次去创建，而是从缓存中获取。如果某个 bean 还未实例化，这个时候就无法命中缓存。此时，就要根据 bean 的配置信息去创建这个 bean 了。相较于<code>getBean(String)</code>方法的实现逻辑，创建 bean 的方法<code>createBean(String, RootBeanDefinition, Object[])</code>及其所调用的方法逻辑上更为复杂一些。</p>
<h2 id=创建入口>创建入口</h2>
<p>在正式分析<code>createBean(String, RootBeanDefinition, Object[])</code>方法前，我们先来看看 createBean 方法是在哪里被调用的。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(...)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 省略不相关代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#5c35cc;font-weight:700>@Override</span>
    		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    		<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#ce5c00;font-weight:700>});</span>
    	<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 省略不相关代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面是 doGetBean 方法的代码片段，从中可以发现 createBean 方法。createBean 方法被匿名工厂类的 getObject 方法包裹，但这个匿名工厂类对象并未直接调用 getObject 方法。而是将自身作为参数传给了<code>getSingleton(String, ObjectFactory)</code>方法，那么我们接下来再去看看一下 <code>getSingleton(String, ObjectFactory) </code>方法的实现。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#39;beanName&#39; must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 从缓存中获取单例 bean，若不为空，则直接返回，不用再初始化
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonsCurrentlyInDestruction</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationNotAllowedException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#4e9a06>&#34;Singleton bean creation not allowed while singletons of this factory are in destruction &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#4e9a06>&#34;(Do not request a bean from a BeanFactory in a destroy method implementation!)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating shared instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>			 * 将 beanName 添加到 singletonsCurrentlyInCreation 集合中，
</span><span style=color:#8f5902;font-style:italic>			 * 用于表明 beanName 对应的 bean 正在创建中
</span><span style=color:#8f5902;font-style:italic>			 */</span>
			<span style=color:#000>beforeSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>recordSuppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>// 通过 getObject 方法调用 createBean 方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>suppressedException</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addRelatedCause</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suppressedException</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>// 将 beanName 从 singletonsCurrentlyInCreation 移除
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>afterSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>			     * 将 &lt;beanName, singletonObject&gt; 键值对添加到 singletonObjects 集合中，
</span><span style=color:#8f5902;font-style:italic>			     * 并从其他集合（比如 earlySingletonObjects）中移除 singletonObject 记录
</span><span style=color:#8f5902;font-style:italic>			     */</span>
				<span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>流程如下：</p>
<ol>
<li>先从 singletonObjects 集合获取 bean 实例，若不为空，则直接返回</li>
<li>若为空，进入创建 bean 实例阶段。先将 beanName 添加到 singletonsCurrentlyInCreation</li>
<li>通过 getObject 方法调用 createBean 方法创建 bean 实例</li>
<li>将 beanName 从 singletonsCurrentlyInCreation 集合中移除</li>
<li>将 &lt;beanName, singletonObject> 映射缓存到 singletonObjects 集合中</li>
</ol>
<p>从上面的分析中，我们知道了 createBean 方法在何处被调用的。那么接下来我们一起深入 createBean 方法的源码中，来看看这个方法具体都做了什么事情。</p>
<h2 id=创建流程>创建流程</h2>
<p>createBean 和 getBean 方法类似，基本上都是空壳方法，只不过 createBean 的逻辑稍微多点，多做了一些事情。下面我们一起看看这个方法的实现逻辑，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>// 解析 bean 的类型
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 处理 lookup-method 和 replace-method 配置，Spring 将这两个配置统称为 override method
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span>
				<span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Validation of method overrides failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 在 bean 初始化前应用后置处理，如果后置处理返回的 bean 不为空，则直接返回
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#4e9a06>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// 调用 doCreateBean 创建 bean
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finished creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>流程如下：</p>
<ol>
<li>解析 bean 类型</li>
<li>处理 lookup-method 和 replace-method 配置</li>
<li>在 bean 初始化前应用后置处理，若后置处理返回的 bean 不为空，则直接返回</li>
<li>若上一步后置处理返回的 bean 为空，则调用 doCreateBean 创建 bean 实例</li>
</ol>
<h2 id=验证准备-override-方法>验证准备 override 方法</h2>
<p>当用户配置了 lookup-method 和 replace-method 时，Spring 需要对目标 bean 进行增强。在增强之前，需要做一些准备工作，也就是 prepareMethodOverrides 中的逻辑。下面来看看这个方法的源码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>MethodOverrides</span> <span style=color:#000>methodOverrides</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>methodOverrides</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodOverride</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>overrides</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodOverrides</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 循环处理每个 MethodOverride 对象
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodOverride</span> <span style=color:#000>mo</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>prepareMethodOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareMethodOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodOverride</span> <span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// 获取方法名为 mo.getMethodName() 的方法数量，当方法重载时，count 的值就会大于1
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodCountForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodName</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#8f5902;font-style:italic>// count = 0，表明根据方法名未找到相应的方法，此时抛出异常
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionValidationException</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#4e9a06>&#34;Invalid method override: no method with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span>
				<span style=color:#4e9a06>&#34;&#39; on class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>// 若 count = 1，表明仅存在已方法名为 mo.getMethodName()，这意味着方法不存在重载
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 方法不存在重载，则将 overloaded 成员变量设为 false
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOverloaded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的源码中，<code>prepareMethodOverrides</code>方法循环调用了<code>prepareMethodOverride</code>方法，并没其他的太多逻辑。主要准备工作都是在 prepareMethodOverride 方法中进行的，所以我们重点关注一下这个方法。</p>
<p>prepareMethodOverride 这个方法主要用于获取指定方法的方法数量 count，并根据 count 的值进行相应的处理。count = 0 时，表明方法不存在，此时抛出异常。count = 1 时，设置 MethodOverride 对象的<code>overloaded</code>成员变量为 false。这样做的目的在于，提前标注名称<code>mo.getMethodName()</code>的方法不存在重载，在使用 CGLIB 增强阶段就不需要进行校验，直接找到某个方法进行增强即可。</p>
<h2 id=实例化前的后置处理>实例化前的后置处理</h2>
<p>后置处理是 Spring 的一个拓展点，用户通过实现 BeanPostProcessor 接口，并将实现类配置到 Spring 的配置文件中（或者使用注解），即可在 bean 初始化前后进行自定义操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#8f5902;font-style:italic>// 检测是否解析过，mbd.beforeInstantiationResolved 的值在下面的代码中会被设置
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeInstantiationResolved</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineTargetType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 应用前置处理
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// 应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// 设置 mbd.beforeInstantiationResolved
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeInstantiationResolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>applyBeanPostProcessorsBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// InstantiationAwareBeanPostProcessor 一般在 Spring 框架内部使用，不建议用户直接使用
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#8f5902;font-style:italic>// bean 初始化前置处理
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>existingBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>existingBean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>beanProcessor</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
	   <span style=color:#8f5902;font-style:italic>// bean 初始化后置处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 resolveBeforeInstantiation 方法中，当前置处理方法返回的 bean 不为空时，后置处理才会被执行。前置处理器是 InstantiationAwareBeanPostProcessor 类型的，该种类型的处理器一般用在 Spring 框架内部，比如 AOP 模块中的<code>AbstractAutoProxyCreator</code>抽象类间接实现了这个接口中的 <code>postProcessBeforeInstantiation</code>方法，所以 AOP 可以在这个方法中生成为目标类的代理对象。</p>
<h2 id=调用-docreatebean>调用 doCreateBean</h2>
<p>在 Spring 中，做事情的方法基本上都是以<code>do</code>开头的，doCreateBean 也不例外。那下面我们就来看看这个方法都做了哪些事情。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>	 * BeanWrapper 是一个基础接口，由接口名可看出这个接口的实现类用于包裹 bean 实例。
</span><span style=color:#8f5902;font-style:italic>	 * 通过 BeanWrapper 的实现类可以方便的设置/获取 bean 实例的属性
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 从缓存中获取 BeanWrapper，并清理相关记录
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanInstanceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>	     * 创建 bean 实例，并将实例包裹在 BeanWrapper 实现类对象中返回。createBeanInstance 
</span><span style=color:#8f5902;font-style:italic>	     * 中包含三种创建 bean 实例的方式：
</span><span style=color:#8f5902;font-style:italic>	     *   1. 通过工厂方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic>	     *   2. 通过构造方法自动注入（autowire by constructor）的方式创建 bean 实例
</span><span style=color:#8f5902;font-style:italic>	     *   3. 通过无参构造方法方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic>		  *
</span><span style=color:#8f5902;font-style:italic>	     * 若 bean 的配置信息中配置了 lookup-method 和 replace-method，则会使用 CGLIB 
</span><span style=color:#8f5902;font-style:italic>	     * 增强 bean 实例。关于这个方法，后面会专门写一篇文章介绍，这里先说这么多。
</span><span style=color:#8f5902;font-style:italic>	     */</span>
		<span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>// 此处的 bean 可以认为是一个原始的 bean 实例，暂未填充属性
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedTargetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>// 这里又遇到后置处理了，此处的后置处理是用于处理已“合并的 BeanDefinition”。关于这种后置处理器具体的实现细节就不深入理解了，大家有兴趣可以自己去看
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * earlySingletonExposure 是一个重要的变量，这里要说明一下。该变量用于表示是否提前暴露
</span><span style=color:#8f5902;font-style:italic>     * 单例 bean，用于解决循环依赖。earlySingletonExposure 由三个条件综合而成，如下：
</span><span style=color:#8f5902;font-style:italic>     *   条件1：mbd.isSingleton() - 表示 bean 是否是单例类型
</span><span style=color:#8f5902;font-style:italic>     *   条件2：allowCircularReferences - 是否允许循环依赖
</span><span style=color:#8f5902;font-style:italic>     *   条件3：isSingletonCurrentlyInCreation(beanName) - 当前 bean 是否处于创建的状态中
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * earlySingletonExposure = 条件1 &amp;&amp; 条件2 &amp;&amp; 条件3 
</span><span style=color:#8f5902;font-style:italic>     *                        = 单例 &amp;&amp; 是否允许循环依赖 &amp;&amp; 是否存于创建状态中。
</span><span style=color:#8f5902;font-style:italic>     */</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
			<span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
					<span style=color:#4e9a06>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// 添加工厂对象到 singletonFactories 缓存中
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#5c35cc;font-weight:700>@Override</span>
			<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 获取早期 bean 的引用，如果 bean 中的方法被 AOP 切点所匹配到，此时 AOP 相关逻辑会介入
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>});</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>// 向 bean 实例中填充属性，populateBean 方法也是一个很重要的方法，后面会专门写文章分析
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>		     * 进行余下的初始化工作，详细如下：
</span><span style=color:#8f5902;font-style:italic>             * 1. 判断 bean 是否实现了 BeanNameAware、BeanFactoryAware、
</span><span style=color:#8f5902;font-style:italic>             *    BeanClassLoaderAware 等接口，并执行接口方法
</span><span style=color:#8f5902;font-style:italic>             * 2. 应用 bean 初始化前置操作
</span><span style=color:#8f5902;font-style:italic>             * 3. 如果 bean 实现了 InitializingBean 接口，则执行 afterPropertiesSet 
</span><span style=color:#8f5902;font-style:italic>             *    方法。如果用户配置了 init-method，则调用相关方法执行自定义初始化逻辑
</span><span style=color:#8f5902;font-style:italic>             * 4. 应用 bean 初始化后置操作
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             * 另外，AOP 相关逻辑也会在该方法中织入切面逻辑，此时的 exposedObject 就变成了
</span><span style=color:#8f5902;font-style:italic>             * 一个代理对象了
</span><span style=color:#8f5902;font-style:italic>		     */</span>
			<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 若 initializeBean 方法未改变 exposedObject 的引用，则此处的条件为 true。
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>// 下面的逻辑我也没完全搞懂，就不分析了。见谅。
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowRawInjectionDespiteWrapping</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
							<span style=color:#4e9a06>&#34;Bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collectionToCommaDelimitedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>// 注册销毁逻辑
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行流程：</p>
<ol>
<li>从缓存中获取 BeanWrapper 实现类对象，并清理相关记录</li>
<li>若未命中缓存，则创建 bean 实例，并将实例包裹在 BeanWrapper 实现类对象中返回</li>
<li>应用 MergedBeanDefinitionPostProcessor 后置处理器相关逻辑</li>
<li>根据条件决定是否提前暴露 bean 的早期引用（early reference），用于处理循环依赖问题</li>
<li>调用 populateBean 方法向 bean 实例中填充属性</li>
<li>调用 initializeBean 方法完成余下的初始化工作</li>
<li>注册销毁逻辑</li>
</ol>
<p>由此也可了解到创建一个 bean 还是很复杂的，这中间要做的事情繁多。比如填充属性、对 BeanPostProcessor 拓展点提供支持等。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-134a7abbdac972a86f3f7920807642b0>2.3 - CH03-创建原始 Bean 对象</h1>
<h2 id=createbeaninstance>createBeanInstance</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 检测类的访问权限。默认情况下，对于非 public 的类，是允许访问的。
</span><span style=color:#8f5902;font-style:italic>     * 若禁止访问，这里会抛出异常
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;Bean class isn&#39;t public, and non-public access not allowed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果工厂方法不为空，则通过工厂方法构建 bean 对象。这种构建 bean 的方式
</span><span style=color:#8f5902;font-style:italic>     * 就不深入分析了，有兴趣的朋友可以自己去看一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 通过“工厂方法”的方式构建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateUsingFactoryMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 当多次构建同一个 bean 时，可以使用此处的快捷路径，即无需再次推断应该使用哪种方式构造实例，
</span><span style=color:#8f5902;font-style:italic>     * 以提高效率。比如在多次构建同一个 prototype 类型的 bean 时，就可以走此处的捷径。
</span><span style=color:#8f5902;font-style:italic>     * 这里的 resolved 和 mbd.constructorArgumentsResolved 将会在 bean 第一次实例
</span><span style=color:#8f5902;font-style:italic>     * 化的过程中被设置，在后面的源码中会分析到，先继续往下看。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowireNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 通过“构造方法自动注入”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 通过“默认构造方法”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 由后置处理器决定返回哪些构造方法，这里不深入分析了
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineConstructorsFromBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 下面的条件分支条件用于判断使用什么方式构造 bean 实例，有两种方式可选 - 构造方法自动
</span><span style=color:#8f5902;font-style:italic>     * 注入和默认构造方法。判断的条件由4部分综合而成，如下：
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     *    条件1：ctors != null -&gt; 后置处理器返回构造方法数组是否为空
</span><span style=color:#8f5902;font-style:italic>     *    
</span><span style=color:#8f5902;font-style:italic>     *    条件2：mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR 
</span><span style=color:#8f5902;font-style:italic>     *              -&gt; bean 配置中的 autowire 属性是否为 constructor    
</span><span style=color:#8f5902;font-style:italic>     *    条件3：mbd.hasConstructorArgumentValues() 
</span><span style=color:#8f5902;font-style:italic>     *              -&gt; constructorArgumentValues 是否存在元素，即 bean 配置文件中
</span><span style=color:#8f5902;font-style:italic>     *                 是否配置了 &lt;construct-arg/&gt;
</span><span style=color:#8f5902;font-style:italic>     *    条件4：!ObjectUtils.isEmpty(args) 
</span><span style=color:#8f5902;font-style:italic>     *              -&gt; args 数组是否存在元素，args 是由用户调用 
</span><span style=color:#8f5902;font-style:italic>     *                 getBean(String name, Object... args) 传入的
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * 上面4个条件，只要有一个为 true，就会通过构造方法自动注入的方式构造 bean 实例
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 通过“构造方法自动注入”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 通过“默认构造方法”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>流程如下：</p>
<ol>
<li>检测类的访问权限，若禁止访问，则抛出异常</li>
<li>若工厂方法不为空，则通过工厂方法构建 bean 对象，并返回结果</li>
<li>若构造方式已解析过，则走快捷路径构建 bean 对象，并返回结果</li>
<li>如第三步不满足，则通过组合条件决定使用哪种方式构建 bean 对象</li>
</ol>
<p>这里有三种构造 bean 对象的方式，如下：</p>
<ol>
<li>通过“工厂方法”的方式构造 bean 对象</li>
<li>通过“构造方法自动注入”的方式构造 bean 对象</li>
<li>通过“默认构造方法”的方式构造 bean 对象</li>
</ol>
<h2 id=创建构造方法自动注入>创建：构造方法自动注入</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 创建 ConstructorResolver 对象，并调用其 autowireConstructor 方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConstructorResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>chosenCtors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 创建 BeanWrapperImpl 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>BeanWrapperImpl</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ArgumentsHolder</span> <span style=color:#000>argsHolderToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 确定参数值列表（argsToUse）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>argsToResolve</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取已解析的构造方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获取已解析的构造方法参数列表
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorArguments</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 若 argsToUse 为空，则获取未解析的构造方法参数列表
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>argsToResolve</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preparedConstructorArguments</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argsToResolve</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 解析参数列表
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvePreparedArguments</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argsToResolve</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowiring</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chosenCtors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>resolvedValues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minNrOfArgs</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>minNrOfArgs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>cargs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>resolvedValues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 确定构造方法参数数量，比如下面的配置：
</span><span style=color:#8f5902;font-style:italic>             *     &lt;bean id=&#34;persion&#34; class=&#34;xyz.coolblog.autowire.Person&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *         &lt;constructor-arg index=&#34;0&#34; value=&#34;xiaoming&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *         &lt;constructor-arg index=&#34;1&#34; value=&#34;1&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *         &lt;constructor-arg index=&#34;2&#34; value=&#34;man&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *     &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 此时 minNrOfArgs = maxIndex + 1 = 2 + 1 = 3，除了计算 minNrOfArgs，
</span><span style=color:#8f5902;font-style:italic>             * 下面的方法还会将 cargs 中的参数数据转存到 resolvedValues 中
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>minNrOfArgs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveConstructorArguments</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cargs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resolvedValues</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 获取构造方法列表
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>chosenCtors</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span>
                        <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructors</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#4e9a06>&#34;Resolution of declared constructors on bean Class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;] from ClassLoader [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 按照构造方法的访问权限级别和参数数量进行排序
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>AutowireUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sortConstructors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minTypeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>paramTypes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 下面的 if 分支的用途是：若匹配到到合适的构造方法了，提前结束 for 循环
</span><span style=color:#8f5902;font-style:italic>             * constructorToUse != null 这个条件比较好理解，下面分析一下条件 argsToUse.length &gt; paramTypes.length：
</span><span style=color:#8f5902;font-style:italic>             * 前面说到 AutowireUtils.sortConstructors(candidates) 用于对构造方法进行
</span><span style=color:#8f5902;font-style:italic>             * 排序，排序规则如下：
</span><span style=color:#8f5902;font-style:italic>             *   1. 具有 public 访问权限的构造方法排在非 public 构造方法前
</span><span style=color:#8f5902;font-style:italic>             *   2. 参数数量多的构造方法排在前面
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 假设现在有一组构造方法按照上面的排序规则进行排序，排序结果如下（省略参数名称）：
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             *   1. public Hello(Object, Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   2. public Hello(Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   3. public Hello(Object)
</span><span style=color:#8f5902;font-style:italic>             *   4. protected Hello(Integer, Object, Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   5. protected Hello(Integer, Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   6. protected Hello(Integer, Object)
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * argsToUse = [num1, obj2]，可以匹配上的构造方法2和构造方法6。由于构造方法2有
</span><span style=color:#8f5902;font-style:italic>             * 更高的访问权限，所以没理由不选他（尽管后者在参数类型上更加匹配）。由于构造方法3
</span><span style=color:#8f5902;font-style:italic>             * 参数数量 &lt; argsToUse.length，参数数量上不匹配，也不应该选。所以 
</span><span style=color:#8f5902;font-style:italic>             * argsToUse.length &gt; paramTypes.length 这个条件用途是：在条件 
</span><span style=color:#8f5902;font-style:italic>             * constructorToUse != null 成立的情况下，通过判断参数数量与参数值数量
</span><span style=color:#8f5902;font-style:italic>             * （argsToUse.length）是否一致，来决定是否提前终止构造方法匹配逻辑。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>argsToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 构造方法参数数量低于配置的参数数量，则忽略当前构造方法，并重试。比如 
</span><span style=color:#8f5902;font-style:italic>             * argsToUse = [obj1, obj2, obj3, obj4]，上面的构造方法列表中，
</span><span style=color:#8f5902;font-style:italic>             * 构造方法1、2和3显然不是合适选择，忽略之。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>minNrOfArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>ArgumentsHolder</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedValues</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 判断否则方法是否有 ConstructorProperties 注解，若有，则取注解中的
</span><span style=color:#8f5902;font-style:italic>                     * 值。比如下面的代码：
</span><span style=color:#8f5902;font-style:italic>                     * 
</span><span style=color:#8f5902;font-style:italic>                     *  public class Persion {
</span><span style=color:#8f5902;font-style:italic>                     *      private String name;
</span><span style=color:#8f5902;font-style:italic>                     *      private Integer age;
</span><span style=color:#8f5902;font-style:italic>                     *
</span><span style=color:#8f5902;font-style:italic>                     *      @ConstructorProperties(value = {&#34;coolblog&#34;, &#34;20&#34;})
</span><span style=color:#8f5902;font-style:italic>                     *      public Persion(String name, Integer age) {
</span><span style=color:#8f5902;font-style:italic>                     *          this.name = name;
</span><span style=color:#8f5902;font-style:italic>                     *          this.age = age;
</span><span style=color:#8f5902;font-style:italic>                     *      }
</span><span style=color:#8f5902;font-style:italic>                     * }
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>paramNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConstructorPropertiesChecker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramNames</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>ParameterNameDiscoverer</span> <span style=color:#000>pnd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pnd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                             * 获取构造方法参数名称列表，比如有这样一个构造方法:
</span><span style=color:#8f5902;font-style:italic>                             *   public Person(String name, int age, String sex)
</span><span style=color:#8f5902;font-style:italic>                             *   
</span><span style=color:#8f5902;font-style:italic>                             * 调用 getParameterNames 方法返回 paramNames = [name, age, sex]
</span><span style=color:#8f5902;font-style:italic>                             */</span>
                            <span style=color:#000>paramNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pnd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterNames</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>                     * 创建参数值列表，返回 argsHolder 会包含进行类型转换后的参数值，比如下
</span><span style=color:#8f5902;font-style:italic>                     * 面的配置:
</span><span style=color:#8f5902;font-style:italic>                     *
</span><span style=color:#8f5902;font-style:italic>                     *     &lt;bean id=&#34;persion&#34; class=&#34;xyz.coolblog.autowire.Person&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *         &lt;constructor-arg name=&#34;name&#34; value=&#34;xiaoming&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>                     *         &lt;constructor-arg name=&#34;age&#34; value=&#34;1&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>                     *         &lt;constructor-arg name=&#34;sex&#34; value=&#34;man&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>                     *     &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>                     *
</span><span style=color:#8f5902;font-style:italic>                     * Person 的成员变量 age 是 Integer 类型的，但由于在 Spring 配置中
</span><span style=color:#8f5902;font-style:italic>                     * 只能配成 String 类型，所以这里要进行类型转换。
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#000>argsHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createArgumentArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resolvedValues</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramNames</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>getUserDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>autowiring</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UnsatisfiedDependencyException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span>
                                <span style=color:#4e9a06>&#34;Ignoring constructor [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#000>causes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>argsHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArgumentsHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 计算参数值（argsHolder.arguments）每个参数类型与构造方法参数列表
</span><span style=color:#8f5902;font-style:italic>             * （paramTypes）中参数的类型差异量，差异量越大表明参数类型差异越大。参数类型差异
</span><span style=color:#8f5902;font-style:italic>             * 越大，表明当前构造方法并不是一个最合适的候选项。引入差异量（typeDiffWeight）
</span><span style=color:#8f5902;font-style:italic>             * 变量目的：是将候选构造方法的参数列表类型与参数值列表类型的差异进行量化，通过量化
</span><span style=color:#8f5902;font-style:italic>             * 后的数值筛选出最合适的构造方法。
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             * 讲完差异量，再来说说 mbd.isLenientConstructorResolution() 条件。
</span><span style=color:#8f5902;font-style:italic>             * 官方的解释是：返回构造方法的解析模式，有宽松模式（lenient mode）和严格模式
</span><span style=color:#8f5902;font-style:italic>             * （strict mode）两种类型可选。具体的细节没去研究，就不多说了。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>typeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLenientConstructorResolution</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span>
                    <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeDifferenceWeight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAssignabilityWeight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>minTypeDiffWeight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>argsHolderToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arguments</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>minTypeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeDiffWeight</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>             * 如果两个构造方法与参数值类型列表之间的差异量一致，那么这两个方法都可以作为
</span><span style=color:#8f5902;font-style:italic>             * 候选项，这个时候就出现歧义了，这里先把有歧义的构造方法放入 
</span><span style=color:#8f5902;font-style:italic>             * ambiguousConstructors 集合中
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>typeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>minTypeDiffWeight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;();</span>
                    <span style=color:#000>ambiguousConstructors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>ambiguousConstructors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 若上面未能筛选出合适的构造方法，这里将抛出 BeanCreationException 异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>UnsatisfiedDependencyException</span> <span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>causes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeLast</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>cause</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>causes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onSuppressedException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#4e9a06>&#34;Could not resolve matching constructor &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#4e9a06>&#34;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 constructorToUse != null，且 ambiguousConstructors 也不为空，表明解析
</span><span style=color:#8f5902;font-style:italic>         * 出了多个的合适的构造方法，此时就出现歧义了。Spring 不会擅自决定使用哪个构造方法，
</span><span style=color:#8f5902;font-style:italic>         * 所以抛出异常。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLenientConstructorResolution</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#4e9a06>&#34;Ambiguous constructor matches found in bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#4e9a06>&#34;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#000>ambiguousConstructors</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 缓存相关信息，比如：
</span><span style=color:#8f5902;font-style:italic>             *   1. 已解析出的构造方法对象 resolvedConstructorOrFactoryMethod
</span><span style=color:#8f5902;font-style:italic>             *   2. 构造方法参数列表是否已解析标志 constructorArgumentsResolved
</span><span style=color:#8f5902;font-style:italic>             *   3. 参数值列表 resolvedConstructorArguments 或 preparedConstructorArguments
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 这些信息可用在其他地方，用于进行快捷判断
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>argsHolderToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ctorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>argumentsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>argsToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span>
                            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctorToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argumentsToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 调用实例化策略创建实例，默认情况下使用反射创建实例。如果 bean 的配置信息中
</span><span style=color:#8f5902;font-style:italic>             * 包含 lookup-method 和 replace-method，则通过 CGLIB 增强 bean 实例
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argsToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 设置 beanInstance 到 BeanWrapperImpl 对象中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;Bean instantiation via constructor failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法的核心逻辑是根据参数值类型筛选合适的构造方法。解析出合适的构造方法后，剩下的工作就是构建 bean 对象了，这个工作交给了实例化策略去做。下面罗列一下这个方法的工作流程吧：</p>
<ol>
<li>创建 BeanWrapperImpl 对象</li>
<li>解析构造方法参数，并算出 minNrOfArgs</li>
<li>获取构造方法列表，并排序</li>
<li>遍历排序好的构造方法列表，筛选合适的构造方法
<ol>
<li>获取构造方法参数列表中每个参数的名称</li>
<li>再次解析参数，此次解析会将 <code>&lt;constructor-arg/> value</code> 属性值进行类型转换，由 String 转为合适的类型。</li>
<li>计算构造方法参数列表与参数值列表之间的类型差异量，以筛选出更为合适的构造方法</li>
</ol>
</li>
<li>缓存已筛选出的构造方法以及参数值列表，若再次创建 bean 实例时，可直接使用，无需再次进行筛选</li>
<li>使用初始化策略创建 bean 对象</li>
<li>将 bean 对象放入 BeanWrapperImpl 对象中，并返回该对象</li>
</ol>
<h2 id=创建默认构造方法>创建：默认构造方法</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// if 条件分支里的一大坨是 Java 安全相关的代码，可以忽略，直接看 else 分支
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 调用实例化策略创建实例，默认情况下使用反射创建对象。如果 bean 的配置信息中
</span><span style=color:#8f5902;font-style:italic>             * 包含 lookup-method 和 replace-method，则通过 CGLIB 创建 bean 对象
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 创建 BeanWrapperImpl 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 检测 bean 配置中是否配置了 lookup-method 或 replace-method，若配置了，则需使用 CGLIB 构建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Specified class is an interface&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#5c35cc;font-weight:700>@Override</span>
                            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 获取默认构造方法
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 设置 resolvedConstructorOrFactoryMethod
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No default constructor found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 通过无参构造方法创建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用 GCLIG 创建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateWithMethodInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面就是通过默认构造方法创建 bean 对象的过程，比较简单，就不多说了。最后我们再来看看简单看看通过无参构造方法刚创建 bean 对象的代码（通过 CGLIB 创建 bean 对象的方式就不看了）是怎样的，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanInstantiationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Constructor must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置构造方法为可访问
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 通过反射创建 bean 实例，这里的 args 是一个没有元素的空数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Is it an abstract class?&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalAccessException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Is the constructor accessible?&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal arguments for constructor&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationTargetException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Constructor threw exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetException</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f226756c00275a43d5e85dc95b38990e>2.4 - CH04-解决循环依赖</h1>
<h2 id=循环依赖>循环依赖</h2>
<p>所谓的循环依赖是指，A 依赖 B，B 又依赖 A，它们之间形成了循环依赖。或者是 A 依赖 B，B 依赖 C，C 又依赖 A。它们之间的依赖关系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230312.png style=display:block;width:60% alt=NAME align=center> </div>
<p>这里以两个类直接相互依赖为例，他们的实现代码可能如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanB</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 省略 getter/setter
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanA</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.BeanA&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.BeanB&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>IOC 容器在读到上面的配置时，会按照顺序，先去实例化 beanA。然后发现 beanA 依赖于 beanB，接在又去实例化 beanB。实例化 beanB 时，发现 beanB 又依赖于 beanA。</p>
<p>如果容器不处理循环依赖的话，容器会无限执行上面的流程，直到内存溢出，程序崩溃。当然，Spring 是不会让这种情况发生的。在容器再次发现 beanB 依赖于 beanA 时，容器会获取 beanA 对象的一个早期的引用（early reference），并把这个早期引用注入到 beanB 中，让 beanB 先完成实例化。beanB 完成实例化，beanA 就可以获取到 beanB 的引用，beanA 随之完成实例化。这里大家可能不知道“早期引用”是什么意思，这里先别着急，我会在下一章进行说明。</p>
<h2 id=缓存介绍>缓存介绍</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** Cache of singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>singletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>256</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>singletonFactories</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of early singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>earlySingletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>根据缓存变量上面的注释，大家应该能大致了解他们的用途。我这里简单说明一下吧：</p>
<table>
<thead>
<tr>
<th style=text-align:left>缓存</th>
<th style=text-align:left>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>singletonObjects</td>
<td style=text-align:left>用于存放完全初始化好的 bean，从该缓存中取出的 bean 可以直接使用</td>
</tr>
<tr>
<td style=text-align:left>earlySingletonObjects</td>
<td style=text-align:left>存放原始的 bean 对象（尚未填充属性），用于解决循环依赖</td>
</tr>
<tr>
<td style=text-align:left>singletonFactories</td>
<td style=text-align:left>存放 bean 工厂对象，用于解决循环依赖</td>
</tr>
</tbody>
</table>
<p>上一章提到了”早期引用“，所谓的”早期引用“是指向原始对象的引用。所谓的原始对象是指刚创建好的对象，但还未填充属性。这样讲大家不知道大家听明白了没，不过没听明白也不要紧。简单做个实验就知道了，这里我们先定义一个对象 Room：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** Room 包含了一些电器 */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Room</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>television</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>airConditioner</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>refrigerator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>washer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 省略 getter/setter
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;room&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.demo.Room&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;television&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Xiaomi&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;airConditioner&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Gree&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;refrigerator&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Haier&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;washer&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Siemens&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>下图依次是原始 bean 和完全初始化后的 bean：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230533.png style=display:block;width:60% alt=NAME align=center> </div>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230608.png style=display:block;width:60% alt=NAME align=center> </div>
<p>这里的 bean 和上面的 bean 指向的是同一个对象<code>Room@1567</code>，但现在这个对象所有字段都是 null，我们把这种对象成为原始的对象。形象点说，上面的 bean 对象是一个装修好的房子，可以拎包入住了。而这里的 bean 对象还是个毛坯房，还要装修一下（填充属性）才行。</p>
<h2 id=bean-获取过程回顾>Bean 获取过程回顾</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230652.png style=display:block;width:80% alt=NAME align=center> </div>
<p>开始流程图中只有一条执行路径，在条件 sharedInstance != null 这里出现了岔路，形成了绿色和红色两条路径。在上图中，读取/添加缓存的方法我用蓝色的框和☆标注了出来。至于虚线的箭头，和虚线框里的路径，这个下面会说到。</p>
<p>我来按照上面的图，分析一下整个流程的执行顺序。这个流程从 getBean 方法开始，getBean 是个空壳方法，所有逻辑都在 doGetBean 方法中。doGetBean 首先会调用 getSingleton(beanName) 方法获取 sharedInstance，sharedInstance 可能是完全实例化好的 bean，也可能是一个原始的 bean，当然也有可能是 null。如果不为 null，则走绿色的那条路径。再经 getObjectForBeanInstance 这一步处理后，绿色的这条执行路径就结束了。</p>
<p>我们再来看一下红色的那条执行路径，也就是 sharedInstance = null 的情况。在第一次获取某个 bean 的时候，缓存中是没有记录的，所以这个时候要走创建逻辑。上图中的 getSingleton(beanName,</p>
<p><code>new ObjectFactory&lt;Object>() {...}) </code>方法会创建一个 bean 实例，上图虚线路径指的是 getSingleton 方法内部调用的两个方法，其逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上所示，getSingleton 会在内部先调用 getObject 方法创建 singletonObject，然后再调用 addSingleton 将 singletonObject 放入缓存中。getObject 在内部代用了 createBean 方法，createBean 方法基本上也属于空壳方法，更多的逻辑是写在 doCreateBean 方法中的。doCreateBean 方法中的逻辑很多，其首先调用了 createBeanInstance 方法创建了一个原始的 bean 对象，随后调用 addSingletonFactory 方法向缓存中添加单例 bean 工厂，从该工厂可以获取原始对象的引用，也就是所谓的“早期引用”。再之后，继续调用 populateBean 方法向原始 bean 对象中填充属性，并解析依赖。getObject 执行完成后，会返回完全实例化好的 bean。紧接着再调用 addSingleton 把完全实例化好的 bean 对象放入缓存中。到这里，红色执行路径差不多也就要结束的。</p>
<p>我这里没有把 getObject、addSingleton 方法和 getSingleton(String, ObjectFactory) 并列画在红色的路径里，目的是想简化一下方法的调用栈（都画进来有点复杂）。我们可以进一步简化上面的调用流程，比如下面：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230747.png style=display:block;width:80% alt=NAME align=center> </div>
<p>这个流程看起来是不是简单多了，命中缓存走绿色路径，未命中走红色的创建路径。</p>
<h2 id=源码分析>源码分析</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// ...... 
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 从缓存中获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从 singletonObjects 获取实例，singletonObjects 中的实例都是准备好的 bean 实例，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 判断 beanName 对应的 bean 是否正在创建中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从 earlySingletonObjects 中获取提前曝光的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获取相应的 bean 工厂
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 提前曝光 bean 实例（raw bean），用于解决循环依赖
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                    
                    <span style=color:#8f5902;font-style:italic>// 将 singletonObject 放入缓存中，并将 singletonFactory 从缓存中移除
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的源码中，doGetBean 所调用的方法 getSingleton(String) 是一个空壳方法，其主要逻辑在 getSingleton(String, boolean) 中。该方法逻辑比较简单，首先从 singletonObjects 缓存中获取 bean 实例。若未命中，再去 earlySingletonObjects 缓存中获取原始 bean 实例。如果仍未命中，则从 singletonFactory 缓存中获取 ObjectFactory 对象，然后再调用 getObject 方法获取原始 bean 实例的应用，也就是早期引用。获取成功后，将该实例放入 earlySingletonObjects 缓存中，并将 ObjectFactory 对象从 singletonFactories 移除。看完这个方法，我们再来看看 getSingleton(String, ObjectFactory) 方法，这个方法也是在 doGetBean 中被调用的。这次我会把 doGetBean 的代码多贴一点出来，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// ...... 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 从缓存中获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 这里先忽略 args == null 这个条件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 进行后续的处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>// mbd.isSingleton() 用于判断 bean 是否是单例模式
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 再次获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 创建 bean 实例，createBean 返回的 bean 是完全实例化好的
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#8f5902;font-style:italic>// 进行后续的处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的代码逻辑和我在 <code>回顾获取 bean 的过程</code> 一节的最后贴的主流程图已经很接近了，对照那张图和代码中的注释，大家应该可以理解 doGetBean 方法了。继续往下看：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#8f5902;font-style:italic>// 调用 getObject 方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 添加 bean 到 singletonObjects 缓存中，并从其他集合中将 bean 相关记录移除
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#8f5902;font-style:italic>// 返回 singletonObject
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 将 &lt;beanName, singletonObject&gt; 映射存入 singletonObjects 中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NULL_OBJECT</span><span style=color:#ce5c00;font-weight:700>));</span>

        <span style=color:#8f5902;font-style:italic>// 从其他缓存中移除 beanName 相关映射
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registeredSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码中包含两步操作，第一步操作是调用 getObject 创建 bean 实例，第二步是调用 addSingleton 方法将创建好的 bean 放入缓存中。代码逻辑并不复杂，相信大家都能看懂。那么接下来我们继续往下看，这次分析的是 doCreateBean 中的一些逻辑。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// ☆ 创建 bean 对象，并将 bean 对象包裹在 BeanWrapper 对象中返回
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 从 BeanWrapper 对象中获取 bean 对象，这里的 bean 指向的是一个原始的对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * earlySingletonExposure 用于表示是否”提前暴露“原始对象的引用，用于解决循环依赖。
</span><span style=color:#8f5902;font-style:italic>     * 对于单例 bean，该变量一般为 true。更详细的解释可以参考我之前的文章
</span><span style=color:#8f5902;font-style:italic>     */</span> 
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ☆ 添加 bean 工厂对象到 singletonFactories 缓存中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>                 * 获取原始对象的早期引用，在 getEarlyBeanReference 方法中，会执行 AOP 
</span><span style=color:#8f5902;font-style:italic>                 * 相关逻辑。若 bean 未被 AOP 拦截，getEarlyBeanReference 原样返回 
</span><span style=color:#8f5902;font-style:italic>                 * bean，所以大家可以把 
</span><span style=color:#8f5902;font-style:italic>                 *      return getEarlyBeanReference(beanName, mbd, bean) 
</span><span style=color:#8f5902;font-style:italic>                 * 等价于：
</span><span style=color:#8f5902;font-style:italic>                 *      return bean;
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// ☆ 填充属性，解析依赖
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 将 singletonFactory 添加到 singletonFactories 缓存中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 从其他缓存中移除相关记录，即使没有
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registeredSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码简化了不少，不过看起来仍有点复杂。好在，上面代码的主线逻辑比较简单，由三个方法组成。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#0000cf;font-weight:700>1.</span> <span style=color:#000>创建原始</span> <span style=color:#000>bean</span> <span style=color:#000>实例</span> <span style=color:#a40000>→</span> <span style=color:#000>createBeanInstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#0000cf;font-weight:700>2.</span> <span style=color:#000>添加原始对象工厂对象到</span> <span style=color:#000>singletonFactories</span> <span style=color:#000>缓存中</span> 
        <span style=color:#a40000>→</span> <span style=color:#000>addSingletonFactory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>{...})</span>
<span style=color:#0000cf;font-weight:700>3.</span> <span style=color:#000>填充属性</span><span style=color:#a40000>，</span><span style=color:#000>解析依赖</span> <span style=color:#a40000>→</span> <span style=color:#000>populateBean</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><h2 id=关键步骤>关键步骤</h2>
<p>在上面的方法调用中，有几个关键的地方，下面一一列举出来：</p>
<h3 id=1-创建原始-bean-对象><strong>1. 创建原始 bean 对象</strong></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getWrappedInstance</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>假设 beanA 先被创建，创建后的原始对象为 <code>BeanA@1234</code>，上面代码中的 bean 变量指向就是这个对象。</p>
<p><strong>2. 暴露早期引用</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000>addSingletonFactory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#a40000>@</span><span style=color:#000>Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87>Object</span> <span style=color:#000>getObject</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>});</span>
</code></pre></div><p>beanA 指向的原始对象创建好后，就开始把指向原始对象的引用通过 ObjectFactory 暴露出去。getEarlyBeanReference 方法的第三个参数 bean 指向的正是 createBeanInstance 方法创建出原始 bean 对象 BeanA@1234。</p>
<h3 id=3-解析依赖><strong>3. 解析依赖</strong></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000>populateBean</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>populateBean 用于向 beanA 这个原始对象中填充属性，当它检测到 beanA 依赖于 beanB 时，会首先去实例化 beanB。beanB 在此方法处也会解析自己的依赖，当它检测到 beanA 这个依赖，于是调用 BeanFactry.getBean(&ldquo;beanA&rdquo;) 这个方法，从容器中获取 beanA。</p>
<h3 id=4-获取早期引用><strong>4. 获取早期引用</strong></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87>Object</span> <span style=color:#000>getSingleton</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span> <span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonObjects</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonObjects</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// ☆ 从缓存中获取早期引用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>earlySingletonObjects</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonFactories</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// ☆ 从 SingletonFactory 中获取早期引用
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getObject</span><span style=color:#000;font-weight:700>();</span>
                    
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>earlySingletonObjects</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#000;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonFactories</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>接着上面的步骤讲，populateBean 调用 BeanFactry.getBean(&ldquo;beanA&rdquo;) 以获取 beanB 的依赖。getBean(&ldquo;beanA&rdquo;) 会先调用 getSingleton(&ldquo;beanA&rdquo;)，尝试从缓存中获取 beanA。此时由于 beanA 还没完全实例化好，于是 this.singletonObjects.get(&ldquo;beanA&rdquo;) 返回 null。接着 this.earlySingletonObjects.get(&ldquo;beanA&rdquo;) 也返回空，因为 beanA 早期引用还没放入到这个缓存中。最后调用 singletonFactory.getObject() 返回 singletonObject，此时 singletonObject != null。singletonObject 指向 BeanA@1234，也就是 createBeanInstance 创建的原始对象。此时 beanB 获取到了这个原始对象的引用，beanB 就能顺利完成实例化。beanB 完成实例化后，beanA 就能获取到 beanB 所指向的实例，beanA 随之也完成了实例化工作。由于 beanB.beanA 和 beanA 指向的是同一个对象 BeanA@1234，所以 beanB 中的 beanA 此时也处于可用状态了。</p>
<p>以上的过程对应下面的流程图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011231159.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d9a521069fb4cad9079c5b918a21c5a1>2.5 - CH05-原始 Bean 属性填充</h1>
<h2 id=populatebean-源码>populateBean 源码</h2>
<p>本节，我们先来看一下填充属性的方法，即 populateBean。该方法并不复杂，但它所调用的一些方法比较复杂。不过好在我们这里只需要知道这些方法都有什么用就行了，暂时不用纠结细节。好了，下面看源码吧。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取属性列表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Cannot apply property values to null instance&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 在属性被填充前，给 InstantiationAwareBeanPostProcessor 类型的后置处理器一个修改 
</span><span style=color:#8f5902;font-style:italic>     * bean 状态的机会。关于这段后置引用，官方的解释是：让用户可以自定义属性注入。比如用户实现一
</span><span style=color:#8f5902;font-style:italic>     * 个 InstantiationAwareBeanPostProcessor 类型的后置处理器，并通过 
</span><span style=color:#8f5902;font-style:italic>     * postProcessAfterInstantiation 方法向 bean 的成员变量注入自定义的信息。当然，如果无
</span><span style=color:#8f5902;font-style:italic>     * 特殊需求，直接使用配置中的信息注入即可。另外，Spring 并不建议大家直接实现 
</span><span style=color:#8f5902;font-style:italic>     * InstantiationAwareBeanPostProcessor 接口，如果想实现这种类型的后置处理器，更建议
</span><span style=color:#8f5902;font-style:italic>     * 通过继承 InstantiationAwareBeanPostProcessorAdapter 抽象类实现自定义后置处理器。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>     * 如果上面设置 continueWithPropertyPopulation = false，表明用户可能已经自己填充了
</span><span style=color:#8f5902;font-style:italic>     * bean 的属性，不需要 Spring 帮忙填充了。此时直接返回即可
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>continueWithPropertyPopulation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 根据名称或类型注入依赖
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>newPvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// 通过属性名称注入依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 通过属性类型注入依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsDepCheck</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyCheck</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPENDENCY_CHECK_NONE</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 这里又是一种后置处理，用于在 Spring 填充属性到 bean 对象前，对属性的值进行相应的处理，
</span><span style=color:#8f5902;font-style:italic>     * 比如可以修改某些属性的值。这时注入到 bean 中的值就不是配置文件中的内容了，
</span><span style=color:#8f5902;font-style:italic>     * 而是经过后置处理器修改后的内容
</span><span style=color:#8f5902;font-style:italic>     */</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredPds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>filterPropertyDescriptorsForDependencyCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCaching</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 对属性进行后置处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>checkDependencies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 应用属性值到 bean 对象中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的源码注释的比较详细了，下面我们来总结一下这个方法的执行流程。如下：</p>
<ol>
<li>获取属性列表 pvs</li>
<li>在属性被填充到 bean 前，应用后置处理自定义属性填充</li>
<li>根据名称或类型解析相关依赖</li>
<li>再次应用后置处理，用于动态修改属性列表 pvs 的内容</li>
<li>将属性应用到 bean 对象中</li>
</ol>
<p>注意第 3 步，也就是根据名称或类型解析相关依赖（autowire）。该逻辑只会解析依赖，并不会将解析出的依赖立即注入到 bean 对象中。所有的属性值是在 applyPropertyValues 方法中统一被注入到 bean 对象中的。</p>
<p>在下面的章节中，我将会对 populateBean 方法中比较重要的几个方法调用进行分析，也就是第3步和第5步中的三个方法。好了，本节先到这里。</p>
<h2 id=autowirebyname>autowireByName</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 获取非简单类型属性的名称，且该属性未被配置在配置文件中。这里从反面解释一下什么是&#34;非简单类型&#34;
</span><span style=color:#8f5902;font-style:italic>     * 属性，我们先来看看 Spring 认为的&#34;简单类型&#34;属性有哪些，如下：
</span><span style=color:#8f5902;font-style:italic>     *   1. CharSequence 接口的实现类，比如 String
</span><span style=color:#8f5902;font-style:italic>     *   2. Enum
</span><span style=color:#8f5902;font-style:italic>     *   3. Date
</span><span style=color:#8f5902;font-style:italic>     *   4. URI/URL
</span><span style=color:#8f5902;font-style:italic>     *   5. Number 的继承类，比如 Integer/Long
</span><span style=color:#8f5902;font-style:italic>     *   6. byte/short/int... 等基本类型
</span><span style=color:#8f5902;font-style:italic>     *   7. Locale
</span><span style=color:#8f5902;font-style:italic>     *   8. 以上所有类型的数组形式，比如 String[]、Date[]、int[] 等等
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * 除了要求非简单类型的属性外，还要求属性未在配置文件中配置过，也就是 pvs.contains(pd.getName()) = false。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>propertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsatisfiedNonSimpleProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>propertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 检测是否存在与 propertyName 相关的 bean 或 BeanDefinition。若存在，则调用 BeanFactory.getBean 方法获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从容器中获取相应的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 将解析出的 bean 存入到属性值列表（pvs）中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Added autowiring by name from bean name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; via property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to bean named &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Not autowiring property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; by name: no matching bean found&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>autowireByName 方法的逻辑比较简单，该方法首先获取非简单类型属性的名称，然后再根据名称到容器中获取相应的 bean 实例，最后再将获取到的 bean 添加到属性列表中即可。既然这个方法比较简单，那我也就不多说了，继续下面的分析。</p>
<h2 id=autowirebytype>autowireByType</h2>
<p>本节我们来分析一下 autowireByName 的孪生兄弟 autowireByType，相较于 autowireByName，autowireByType 则要复杂一些，复杂之处在于解析依赖的过程。不过也没关系，如果我们不过于纠结细节，我们完全可以把一些复杂的地方当做一个黑盒，我们只需要要知道这个黑盒有什么用即可。这样可以在很大程度上降低源码分析的难度。好了，其他的就不多说了，咱们来分析源码吧。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>TypeConverter</span> <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCustomTypeConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取非简单类型的属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>propertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsatisfiedNonSimpleProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>propertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>PropertyDescriptor</span> <span style=color:#000>pd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 如果属性类型为 Object，则忽略，不做解析
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 获取 setter 方法（write method）的参数信息，比如参数在参数列表中的
</span><span style=color:#8f5902;font-style:italic>                 * 位置，参数类型，以及该参数所归属的方法等信息
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>MethodParameter</span> <span style=color:#000>methodParam</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWriteMethodParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// Do not allow eager init for type matching in case of a prioritized post-processor.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>eager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#8f5902;font-style:italic>// 创建依赖描述对象
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>DependencyDescriptor</span> <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AutowireByTypeDependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodParam</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eager</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 下面的方法用于解析依赖。过程比较复杂，先把这里看成一个黑盒，我们只要知道这
</span><span style=color:#8f5902;font-style:italic>                 * 个方法可以帮我们解析出合适的依赖即可。
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>Object</span> <span style=color:#000>autowiredArgument</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredArgument</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 将解析出的 bean 存入到属性值列表（pvs）中
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredArgument</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowiring by type from bean name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; via property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                                <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to bean named &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上所示，autowireByType 的代码本身并不复杂。和 autowireByName 一样，autowireByType 首先也是获取非简单类型属性的名称。然后再根据属性名获取属性描述符，并由属性描述符获取方法参数对象 MethodParameter，随后再根据 MethodParameter 对象获取依赖描述符对象，整个过程为 <code>beanName → PropertyDescriptor → MethodParameter → DependencyDescriptor</code>。在获取到依赖描述符对象后，再根据依赖描述符解析出合适的依赖。最后将解析出的结果存入属性列表 pvs 中即可。</p>
<p>关于 autowireByType 方法中出现的几种描述符对象，大家自己去看一下他们的实现吧，我就不分析了。接下来，我们来分析一下解析依赖的方法 resolveDependency。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DependencyDescriptor</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initParameterNameDiscovery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getParameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaUtilOptionalClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OptionalDependencyFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createOptionalDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>ObjectProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DependencyObjectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaxInjectProviderClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Jsr330ProviderFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createDependencyProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLazyResolutionProxyIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 解析依赖
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doResolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>doResolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DependencyDescriptor</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>InjectionPoint</span> <span style=color:#000>previousInjectionPoint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConstructorResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentInjectionPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 该方法最终调用了 beanFactory.getBean(String, Class)，从容器中获取依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>shortcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveShortcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 如果容器中存在所需依赖，这里进行断路操作，提前结束依赖解析逻辑
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortcut</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shortcut</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 处理 @value 注解
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSuggestedValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>strVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveEmbeddedValue</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>evaluateBeanDefinitionString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>TypeConverter</span> <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeConverter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>typeConverter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getField</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span>
                    <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getField</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodParameter</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 解析数组、list、map 等类型的依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>multipleBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveMultipleBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>multipleBeans</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>multipleBeans</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 按类型查找候选列表，如果某个类型已经被实例化，则返回相应的实例。
</span><span style=color:#8f5902;font-style:italic>         * 比如下面的配置：
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         *   &lt;bean name=&#34;mongoDao&#34; class=&#34;xyz.coolblog.autowire.MongoDao&#34; primary=&#34;true&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>         *   &lt;bean name=&#34;service&#34; class=&#34;xyz.coolblog.autowire.Service&#34; autowire=&#34;byType&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>         *   &lt;bean name=&#34;mysqlDao&#34; class=&#34;xyz.coolblog.autowire.MySqlDao&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         * MongoDao 和 MySqlDao 均实现自 Dao 接口，Service 对象（不是接口）中有一个 Dao 
</span><span style=color:#8f5902;font-style:italic>         * 类型的属性。现在根据类型自动注入 Dao 的实现类。这里有两个候选 bean，一个是 
</span><span style=color:#8f5902;font-style:italic>         * mongoDao，另一个是 mysqlDao，其中 mongoDao 在 service 之前实例化，
</span><span style=color:#8f5902;font-style:italic>         * mysqlDao 在 service 之后实例化。此时 findAutowireCandidates 方法会返回如下的结果：
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         *   matchingBeans = [ &lt;mongoDao, Object@MongoDao&gt;, &lt;mysqlDao, Class@MySqlDao&gt; ]
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         * 注意 mysqlDao 还未实例化，所以返回的是 MySqlDao.class。
</span><span style=color:#8f5902;font-style:italic>         * 
</span><span style=color:#8f5902;font-style:italic>         * findAutowireCandidates 这个方法逻辑比较复杂，我简单说一下它的工作流程吧，如下：
</span><span style=color:#8f5902;font-style:italic>         *   1. 从 BeanFactory 中获取某种类型 bean 的名称，比如上面的配置中 
</span><span style=color:#8f5902;font-style:italic>         *      mongoDao 和 mysqlDao 均实现了 Dao 接口，所以他们是同一种类型的 bean。
</span><span style=color:#8f5902;font-style:italic>         *   2. 遍历上一步得到的名称列表，并判断 bean 名称对应的 bean 是否是合适的候选项，
</span><span style=color:#8f5902;font-style:italic>         *      若合适则添加到候选列表中，并在最后返回候选列表
</span><span style=color:#8f5902;font-style:italic>         *      
</span><span style=color:#8f5902;font-style:italic>         * findAutowireCandidates 比较复杂，我并未完全搞懂，就不深入分析了。见谅
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>matchingBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowireCandidates</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 抛出 NoSuchBeanDefinitionException 异常
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>raiseNoMatchingBeanFound</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvableType</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>String</span> <span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Object</span> <span style=color:#000>instanceCandidate</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * matchingBeans.size() &gt; 1，则表明存在多个可注入的候选项，这里判断使用哪一个
</span><span style=color:#8f5902;font-style:italic>             * 候选项。比如下面的配置：
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean name=&#34;mongoDao&#34; class=&#34;xyz.coolblog.autowire.MongoDao&#34; primary=&#34;true&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean name=&#34;mysqlDao&#34; class=&#34;xyz.coolblog.autowire.MySqlDao&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * mongoDao 的配置中存在 primary 属性，所以 mongoDao 会被选为最终的候选项。如
</span><span style=color:#8f5902;font-style:italic>             * 果两个 bean 配置都没有 primary 属性，则需要根据优先级选择候选项。优先级这一块
</span><span style=color:#8f5902;font-style:italic>             * 的逻辑没细看，不多说了。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>indicatesMultipleBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 抛出 NoUniqueBeanDefinitionException 异常
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveNotUnique</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 根据解析出的 autowiredBeanName，获取相应的候选项
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>instanceCandidate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 只有一个候选项，直接取出来即可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>instanceCandidate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanNames</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 返回候选项实例，如果实例是 Class 类型，则调用 beanFactory.getBean(String, Class) 获取相应的 bean。否则直接返回即可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceCandidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Class</span> <span style=color:#ce5c00;font-weight:700>?</span>
                <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>instanceCandidate</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConstructorResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentInjectionPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>previousInjectionPoint</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由上面的代码可以看出，doResolveDependency 这个方法还是挺复杂的。这里我就不继续分析 doResolveDependency 所调用的方法了，对于这些方法，我也是似懂非懂。好了，本节的最后我们来总结一下 doResolveDependency 的执行流程吧，如下：</p>
<ol>
<li>首先将 beanName 和 requiredType 作为参数，并尝试从 BeanFactory 中获取与此对于的 bean。若获取成功，就可以提前结束 doResolveDependency 的逻辑。</li>
<li>处理 @value 注解</li>
<li>解析数组、List、Map 等类型的依赖，如果解析结果不为空，则返回结果</li>
<li>根据类型查找合适的候选项</li>
<li>如果候选项的数量为0，则抛出异常。为1，直接从候选列表中取出即可。若候选项数量 > 1，则在多个候选项中确定最优候选项，若无法确定则抛出异常</li>
<li>若候选项是 Class 类型，表明候选项还没实例化，此时通过 BeanFactory.getBean 方法对其进行实例化。若候选项是非 Class 类型，则表明已经完成了实例化，此时直接返回即可。</li>
</ol>
<h2 id=applypropertyvalues>applyPropertyValues</h2>
<p>经过了上面的流程，现在终于可以将属性值注入到 bean 对象中了。当然，这里还不能立即将属性值注入到对象中，因为在 Spring 配置文件中属性值都是以 String 类型进行配置的，所以 Spring 框架需要对 String 类型进行转换。除此之外，对于 ref 属性，这里还需要根据 ref 属性值解析依赖。还有一些其他操作，这里就不多说了，更多的信息我们一起在源码探寻。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bw</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setSecurityContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>mpvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mpvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果属性列表 pvs 被转换过，则直接返回即可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConverted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Error setting property values&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>original</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValueList</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>original</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>TypeConverter</span> <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCustomTypeConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>BeanDefinitionValueResolver</span> <span style=color:#000>valueResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>deepCopy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolveNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 遍历属性列表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValue</span> <span style=color:#000>pv</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果属性值被转换过，则就不需要再次转换
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConverted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Object</span> <span style=color:#000>originalValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 解析属性值。举例说明，先看下面的配置：
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean id=&#34;macbook&#34; class=&#34;MacBookPro&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;manufacturer&#34; value=&#34;Apple&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;width&#34; value=&#34;280&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;cpu&#34; ref=&#34;cpu&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;interface&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *           &lt;list&gt;
</span><span style=color:#8f5902;font-style:italic>             *               &lt;value&gt;USB&lt;/value&gt;
</span><span style=color:#8f5902;font-style:italic>             *               &lt;value&gt;HDMI&lt;/value&gt;
</span><span style=color:#8f5902;font-style:italic>             *               &lt;value&gt;Thunderbolt&lt;/value&gt;
</span><span style=color:#8f5902;font-style:italic>             *           &lt;/list&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;/property&gt;
</span><span style=color:#8f5902;font-style:italic>             *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 上面是一款电脑的配置信息，每个 property 配置经过下面的方法解析后，返回如下结果：
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;manufacturer&#34;, resolvedValue = &#34;Apple&#34;
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;width&#34;, resolvedValue = &#34;280&#34;
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;cpu&#34;, resolvedValue = &#34;CPU@1234&#34;  注：resolvedValue 是一个对象
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;interface&#34;, resolvedValue = [&#34;USB&#34;, &#34;HDMI&#34;, &#34;Thunderbolt&#34;]
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 如上所示，resolveValueIfNecessary 会将 ref 解析为具体的对象，将 &lt;list&gt; 
</span><span style=color:#8f5902;font-style:italic>             * 标签转换为 List 对象等。对于 int 类型的配置，这里并未做转换，所以 
</span><span style=color:#8f5902;font-style:italic>             * width = &#34;280&#34;，还是字符串。除了解析上面几种类型，该方法还会解析 &lt;set/&gt;、
</span><span style=color:#8f5902;font-style:italic>             * &lt;map/&gt;、&lt;array/&gt; 等集合配置
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>Object</span> <span style=color:#000>resolvedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>valueResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveValueIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>originalValue</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Object</span> <span style=color:#000>convertedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedValue</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * convertible 表示属性值是否可转换，由两个条件合成而来。第一个条件不难理解，解释
</span><span style=color:#8f5902;font-style:italic>             * 一下第二个条件。第二个条件用于检测 propertyName 是否是 nested 或者 indexed，
</span><span style=color:#8f5902;font-style:italic>             * 直接举例说明吧：
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             *   public class Room {
</span><span style=color:#8f5902;font-style:italic>             *       private Door door = new Door();
</span><span style=color:#8f5902;font-style:italic>             *   }
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * room 对象里面包含了 door 对象，如果我们想向 door 对象中注入属性值，则可以这样配置：
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean id=&#34;room&#34; class=&#34;xyz.coolblog.Room&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *      &lt;property name=&#34;door.width&#34; value=&#34;123&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             * isNestedOrIndexedProperty 会根据 propertyName 中是否包含 . 或 [  返回 
</span><span style=color:#8f5902;font-style:italic>             * true 和 false。包含则返回 true，否则返回 false。关于 nested 类型的属性，我
</span><span style=color:#8f5902;font-style:italic>             * 没在实践中用过，所以不知道上面举的例子是不是合理。若不合理，欢迎指正，也请多多指教。
</span><span style=color:#8f5902;font-style:italic>             * 关于 nested 类型的属性，大家还可以参考 Spring 的官方文档：
</span><span style=color:#8f5902;font-style:italic>             *     https://docs.spring.io/spring/docs/4.3.17.RELEASE/spring-framework-reference/htmlsingle/#beans-beans-conventions
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>convertible</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWritableProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>PropertyAccessorUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNestedOrIndexedProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 对于一般的属性，convertible 通常为 true
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertible</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 对属性值的类型进行转换，比如将 String 类型的属性值 &#34;123&#34; 转为 Integer 类型的 123
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>convertedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>convertForProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 如果 originalValue 是通过 autowireByType 或 autowireByName 解析而来，
</span><span style=color:#8f5902;font-style:italic>             * 那么此处条件成立，即 (resolvedValue == originalValue) = true
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedValue</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>originalValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertible</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 将 convertedValue 设置到 pv 中，后续再次创建同一个 bean 时，就无需再次进行转换了
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConvertedValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 如果原始值 originalValue 是 TypedStringValue，且转换后的值 
</span><span style=color:#8f5902;font-style:italic>             * convertedValue 不是 Collection 或数组类型，则将转换后的值存入到 pv 中。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertible</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>originalValue</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TypedStringValue</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#ce5c00;font-weight:700>!((</span><span style=color:#000>TypedStringValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>originalValue</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isDynamic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>convertedValue</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Collection</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConvertedValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>resolveNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpvs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>resolveNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConverted</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 将所有的属性值设置到 bean 实例中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Error setting property values&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上就是 applyPropertyValues 方法的源码，配合着我写的注释，应该可以理解这个方法的流程。这个方法也调用了很多其他的方法，如果大家跟下去的话，会发现这些方法的调用栈也是很深的，比较复杂。这里说一下 bw.setPropertyValues 这个方法，如果大家跟到这个方法的调用栈的最底部，会发现这个方法是通过调用对象的 setter 方法进行属性设置的。这里贴一下简化后的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanWrapperImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractNestablePropertyAccessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanWrapper</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanPropertyHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PropertyHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>valueToApply</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 writeMethod，也就是 setter 方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Method</span> <span style=color:#000>writeMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWriteMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAccessible</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>valueToApply</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 调用 setter 方法，getWrappedInstance() 返回的是 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>好了，本节的最后来总结一下 applyPropertyValues 方法的执行流程吧，如下：</p>
<ol>
<li>检测属性值列表是否已转换过的，若转换过，则直接填充属性，无需再次转换</li>
<li>遍历属性值列表 pvs，解析原始值 originalValue，得到解析值 resolvedValue</li>
<li>对解析后的属性值 resolvedValue 进行类型转换</li>
<li>将类型转换后的属性值设置到 PropertyValue 对象中，并将 PropertyValue 对象存入 deepCopy 集合中</li>
<li>将 deepCopy 中的属性信息注入到 bean 对象中</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-af78074eb9a0b37dec4c27ffbf65a82b>2.6 - CH06-后续初始化工作</h1>
<h2 id=initializebean>initializeBean</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 若 bean 实现了 BeanNameAware、BeanFactoryAware、BeanClassLoaderAware 等接口，则向 bean 中注入相关对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Object</span> <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 执行 bean 初始化前置操作
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 调用初始化方法：
</span><span style=color:#8f5902;font-style:italic>         * 1. 若 bean 实现了 InitializingBean 接口，则调用 afterPropertiesSet 方法
</span><span style=color:#8f5902;font-style:italic>         * 2. 若用户配置了 bean 的 init-method 属性，则调用用户在配置中指定的方法
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
                <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invocation of init method failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 执行 bean 初始化后置操作，AOP 会在此处向目标对象中织入切面逻辑
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上就是 initializeBean 方法的逻辑，很简单是不是。该方法做了如下几件事情：</p>
<ol>
<li>检测 bean 是否实现了 *Aware 类型接口，若实现，则向 bean 中注入相应的对象</li>
<li>执行 bean 初始化前置操作</li>
<li>执行初始化操作</li>
<li>执行 bean 初始化后置操作</li>
</ol>
<p>在上面的流程中，我们又发现了后置处理器的踪影。如果大家阅读过 Spring 的源码，会发现后置处理器在 Spring 源码中多次出现过。后置处理器是 Spring 拓展点之一，通过实现后置处理器 BeanPostProcessor 接口，我们就可以插手 bean 的初始化过程。比如大家所熟悉的 AOP 就是在后置处理 postProcessAfterInitialization 方法中向目标对象中织如切面逻辑的。关于“前置处理”和“后置处理”相关的源码，这里就不分析了，大家有兴趣自己去看一下。接下来分析一下 invokeAwareMethods 和 invokeInitMethods 方法，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Aware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanNameAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注入 beanName 字符串
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanNameAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注入 ClassLoader 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanFactoryAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注入 BeanFactory 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanFactoryAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractAutowireCapableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>invokeAwareMethods 方法的逻辑很简单，一句话总结：根据 bean 所实现的 Aware 的类型，向 bean 中注入不同类型的对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 检测 bean 是否是 InitializingBean 类型的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isInitializingBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isInitializingBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isExternallyManagedInitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;afterPropertiesSet&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Invoking afterPropertiesSet() on bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PrivilegedActionException</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 如果 bean 实现了 InitializingBean，则调用 afterPropertiesSet 方法执行初始化逻辑
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>initMethodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initMethodName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>isInitializingBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>&#34;afterPropertiesSet&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initMethodName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isExternallyManagedInitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initMethodName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 调用用户自定义的初始化方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>invokeCustomInitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-df482e7d67cbcb67a71beecf0e6e8c46>2.7 - CH07-生命周期扩展</h1>
<p>Spring的核心思想就是容器，当容器refresh的时候，外部看上去风平浪静，其实内部则是一片惊涛骇浪，汪洋一片。Springboot更是封装了Spring，遵循约定大于配置，加上自动装配的机制。很多时候我们只要引用了一个依赖，几乎是零配置就能完成一个功能的装配。</p>
<p>我非常喜欢这种自动装配的机制，所以在自己开发中间件和公共依赖工具的时候也会用到这个特性。让使用者以最小的代价接入。想要把自动装配玩的转，就必须要了解spring对于bean的构造生命周期以及各个扩展接口。当然了解了bean的各个生命周期也能促进我们加深对spring的理解。业务代码也能合理利用这些扩展点写出更加漂亮的代码。</p>
<h2 id=0-扩展点调用顺序图>0. 扩展点调用顺序图</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011232128.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=1-applicationcontextinitializer>1. ApplicationContextInitializer</h2>
<blockquote>
<p>org.springframework.context.ApplicationContextInitializer</p>
</blockquote>
<p>这是整个spring容器在刷新之前初始化<code>ConfigurableApplicationContext</code>的回调接口，简单来说，就是在容器刷新之前调用此类的<code>initialize</code>方法。这个点允许被用户自己扩展。用户可以在整个spring容器还没被初始化之前做一些事情。</p>
<p>可以想到的场景可能为，在最开始激活一些配置，或者利用这时候 class 还没被类加载器加载的时机，进行动态字节码注入等操作。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestApplicationContextInitializer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationContextInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[ApplicationContextInitializer]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为这时候spring容器还没被初始化，所以想要自己的扩展的生效，有以下三种方式：</p>
<ul>
<li>在启动类中用<code>springApplication.addInitializers(new TestApplicationContextInitializer())</code>语句加入</li>
<li>配置文件配置<code>context.initializer.classes=com.example.demo.TestApplicationContextInitializer</code></li>
<li>Spring SPI扩展，在spring.factories中加入<code>org.springframework.context.ApplicationContextInitializer=com.example.demo.TestApplicationContextInitializer</code></li>
</ul>
<h2 id=2-beandefinitionregistrypostprocessor>2. BeanDefinitionRegistryPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor</p>
</blockquote>
<p>这个接口在读取项目中的<code>beanDefinition</code>之后执行，提供一个补充的扩展点</p>
<p>使用场景：你可以在这里动态注册自己的<code>beanDefinition</code>，可以加载classpath之外的bean</p>
<p>扩展方式为:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestBeanDefinitionRegistryPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanDefinitionRegistryPostProcessor] postProcessBeanDefinitionRegistry&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanDefinitionRegistryPostProcessor] postProcessBeanFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=3-beanfactorypostprocessor>3. BeanFactoryPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.config.BeanFactoryPostProcessor</p>
</blockquote>
<p>这个接口是<code>beanFactory</code>的扩展接口，调用时机在spring在读取<code>beanDefinition</code>信息之后，实例化bean之前。</p>
<p>在这个时机，用户可以通过实现这个扩展接口来自行处理一些东西，比如修改已经注册的<code>beanDefinition</code>的元信息。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestBeanFactoryPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanFactoryPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanFactoryPostProcessor]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=4-instantiationawarebeanpostprocessor>4. InstantiationAwareBeanPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor</p>
</blockquote>
<p>该接口继承了<code>BeanPostProcess</code>接口，区别如下：</p>
<p><font color=red><strong><code>BeanPostProcess</code>接口只在bean的初始化阶段进行扩展（注入spring上下文前后），而<code>InstantiationAwareBeanPostProcessor</code>接口在此基础上增加了3个方法，把可扩展的范围增加了实例化阶段和属性注入阶段。</strong></font></p>
<p>该类主要的扩展点有以下5个方法，主要在bean生命周期的两大阶段：<font color=red><strong>实例化阶段</strong></font>和<font color=red><strong>初始化阶段</strong></font>，下面一起进行说明，按调用顺序为：</p>
<ul>
<li><code>postProcessBeforeInstantiation</code>：实例化bean之前，相当于new这个bean之前</li>
<li><code>postProcessAfterInstantiation</code>：实例化bean之后，相当于new这个bean之后</li>
<li><code>postProcessPropertyValues</code>：bean已经实例化完成，在属性注入时阶段触发，<code>@Autowired</code>,<code>@Resource</code>等注解原理基于此方法实现</li>
<li><code>postProcessBeforeInitialization</code>：初始化bean之前，相当于把bean注入spring上下文之前</li>
<li><code>postProcessAfterInitialization</code>：初始化bean之后，相当于把bean注入spring上下文之后</li>
</ul>
<p>使用场景：这个扩展点非常有用 ，无论是写中间件和业务中，都能利用这个特性。比如对实现了某一类接口的bean在各个生命期间进行收集，或者对某个类型的bean进行统一的设值等等。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestInstantiationAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] before initialization &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] after initialization &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] before instantiation &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] after instantiation &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>pds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] postProcessPropertyValues &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=5-smartinstantiationawarebeanpostprocessor>5. SmartInstantiationAwareBeanPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.config.SmartInstantiationAwareBeanPostProcessor</p>
</blockquote>
<p>该扩展接口有3个触发点方法：</p>
<ul>
<li><code>predictBeanType</code>：该触发点发生在<code>postProcessBeforeInstantiation</code>之前(在图上并没有标明，因为一般不太需要扩展这个点)，这个方法用于预测Bean的类型，返回第一个预测成功的Class类型，如果不能预测返回null；当你调用<code>BeanFactory.getType(name)</code>时当通过bean的名字无法得到bean类型信息时就调用该回调方法来决定类型信息。</li>
<li><code>determineCandidateConstructors</code>：该触发点发生在<code>postProcessBeforeInstantiation</code>之后，用于确定该bean的构造函数之用，返回的是该bean的所有构造函数列表。用户可以扩展这个点，来自定义选择相应的构造器来实例化这个bean。</li>
<li><code>getEarlyBeanReference</code>：该触发点发生在<code>postProcessAfterInstantiation</code>之后，当有循环依赖的场景，当bean实例化好之后，为了防止有循环依赖，会提前暴露回调方法，用于bean实例化的后置处理。这个方法就是在提前暴露的回调方法中触发。</li>
</ul>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestSmartInstantiationAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>predictBeanType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInstantiationAwareBeanPostProcessor] predictBeanType &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>determineCandidateConstructors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInstantiationAwareBeanPostProcessor] determineCandidateConstructors &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInstantiationAwareBeanPostProcessor] getEarlyBeanReference &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=6-beanfactoryaware>6. BeanFactoryAware</h2>
<blockquote>
<p>org.springframework.beans.factory.BeanFactoryAware</p>
</blockquote>
<p>这个类只有一个触发点，发生在bean的实例化之后，注入属性之前，也就是Setter之前。这个类的扩展点方法为<code>setBeanFactory</code>，可以拿到<code>BeanFactory</code>这个属性。</p>
<p>使用场景为，你可以在bean实例化之后，但还未初始化之前，拿到 <code>BeanFactory</code>，在这个时候，可以对每个bean作特殊化的定制。也或者可以把<code>BeanFactory</code>拿到进行缓存，日后使用。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestBeanFactoryAware</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestBeanFactoryAware] &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TestBeanFactoryAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=7-applicationcontextawareprocessor>7. ApplicationContextAwareProcessor</h2>
<blockquote>
<p>org.springframework.context.support.ApplicationContextAwareProcessor</p>
</blockquote>
<p>该类本身并没有扩展点，但是该类内部却有6个扩展点可供实现 ，这些类触发的时机在bean实例化之后，初始化之前：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011232824.png style=display:block;width:80% alt=NAME align=center> </div>
<p>可以看到，该类用于执行各种驱动接口，在bean实例化之后，属性填充之后，通过执行以上红框标出的扩展接口，来获取对应容器的变量。<strong>所以这里应该来说是有6个扩展点</strong>，这里就放一起来说了</p>
<ul>
<li><code>EnvironmentAware</code>：用于获取<code>EnviromentAware</code>的一个扩展类，这个变量非常有用， 可以获得系统内的所有参数。当然个人认为这个Aware没必要去扩展，因为spring内部都可以通过注入的方式来直接获得。</li>
<li><code>EmbeddedValueResolverAware</code>：用于获取<code>StringValueResolver</code>的一个扩展类， <code>StringValueResolver</code>用于获取基于<code>String</code>类型的properties的变量，一般我们都用<code>@Value</code>的方式去获取，如果实现了这个Aware接口，把<code>StringValueResolver</code>缓存起来，通过这个类去获取<code>String</code>类型的变量，效果是一样的。</li>
<li><code>ResourceLoaderAware</code>：用于获取<code>ResourceLoader</code>的一个扩展类，<code>ResourceLoader</code>可以用于获取classpath内所有的资源对象，可以扩展此类来拿到<code>ResourceLoader</code>对象。</li>
<li><code>ApplicationEventPublisherAware</code>：用于获取<code>ApplicationEventPublisher</code>的一个扩展类，<code>ApplicationEventPublisher</code>可以用来发布事件，结合<code>ApplicationListener</code>来共同使用，下文在介绍<code>ApplicationListener</code>时会详细提到。这个对象也可以通过spring注入的方式来获得。</li>
<li><code>MessageSourceAware</code>：用于获取<code>MessageSource</code>的一个扩展类，<code>MessageSource</code>主要用来做国际化。</li>
<li><code>ApplicationContextAware</code>：用来获取<code>ApplicationContext</code>的一个扩展类，<code>ApplicationContext</code>应该是很多人非常熟悉的一个类了，就是spring上下文管理器，可以手动的获取任何在spring上下文注册的bean，我们经常扩展这个接口来缓存spring上下文，包装成静态方法。同时<code>ApplicationContext</code>也实现了<code>BeanFactory</code>，<code>MessageSource</code>，<code>ApplicationEventPublisher</code>等接口，也可以用来做相关接口的事情。</li>
</ul>
<h2 id=8-beannameaware>8. BeanNameAware</h2>
<blockquote>
<p>org.springframework.beans.factory.BeanNameAware</p>
</blockquote>
<p>可以看到，这个类也是Aware扩展的一种，触发点在bean的初始化之前，也就是<code>postProcessBeforeInitialization</code>之前，这个类的触发点方法只有一个：<code>setBeanName</code></p>
<p>使用场景为：用户可以扩展这个点，在初始化bean之前拿到spring容器中注册的的beanName，来自行修改这个beanName的值。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanNameAware</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>NormalBeanA</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;NormalBean constructor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanNameAware] &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=9-postconstruct>9. @PostConstruct</h2>
<blockquote>
<p>javax.annotation.PostConstruct</p>
</blockquote>
<p>这个并不算一个扩展点，其实就是一个标注。其作用是在bean的初始化阶段，如果对一个方法标注了<code>@PostConstruct</code>，会先调用这个方法。这里重点是要关注下这个标准的触发点，这个触发点是在<code>postProcessBeforeInitialization</code>之后，<code>InitializingBean.afterPropertiesSet</code>之前。</p>
<p>使用场景：用户可以对某一方法进行标注，来进行初始化某一个属性</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>NormalBeanA</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;NormalBean constructor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@PostConstruct</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[PostConstruct] NormalBeanA&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=10-initializingbean>10. InitializingBean</h2>
<blockquote>
<p>org.springframework.beans.factory.InitializingBean</p>
</blockquote>
<p>这个类，顾名思义，也是用来初始化bean的。<code>InitializingBean</code>接口为bean提供了初始化方法的方式，它只包括<code>afterPropertiesSet</code>方法，凡是继承该接口的类，在初始化bean的时候都会执行该方法。这个扩展点的触发时机在<code>postProcessAfterInitialization</code>之前。</p>
<p>使用场景：用户实现此接口，来进行系统启动的时候一些业务指标的初始化工作。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[InitializingBean] NormalBeanA&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=11-factorybean>11. FactoryBean</h2>
<blockquote>
<p>org.springframework.beans.factory.FactoryBean</p>
</blockquote>
<p>一般情况下，Spring通过反射机制利用bean的class属性指定支线类去实例化bean，在某些情况下，实例化Bean过程比较复杂，如果按照传统的方式，则需要在bean中提供大量的配置信息。配置方式的灵活性是受限的，这时采用编码的方式可能会得到一个简单的方案。Spring为此提供了一个<code>org.springframework.bean.factory.FactoryBean</code>的工厂类接口，用户可以通过实现该接口定制实例化Bean的逻辑。<code>FactoryBean</code>接口对于Spring框架来说占用重要的地位，Spring自身就提供了70多个<code>FactoryBean</code>的实现。它们隐藏了实例化一些复杂bean的细节，给上层应用带来了便利。从Spring3.0开始，<code>FactoryBean</code>开始支持泛型，即接口声明改为<code>FactoryBean&lt;T></code>的形式</p>
<p>使用场景：用户可以扩展这个类，来为要实例化的bean作一个代理，比如为该对象的所有的方法作一个拦截，在调用前后输出一行log，模仿<code>ProxyFactoryBean</code>的功能。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestFactoryBean</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[FactoryBean] getObject&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getObjectType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=12-smartinitializingsingleton>12. SmartInitializingSingleton</h2>
<blockquote>
<p>org.springframework.beans.factory.SmartInitializingSingleton</p>
</blockquote>
<p>这个接口中只有一个方法<code>afterSingletonsInstantiated</code>，其作用是是 在spring容器管理的所有单例对象（非懒加载对象）初始化完成之后调用的回调接口。其触发时机为<code>postProcessAfterInitialization</code>之后。</p>
<p>使用场景：用户可以扩展此接口在对所有单例对象初始化完毕后，做一些后置的业务处理。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestSmartInitializingSingleton</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SmartInitializingSingleton</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInitializingSingleton]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=13-commandlinerunner>13. CommandLineRunner</h2>
<blockquote>
<p>org.springframework.boot.CommandLineRunner</p>
</blockquote>
<p>这个接口也只有一个方法：<code>run(String... args)</code>，触发时机为整个项目启动完毕后，自动执行。如果有多个<code>CommandLineRunner</code>，可以利用<code>@Order</code>来进行排序。</p>
<p>使用场景：用户扩展此接口，进行启动项目之后一些业务的预处理。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestCommandLineRunner</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>CommandLineRunner</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestCommandLineRunner]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=14-disposablebean>14. DisposableBean</h2>
<blockquote>
<p>org.springframework.beans.factory.DisposableBean</p>
</blockquote>
<p>这个扩展点也只有一个方法：<code>destroy()</code>，其触发时机为当此对象销毁时，会自动执行这个方法。比如说运行<code>applicationContext.registerShutdownHook</code>时，就会触发这个方法。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>DisposableBean</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[DisposableBean] NormalBeanA&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=15-applicationlistener>15. ApplicationListener</h2>
<blockquote>
<p>org.springframework.context.ApplicationListener</p>
</blockquote>
<p>准确的说，这个应该不算spring&springboot当中的一个扩展点，<code>ApplicationListener</code>可以监听某个事件的<code>event</code>，触发时机可以穿插在业务方法执行过程中，用户可以自定义某个业务事件。但是spring内部也有一些内置事件，这种事件，可以穿插在启动调用中。我们也可以利用这个特性，来自己做一些内置事件的监听器来达到和前面一些触发点大致相同的事情。</p>
<p>接下来罗列下spring主要的内置事件：</p>
<ul>
<li>
<p>ContextRefreshedEvent</p>
<p>ApplicationContext 被初始化或刷新时，该事件被发布。这也可以在<code> ConfigurableApplicationContext</code>接口中使用 <code>refresh() </code>方法来发生。此处的初始化是指：所有的Bean被成功装载，后处理Bean被检测并激活，所有Singleton Bean 被预实例化，<code>ApplicationContext</code>容器已就绪可用。</p>
</li>
<li>
<p>ContextStartedEvent</p>
<p>当使用 <code>ConfigurableApplicationContext</code> （ApplicationContext子接口）接口中的 start() 方法启动 <code>ApplicationContext </code>时，该事件被发布。你可以调查你的数据库，或者你可以在接受到这个事件后重启任何停止的应用程序。</p>
</li>
<li>
<p>ContextStoppedEvent</p>
<p>当使用 <code>ConfigurableApplicationContext </code>接口中的 <code>stop() </code>停止<code> ApplicationContext</code> 时，发布这个事件。你可以在接受到这个事件后做必要的清理的工作</p>
</li>
<li>
<p>ContextClosedEvent</p>
<p>当使用 <code>ConfigurableApplicationContext</code>接口中的 <code>close()</code>方法关闭 <code>ApplicationContext</code> 时，该事件被发布。一个已关闭的上下文到达生命周期末端；它不能被刷新或重启</p>
</li>
<li>
<p>RequestHandledEvent</p>
<p>这是一个 web-specific 事件，告诉所有 bean HTTP 请求已经被服务。只能应用于使用DispatcherServlet的Web应用。在使用Spring作为前端的MVC控制器时，当Spring处理用户请求结束后，系统会自动触发该事件</p>
</li>
</ul>
<h2 id=总结>总结</h2>
<p>我们从这些spring&springboot的扩展点当中，大致可以窥视到整个bean的生命周期。在业务开发或者写中间件业务的时候，可以合理利用spring提供给我们的扩展点，在spring启动的各个阶段内做一些事情。以达到自定义初始化的目的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b51917ad9041bab714580f7b22d13d9b>2.8 - CH08-控制加载顺序</h1>
<p><code>springboot</code>遵从约定大于配置的原则，极大程度的解决了配置繁琐的问题。在此基础上，又提供了spi机制，用<code>spring.factories</code>可以完成一个小组件的自动装配功能。</p>
<p>在一般业务场景，可能你不大关心一个bean是如何被注册进spring容器的。只需要把需要注册进容器的bean声明为<code>@Component</code>即可，spring会自动扫描到这个Bean完成初始化并加载到spring上下文容器。</p>
<p>而当你在项目启动时需要提前做一个业务的初始化工作时，或者你正在开发某个中间件需要完成自动装配时。你会声明自己的Configuration类，但是可能你面对的是好几个有互相依赖的Bean。如果不加以控制，这时候可能会报找不到依赖的错误。</p>
<p>但是你明明已经把相关的Bean都注册进spring上下文了呀。这时候你需要通过一些手段来控制springboot中的bean加载顺序。</p>
<h2 id=几个误区>几个误区</h2>
<p>在正式说如何控制加载顺序之前，先说2个误区。</p>
<p><strong>在标注了<code>@Configuration</code>的类中，写在前面的@Bean一定会被先注册</strong></p>
<p>这个不存在的，spring在以前xml的时代，也不存在写在前面一定会被先加载的逻辑。因为xml不是渐进的加载，而是全部parse好，再进行依赖分析和注册。到了springboot中，只是省去了xml被parse成spring内部对象的这一过程，但是加载方式并没有大的改变。</p>
<p><strong>利用<code>@Order</code>这个标注能进行加载顺序的控制</strong></p>
<p>严格的说，不是所有的Bean都可以通过<code>@Order</code>这个标注进行顺序的控制。你把<code>@Order</code>这个标注加在普通的方法上或者类上一点鸟用都没有。</p>
<p>那<code>@Order</code>能控制哪些bean的加载顺序呢，我们先看看官方的解释：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>{@code @Order} defines the sort order for an annotated component. Since Spring 4.0, annotation-based ordering is supported for many kinds of components in Spring, even for collection injection where the order values of the target components are taken into account (either from their target class or from their {@code @Bean} method). While such order values may influence priorities at injection points, please be aware that they do not influence singleton startup order which is an orthogonal concern determined by dependency relationships and {@code @DependsOn} declarations (influencing a runtime-determined dependency graph).
</code></pre></div><p>最开始<code>@Order</code>注解用于切面的优先级指定；在 4.0 之后对它的功能进行了增强，支持集合的注入时，指定集合中 bean 的顺序，并且特别指出了，它对于但实例的 bean 之间的顺序，没有任何影响。</p>
<p>目前用的比较多的有以下3点：</p>
<ul>
<li>控制AOP的类的加载顺序，也就是被<code>@Aspect</code>标注的类</li>
<li>控制<code>ApplicationListener</code>实现类的加载顺序</li>
<li>控制<code>CommandLineRunner</code>实现类的加载顺序</li>
</ul>
<h2 id=控制方法>控制方法</h2>
<h3 id=dependson>@DependsOn</h3>
<p><code>@DependsOn</code>注解可以用来控制bean的创建顺序，该注解用于声明当前bean依赖于另外一个bean。所依赖的bean会被容器确保在当前bean实例化之前被实例化。</p>
<p>示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@DependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@DependsOn</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;beanD&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;beanE&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanC</span> <span style=color:#000>beanC</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean C init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanC</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@DependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beanE&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanD</span> <span style=color:#000>beanD</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean D init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanD</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanE</span> <span style=color:#000>beanE</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean E init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanE</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上代码bean的加载顺序为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>bean B init
bean A init
bean E init
bean D init
bean C init
</code></pre></div><p><code>@DependsOn</code>的使用：</p>
<ul>
<li>直接或者间接标注在带有<code>@Component</code>注解的类上面;</li>
<li>直接或者间接标注在带有<code>@Bean</code>注解的方法上面;</li>
<li>使用<code>@DependsOn</code>注解到类层面仅仅在使用 component-scanning 方式时才有效，如果带有<code>@DependsOn</code>注解的类通过XML方式使用，该注解会被忽略，<code>&lt;bean depends-on="..."/></code>这种方式会生效。</li>
</ul>
<h3 id=参数注入>参数注入</h3>
<p>在<code>@Bean</code>标注的方法上，如果你传入了参数，springboot会自动会为这个参数在spring上下文里寻找这个类型的引用。并先初始化这个类的实例。</p>
<p>利用此特性，我们也可以控制bean的加载顺序。</p>
<p>示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Bean</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanB</span> <span style=color:#000>demoB</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Bean</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上结果，beanB先于beanA被初始化加载。</p>
<p>需要注意的是，springboot会按类型去寻找。如果这个类型有多个实例被注册到spring上下文，那你就需要加上<code>@Qualifier("Bean的名称")</code>来指定</p>
<h3 id=生命周期中的扩展点>生命周期中的扩展点</h3>
<p>在spring体系中，从容器到Bean实例化&初始化都是有生命周期的，并且提供了很多的扩展点，允许你在这些步骤时进行逻辑的扩展。</p>
<p>这些可扩展点的加载顺序由spring自己控制，大多数是无法进行干预的。我们可以利用这一点，扩展spring的扩展点。在相应的扩展点加入自己的业务初始化代码。从来达到顺序的控制。</p>
<h3 id=autoconfigureorder>@AutoConfigureOrder</h3>
<p>这个注解用来指定配置文件的加载顺序。但是在实际测试中发现，以下这样使用是不生效的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration1</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration2</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>无论你2个数字填多少，都不会改变其加载顺序结果。</p>
<p>那这个<code>@AutoConfigureOrder</code>到底是如何使用的呢。</p>
<p>经过测试发现，<code>@AutoConfigureOrder</code>只能改变外部依赖的<code>@Configuration</code>的顺序。如何理解是外部依赖呢。</p>
<p>能被你工程内部scan到的包，都是内部的Configuration，而spring引入外部的Configuration，都是通过spring特有的spi文件：<code>spring.factories</code></p>
<p><strong>换句话说，<code>@AutoConfigureOrder</code>能改变<code>spring.factories</code>中的<code>@Configuration</code>的顺序。</strong></p>
<p>具体使用方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration1</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration2</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>spring.factories</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-stylus data-lang=stylus><span style=color:#a40000>org</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>springframework</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boot</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>autoconfigure</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>EnableAutoConfiguration</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#a40000>\</span>
  <span style=color:#a40000>com</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>demo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BeanOrderConfiguration1</span><span style=color:#000;font-weight:700>,</span><span style=color:#a40000>\</span>
  <span style=color:#a40000>com</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>demo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BeanOrderConfiguration2</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8cd9b12dd975c73df503ba9175609189>3 - Spring AOP</h1>
<h2 id=reference>Reference</h2>
<ul>
<li>原文地址：<a href=https://segmentfault.com/a/1190000007469968>https://segmentfault.com/a/1190000007469968</a></li>
</ul>
</div>
<div class=td-content>
<h1 id=pg-f1cf3ad474cbe8e0f22061af8a0afc86>3.1 - AOP 理论</h1>
<h2 id=什么是-aop>什么是 AOP</h2>
<p>AOP(Aspect-Oriented Programming), 即 <strong>面向切面编程</strong>, 它与 OOP( Object-Oriented Programming, 面向对象编程) 相辅相成, 提供了与 OOP 不同的抽象软件结构的视角.</p>
<p>在 OOP 中, 我们以类(class)作为我们的基本单元, 而 AOP 中的基本单元是 <strong>Aspect(切面)</strong>。</p>
<h2 id=术语>术语</h2>
<h3 id=切面aspect>切面：Aspect</h3>
<p><code>aspect</code> 由 <code>pointcount</code> 和 <code>advice</code> 组成, 它既包含了横切逻辑的定义, 也包括了连接点的定义. Spring AOP就是负责实施切面的框架, 它将切面所定义的横切逻辑织入到切面所指定的连接点中.
AOP的工作重心在于如何将增强织入目标对象的连接点上, 这里包含两个工作:</p>
<ol>
<li>如何通过 pointcut 和 advice 定位到特定的 joinpoint 上</li>
<li>如何在 advice 中编写切面代码.</li>
</ol>
<p><strong>可以简单地认为, 使用 @Aspect 注解的类就是切面.</strong></p>
<h3 id=增强advice>增强：advice</h3>
<p>由 aspect 添加到特定的 join point(即满足 point cut 规则的 join point) 的一段代码.</p>
<p>许多 AOP框架, 包括 Spring AOP, 会将 advice 模拟为一个拦截器(interceptor), 并且在 join point 上维护多个 advice, 进行层层拦截.</p>
<p>例如 HTTP 鉴权的实现, 我们可以为每个使用 RequestMapping 标注的方法织入 advice, 当 HTTP 请求到来时, 首先进入到 advice 代码中, 在这里我们可以分析这个 HTTP 请求是否有相应的权限, 如果有, 则执行 Controller, 如果没有, 则抛出异常. 这里的 advice 就扮演着鉴权拦截器的角色了.</p>
<h3 id=连接点join-point>连接点：join point</h3>
<blockquote>
<p>a point during the execution of a program, such as the execution of a method or the handling of an exception. In Spring AOP, a join point always represents a method execution.</p>
</blockquote>
<p>程序运行中的一些时间点、时机, 例如一个方法的执行, 或者是一个异常的处理.</p>
<p><code>在 Spring AOP 中, join point 总是方法的执行点, 即只有方法连接点.</code></p>
<h3 id=切点point-cut>切点：point cut</h3>
<p>匹配 join point 的谓词(a predicate that matches join points).</p>
<p>Advice 是和特定的 point cut 关联的, 并且在 point cut 相匹配的 join point 中执行.</p>
<p><code>在 Spring 中, 所有的方法都可以认为是 joinpoint, 但是我们并不希望在所有的方法上都添加 Advice, 而 pointcut 的作用就是提供一组规则(使用 AspectJ pointcut expression language 来描述) 来匹配joinpoint, 给满足规则的 joinpoint 添加 Advice.</code></p>
<h3 id=区别joint-point-与-point-cut>区别：joint point 与 point cut</h3>
<p>在 Spring AOP 中, 所有的方法执行都是 join point. 而 point cut 是一个描述信息, 它修饰的是 join point, 通过 point cut, 我们就可以确定哪些 join point 可以被织入 Advice. 因此 join point 和 point cut 本质上就是两个不同纬度上的东西.</p>
<p><code>advice 是在 join point 上执行的, 而 point cut 规定了哪些 join point 可以执行哪些 advice</code></p>
<h3 id=introduction>introduction</h3>
<p>为一个类型添加额外的方法或字段. Spring AOP 允许我们为 <code>目标对象</code> 引入新的接口(和对应的实现). 例如我们可以使用 introduction 来为一个 bean 实现 IsModified 接口, 并以此来简化 caching 的实现.</p>
<h3 id=目标对象target>目标对象：Target</h3>
<p>织入 advice 的目标对象. 目标对象也被称为 <code>advised object</code>.</p>
<p><code>因为 Spring AOP 使用运行时代理的方式来实现 aspect, 因此 adviced object 总是一个代理对象(proxied object)。</code></p>
<p><code>注意, adviced object 指的不是原来的类, 而是织入 advice 后所产生的代理类.</code></p>
<h3 id=aop-proxy>AOP Proxy</h3>
<p>一个类被 AOP 织入 advice, 就会产生一个结果类, 它是融合了原类和增强逻辑的代理类.</p>
<p>在 Spring AOP 中, 一个 AOP 代理是一个 JDK 动态代理对象或 CGLIB 代理对象.</p>
<h3 id=织入weaving>织入：Weaving</h3>
<p>将 aspect 和其他对象连接起来, 并创建 adviced object 的过程.</p>
<p>根据不同的实现技术, AOP织入有三种方式:</p>
<ul>
<li>编译器织入, 这要求有特殊的Java编译器.</li>
<li>类装载期织入, 这需要有特殊的类装载器.</li>
<li>动态代理织入, 在运行期为目标类添加增强(Advice)生成子类的方式.
Spring 采用动态代理织入, 而AspectJ采用编译器织入和类装载期织入.</li>
</ul>
<h3 id=advice-类型>advice 类型</h3>
<ul>
<li>before advice：在 join point 前被执行的 advice. 虽然 before advice 是在 join point 前被执行, 但是它并不能够阻止 join point 的执行, 除非发生了异常(即我们在 before advice 代码中, 不能人为地决定是否继续执行 join point 中的代码)</li>
<li>after return advice：在一个 join point 正常返回后执行的 advice</li>
<li>after throwing advice：当一个 join point 抛出异常后执行的 advice</li>
<li>after(final) advice：无论一个 join point 是正常退出还是发生了异常, 都会被执行的 advice.</li>
<li>around advice：在 join point 前和 joint point 退出后都执行的 advice. 这个是最常用的 advice.</li>
</ul>
<h2 id=关于-aop-proxy>关于 AOP Proxy</h2>
<p>Spring AOP 默认使用标准的 JDK 动态代理(dynamic proxy)技术来实现 AOP 代理, 通过它, 我们可以为任意的接口实现代理.</p>
<p><code>如果需要为一个类实现代理, 那么可以使用 CGLIB 代理.</code> 当一个业务逻辑对象没有实现接口时, 那么Spring AOP 就默认使用 CGLIB 来作为 AOP 代理了.</p>
<p>即如果我们需要为一个方法织入 advice, 但是这个方法不是一个接口所提供的方法, 则此时 Spring AOP 会使用 CGLIB 来实现动态代理.</p>
<p>鉴于此, Spring AOP 建议基于接口编程, 对接口进行 AOP 而不是类.</p>
<h2 id=aspectj-支持>@AspectJ 支持</h2>
<p><strong>@AspectJ</strong> 是一种使用 Java 注解来实现 AOP 的编码风格.</p>
<p>@AspectJ 风格的 AOP 是 AspectJ Project 在 AspectJ 5 中引入的, 并且 Spring 也支持 @AspectJ 的 AOP 风格.</p>
<h3 id=开启-aspectj-支持>开启 @AspectJ 支持</h3>
<p>@AspectJ 可以以 XML 的方式或以注解的方式来开启, 并且不论以哪种方式开启 @ASpectJ, 我们都必须保证 aspectjweaver.jar 在 classpath 中.</p>
<h4 id=通过-java-configuration-方式开启-aspectj>通过 Java Configuration 方式开启 @AspectJ</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@EnableAspectJAutoProxy</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=通过-xml-方式开启-aspectj>通过 XML 方式开启 @AspectJ</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;aop:aspectj-autoproxy/&gt;</span>
</code></pre></div><h3 id=定义切面-aspect>定义切面 aspect</h3>
<p>当使用注解 <strong>@Aspect</strong> 标注一个 Bean 后, 那么 Spring 框架会自动收集这些 Bean, 并添加到 Spring AOP 中, 例如:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyTest</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意, 仅仅使用@Aspect 注解, 并不能将一个 Java 对象转换为 Bean, 因此我们还需要使用类似 @Component 之类的</p>
<p>注解.注意, 如果一个 类被@Aspect 标注, 则这个类就不能是其他 aspect 的 <strong>advised object</strong> 了, 因为使用 @Aspect 后, 这个类就会被排除在 auto-proxying 机制之外.</p>
<h3 id=声明-pointcut>声明 pointcut</h3>
<p>一个 pointcut 的声明由两部分组成:</p>
<ul>
<li>一个方法签名, 包括方法名和相关参数</li>
<li>一个 pointcut 表达式, 用来指定哪些方法执行是我们感兴趣的(即因此可以织入 advice).</li>
</ul>
<p>在 @AspectJ 风格的 AOP 中, 我们使用一个方法来描述 pointcut, 即:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execution(* com.xys.service.UserService.*(..))&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 切点表达式
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>dataAccessOperation</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{}</span> <span style=color:#8f5902;font-style:italic>// 切点前面
</span></code></pre></div><p><code>这个方法必须无返回值.</code>
<code>这个方法本身就是 pointcut signature, pointcut 表达式使用@Pointcut 注解指定.</code>
上面我们简单地定义了一个 pointcut, 这个 pointcut 所描述的是: 匹配所有在包 <strong>com.xys.service.UserService</strong> 下的所有方法的执行.</p>
<h3 id=切点标志符-designator>切点标志符 designator</h3>
<p>AspectJ5 的切点表达式由标志符(designator)和操作参数组成. 如 &ldquo;execution( <em>greetTo(..))&rdquo; 的切点表达式, <strong>execution</strong> 就是 标志符, 而圆括号里的</em> greetTo(..) 就是操作参数</p>
<h5 id=execution>execution</h5>
<p>匹配 join point 的执行, 例如 &ldquo;execution(* hello(..))&rdquo; 表示匹配所有目标类中的 hello() 方法. 这个是最基本的 pointcut 标志符.</p>
<h5 id=within>within</h5>
<p>匹配特定包下的所有 join point, 例如 <code>within(com.xys.*)</code> 表示 com.xys 包中的所有连接点, 即包中的所有类的所有方法. 而 <code>within(com.xys.service.*Service)</code> 表示在 com.xys.service 包中所有以 Service 结尾的类的所有的连接点.</p>
<h5 id=this-与-target>this 与 target</h5>
<p>this 的作用是匹配一个 bean, 这个 bean(Spring AOP proxy) 是一个给定类型的实例(instance of). 而 target 匹配的是一个目标对象(target object, 即需要织入 advice 的原始的类), 此对象是一个给定类型的实例(instance of).</p>
<h5 id=bean>bean</h5>
<p>匹配 bean 名字为指定值的 bean 下的所有方法, 例如:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>Service</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 匹配名字后缀为 Service 的 bean 下的所有方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myService</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 匹配名字为 myService 的 bean 下的所有方法
</span></code></pre></div><h5 id=args>args</h5>
<p>匹配参数满足要求的的方法.
例如:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;within(com.xys.demo2.*)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pointcut2</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;pointcut2()  &amp;&amp;  args(name)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---page: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>someMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---NormalService: someMethod invoked---&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>


    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---NormalService: test invoked---&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;服务一切正常&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当 NormalService.test 执行时, 则 advice <code>doSomething</code> 就会执行, test 方法的参数 name 就会传递到 <code>doSomething</code> 中.</p>
<p>常用例子:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 匹配只有一个参数 name 的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;aspectMethod()  &amp;&amp;  args(name)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 匹配第一个参数为 name 的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;aspectMethod()  &amp;&amp;  args(name, ..)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 匹配第二个参数为 name 的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;aspectMethod()  &amp;&amp;  args(*, name, ..)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=annotation>@annotation</h5>
<p>匹配由指定注解所标注的方法, 例如:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;@annotation(com.xys.demo1.AuthChecker)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>则匹配由注解 <code>AuthChecker</code> 所标注的方法.</p>
<h3 id=常见切点表达式>常见切点表达式</h3>
<h5 id=匹配方法签名>匹配方法签名</h5>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 匹配指定包中的所有的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>execution</span><span style=color:#ce5c00;font-weight:700>(*</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>.*(..))</span>

<span style=color:#8f5902;font-style:italic>// 匹配当前包中的指定类的所有方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>execution</span><span style=color:#ce5c00;font-weight:700>(*</span> <span style=color:#000>UserService</span><span style=color:#ce5c00;font-weight:700>.*(..))</span>

<span style=color:#8f5902;font-style:italic>// 匹配指定包中的所有 public 方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>execution</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>.*(..))</span>

<span style=color:#8f5902;font-style:italic>// 匹配指定包中的所有 public 方法, 并且返回值是 int 类型的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>execution</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>.*(..))</span>

<span style=color:#8f5902;font-style:italic>// 匹配指定包中的所有 public 方法, 并且第一个参数是 String, 返回值是 int 类型的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>execution</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>.*(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>..))</span>
</code></pre></div><h5 id=匹配类型签名>匹配类型签名</h5>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 匹配指定包中的所有的方法, 但不包括子包
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>within</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>.*)</span>

<span style=color:#8f5902;font-style:italic>// 匹配指定包中的所有的方法, 包括子包
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>within</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>..*)</span>

<span style=color:#8f5902;font-style:italic>// 匹配当前包中的指定类中的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>within</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserService</span><span style=color:#ce5c00;font-weight:700>)</span>


<span style=color:#8f5902;font-style:italic>// 匹配一个接口的所有实现类中的实现的方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>within</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserDao</span><span style=color:#ce5c00;font-weight:700>+)</span>
</code></pre></div><h5 id=匹配-bean-名字>匹配 Bean 名字</h5>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 匹配以指定名字结尾的 Bean 中的所有方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>Service</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h5 id=切点表达式组合>切点表达式组合</h5>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 匹配以 Service 或 ServiceImpl 结尾的 bean
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>Service</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ServiceImpl</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// 匹配名字以 Service 结尾, 并且在包 com.xys.service 中的 bean
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>Service</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>within</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>.*)</span>
</code></pre></div><h3 id=声明-advice>声明 advice</h3>
<p>advice 是和一个 pointcut 表达式关联在一起的, 并且会在匹配的 join point 的方法执行的前/后/周围 运行. <code>pointcut 表达式可以是简单的一个 pointcut 名字的引用, 或者是完整的 pointcut 表达式</code>.
下面我们以几个简单的 advice 为例子, 来看一下一个 advice 是如何声明的.</p>
<h4 id=before-advice>Before advice</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * @author xiongyongshun
</span><span style=color:#8f5902;font-style:italic> * @version 1.0
</span><span style=color:#8f5902;font-style:italic> * @created 16/9/9 13:13
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeforeAspectTest</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 定义一个 Pointcut, 使用 切点表达式函数 来描述对哪些 Join point 使用 advise.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execution(* com.xys.service.UserService.*(..))&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>dataAccessOperation</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AdviseDefine</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 定义 advise
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.xys.aspect.PointcutDefine.dataAccessOperation()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doBeforeAccessCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;*****Before advise, method: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; *****&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里, <strong>@Before</strong> 引用了一个 pointcut, 即 &ldquo;com.xys.aspect.PointcutDefine.dataAccessOperation()&rdquo; 是一个 pointcut 的名字.
如果我们在 advice 在内置 pointcut, 则可以:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AdviseDefine</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 将 pointcut 和 advice 同时定义
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;within(com.xys.service..*)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doAccessCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;*****doAccessCheck, Before advise, method: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; *****&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=around-advice>around advice</h4>
<p>around advice 比较特别, 它可以在一个方法的之前之前和之后添加不同的操作, 并且甚至可以决定何时, 如何, 是否调用匹配到的方法.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AdviseDefine</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 定义 advise
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Around</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.xys.aspect.PointcutDefine.dataAccessOperation()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>doAroundAccessCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>StopWatch</span> <span style=color:#000>stopWatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StopWatch</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 开始
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stop</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 结束
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;invoke method: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, elapsed time: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTotalTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>around advice 和前面的 before advice 差不多, 只是我们把注解 <strong>@Before</strong> 改为了 <strong>@Around</strong> 了.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6cd40205393a6545176585a42ce0a584>3.2 - AOP 实战</h1>
<h2 id=spring-aop-实战>Spring AOP 实战</h2>
<p>看了上面这么多的理论知识, 不知道大家有没有觉得枯燥哈. 不过不要急, 俗话说理论是实践的基础, 对 Spring AOP 有了基本的理论认识后, 我们来看一下下面几个具体的例子吧.</p>
<p>下面的几个例子是我在工作中所遇见的比较常用的 Spring AOP 的使用场景, 我精简了很多有干扰我们学习的注意力的细枝末节, 以力求整个例子的简洁性.</p>
<h3 id=http-接口鉴权>HTTP 接口鉴权</h3>
<p>首先让我们来想象一下如下场景: 我们需要提供的 HTTP RESTful 服务, 这个服务会提供一些比较敏感的信息, 因此对于某些接口的调用会进行调用方权限的校验, 而某些不太敏感的接口则不设置权限, 或所需要的权限比较低(例如某些监控接口, 服务状态接口等).</p>
<p>实现这样的需求的方法有很多, 例如我们可以在每个 HTTP 接口方法中对服务请求的调用方进行权限的检查, 当调用方权限不符时, 方法返回错误. 当然这样做并无不可, 不过如果我们的 api 接口很多, 每个接口都进行这样的判断, 无疑有很多冗余的代码, 并且很有可能有某个粗心的家伙忘记了对调用者的权限进行验证, 这样就会造成潜在的 bug.
那么除了上面的所说的方法外, 还有没有别的比较优雅的方式来实现呢? 当然有啦, 不然我在这啰嗦半天干嘛呢, 它就是我们今天的主角: <code>AOP</code>.</p>
<p>让我们来提炼一下我们的需求:</p>
<ol>
<li>可以定制地为某些指定的 HTTP RESTful api 提供权限验证功能.</li>
<li>当调用方的权限不符时, 返回错误.</li>
</ol>
<p>根据上面所提出的需求, 我们可以进行如下设计:</p>
<ol>
<li>提供一个特殊的注解 <code>AuthChecker</code>, 这个是一个方法注解, 有此注解所标注的 Controller 需要进行调用方权限的认证.</li>
<li>利用 Spring AOP, 以 <strong>@annotation</strong> 切点标志符来匹配有注解 <code>AuthChecker</code> 所标注的 joinpoint.</li>
<li>在 advice 中, 简单地检查调用者请求中的 Cookie 中是否有我们指定的 token, 如果有, 则认为此调用者权限合法, 允许调用, 反之权限不合法, 范围错误.</li>
</ol>
<p>根据上面的设计, 我们来看一下具体的源码吧.</p>
<p>首先是 <code>AuthChecker</code> 注解的定义:
<strong>AuthChecker.java:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>AuthChecker</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>AuthChecker</code> 注解是一个方法注解, 它用于注解 RequestMapping 方法.</p>
<p>有了注解的定义, 那我们再来看一下 aspect 的实现吧:
<strong>HttpAopAdviseDefine.java:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HttpAopAdviseDefine</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 定义一个 Pointcut, 使用 切点表达式函数 来描述对哪些 Join point 使用 advise.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;@annotation(com.xys.demo1.AuthChecker)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 定义 advise
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Around</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>checkAuth</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ServletRequestAttributes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>RequestContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestAttributes</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequest</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// 检查用户所传递的 token 是否合法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>token</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getUserToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>token</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equalsIgnoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;123456&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;错误, 权限不合法!&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getUserToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Cookie</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>cookies</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCookies</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cookies</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cookie</span> <span style=color:#000>cookie</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>cookies</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cookie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equalsIgnoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;user_token&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cookie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这个 aspect 中, 我们首先定义了一个 pointcut, 以 <strong>@annotation</strong> 切点标志符来匹配有注解 <code>AuthChecker</code> 所标注的 joinpoint, 即:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 定义一个 Pointcut, 使用 切点表达式函数 来描述对哪些 Join point 使用 advise.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;@annotation(com.xys.demo1.AuthChecker)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后再定义一个 advice:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 定义 advise
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Around</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>checkAuth</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ServletRequestAttributes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>RequestContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestAttributes</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequest</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// 检查用户所传递的 token 是否合法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>token</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getUserToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>token</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equalsIgnoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;123456&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;错误, 权限不合法!&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当被 <code>AuthChecker</code> 注解所标注的方法调用前, 会执行我们的这个 advice, 而这个 advice 的处理逻辑很简单, 即从 HTTP 请求中获取名为 <code>user_token</code> 的 cookie 的值, 如果它的值是 <code>123456</code>, 则我们认为此 HTTP 请求合法, 进而调用 <code>joinPoint.proceed()</code> 将 HTTP 请求转交给相应的控制器处理; 而如果<code>user_token</code> cookie 的值不是 <code>123456</code>, 或为空, 则认为此 HTTP 请求非法, 返回错误.</p>
<p>接下来我们来写一个模拟的 HTTP 接口:
<strong>DemoController.java:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DemoController</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/aop/http/alive&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>alive</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;服务一切正常&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@AuthChecker</span>
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/aop/http/user_info&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>callSomeInterface</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;调用了 user_info 接口.&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意到上面我们提供了两个 HTTP 接口, 其中 接口 <strong>/aop/http/alive</strong> 是没有 <code>AuthChecker</code> 标注的, 而 <strong>/aop/http/user_info</strong> 接口则用到了 <code>@AuthChecker</code> 标注. 那么自然地, 当请求了 <strong>/aop/http/user_info</strong> 接口时, 就会触发我们所设置的权限校验逻辑.</p>
<p>接下来我们来验证一下, 我们所实现的功能是否有效吧.
首先在 Postman 中, 调用 <strong>/aop/http/alive</strong> 接口, 请求头中不加任何参数:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211014235824.png style=display:block;width:80% alt=NAME align=center> </div>
<p>可以看到, 我们的 HTTP 请求完全没问题.</p>
<p>那么再来看一下请求 <strong>/aop/http/user_info</strong> 接口会怎样呢:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211014235839.png style=display:block;width:80% alt=NAME align=center> </div>
<p>当我们请求 <strong>/aop/http/user_info</strong> 接口时, 服务返回一个权限异常的错误, 为什么会这样呢? 自然就是我们的权限认证系统起了作为: 当一个方法被调用并且这个方法有 <code>AuthChecker</code> 标注时, 那么首先会执行到我们的 <code>around advice</code>, 在这个 advice 中, 我们会校验 HTTP 请求的 cookie 字段中是否有携带 <code>user_token</code> 字段时, 如果没有, 则返回权限错误.</p>
<p>那么为了能够正常地调用 <strong>/aop/http/user_info</strong> 接口, 我们可以在 Cookie 中添加 <strong>user_token=123456</strong>, 这样我们可以愉快的玩耍了:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211014235858.png style=display:block;width:80% alt=NAME align=center> </div>
<p><code>注意</code>, Postman 默认是不支持 Cookie 的, 所以为了实现添加 Cookie 的功能, 我们需要安装 Postman 的 <code>interceptor</code> 插件. 安装方法可以看<a href="https://link.segmentfault.com/?enc=G1d106ZYXX2unwFeLlob%2BQ%3D%3D.JSe3FYMqFgMOzpDOTccrfnVcWpZU4wnJOYRkskEDvikaJ%2Bv8N2yetiKGLsS98UOM9kXu2hfUcpOlvgOBmo9dJg%3D%3D">官网的文章</a></p>
<h3 id=方法调用日志>方法调用日志</h3>
<p>第二个 AOP 实例是记录一个方法调用的log. 这应该是一个很常见的功能了.
首先假设我们有如下需求:</p>
<ol>
<li>某个服务下的方法的调用需要有 log: 记录调用的参数以及返回结果.</li>
<li>当方法调用出异常时, 有特殊处理, 例如打印异常 log, 报警等.</li>
</ol>
<p>根据上面的需求, 我们可以使用 before advice 来在调用方法前打印调用的参数, 使用 after returning advice 在方法返回打印返回的结果. 而当方法调用失败后, 可以使用 after throwing advice 来做相应的处理.
那么我们来看一下 aspect 的实现:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LogAopAdviseDefine</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#8f5902;font-style:italic>// 定义一个 Pointcut, 使用 切点表达式函数 来描述对哪些 Join point 使用 advise.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;within(NeedLogService)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 定义 advise
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>logMethodInvokeParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---Before method {} invoke, param: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArgs</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@AfterReturning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>returning</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;retVal&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>logMethodInvokeResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---After method {} invoke, result: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArgs</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@AfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>throwing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;exception&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>logMethodInvokeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Exception</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---method {} invoke exception: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>第一步, 自然是定义一个 <code>pointcut</code>, 以 <strong>within</strong> 切点标志符来匹配类 <code>NeedLogService</code> 下的所有 joinpoint, 即:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;within(NeedLogService)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来根据我们前面的设计, 我们分别定义了三个 advice, 第一个是一个 before advice:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>logMethodInvokeParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---Before method {} invoke, param: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArgs</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>它在一个符合要求的 joinpoint 方法调用前执行, 打印调用的方法名和调用的参数.</p>
<p>第二个是 after return advice:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@AfterReturning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>returning</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;retVal&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>logMethodInvokeResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---After method {} invoke, result: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getArgs</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个 advice 会在方法调用成功后打印出方法名还反的参数.</p>
<p>最后一个是 after throw advice:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@AfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>throwing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;exception&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>logMethodInvokeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Exception</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---method {} invoke exception: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个 advice 会在指定的 joinpoint 抛出异常时执行, 打印异常的信息.</p>
<p>接下来我们再写两个 Service 类:
<strong>NeedLogService.java:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NeedLogService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Random</span> <span style=color:#000>random</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>logMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>someParam</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---NeedLogService: logMethod invoked, param: {}---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>someParam</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>exceptionMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---NeedLogService: exceptionMethod invoked---&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Something bad happened!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>NormalService.java:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>someMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---NormalService: someMethod invoked---&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>根据我们 pointcut 的规则, 类 NeedLogService 下的所有方法都会被织入 advice, 而类 NormalService 则不会.</p>
<p>最后我们分别调用这几个方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostConstruct</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>needLogService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;xys&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>needLogService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Ignore
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>normalService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>someMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到有如下输出:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>---Before method NeedLogService.logMethod(..) invoke, param: [xys]---
---NeedLogService: logMethod invoked, param: xys---
---After method NeedLogService.logMethod(..) invoke, result: [xys]---

---Before method NeedLogService.exceptionMethod() invoke, param: []---
---NeedLogService: exceptionMethod invoked---
---method NeedLogService.exceptionMethod() invoke exception: Something bad happened!---

---NormalService: someMethod invoked---
</code></pre></div><p>根据 log, 我们知道, NeedLogService.logMethod 执行的前后确实有 advice 执行了, 并且在 NeedLogService.exceptionMethod 抛出异常后, <code>logMethodInvokeException</code> 这个 advice 也被执行了. 而由于 pointcut 的匹配规则, 在 <code>NormalService</code> 类中的方法则不会织入 advice.</p>
<h3 id=方法耗时统计>方法耗时统计</h3>
<p>作为程序员, 我们都知道服务监控对于一个服务能够长期稳定运行的重要性, 因此很多公司都有自己内部的监控报警系统, 或者是使用一些开源的系统, 例如小米的 Falcon 监控系统.</p>
<p>那么在程序监控中, AOP 有哪些用武之地呢? 我们来假想一下如下场景:</p>
<blockquote>
<p>有一天, leader 对小王说, &ldquo;小王啊, 你负责的那个服务不太稳定啊, 经常有超时发生! 你有对这些服务接口进行过耗时统计吗?&rdquo;
耗时统计? 小王嘀咕了, 小声的回答到: &ldquo;还没有加呢.&rdquo;
leader: &ldquo;你看着办吧, 我明天要看到各个时段的服务接口调用的耗时分布!&rdquo;
小王这就犯难了, 虽然说计算一个方法的调用耗时并不是一个很难的事情, 但是整个服务有二十来个接口呢, 一个一个地添加统计代码, 那还不是要累死人了.
看着同事一个一个都下班回家了, 小王眉头更加紧了. 不过此时小王灵机一动: &ldquo;噫, 有了!&rdquo;.
小王想到了一个好方法, 立即动手, 吭哧吭哧地几分钟就搞定了.</p>
</blockquote>
<p>那么小王的解决方法是什么呢? 自然是我们的主角 <code>AOP</code> 啦.</p>
<p>首先让我们来提炼一下需求:</p>
<ol>
<li>为服务中的每个方法调用进行调用耗时记录.</li>
<li>将方法调用的时间戳, 方法名, 调用耗时上报到监控平台</li>
</ol>
<p>有了需求, 自然设计实现就很简单了. 首先我们可以使用 around advice, 然后在方法调用前, 记录一下开始时间, 然后在方法调用结束后, 记录结束时间, 它们的时间差就是方法的调用耗时.</p>
<p>我们来看一下具体的 aspect 实现:</p>
<p><strong>ExpiredAopAdviseDefine.java:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@Aspect</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ExpiredAopAdviseDefine</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#8f5902;font-style:italic>// 定义一个 Pointcut, 使用 切点表达式函数 来描述对哪些 Join point 使用 advise.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Pointcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;within(SomeService)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pointcut</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 定义 advise
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 定义 advise
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Around</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>methodInvokeExpiredTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>StopWatch</span> <span style=color:#000>stopWatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StopWatch</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 开始
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stop</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 结束
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>// 上报到公司监控平台
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>reportToMonitorSystem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTotalTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>


    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reportToMonitorSystem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>expiredTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---method {} invoked, expired time: {} ms---&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>expiredTime</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>aspect 一开始定义了一个 <code>pointcut</code>, 匹配 <code>SomeService</code> 类下的所有的方法.
接着呢, 定义了一个 around advice:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Around</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pointcut()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>methodInvokeExpiredTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ProceedingJoinPoint</span> <span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>StopWatch</span> <span style=color:#000>stopWatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StopWatch</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 开始
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>retVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stop</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 结束
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 上报到公司监控平台
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>reportToMonitorSystem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pjp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toShortString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>stopWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTotalTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retVal</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>advice 中的代码也很简单, 它使用了 Spring 提供的 StopWatch 来统计一段代码的执行时间. 首先我们先调用 <strong>stopWatch.start()</strong> 开始计时, 然后通过 <code>pjp.proceed()</code> 来调用我们实际的服务方法, 当调用结束后, 通过 <strong>stopWatch.stop()</strong> 来结束计时.</p>
<p>接着我们来写一个简单的服务, 这个服务提供一个 <strong>someMethod</strong> 方法用于模拟一个耗时的方法调用:
<strong>SomeService.java:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SomeService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Random</span> <span style=color:#000>random</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>someMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;---SomeService: someMethod invoked---&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 模拟耗时任务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样当 <code>SomeService</code> 类下的方法调用时, 我们所提供的 advice 就会被执行, 因此就可以自动地为我们统计此方法的调用耗时, 并自动上报到监控系统中了.
看到 <code>AOP</code> 的威力了吧, 我们这里仅仅使用了寥寥数语就把一个需求完美地解决了, 并且还与原来的业务逻辑完全解耦, 扩展及其方便.</p>
<h2 id=总结>总结</h2>
<p>通过上面的几个简单例子, 我们对 <code>Spring AOP</code> 的使用应该有了一个更为深入的了解了. 其实 Spring AOP 的使用的地方不止这些, 例如 Spring 的 <code>声明式事务</code> 就是在 AOP 之上构建的. 读者朋友也可以根据自己的实际业务场景, 合理使用 Spring AOP, 发挥它的强大功能!</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-29e1458ad73683edde81bbb86dd3cdec>4 - Mybatis</h1>
<p>参考自 &lt;MyBatis 技术内幕>。</p>
</div>
<div class=td-content>
<h1 id=pg-dd52fe1a10710f0961ee3c2e2b522a33>4.1 - CH01-整体架构</h1>
<p>MyBatis 是一款旨在帮助开发人员屏蔽底层重复性原生 JDBC 代码的持久化框架，其支持通过映射文件配置或注解将 ResultSet 映射为 Java 对象。相对于其它 ORM 框架，MyBatis 更为轻量级，支持定制化 SQL
和动态 SQL，方便优化查询性能，同时包含了良好的缓存机制。</p>
<h2 id=整体架构>整体架构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211005234510.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=基础支持层>基础支持层</h3>
<ul>
<li>反射模块：提供封装的反射 API，方便上层调用。</li>
<li>类型转换：为简化配置文件提供了别名机制，并且实现了 Java 类型和 JDBC 类型的互转。</li>
<li>日志模块：能够集成多种第三方日志框架。</li>
<li>资源加载模块：对类加载器进行封装，提供加载类文件和其它资源文件的功能。</li>
<li>数据源模块：提供数据源实现并能够集成第三方数据源模块。</li>
<li>事务管理：可以和 Spring 集成开发，对事务进行管理。</li>
<li>缓存模块：提供一级缓存和二级缓存，将部分请求拦截在缓存层。</li>
<li>Binding 模块：在调用 SqlSession 相应方法执行数据库操作时，需要指定映射文件中的 SQL 节点，MyBatis 通过 Binding 模块将自定义 Mapper 接口与映射文件关联，避免拼写等错误导致在运行时才发现相应异常。</li>
</ul>
<h3 id=核心处理层>核心处理层</h3>
<ul>
<li>配置解析：MyBatis 初始化时会加载配置文件、映射文件和 Mapper 接口的注解信息，解析后会以对象的形式保存到 Configuration 对象中。</li>
<li>SQL 解析与 scripting 模块：MyBatis 支持通过配置实现动态 SQL，即根据不同入参生成 SQL。</li>
<li>SQL 执行与结果解析：Executor 负责维护缓存和事务管理，并将数据库相关操作委托给 StatementHandler，ParmeterHadler 负责完成 SQL 语句的实参绑定并通过 Statement 对象执行 SQL，通过 ResultSet 返回结果，交由 ResultSetHandler 处理。</li>
<li>插件：支持开发者通过插件接口对 MyBatis 进行扩展。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211005234752.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=接口层>接口层</h3>
<p>SqlSession 接口定义了暴露给应用程序调用的 API，接口层在收到请求时会调用核心处理层的相应模块完成具体的数据库操作。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-773d776c2e66e11b838e4ab33514e4c1>4.2 - CH02-反射模块</h1>
<p>MyBatis 在进行参数处理、结果映射时等操作时，会涉及大量的反射操作。为了简化这些反射相关操作，MyBatis 在 org.apache.ibatis.reflection 包下提供了专门的反射模块，对反射操作做了近一步封装，提供了更为简洁的 API。</p>
<h2 id=缓存类的元信息>缓存类的元信息</h2>
<p>MyBatis 提供 Reflector 类来缓存类的字段名和 getter/setter 方法的元信息，使得反射时有更好的性能。使用方式是将原始类对象传入其构造方法，生成 Reflector 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 如果存在，记录无参构造方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addDefaultConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 记录字段名与get方法、get方法返回值的映射关系
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addGetMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 记录字段名与set方法、set方法参数的映射关系
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addSetMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 针对没有getter/setter方法的字段，通过Filed对象的反射来设置和读取字段值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 可读的字段名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>readablePropertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()]);</span>
    <span style=color:#8f5902;font-style:italic>// 可写的字段名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>writablePropertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>setMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>setMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()]);</span>
    <span style=color:#8f5902;font-style:italic>// 保存一份所有字段名大写与原始字段名的映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>readablePropertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>caseInsensitivePropertyMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>writablePropertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>caseInsensitivePropertyMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>addGetMethods 和 addSetMethods 分别获取类的所有方法，从符合 getter/setter 规范的方法中解析出字段名，并记录方法的参数类型、返回值类型等信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addGetMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 字段名-get方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>conflictingGetters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 获取类的所有方法，及其实现接口的方法，并根据方法签名去重
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getClassMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 过滤有参方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;get&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)</span>
          <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;is&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 由get属性获取对应的字段名（去除前缀，首字母转小写）
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyNamer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodToProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>addMethodConflict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 保证每个字段只对应一个get方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>resolveGetterConflicts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对 getter/setter 方法进行去重是通过类似 java.lang.String#getSignature:java.lang.reflect.Method 的方法签名来实现的，如果子类在实现过程中，参数、返回值使用了不同的类型（使用原类型的子类），则会导致方法签名不一致，同一字段就会对应不同的 getter/setter 方法，因此需要进行去重。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>resolveGetterConflicts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Method</span> <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 属性名
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 字段对应了多个get方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>winnerType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>candidateType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winnerType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 返回值类型相同
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;Illegal overloaded getter method with ambiguous type for property &#34;</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; in class &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. This breaks the JavaBeans specification and can cause unpredictable results.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;is&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 返回值为boolean的get方法可能有多个，如getIsSave和isSave，优先取is开头的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winnerType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// OK getter type is descendant
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// 可能会出现接口中的方法返回值是List，子类实现方法返回值是ArrayList，使用子类返回值方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winnerType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionException</span><span style=color:#ce5c00;font-weight:700>(</span>
              <span style=color:#4e9a06>&#34;Illegal overloaded getter method with ambiguous type for property &#34;</span>
                  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; in class &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()</span>
                  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. This breaks the JavaBeans specification and can cause unpredictable results.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 记录字段名对应的get方法对象和返回值类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addGetMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>去重的方式是使用更规范的方法以及使用子类的方法。在确认字段名对应的唯一 getter/setter 方法后，记录方法名对应的方法、参数、返回值等信息。MethodInvoker 可用于调用 Method 类的 invoke 方法来执行 getter/setter 方法（addSetMethods 记录映射关系的方式与 addGetMethods 大致相同）。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addGetMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 过滤$开头、serialVersionUID的get方法和getClass()方法
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isValidPropertyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 字段名-对应get方法的MethodInvoker对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Type</span> <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TypeParameterResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveReturnType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 字段名-运行时方法的真正返回类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>getTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeToClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来会执行 addFields 方法，此方法针对没有 getter/setter 方法的字段，通过包装为 SetFieldInvoker 在需要时通过 Field 对象的反射来设置和读取字段值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>fields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredFields</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span> <span style=color:#000>field</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>fields</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>setMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// issue #379 - removed the check for final because JDK 1.5 allows
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// modification of final fields through reflection (JSR-133). (JGB)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// pr #16 - final static can only be set by the classloader
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>modifiers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFinal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 非final的static变量，没有set方法，可以通过File对象做赋值操作
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>addSetField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>addGetField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperclass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 递归查找父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperclass</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=抽象字段赋值与读取>抽象字段赋值与读取</h2>
<p>Invoker 接口用于抽象设置和读取字段值的操作。对于有 getter/setter 方法的字段，通过 MethodInvoker 反射执行；对应其它字段，通过 GetFieldInvoker 和 SetFieldInvoker 操作 Field 对象的 getter/setter 方法反射执行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 用于抽象设置和读取字段值的操作
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * {@link MethodInvoker} 反射执行getter/setter方法
</span><span style=color:#8f5902;font-style:italic> * {@link GetFieldInvoker} {@link SetFieldInvoker} 反射执行Field对象的get/set方法
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author Clinton Begin
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Invoker</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 通过反射设置或读取字段值
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param target
</span><span style=color:#8f5902;font-style:italic>   * @param args
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws IllegalAccessException
</span><span style=color:#8f5902;font-style:italic>   * @throws InvocationTargetException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 字段类型
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getType</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析参数类型>解析参数类型</h2>
<p>针对 Java-Type 体系的多种实现，TypeParameterResolver 提供一系列方法来解析指定类中的字段、方法返回值或方法参数的类型。</p>
<p>Type 接口包含 4 个子接口和 1 个实现类：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211005235708.png style=display:block;width:70% alt=NAME align=center> </div>
<ul>
<li>Class：原始类型</li>
<li>ParameterizedType：泛型类型，如：List<string></li>
<li>TypeVariable：泛型类型变量，如: List<t> 中的 T</li>
<li>GenericArrayType：组成元素是 ParameterizedType 或 TypeVariable 的数组类型，如：List<string>[]、T[]</li>
<li>WildcardType：通配符泛型类型变量，如：List&lt;?> 中的 ?</li>
</ul>
<p>TypeParameterResolver 分别提供 resolveFieldType、resolveReturnType、resolveParamTypes 方法用于解析字段类型、方法返回值类型和方法入参类型，这些方法均调用 resolveType 来获取类型信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 获取类型信息
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param type 根据是否有泛型信息签名选择传入泛型类型或简单类型
</span><span style=color:#8f5902;font-style:italic> * @param srcType 引用字段/方法的类（可能是子类，字段和方法在父类声明）
</span><span style=color:#8f5902;font-style:italic> * @param declaringClass 字段/方法声明的类
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Type</span> <span style=color:#000>resolveType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 泛型类型变量，如：List&lt;T&gt; 中的 T
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 泛型类型，如：List&lt;String&gt;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveParameterizedType</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>GenericArrayType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// TypeVariable/ParameterizedType 数组类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveGenericArrayType</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>GenericArrayType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 原始类型，直接返回
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>resolveTypeVar 用于解析泛型类型变量参数类型，如果字段或方法在当前类中声明，则返回泛型类型的上界或 Object 类型；如果在父类中声明，则递归解析父类；父类也无法解析，则递归解析实现的接口。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Type</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Type</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srcType</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 原始类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srcType</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 泛型类型，如 TestObj&lt;String&gt;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ParameterizedType</span> <span style=color:#000>parameterizedType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 取原始类型TestObj
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>parameterizedType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRawType</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The 2nd arg must be Class or ParameterizedType, but was: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 字段就是在当前引用类中声明的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bounds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBounds</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 返回泛型类型变量上界，如：T extends String，则返回String
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bounds</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 没有上界返回Object
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// 字段/方法在父类中声明，递归查找父类泛型
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>Type</span> <span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGenericSuperclass</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scanSuperTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// 递归泛型接口
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>superInterfaces</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGenericInterfaces</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>superInterface</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>superInterfaces</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scanSuperTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>superInterface</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 scanSuperTypes 实现递归解析：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Type</span> <span style=color:#000>scanSuperTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 父类是泛型类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ParameterizedType</span> <span style=color:#000>parentAsType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parentAsClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRawType</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 父类中的泛型类型变量集合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parentTypeVars</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentAsClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeParameters</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srcType</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 子类可能对父类泛型变量做过替换，使用替换后的类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parentAsType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>translateParentTypeVars</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>parentAsClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 字段/方法在当前父类中声明
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>parentTypeVars</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>parentTypeVars</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 使用变量对应位置的真正类型（可能已经被替换），如父类 A&lt;T&gt;，子类 B extends A&lt;String&gt;，则返回String
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getActualTypeArguments</span><span style=color:#ce5c00;font-weight:700>()[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 字段/方法声明的类是当前父类的父类，继续递归
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentAsClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Class</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 父类是原始类型，继续递归父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>解析方法返回值和方法参数的逻辑大致与解析字段类型相同，MyBatis 源码的TypeParameterResolverTest 类提供了相关的测试用例。</p>
<h2 id=元信息工厂>元信息工厂</h2>
<p>MyBatis 还提供 ReflectorFactory 接口用于实现 Reflector 容器，其默认实现为 DefaultReflectorFactory，其中可以使用 classCacheEnabled 属性来配置是否使用缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultReflectorFactory</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ReflectorFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 是否缓存Reflector类信息
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>classCacheEnabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Reflector缓存容器
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reflectorMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultReflectorFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isClassCacheEnabled</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setClassCacheEnabled</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classCacheEnabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取类的Reflector信息
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param type
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Reflector</span> <span style=color:#000>findForClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// synchronized (type) removed see issue #461
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果缓存Reflector信息，放入缓存容器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>reflectorMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#204a87;font-weight:700>new</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=对象创建工厂>对象创建工厂</h2>
<p>ObjectFactory 接口是 MyBatis 对象创建工厂，其默认实现 DefaultObjectFactory 通过构造器反射创建对象，支持使用无参构造器和有参构造器。</p>
<h2 id=属性工具集>属性工具集</h2>
<p>MyBatis 在映射文件定义 resultMap 支持如下形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;map&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;Order&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;orders[0].items[0].name&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;col1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;orders[0].items[1].name&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;col2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
	...
<span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
</code></pre></div><p><code>orders[0].items[0].name</code> 这样的表达式是由 PropertyTokenizer 解析的，其构造方法能够对表达式进行解析；同时还实现了 Iterator 接口，能够迭代解析表达式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// orders[0].items[0].name
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// name = orders[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delim</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// children = items[0].name
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#8f5902;font-style:italic>// orders[0]
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>indexedName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;[&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// order
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delim</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 是否有children表达式继续迭代
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 分解出的 . 分隔符的 children 表达式可以继续迭代
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyTokenizer</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>PropertyNamer 可以根据 getter/setter 规范解析字段名称；PropertyCopier 则支持对有相同父类的对象，通过反射拷贝字段值。</p>
<h2 id=封装类信息>封装类信息</h2>
<p>MetaClass 类依赖 PropertyTokenizer 和 Reflector 查找表达式是否可以匹配 Java 对象中的字段，以及对应字段是否有 getter/setter 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 验证传入的表达式，是否存在指定的字段
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param name
</span><span style=color:#8f5902;font-style:italic> * @param builder
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>buildProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 映射文件表达式迭代器
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 复杂表达式，如name = items[0].name，则prop.getName() = items
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findPropertyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// items.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 加载内嵌字段类型对应的MetaClass
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>MetaClass</span> <span style=color:#000>metaProp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaClassForProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 迭代子字段
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>metaProp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 非复杂表达式，获取字段名，如：userid-&gt;userId
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findPropertyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=包装字段对象>包装字段对象</h2>
<p>相对于 MetaClass 关注类信息，MetalObject 关注的是对象的信息，除了保存传入的对象本身，还会为对象指定一个 ObjectWrapper 将对象包装起来。ObejctWrapper 体系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211006000300.png style=display:block;width:70% alt=NAME align=center> </div>
<p>ObjectWrapper 的默认实现包括了对 Map、Collection 和普通 JavaBean 的包装。MyBatis 还支持通过 ObjectWrapperFactory 接口对 ObejctWrapper 进行扩展，生成自定义的包装类。MetaObject 对对象的具体操作，就委托给真正的 ObjectWrapper 处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span> <span style=color:#000>objectFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectWrapperFactory</span> <span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReflectorFactory</span> <span style=color:#000>reflectorFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>originalObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>objectFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapperFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflectorFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectorFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>// 根据传入object类型不同，指定不同的wrapper
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ObjectWrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectWrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasWrapperFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrapperFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CollectionWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>例如赋值操作，BeanWrapper 的实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 当前表达式是集合，如：items[0]，就需要获取items集合对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>collection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 在集合的指定索引上赋值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setCollectionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析完成，通过Invoker接口做赋值操作
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setBeanProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>resolveCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 在对象信息中查到此字段对应的集合对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>根据 PropertyTokenizer 对象解析出的当前字段是否存在 index 索引来判断字段是否为集合。如果当前字段对应集合，则需要在对象信息中查到此字段对应的集合对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 如果表达式仍可迭代，递归寻找字段对应的对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MetaObject</span> <span style=color:#000>metaValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaObjectForProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndexedName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metaValue</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SystemMetaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NULL_META_OBJECT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaValue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 字段解析完成
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>objectWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果字段是简单类型，BeanWrapper 获取字段对应的对象逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 集合类型，递归获取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>collection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getCollectionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 解析完成，反射读取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBeanProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，仍然是会判断表达式是否迭代完成，如果未解析完字段会不断递归，直至找到对应的类型。前面说到 Reflector 创建过程中将对字段的读取和赋值操作通过 Invoke 接口抽象出来，针对最终获取的字段，此时就会调用 Invoke 接口对字段反射读取对象值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 通过Invoker接口反射执行读取操作
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param prop
</span><span style=color:#8f5902;font-style:italic> * @param object
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>getBeanProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Invoker</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_ARGUMENTS</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not get property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对象读取完毕再通过 setCollectionValue 方法对集合指定索引进行赋值或通过 setBeanProperty 方法对简单类型反射赋值。MapWrapper 的操作与 BeanWrapper 大致相同，CollectionWrapper 相对更会简单，只支持对原始集合对象进行添加操作。</p>
<h2 id=总结>总结</h2>
<p>MyBatis 根据自身需求，对反射 API 做了近一步封装。其目的是简化反射操作，为对象字段的读取和赋值提供更好的性能。</p>
<ul>
<li>org.apache.ibatis.reflection.Reflector：缓存类的字段名和 getter/setter 方法的元信息，使得反射时有更好的性能。</li>
<li>org.apache.ibatis.reflection.invoker.Invoker：用于抽象设置和读取字段值的操作。</li>
<li>org.apache.ibatis.reflection.TypeParameterResolver：针对 Java-Type 体系的多种实现，解析指定类中的字段、方法返回值或方法参数的类型。</li>
<li>org.apache.ibatis.reflection.ReflectorFactory：反射信息创建工厂抽象接口。</li>
<li>org.apache.ibatis.reflection.DefaultReflectorFactory：默认的反射信息创建工厂。</li>
<li>org.apache.ibatis.reflection.factory.ObjectFactory：MyBatis 对象创建工厂，其默认实现 DefaultObjectFactory 通过构造器反射创建对象。</li>
<li>org.apache.ibatis.reflection.property：property 工具包，针对映射文件表达式进行解析和 Java 对象的反射赋值。</li>
<li>org.apache.ibatis.reflection.MetaClass：依赖 PropertyTokenizer 和 Reflector 查找表达式是否可以匹配 Java 对象中的字段，以及对应字段是否有 getter/setter 方法。</li>
<li>org.apache.ibatis.reflection.MetaObject：对原始对象进行封装，将对象操作委托给 ObjectWrapper 处理。</li>
<li>org.apache.ibatis.reflection.wrapper.ObjectWrapper：对象包装类，封装对象的读取和赋值等操作。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-499db58c0f961451e8ac888520e1c5fa>4.3 - CH03-基础支持模块</h1>
<h2 id=类型转换>类型转换</h2>
<p>JDBC 规范定义的数据类型与 Java 数据类型并不是完全对应的，所以在 PrepareStatement 为 SQL 语句绑定参数时，需要从 Java 类型转为 JDBC 类型；而从结果集中获取数据时，则需要将 JDBC 类型转为 Java 类型。</p>
<h3 id=类型转换操作>类型转换操作</h3>
<p>MyBatis 中的所有类型转换器都继承自 BaseTypeHandler 抽象类，此类实现了 TypeHandler 接口。接口中定义了 1 个向 PreparedStatement 对象中设置参数的方法和 3 个从结果集中取值的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 为PreparedStatement对象设置参数
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param ps SQL 预编译对象
</span><span style=color:#8f5902;font-style:italic>     * @param i 参数索引
</span><span style=color:#8f5902;font-style:italic>     * @param parameter 参数值
</span><span style=color:#8f5902;font-style:italic>     * @param jdbcType 参数 JDBC类型
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据列名从结果集中取值
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param rs 结果集
</span><span style=color:#8f5902;font-style:italic>     * @param columnName 列名
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>columnName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据索引从结果集中取值
</span><span style=color:#8f5902;font-style:italic>     * @param rs 结果集
</span><span style=color:#8f5902;font-style:italic>     * @param columnIndex 索引
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据索引从存储过程函数中取值
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param cs 存储过程对象
</span><span style=color:#8f5902;font-style:italic>     * @param columnIndex 索引
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CallableStatement</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=basetypehandler-及其实现>BaseTypeHandler 及其实现</h3>
<p>BaseTypeHandler 实现了 TypeHandler 接口，针对 null 和异常处理做了封装，但是具体逻辑封装成 4 个抽象方法仍交由相应的类型转换器子类实现，以 IntegerTypeHandler 为例，其实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IntegerTypeHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseTypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNonNullParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>getNullableResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>columnName</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>columnName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 如果列值为空值返回控制否则返回原值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasNull</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>getNullableResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasNull</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>getNullableResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CallableStatement</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasNull</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其实现主要是调用 JDBC API 设置查询参数或取值，并对 null 等特定情况做特殊处理。</p>
<h3 id=类型转换注册器>类型转换注册器</h3>
<p>TypeHandlerRegistry 是 TypeHandler 的注册类，在其无参构造方法中维护了 JavaType、JdbcType 和 TypeHandler 的关系。其主要使用的容器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * JdbcType - TypeHandler对象
</span><span style=color:#8f5902;font-style:italic>   * 用于将Jdbc类型转为Java类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span>  <span style=color:#000>jdbcTypeHandlerMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EnumMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * JavaType - JdbcType - TypeHandler对象
</span><span style=color:#8f5902;font-style:italic>   * 用于将Java类型转为指定的Jdbc类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>typeHandlerMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * TypeHandler类型 - TypeHandler对象
</span><span style=color:#8f5902;font-style:italic>   * 注册所有的TypeHandler类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>allTypeHandlersMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</code></pre></div><h2 id=别名注册>别名注册</h2>
<h3 id=别名转换器注册>别名转换器注册</h3>
<p>TypeAliasRegistry 提供了多种方式用于为 Java 类型注册别名。包括直接指定别名、注解指定别名、为指定包下类型注册别名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下所有类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下指定类型的别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   * @param superType
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>resolverUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 找出该包下superType所有的子类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IsA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>typeSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClasses</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>typeSet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Ignore inner classes and interfaces (including package-info.java)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// Skip also inner classes. See issue #6
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMemberClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名，默认为简单类名，优先从Alias注解获取
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param type
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 从Alias注解读取别名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Alias</span> <span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliasAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param alias 别名
</span><span style=color:#8f5902;font-style:italic>   * @param value 类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The parameter alias cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// issue #748
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toLowerCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The alias &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is already mapped to the value &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名
</span><span style=color:#8f5902;font-style:italic>   * @param alias 别名
</span><span style=color:#8f5902;font-style:italic>   * @param value 指定类型全名
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error registering type alias &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所有别名均注册到名为 typeAliases 的容器中。TypeAliasRegistry 的无参构造方法默认为一些常用类型注册了别名，如 Integer、String、byte[] 等。</p>
<h2 id=日志配置>日志配置</h2>
<p>MyBatis 支持与多种日志工具集成，包括 Slf4j、log4j、log4j2、commons-logging 等。这些第三方工具类对应日志的实现各有不同，MyBatis 通过适配器模式抽象了这些第三方工具的集成过程，按照一定的优先级选择具体的日志工具，并将真正的日志实现委托给选择的日志工具。</p>
<h3 id=日志适配接口>日志适配接口</h3>
<p>Log 接口是 MyBatis 的日志适配接口，支持 trace、debug、warn、error 四种级别。</p>
<h3 id=日志工厂>日志工厂</h3>
<p>LogFactory 负责对第三方日志工具进行适配，在类加载时会通过静态代码块按顺序选择合适的日志实现。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 按顺序加载日志实现，如果有某个第三方日志实现可以成功加载，则不继续加载其它实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useSlf4jLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useCommonsLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useLog4J2Logging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useLog4JLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useJdkLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useNoLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 初始化 logConstructor
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param runnable
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logConstructor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 同步执行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 配置第三方日志实现适配器
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param implClass
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>implClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>implClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>Log</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Logging initialized using &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>implClass</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; adapter.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>logConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LogException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error setting Log implementation.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>tryImplementation 按顺序加载第三方日志工具的适配实现，如 Slf4j 的适配器 Slf4jImpl：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Slf4jImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>LocationAwareLogger</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// check for slf4j &gt;= 1.6 method signature
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;log&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Marker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Slf4jLocationAwareLoggerImpl</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>LocationAwareLogger</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SecurityException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>NoSuchMethodException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// fail-back to Slf4jLoggerImpl
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// Logger is not LocationAwareLogger or slf4j version &lt; 1.6
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Slf4jLoggerImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果 Slf4jImpl 能成功执行构造方法，则 LogFactory 的 logConstructor 被成功赋值，MyBatis 就找到了合适的日志实现，可以通过 getLog 方法获取 Log 对象。</p>
<h3 id=jdbc-日志代理>JDBC 日志代理</h3>
<p>org.apache.ibatis.logging.jdbc 包提供了 Connection、PrepareStatement、Statement、ResultSet 类中的相关方法执行的日志记录代理。BaseJdbcLogger 在创建时整理了 PreparedStatement 执行的相关方法名，并提供容器保存列值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * PreparedStatement 接口中的 set* 方法名称集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>SET_METHODS</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * PreparedStatement 接口中的 部分执行方法
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>EXECUTE_METHODS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 列名-列值
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>columnMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 列名集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>columnNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 列值集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>columnValues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SET_METHODS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredMethods</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collectors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toSet</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execute&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executeUpdate&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executeQuery&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;addBatch&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setColumn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>columnMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>columnNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>columnValues</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ConnectionLogger、PreparedStatementLogger、StatementLogger、ResultSetLogger 都继承自 BaseJdbcLogger，并实现了 InvocationHandler 接口，在运行时通过 JDK 动态代理实现代理类，针对相关方法执行打印日志。如下是 ConnectionLogger 对 InvocationHandler 接口的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;prepareStatement&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; Preparing: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>removeBreakingWhitespace</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>PreparedStatement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 执行创建PreparedStatement方法，使用PreparedStatementLogger代理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PreparedStatementLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;prepareCall&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; Preparing: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>removeBreakingWhitespace</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>PreparedStatement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PreparedStatementLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;createStatement&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果执行 prepareStatement 方法创建 PrepareStatement 对象，则会使用动态代理创建 PreparedStatementLogger 对象增强原有对象。在 PreparedStatementLogger 的代理逻辑中，如果执行的是 executeQuery 或 getResultSet 方法，其返回值 ResultSet 也会包装为 ResultSetLogger 作为代理，其代理逻辑为如果执行 ResultSet 的 next 方法，会打印结果集的行。</p>
<h2 id=资源加载>资源加载</h2>
<h3 id=resources-与-classloaderwrapper>Resources 与 ClassLoaderWrapper</h3>
<p>MyBatis 提供工具类 Resources 用于工具加载，其底层是通过 ClassLoaderWrapper 实现的。ClassLoaderWrapper 组合了一系列的 ClassLoader：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getClassLoaders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>[]{</span>
            <span style=color:#8f5902;font-style:italic>// 指定 ClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#8f5902;font-style:italic>// 默认 ClassLoader，默认为 null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>defaultClassLoader</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#8f5902;font-style:italic>// 当前线程对应的 ClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getContextClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#8f5902;font-style:italic>// 当前类对应的 ClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#8f5902;font-style:italic>// 默认为 SystemClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>systemClassLoader</span><span style=color:#ce5c00;font-weight:700>};</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当加载资源时会按组合的 ClassLoader 顺序依次尝试加载资源，例如 classForName 方法的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 按组合顺序依次加载
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 类加载
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// we&#39;ll ignore this until all classloaders fail to locate the class
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassNotFoundException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cannot find class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=加载指定包下的类>加载指定包下的类</h3>
<p>ResolverUtil 的 find 方法用于按条件加载指定包下的类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 包名.替换为/
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>String</span> <span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getPackagePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 虚拟文件系统加载文件路径
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>VFS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.class&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果指定class文件符合条件，加入容器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>addIfMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ioe</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not read package: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ioe</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ResolverUtil 还提供了一个内部接口 Test 用于判断指定类型是否满足条件，在 ResolverUtil 有两个默认实现：IsA 用于判断是否为指定类型的子类；AnnotatedWith 用于判断类上是否有指定注解。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * A Test that checks to see if each class is assignable to the provided class. Note
</span><span style=color:#8f5902;font-style:italic>   * that this test will match the parent type itself if it is presented for matching.
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * 判断是否为子类
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IsA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/** Constructs an IsA test using the supplied Class as the parent class/interface. */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>IsA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parentType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/** Returns true if type is assignable to the parent type supplied in the constructor. */</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * A Test that checks to see if each class is annotated with a specific annotation. If it
</span><span style=color:#8f5902;font-style:italic>   * is, then the test returns true, otherwise false.
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * 判断类上是否有指定注解
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotatedWith</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/** Constructs an AnnotatedWith test for the specified annotation type. */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotatedWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/** Returns true if the type is annotated with the class provided to the constructor. */</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotationPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果要加载的类复合条件，则将加载的类对象加入容器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addIfMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>fqn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>externalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fqn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fqn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Checking to see if class &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>externalName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; matches criteria [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>test</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 加载类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>externalName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 符合条件，加入容器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not examine class &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>fqn</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; due to a &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
        <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; with message: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=数据源实现>数据源实现</h2>
<p>MyBatis 提供了自己的数据源实现，分别为非池化数据源 UnpooledDataSource 和池化数据源 PooledDataSource。两个数据源都实现了 javax.sql.DataSource 接口并分别由 UnpooledDataSourceFactory 和 PooledDataSourceFactory 工厂类创建。两个工厂类又都实现了 DataSourceFactory 接口。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211007160038.png style=display:block;width:70% alt=NAME align=center> </div>
<h3 id=datasourcefactory-实现>DataSourceFactory 实现</h3>
<p>UnpooledDataSourceFactory 实现了 DataSourceFactory 接口的 setProperties 和 getDataSource 方法，分别用于在创建数据源工厂后配置数据源属性和获取数据源，PooledDataSourceFactory 继承了其实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UnpooledDataSourceFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnpooledDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 创建数据源工厂后配置数据源属性
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param props
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Properties</span> <span style=color:#000>driverProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 数据源对象信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MetaObject</span> <span style=color:#000>metaDataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SystemMetaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DRIVER_PROPERTY_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 数据源驱动相关属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>driverProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DRIVER_PROPERTY_PREFIX_LENGTH</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSetter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 属性在数据源类中有相应的set方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 转换类型
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>convertedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>convertValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 反射赋值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataSourceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown DataSource property: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driverProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;driverProperties&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>driverProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取数据源
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>getDataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=非池化数据源>非池化数据源</h3>
<p>UnpooledDataSource 在静态语句块中从数据源驱动管理器 DriverManager 获取所有已注册驱动并放入本地容器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从数据库驱动类中获取所有驱动
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Enumeration</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDrivers</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreElements</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Driver</span> <span style=color:#000>driver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextElement</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>registeredDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此数据源获取连接的实现为调用 doGetConnection 方法，每次获取连接时先校验当前驱动是否注册，如果已注册则直接创建新连接，并配置自动提交属性和默认事务隔离级别：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取连接
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param properties
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Connection</span> <span style=color:#000>doGetConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 校验当前驱动是否注册，如果未注册，加载驱动并注册
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>initializeDriver</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 获取数据库连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 配置自动提交和默认事务隔离级别属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>configureConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 校验当前驱动是否注册
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initializeDriver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registeredDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 当前驱动还未注册
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>driverType</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 加载驱动类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driverClassLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>driverType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>driverClassLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>driverType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// DriverManager requires the driver to be loaded via the system ClassLoader.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// http://www.kfu.com/~nsayer/Java/dyn-jdbc.html
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Driver</span> <span style=color:#000>driverInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>driverType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 注册驱动
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerDriver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DriverProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driverInstance</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>registeredDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>driverInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error setting driver on UnpooledDataSource. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 配置自动提交和默认事务隔离级别属性
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param conn
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>configureConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAutoCommit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultTransactionIsolationLevel</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTransactionIsolation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultTransactionIsolationLevel</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=池化数据源>池化数据源</h3>
<p>数据库连接的创建是十分耗时的，在高并发环境下，频繁地创建和关闭连接会为系统带来很大的开销。而使用连接池实现对数据库连接的重用可以显著提高性能，避免反复创建连接。MyBatis 实现的连接池包含了维护连接队列、创建和保存连接、归还连接等功能。</p>
<h4 id=池化连接>池化连接</h4>
<p>PooledConnection 是 MyBatis 的池化连接实现。其构造方法中传入了驱动管理器创建的真正连接，并通过 JDK 动态代理创建了连接的代理对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PooledDataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 真正的数据库连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>realConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 数据源对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 连接创建时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createdTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 连接上次使用时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastUsedTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 数据源有效标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 创建连接代理
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proxyConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>IFACES</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>连接代理的逻辑如下，如果执行 close 方法，并不会真正的关闭连接，而是当作空闲连接交给数据源处理，根据连接池的状态选择将连接放入空闲队列或关闭连接；如果执行其它方法，则会判断当前连接是否有效，如果是无效连接会抛出异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLOSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>CLOSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 调用连接关闭方法代理逻辑：处理空闲连接，放入空闲队列或关闭
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pushConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// issue #579 toString() should never fail
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// throw an SQLException instead of a Runtime
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 执行其它方法，验证连接是否有效，如果是无效连接，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>realConnection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=连接池状态>连接池状态</h4>
<p>PoolState 维护了数据库连接池状态。其内部维护了两个容器，分别为空闲连接集合和活跃连接集合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 空闲连接集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>idleConnections</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 活跃连接集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>activeConnections</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</code></pre></div><h4 id=获取连接>获取连接</h4>
<p>池化数据源 PooledDataSource 是依赖 UnpooledDataSource 实现的。其获取连接的方式是调用 popConnection 方法。在获取连接池同步锁后按照以下顺序尝试获取可用连接：</p>
<ul>
<li>从空闲队列获取连接</li>
<li>活跃连接池未满，创建新连接</li>
<li>检查最早的活跃连接是否超时</li>
<li>等待释放连接</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PooledConnection</span> <span style=color:#000>popConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 等待连接标志
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>countedWait</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#8f5902;font-style:italic>// 待获取的池化连接
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>localBadConnectionCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 循环获取连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取连接池的同步锁
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Pool has available connection 连接池中有空闲连接
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Checked out connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; from pool.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Pool does not have available connection 连接池无可用连接
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>poolMaximumActiveConnections</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// Can create new connection 活跃连接数小于设定的最大连接数，创建新的连接（从驱动管理器创建新的连接）
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Created connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// Cannot create new connection 活跃连接数到达最大连接数
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>oldestActiveConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 查询最早入队的活跃连接使用时间（即使用时间最长的活跃连接使用时间）
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>longestCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCheckoutTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>longestCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>poolMaximumCheckoutTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Can claim overdue connection 超出活跃连接最大使用时间
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>claimedOverdueConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
            <span style=color:#8f5902;font-style:italic>// 超时连接累计使用时长
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTimeOfOverdueConnections</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>longestCheckoutTime</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>longestCheckoutTime</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 活跃连接队列移除当前连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 创建的连接未自动提交，执行回滚
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
              <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                   Just log a message for debug and continue to execute the following
</span><span style=color:#8f5902;font-style:italic>                   statement like nothing happened.
</span><span style=color:#8f5902;font-style:italic>                   Wrap the bad connection with a new PooledConnection, this will help
</span><span style=color:#8f5902;font-style:italic>                   to not interrupt current executing thread and give current thread a
</span><span style=color:#8f5902;font-style:italic>                   chance to join the next competition for another valid/good database
</span><span style=color:#8f5902;font-style:italic>                   connection. At the end of this loop, bad {@link @conn} will be set as null.
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bad connection. Could not roll back&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 包装新的池化连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 设置原连接无效
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Claimed overdue connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Must wait
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// 存活连接有效
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>countedWait</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hadToWaitCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
                <span style=color:#000>countedWait</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Waiting as long as &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>poolTimeToWait</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; milliseconds for connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
              <span style=color:#8f5902;font-style:italic>// 释放锁等待连接，{@link PooledDataSource#pushConnection} 如果有连接空闲，会唤醒等待
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolTimeToWait</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#8f5902;font-style:italic>// 记录等待时长
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedWaitTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ping to server and check the connection is valid or not
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isValid</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 连接有效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 非自动提交的连接，回滚上次任务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assembleConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#8f5902;font-style:italic>// 设置连接新的使用时间
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCheckoutTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#8f5902;font-style:italic>// 添加到活跃连接集合队尾
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 连接请求次数+1
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
          <span style=color:#8f5902;font-style:italic>// 请求连接花费的时间
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedRequestTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 未获取到连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A bad connection (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) was returned from the pool, getting another connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 因为没有空闲连接导致获取连接失败次数+1
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>badConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
          <span style=color:#8f5902;font-style:italic>// 本次请求获取连接失败数+1
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>localBadConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
          <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>localBadConnectionCount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolMaximumIdleConnections</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>poolMaximumLocalBadConnectionTolerance</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 超出获取连接失败的可容忍次数，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Could not get a good connection to the database.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Could not get a good connection to the database.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果暂时获取不到可用连接，则当前线程进入等待，等待新的空闲连接产生唤醒等待或等待超时后重新尝试获取连接。当尝试次数到达指定上限，会抛出异常跳出等待。</p>
<h4 id=判断连接有效性>判断连接有效性</h4>
<p>如果可以从连接池中获取连接，会调用 PooledConnection#isValid 方法判断连接是否有效，其逻辑为 PooledConnection 对象自身维护的标志有效且连接存活。判断连接存活的实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>pingConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 连接是否关闭
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isClosed</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is BAD: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolPingEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用语句检测连接是否可用开关开启
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolPingConnectionsNotUsedFor</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeElapsedSinceLastUse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>poolPingConnectionsNotUsedFor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 距上次连接使用经历时长超过设置的阈值
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Testing connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; ...&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 验证连接是否可用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Connection</span> <span style=color:#000>realConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStatement</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolPingQuery</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// 未自动提交执行回滚
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is GOOD!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Execution of ping query &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>poolPingQuery</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; failed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// 抛出异常，连接不可用，关闭连接
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>//ignore
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is BAD: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>默认调用 Connection#isClosed 方法判断连接是否存活，如果连接存活，则可以选择执行 SQL 语句来进一步判断连接的有效性。是否进一步验证、验证使用的 SQL 语句、验证的时间条件，都是可配置的。</p>
<h4 id=处理空闲连接>处理空闲连接</h4>
<p>在池化连接的代理连接执行关闭操作时，会转为对空闲连接的处理，其实现逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pushConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取连接池状态同步锁，活跃连接队列移除当前连接
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isValid</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 连接有效
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>poolMaximumIdleConnections</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>expectedConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 空闲连接数小于最大空闲连接数，累计连接使用时长
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCheckoutTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未自动提交连接回滚上次事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 包装成新的代理连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>newConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 将新连接放入空闲队列
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 设置相关统计时间戳
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#8f5902;font-style:italic>// 老连接设置失效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returned connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; to pool.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 唤醒等待连接的线程，通知有新连接可以使用
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 空闲连接数达到最大空闲连接数
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCheckoutTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未自动提交连接回滚上次事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 关闭多余的连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Closed connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 连接设置失效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A bad connection (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) attempted to return to the pool, discarding connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 连接无效次数+1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>badConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果当前空闲连接数小于最大空闲连接数，则将空闲连接放入空闲队列，否则关闭连接。</p>
<h4 id=处理配置变更>处理配置变更</h4>
<p>在相关配置变更后，MyBatis 会调用 forceCloseAll 关闭连接池中所有存活的连接：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forceCloseAll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取连接池状态同步锁
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>expectedConnectionTypeCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>assembleConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPassword</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 移除活跃连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 原连接置为无效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>

          <span style=color:#000>Connection</span> <span style=color:#000>realConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未提交连接回滚当前事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 关闭连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 移除空闲连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 原连接置为无效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>

          <span style=color:#000>Connection</span> <span style=color:#000>realConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未提交连接回滚当前事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 关闭连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource forcefully closed/removed all connections.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=缓存实现>缓存实现</h2>
<p>Cache 是 MyBatis 的缓存抽象接口，其要求实现如下方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Cache</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 缓存对象 id
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return The identifier of this cache
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 设置缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param key Can be any object but usually it is a {@link CacheKey}
</span><span style=color:#8f5902;font-style:italic>     * @param value The result of a select.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 获取缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param key The key
</span><span style=color:#8f5902;font-style:italic>     * @return The object stored in the cache.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 移除缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param key The key
</span><span style=color:#8f5902;font-style:italic>     * @return Not used
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 清空缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * Clears this cache instance.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Optional. This method is not called by the core.
</span><span style=color:#8f5902;font-style:italic>     * 获取缓存项数量
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return The number of elements stored in the cache (not its capacity).
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getSize</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 获取读写锁
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return A ReadWriteLock
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>ReadWriteLock</span> <span style=color:#000>getReadWriteLock</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=基础实现>基础实现</h3>
<p>PerpetualCache 类是基础实现类，核心是基于 HashMap 作为缓存维护容器。在此基础上，MyBatis 实现了多种缓存装饰器，用于满足不同的需求。</p>
<h3 id=缓存装饰器>缓存装饰器</h3>
<h4 id=同步操作>同步操作</h4>
<p>SynchronizedCache 针对缓存操作方法加上了 synchronized 关键字用于进行同步操作。</p>
<h4 id=阻塞操作>阻塞操作</h4>
<p>BlockingCache 在执行获取缓存操作时对 key 加锁，直到写缓存后释放锁，保证了相同 key 同一时刻只有一个线程执行数据库操作，其它线程在缓存层阻塞。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 写缓存完成后释放锁
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>acquireLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 缓存不为空则释放锁，否则继续持有锁，在进行数据库操作后写缓存释放锁
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 删除指定 key 对应的缓存，并释放锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key The key
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// despite of its name, this method is called only to release locks
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取已有的锁或创建新锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>getLockForKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>locks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据 key 获取锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>acquireLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Lock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getLockForKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>acquired</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>acquired</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Couldn&#39;t get a lock in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; for the key &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>  <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; at the cache &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Got interrupted while trying to acquire lock for key &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 释放锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>locks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isHeldByCurrentThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=日志记录>日志记录</h4>
<p>LoggingCache 是缓存日志装饰器。查询缓存时会记录查询日志并统计命中率。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 查询缓存时记录查询日志并统计命中率
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param key The key
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 查询数+1
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>requests</span><span style=color:#ce5c00;font-weight:700>++;</span>
  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 命中数+1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>hits</span><span style=color:#ce5c00;font-weight:700>++;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cache Hit Ratio [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getHitRatio</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=定时清理>定时清理</h4>
<p>ScheduledCache 是缓存定时清理装饰器。在执行缓存相关操作时会根据设置的时间间隔判断是否需要清除全部的缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 操作缓存时判断是否需要清除所有缓存。
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>clearWhenStale</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>lastClear</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clearInterval</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=序列化与反序列化>序列化与反序列化</h4>
<p>SerializedCache 是缓存序列化装饰器，其在写入时会将值序列化成对象流，并在读取时进行反序列化。</p>
<h4 id=事务操作>事务操作</h4>
<p>TransactionalCache 是事务缓存装饰器。在事务提交后再将缓存写入，如果发生回滚则不写入。</p>
<h4 id=先进先出>先进先出</h4>
<p>FifoCache 是先进先出缓存装饰器。其按写缓存顺序维护了一个缓存 key 队列，如果缓存项超出指定大小，则删除最先入队的缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 按写缓存顺序维护缓存 key 队列，缓存项超出指定大小，删除最先入队的缓存
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param key
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cycleKeyList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>keyList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>oldestKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeFirst</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestKey</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=最近最久未使用>最近最久未使用</h4>
<p>LruCache 是缓存最近最久未使用装饰器。其基于 LinkedHashMap 维护了 key 的 LRU 顺序。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// LinkedHashMap 在执行 get 方法后会将对应的 entry 移到队尾来维护使用顺序
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>keyMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>75F</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4267176411845948333L</span><span style=color:#ce5c00;font-weight:700>;</span>

      <span style=color:#5c35cc;font-weight:700>@Override</span>
      <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removeEldestEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>eldest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tooBig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tooBig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 超出缓存项数量限制，获取最近最久未使用的key
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>eldestKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>eldest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tooBig</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>};</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 更新缓存后检查是否需要删除最近最久未使用的缓存项
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>cycleKeyList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cycleKeyList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>keyMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eldestKey</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eldestKey</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>eldestKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=软引用缓存>软引用缓存</h4>
<p>SoftCache 是缓存软引用装饰器，其使用了软引用 + 强引用队列的方式维护缓存。在写缓存操作中，写入的数据其实时缓存项的软引用包装对象，在 Full GC 时，如果没有一个强引用指向被包装的缓存项或缓存值，并且系统内存不足，缓存项就会被 GC，被回收对象进入指定的引用队列。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 引用队列，用于记录已经被 GC 的 SoftEntry 对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReferenceQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queueOfGarbageCollectedEntries</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 写入缓存。
</span><span style=color:#8f5902;font-style:italic>   * 不直接写缓存的值，而是写入缓存项对应的软引用
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>removeGarbageCollectedItems</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 在 Full GC 时，如果没有一个强引用指向被包装的缓存项或缓存值，并且系统内存不足，缓存项就会被回收，被回收对象进入指定的引用队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SoftEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueOfGarbageCollectedEntries</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询已被 GC 的软引用，删除对应的缓存项
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeGarbageCollectedItems</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SoftEntry</span> <span style=color:#000>sv</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SoftEntry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>queueOfGarbageCollectedEntries</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 封装软引用对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SoftEntry</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>SoftEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReferenceQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>garbageCollectionQueue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 声明 value 为软引用对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>garbageCollectionQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// key 为强引用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在读取缓存时，如果软引用被回收，则删除对应的缓存项；否则将缓存项放入一个强引用队列中，该队列会将最新读取的缓存项放入队首，使得真正的缓存项有了强引用指向，其软引用包装就不会被垃圾回收。队列有数量限制，当超出限制时会删除队尾的缓存项。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取缓存。
</span><span style=color:#8f5902;font-style:italic>   * 如果软引用被回收则删除对应的缓存项，如果未回收则加入到有数量限制的 LRU 队列中
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key The key
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// assumed delegate cache is totally managed by this cache
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>softReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>softReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>softReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 软引用已经被回收，删除对应的缓存项
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果未被回收，增将软引用加入到 LRU 队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// See #586 (and #335) modifications need more than a read lock
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 将对应的软引用
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>numberOfHardLinks</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 超出数量限制，删除最近最久未使用的软引用对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeLast</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=弱引用缓存>弱引用缓存</h4>
<p>WeakCache 是缓存弱引用装饰器，使用弱引用 + 强引用队列的方式维护缓存，其实现方式与 SoftCache 是一致的。</p>
<h2 id=binding-模块>Binding 模块</h2>
<p>为了避免因拼写等错误导致在运行期才发现执行方法找不到对应的 SQL 语句，MyBatis 使用 Binding 模块在启动时对执行方法校验，如果找不到对应的语句，则会抛出 BindingException。</p>
<p>MyBatis 一般将执行数据库操作的方法所在的接口称为 Mapper，MapperRegistry 用来注册 Mapper 接口类型与其代理创建工厂的映射，其提供 addMapper 和 addMappers 接口用于注册。Mapper 接口代理工厂是通过 MapperProxyFactory 创建，创建过程依赖 MapperProxy 提供的 JDK 动态代理：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapperProxy</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapperProxy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>mapperInterface</span> <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>mapperProxy</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 使用 Mapper 代理封装 SqlSession 相关操作
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param sqlSession
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MapperProxy</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapperProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperProxy</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodCache</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperProxy</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>MapperProxy 的代理逻辑如下，在 Mapper 接口中的方法真正执行时，会为指定的非 default 方法创建方法信息和 SQL 执行信息缓存：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Object中的方法，直接执行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDefaultMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 当前方法是接口中的非abstract、非static的public方法，即高版本JDK中的default方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokeDefaultMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 缓存 Mapper接口 对应的方法和 SQL 执行信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MapperMethod</span> <span style=color:#000>mapperMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedMapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 执行 SQL
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mapperMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存 Mapper接口 对应的方法和 SQL 执行信息
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param method
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MapperMethod</span> <span style=color:#000>cachedMapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>methodCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>()));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>缓存通过 MapperMethod 类来保存，其构造方法创建了 SqlCommand 和 MethodSignature 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Configuration</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// SQL 执行信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlCommand</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取方法参数和返回值相关信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodSignature</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>SqlCommand 会根据接口和方法名找到对应的 SQL statement 对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MappedStatement</span> <span style=color:#000>resolveMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// statementId 为接口名与方法名组合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>statementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 配置中存在此 statementId，返回对应的 statement
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementId</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 此方法就是在对应接口中声明的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 递归查找父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>superInterface</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInterfaces</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superInterface</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                    <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>而 MethodSignature 会获取方法相关信息，如返回值类型、是否返回 void、是否返回多值等。对于 Param 注解的解析也会保存下来（MyBatis 使用 Param 注解重置参数名）。</p>
<h2 id=总结>总结</h2>
<p>MyBatis 提供了一系列工具和实现，用于为整个框架提供基础支持。</p>
<ul>
<li>类型转换
<ul>
<li>org.apache.ibatis.type.TypeHandler：类型转换器接口，抽象 JDBC 类型和 Java 类型互转逻辑。</li>
<li>org.apache.ibatis.type.BaseTypeHandler：TypeHandler 的抽象实现，针对 null 和异常处理做了封装，具体逻辑仍由相应的类型转换器实现。</li>
<li>org.apache.ibatis.type.TypeHandlerRegistry：TypeHandler 注册类，维护 JavaType、JdbcType 和 TypeHandler 关系。</li>
</ul>
</li>
<li>别名注册
<ul>
<li>org.apache.ibatis.type.TypeAliasRegistry：别名注册类。注册常用类型的别名，并提供多种注册别名的方式。</li>
</ul>
</li>
<li>日志配置
<ul>
<li>org.apache.ibatis.logging.Log：MyBatis 日志适配接口，支持 trace、debug、warn、error 四种级别。</li>
<li>org.apache.ibatis.logging.LogFactory：MyBatis 日志工厂，负责适配第三方日志实现。</li>
<li>org.apache.ibatis.logging.jdbc：SQL 执行日志工具包，针对执行 Connection、PrepareStatement、Statement、ResultSet 类中的相关方法，提供日志记录工具。</li>
</ul>
</li>
<li>资源加载
<ul>
<li>org.apache.ibatis.io.Resources：MyBatis 封装的资源加载工具类。</li>
<li>org.apache.ibatis.io.ClassLoaderWrapper：资源加载底层实现。组合多种 ClassLoader 按顺序尝试加载资源。</li>
<li>org.apache.ibatis.io.ResolverUtil：按条件加载指定包下的类。</li>
</ul>
</li>
<li>数据源实现
<ul>
<li>org.apache.ibatis.datasource.DataSourceFactory：数据源创建工厂接口。</li>
<li>org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory：非池化数据源工厂。</li>
<li>org.apache.ibatis.datasource.pooled.PooledDataSourceFactory：池化数据源工厂。</li>
<li>org.apache.ibatis.datasource.unpooled.UnpooledDataSource：非池化数据源。</li>
<li>org.apache.ibatis.datasource.pooled.PooledDataSource：池化数据源。</li>
<li>org.apache.ibatis.datasource.pooled.PooledConnection：池化连接。</li>
<li>org.apache.ibatis.datasource.pooled.PoolState：连接池状态。</li>
</ul>
</li>
<li>事务实现
<ul>
<li>org.apache.ibatis.transaction.Transaction：事务抽象接口</li>
<li>org.apache.ibatis.session.TransactionIsolationLevel：事务隔离级别。</li>
<li>org.apache.ibatis.transaction.TransactionFactory：事务创建工厂抽象接口。</li>
<li>org.apache.ibatis.transaction.jdbc.JdbcTransaction：封装 JDBC 数据库事务操作。</li>
<li>org.apache.ibatis.transaction.managed.ManagedTransaction：数据库事务操作依赖外部管理。</li>
</ul>
</li>
<li>缓存实现
<ul>
<li>org.apache.ibatis.cache.Cache：缓存抽象接口。</li>
<li>org.apache.ibatis.cache.impl.PerpetualCache：使用 HashMap 作为缓存实现容器的 Cache 基本实现。</li>
<li>org.apache.ibatis.cache.decorators.BlockingCache：缓存阻塞装饰器。保证相同 key 同一时刻只有一个线程执行数据库操作，其它线程在缓存层阻塞。</li>
<li>org.apache.ibatis.cache.decorators.FifoCache：缓存先进先出装饰器。按写缓存顺序维护缓存 key 队列，缓存项超出指定大小，删除最先入队的缓存。</li>
<li>org.apache.ibatis.cache.decorators.LruCache：缓存最近最久未使用装饰器。基于 LinkedHashMap 维护了 key 的 LRU 顺序。</li>
<li>org.apache.ibatis.cache.decorators.LoggingCache：缓存日志装饰器。查询缓存时记录查询日志并统计命中率。</li>
<li>org.apache.ibatis.cache.decorators.ScheduledCache：缓存定时清理装饰器。</li>
<li>org.apache.ibatis.cache.decorators.SerializedCache：缓存序列化装饰器。</li>
<li>org.apache.ibatis.cache.decorators.SynchronizedCache：缓存同步装饰器。在缓存操作方法上使用 synchronized 关键字同步。</li>
<li>org.apache.ibatis.cache.decorators.TransactionalCache：事务缓存装饰器。在事务提交后再将缓存写入，如果发生回滚则不写入。</li>
<li>org.apache.ibatis.cache.decorators.SoftCache：缓存软引用装饰器。使用软引用 + 强引用队列的方式维护缓存。</li>
<li>org.apache.ibatis.cache.decorators.WeakCache：缓存弱引用装饰器。使用弱引用 + 强引用队列的方式维护缓存。</li>
</ul>
</li>
<li>Binding
<ul>
<li>org.apache.ibatis.binding.MapperRegistry： Mapper 接口注册类，管理 Mapper 接口类型和其代理创建工厂的映射。</li>
<li>org.apache.ibatis.binding.MapperProxyFactory：Mapper 接口代理创建工厂。</li>
<li>org.apache.ibatis.binding.MapperProxy：Mapper 接口方法代理逻辑，封装 SqlSession 相关操作。</li>
<li>org.apache.ibatis.binding.MapperMethod：封装 Mapper 接口对应的方法和 SQL 执行信息。</li>
</ul>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5b7e738c6d50dab8aea897b0c9b16a6f>4.4 - CH04-运行配置解析</h1>
<p>在 Spring 与 MyBatis 的集成中，通常需要声明一个 sqlSessionFactory 用于初始化 MyBatis：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#8f5902;font-style:italic>&lt;!-- 注册 sqlSessionFactory --&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;sqlSessionFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.mybatis.spring.SqlSessionFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;configLocation&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;classpath:config/mybatis-config.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;typeAliasesPackage&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;com.wch.base.domain&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mapperLocations&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;classpath:mapper/*.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>在 bean 初始化的时候会调用 SqlSessionFactoryBean 的 afterPropertiesSet 方法，在此方法中 MyBatis 使用 XMLConfigBuilder 对配置进行解析。</p>
<h2 id=basebuilder-体系>BaseBuilder 体系</h2>
<p>XMLConfigBuilder 是 XML 配置解析的入口，继承自 BaseBuilder，其为 MyBatis 初始化提供了一系列工具方法，如别名转换、类型转换、类加载等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211007161811.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=全局配置对象>全局配置对象</h2>
<p>XMLConfigBuilder 在构造方法中创建了 Configuration 对象，这个对象中用于保存 MyBatis 相关的全部配置，包括运行行为、类型容器、别名容器、注册 Mapper、注册 statement 等。通过 XMLConfigBuilder 的 parse 方法可以看出，配置解析的目的就是为了获取 Configuration 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XPathParser</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建全局配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SQL Mapper Configuration&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置自定义配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 指定环境
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 包装配置 InputStream 的 XPathParser
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Configuration</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Each XMLConfigBuilder can only be used once.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 读取 configuration 元素并解析
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/configuration&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析配置文件>解析配置文件</h2>
<p>配置解析分为多步，详情可参考 XML 配置。MyBatis 源码内置 mybatis-config.xsd 文件用于定义配置文件书写规则。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//issue #117 read properties first
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 解析 properties 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>propertiesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;properties&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 加载 settings 配置并验证是否有效
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>settings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;settings&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 配置自定义虚拟文件系统实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadCustomVfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 配置自定义日志实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadCustomLogImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 typeAliases 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeAliasesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeAliases&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 plugins 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>pluginElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;plugins&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 objectFactory 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>objectFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 objectWrapperFactory 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>objectWrapperFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectWrapperFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 reflectorFactory 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reflectorFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reflectorFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 将 settings 配置设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>settingsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// read it after objectFactory and objectWrapperFactory issue #631
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 解析 environments 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>environmentsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;environments&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 databaseIdProvider 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>databaseIdProviderElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseIdProvider&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 typeHandlers 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeHandlerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandlers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 mappers 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>mapperElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mappers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error parsing SQL Mapper Configuration. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-properties-元素>解析 properties 元素</h3>
<p>properties 元素用于将自定义配置传递给 MyBatis，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;properties</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;com/wch/mybatis/config.properties&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;username&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;wch&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;password&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Noop&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/properties&gt;</span>
</code></pre></div><p>其加载逻辑为将不同配置转为 Properties 对象，并设置到全局配置中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>propertiesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取子元素属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>defaults</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 读取 resource 属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 读取 url 属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 不可均为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 加载指定路径文件，转为 properties
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrlAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 添加创建配置的附加属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>vars</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vars</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vars</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-settings-元素>解析 settings 元素</h3>
<p>setteings 元素中的各子元素定义了 MyBatis 的运行时行为，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;settings&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 缓存开关 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;cacheEnabled&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 懒加载开关 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;lazyLoadingEnabled&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 允许自动生成主键 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;useGeneratedKeys&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 驼峰命名开关 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mapUnderscoreToCamelCase&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    ...
  <span style=color:#204a87;font-weight:700>&lt;/settings&gt;</span>
</code></pre></div><p>这些配置在 Configuration 类中都有对应的 setter 方法。settings 元素的解析方法对配置进行了验证：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Properties</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 获取子元素配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// Check that all settings are known to the configuration class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 获取 Configuration 类的相关信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MetaClass</span> <span style=color:#000>metaConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MetaClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localReflectorFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>metaConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSetter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 验证对应的 setter 方法存在，保证配置是有效的
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The setting &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is not known.  Make sure you spelled it correctly (case sensitive).&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果不存在对应的配置，会抛出 BuilderException 异常，如果自定义配置都是生效的，随后会调用 settingsElement 方法将这些运行时行为设置到全局配置中。</p>
<h3 id=解析-typealiases-元素>解析 typeAliases 元素</h3>
<p>typeAliases 元素用于定义类别名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;typeAliases&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;package</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.User&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;User&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.User&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.Item&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/typeAliases&gt;</span>
</code></pre></div><p>如果使用 package 元素注册别名，则对应包下的所有类都会注册到 TypeAliasRegistry 别名注册容器中；如果使用 typeAlias 元素，则会注册指定类到别名容器中。注册逻辑如下，如果没有指定别名，则优先从类的 Alias 注解获取别名，如果未在类上定义，则默认使用简单类名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下所有类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下指定类型的别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   * @param superType
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>resolverUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 找出该包下superType所有的子类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IsA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>typeSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClasses</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>typeSet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Ignore inner classes and interfaces (including package-info.java)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// Skip also inner classes. See issue #6
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMemberClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名，默认为简单类名，优先从 Alias 注解获取
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param type
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 从Alias注解读取别名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Alias</span> <span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliasAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param alias 别名
</span><span style=color:#8f5902;font-style:italic>   * @param value 类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The parameter alias cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// issue #748
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toLowerCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The alias &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is already mapped to the value &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-plugins-元素>解析 plugins 元素</h3>
<p>插件是 MyBatis 提供的扩展机制之一，通过添加自定义插件可以实现在 SQL 执行过程中的某个时机进行拦截。 plugins 元素用于定义调用拦截器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;plugin</span> <span style=color:#c4a000>interceptor=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.ExamplePlugin&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;ExamplePlugin&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</code></pre></div><p>指定的 interceptor 需要实现 org.apache.ibatis.plugin.Interceptor 接口，在创建对象后被加到全局配置过滤器链中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pluginElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取 interceptor 属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>interceptor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;interceptor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 从子元素中读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Properties</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 加载指定拦截器并创建实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Interceptor</span> <span style=color:#000>interceptorInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Interceptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>interceptorInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 加入全局配置拦截器链
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptorInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>objectFactory、 objectWrapperFactory、reflectorFactory 元素的解析方式与 plugins 元素类似 ，指定的子类对象创建后被设置到全局对象中。</p>
<h3 id=解析-environments-元素>解析 environments 元素</h3>
<p>在实际生产中，一个项目可能会分为多个不同的环境，通过配置enviroments 元素可以定义不同的数据环境，并在运行时使用指定的环境：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;environments</span> <span style=color:#c4a000>default=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;environment</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;transactionManager</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;JDBC&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/transactionManager&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;dataSource</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;UNPOOLED&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;driver&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${driver}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;url&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${url}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;username&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${username}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;password&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${password}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/dataSource&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/environment&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;environment</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;prd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    	...
    <span style=color:#204a87;font-weight:700>&lt;/environment&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/environments&gt;</span>
</code></pre></div><p>在解析过程中，只有被 default 属性指定的数据环境才会被加载：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>environmentsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取指定的数据源名
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;default&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 环境配置 id
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSpecifiedEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定环境配置
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// 解析 transactionManager 元素并创建事务工厂实例
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>TransactionFactory</span> <span style=color:#000>txFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionManagerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#8f5902;font-style:italic>// 解析 dataSource 元素并创建数据源工厂实例
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>DataSourceFactory</span> <span style=color:#000>dsFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSourceElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#8f5902;font-style:italic>// 创建数据源
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dsFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#8f5902;font-style:italic>// 创建环境
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span> <span style=color:#000>environmentBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txFactory</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 将环境配置信息设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environmentBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 解析 transactionManager 元素并创建事务工厂实例
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws Exception
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionManagerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 指定事务工厂类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 加载事务工厂并创建实例
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>TransactionFactory</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Environment declaration requires a TransactionFactory.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 解析 dataSource 元素并创建数据源工厂实例
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws Exception
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DataSourceFactory</span> <span style=color:#000>dataSourceElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 指定数据源工厂类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 加载数据源工厂并创建实例
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>DataSourceFactory</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSourceFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Environment declaration requires a DataSourceFactory.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-databaseidprovider-元素>解析 databaseIdProvider 元素</h3>
<p>MyBatis 支持通过 databaseIdProvider 元素来指定支持的数据库的 databaseId，这样在映射配置文件中指定 databaseId 就能够与对应的数据源进行匹配：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;databaseIdProvider</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;DB_VENDOR&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;SQL Server&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;sqlserver&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;DB2&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;db2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;Oracle&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;oracle&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/databaseIdProvider&gt;</span>
</code></pre></div><p>在根据指定类型解析出对应的 DatabaseIdProvider 后，MyBatis 会根据数据源获取对应的厂商信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>databaseIdProviderElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DatabaseIdProvider</span> <span style=color:#000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// awful patch to keep backward compatibility
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;VENDOR&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;DB_VENDOR&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 加载数据库厂商信息配置类并创建实例
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DatabaseIdProvider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>databaseIdProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Environment</span> <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取数据库厂商标识
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>databaseIdProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为 DB_VENDOR 被指定为 VendorDatabaseIdProvider 的别名，所以默认的获取厂商信息的逻辑如下，当通过 property 属性指定了数据库产品名则使用指定的名称，否则使用数据库元信息对应的产品名。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据数据源获取对应的厂商信息
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param dataSource
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dataSource cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getDatabaseName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>LogHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not get a databaseId from dataSource&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 如果传入的属性配置包含当前数据库产品名，返回指定的值，否则返回数据库产品名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param dataSource
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getDatabaseName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>productName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDatabaseProductName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>productName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// no match, return null
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>productName</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取数据库产品名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param dataSource
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getDatabaseProductName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Connection</span> <span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>DatabaseMetaData</span> <span style=color:#000>metaData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetaData</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseProductName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// ignored
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-typehandlers-元素>解析 typeHandlers 元素</h3>
<p>typeHandlers 元素用于配置自定义类型转换器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;typeHandlers&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;typeHandler</span> <span style=color:#c4a000>handler=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.ExampleTypeHandler&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/typeHandlers&gt;</span>
</code></pre></div><p>如果配置的是 package 元素，则会将包下的所有类注册为类型转换器；如果配置的是 typeHandler 元素，则会根据 javaType、jdbcType、handler 属性注册类型转换器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>typeHandlerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;package&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 注册指定包下的类作为类型转换器，如果声明了 MappedTypes 注解则注册为指定 java 类型的转换器
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>String</span> <span style=color:#000>typeHandlerPackage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandlerPackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 获取相关属性
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>String</span> <span style=color:#000>javaTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>jdbcTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbcType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>handlerTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;handler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定 java 类型类对象
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定 JDBC 类型并创建实例
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveJdbcType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定类型转换器类对象
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeHandlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注册类型转换器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-mappers-元素>解析 mappers 元素</h3>
<p>mappers 元素用于定义 Mapper 映射文件和 Mapper 调用接口：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;mappers&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;com/wch/mybatis/UserMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>url=</span><span style=color:#4e9a06>&#34;file://mappers/ItemMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.UserMapper&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;package</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.mappers&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/mappers&gt;</span>
</code></pre></div><p>如果定义的是 mapper 元素并指定了 class 属性，或定义了 package 元素，则会将指定类型在 MapperRegistry 中注册为 Mapper 接口，并使用 MapperAnnotationBuilder 对接口方法进行解析；如果定义的是 mapper 元素并指定了 resource、或 url 属性，则会使用 XMLMapperBuilder 解析。对于 Mapper 接口和映射文件将在下一章进行分析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mapperElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;package&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 注册指定包名下的类为 Mapper 接口
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>String</span> <span style=color:#000>mapperPackage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperPackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;class&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定资源
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定 Mapper 文件并解析
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>mapperParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>mapperParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定 URL
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrlAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定 Mapper 文件并解析
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>mapperParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>mapperParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注册指定类为 Mapper 接口
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>mapperInterface</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A mapper element may only specify a url, resource or class, but not more than one.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p>XMLConfigBuilder 是 XML 配置解析的入口，通常 MyBatis 启动时会使用此类解析配置文件获取运行时行为。</p>
<ul>
<li>org.apache.ibatis.builder.BaseBuilder：为 MyBatis 初始化过程提供一系列工具方法。如别名转换、类型转换、类加载等。</li>
<li>org.apache.ibatis.builder.xml.XMLConfigBuilder：XML 配置解析入口。</li>
<li>org.apache.ibatis.session.Configuration：MyBatis 全局配置，包括运行行为、类型容器、别名容器、注册 Mapper、注册 statement 等。</li>
<li>org.apache.ibatis.mapping.VendorDatabaseIdProvider：根据数据源获取对应的厂商信息。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-125a1275eb4845ae03d56a1d156b0d92>4.5 - CH05-通用配置解析</h1>
<p>在上章的配置解析中可以看到 MyBatis 在解析完运行时行为相关配置后会继续解析 Mapper 映射文件和接口，其中参数映射的解析入口为 XMLMapperBuilder 。</p>
<h2 id=映射文件解析>映射文件解析</h2>
<p>XMLMapperBuilder 调用 parse 方法解析 Mapper 映射文件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isResourceLoaded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析 mapper 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configurationElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 加入已解析队列
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLoadedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// Mapper 映射文件与对应 namespace 的接口进行绑定
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>bindMapperForNamespace</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 重新引用配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parsePendingResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>parsePendingCacheRefs</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>parsePendingStatements</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-mapper-元素>解析 mapper 元素</h2>
<p>mapper 元素通常需要指定 namespace 用于唯一区别映射文件，不同映射文件支持通过其它映射文件的 namespace 来引用其配置。mapper 元素下可以配置二级缓存（cache、cache-ref）、返回值映射（resultMap）、sql fragments（sql）、statement（select、insert、update、delete）等，MyBatis 源码提供 mybatis-mapper.xsd 文件用于规范映射文件书写规则。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>configurationElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取元素对应的 namespace 名称
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Mapper&#39;s namespace cannot be empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 设置 Mapper 文件对应的 namespace 名称
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 cache-ref 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>cacheRefElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache-ref&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 cache 元素，会覆盖 cache-ref 配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>cacheElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 parameterMap 元素（废弃）
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parameterMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/parameterMap&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 resultMap 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>resultMapElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 sql 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/sql&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 select|insert|update|delete 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>buildStatementFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select|insert|update|delete&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error parsing Mapper XML. The XML location is &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-cache-元素>解析 cache 元素</h2>
<p>如果要为某命名空间开启二级缓存功能，可以通过配置 cache 元素，示例配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;cache</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>“PERPETUAL”</span> <span style=color:#c4a000>eviction=</span><span style=color:#4e9a06>&#34;LRU&#34;</span> <span style=color:#c4a000>flushInterval=</span><span style=color:#4e9a06>&#34;60000&#34;</span> <span style=color:#c4a000>size=</span><span style=color:#4e9a06>&#34;512&#34;</span> <span style=color:#c4a000>readOnly=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>blocking=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/cache&gt;</span>
</code></pre></div><p>cache 元素的解析逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cacheElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取缓存类型，默认为 PERPETUAL
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;PERPETUAL&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// Configuration 构造方法中已为默认的缓存实现注册别名，从别名转换器中获取类对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 获取失效类型，默认为 LRU
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>eviction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;eviction&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;LRU&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evictionClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eviction</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 缓存刷新时间间隔
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Long</span> <span style=color:#000>flushInterval</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLongAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;flushInterval&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 缓存项大小
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Integer</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;size&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 是否将序列化成二级制数据
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>readWrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;readOnly&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 缓存不命中进入数据库查询时是否加锁（保证同一时刻相同缓存key只有一个线程执行数据库查询任务）
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>blocking</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;blocking&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素中加载属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 创建缓存配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>useNewCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>evictionClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushInterval</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readWrite</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>blocking</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在第三章基础支持模块中已经详细介绍了 MyBatis 实现的各种缓存。从 cache 元素中获取缓存参数配置后会交由 MapperBuilderAssistant#useNewCache 方法处理。MapperBuilderAssistant 方法是一个映射文件解析工具，它负责将映射文件各个元素解析的参数生成配置对象，最终设置到全局配置类 Configuration 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Cache</span> <span style=color:#000>useNewCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evictionClass</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Long</span> <span style=color:#000>flushInterval</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Integer</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>readWrite</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>blocking</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Properties</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentNamespace</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 基础缓存配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>implementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>valueOrDefault</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PerpetualCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#8f5902;font-style:italic>// 失效类型，默认 LRU
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addDecorator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>valueOrDefault</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>evictionClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>LruCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#8f5902;font-style:italic>// 定时清理缓存时间间隔
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearInterval</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flushInterval</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 缓存项大小
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 是否将缓存系列化成二级制数据
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readWrite</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readWrite</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 缓存不命中进入数据库查询时是否加锁（保证同一时刻相同缓存key只有一个线程执行数据库查询任务）
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>blocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>blocking</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>currentCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-cache-ref-元素>解析 cache-ref 元素</h2>
<p>如果希望引用其它 namespace 的缓存配置，可以通过 cache-ref 元素配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;cache-ref</span> <span style=color:#c4a000>namespace=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.OtherMapper&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>其解析逻辑是将当前 namespace 与引用缓存配置的 namespace 在全局配置中进行绑定。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cacheRefElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 当前 namespace - 引用缓存配置的 namespace，在全局配置中进行绑定
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addCacheRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 获取缓存配置解析器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>CacheRefResolver</span> <span style=color:#000>cacheRefResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheRefResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析获得引用的缓存配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cacheRefResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveCacheRef</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IncompleteElementException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 指定引用的 namespace 缓存还未加载，暂时放入集合，等待全部 namespace 都加载完成后重新引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addIncompleteCacheRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheRefResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由于存在被引用配置还未被加载，因而无法从全局配置中获取的情况，MyBatis 定义了 IncompleteElementException 在此时抛出，未解析完成的缓存解析对象会被加入到全局配置中的 incompleteCacheRefs 集合中，用于后续处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Cache</span> <span style=color:#000>useCacheRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache-ref element requires a namespace attribute.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>unresolvedCacheRef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 从全局配置中获取缓存配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No cache for namespace &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; could be found.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>currentCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>unresolvedCacheRef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 可能指定引用的 namespace 缓存还未加载，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No cache for namespace &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; could be found.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>MyBatis 允许 resultMap、cache-ref、statement 元素延迟加载，以 cache-ref 重新引用的方法 parsePendingCacheRefs 为例，其重新引用逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parsePendingCacheRefs</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从全局配置中获取未解析的缓存引用配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CacheRefResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>incompleteCacheRefs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIncompleteCacheRefs</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>incompleteCacheRefs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CacheRefResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>incompleteCacheRefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 逐个重新引用缓存配置
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>iter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolveCacheRef</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#8f5902;font-style:italic>// 引用成功，删除集合元素
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>iter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IncompleteElementException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 引用的缓存配置不存在
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// Cache ref is still missing a resource...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-resultmap-元素>解析 resultMap 元素</h2>
<p>resultMap 元素用于定义结果集与结果对象（JavaBean 对象）之间的映射规则。resultMap 下除了 discriminator 的其它元素，都会被解析成 ResultMapping 对象，其解析过程如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMap</span> <span style=color:#000>resultMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalResultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;processing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValueBasedIdentifier</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 获取返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ofType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>))));</span>
    <span style=color:#8f5902;font-style:italic>// 加载返回值类对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// association 和 case 元素没有显式地指定返回值类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inheritEnclosingType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Discriminator</span> <span style=color:#000>discriminator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>additionalResultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加载子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultChildren</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resultChildren</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;constructor&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 constructor 元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>processConstructorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;discriminator&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 discriminator 元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>discriminator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>processDiscriminatorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 resultMap 元素下的其它元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// id 元素增加标志
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ID</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 解析元素映射关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValueBasedIdentifier</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// extend resultMap id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;extends&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 是否设置自动映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Boolean</span> <span style=color:#000>autoMapping</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;autoMapping&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// resultMap 解析器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ResultMapResolver</span> <span style=color:#000>resultMapResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResultMapResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>discriminator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoMapping</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析生成 ResultMap 对象并设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultMapResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolve</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IncompleteElementException</span>  <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 异常稍后处理
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addIncompleteResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以下从不同元素配置的角度分别分析 MyBatis 解析规则。</p>
<h3 id=id--result>id & result</h3>
<p>id 和 result 元素都会将一个列的值映射到一个简单数据类型字段，不同的是 id 元素对应对象的标识属性，在比较对象时会用到。此外还可以设置 typeHandler 属性用于自定义类型转换逻辑。</p>
<p>buildResultMappingFromContext 方法负责将 resultMap 子元素解析为 ResultMapping 对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 解析 resultMap 子元素映射关系
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMapping</span> <span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// constructor 子元素，通过 name 获取参数名
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 列名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;column&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// java 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>javaType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// jdbc 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbcType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 嵌套的 select id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nestedSelect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取嵌套的 resultMap id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nestedResultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 获取指定的不为空才创建实例的列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>notNullColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;notNullColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 列前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>columnPrefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;columnPrefix&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 类型转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 集合的多结果集
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSet&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 指定外键对应的列名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>foreignColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foreignColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 是否懒加载
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;lazy&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fetchType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLazyLoadingEnabled</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;lazy&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;eager&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 加载返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加载类型转换器类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>typeHandlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加载 jdbc 类型对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveJdbcType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildResultMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nestedSelect</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nestedResultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>notNullColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>columnPrefix</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultSet</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>foreignColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lazy</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ResultMapping 对象保存了列名与 JavaBean 中字段名的对应关系，并明确了 Java 类型和 JDBC 类型，如果指定了类型转换器则使用指定的转化器将结果集字段映射为 Java 对象字段；否则根据 Java 类型和 JDBC 类型到类型转换器注册类中寻找适合的类型转换器。最终影响映射的一系列因素都被保存到 ResultMapping 对象中并加入到全局配置。</p>
<h3 id=constructor>constructor</h3>
<p>使用 constructor 元素允许返回值对象使用指定的构造方法创建而不是默认的构造方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;constructor&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;idArg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;arg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;productId&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;product_id&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/constructor&gt;</span>
</code></pre></div><p>在解析 constructor 元素时，MyBatis 特别指定了将 constructor 子元素解析为 ResultMapping 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#8f5902;font-style:italic>// 加载子元素
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultChildren</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resultChildren</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;constructor&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析 constructor 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processConstructorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>...</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 解析 constructor 元素下的子元素
</span><span style=color:#8f5902;font-style:italic>	 */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConstructorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>argChildren</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>argChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>argChildren</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#8f5902;font-style:italic>// 标明此元素在 constructor 元素中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;idArg&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 此元素映射 id
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ID</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 解析子元素映射关系
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>解析 constructor 子元素的逻辑与解析 id、result 元素的逻辑是一致的。</p>
<h4 id=association>association</h4>
<p>association 用于配置非简单类型的映射关系。其不仅支持在当前查询中做嵌套映射：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;userResult&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;User&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;id</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;user_id&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;association</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;product&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;product_id&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;productResult&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
</code></pre></div><p>也支持通过 select 属性嵌套其它查询：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;userResult&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;User&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;id</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;user_id&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;association</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;product&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;product_id&#34;</span> <span style=color:#c4a000>select=</span><span style=color:#4e9a06>&#34;queryProduct&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
</code></pre></div><p>在解析 resultMap 子元素方法 buildResultMappingFromContext 的逻辑中，MyBatis 会尝试获取每个子元素的 resultMap 属性，如果未指定，则会调用 processNestedResultMappings 方法，在此方法中对于 asociation 元素来说，如果指定了 select 属性，则映射时只需要获取对应 select 语句的 resultMap；如果未指定，则需要重新调用 resultMapElement 解析结果集映射关系。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMapping</span> <span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// 尝试获取嵌套的 resultMap id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nestedResultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 处理嵌套的 resultMap，获取 id
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param resultMappings
</span><span style=color:#8f5902;font-style:italic>   * @param enclosingType
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws Exception
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;association&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;collection&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;case&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果是 association、collection 或 case 元素并且没有 select 属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// collection 元素没有指定 resultMap 或 javaType 属性，需要验证 resultMap 父元素对应的返回值类型是否有对当前集合的赋值入口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>validateCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 resultMapElement 方法中调用了 inheritEnclosingType 针对未定义返回类型的元素的返回值类型解析：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMap</span> <span style=color:#000>resultMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalResultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// 获取返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ofType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>))));</span>
    <span style=color:#8f5902;font-style:italic>// 加载返回值类对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// association 等元素没有显式地指定返回值类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inheritEnclosingType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>inheritEnclosingType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;association&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// association 元素没有指定 resultMap 属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>enclosingType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 根据反射信息确定字段的类型
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MetaClass</span> <span style=color:#000>metaResultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MetaClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReflectorFactory</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaResultType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSetterType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;case&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// case 元素返回值属性与 resultMap 父元素相同
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 inheritEnclosingType 方法中，如果未定义 resultMap 属性，则会通过反射工具 MetaClass 获取父元素 resultMap 返回类型的类信息，association 元素对应的字段名称的 setter 方法的参数就是其返回值类型。由此 association 元素必定可以关联到其结果集映射。</p>
<h3 id=collection>collection</h3>
<p>collection 元素用于配置集合属性的映射关系，其解析过程与 association 元素大致相同，重要的区别是 collection 元素使用 ofType 属性指定集合元素类型，例如需要映射的 Java 集合为 List<user> users，则配置示例如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>	<span style=color:#204a87;font-weight:700>&lt;collection</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;users&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>user_id&#34;</span> <span style=color:#c4a000>ofType=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.User&#34;</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;ArrayList&#34;</span> <span style=color:#c4a000>select=</span><span style=color:#4e9a06>&#34;queryUsers&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>javaType熟悉指定的是字段类型，而 ofType 属性指定的才是需要映射的集合存储的类型。</p>
<h3 id=discriminator>discriminator</h3>
<p>discriminator 支持对一个查询可能出现的不同结果集做鉴别，根据具体的条件为 resultMap 动态选择返回值类型。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;discriminator</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;case</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Apple&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;case</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;2&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Banana&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/discriminator&gt;</span>
</code></pre></div><p>discriminator 元素的解析是通过 processDiscriminatorElement 方法完成的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Discriminator</span> <span style=color:#000>processDiscriminatorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取需要鉴别的字段的相关信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;column&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>javaType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbcType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>typeHandlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveJdbcType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>discriminatorMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 解析 discriminator 的 case 子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>caseChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析不同列值对应的不同 resultMap
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>caseChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>caseChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caseChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>discriminatorMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildDiscriminator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>discriminatorMap</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-resultmap>创建 ResultMap</h3>
<p>在 resultMap 各子元素解析完成，ResultMapResolver 负责将生成的 ResultMapping 集合解析为 ResultMap 对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ResultMap</span> <span style=color:#000>addResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Discriminator</span> <span style=color:#000>discriminator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span> <span style=color:#000>autoMapping</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not find a parent resultmap with id &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 获取继承的 ResultMap 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>extendedResultMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMappings</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>extendedResultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// Remove parent constructor if this resultMap declares a constructor.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>declaresConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultMapping</span> <span style=color:#000>resultMapping</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 当前 resultMap 指定了构造方法
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>declaresConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaresConstructor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 移除继承的 ResultMap 的构造器映射对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>extendedResultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeIf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapping</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>resultMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extendedResultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResultMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoMapping</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>discriminator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>discriminator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果当前 ResultMap 指定了 extend 属性，MyBatis 会从全局配置中获取被继承的 ResultMap 的相关映射关系，加入到当前映射关系中。但是如果被继承的 ResultMap 指定了构造器映射关系，当前 ResultMap 会选择移除。</p>
<h2 id=解析-sql-元素>解析 sql 元素</h2>
<p>sql 元素用于定义可重用的 SQL 代码段，这些代码段可以通过 include 元素进行引用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;baseColumns&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	id, name, value
<span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;other&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	${alias}
<span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;query&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Product&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	SELECT
  	<span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;baseColumns&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>,
  	<span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;other&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;alias&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;other&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  	<span style=color:#204a87;font-weight:700>&lt;/include&gt;</span>
  FROM
      t_something
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><p>对 sql 元素的解析逻辑如下，符合 databaseId 要求的 sql 元素才会被加载到全局配置中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 解析 sql 元素，将对应的 sql 片段设置到全局配置中
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseIdMatchesCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 符合当前 databaseId 的 sql fragment，加入到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlFragments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 判断 sql 元素是否满足加载条件
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param id
</span><span style=color:#8f5902;font-style:italic> * @param databaseId
</span><span style=color:#8f5902;font-style:italic> * @param requiredDatabaseId
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>databaseIdMatchesCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredDatabaseId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 如果指定了当前数据源的 databaseId
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 被解析 sql 元素的 databaseId 需要符合
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 全局未指定 databaseId，不会加载指定了 databaseId 的 sql 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// skip this fragment if there is a previous one with a not null databaseId
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlFragments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>XNode</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlFragments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p>MyBatis 能够轻松实现列值转换为 Java 对象依靠的是其强大的参数映射功能，能够支持集合、关联类型、嵌套等复杂场景的映射。同时缓存配置、sql 片段配置，也为开发者方便的提供了配置入口。</p>
<ul>
<li>org.apache.ibatis.builder.annotation.MapperAnnotationBuilder：解析 Mapper 接口。</li>
<li>org.apache.ibatis.builder.xml.XMLMapperBuilder：解析 Mapper 文件。</li>
<li>org.apache.ibatis.builder.MapperBuilderAssistant：Mapper 文件解析工具。生成元素对象并设置到全局配置中。</li>
<li>org.apache.ibatis.builder.CacheRefResolver：缓存引用配置解析器，应用其它命名空间缓存配置到当前命名空间下。</li>
<li>org.apache.ibatis.builder.IncompleteElementException：当前映射文件引用了其它命名空间下的配置，而该配置还未加载到全局配置中时会抛出此异常。</li>
<li>org.apache.ibatis.mapping.ResultMapping：返回值字段映射关系对象。</li>
<li>org.apache.ibatis.builder.ResultMapResolver：ResultMap 解析器。</li>
<li>org.apache.ibatis.mapping.ResultMap：返回值映射对象。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a9c6c53bbe0dedfdf1ef1b445f90dcb1>4.6 - CH06-语句解析</h1>
<p>Mapper 映射文件解析的最后一步是解析所有 statement 元素，即 select、insert、update、delete 元素，这些元素中可能会包含动态 SQL，即使用 ${} 占位符或 if、choose、where 等元素动态组成的 SQL。动态 SQL 功能正是 MyBatis 强大的所在，其解析过程也是十分复杂的。</p>
<h2 id=解析工具>解析工具</h2>
<p>为了方便 statement 的解析，MyBatis 提供了一些解析工具。</p>
<h3 id=token-解析>Token 解析</h3>
<p>MyBatis 支持使用 ${} 或 #{} 类型的 token 作为动态参数，不仅文本中可以使用 token，xml 元素中的属性等也可以使用。</p>
<h4 id=generictokenparser>GenericTokenParser</h4>
<p>GenericTokenParser 是 MyBatis 提供的通用 token 解析器，其解析逻辑是根据指定的 token 前缀和后缀搜索 token，并使用传入的 TokenHandler 对文本进行处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// search open token 搜索 token 前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 没有 token 前缀，返回原文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>src</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toCharArray</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 当前解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 已解析文本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>builder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 当前占位符内的表达式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StringBuilder</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;\\&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果待解析属性前缀被转义，则去掉转义字符，加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// this open token is escaped. remove the backslash and continue.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// found open token. let&#39;s search close token.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 前缀前面的部分加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取对应的后缀索引
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;\\&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 后缀被转义，加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// this close token is escaped. remove the backslash and continue.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 寻找下一个后缀
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 找到后缀，获取占位符内的表达式
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 找不到后缀，前缀之后的部分全部加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// close token was not found.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 能够找到后缀，追加 token 处理器处理后的文本
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
          <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 寻找下一个前缀，重复解析表达式
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 将最后的部分加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 返回解析后的文本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由于 GenericTokenParser 的 token 前后缀和具体解析逻辑都是可指定的，因此基于 GenericTokenParser 可以实现对不同 token 的定制化解析。</p>
<h4 id=tokenhandler>TokenHandler</h4>
<p>TokenHandler 是 token 处理器抽象接口。实现此接口可以定义 token 以何种方式被解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 对 token 进行解析
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param content 待解析 token
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=propertyparser>PropertyParser</h4>
<p>PropertyParser 是 token 解析的一种具体实现，其指定对 <code>${}</code> 类型 token 进行解析，具体解析逻辑由其内部类 VariableTokenHandler 实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 对 ${} 类型 token 进行解析
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param string
</span><span style=color:#8f5902;font-style:italic>   * @param variables
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>VariableTokenHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>VariableTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据配置属性对 ${} token 进行解析
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VariableTokenHandler</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 预先设置的属性
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 是否运行使用默认值，默认为 false
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enableDefaultValue</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 默认值分隔符号，即如待解析属性 ${key:default}，key 的默认值为 default
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>VariableTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>variables</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableDefaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>KEY_ENABLE_DEFAULT_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ENABLE_DEFAULT_VALUE</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultValueSeparator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>KEY_DEFAULT_VALUE_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DEFAULT_VALUE_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enableDefaultValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 如待解析属性 ${key:default}，key 的默认值为 default
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>separatorIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 使用默认值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 不使用默认值
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 返回原文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;${&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>VariableTokenHandler 实现了 TokenHandler 接口，其构造方法允许传入一组 Properties 用于获取 token 表达式的值。如果开启了使用默认值，则表达式 ${key:default} 会在 key 没有映射值的时候使用 default 作为默认值。</p>
<h3 id=特殊容器>特殊容器</h3>
<h4 id=strictmap>StrictMap</h4>
<p>Configuration 中的 StrictMap 继承了 HashMap，相对于 HashMap，其存取键值的要求更为严格。put 方法不允许添加相同的 key，并获取最后一个 <code>.</code> 后的部分作为 shortKey，如果 shortKey 也重复了，其会向容器中添加一个 Ambiguity 对象，当使用 get 方法获取这个 shortKey 对应的值时，就会抛出异常。get 方法对于不存在的 key 也会抛出异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 重复 key 异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; already contains value for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span>
          <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conflictMessageProducer</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conflictMessageProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取最后一个 . 后的部分作为 shortKey
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>shortKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getShortName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// shortKey 不允许重复，否则在获取时异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>V</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// key 不存在抛异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; does not contain value for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 重复的 key 抛异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getSubject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is ambiguous in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span>
                                         <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; (try using the full name including the namespace, or rename one of the entries)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=contextmap>ContextMap</h4>
<p>ContextMap 是 DynamicContext 的静态内部类，用于保存 sql 上下文中的绑定参数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextMap</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2977601501966151582L</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 参数对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MetaObject</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ContextMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetaObject</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterMetaObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 先根据 key 查找原始容器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>strKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 再进入参数对象查找
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMetaObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// issue #61 do not modify the context when reading
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=ognl-参数>OGNL 参数</h3>
<h4 id=ognlcache>OgnlCache</h4>
<p>OGNL 工具支持通过字符串表达式调用 Java 方法，但是其实现需要对 OGNL 表达式进行编译，为了提高性能，MyBatis 提供 OgnlCache 工具类用于对 OGNL 表达式编译结果进行缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据 ognl 表达式和参数计算值
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param root
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Map</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createDefaultContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MEMBER_ACCESS</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CLASS_RESOLVER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OgnlException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error evaluating expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 编译 ognl 表达式并放入缓存
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws OgnlException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>OgnlException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expressionCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 编译 ognl 表达式
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 放入缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>expressionCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=expressionevaluator>ExpressionEvaluator</h4>
<p>ExpressionEvaluator 是 OGNL 表达式计算工具，evaluateBoolean 和 evaluateIterable 方法分别根据传入的表达式和参数计算出一个 boolean 值或一个可迭代对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 计算 ognl 表达式 true / false
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>evaluateBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 ognl 表达式和参数计算值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// true / false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 不为 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>compareTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ZERO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 不为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 计算获得一个可迭代的对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>evaluateIterable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; evaluated to a null value.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 已实现 Iterable 接口
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isArray</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 数组转集合
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// the array may be primitive, so Arrays.asList() may throw
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// a ClassCastException (issue 209).  Do the work manually
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// Curse primitives! :) (JGB)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>answer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>answer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>answer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Map 获取 entry
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error evaluating expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;.  Return value (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) was not iterable.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析逻辑>解析逻辑</h2>
<p>MyBastis 中调用 XMLStatementBuilder#parseStatementNode 方法解析单个 statement 元素。此方法中除了逐个获取元素属性，还对 include 元素、selectKey 元素进行解析，创建了 sql 生成对象 SqlSource，并将 statement 的全部信息聚合到 MappedStatement 对象中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseStatementNode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取 id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 自定义数据库厂商信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>databaseIdMatchesCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 不符合当前数据源对应的数据厂商信息的语句不加载
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 获取元素名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 元素名转为对应的 SqlCommandType 枚举
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlCommandType</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 是否为查询
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSelect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 获取 flushCache 属性，查询默认为 false，其它默认为 true
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flushCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;flushCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>isSelect</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取 useCache 属性，查询默认为 true，其它默认为 false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>useCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;useCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isSelect</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取 resultOrdered 属性，默认为 false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resultOrdered</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultOrdered&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// Include Fragments before parsing
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>XMLIncludeTransformer</span> <span style=color:#000>includeParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLIncludeTransformer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析 include 属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>includeParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#8f5902;font-style:italic>// 参数类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>parameterType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parameterType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 Mapper 语法类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>lang</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lang&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 默认使用 XMLLanguageDriver
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LanguageDriver</span> <span style=color:#000>langDriver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getLanguageDriver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// Parse selectKey after includes and remove them.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 解析 selectKey 元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>processSelectKeyNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 KeyGenerator
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>keyStatementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SelectKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT_KEY_SUFFIX</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>keyStatementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取解析完成的 KeyGenerator 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果开启了 useGeneratedKeys 属性，并且为插入类型的 sql 语句、配置了 keyProperty 属性，则可以批量自动设置属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;useGeneratedKeys&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isUseGeneratedKeys</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSERT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>))</span>
          <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>Jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 生成有效 sql 语句和参数绑定对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// sql 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StatementType</span> <span style=color:#000>statementType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;statementType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PREPARED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#8f5902;font-style:italic>// 分批获取数据的数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Integer</span> <span style=color:#000>fetchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fetchSize&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 执行超时时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Integer</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;timeout&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 参数映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>parameterMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parameterMap&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 返回值映射 map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 结果集类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSetType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ResultSetType</span> <span style=color:#000>resultSetTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveResultSetType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSetType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 插入、更新生成键值的字段
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyProperty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyProperty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 插入、更新生成键值的列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 指定多结果集名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSets&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 新增 MappedStatement
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>fetchSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultSetTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>useCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultOrdered</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultSets</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=语法驱动>语法驱动</h3>
<p>LanguageDriver 是 statement 创建语法驱动，默认实现为 XMLLanguageDriver，其提供 createSqlSource 方法用于使用 XMLScriptBuilder 创建 sql 生成对象。</p>
<h3 id=递归解析-include>递归解析 include</h3>
<p>include 元素是 statement 元素的子元素，通过 refid 属性可以指向在别处定义的 sql fragments。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Properties</span> <span style=color:#000>variablesContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Properties</span> <span style=color:#000>configurationVariables</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 拷贝全局配置中设置的额外配置属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configurationVariables</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>putAll</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 递归解析 statement 元素中的 include 元素
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * Recursively apply includes through all SQL fragments.
</span><span style=color:#8f5902;font-style:italic>   * @param source Include node in DOM tree
</span><span style=color:#8f5902;font-style:italic>   * @param variablesContext Current context for static variables with values
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Properties</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>included</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;include&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// include 元素，从全局配置中找对应的 sql 节点并 clone
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Node</span> <span style=color:#000>toInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findSqlFragment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;refid&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 读取 include 子元素中的 property 元素，获取全部属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>toIncludeContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getVariablesContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>toIncludeContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>toInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>importNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replaceChild</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasChildNodes</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>insertBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFirstChild</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeChild</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>included</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// replace variables in attribute values
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// include 指向的 sql clone 节点，逐个对属性进行解析
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>NamedNodeMap</span> <span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributes</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>Node</span> <span style=color:#000>attr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNodeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// statement 元素中可能包含 include 子元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>included</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>included</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TEXT_NODE</span>
        <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// replace variables in text node
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 替换元素值，如果使用了 ${} 占位符，会对 token 进行解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNodeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 从全局配置中找对应的 sql fragment
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param refid
</span><span style=color:#8f5902;font-style:italic>   * @param variables
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Node</span> <span style=color:#000>findSqlFragment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 解析 refid
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// namespace.refid
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 从全局配置中找对应的 sql fragment
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>XNode</span> <span style=color:#000>nodeToInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nodeToInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>cloneNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// sql fragments 定义在全局配置中的 StrictMap 中，获取不到会抛出异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not find SQL statement to include with refid &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributes</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNamedItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Read placeholders and their values from include node definition.
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * 读取 include 子元素中的 property 元素
</span><span style=color:#8f5902;font-style:italic>   * @param node Include node instance
</span><span style=color:#8f5902;font-style:italic>   * @param inheritedVariablesContext Current context used for replace variables in new variables values
</span><span style=color:#8f5902;font-style:italic>   * @return variables context from include instance (no inherited values)
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Properties</span> <span style=color:#000>getVariablesContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 解析 include 元素中的 property 子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Node</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// include 运行包含 property 元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Replace variables inside
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 不允许添加同名属性
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Variable &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; defined twice in the same include definition&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 聚合属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>newProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在开始解析前，从全局配置中获取全部的属性配置，如果 include 元素中有 property 元素，解析并获取键值，放入 variablesContext 中，在后续处理中针对可能出现的 ${} 类型 token 使用 PropertyParser 进行解析。</p>
<p>因为解析 statement 元素前已经加载过 sql 元素，因此会根据 include 元素的 refid 属性查找对应的 sql fragments，如果全局配置中无法找到就会抛出异常；如果能够找到则克隆 sql 元素并插入到当前 xml 文档中。</p>
<h3 id=解析-selectkey>解析 selectKey</h3>
<p>selectKey 用于指定 sql 在 insert 或 update 语句执行前或执行后生成或获取列值，在 MyBatis 中 selectKey 也被当做 statement 语句进行解析并设置到全局配置中。单个 selectKey 元素会以SelectKeyGenerator 对象的形式进行保存用于后续调用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseSelectKeyNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XNode</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>LanguageDriver</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>StatementType</span> <span style=color:#000>statementType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;statementType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PREPARED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#8f5902;font-style:italic>// 对应字段名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyProperty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyProperty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 对应列名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 是否在父sql执行前执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>executeBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;BEFORE&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AFTER&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#8f5902;font-style:italic>//defaults
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>useCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resultOrdered</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Integer</span> <span style=color:#000>fetchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Integer</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flushCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>parameterMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ResultSetType</span> <span style=color:#000>resultSetTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 创建 sql 生成对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlCommandType</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 将 KeyGenerator 生成 sql 作为 MappedStatement 加入全局对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>fetchSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultSetTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>useCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultOrdered</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>MappedStatement</span> <span style=color:#000>keyStatement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 包装为 SelectKeyGenerator 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SelectKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executeBefore</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 selectKey 解析完成后，按指定的 namespace 规则从全局配置中获取 SelectKeyGenerator 对象，等待创建 MappedStatement 对象。如果未指定 selectKey 元素，但是全局配置中开启了 useGeneratedKeys，并且指定 insert 元素的 useGeneratedKeys 属性为 true，则 MyBatis 会指定 Jdbc3KeyGenerator 作为 useGeneratedKeys 的默认实现。</p>
<h3 id=创建-sql-生成对象>创建 sql 生成对象</h3>
<h4 id=sqlsource>SqlSource</h4>
<p>SqlSource 是 sql 生成抽象接口，其提供 getBoundSql 方法用于根据参数生成有效 sql 语句和参数绑定对象 BoundSql。在生成 statement 元素的解析结果 MappedStatement 对象前，需要先创建 sql 生成对象，即 SqlSource 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlSource</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据参数生成有效 sql 语句和参数绑定对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=sqlnode>SqlNode</h4>
<p>SqlNode 是 sql 节点抽象接口。sql 节点指的是 statement 中的组成部分，如果简单文本、if 元素、where 元素等。SqlNode 提供 apply 方法用于判断当前 sql 节点是否可以加入到生效的 sql 语句中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据条件判断当前 sql 节点是否可以加入到生效的 sql 语句中
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211008223403.png style=display:block;width:70% alt=NAME align=center> </div>
<h4 id=dynamiccontext>DynamicContext</h4>
<p>DynamicContext 是动态 sql 上下文，用于保存绑定参数和生效 sql 节点。DynamicContext 使用 ContextMap 作为参数绑定容器。由于动态 sql 是根据参数条件组合生成 sql，DynamicContext 还提供了对 sqlBuilder 修改和访问方法，用于添加有效 sql 节点和生成 sql 文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 生效的 sql 部分，以空格相连
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringJoiner</span> <span style=color:#000>sqlBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringJoiner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getSql</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=节点解析>节点解析</h4>
<p>将 statement 元素转为 sql 生成对象依赖于 LanguageDriver 的 createSqlSource 方法，此方法中创建 XMLScriptBuilder 对象，并调用 parseScriptNode 方法对 sql 组成节点逐个解析并进行组合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSource</span> <span style=color:#000>parseScriptNode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 递归解析各 sql 节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MixedSqlNode</span> <span style=color:#000>rootSqlNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseDynamicTags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDynamic</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 动态 sql
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DynamicSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 原始文本 sql
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RawSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 处理 statement 各 SQL 组成部分，并进行组合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>MixedSqlNode</span> <span style=color:#000>parseDynamicTags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// SQL 各组成部分
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 遍历子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newXNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CDATA_SECTION_NODE</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TEXT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 sql 文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>TextSqlNode</span> <span style=color:#000>textSqlNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TextSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>textSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDynamic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 判断是否为动态 sql，包含 ${} 占位符即为动态 sql
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>textSqlNode</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>isDynamic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 静态 sql 元素
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticTextSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// issue #628
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 如果是子元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取支持的子元素语法处理器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>NodeHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown element &lt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&gt; in SQL statement.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 根据子元素标签类型使用对应的处理器处理子元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 包含标签元素，认定为动态 SQL
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>isDynamic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MixedSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>parseDynamicTags 方法会对 sql 各组成部分进行分解，如果 statement 元素包含 ${} 类型 token 或含有标签子元素，则认为当前 statement 是动态 sql，随后 isDynamic 属性会被设置为 true。对于文本节点，如 sql 纯文本和仅含 ${} 类型 token 的文本，会被包装为 StaticTextSqlNode 或 TextSqlNode 加入到 sql 节点容器中，而其它元素类型的 sql 节点会经过 NodeHandler 的 handleNode 方法处理过之后才能加入到节点容器中。nodeHandlerMap 定义了不同动态 sql 元素节点与 NodeHandler 的关系：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initNodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trim&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TrimHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;where&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WhereHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SetHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foreach&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;if&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IfHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;choose&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChooseHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;when&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IfHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;otherwise&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OtherwiseHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bind&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=mixedsqlnode>MixedSqlNode</h5>
<p>MixedSqlNode 中定义了一个 SqlNode 集合，用于保存 statement 中包含的全部 sql 节点。其生成有效 sql 的逻辑为逐个判断节点是否有效。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 组合 SQL 各组成部分
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @author Clinton Begin
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MixedSqlNode</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * SQL 各组装成部分
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MixedSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 逐个判断各个 sql 节点是否能生效
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=statictextsqlnode>StaticTextSqlNode</h5>
<p>StaticTextSqlNode 中仅包含静态 sql 文本，在组装时会直接追加到 sql 上下文的有效 sql 中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=textsqlnode>TextSqlNode</h5>
<p>TextSqlNode 中的 sql 文本包含 ${} 类型 token，使用 GenericTokenParser 搜索到 token 后会使用 BindingTokenParser 对 token 进行解析，解析后的文本会被追加到生效 sql 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 搜索 ${} 类型 token 节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 解析 token 并追加解析后的文本到生效 sql 中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>GenericTokenParser</span> <span style=color:#000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TokenHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BindingTokenParser</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Pattern</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BindingTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pattern</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取绑定参数
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;_parameter&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SimpleTypeRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSimpleType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 计算 ognl 表达式的值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>String</span> <span style=color:#000>srtValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// issue #274 return &#34;&#34; instead of &#34;null&#34;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>checkInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srtValue</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>srtValue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=ifsqlnode>IfSqlNode</h5>
<p>if 标签用于在 test 条件生效时才追加标签内的文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userId &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    AND user_id = #｛userId｝
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
</code></pre></div><p>IfSqlNode 保存了 if 元素下的节点内容和 test 表达式，在生成有效 sql 时会根据 OGNL 工具计算 test 表达式是否生效。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 test 表达式判断当前节点是否生效
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>evaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=trimsqlnode>TrimSqlNode</h5>
<p>trim 标签用于解决动态 sql 中由于条件不同不能拼接正确语法的问题。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  SELECT * FROM test
  <span style=color:#204a87;font-weight:700>&lt;trim</span> <span style=color:#c4a000>prefix=</span><span style=color:#4e9a06>&#34;WHERE&#34;</span> <span style=color:#c4a000>prefixOverrides=</span><span style=color:#4e9a06>&#34;AND|OR&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      a = #{a}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;b &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      OR b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;c &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      AND c = #{c}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/trim&gt;</span>
</code></pre></div><p>如果没有 trim 标签，这个 statement 的有效 sql 最终可能会是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#a40000>{</span><span style=color:#000>b</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>但是加上 trim 标签，生成的 sql 语法是正确的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#a40000>{</span><span style=color:#000>b</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>prefix 属性用于指定 trim 节点生成的 sql 语句的前缀，prefixOverrides 则会指定生成的 sql 语句的前缀需要去除的部分，多个需要去除的前缀可以使用 | 隔开。suffix 与 suffixOverrides 的功能类似，但是作用于后缀。</p>
<p>TrimSqlNode 首先调用 parseOverrides 对 prefixOverrides 和 suffixOverrides 进行解析，通过 | 分隔，分别加入字符串集合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parseOverrides</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析 token，按 | 分隔
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringTokenizer</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;|&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countTokens</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreTokens</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存为字符串集合
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextToken</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在调用包含的 SqlNode 的 apply 方法后还会调用 FilteredDynamicContext 的 applyAll 方法处理前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>FilteredDynamicContext</span> <span style=color:#000>filteredDynamicContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加上前缀和和后缀，并去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>filteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于已经生成的 sql 文本，分别根据规则加上和去除指定前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyAll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 加上前缀和和后缀，并去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>applyPrefix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applySuffix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyPrefix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringBuilder</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>prefixApplied</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>prefixApplied</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefixesToOverride</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 文本最前去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>toRemove</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>prefixesToOverride</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 在文本最前插入前缀和空格
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applySuffix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringBuilder</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>suffixApplied</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>suffixApplied</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffixesToOverride</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 文本最后去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>toRemove</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>suffixesToOverride</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 文本最后插入空格和后缀
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffix</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffix</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=wheresqlnode>WhereSqlNode</h5>
<p>where 元素与 trim 元素的功能类似，区别在于 where 元素不提供属性配置可以处理的前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>
    ...
  <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>
</code></pre></div><p>WhereSqlNode 继承了 TrimSqlNode，并指定了需要添加和删除的前缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WhereSqlNode</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TrimSqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prefixList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;AND &#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;OR &#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;AND\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AND\r&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\r&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AND\t&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\t&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>WhereSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlNode</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 默认添加 WHERE 前缀，去除 AND、OR 等前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;WHERE&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prefixList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因此，生成的 sql 语句会自动在最前加上 WHERE，并去除前缀中包含的 AND、OR 等字符串。</p>
<h5 id=setsqlnode>SetSqlNode</h5>
<p>set 标签用于 update 语句中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>	UPDATE test
	<span style=color:#204a87;font-weight:700>&lt;set&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      a = #{a},
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;b &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>
</code></pre></div><p>SetSqlNode 同样继承自 TrimSqlNode，并指定默认添加 SET 前缀，去除 , 前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SetSqlNode</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TrimSqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>COMMA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SetSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>SqlNode</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 默认添加 SET 前缀，去除 , 前缀和后缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;SET&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMA</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMA</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=foreachsqlnode>ForEachSqlNode</h5>
<p>foreach 元素用于指定对集合循环添加 sql 语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;list&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;item&#34;</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;index&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  AND itm = #{item} AND idx #{index}
<span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
</code></pre></div><p>ForEachSqlNode 解析生成有效 sql 的逻辑如下，除了计算 collection 表达式的值、添加前缀、后缀外，还将参数与索引进行了绑定。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取绑定参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>bindings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 计算 ognl 表达式获取可迭代对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>iterable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>evaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateIterable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>collectionExpression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bindings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>iterable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 添加动态语句前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyOpen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 迭代索引
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iterable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>DynamicContext</span> <span style=color:#000>oldContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 首个元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>separator</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>uniqueNumber</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUniqueNumber</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// Issue #709
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// entry 集合项索引为 key，集合项为 value
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 绑定集合项索引关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 绑定集合项关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!((</span><span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isPrefixApplied</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldContext</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 添加动态语句后缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyClose</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 移除原始的表达式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 绑定集合项索引关系
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param o
</span><span style=color:#8f5902;font-style:italic>   * @param i
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 绑定集合项关系
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param o
</span><span style=color:#8f5902;font-style:italic>   * @param i
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于循环中的 #{} 类型 token，ForEachSqlNode 在内部类 FilteredDynamicContext 中定义了解析规则：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;^\\s*&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;(?![^.,:\\s])&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>newContent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;^\\s*&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>itemIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;(?![^.,:\\s])&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;#{&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>});</span>

    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>类似 <code>idx = #{index} AND itm = #{item}</code> 会被替换为 <code>idx = #{__frch_index_1} AND itm = #{__frch_item_1}</code>，而 ForEachSqlNode 也做了参数与索引的绑定，因此在替换时可以快速绑定参数。</p>
<h5 id=choosesqlnode>ChooseSqlNode</h5>
<p>choose 元素用于生成带默认 sql 文本的语句，当 when 元素中的条件都不生效，就可以使用 otherwise 元素的默认文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;choose&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    	AND a = #{a}
    <span style=color:#204a87;font-weight:700>&lt;/when&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;otherwise&gt;</span>
    	AND b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/otherwise&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/choose&gt;</span>
</code></pre></div><p>ChooseSqlNode 是由 choose 节点和 otherwise 节点组合而成的，在生成有效 sql 于语句时会逐个计算 when 节点的 test 表达式，如果返回 true 则生效当前 when 语句中的 sql。如果均不生效则使用 otherwise 语句对应的默认 sql 文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// when 节点根据 test 表达式判断是否生效
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlNode</span> <span style=color:#000>sqlNode</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ifSqlNodes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// when 节点如果都未生效，且存在 otherwise 节点，则使用 otherwise 节点
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultSqlNode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>defaultSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=vardeclsqlnode>VarDeclSqlNode</h5>
<p>bind 元素用于绑定一个 OGNL 表达式到一个动态 sql 变量中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bind</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;pattern&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;&#39;%&#39; + _parameter.getTitle() + &#39;%&#39;&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>VarDeclSqlNode 会计算表达式的值并将参数名和值绑定到参数容器中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 解析 ognl 表达式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#8f5902;font-style:italic>// 绑定参数
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建解析对象与生成可执行-sql>创建解析对象与生成可执行 sql</h3>
<p>statemen 解析完毕后会创建 MappedStatement 对象，statement 的相关属性以及生成的 sql 创建对象都会被保存到该对象中。MappedStatement 还提供了 getBoundSql 方法用于获取可执行 sql 和参数绑定对象，即 BoundSql 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 生成可执行 sql 和参数绑定对象
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#8f5902;font-style:italic>// 获取参数映射
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ParameterMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// check for nested result maps in parameter mappings (issue #30)
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 检查是否有嵌套的 resultMap
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterMapping</span> <span style=color:#000>pm</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>rmId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMapId</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rmId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ResultMap</span> <span style=color:#000>rm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rmId</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rm</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>hasNestedResultMaps</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>rm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNestedResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BoundSql 对象由 DynamicSqlSource 的 getBoundSql 方法生成，在验证各个 sql 节点，生成了有效 sql 后会继续调用 SqlSourceBuilder 将 sql 解析为 StaticSqlSource，即可执行 sql。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DynamicContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 验证各 sql 节点，生成有效 sql
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlSourceBuilder</span> <span style=color:#000>sqlSourceParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSourceBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 将生成的 sql 文本解析为 StaticSqlSource
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSourceParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此时的 sql 文本中仍包含 #{} 类型 token，需要通过 ParameterMappingTokenHandler 进行解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSource</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>originalSql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ParameterMappingTokenHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParameterMappingTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建 #{} 类型 token 搜索对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析 token
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>originalSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建静态 sql 生成对象，并绑定参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>token 的具体解析逻辑为根据表达式的参数名生成对应的参数映射对象，并将表达式转为预编译 sql 的占位符 ?。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建参数映射对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildParameterMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 将表达式转为预编译 sql 占位符
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;?&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终解析完成的 sql 与参数映射关系集合包装为 StaticSqlSource 对象，该对象在随后的逻辑中通过构造方法创建了 BoundSql 对象。</p>
<h2 id=接口解析>接口解析</h2>
<p>除了使用 xml 方式配置 statement，MyBatis 同样支持使用 Java 注解配置。但是相对于 xml 的映射方式，将动态 sql 写在 Java 代码中是不合适的。如果在配置文件中指定了需要注册 Mapper 接口的类或包，MyBatis 会扫描相关类进行注册；在 Mapper 文件解析完成后也会尝试加载 namespace 的同名类，如果存在，则注册为 Mapper 接口。</p>
<p>无论是绑定还是直接注册 Mapper 接口，都是调用 MapperAnnotationBuilder#parse 方法来解析的。此方法中的解析方式与上述 xml 解析方式大致相同，区别只在于相关配置参数是从注解中获取而不是从 xml 元素属性中获取。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 不允许相同接口重复注册
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Type &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is already known to the MapperRegistry.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#8f5902;font-style:italic>// It&#39;s important that the type is added before the parser is run
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// otherwise the binding may automatically be attempted by the
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// mapper parser. If the type is already known, it won&#39;t try.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MapperAnnotationBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperAnnotationBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>loadCompleted</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p><code>statement</code> 解析的最终目的是为每个 <code>statement</code> 创建一个 <code>MappedStatement</code> 对象保存相关定义，在 <code>sql</code> 执行时根据传入参数动态获取可执行 <code>sql</code> 和参数绑定对象。</p>
<ul>
<li><code>org.apache.ibatis.builder.xml.XMLStatementBuilder</code>：解析 <code>Mapper</code> 文件中的 <code>select|insert|update|delete</code> 元素。</li>
<li><code>org.apache.ibatis.parsing.GenericTokenParser.GenericTokenParser</code>：搜索指定格式 <code>token</code> 并进行解析。</li>
<li><code>org.apache.ibatis.parsing.TokenHandler</code>：<code>token</code> 处理器抽象接口。定义 <code>token</code> 以何种方式被解析。</li>
<li><code>org.apache.ibatis.parsing.PropertyParser</code>：<code>${}</code> 类型 <code>token</code> 解析器。</li>
<li><code>org.apache.ibatis.session.Configuration.StrictMap</code>：封装 <code>HashMap</code>，对键值存取有严格要求。</li>
<li><code>org.apache.ibatis.builder.xml.XMLIncludeTransformer</code>：<code>include</code> 元素解析器。</li>
<li><code>org.apache.ibatis.mapping.SqlSource</code>：<code>sql</code> 生成抽象接口。根据传入参数生成有效 <code>sql</code> 语句和参数绑定对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.XMLScriptBuilder</code>：解析 <code>statement</code> 各个 <code>sql</code> 节点并进行组合。</li>
<li><code>org.apache.ibatis.scripting.xmltags.SqlNode</code>：<code>sql</code> 节点抽象接口。用于判断当前 <code>sql</code> 节点是否可以加入到生效的 sql 语句中。</li>
<li><code>org.apache.ibatis.scripting.xmltags.DynamicContext</code>：动态 <code>sql</code> 上下文。用于保存绑定参数和生效 <code>sql</code> 节点。</li>
<li><code>org.apache.ibatis.scripting.xmltags.OgnlCache</code>：<code>ognl</code> 缓存工具，缓存表达式编译结果。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ExpressionEvaluator</code>：<code>ognl</code> 表达式计算工具。</li>
<li><code>org.apache.ibatis.scripting.xmltags.MixedSqlNode</code>：<code>sql</code> 节点组合对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.StaticTextSqlNode</code>：静态 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.TextSqlNode</code>：<code>${}</code> 类型 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.IfSqlNode</code>：<code>if</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.TrimSqlNode</code>：<code>trim</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.WhereSqlNode</code>：<code>where</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.SetSqlNode</code>：<code>set</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ForEachSqlNode</code>：<code>foreach</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ChooseSqlNode</code>：<code>choose</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.VarDeclSqlNode</code>：<code>bind</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.mapping.MappedStatement</code>：<code>statement</code> 解析对象。</li>
<li><code>org.apache.ibatis.mapping.BoundSql</code>：可执行 <code>sql</code> 和参数绑定对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.DynamicSqlSource</code>：根据参数动态生成有效 <code>sql</code> 和绑定参数。</li>
<li><code>org.apache.ibatis.builder.SqlSourceBuilder</code>：解析 <code>#{}</code> 类型 <code>token</code> 并绑定参数对象。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-76dd90616bec5587f31bc2e5f663b91b>4.7 - CH07-接口层</h1>
<h2 id=sql-会话创建工厂>sql 会话创建工厂</h2>
<p><code>SqlSessionFactoryBuilder</code> 经过复杂的解析逻辑之后，会根据全局配置创建 <code>DefaultSqlSessionFactory</code>，该类是 <code>sql</code> 会话创建工厂抽象接口 <code>SqlSessionFactory</code> 的默认实现，其提供了若干 <code>openSession</code> 方法用于打开一个会话，在会话中进行相关数据库操作。这些 <code>openSession</code> 方法最终都会调用 <code>openSessionFromDataSource</code> 或 <code>openSessionFromConnection</code> 创建会话，即基于数据源配置创建还是基于已有连接对象创建。</p>
<h3 id=基于数据源配置创建会话>基于数据源配置创建会话</h3>
<p>要使用数据源打开一个会话需要先从全局配置中获取当前生效的数据源环境配置，如果没有生效配置或没用设置可用的事务工厂，就会创建一个 <code>ManagedTransactionFactory</code> 实例作为默认事务工厂实现，其与 <code>MyBatis</code> 提供的另一个事务工厂实现 <code>JdbcTransactionFactory</code> 的区别在于其生成的事务实现 <code>ManagedTransaction</code> 的提交和回滚方法是空实现，即希望将事务管理交由外部容器管理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSessionFromDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Transaction</span> <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Environment</span> <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 获取事务工厂
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTransactionFactoryFromEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建事务配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建执行器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建 sql 会话
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// may have fetched a connection so lets call close()
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error opening session.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取生效数据源环境配置的事务工厂
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>getTransactionFactoryFromEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Environment</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 未配置数据源环境或事务工厂，默认使用 ManagedTransactionFactory
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ManagedTransactionFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>随后会根据入参传入的 <code>execType</code> 选择对应的执行器 <code>Executor</code>，<code>execType</code> 的取值来源于 <code>ExecutorType</code>，这是一个枚举类。在下一章将会详细分析各类 <code>Executor</code> 的作用及其实现。</p>
<p>获取到事务工厂配置和执行器对象后会结合传入的数据源自动提交属性创建 <code>DefaultSqlSession</code>，即 <code>sql</code> 会话对象。</p>
<h3 id=基于数据连接创建会话>基于数据连接创建会话</h3>
<p>基于连接创建会话的流程大致与基于数据源配置创建相同，区别在于自动提交属性 <code>autoCommit</code> 是从连接对象本身获取的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSessionFromConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取自动提交配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Failover to true, as most poor drivers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// or databases won&#39;t support transactions
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Environment</span> <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 获取事务工厂
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTransactionFactoryFromEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建事务配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Transaction</span> <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建执行器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建 sql 会话
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error opening session.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=sql-会话>sql 会话</h2>
<p><code>SqlSession</code> 是 <code>MyBatis</code> 面向用户编程的接口，其提供了一系列方法用于执行相关数据库操作，默认实现为 <code>DefaultSqlSession</code>，在该类中，增删查改对应的操作最终会调用 <code>selectList</code>、<code>select</code> 和 <code>update</code> 方法，其分别用于普通查询、执行存储过程和修改数据库记录。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrapCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_RESULT_HANDLER</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error querying database.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 调用存储过程
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrapCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error querying database.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 修改
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>dirty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrapCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error updating database.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上操作均是根据传入的 <code>statement</code> 名称到全局配置中查找对应的 <code>MappedStatement</code> 对象，并将操作委托给执行器对象 <code>executor</code> 完成。<code>select</code>、<code>selectMap</code> 等方法则是对 <code>selectList</code> 方法返回的结果集做处理来实现的。</p>
<p>此外，提交和回滚方法也是基于 <code>executor</code> 实现的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 提交事务
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCommitOrRollbackRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>dirty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error committing transaction.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 回滚事务
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCommitOrRollbackRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>dirty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error rolling back transaction.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 非自动提交且事务未提交 || 强制提交或回滚 时返回 true
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCommitOrRollbackRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>dirty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在执行 <code>update</code> 方法时，会设置 <code>dirty</code> 属性为 <code>true</code> ，意为事务还未提交，当事务提交或回滚后才会将 <code>dirty</code> 属性修改为 <code>false</code>。如果当前会话不是自动提交且 <code>dirty</code> 熟悉为 <code>true</code>，或者设置了强制提交或回滚的标志，则会将强制标志提交给 <code>executor</code> 处理。</p>
<h2 id=sql-会话管理器>sql 会话管理器</h2>
<p><code>SqlSessionManager</code> 同时实现了 <code>SqlSessionFactory</code> 和 <code>SqlSession</code> 接口，使得其既能够创建 <code>sql</code> 会话，又能够执行 <code>sql</code> 会话的相关数据库操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * sql 会话创建工厂
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * sql 会话代理对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSessionProxy</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 保存线程对应 sql 会话
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>localSqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSessionManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>SqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionInterceptor</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 设置当前线程对应的 sql 会话
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>startManagedSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>localSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openSession</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * sql 会话代理逻辑
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SqlSessionInterceptor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionInterceptor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Prevent Synthetic Access
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取当前线程对应的 sql 会话对象并执行对应方法
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlSessionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>localSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果当前线程没有对应的 sql 会话，默认创建不自动提交的 sql 会话
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span> <span style=color:#000>autoSqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openSession</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autoSqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>autoSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autoSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>SqlSessionManager</code> 的构造方法要求 <code>SqlSessionFactory</code> 对象作为入参传入，其各个创建会话的方法实际是由该传入对象完成的。执行 <code>sql</code> 会话的操作由 <code>sqlSessionProxy</code> 对象完成，这是一个由 <code>JDK</code> 动态代理创建的对象，当执行方法时会去 <code>ThreadLocal</code> 对象中查找当前线程有没有对应的 <code>sql</code> 会话对象，如果有则使用已有的会话对象执行，否则创建新的会话对象执行，而线程对应的会话对象需要使用 <code>startManagedSession</code> 方法来维护。</p>
<p>之所以 <code>SqlSessionManager</code> 需要为每个线程维护会话对象，是因为 <code>DefaultSqlSession</code> 是非线程安全的，多线程操作会导致执行错误。如上文中提到的 <code>dirty</code> 属性，其修改是没有经过任何同步操作的。</p>
<h2 id=总结>总结</h2>
<p><code>SqlSession</code> 是 <code>MyBatis</code> 提供的面向开发者编程的接口，其提供了一系列数据库相关操作，并屏蔽了底层细节。使用 <code>MyBatis</code> 的正确方式应该是像 <code>SqlSessionManager</code> 那样为每个线程创建 <code>sql</code> 会话对象，避免造成线程安全问题。</p>
<ul>
<li><code>org.apache.ibatis.session.SqlSessionFactory</code>：<code>sql</code> 会话创建工厂。</li>
<li><code>org.apache.ibatis.session.defaults.DefaultSqlSessionFactory</code>： <code>sql</code> 会话创建工厂默认实现。</li>
<li><code>org.apache.ibatis.session.SqlSession</code>：<code>sql</code> 会话。</li>
<li><code>org.apache.ibatis.session.defaults.DefaultSqlSession</code>：<code>sql</code> 会话默认实现。</li>
<li><code>org.apache.ibatis.session.SqlSessionManager</code>：<code>sql</code> 会话管理器。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c2f0467d2acc81697b3d21a42afa4ddb>4.8 - CH08-执行器</h1>
<p>执行器 <code>Executor</code> 是 <code>MyBatis</code> 的核心接口之一，接口层提供的相关数据库操作，都是基于 <code>Executor</code> 的子类实现的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211008225409.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=创建执行器>创建执行器</h2>
<p>在创建 <code>sql</code> 会话时，<code>MyBatis</code> 会调用 <code>Configuration#newExecutor</code> 方法创建执行器。枚举类 <code>ExecutorType</code> 定义了三种执行器类型，即 <code>SIMPLE</code>、<code>REUSE</code> 和 <code>Batch</code>，这些执行器的主要区别在于：</p>
<ul>
<li><code>SIMPLE</code> 在每次执行完成后都会关闭 <code>statement</code> 对象；</li>
<li><code>REUSE</code> 会在本地维护一个容器，当前 <code>statement</code> 创建完成后放入容器中，当下次执行相同的 <code>sql</code> 时会复用 <code>statement</code> 对象，执行完毕后也不会关闭；</li>
<li><code>BATCH</code> 会将修改操作记录在本地，等待程序触发或有下一次查询时才批量执行修改操作。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Executor</span> <span style=color:#000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Transaction</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutorType</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 默认类型为 simple
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>defaultExecutorType</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIMPLE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BATCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BatchExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REUSE</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReuseExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 如果全局缓存打开，使用 CachingExecutor 代理执行器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CachingExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#8f5902;font-style:italic>// 应用插件
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行器创建后，如果全局缓存配置是有效的，则会将执行器装饰为 <code>CachingExecutor</code>。</p>
<h2 id=基础执行器>基础执行器</h2>
<p><code>SimpleExecutor</code>、<code>ReuseExecutor</code>、<code>BatchExecutor</code> 均继承自 <code>BaseExecutor</code>。<code>BaseExecutor</code> 实现了 <code>Executor</code> 的全部方法，对缓存、事务、连接处理等提供了一些模板方法，但是针对具体的数据库操作留下了四个抽象方法交由子类实现。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 更新
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 刷新 statement
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doFlushStatements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询获取游标对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doQueryCursor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>基础执行器的查询逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executing a query&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>object</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Executor was closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queryStack</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFlushCacheRequired</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 非嵌套查询且设置强制刷新时清除缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>++;</span>
      <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultHandler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 缓存不为空，组装存储过程出参
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>handleLocallyCachedOutputParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 无本地缓存，执行数据库查询
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queryFromDatabase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>--;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queryStack</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeferredLoad</span> <span style=color:#000>deferredLoad</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>deferredLoads</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>deferredLoad</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// issue #601
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>deferredLoads</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocalCacheScope</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>LocalCacheScope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STATEMENT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// issue #482
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 全局配置语句不共享缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询本地缓存，组装存储过程结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>handleLocallyCachedOutputParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CALLABLE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存储过程类型，查询缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>cachedParameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>localOutputParameterCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedParameter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MetaObject</span> <span style=color:#000>metaCachedParameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedParameter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MetaObject</span> <span style=color:#000>metaParameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterMapping</span> <span style=color:#000>parameterMapping</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>ParameterMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IN</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 参数类型为 OUT 或 INOUT 的，组装结果集
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>parameterName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>cachedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaCachedParameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>metaParameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cachedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询数据库获取结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queryFromDatabase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 放一个 placeHolder 标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EXECUTION_PLACEHOLDER</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 执行查询
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 查询结果集放入本地缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CALLABLE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果是存储过程查询，将存储过程结果集放入本地缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>localOutputParameterCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行查询时 <code>MyBatis</code> 首先会根据 <code>CacheKey</code> 查询本地缓存，<code>CacheKey</code> 由本次查询的参数生成，本地缓存由 <code>PerpetualCache</code> 实现，这就是 <code>MyBatis</code> 的一级缓存。一级缓存维护对象 <code>localCache</code> 是基础执行器的本地变量，因此只有相同 <code>sql</code> 会话的查询才能共享一级缓存。当一级缓存中没有对应的数据，基础执行器最终会调用 <code>doQuery</code> 方法交由子类去获取数据。</p>
<p>而执行 <code>update</code> 等其它操作时，则会首先清除本地的一级缓存再交由子类执行具体的操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executing an update&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>object</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Executor was closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 清空本地缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 调用子类执行器逻辑
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=简单执行器>简单执行器</h2>
<p>简单执行器是 <code>MyBatis</code> 的默认执行器。其封装了对 <code>JDBC</code> 的操作，对于查询方法 <code>doQuery</code> 的实现如下，其主要包括创建 <code>statement</code> 处理器、创建 <code>statement</code>、执行查询、关闭 <code>statement</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Configuration</span> <span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 创建 statement 处理器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建 statement
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementLog</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#8f5902;font-style:italic>// 执行查询
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 关闭 statement
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-statement-处理器>创建 statement 处理器</h3>
<p>全局配置类 <code>Configuration</code> 提供了方法 <code>newStatementHandler</code> 用于创建 <code>statement</code> 处理器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 创建 statement 处理器
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StatementHandler</span> <span style=color:#000>newStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MappedStatement</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// StatementHandler 包装对象，根据 statement 类型创建代理处理器，并将实际操作委托给代理处理器处理
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StatementHandler</span> <span style=color:#000>statementHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RoutingStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 应用插件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>statementHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StatementHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statementHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实际每次创建的 <code>statement</code> 处理器对象都是由 <code>RoutingStatementHandler</code> 创建的，<code>RoutingStatementHandler</code> 根据当前 <code>MappedStatement</code> 的类型创建具体的 <code>statement</code> 类型处理器。<code>StatementType</code> 定义了 <code>3</code> 个 <code>statement</code> 类型枚举，分别对应 <code>JDBC</code> 的普通语句、预编译语句和存储过程语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RoutingStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 statement 类型选择对应的 statementHandler
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>STATEMENT</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PREPARED</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PreparedStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CALLABLE</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CallableStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown statement type: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-statement>创建 statement</h3>
<p>简单执行器中的 <code>Statement</code> 对象是根据上述步骤中生成的 <code>statement</code> 处理器获取的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Statement</span> <span style=color:#000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Log</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 获取代理连接对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 设置 statement 参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Statement</span> <span style=color:#000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>transactionTimeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>Statement</span> <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 从连接中创建 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>instantiateStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置超时时间
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setStatementTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transactionTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置分批获取数据数量
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setFetchSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error preparing statement.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=执行查询>执行查询</h3>
<p>创建 statement 对象完成即可通过 JDBC 的 API 执行数据库查询，并从 statement 对象中获取查询结果，根据配置进行转换。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 执行查询
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 处理结果集
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultSetHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleResultSets</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 处理结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handleResultSets</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;handling results&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>object</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 多结果集
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>multipleResults</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>resultSetCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ResultSetWrapper</span> <span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getFirstResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// statement 对应的所有 ResultMap 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMaps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>resultMapCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMaps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 验证结果集不为空时，ResultMap 数量不能为 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>validateResultMapsCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMapCount</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultMapCount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 逐个获取 ResultMap
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMaps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 转换结果集，放到 multipleResults 容器中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>handleResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>multipleResults</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 获取下一个待处理的结果集
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getNextResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>cleanUpAfterHandlingResultSet</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// statement 配置的多结果集类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resultSets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultSets</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSets</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultSetCount</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>resultSets</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ResultMapping</span> <span style=color:#000>parentMapping</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextResultMaps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSets</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentMapping</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>nestedResultMapId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNestedResultMapId</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nestedResultMapId</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>handleResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parentMapping</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getNextResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>cleanUpAfterHandlingResultSet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>collapseSingleResultList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>multipleResults</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=关闭连接>关闭连接</h3>
<p>查询完成后 <code>statement</code> 对象会被关闭。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 关闭 statement
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param statement
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>简单执行器中的其它数据库执行方法与 <code>doQuery</code> 方法实现类似。</p>
<h2 id=复用执行器>复用执行器</h2>
<p><code>ReuseExecutor</code> 相对于 <code>SimpleExecutor</code> 实现了对 <code>statment</code> 对象的复用，其在本地维护了 <code>statementMap</code> 用于保存 <code>sql</code> 语句和 <code>statement</code> 对象的关系。当调用 <code>prepareStatement</code> 方法获取 <code>statement</code> 对象时首先会查找本地是否有对应的 <code>statement</code> 对象，如果有则进行复用，负责重新创建并将 <code>statement</code> 对象放入本地缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 创建 statement 对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param handler
</span><span style=color:#8f5902;font-style:italic>   * @param statementLog
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Statement</span> <span style=color:#000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Log</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>String</span> <span style=color:#000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasStatementFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果本地容器中包含当前 sql 对应的 statement 对象，进行复用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applyTransactionTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>putStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasStatementFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isClosed</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Statement</span> <span style=color:#000>getStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>提交或回滚会导致执行器调用 <code>doFlushStatements</code> 方法，复用执行器会因此批量关闭本地的 <code>statement</code> 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 批量关闭 statement 对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param isRollback
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doFlushStatements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=批量执行器>批量执行器</h2>
<p><code>BatchExecutor</code> 相对于 <code>SimpleExecutor</code> ，其 <code>update</code> 操作是批量执行的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Configuration</span> <span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentStatement</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果当前 sql 与上次传入 sql 相同且为相同的 MappedStatement，复用 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 获取最后一个 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置超时时间
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>applyTransactionTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置参数
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//fix Issues 322
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 获取批量执行结果对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>BatchResult</span> <span style=color:#000>batchResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameterObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 创建新的 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementLog</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>    <span style=color:#8f5902;font-style:italic>//fix Issues 322
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>currentSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>currentStatement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 执行 JDBC 批量添加 sql 语句操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>batch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BATCH_UPDATE_RETURN_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 批量执行 sql
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param isRollback
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doFlushStatements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 批量执行结果
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>results</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>applyTransactionTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>BatchResult</span> <span style=color:#000>batchResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 设置执行影响行数
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUpdateCounts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeBatch</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterObjects</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKeyGenerator</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Jdbc3KeyGenerator</span> <span style=color:#000>jdbc3KeyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 设置数据库生成的主键
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processBatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObjects</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//issue #141
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parameterObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processAfter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// Close statement to close cursor #1109
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BatchUpdateException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>StringBuilder</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>())</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; (batch index #&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; failed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; prior sub executor(s) completed successfully, but will be rolled back.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BatchExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>currentSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行器提交或回滚事务时会调用 <code>doFlushStatements</code>，从而批量执行提交的 <code>sql</code> 语句并最终批量关闭 <code>statement</code> 对象。</p>
<h2 id=缓存执行器与二级缓存>缓存执行器与二级缓存</h2>
<p><code>CachingExecutor</code> 对基础执行器进行了装饰，其作用就是为查询提供二级缓存。所谓的二级缓存是由 <code>CachingExecutor</code> 维护的，相对默认内置的一级缓存而言的缓存。二者区别如下：</p>
<ul>
<li>一级缓存由基础执行器维护，且不可关闭。二级缓存的配置是开发者可干预的，在 <code>xml</code> 文件或注解中针对 <code>namespace</code> 的缓存配置就是二级缓存配置。</li>
<li>一级缓存在执行器中维护，即不同 <code>sql</code> 会话不能共享一级缓存。二级缓存则是根据 <code>namespace</code> 维护，不同 <code>sql</code> 会话是可以共享二级缓存的。</li>
</ul>
<p><code>CachingExecutor</code> 中的方法大多是通过直接调用其代理的执行器来实现的，而查询操作则会先查询二级缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存事务管理器
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionalCacheManager</span> <span style=color:#000>tcm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransactionalCacheManager</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 查询二级缓存配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>flushCacheIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isUseCache</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultHandler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 当前 statement 配置使用二级缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ensureNoOutParams</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 二级缓存中没用数据，调用代理执行器
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 将查询结果放入二级缓存
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// issue #578 and #116
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 无二级缓存配置，调用代理执行器获取结果
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flushCacheIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFlushCacheRequired</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存在 namespace 对应的缓存配置，且当前 statement 配置了刷新缓存，执行清空缓存操作
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 非 select 语句配置了默认刷新
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果对应的 <code>statement</code> 的二级缓存配置有效，则会先通过缓存事务管理器 <code>TransactionalCacheManager</code> 查询二级缓存，如果没有命中则查询一级缓存，仍没有命中才会执行数据库查询。</p>
<h3 id=缓存事务管理器>缓存事务管理器</h3>
<p>缓存执行器对二级缓存的维护是基于缓存事务管理器 <code>TransactionalCacheManager</code> 的，其内部维护了一个 <code>Map</code> 容器，用于保存 <code>namespace</code> 缓存配置与事务缓存对象的映射关系。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TransactionalCacheManager</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存配置 - 缓存事务对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionalCache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>transactionalCaches</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 清除缓存
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param cache
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取缓存
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 写缓存
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存提交
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionalCache</span> <span style=color:#000>txCache</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>transactionalCaches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>txCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存回滚
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionalCache</span> <span style=color:#000>txCache</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>transactionalCaches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>txCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取或新建事务缓存对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionalCache</span> <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>transactionalCaches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionalCache</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#204a87;font-weight:700>new</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>缓存配置映射的事务缓存对象就是前文中提到过的事务缓存装饰器 <code>TransactionalCache</code>。<code>getTransactionalCache</code> 会从维护容器中查找对应的事务缓存对象，如果找不到就创建一个事务缓存对象，即通过事务缓存对象装饰当前缓存配置。</p>
<p>查询缓存时，如果缓存未命中，则将对应的 <code>key</code> 放入未命中队列，执行数据库查询完毕后写缓存时并不是立刻写到缓存配置的本地容器中，而是暂时放入待提交队列中，当触发事务提交时才将提交队列中的缓存数据写到缓存配置中。如果发生回滚，则提交队列中的数据会被清空，从而保证了数据的一致性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// issue #116
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 放入未命中缓存的 key 的队列
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>entriesMissedInCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// issue #146
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clearOnCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 缓存先写入待提交容器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>entriesToAddOnCommit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务提交
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clearOnCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 提交缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>flushPendingEntries</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务回滚
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>unlockMissedEntries</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务提交，提交待提交的缓存。
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flushPendingEntries</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entriesToAddOnCommit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entriesMissedInCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>entriesToAddOnCommit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务回滚，清理未命中缓存。
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>unlockMissedEntries</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entriesMissedInCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unexpected exception while notifiying a rollback to the cache adapter.&#34;</span>
            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;Consider upgrading your cache adapter to the latest version.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=二级缓存与一级缓存的互斥性>二级缓存与一级缓存的互斥性</h3>
<p>使用二级缓存要求无论是否配置了事务自动提交，在执行完成后， <code>sql</code> 会话必须手动提交事务才能触发事务缓存管理器维护缓存到缓存配置中，否则二级缓存无法生效。而缓存执行器在触发事务提交时，不仅会调用事务缓存管理器提交，还会调用代理执行器提交事务：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 代理执行器提交
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 事务缓存管理器提交
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代理执行器的事务提交方法继承自 <code>BaseExecutor</code>，其 <code>commit</code> 方法中调用了 <code>clearLocalCache</code> 方法清除本地一级缓存。因此二级缓存和一级缓存的使用是互斥的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cannot commit, transaction is already closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 清除本地一级缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>flushStatements</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p><code>MyBatis</code> 提供若干执行器封装底层 <code>JDBC</code> 操作和结果集转换，并嵌入 <code>sql</code> 会话维度的一级缓存和 <code>namespace</code> 维度的二级缓存。接口层可以通过调用不同类型的执行器来完成 <code>sql</code> 相关操作。</p>
<ul>
<li><code>org.apache.ibatis.executor.Executor</code>：数据库操作执行器抽象接口。</li>
<li><code>org.apache.ibatis.executor.BaseExecutor</code>：执行器基础抽象实现。</li>
<li><code>org.apache.ibatis.executor.SimpleExecutor</code>：简单类型执行器。</li>
<li><code>org.apache.ibatis.executor.ReuseExecutor</code>：<code>statement</code> 复用执行器。</li>
<li><code>org.apache.ibatis.executor.BatchExecutor</code>：批量执行器。</li>
<li><code>org.apache.ibatis.executor.CachingExecutor</code>：二级缓存执行器。</li>
<li><code>org.apache.ibatis.executor.statement.StatementHandler</code>：<code>statement</code> 处理器抽象接口。</li>
<li><code>org.apache.ibatis.executor.statement.BaseStatementHandler</code>：<code>statement</code> 处理器基础抽象实现。</li>
<li><code>org.apache.ibatis.executor.statement.RoutingStatementHandler</code>：<code>statement</code> 处理器路由对象。</li>
<li><code>org.apache.ibatis.executor.statement.SimpleStatementHandler</code>：简单 <code>statement</code> 处理器。</li>
<li><code>org.apache.ibatis.executor.statement.PreparedStatementHandler</code>：预编译 <code>statement</code> 处理器。</li>
<li><code>org.apache.ibatis.executor.statement.CallableStatementHandler</code>：存储过程 <code>statement</code> 处理器。</li>
<li><code>org.apache.ibatis.cache.TransactionalCacheManager</code>：缓存事务管理器。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dd0af738f6f6eeb4e6c0c4aeb3162eaa>4.9 - CH09-集成 Spring</h1>
<p><code>mybatis-spring</code> 是 <code>MyBatis</code> 的一个子项目，用于帮助开发者将 <code>MyBatis</code> 无缝集成到 <code>Spring</code> 中。它允许 <code>MyBatis</code> 参与到 <code>Spring</code> 的事务管理中，创建映射器 <code>mapper</code> 和 <code>SqlSession</code> 并注入到 <code>Spring bean</code> 中。</p>
<h2 id=sqlsessionfactorybean>SqlSessionFactoryBean</h2>
<p>在 <code>MyBatis</code> 的基础用法中，是通过 <code>SqlSessionFactoryBuilder</code> 来创建 <code>SqlSessionFactory</code>，最终获得执行接口 <code>SqlSession</code> 的，而在 <code>mybatis-spring</code> 中，则使用 <code>SqlSessionFactoryBean</code> 来创建。其使用方式如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Bean</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBean</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置配置文件路径
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConfigLocation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;config/mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 别名转化类所在的包
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTypeAliasesPackage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.wch.domain&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置数据源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置 mapper 文件路径
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMapperLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mapper/*.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 获取 SqlSessionFactory 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>SqlSessionFactoryBean</code> 实现了 <code>FactoryBean</code> 接口，因此可以通过其 <code>getObject</code> 方法获取 <code>SqlSessionFactory</code> 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;dataSource&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;sqlSessionFactoryBuilder&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
      <span style=color:#4e9a06>&#34;Property &#39;configuration&#39; and &#39;configLocation&#39; can not specified with together&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>buildSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Configuration</span> <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>XMLConfigBuilder</span> <span style=color:#000>xmlConfigBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configuration</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 使用已配置的全局配置对象和附加属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>targetConfiguration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configuration</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 使用配置文件路径加载全局配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>xmlConfigBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>targetConfiguration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xmlConfigBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 新建全局配置对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Property &#39;configuration&#39; or &#39;configLocation&#39; not specified, using default MyBatis Configuration&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>targetConfiguration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setVariables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置对象创建工厂、对象包装工厂、虚拟文件系统实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFactory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setObjectFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setObjectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>vfs</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setVfsImpl</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 以包的维度注册别名转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliasesPackage</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 扫描之类包下的符合条件的类对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>scanClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliasesPackage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliasesSuperType</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#8f5902;font-style:italic>// 过滤匿名类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤成员类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMemberClass</span><span style=color:#ce5c00;font-weight:700>()).</span>
        <span style=color:#8f5902;font-style:italic>// 注册别名转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>()::</span><span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 以类的维度注册别名转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliases</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliases</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAlias</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 注册类对象到别名转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAlias</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered type alias: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeAlias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置插件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>plugins</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>plugins</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>plugin</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>plugin</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered plugin: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>plugin</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 以包的维度注册类型转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlersPackage</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 扫描指定包下 TypeHandler 的子类
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>scanClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlersPackage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span>
        <span style=color:#8f5902;font-style:italic>// 过滤匿名类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤抽象类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()))</span>
        <span style=color:#8f5902;font-style:italic>// 注册类对象到类型转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>()::</span><span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 以类的维度注册类型转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlers</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 注册类对象到类型转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered type handler: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 注册脚本语言驱动
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scriptingLanguageDrivers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scriptingLanguageDrivers</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>languageDriver</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLanguageRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>languageDriver</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered scripting language driver: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>languageDriver</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultScriptingLanguageDriver</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setDefaultScriptingLanguage</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 配置数据库产品识别转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// fix #64 set databaseId before parse mapper xmls
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>databaseIdProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedIOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed getting a databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置缓存配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>addCache</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 如果设置了配置文件路径，则解析并加载到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xmlConfigBuilder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>xmlConfigBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Parsed configuration file: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedIOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to parse config resource: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置数据源环境
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringManagedTransactionFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#8f5902;font-style:italic>// 解析 xml statement 文件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperLocations</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperLocations</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Property &#39;mapperLocations&#39; was specified but matching resources are not found.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperLocations</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>xmlMapperBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperLocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>(),</span>
              <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperLocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>xmlMapperBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedIOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to parse mapping resource: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Parsed mapper file: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Property &#39;mapperLocations&#39; was not specified.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 创建 sql 会话工厂
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>buildSqlSessionFactory</code> 方法会分别对配置文件、别名转换类、<code>mapper</code> 文件等进行解析，逐步配置全局配置对象，并最终调用 <code>SqlSessionFactoryBuilder</code> 创建 <code>SqlSessionFactory</code> 对象。</p>
<h2 id=sqlsessiontemplatge>SqlSessionTemplatge</h2>
<p>在前章分析 <code>MyBatis</code> 接口层时说到 <code>SqlSessionManager</code> 通过 <code>JDK</code> 动态代理为每个线程创建不同的 <code>SqlSession</code> 来解决 <code>DefaultSqlSession</code> 的线程不安全问题。<code>mybatis-spring</code> 的实现与 <code>SqlSessionManager</code> 大致相同，但是其提供了更好的方式与 <code>Spring</code> 事务集成。</p>
<p><code>SqlSessionTemplate</code> 实现了 <code>SqlSession</code> 接口，但是都是委托给成员对象 <code>sqlSessionProxy</code> 来实现的。<code>sqlSessionProxy</code> 在构造方法中使用 <code>JDK</code> 动态代理初始化为代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutorType</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>PersistenceExceptionTranslator</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;sqlSessionFactory&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;executorType&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionInterceptor</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>sqlSessionProxy</code> 的代理逻辑如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SqlSessionInterceptor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取 sqlSession
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 执行原始调用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isSqlSessionTransactional</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 如果事务没有交给外部事务管理器管理，进行提交
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Throwable</span> <span style=color:#000>unwrapped</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>unwrapped</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>PersistenceException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 异常为 PersistenceException，使用配置的 exceptionTranslator 来包装异常
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>closeSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#000>Throwable</span> <span style=color:#000>translated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>translateExceptionIfPossible</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>PersistenceException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>unwrapped</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>translated</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>unwrapped</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>translated</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>unwrapped</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 关闭 sql session
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>closeSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=获取-sqlsession>获取 SqlSession</h3>
<p>在执行原始调用前会先根据 <code>SqlSessionUtils#getSqlSession</code> 方法获取 <code>SqlSession</code>，如果通过事务同步管理器 <code>TransactionSynchronizationManager</code> 获取不到 <code>SqlSession</code>，就会使用 <code>SqlSessionFactory</code> 新建一个 <code>SqlSession</code>，并尝试将获取的 <code>SqlSession</code> 注册到 <code>TransactionSynchronizationManager</code> 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SqlSession</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutorType</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>PersistenceExceptionTranslator</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// SqlSessionFactory 和 ExecutorType 参数不可为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_SQL_SESSION_FACTORY_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_EXECUTOR_TYPE_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 尝试从事务同步管理器中获取 SqlSessionHolder
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSessionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionHolder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>TransactionSynchronizationManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 SqlSession
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSession</span> <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sessionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 新建 SqlSession
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Creating a new SqlSession&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 将新建的 SqlSession 注册到事务同步管理器中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>registerSessionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=事务同步管理器>事务同步管理器</h4>
<p>每次获取 <code>SqlSession</code> 时是新建还是从事务同步管理器中获取决于事务同步管理器是否开启。事务同步管理器用于维护当前线程的同步资源，如判断当前线程是否已经开启了一个事务就需要查询事务同步管理器，以便后续根据事务传播方式决定是新开启一个事务或加入当前事务。<code>Spring</code> 支持使用注解开启事务或编程式事务。</p>
<h5 id=注解开启事务>注解开启事务</h5>
<p>在 <code>Spring</code> 工程中可以通过添加 <code>EnableTransactionManagement</code> 注解来开启 <code>Spring</code> 事务管理。<code>EnableTransactionManagement</code> 注解的参数 <code>mode = AdviceMode.PROXY</code> 默认指定了加载代理事务管理器配置 <code>ProxyTransactionManagementConfiguration</code>，在此配置中其默认地对使用 <code>Transactional</code> 注解的方法进行 <code>AOP</code> 代理。在代理逻辑中，会调用 <code>AbstractPlatformTransactionManager#getTransaction</code> 方法获取当前线程对应的事务，根据当前线程是否有活跃事务、事务传播属性等来配置事务。如果是新创建事务，就会调用 <code>TransactionSynchronizationManager#initSynchronization</code> 方法来初始化当前线程在事务同步管理器中的资源。</p>
<h5 id=编程式事务>编程式事务</h5>
<p>编程开启事务的方式与注解式其实是一样的，区别在于编程式需要手动开启事务，其最终也会为当前线程在事务同步管理器中初始化资源。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// 手动开启事务
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>TransactionStatus</span> <span style=color:#000>txStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultTransactionDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// invoke...
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>transactionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>transactionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=sqlsession-注册>SqlSession 注册</h4>
<p>如果当前方法开启了事务，那么创建的 <code>SqlSession</code> 就会被注册到事务同步管理器中。<code>SqlSession</code> 会首先被包装为 <code>SqlSessionHolder</code>，其还包含了 <code>SqlSession</code> 对应的执行器类型、异常处理器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>TransactionSynchronizationManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bindResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#8f5902;font-style:italic>// ...
</span></code></pre></div><p>随后 <code>SqlSessionHolder</code> 对象通过 <code>TransactionSynchronizationManager#bindResource</code> 方法绑定到事务同步管理器中，其实现为将 <code>SqlSessionFactory</code> 和 <code>SqlSessionHolder</code> 绑定到 <code>ThreadLocal</code> 中，从而完成了线程到 <code>SqlSessionFactory</code> 到 <code>SqlSession</code> 的映射。</p>
<h3 id=事务提交与回滚>事务提交与回滚</h3>
<p>如果事务是交给 <code>Spring</code> 事务管理器管理的，那么<code>Spring</code> 会自动在执行成功或异常后对当前事务进行提交或回滚。如果没有配置 <code>Spring</code> 事务管理，那么将会调用 <code>SqlSession</code> 的 <code>commit</code> 方法对事务进行提交。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isSqlSessionTransactional</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 未被事务管理器管理，设置提交
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>而 <code>SqlSessionTemplate</code> 是不允许用来显式地提交或回滚的，其提交或回滚的方法实现为直接抛出 <code>UnsupportedOperationException</code> 异常。</p>
<h3 id=关闭-sqlsession>关闭 SqlSession</h3>
<p>在当前调用结束后 <code>SqlSessionTemplate</code> 会调动 <code>closeSqlSession</code> 方法来关闭 <code>SqlSession</code>，如果事务同步管理器中存在当前线程绑定的 <code>SqlSessionHolder</code>，即当前调用被事务管理器管理，则将 <code>SqlSession</code> 的持有释放掉。如果没被事务管理器管理，则会真实地关闭 <code>SqlSession</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_SQL_SESSION_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_SQL_SESSION_FACTORY_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>SqlSessionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionHolder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>TransactionSynchronizationManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 被事务管理器管理，释放 SqlSession
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Releasing transactional SqlSession [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>released</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 真实地关闭 SqlSesion
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Closing non transactional SqlSession [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=映射器>映射器</h2>
<h3 id=单个映射器>单个映射器</h3>
<p>在 <code>MyBatis</code> 的基础用法中，<code>MyBatis</code> 配置文件支持使用 <code>mappers</code> 标签的子元素 <code>mapper</code> 或 <code>package</code> 来指定需要扫描的 <code>mapper</code> 接口。被扫描到的接口类将被注册到 <code>MapperRegistry</code> 中，通过 <code>MapperRegistry#getMapper</code> 方法可以获得 <code>Mapper</code> 接口的代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapperProxyFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperProxyFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Type &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is not known to the MapperRegistry.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 生成 mapper 接口的代理类
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error getting mapper instance. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代理类的方式可以使得 <code>statement</code> 的 <code>id</code> 直接与接口方法的全限定名关联，消除了 <code>mapper</code> 接口实现类的样板代码。但是此种方式在每次获取 <code>mapper</code> 代理类的时候都需要指定 <code>sqlSession</code> 对象，而 <code>mybatis-spring</code> 中的 <code>sqlSession</code> 对象是 <code>SqlSessionTemplate</code> 代理创建的，为了适配代理逻辑，<code>mybatis-spring</code> 提供了 <code>MapperFactoryBean</code> 来创建代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Bean</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserMapper</span> <span style=color:#000>userMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MapperFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserMapper</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>factoryBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>UserMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>factoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>MapperFactoryBean</code> 继承了 <code>SqlSessionDaoSupport</code>，其会根据传入的 <code>SqlSessionFactory</code> 来创建 <code>SqlSessionTemplate</code>，并使用 <code>SqlSessionTemplate</code> 来生成代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 使用 SqlSessionTemplate 来创建代理类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSession</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=批量映射器>批量映射器</h3>
<p>每次手动获取单个映射器的效率是低下的，<code>MyBatis</code> 还提供了 <code>MapperScan</code> 注解用于批量扫描 <code>mapper</code> 接口并通过 <code>MapperFactoryBean</code> 创建代理类，注册为 <code>Spring bean</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.spring.sample.mapper&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>MapperScan</code> 注解解析后注册 <code>Spring bean</code> 的逻辑是由 <code>MapperScannerConfigure</code> 实现的，其实现 了 <code>BeanDefinitionRegistryPostProcessor</code> 接口的 <code>postProcessBeanDefinitionRegistry</code> 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#000>ClassPathMapperScanner</span> <span style=color:#000>scanner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathMapperScanner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>scanner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scan</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>basePackage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConfigurableApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIG_LOCATION_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扫描逻辑由 <code>ClassPathMapperScanner</code> 提供，其继承了 <code>ClassPathBeanDefinitionScanner</code> 扫描指定包下的类并注册为 <code>BeanDefinitionHolder</code> 的能力。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>beanCountAtScanStart</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// 扫描指定包并注册 bean definion
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// Register annotation config processors, if necessary.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeAnnotationConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAnnotationConfigProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beanCountAtScanStart</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 扫描指定包已经获取的 bean 定义
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;No MyBatis mapper was found in &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span>
          <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; package. Please check your configuration.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 增强 bean 配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>GenericBeanDefinition</span> <span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>definition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GenericBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 设置 bean class 类型为 MapperFactoryBean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperFactoryBeanClass</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>获取到指定 <code>bean</code> 的定义后，重新设置 <code>beanClass</code> 为 <code>MapperFactoryBean</code>，因此在随后的 <code>bean</code> 初始化中，这些被扫描的 <code>mapper</code> 接口可以创建代理类并被注册到 <code>Spring</code> 容器中。</p>
<p>映射器注册完成后，就可以使用引用 <code>Spring bean</code> 的配置来使用 <code>mapper</code> 接口。</p>
<h2 id=总结>总结</h2>
<p><code>mybatis-spring</code> 提供了与 <code>Spring</code> 集成的更高层次的封装。</p>
<ul>
<li><code>SqlSessionFactoryBean</code> 遵循 <code>Spring FactoryBean</code> 的定义，使得 <code>SqlSessionFactory</code> 注册在 <code>Spring</code> 容器中。</li>
<li><code>SqlSessionTemplate</code> 是 <code>SqlSession</code> 另一种线程安全版本的实现，并且能够更好地与 <code>Spring</code> 事务管理集成。</li>
<li><code>MapperFactoryBean</code> 是生成 <code>mapper</code> 接口代理类的 <code>SqlSessionTemplate</code> 版本实现。</li>
<li><code>MapperScannerConfigurer</code> 简化了生成 <code>mapper</code> 接口代理的逻辑，指定扫描的包即可将生成 <code>mapper</code> 接口代理类并注册为 <code>Spring bean</code>。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-08516932d642ae0a720b5753a346bba3>4.10 - CH10-整体流程</h1>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/iShot2021-10-10%2016.22.29.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=1-通过-resource-加载配置>1. 通过 Resource 加载配置</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.io.Resources</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.session.SqlSession</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.session.SqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.session.SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyBatisUtils</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SqlSession</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=2-实例化-sqlsessionfactorybuilder-构造器>2. 实例化 sqlSessionFactoryBuilder 构造器</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h2 id=3-通过-build-中-xmlconfigbuilder-类解析文件流以及环境和属性>3. 通过 build 中 XmlConfigBuilder 类解析文件流以及环境和属性</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>XMLConfigBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><h2 id=4-将配置信息存放到-configuration-中>4. 将配置信息存放到 Configuration 中</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=5-实例化-sqlsessionfactory-实现类-defaultsqlsessionfactory>5. 实例化 SqlSessionFactory 实现类 DefaultSqlSessionFactory</h2>
<h2 id=6-由-transactionfactory-创建一个-transaction-事务对象>6. 由 TransactionFactory 创建一个 Transaction 事务对象</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010162704.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=7-创建执行器-excutor执行-mapper>7. 创建执行器 Excutor，执行 mapper</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010162729.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=8-创建-sqlsession-接口实现类-defaultsqlsession>8. 创建 SqlSession 接口实现类 DefaultSqlSession</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MybatisUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#000>UserMapper</span> <span style=color:#000>mapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h2 id=9-执行-crud>9. 执行 CRUD</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010162814.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=10-判断是否成功失败则回滚到事务提交器>10. 判断是否成功，失败则回滚到事务提交器</h2>
<h2 id=11-提交事务>11. 提交事务</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h2 id=12-关闭>12. 关闭</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-14222f79d12931239488c3ab405189f6>4.11 - CH11-插件机制</h1>
<p><code>MyBatis</code>支持用插件对四大核心组件进行拦截，对<code>MyBatis</code>来说插件就是拦截器，用来增强核心组件的功能，增强功能本质上是借助于底层的动态代理实现的，换句话说，<code>MyBatis</code>中的四大对象都是代理对象。</p>
<p>-<code>ParameterHandler</code>：处理SQL的参数的类
-<code>ResultSetHandler</code>：处理SQL的返回结果集的类
-<code>StatementHandler</code>：处理数据库SQL语句的类
-<code>Executor</code>：用于执行增删改查操作的执行器类</p>
<h2 id=插件原理>插件原理</h2>
<ol>
<li><code>MyBatis</code>的插件借助于<strong>责任链</strong>的模式进行对拦截的处理</li>
<li>使用<code>动态代理</code>对目标对象进行包装，达到拦截的目的</li>
</ol>
<h2 id=拦截>拦截</h2>
<p>插件具体是如何拦截并附加额外的功能的呢？以<code>ParameterHandler</code>来说：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ParameterHandlernewParameterHandler</span><span style=color:#ce5c00;font-weight:700>(</span>
  	<span style=color:#000>MappedStatement</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span>
  	<span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span>
  	<span style=color:#000>BoundSql</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span>
  	<span style=color:#000>InterceptorChain</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>){</span>
	<span style=color:#000>ParameterHandler</span> <span style=color:#000>parameterHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLang</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createParameterHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>parameterHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parameterHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Objecttarget</span><span style=color:#ce5c00;font-weight:700>){</span>
	<span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Interceptorinterceptor</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>){</span>
		<span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>plugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>interceptorChain</code>保存了所有的拦截器(interceptors)，是<code>MyBatis</code>初始化的时候创建的。</p>
<p>调用拦截器链中的拦截器依次的对目标进行拦截或增强。</p>
<p><code>interceptor.plugin(target)</code> 中的 target 就可以理解为<code>MyBatis</code>中的四大组件，返回的target是被重重代理后的对象。</p>
<h2 id=插件接口interceptor>插件接口Interceptor</h2>
<ol>
<li><code>intercept()</code>方法，插件的核心方法</li>
<li><code>plugin()</code>方法，生成target的代理对象</li>
<li><code>setProperties()</code>方法，传递插件所需参数</li>
</ol>
<h2 id=插件实例>插件实例</h2>
<p>插件开发需要以下步骤</p>
<ol>
<li>自定义插件需要实现上述接口</li>
<li>增加@Intercepts注解（声明是哪个核心组件的插件，以及对哪些方法进行扩展）</li>
<li>在xml文件中配置插件</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>**</span>
<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>插件签名</span><span style=color:#a40000>，</span><span style=color:#000>告诉MyBatis插件用来拦截那个对象的哪个方法</span>
<span style=color:#ce5c00;font-weight:700>**/</span>
<span style=color:#5c35cc;font-weight:700>@Intercepts</span><span style=color:#ce5c00;font-weight:700>({</span>
	<span style=color:#5c35cc;font-weight:700>@Signature</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>StatementHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;parameterize&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyInterceptsimplementsInterceptor</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>  *拦截目标对象的目标方法
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  *@paraminvocation
</span><span style=color:#8f5902;font-style:italic>  *@return
</span><span style=color:#8f5902;font-style:italic>  *@throwsThrowable
</span><span style=color:#8f5902;font-style:italic>  */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;进入自定义的拦截器，拦截目标对象&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTarget</span><span style=color:#ce5c00;font-weight:700>());</span>
  	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>  *包装目标对象为目标对象创建代理对象
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  *@Paramtarget为要拦截的对象
</span><span style=color:#8f5902;font-style:italic>  *@Return代理对象
</span><span style=color:#8f5902;font-style:italic>  */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>plugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>){</span>
  	<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;自定义plugin方法，将要包装的目标对象&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
  	<span style=color:#000>returnPlugin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>  *获取配置文件的属性
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  *@paramproperties
</span><span style=color:#8f5902;font-style:italic>  */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>){</span>
  	<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;自定义插件的初始化参数&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在mybatis-config.xml中配置插件</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>    <span style=color:#8f5902;font-style:italic>&lt;!--自定义插件--&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;plugininterceptor</span><span style=color:#a40000>=&#34;com.boxuegu.javaee.mybatissourcelearn.MyIntercepts&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;propertyname</span><span style=color:#a40000>=&#34;test&#34;</span><span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;testvalue&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</code></pre></div><p>调用查询方法，查询方法会返回ResultSet</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#8f5902;font-style:italic>//1.加载配置文件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOExceptione</span><span style=color:#ce5c00;font-weight:700>){</span>
    	<span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
  	<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//2.获取sqlSessionFactory
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>=</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>//3.获取sqlSession
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//通过xml文件直接执行sql语句
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//Employeeemployee=sqlSession.selectOne(&#34;com.boxuegu.javaee.mybatissourcelearn.dao.EmployeeMapper.getEmployeeById&#34;,1);
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//alt+shift+Lintroducelocalvariables;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>newThread</span><span style=color:#ce5c00;font-weight:700>(()-&gt;</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>//4.获取mapper接口实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>EmployeeMapper</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmployeeMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mapper::::&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#8f5902;font-style:italic>//5.执行sql语句
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Employee</span> <span style=color:#000>employee</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEmployeeById</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>employee</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>finally</span><span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=多插件开发>多插件开发</h2>
<ol>
<li>创建代理对象时，按照插件配置的顺序进行包装</li>
<li>执行目标方法后，是按照代理的逆向进行执行</li>
</ol>
<h2 id=总结>总结</h2>
<p>1.遵循插件尽量不使用的原则，因为会修改底层设计</p>
<p>2.插件是生成的层层代理对象的责任链模式，使用反射机制实现</p>
<p>3.插件的编写要考虑全面，特别是多个插件层层代理的时候</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-68611e2d64eb5f1709d53542acbd61f4>4.12 - CH12-代码生成</h1>
<h2 id=运行方式>运行方式</h2>
<p><code>Mybatis-Generator</code>的运行方式有很多种：</p>
<ul>
<li>基于<code>mybatis-generator-core-x.x.x.jar</code>和其<code>XML</code>配置文件，通过命令行运行。</li>
<li>通过<code>Ant</code>的<code>Task</code>结合其<code>XML</code>配置文件运行。</li>
<li>通过<code>Maven</code>插件运行。</li>
<li>通过<code>Java</code>代码和其<code>XML</code>配置文件运行。</li>
<li>通过<code>Java</code>代码和编程式配置运行。</li>
<li>通过<code>Eclipse Feature</code>运行。</li>
</ul>
<p>这里只介绍通过<code>Maven</code>插件运行和通过<code>Java</code>代码和其<code>XML</code>配置文件运行这两种方式，两种方式有个特点：都要提前编写好<code>XML</code>配置文件。个人感觉<code>XML</code>配置文件相对直观，后文会花大量篇幅去说明<code>XML</code>配置文件中的配置项及其作用。这里先注意一点：默认的配置文件为<code>ClassPath:generatorConfig.xml</code>。</p>
<h3 id=通过编码和配置文件运行>通过编码和配置文件运行</h3>
<p>通过编码方式去运行插件先需要引入<code>mybatis-generator-core</code>依赖，编写本文的时候最新的版本为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.mybatis.generator<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>mybatis-generator-core<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.4.0<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>假设编写好的<code>XML</code>配置文件是<code>ClassPath</code>下的<code>generator-configuration.xml</code>，那么使用代码生成器的编码方式大致如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>warnings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#8f5902;font-style:italic>// 如果已经存在生成过的文件是否进行覆盖
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>overwrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>File</span> <span style=color:#000>configFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ClassPath路径/generator-configuration.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ConfigurationParser</span> <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Configuration</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configFile</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>DefaultShellCallback</span> <span style=color:#000>callback</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultShellCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overwrite</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>MyBatisGenerator</span> <span style=color:#000>generator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyBatisGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>callback</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h3 id=通过-maven-插件运行>通过 Maven 插件运行</h3>
<p>如果使用<code>Maven</code>插件，那么<strong>不需要</strong>引入<code>mybatis-generator-core</code>依赖，只需要引入一个<code>Maven</code>的插件<code>mybatis-generator-maven-plugin</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.mybatis.generator<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>mybatis-generator-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.4.0<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;executions&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;execution&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>Generate MyBatis Artifacts<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;goals&gt;</span>
                    <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>generate<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;/goals&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;/execution&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/executions&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
            <span style=color:#8f5902;font-style:italic>&lt;!-- 输出详细信息 --&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;verbose&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/verbose&gt;</span>
            <span style=color:#8f5902;font-style:italic>&lt;!-- 覆盖生成文件 --&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;overwrite&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/overwrite&gt;</span>
            <span style=color:#8f5902;font-style:italic>&lt;!-- 定义配置文件 --&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;configurationFile&gt;</span>${basedir}/src/main/resources/generator-configuration.xml<span style=color:#204a87;font-weight:700>&lt;/configurationFile&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</code></pre></div><h2 id=xml-配置详解>XML 配置详解</h2>
<p><code>XML</code>配置文件才是<code>Mybatis-Generator</code>的核心，它用于控制代码生成的所有行为。所有非标签独有的公共配置的<code>Key</code>可以在<code>mybatis-generator-core</code>的<code>PropertyRegistry</code>类中找到。下面是一个相对完整的配置文件的模板：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!DOCTYPE generatorConfiguration
</span><span style=color:#8f5902;font-style:italic>  PUBLIC &#34;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&#34;
</span><span style=color:#8f5902;font-style:italic>  &#34;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&#34;&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;generatorConfiguration&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;properties</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;db.properties&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;classPathEntry</span> <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;/Program Files/IBM/SQLLIB/java/db2java.zip&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;DB2Tables&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;jdbcConnection</span> <span style=color:#c4a000>driverClass=</span><span style=color:#4e9a06>&#34;COM.ibm.db2.jdbc.app.DB2Driver&#34;</span>
        <span style=color:#c4a000>connectionURL=</span><span style=color:#4e9a06>&#34;jdbc:db2:TEST&#34;</span>
        <span style=color:#c4a000>userId=</span><span style=color:#4e9a06>&#34;db2admin&#34;</span>
        <span style=color:#c4a000>password=</span><span style=color:#4e9a06>&#34;db2admin&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/jdbcConnection&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;plugin</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;org.mybatis.generator.plugins.SerializablePlugin&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;commentGenerator&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressDate&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressAllComments&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/commentGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;javaTypeResolver&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;forceBigDecimals&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/javaTypeResolver&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;javaModelGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;test.model&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;\MBGTestProject\src&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;trimStrings&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/javaModelGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;sqlMapGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;test.xml&#34;</span>  <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;\MBGTestProject\src&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/sqlMapGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;XMLMAPPER&#34;</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;test.dao&#34;</span>  <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;\MBGTestProject\src&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/javaClientGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;table</span> <span style=color:#c4a000>schema=</span><span style=color:#4e9a06>&#34;DB2ADMIN&#34;</span> <span style=color:#c4a000>tableName=</span><span style=color:#4e9a06>&#34;ALLTYPES&#34;</span> <span style=color:#c4a000>domainObjectName=</span><span style=color:#4e9a06>&#34;Customer&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;useActualColumnNames&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;generatedKey</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;ID&#34;</span> <span style=color:#c4a000>sqlStatement=</span><span style=color:#4e9a06>&#34;DB2&#34;</span> <span style=color:#c4a000>identity=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;columnOverride</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;DATE_FIELD&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;startDate&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;ignoreColumn</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;FRED&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;columnOverride</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;LONG_VARCHAR_FIELD&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/table&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;/context&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/generatorConfiguration&gt;</span>
</code></pre></div><p>配置文件中，最外层的标签为<code>&lt;generatorConfiguration></code>，它的子标签包括：</p>
<ul>
<li>0或者1个<code>&lt;properties></code>标签，用于指定全局配置文件，下面可以通过占位符的形式读取<code>&lt;properties></code>指定文件中的值。</li>
<li>0或者N个<code>&lt;classPathEntry></code>标签，<code>&lt;classPathEntry></code>只有一个<code>location</code>属性，用于指定数据源驱动包（<code>jar</code>或者<code>zip</code>）的绝对路径，具体选择什么驱动包取决于连接什么类型的数据源。</li>
<li>1或者N个<code>&lt;context></code>标签，用于运行时的解析模式和具体的代码生成行为，所以这个标签里面的配置是最重要的。</li>
</ul>
<p>下面分别列举和分析一下<code>&lt;context></code>标签和它的主要子标签的一些属性配置和功能。</p>
<h3 id=context-标签>context 标签</h3>
<p><code>&lt;context></code>标签在<code>mybatis-generator-core</code>中对应的实现类为<code>org.mybatis.generator.config.Context</code>，它除了大量的子标签配置之外，比较主要的属性是：</p>
<ul>
<li><code>id</code>：<code>Context</code>示例的唯一<code>ID</code>，用于输出错误信息时候作为唯一标记。</li>
<li><code>targetRuntime</code>：用于执行代码生成模式。</li>
<li><code>defaultModelType</code>：控制 Domain 类的生成行为。执行引擎为 MyBatis3DynamicSql 或者 MyBatis3Kotlin 时忽略此配置，可选值：
<ul>
<li><code>conditional</code>：默认值，类似<code>hierarchical</code>，但是只有一个主键的时候会合并所有属性生成在同一个类。</li>
<li><code>flat</code>：所有内容全部生成在一个对象中。</li>
<li><code>hierarchical</code>：键生成一个XXKey对象，Blob等单独生成一个对象，其他简单属性在一个对象中。</li>
</ul>
</li>
<li><code>targetRuntime</code>属性的可选值比较多，这里做个简单的小结：</li>
</ul>
<p>属性：</p>
<ul>
<li>MyBatis3DynamicSql：默认值，兼容 JDK8+ 和 MyBatis 3.4.2+，不会生成 XML 映射文件，忽略 <code>&lt;sqlMapGenerator></code> 的配置项，也就是 Mapper 全部注解化，依赖于 MyBatis Dynamic SQL 类库。</li>
<li>MyBatis3Kotlin：行为类似于 MyBatis3DynamicSql，不过兼容 Kotlin 的代码生成。</li>
<li>MyBatis3：提供基本的基于动态 SQL 的 CRUD 方法和 XXXByExample 方法，会生成 XML 映射文件。</li>
<li>MyBatis3Simple：提供基本的基于动态 SQL 的 CRUD 方法，会生成 XML 映射文件。</li>
<li>MyBatis3DynamicSqlV1：已经过时，不推荐使用。</li>
</ul>
<p>笔者偏向于把<code>SQL</code>文件和代码分离，所以一般选用<code>MyBatis3</code>或者<code>MyBatis3Simple</code>。例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div><p><code>&lt;context></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>autoDelimitKeywords</code></td>
<td style=text-align:left>是否使用分隔符号括住数据库关键字</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>例如<code>MySQL</code>中会使用反引号括住关键字</td>
</tr>
<tr>
<td style=text-align:left><code>beginningDelimiter</code></td>
<td style=text-align:left>分隔符号的开始符号</td>
<td style=text-align:left><code>"</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>endingDelimiter</code></td>
<td style=text-align:left>分隔符号的结束号</td>
<td style=text-align:left><code>"</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>javaFileEncoding</code></td>
<td style=text-align:left>文件的编码</td>
<td style=text-align:left><code>系统默认值</code></td>
<td style=text-align:left>来源于<code>java.nio.charset.Charset</code></td>
</tr>
<tr>
<td style=text-align:left><code>javaFormatter</code></td>
<td style=text-align:left>类名和文件格式化器</td>
<td style=text-align:left><code>DefaultJavaFormatter</code></td>
<td style=text-align:left>见<code>JavaFormatter</code>和<code>DefaultJavaFormatter</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetJava8</code></td>
<td style=text-align:left>是否JDK8和启动其特性</td>
<td style=text-align:left><code>true</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>kotlinFileEncoding</code></td>
<td style=text-align:left><code>Kotlin</code>文件编码</td>
<td style=text-align:left><code>系统默认值</code></td>
<td style=text-align:left>来源于<code>java.nio.charset.Charset</code></td>
</tr>
<tr>
<td style=text-align:left><code>kotlinFormatter</code></td>
<td style=text-align:left><code>Kotlin</code>类名和文件格式化器</td>
<td style=text-align:left><code>DefaultKotlinFormatter</code></td>
<td style=text-align:left>见<code>KotlinFormatter</code>和<code>DefaultKotlinFormatter</code></td>
</tr>
<tr>
<td style=text-align:left><code>xmlFormatter</code></td>
<td style=text-align:left><code>XML</code>文件格式化器</td>
<td style=text-align:left><code>DefaultXmlFormatter</code></td>
<td style=text-align:left>见<code>XmlFormatter</code>和<code>DefaultXmlFormatter</code></td>
</tr>
</tbody>
</table>
<h3 id=jdbcconnection-标签>jdbcConnection 标签</h3>
<p><code>&lt;jdbcConnection></code>标签用于<strong>指定数据源的连接信息</strong>，它在<code>mybatis-generator-core</code>中对应的实现类为<code>org.mybatis.generator.config.JDBCConnectionConfiguration</code>，主要属性包括：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>driverClass</code></td>
<td style=text-align:left>数据源驱动的全类名</td>
<td style=text-align:left><code>Y</code></td>
</tr>
<tr>
<td style=text-align:left><code>connectionURL</code></td>
<td style=text-align:left><code>JDBC</code>的连接<code>URL</code></td>
<td style=text-align:left><code>Y</code></td>
</tr>
<tr>
<td style=text-align:left><code>userId</code></td>
<td style=text-align:left>连接到数据源的用户名</td>
<td style=text-align:left><code>N</code></td>
</tr>
<tr>
<td style=text-align:left><code>password</code></td>
<td style=text-align:left>连接到数据源的密码</td>
<td style=text-align:left><code>N</code></td>
</tr>
</tbody>
</table>
<h3 id=commentgenerator-标签>commentGenerator 标签</h3>
<p><code>&lt;commentGenerator></code>标签是可选的，用于<strong>控制生成的实体的注释内容</strong>。它在<code>mybatis-generator-core</code>中对应的实现类为<code>org.mybatis.generator.internal.DefaultCommentGenerator</code>，可以通过可选的<code>type</code>属性指定一个自定义的<code>CommentGenerator</code>实现。<code>&lt;commentGenerator></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>suppressAllComments</code></td>
<td style=text-align:left>是否生成注释</td>
<td style=text-align:left><code>false</code></td>
</tr>
<tr>
<td style=text-align:left><code>suppressDate</code></td>
<td style=text-align:left>是否在注释中添加生成的时间戳</td>
<td style=text-align:left><code>false</code></td>
</tr>
<tr>
<td style=text-align:left><code>dateFormat</code></td>
<td style=text-align:left>配合<code>suppressDate</code>使用，指定输出时间戳的格式</td>
<td style=text-align:left><code>java.util.Date#toString()</code></td>
</tr>
<tr>
<td style=text-align:left><code>addRemarkComments</code></td>
<td style=text-align:left>是否输出表和列的<code>Comment</code>信息</td>
<td style=text-align:left><code>false</code></td>
</tr>
</tbody>
</table>
<p>笔者建议保持默认值，也就是什么注释都不输出，生成代码干净的实体。</p>
<h3 id=javatyperesolver-标签>javaTypeResolver 标签</h3>
<p><code>&lt;javaTypeResolver></code>标签是<code>&lt;context></code>的子标签，用于解析和计算数据库列类型和<code>Java</code>类型的映射关系，该标签只包含一个<code>type</code>属性，用于指定<code>org.mybatis.generator.api.JavaTypeResolver</code>接口的实现类。<code>&lt;javaTypeResolver></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>forceBigDecimals</code></td>
<td style=text-align:left>是否强制把所有的数字类型强制使用<code>java.math.BigDecimal</code>类型表示</td>
<td style=text-align:left><code>false</code></td>
</tr>
<tr>
<td style=text-align:left><code>useJSR310Types</code></td>
<td style=text-align:left>是否支持<code>JSR310</code>，主要是<code>JSR310</code>的新日期类型</td>
<td style=text-align:left><code>false</code></td>
</tr>
</tbody>
</table>
<p>如果<code>useJSR310Types</code>属性设置为<code>true</code>，那么生成代码的时候类型映射关系如下（主要针对日期时间类型）：</p>
<table>
<thead>
<tr>
<th style=text-align:left>数据库（JDBC）类型</th>
<th style=text-align:left>Java类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>DATE</code></td>
<td style=text-align:left><code>java.time.LocalDate</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIME</code></td>
<td style=text-align:left><code>java.time.LocalTime</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIMESTAMP</code></td>
<td style=text-align:left><code>java.time.LocalDateTime</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIME_WITH_TIMEZONE</code></td>
<td style=text-align:left><code>java.time.OffsetTime</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIMESTAMP_WITH_TIMEZONE</code></td>
<td style=text-align:left><code>java.time.OffsetDateTime</code></td>
</tr>
</tbody>
</table>
<p>引入<code>mybatis-generator-core</code>后，可以查看<code>JavaTypeResolver</code>的默认实现为<code>JavaTypeResolverDefaultImpl</code>，从它的源码可以得知一些映射关系：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>BIGINT --&gt; Long
BIT --&gt; Boolean
INTEGER --&gt; Integer
SMALLINT --&gt; Short
TINYINT --&gt; Byte
......
</code></pre></div><p>有些时候，我们希望<code>INTEGER</code>、<code>SMALLINT</code>和<code>TINYINT</code>都映射为<code>Integer</code>，那么我们需要覆盖<code>JavaTypeResolverDefaultImpl</code>的构造方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultJavaTypeResolver</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>JavaTypeResolverDefaultImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultJavaTypeResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SMALLINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SMALLINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意一点的是这种自定义实现<code>JavaTypeResolver</code>接口的方式使用编程式运行<code>MBG</code>会相对方便，如果需要使用<code>Maven</code>插件运行，那么需要把上面的<code>DefaultJavaTypeResolver</code>类打包到插件中。</p>
<h3 id=javamodelgenerator-标签>javaModelGenerator 标签</h3>
<p><code>&lt;javaModelGenerator标签></code>标签是<code>&lt;context></code>的子标签，主要用于控制实体（<code>Model</code>）类的代码生成行为。它支持的属性如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>targetPackage</code></td>
<td style=text-align:left>生成的实体类的包名</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>club.throwable.model</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetProject</code></td>
<td style=text-align:left>生成的实体类文件相对于项目（根目录）的位置</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>src/main/java</code></td>
</tr>
</tbody>
</table>
<p><code>&lt;javaModelGenerator标签></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>constructorBased</code></td>
<td style=text-align:left>是否生成一个带有所有字段属性的构造函数</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left><code>MyBatis3Kotlin</code>模式下忽略此属性配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableSubPackages</code></td>
<td style=text-align:left>是否允许通过<code>Schema</code>生成子包</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，例如包名为<code>club.throwable</code>，如果<code>Schema</code>为<code>xyz</code>，那么实体类文件最终会生成在<code>club.throwable.xyz</code>目录</td>
</tr>
<tr>
<td style=text-align:left><code>exampleTargetPackage</code></td>
<td style=text-align:left>生成的伴随实体类的<code>Example</code>类的包名</td>
<td style=text-align:left>-</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>exampleTargetProject</code></td>
<td style=text-align:left>生成的伴随实体类的<code>Example</code>类文件相对于项目（根目录）的位置</td>
<td style=text-align:left>-</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>immutable</code></td>
<td style=text-align:left>是否不可变</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，则不会生成<code>Setter</code>方法，所有字段都使用<code>final</code>修饰，提供一个带有所有字段属性的构造函数</td>
</tr>
<tr>
<td style=text-align:left><code>rootClass</code></td>
<td style=text-align:left>为生成的实体类添加父类</td>
<td style=text-align:left>-</td>
<td style=text-align:left>通过<code>value</code>指定父类的全类名即可</td>
</tr>
<tr>
<td style=text-align:left><code>trimStrings</code></td>
<td style=text-align:left><code>Setter</code>方法是否对字符串类型进行一次<code>trim</code>操作</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<h3 id=javaclientgenerator-标签>javaClientGenerator 标签</h3>
<p><code>&lt;javaClientGenerator></code>标签是<code>&lt;context></code>的子标签，主要用于控制<code>Mapper</code>接口的代码生成行为。它支持的属性如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>type</code></td>
<td style=text-align:left><code>Mapper</code>接口生成策略</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left><code>&lt;context></code>标签的<code>targetRuntime</code>属性为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时此属性配置忽略</td>
</tr>
<tr>
<td style=text-align:left><code>targetPackage</code></td>
<td style=text-align:left>生成的<code>Mapper</code>接口的包名</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>club.throwable.mapper</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetProject</code></td>
<td style=text-align:left>生成的<code>Mapper</code>接口文件相对于项目（根目录）的位置</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>src/main/java</code></td>
</tr>
</tbody>
</table>
<p><code>type</code>属性的可选值如下：</p>
<ul>
<li><code>ANNOTATEDMAPPER</code>：<code>Mapper</code>接口生成的时候依赖于注解和<code>SqlProviders</code>（也就是纯注解实现），不会生成<code>XML</code>映射文件。</li>
<li><code>XMLMAPPER</code>：<code>Mapper</code>接口生成接口方法，对应的实现代码生成在<code>XML</code>映射文件中（也就是纯映射文件实现）。</li>
<li><code>MIXEDMAPPER</code>：<code>Mapper</code>接口生成的时候复杂的方法实现生成在<code>XML</code>映射文件中，而简单的实现通过注解和<code>SqlProviders</code>实现（也就是注解和映射文件混合实现）。</li>
</ul>
<p>注意两点：</p>
<ul>
<li><code>&lt;context></code>标签的<code>targetRuntime</code>属性指定为<code>MyBatis3Simple</code>的时候，<code>type</code>只能选用<code>ANNOTATEDMAPPER</code>或者<code>XMLMAPPER</code>。</li>
<li><code>&lt;context></code>标签的<code>targetRuntime</code>属性指定为<code>MyBatis3</code>的时候，<code>type</code>可以选用<code>ANNOTATEDMAPPER</code>、<code>XMLMAPPER</code>或者<code>MIXEDMAPPER</code>。</li>
</ul>
<p><code>&lt;javaClientGenerator></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>enableSubPackages</code></td>
<td style=text-align:left>是否允许通过<code>Schema</code>生成子包</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，例如包名为<code>club.throwable</code>，如果<code>Schema</code>为<code>xyz</code>，那么<code>Mapper</code>接口文件最终会生成在<code>club.throwable.xyz</code>目录</td>
</tr>
<tr>
<td style=text-align:left><code>useLegacyBuilder</code></td>
<td style=text-align:left>是否通过<code>SQL Builder</code>生成动态<code>SQL</code></td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>rootInterface</code></td>
<td style=text-align:left>为生成的<code>Mapper</code>接口添加父接口</td>
<td style=text-align:left>-</td>
<td style=text-align:left>通过<code>value</code>指定父接口的全类名即可</td>
</tr>
</tbody>
</table>
<h3 id=sqlmapgenerator-标签>sqlMapGenerator 标签</h3>
<p><code>&lt;sqlMapGenerator></code>标签是<code>&lt;context></code>的子标签，主要用于控制<code>XML</code>映射文件的代码生成行为。它支持的属性如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>targetPackage</code></td>
<td style=text-align:left>生成的<code>XML</code>映射文件的包名</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>mappings</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetProject</code></td>
<td style=text-align:left>生成的<code>XML</code>映射文件相对于项目（根目录）的位置</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>src/main/resources</code></td>
</tr>
</tbody>
</table>
<p><code>&lt;sqlMapGenerator></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>enableSubPackages</code></td>
<td style=text-align:left>是否允许通过<code>Schema</code>生成子包</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<h3 id=plugin-标签>plugin 标签</h3>
<p><code>&lt;plugin></code>标签是<code>&lt;context></code>的子标签，用于引入一些插件对代码生成的一些特性进行扩展，该标签只包含一个<code>type</code>属性，用于指定<code>org.mybatis.generator.api.Plugin</code>接口的实现类。内置的插件实现见<a href=http://mybatis.org/generator/reference/plugins.html>Supplied Plugins</a>。例如：引入<code>org.mybatis.generator.plugins.SerializablePlugin</code>插件会让生成的实体类自动实现<code>java.io.Serializable</code>接口并且添加<code>serialVersionUID</code>属性。</p>
<h3 id=table-标签>table 标签</h3>
<p><code>&lt;table></code> 标签是 <code>&lt;context></code> 的子标签，主要用于配置要生成代码的数据库表格，定制一些代码生成行为等等。它支持的属性众多，列举如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>tableName</code></td>
<td style=text-align:left>数据库表名称</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>t_order</code></td>
</tr>
<tr>
<td style=text-align:left><code>schema</code></td>
<td style=text-align:left>数据库<code>Schema</code></td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>catalog</code></td>
<td style=text-align:left>数据库<code>Catalog</code></td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>alias</code></td>
<td style=text-align:left>表名称标签</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>如果指定了此值，则查询列的时候结果格式为<code>alias_column</code></td>
</tr>
<tr>
<td style=text-align:left><code>domainObjectName</code></td>
<td style=text-align:left>表对应的实体类名称，可以通过<code>.</code>指定包路径</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>如果指定了<code>bar.User</code>，则包名为<code>bar</code>，实体类名称为<code>User</code></td>
</tr>
<tr>
<td style=text-align:left><code>mapperName</code></td>
<td style=text-align:left>表对应的<code>Mapper</code>接口类名称，可以通过<code>.</code>指定包路径</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>如果指定了<code>bar.UserMapper</code>，则包名为<code>bar</code>，<code>Mapper</code>接口类名称为<code>UserMapper</code></td>
</tr>
<tr>
<td style=text-align:left><code>sqlProviderName</code></td>
<td style=text-align:left>动态<code>SQL</code>提供类<code>SqlProvider</code>的类名称</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>enableInsert</code></td>
<td style=text-align:left>是否允许生成<code>insert</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableSelectByPrimaryKey</code></td>
<td style=text-align:left>是否允许生成<code>selectByPrimaryKey</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableSelectByExample</code></td>
<td style=text-align:left>是否允许生成<code>selectByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableUpdateByPrimaryKey</code></td>
<td style=text-align:left>是否允许生成<code>updateByPrimaryKey</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableDeleteByPrimaryKey</code></td>
<td style=text-align:left>是否允许生成<code>deleteByPrimaryKey</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableDeleteByExample</code></td>
<td style=text-align:left>是否允许生成<code>deleteByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableCountByExample</code></td>
<td style=text-align:left>是否允许生成<code>countByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableUpdateByExample</code></td>
<td style=text-align:left>是否允许生成<code>updateByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>selectByPrimaryKeyQueryId</code></td>
<td style=text-align:left><code>value</code>指定对应的主键列提供列表查询功能</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>selectByExampleQueryId</code></td>
<td style=text-align:left><code>value</code>指定对应的查询<code>ID</code>提供列表查询功能</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>modelType</code></td>
<td style=text-align:left>覆盖<code>&lt;context></code>的<code>defaultModelType</code>属性</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>见<code>&lt;context></code>的<code>defaultModelType</code>属性</td>
</tr>
<tr>
<td style=text-align:left><code>escapeWildcards</code></td>
<td style=text-align:left>是否对通配符进行转义</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>delimitIdentifiers</code></td>
<td style=text-align:left>标记匹配表名称的时候是否需要使用分隔符去标记生成的SQL</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>delimitAllColumns</code></td>
<td style=text-align:left>是否所有的列都添加分隔符</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>false</code>，如果设置为<code>true</code>，所有列名会添加起始和结束分隔符</td>
</tr>
</tbody>
</table>
<p><code>&lt;table></code> 标签支持0或N个 <code>&lt;property></code> 标签，<code>&lt;property></code> 的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>constructorBased</code></td>
<td style=text-align:left>是否为实体类生成一个带有所有字段的构造函数</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>ignoreQualifiersAtRuntime</code></td>
<td style=text-align:left>是否在运行时忽略别名</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，则不会在生成表的时候把<code>schema</code>和<code>catalog</code>作为表的前缀</td>
</tr>
<tr>
<td style=text-align:left><code>immutable</code></td>
<td style=text-align:left>实体类是否不可变</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>modelOnly</code></td>
<td style=text-align:left>是否仅仅生成实体类</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>rootClass</code></td>
<td style=text-align:left>如果配置此属性，则实体类会继承此指定的超类</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>如果有主键属性会把主键属性在超类生成</td>
</tr>
<tr>
<td style=text-align:left><code>rootInterface</code></td>
<td style=text-align:left>如果配置此属性，则实体类会实现此指定的接口</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>或者<code>MyBatis3DynamicSql</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>runtimeCatalog</code></td>
<td style=text-align:left>指定运行时的<code>Catalog</code></td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>当生成表和运行时的表的<code>Catalog</code>不一样的时候可以使用该属性进行配置</td>
</tr>
<tr>
<td style=text-align:left><code>runtimeSchema</code></td>
<td style=text-align:left>指定运行时的<code>Schema</code></td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>当生成表和运行时的表的<code>Schema</code>不一样的时候可以使用该属性进行配置</td>
</tr>
<tr>
<td style=text-align:left><code>runtimeTableName</code></td>
<td style=text-align:left>指定运行时的表名称</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>当生成表和运行时的表的表名称不一样的时候可以使用该属性进行配置</td>
</tr>
<tr>
<td style=text-align:left><code>selectAllOrderByClause</code></td>
<td style=text-align:left>指定字句内容添加到<code>selectAll()</code>方法的<code>order by</code>子句之中</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Simple</code>的时候此属性才适用</td>
</tr>
<tr>
<td style=text-align:left><code>trimStrings</code></td>
<td style=text-align:left>实体类的字符串类型属性会做<code>trim</code>处理</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>useActualColumnNames</code></td>
<td style=text-align:left>是否使用列名作为实体类的属性名</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>useColumnIndexes</code></td>
<td style=text-align:left><code>XML</code>映射文件中生成的<code>ResultMap</code>使用列索引定义而不是列名称</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>或者<code>MyBatis3DynamicSql</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>useCompoundPropertyNames</code></td>
<td style=text-align:left>是否把列名和列备注拼接起来生成实体类属性名</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<p><code>&lt;table></code> 标签还支持众多的非 property 的子标签：</p>
<ul>
<li>0或1个<code>&lt;generatedKey></code>用于指定主键生成的规则，指定此标签后会生成一个<code>&lt;selectKey></code>标签：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- column：指定主键列 --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- sqlStatement：查询主键的SQL语句，例如填写了MySql，则使用SELECT LAST_INSERT_ID() --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- type：可选值为pre或者post，pre指定selectKey标签的order为BEFORE，post指定selectKey标签的order为AFTER --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- identity：true的时候，指定selectKey标签的order为AFTER --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;generatedKey</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>sqlStatement=</span><span style=color:#4e9a06>&#34;MySql&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;post&#34;</span> <span style=color:#c4a000>identity=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><ul>
<li>0或1个<code>&lt;domainObjectRenamingRule></code>用于指定实体类重命名规则：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- searchString中正则命中的实体类名部分会替换为replaceString --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;domainObjectRenamingRule</span> <span style=color:#c4a000>searchString=</span><span style=color:#4e9a06>&#34;^Sys&#34;</span> <span style=color:#c4a000>replaceString=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 SysUser会变成User --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 SysUserMapper会变成UserMapper --&gt;</span>
</code></pre></div><ul>
<li>0或1个<code>&lt;columnRenamingRule></code>用于指定列重命名规则：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- searchString中正则命中的列名部分会替换为replaceString --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;columnRenamingRule</span> <span style=color:#c4a000>searchString=</span><span style=color:#4e9a06>&#34;^CUST_&#34;</span> <span style=color:#c4a000>replaceString=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 CUST_BUSINESS_NAME会变成BUSINESS_NAME（useActualColumnNames=true） --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 CUST_BUSINESS_NAME会变成businessName（useActualColumnNames=false） --&gt;</span>
</code></pre></div><ul>
<li>0或N个<code>&lt;columnOverride></code>用于指定具体列的覆盖映射规则：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- column：指定要覆盖配置的列 --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- property：指定要覆盖配置的属性 --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- delimitedColumnName：是否为列名添加定界符，例如`{column}` --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- isGeneratedAlways：是否一定生成此列 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;columnOverride</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;customer_name&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;customerName&#34;</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>typeHandler=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>delimitedColumnName=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>isGeneratedAlways=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#8f5902;font-style:italic>&lt;!-- 覆盖table或者javaModelGenerator级别的trimStrings属性配置 --&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;trimStrings&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;columnOverride/&gt;</span>
</code></pre></div><ul>
<li>0或N个<code>&lt;ignoreColumn></code>用于指定忽略生成的列：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;ignoreColumn</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;version&#34;</span> <span style=color:#c4a000>delimitedColumnName=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h2 id=应用实例>应用实例</h2>
<p>如果需要深度定制一些代码生成行为，建议引入<code>mybatis-generator-core</code>并且通过编程式执行代码生成方法，否则可以选用<code>Maven</code>插件。假设我们在本地数据<code>local</code>有一张<code>t_order</code>表如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>t_order</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UNSIGNED</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;主键&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>order_id</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87>VARCHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;订单ID&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>create_time</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>DATETIME</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;创建时间&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>amount</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87>DECIMAL</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;金额&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>order_status</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TINYINT</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;订单状态&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNIQUE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_order_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;订单表&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>假设项目的结构如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mbg-sample
  - main
   - java
    - club
     - throwable
   - resources
</code></pre></div><p>下面会基于此前提举三个例子。编写基础的<code>XML</code>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!DOCTYPE generatorConfiguration
</span><span style=color:#8f5902;font-style:italic>        PUBLIC &#34;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&#34;
</span><span style=color:#8f5902;font-style:italic>        &#34;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&#34;&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;generatorConfiguration&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 驱动包绝对路径 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;classPathEntry</span>
            <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;I:\Develop\Maven-Repository\mysql\mysql-connector-java\5.1.48\mysql-connector-java-5.1.48.jar&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;这里选择合适的引擎&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;javaFileEncoding&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

        <span style=color:#8f5902;font-style:italic>&lt;!-- 不输出注释 --&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;commentGenerator&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressDate&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressAllComments&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/commentGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;jdbcConnection</span> <span style=color:#c4a000>driverClass=</span><span style=color:#4e9a06>&#34;com.mysql.jdbc.Driver&#34;</span>
                        <span style=color:#c4a000>connectionURL=</span><span style=color:#4e9a06>&#34;jdbc:mysql://localhost:3306/local&#34;</span>
                        <span style=color:#c4a000>userId=</span><span style=color:#4e9a06>&#34;root&#34;</span>
                        <span style=color:#c4a000>password=</span><span style=color:#4e9a06>&#34;root&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/jdbcConnection&gt;</span>


        <span style=color:#8f5902;font-style:italic>&lt;!-- 不强制把所有的数字类型转化为BigDecimal --&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;javaTypeResolver&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;forceBigDecimals&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/javaTypeResolver&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;javaModelGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;club.throwable.entity&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;src/main/java&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/javaModelGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;sqlMapGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;mappings&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;src/main/resources&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/sqlMapGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;这里选择合适的Mapper类型&#34;</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;club.throwable.dao&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;src/main/java&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/javaClientGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;table</span> <span style=color:#c4a000>tableName=</span><span style=color:#4e9a06>&#34;t_order&#34;</span>
               <span style=color:#c4a000>enableCountByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>enableDeleteByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>enableSelectByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>enableUpdateByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>domainObjectName=</span><span style=color:#4e9a06>&#34;Order&#34;</span>
               <span style=color:#c4a000>mapperName=</span><span style=color:#4e9a06>&#34;OrderMapper&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;generatedKey</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>sqlStatement=</span><span style=color:#4e9a06>&#34;MySql&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/table&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/context&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/generatorConfiguration&gt;</span>
</code></pre></div><h3 id=纯注解>纯注解</h3>
<p>使用纯注解需要引入<code>mybatis-dynamic-sql</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.mybatis.dynamic-sql<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>mybatis-dynamic-sql<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.1.4<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>需要修改两个位置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3DynamicSql&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
...

<span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;ANNOTATEDMAPPER&#34;</span>
<span style=color:#a40000>...</span>
</code></pre></div><p>运行结果会生成三个类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// club.throwable.entity
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Order</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setCreateTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAmount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Byte</span> <span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// club.throwable.dao
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OrderDynamicSqlSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Order</span> <span style=color:#000>order</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Byte</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Order</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SqlTable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BIGINT</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order_id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;create_time&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Byte</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order_status&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t_order&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Mapper</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OrderMapper</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>BasicColumn</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>selectList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BasicColumn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>columnList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectStatementProvider</span> <span style=color:#000>selectStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@DeleteProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;delete&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeleteStatementProvider</span> <span style=color:#000>deleteStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@InsertProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;insert&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;SELECT LAST_INSERT_ID()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;record.id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InsertStatementProvider</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>insertStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Results</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;OrderResult&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BIGINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectStatementProvider</span> <span style=color:#000>selectStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Results</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;OrderResult&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BIGINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectMany</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectStatementProvider</span> <span style=color:#000>selectStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@UpdateProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;update&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UpdateStatementProvider</span> <span style=color:#000>updateStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeleteDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deleteFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>deleteByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> 
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insertSelective</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>selectMany</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectDistinct</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectDistinct</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>selectMany</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UpdateDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updateAllColumns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updateSelectiveColumns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>updateByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>updateByPrimaryKeySelective</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=极简-xml-映射文件>极简 XML 映射文件</h3>
<p>极简<code>XML</code>映射文件生成只需要简单修改配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3Simple&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
...

<span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;XMLMAPPER&#34;</span>
<span style=color:#a40000>...</span>
</code></pre></div><p>生成三个文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// club.throwable.entity
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Order</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setCreateTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAmount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Byte</span> <span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// club.throwable.dao
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OrderMapper</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>deleteByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Order</span> <span style=color:#000>selectByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectAll</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>updateByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// mappings
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>&lt;?</span><span style=color:#000>xml</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.0&#34;</span> <span style=color:#000>encoding</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>?&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;!</span><span style=color:#000>DOCTYPE</span> <span style=color:#000>mapper</span> <span style=color:#000>PUBLIC</span> <span style=color:#4e9a06>&#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;</span> <span style=color:#4e9a06>&#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>mapper</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.dao.OrderMapper&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>resultMap</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>id</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BIGINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TIMESTAMP&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;DECIMAL&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>delete</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;deleteByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>delete</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>insert</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;insert&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>selectKey</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;AFTER&#34;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#000>SELECT</span> <span style=color:#000>LAST_INSERT_ID</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>selectKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>insert</span> <span style=color:#000>into</span> <span style=color:#000>t_order</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>order_status</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span>
        <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>update</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;updateByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>update</span> <span style=color:#000>t_order</span>
        <span style=color:#000>set</span> <span style=color:#000>order_id</span>     <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>create_time</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>amount</span>       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>order_status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectAll&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>resultMap</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>id</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BIGINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TIMESTAMP&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;DECIMAL&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>delete</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;deleteByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>delete</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>insert</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;insert&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>selectKey</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BEFORE&#34;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#000>SELECT</span> <span style=color:#000>LAST_INSERT_ID</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>selectKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>insert</span> <span style=color:#000>into</span> <span style=color:#000>t_order</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span>
        <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>update</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;updateByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>update</span> <span style=color:#000>t_order</span>
        <span style=color:#000>set</span> <span style=color:#000>order_id</span>     <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>create_time</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>amount</span>       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>order_status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectAll&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><h3 id=编程式自定义类型映射>编程式自定义类型映射</h3>
<p>笔者喜欢把所有的非长整型的数字，统一使用<code>Integer</code>接收，因此需要自定义类型映射。编写映射器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultJavaTypeResolver</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>JavaTypeResolverDefaultImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultJavaTypeResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SMALLINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SMALLINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此时最好使用编程式运行代码生成器，修改<code>XML</code>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;javaTypeResolver</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;club.throwable.mbg.DefaultJavaTypeResolver&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;forceBigDecimals&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/javaTypeResolver&gt;</span>
...
</code></pre></div><p>运行方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Main</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>warnings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#8f5902;font-style:italic>// 如果已经存在生成过的文件是否进行覆盖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>overwrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ConfigurationParser</span> <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Configuration</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Main</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/generator-configuration.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>DefaultShellCallback</span> <span style=color:#000>callback</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultShellCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overwrite</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyBatisGenerator</span> <span style=color:#000>generator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyBatisGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>callback</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>数据库的<code>order_status</code>是<code>TINYINT</code>类型，生成出来的文件中的<code>orderStatus</code>字段全部替换使用<code>Integer</code>类型定义。</p>
<h2 id=总结>总结</h2>
<p>本文相对详尽地介绍了<code>Mybatis Generator</code>的使用方式，具体分析了<code>XML</code>配置文件中主要标签以及标签属性的功能。因为<code>Mybatis</code>在<code>Java</code>的<code>ORM</code>框架体系中还会有一段很长的时间处于主流地位，了解<code>Mybatis Generator</code>可以简化<code>CRUD</code>方法模板代码、实体以及<code>Mapper</code>接口代码生成，从而解放大量生产力。<code>Mybatis Generator</code>有不少第三方的扩展，例如<code>tk.mapper</code>或者<code>mybatis-plus</code>自身的扩展，可能附加的功能不一样，但是基本的使用是一致的。</p>
<h2 id=引用>引用</h2>
<p>原文地址：<a href=https://www.cnblogs.com/throwable/p/12046848.html>https://www.cnblogs.com/throwable/p/12046848.html</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1b4c6af1cc9c41504ec2b73cde59980f>4.13 - CH13-多数据源</h1>
<p>如果要在查询端实现数据库的主从访问，或者业务较复杂，需要访问不同的数据库，则需要实现多数据源的集成与切换。</p>
<h2 id=配置文件>配置文件</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mybatis.config-location=classpath:mybatis/mybatis-config.xml

spring.datasource.test1.jdbc-url=jdbc:mysql://localhost:3306/test1?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true
spring.datasource.test1.username=root
spring.datasource.test1.password=root
spring.datasource.test1.driver-class-name=com.mysql.cj.jdbc.Driver

spring.datasource.test2.jdbc-url=jdbc:mysql://localhost:3306/test2?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true
spring.datasource.test2.username=root
spring.datasource.test2.password=root
spring.datasource.test2.driver-class-name=com.mysql.cj.jdbc.Driver
</code></pre></div><p>一个 test1 库和一个 test2 库，其中 test1 位主库，在使用的过程中必须指定主库，不然会报错。</p>
<h2 id=数据源配置>数据源配置</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.neo.mapper.test1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSessionTemplateRef</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DataSource1Config</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1DataSource&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;spring.datasource.test1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>testDataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>DataSourceBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>testSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test1DataSource&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBean</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMapperLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathMatchingResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:mybatis/mapper/test1/*.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1TransactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSourceTransactionManager</span> <span style=color:#000>testTransactionManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test1DataSource&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataSourceTransactionManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionTemplate</span> <span style=color:#000>testSqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test1SqlSessionFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最关键的地方就是这块了，一层一层注入,首先创建 DataSource，然后创建 SqlSessionFactory 再创建事务，最后包装到 SqlSessionTemplate 中。其中需要指定分库的 mapper 文件地址，以及分库dao层代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.neo.mapper.test1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSessionTemplateRef</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这块的注解就是指明了扫描 dao 层，并且给 dao 层注入指定的 SqlSessionTemplate。所有<code>@Bean</code>都需要按照命名指定正确。</p>
<h2 id=dao--mapper>dao & mapper</h2>
<p>dao 层和 xml 需要按照库来分在不同的目录，比如：test1 库 dao 层在 <code>com.neo.mapper.test1</code> 包下，test2 库在<code>com.neo.mapper.test2</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>User1Mapper</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getAll</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#000>UserEntity</span> <span style=color:#000>getOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>mapper：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>namespace=</span><span style=color:#4e9a06>&#34;com.neo.mapper.test1.User1Mapper&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;com.neo.model.User&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;id</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;BIGINT&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;userName&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;userName&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;passWord&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;passWord&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;user_sex&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;userSex&#34;</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;com.neo.enums.UserSexEnum&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;nick_name&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;nickName&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
    
    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;Base_Column_List&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        id, userName, passWord, user_sex, nick_name
    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getAll&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span>  <span style=color:#204a87;font-weight:700>&gt;</span>
       SELECT 
       <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;Base_Column_List&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
     FROM users
    <span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getOne&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        SELECT 
       <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;Base_Column_List&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
     FROM users
     WHERE id = #{id}
    <span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;insert&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.neo.model.User&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
       INSERT INTO 
          users
          (userName,passWord,user_sex) 
        VALUES
          (#{userName}, #{passWord}, #{userSex})
    <span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
    
    <span style=color:#204a87;font-weight:700>&lt;update</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;update&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.neo.model.User&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
       UPDATE 
          users 
       SET 
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userName != null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>userName = #{userName},<span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;passWord != null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>passWord = #{passWord},<span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
        nick_name = #{nickName}
       WHERE 
          id = #{id}
    <span style=color:#204a87;font-weight:700>&lt;/update&gt;</span>
    
    <span style=color:#204a87;font-weight:700>&lt;delete</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;delete&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
       DELETE FROM
           users 
       WHERE 
           id =#{id}
    <span style=color:#204a87;font-weight:700>&lt;/delete&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/mapper&gt;</span>
</code></pre></div><h2 id=测试验证>测试验证</h2>
<p>测试可以使用 SpringBootTest,也可以放到 Controller中，这里只贴 Controller 层的使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>User1Mapper</span> <span style=color:#000>user1Mapper</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#5c35cc;font-weight:700>@Autowired</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>User2Mapper</span> <span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>;</span>
	
	<span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/getUsers&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getUsers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>user1Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAll</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/getUser&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserEntity</span> <span style=color:#000>getUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/add&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;update&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/delete/{id}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>user1Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6381d54b4f53832189fba7dda04feff4>4.14 - CH14-常用片段</h1>
<h2 id=容器循环-foreach>容器循环 foreach</h2>
<p>foreach 元素的属性主要有：</p>
<ul>
<li>item：集合中元素迭代时的别名</li>
<li>index：集合中元素迭代时的索引</li>
<li>open：常用语where语句中，表示以什么开始，比如以'(&lsquo;开始</li>
<li>separator：表示在每次进行迭代时的分隔符</li>
<li>close 常用语where语句中，表示以什么结束</li>
</ul>
<p>在使用 foreach 的时候最关键的也是最容易出错的就是 collection 属性，该属性是必须指定的，但是在不同情况下，该属性的值是不一样的，主要有一下 3 种情况：</p>
<ul>
<li>如果传入的是单参数且参数类型是一个 List 的时候，collection 属性值为 list。</li>
<li>如果传入的是单参数且参数类型是一个 array 数组的时候，collection 的属性值为 array。</li>
<li>如果传入的参数是多个的时候，我们就需要把它们封装成一个 Map 了，当然单参数也可以封装成 map，实际上如果你在传入参数的时候，在 MyBatis 里面也是会把它封装成一个 Map 的，map 的 key 就是参数名，所以这个时候 collection 属性值就是传入的 List 或 array 对象在自己封装的 map 里面的 key.</li>
</ul>
<p>针对最后一条，我们看一下官方的说法：</p>
<blockquote>
<p>注意：你可以将一个 List 实例或者数组作为参数对象传给 MyBatis，当你这么做的时候，MyBatis 会自动将它包装在一个 Map 中并以名称为键。List 实例将会以 “list” 作为键，而数组实例的键将是 “array”。</p>
</blockquote>
<p>所以，不管是多参数还是单参数的 list,array 类型，都可以封装为 map 进行传递。如果传递的是一个 List，则 mybatis 会封装为一个 list 为 key，list 值为 object 的 map，如果是 array，则封装成一个 array 为 key，array 的值为 object 的 map，如果自己封装呢，则 colloection里 放的是自己封装的 map 里的 key 值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//mapper中我们要为这个方法传递的是一个容器,将容器中的元素一个一个的
</span><span style=color:#8f5902;font-style:italic>//拼接到xml的方法中就要使用这个forEach这个标签了
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Entity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queryById</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>userids</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>//对应的xml中如下
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;queryById&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseReslutMap&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
      <span style=color:#000>select</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>FROM</span> <span style=color:#000>entity</span>
      <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#000>in</span> 
      <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>foreach</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;userids&#34;</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;userid&#34;</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;index&#34;</span> <span style=color:#000>open</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
              <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>userid</span><span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
  <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><h3 id=foreach-array>foreach array</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getStudentListByClassIds_foreach_array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>classIds</span><span style=color:#ce5c00;font-weight:700>);</span>  
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 7.1 foreach(循环array参数) - 作为where中in的条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentListByClassIds_foreach_array&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST  
      WHERE ST.CLASS_ID IN   
     <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;array&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;classIds&#34;</span>  <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        #{classIds}  
     <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><h3 id=foreach-list>foreach list</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getStudentListByClassIds_foreach_list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>classIdList</span><span style=color:#ce5c00;font-weight:700>);</span> 
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 7.2 foreach(循环List&lt;String&gt;参数) - 作为where中in的条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentListByClassIds_foreach_list&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST  
      WHERE ST.CLASS_ID IN   
     <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;list&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;classIdList&#34;</span>  <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        #{classIdList}  
     <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><h2 id=模糊查询-concat>模糊查询 concat</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//比如说我们想要进行条件查询,但是几个条件不是每次都要使用,那么我们就可以
</span><span style=color:#8f5902;font-style:italic>//通过判断是否拼接到sql中
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;queryById&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BascResultMap&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;entity&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#000>SELECT</span> <span style=color:#ce5c00;font-weight:700>*</span>  <span style=color:#000>from</span> <span style=color:#000>entity</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>where</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name!=null&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#000>name</span> <span style=color:#000>like</span> <span style=color:#000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;%&#39;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>},</span><span style=color:#4e9a06>&#39;%&#39;</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>where</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
  <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><h2 id=choosewhenotherwise>choose、when、otherwise</h2>
<p>choose 标签是按顺序判断其内部 when 标签中的 test 条件出否成立，如果有一个成立，则 choose 结束。当 choose 中所有 when 的条件都不满则时，则执行 otherwise 中的 sql。类似于 Java 的 switch 语句，choose 为 switch，when 为 case，otherwise 则为 default。</p>
<p>例如下面例子，同样把所有可以限制的条件都写上，方面使用。choose 会从上到下选择一个 when 标签的 test 为 true 的 sql 执行。安全考虑，我们使用 where 将 choose 包起来，放置关键字多于错误。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!--  choose(判断参数) - 按顺序将实体类 User 第一个不为空的属性作为：where条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getUserList_choose&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_user&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.yiibai.pojo.User&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT *  
      FROM User u   
    <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;choose&gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;username !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
                u.username LIKE CONCAT(CONCAT(&#39;%&#39;, #{username, jdbcType=VARCHAR}),&#39;%&#39;)  
            <span style=color:#204a87;font-weight:700>&lt;/when &gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;sex != null and sex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
                AND u.sex = #{sex, jdbcType=INTEGER}  
            <span style=color:#204a87;font-weight:700>&lt;/when &gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;birthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
                AND u.birthday = #{birthday, jdbcType=DATE}  
            <span style=color:#204a87;font-weight:700>&lt;/when &gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;otherwise&gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;/otherwise&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;/choose&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>    
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><h2 id=selectkey>selectKey</h2>
<p>在insert语句中，在Oracle经常使用序列、在MySQL中使用函数来自动生成插入表的主键，而且需要方法能返回这个生成主键。使用myBatis的selectKey标签可以实现这个效果。</p>
<p>下面例子，使用 mysql 数据库自定义函数 nextval(&lsquo;student&rsquo;)，用来生成一个 key，并把他设置到传入的实体类中的 studentId 属性上。所以在执行完此方法后，边可以通过这个实体类获取生成的 key。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 插入学生 自动主键--&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;createStudentAutoKey&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.demo.model.StudentEntity&#34;</span> <span style=color:#c4a000>keyProperty=</span><span style=color:#4e9a06>&#34;studentId&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;selectKey</span> <span style=color:#c4a000>keyProperty=</span><span style=color:#4e9a06>&#34;studentId&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;String&#34;</span> <span style=color:#c4a000>order=</span><span style=color:#4e9a06>&#34;BEFORE&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        select nextval(&#39;student&#39;)  
    <span style=color:#204a87;font-weight:700>&lt;/selectKey&gt;</span>  
    INSERT INTO STUDENT_TBL(STUDENT_ID,  
                            STUDENT_NAME,  
                            STUDENT_SEX,  
                            STUDENT_BIRTHDAY,  
                            STUDENT_PHOTO,  
                            CLASS_ID,  
                            PLACE_ID)  
    VALUES (#{studentId},  
            #{studentName},  
            #{studentSex},  
            #{studentBirthday},  
            #{studentPhoto, javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},  
            #{classId},  
            #{placeId})  
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>  
</code></pre></div><p>调用接口方法，和获取自动生成 key：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>StudentEntity</span> <span style=color:#000>entity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>();</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;黎明你好&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentSex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentBirthday</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DateUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1985-05-28&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClassId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;20000001&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPlaceId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;70000001&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  

<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dynamicSqlMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStudentAutoKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;新增学生ID: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStudentId</span><span style=color:#ce5c00;font-weight:700>());</span>  
</code></pre></div><h2 id=if>if</h2>
<p>if 标签可用在许多类型的 sql 语句中，我们以查询为例。首先看一个很普通的查询：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 查询学生list，like姓名 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentListLikeName&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;StudentEntity&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;studentResultMap&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT * from STUDENT_TBL ST   
WHERE ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName}),&#39;%&#39;)  
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>  
</code></pre></div><p>但是此时如果 studentName 为 null，此语句很可能报错或查询结果为空。此时我们使用 if 动态 sql 语句先进行判断，如果值为 null 或等于空字符串，我们就不进行此条件的判断，增加灵活性。</p>
<p>参数为实体类 StudentEntity。将实体类中所有的属性均进行判断，如果不为空则执行判断条件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 2 if(判断参数) - 将实体类不为空的属性作为where条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentList_if&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST   
     WHERE  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName, jdbcType=VARCHAR}),&#39;%&#39;)  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.STUDENT_SEX = #{studentSex, jdbcType=INTEGER}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.STUDENT_BIRTHDAY = #{studentBirthday, jdbcType=DATE}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != null and classId!= &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.CLASS_ID = #{classId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classEntity != null and classEntity.classId !=null and classEntity.classId !=&#39; &#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.CLASS_ID = #{classEntity.classId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != null and placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.PLACE_ID = #{placeId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeEntity != null and placeEntity.placeId != null and placeEntity.placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.PLACE_ID = #{placeEntity.placeId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentId != null and studentId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.STUDENT_ID = #{studentId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>   
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><p>使用时比较灵活，new 一个这样的实体类，我们需要限制那个条件，只需要附上相应的值就会 where 这个条件，相反不去赋值就可以不在 where 中判断。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select_test_2_1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#000>StudentEntity</span> <span style=color:#000>entity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentSex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentBirthday</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DateUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1985-05-28&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClassId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;20000001&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#8f5902;font-style:italic>//entity.setPlaceId(&#34;70000001&#34;);  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dynamicSqlMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStudentList_if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StudentEntity</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=if--where>if + where</h2>
<p>当 where 中的条件使用的 if 标签较多时，这样的组合可能会导致错误。我们以在 3.1 中的查询语句为例子，当 java 代码按如下方法调用时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Test</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select_test_2_1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#000>StudentEntity</span> <span style=color:#000>entity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentSex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dynamicSqlMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStudentList_if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StudentEntity</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>如果上面例子，参数studentName为null，将不会进行STUDENT_NAME列的判断，则会直接导“WHERE AND”关键字多余的错误SQL。</p>
<p>这时我们可以使用where动态语句来解决。这个“where”标签会知道如果它包含的标签中有返回值的话，它就插入一个‘where’。此外，如果标签返回的内容是以AND 或OR 开头的，则它会剔除掉。</p>
<p>上面例子修改为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 3 select - where/if(判断参数) - 将实体类不为空的属性作为where条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentList_whereIf&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST   
    <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName, jdbcType=VARCHAR}),&#39;%&#39;)  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_SEX = #{studentSex, jdbcType=INTEGER}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_BIRTHDAY = #{studentBirthday, jdbcType=DATE}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != null and classId!= &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classEntity != null and classEntity.classId !=null and classEntity.classId !=&#39; &#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classEntity.classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != null and placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeEntity != null and placeEntity.placeId != null and placeEntity.placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeEntity.placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentId != null and studentId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_ID = #{studentId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>    
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>  
</code></pre></div><h2 id=if--set>if + set</h2>
<p>当update语句中没有使用if标签时，如果有一个参数为null，都会导致错误。</p>
<p>当在update语句中使用if标签时，如果前面的if没有执行，则或导致逗号多余错误。使用set标签可以将动态的配置SET 关键字，和剔除追加到条件末尾的任何不相关的逗号。使用if+set标签修改后，如果某项为null则不进行更新，而是保持数据库原值。</p>
<p>如下示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 4 if/set(判断参数) - 将实体类不为空的属性更新 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;update</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;updateStudent_if_set&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    UPDATE STUDENT_TBL  
    <span style=color:#204a87;font-weight:700>&lt;set&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName != null and studentName != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_NAME = #{studentName},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_SEX = #{studentSex},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_BIRTHDAY = #{studentBirthday},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentPhoto != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_PHOTO = #{studentPhoto, javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.CLASS_ID = #{classId}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.PLACE_ID = #{placeId}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>  
    WHERE STUDENT_TBL.STUDENT_ID = #{studentId};      
<span style=color:#204a87;font-weight:700>&lt;/update&gt;</span> 
</code></pre></div><h2 id=if--trim-代替-whereset>if + trim 代替 where/set</h2>
<p>trim是更灵活的去处多余关键字的标签，他可以实践where和set的效果。</p>
<h3 id=trim-代替-where>trim 代替 where</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 5.1if/trim代替where(判断参数) -将实体类不为空的属性作为where条件--&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentList_if_trim&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST   
    <span style=color:#204a87;font-weight:700>&lt;trim</span> <span style=color:#c4a000>prefix=</span><span style=color:#4e9a06>&#34;WHERE&#34;</span> <span style=color:#c4a000>prefixOverrides=</span><span style=color:#4e9a06>&#34;AND|OR&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName, jdbcType=VARCHAR}),&#39;%&#39;)  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_SEX = #{studentSex, jdbcType=INTEGER}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_BIRTHDAY = #{studentBirthday, jdbcType=DATE}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != null and classId!= &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classEntity != null and classEntity.classId !=null and classEntity.classId !=&#39; &#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classEntity.classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != null and placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeEntity != null and placeEntity.placeId != null and placeEntity.placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeEntity.placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentId != null and studentId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_ID = #{studentId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/trim&gt;</span>     
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><h3 id=trim-代替-set>trim 代替 set</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 5.2 if/trim代替set(判断参数) - 将实体类不为空的属性更新 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;update</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;updateStudent_if_trim&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    UPDATE STUDENT_TBL  
    <span style=color:#204a87;font-weight:700>&lt;trim</span> <span style=color:#c4a000>prefix=</span><span style=color:#4e9a06>&#34;SET&#34;</span> <span style=color:#c4a000>suffixOverrides=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName != null and studentName != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_NAME = #{studentName},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_SEX = #{studentSex},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_BIRTHDAY = #{studentBirthday},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentPhoto != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_PHOTO = #{studentPhoto, javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.CLASS_ID = #{classId},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.PLACE_ID = #{placeId}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/trim&gt;</span>  
    WHERE STUDENT_TBL.STUDENT_ID = #{studentId}  
<span style=color:#204a87;font-weight:700>&lt;/update&gt;</span>
</code></pre></div><h2 id=sql-复用>sql 复用</h2>
<p>sql片段标签<sql>：通过该标签可定义能复用的sql语句片段，在执行sql语句标签中直接引用即可。这样既可以提高编码效率，还能有效简化代码，提高可读性</p>
<p>需要配置的属性：id="" &#187;>表示需要改sql语句片段的唯一标识</p>
<p>引用：通过<include refid>标签引用，refid="" 中的值指向需要引用的<sql>中的id=“”属性</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!--定义sql片段--&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;orderAndItem&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    o.order_id,o.cid,o.address,o.create_date,o.orderitem_id,i.orderitem_id,i.product_id,i.count  
  <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>  

 <span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;findOrderAndItemsByOid&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;java.lang.String&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    select  
<span style=color:#8f5902;font-style:italic>&lt;!--引用sql片段--&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;orderAndItem&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>  
    from ordertable o  
    join orderitem i on o.orderitem_id = i.orderitem_id  
    where o.order_id = #{orderId}  
  <span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>  
</code></pre></div><h2 id=upsert>upsert</h2>
<h3 id=基于唯一键冲突>基于唯一键冲突</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;createRecord&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;map&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;long&#34;</span> <span style=color:#c4a000>flushCache=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  INSERT INTO MYTABLE (id, name, creator, description)
  VALUES (nextval(&#39;my_seq&#39;), #{name}, #{creator}, #{description})
  ON CONFLICT ON CONSTRAINT (name, creator)
  DO UPDATE SET
    name = #{name},
    creator = #{creator},
    description = #{description}
  RETURNING id
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
</code></pre></div><h3 id=基于主键>基于主键</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;AddTeacher&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.mycompany.entity.Teacher&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;selectKey</span> <span style=color:#c4a000>keyProperty=</span><span style=color:#4e9a06>&#34;count&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>order=</span><span style=color:#4e9a06>&#34;BEFORE&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        select count(*) from Teacher where teacher_id = #{teacherId}
    <span style=color:#204a87;font-weight:700>&lt;/selectKey&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;count &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        update event
        <span style=color:#204a87;font-weight:700>&lt;set&gt;</span>
           <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;teacherName!= null&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>  
                teacher_name= #{teacherName},
           <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>
            teacher_id = #{teacherId}
        <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;count==0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        insert into teacher(teacher_id,teacher_name) values (#{teacherId},#{teacherName})
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
</code></pre></div><h3 id=基于唯一键冲突批量执行>基于唯一键冲突批量执行</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ExcelDataMapper</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据excel解析的实体，插入到数据库。
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param dbColumnToValueMap &lt;code&gt;Map&lt;String, String&gt;&lt;/code&gt; 表示excel解析的实体。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dbColumnToValueMap&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dbColumnToValueMap</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;upsert&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;map&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
insert into excel_data_info
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;dbColumnToValueMap.keys&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;key&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      ${key}
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
    values
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;dbColumnToValueMap.keys&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;key&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      #{dbColumnToValueMap[${key}]}
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
    on duplicate key update
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;dbColumnToValueMap.keys&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;key&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34; key != &#39;id&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            ${key} = #{dbColumnToValueMap[${key}]}
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c1e8f2365fc6e91852aa984062de81f7>5 - Hikari</h1>
<p>Hikari 读作 <strong>Hi-ka-li</strong>。</p>
</div>
<div class=td-content>
<h1 id=pg-4044b0e6448e84d3abca221838625d38>5.1 - 基本概念</h1>
<h2 id=定义>定义</h2>
<ul>
<li>数据库连接池负责分配、管理和释放数据库连接，它允许应用程序重复使用一个现有的数据库连接，而不是重新建立一个；</li>
<li>释放空闲时间超过最大空闲时间的数据库连接，来避免因为没有释放数据库连接而引起的数据库连接遗漏。</li>
</ul>
<h2 id=传统过程>传统过程</h2>
<p>经典的 JDBC 连接数据库的大致步骤：</p>
<ul>
<li>加载 JDBC 驱动</li>
<li>创建数据库连接</li>
<li>创建 preparedStatement</li>
<li>执行 SQL 语句</li>
<li>遍历结果</li>
<li>关闭数据库连接</li>
</ul>
<p>在网络层面，以访问 MySQL 为例，执行一个 SQL 语句的完整 TCP 流程包括：</p>
<ul>
<li>TCP 三次握手建立连接</li>
<li>MySQL 三次握手认证</li>
<li>SQL 语句执行</li>
<li>MySQL 关闭</li>
<li>TCP 四次挥手关闭连接</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210711223145.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=存在问题>存在问题</h2>
<p>这种传统连接方式的问题有：</p>
<ul>
<li>创建和关闭连接的过程比较耗时，并发时系统会变得卡顿。</li>
<li>数据库同时支持的连接数有限，如果并发量很大，数据库的连接数则会被耗尽，增加了数据库负载，新的数据库连接请求将会失败。
<ul>
<li>这会极大的浪费数据库资源，极易造成数据库服务内存溢出、宕机。</li>
</ul>
</li>
<li>为了执行一条 SQL，却产生了很多我们并不关心的网络 IO。</li>
<li>应用如果频繁的创建和关闭连接，会导致 JVM 临时对象较多，GC 频繁。</li>
<li>频繁关闭连接后，会出现大量 TIME_WAIT 的 TCP 状态(在 2 个 MSL 之后关闭)。</li>
<li>应用的响应时间和 QPS 较低。</li>
</ul>
<h2 id=池化优点>池化优点</h2>
<p>使用数据库连接池后，最直接的改变就是仅需在首次访问时创建连接，之后的访问直接可以复用已有连接。</p>
<ul>
<li>资源重用。由于数据库连接得到复用，减少了大量创建和关闭连接带来的开销，也减少了内存碎片和数据库临时进程、线程的珊瑚粮，整体系统的运行更加平稳。</li>
<li>系统调优更简便。TIME_WAIT 的调优非常繁琐，使用了数据库连接池以后，由于资源重用，大大减少了频繁关闭连接的开销，大大降低 TIME_WAIT 的出现频率。</li>
<li>系统响应更快。数据库连接池在应用初始化的过程中一般都会提前准备好一些数据库连接，业务请求可以直接使用已经创建的连接而不需要等待创建连接的开销。初始化数据库连接配合资源重用，使得数据库连接池可以大大缩短系统整体响应时间。</li>
<li>连接管理更灵活。数据库连接池作为一款中间件，除了扮演有界缓冲的角色以外，在统一的连接管理上同样可以做很多文章。用户可以自行配置连接的最小数量、最大数量、最常空闲时间、获取连接超时间、心跳检测等。另外，用户也可以结合新的技术趋势，增加数据库连接池的动态配置、监控、故障演习等一系列实用的功能。</li>
</ul>
<h2 id=实现原理>实现原理</h2>
<p>在系统初始化的时候，在内存中开辟一片空间，将一定数量的数据库连接作为对象存储在对象池里，并对外提供数据库连接的获取和归还方法。</p>
<p>用户访问数据库时，并不是建立一个新的连接，而是从数据库连接池中取出一个已有的空闲连接对象；使用完毕归还后的连接也不会马上被关闭，而是由数据库连接池统一管理回收，为下一次借用做好准备。</p>
<p>如果由于高并发请求导致数据库连接池中的连接被借用完毕，其他线程就会等待，直到有连接被归还。</p>
<p>整个过程中，连接并不会被关闭，而是源源不断地循环使用，有借有还。数据库连接池还可以通过设置其参数来控制连接池中的初始连接数、连接的上下限数，以及每个连接的最大使用次数、最大空闲时间等，也可以通过其自身的管理机制来监视数据库连接的数量、使用情况等。</p>
<h2 id=基本构成>基本构成</h2>
<p>数据库连接池的核心功能是建立和释放连接。通常完整的连接池实现会提供更多功能：</p>
<ul>
<li>并发优化：锁性能优化，甚至无锁</li>
<li>连接数控制：不同的系统对连接数的要求不同</li>
<li>监控：提供管理机制来监视连接数量或用量</li>
<li>外部配置</li>
<li>资源重用</li>
<li>检测/容灾：面对网络、时间问题的自愈</li>
<li>多库：不同的数据库、不同的用户与密码、分库分表</li>
<li>事务处理：对数据库的操作符合 ALL-ALL-NOTHING 原则</li>
<li>定时任务：空闲检查、最小连接数控制</li>
<li>缓存：如 PSCache 等避免 SQL 重复解析</li>
<li>异常处理：对 JDBC 异常的统处理</li>
<li>组件维护：连接状态、JDBC 封装维护</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210711224709.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d65e1cea2e403108cd2bf982d6f46006>5.2 - 开源实现</h1>
<p>按采用的线程模型分类：</p>
<table>
<thead>
<tr>
<th>单线程</th>
<th>多线程</th>
</tr>
</thead>
<tbody>
<tr>
<td>c3p0</td>
<td>DBCP 2.x</td>
</tr>
<tr>
<td>Proxool</td>
<td>Tomact JDBC Pool</td>
</tr>
<tr>
<td>XAPool</td>
<td>BoneCP</td>
</tr>
<tr>
<td>DBCP 1.x</td>
<td>Druid</td>
</tr>
<tr>
<td></td>
<td>Hakari</td>
</tr>
</tbody>
</table>
<h2 id=c3p0>c3p0</h2>
<p>c3p0 具有超过 230 个 <code>synchronize</code> 同步块和方法，在不同的类中充斥着大量 <code>wait()</code> 及 <code>notifyAll()</code> 方法，这些导致死锁倾向的代码造成了在网络上搜索“c3p0死锁”可以查到大量的资料。由于代码量复杂等原因，c3p0 在基准测试中也始终排在最后。c3p0 在默认情况下不会在 <code>getConnection </code>的时候测试连接可用性，这点也是不安全的默认配置。</p>
<p>但 c3p0 也提供了一些有用的功能：</p>
<ul>
<li>一个将传统的基于 <code>DriverManager</code> 的 JDBC 驱动程序调整为较新的 <code>javax.sql. DataSource</code> 方案的类，以获取数据库连接。</li>
<li>基于 <code>DataSources</code> 的 <code>Connection</code> 和 <code>PreparedStatements</code> 的透明池，可以“包装”传统驱动程序或任意非池化数据源。</li>
</ul>
<p>c3p0 在以下细节上进行了打磨以确保正确性：</p>
<ul>
<li><code>DataSources</code> 都是可引用和可序列化的，因此其适合绑定到各种基于 JNDI 的命名服务。</li>
<li>当引入 <code>Connection</code> 和 <code>Statement</code> 时，都会仔细清理 <code>Statement</code> 和 <code>ResultSets</code>，这是为了防止客户端使用Lazy模式。但常见的资源管理策略仅仅清理 <code>Connection</code> 而造成资源耗尽。</li>
<li>该库采用 JDBC 2 和 JDBC 3 规范定义的方法(即使这些方法与库作者的首选项冲突)。 <code>DataSources</code> 以 JavaBean 样式编写，提供所有必需和大多数可选属性（以及一些非标准属性）和无参构造函数。
<ul>
<li>实现了所有 JDBC 定义的内部接口（<code>ConnectionPoolDataSource</code>, <code>PooledConnection</code>,<code>ConnectionEvent-generating Connections</code>等）。</li>
<li>用户可以将 c3p0 类与兼容的第三方实现混合使用(尽管并非所有 c3p0 功能都可以与 <code>ConnectionPoolDataSource</code> 的外部实现一起使用)。</li>
</ul>
</li>
</ul>
<h2 id=proxool>Proxool</h2>
<p>Proxool 以JDBC 驱动的身份为用户提供透明的连接池服务，所以 Proxool 移植到现有代码中特别容易，用户可以轻松地使用 JDBC API、XML 或 Java 属性文件进行配置。</p>
<p>Proxool 在那个年代另辟蹊径，开创性地提供了连接池监控功能，便于发现连接泄漏的等性能情况及连接事件。</p>
<p>它的很多设计理念都被 HikariCP 认可并吸收，HikariCP 在继承过程中进行了独具匠心的打磨。例如，关于 Cglib 等字节码的代理，这也是 HikariCP 仔细打磨的地方。</p>
<h2 id=xapool>XAPool</h2>
<p>XA 是 X/Open CAE Specification(Distributed TransactionProcessing) 模型中定义的 TM(Transaction Manager) 与 RM(Resource Manager) 之间进行通信的接口。</p>
<p>Java 中的 <code>javax.transaction.xa.XAResource</code> 定义了XA接口，它依赖数据库厂商对 jdbc-driver 的具体实现。在 XA 规范中，数据库充当 RM 角色，应用需要充当 TM 的角色，即生成全局的 txId，调用 <code>XAResource</code> 接口，把多个本地事务协调为全局统一的分布式事务。</p>
<p>XAPool 是一个 XA 数据库连接池，它实现了 <code>javax.sql.XADataSource</code>，并提供了连接池工具。这是一款主打分布式事务的数据库连接池，它允许池对象，JDBC 连接和 XA 连接。</p>
<h2 id=dbcp>DBCP</h2>
<p>Apache Commons DBCP 并不是独立实现连接池功能的，它内部依赖于 Commons 中的另一个子项目 Apache Commons Pool。数据库连接池中最核心的“池”，就是由 Pool 组件提供的，Apache Commons Pool 决定着数据库连接池的整体性能。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210711231029.png style=display:block;width:80% alt=NAME align=center> </div>
<p>在2014年3月，DBCP终于更新到了2.x版本，基于新的线程模型的数据库连接池让DBCP焕然一新重获新生，稳定性得到提升，性能也有了质的提升。Apache Commons Pool 2类库是对象池技术的一种具体实现，它的出现是为了解决频繁的创建和销毁对象带来的性能损耗问题。</p>
<p>其原理就是建立一个对象池，池中预先生成了一些对象，需要对象的时候借用，用完后进行归还，对象不够时灵活地自动创建，对象池满后提供参数控制是阻塞还是非阻塞响应租借用。</p>
<p>在 SpringBoot 1.5.x 版本中，数据库连接池的默认配置是 Tomcat Pool → HikariCP →Commons DBCP → Commons DBCP2；然而在 2.x 版本中，HikariCP 被提升为默认的数据库连接池，数据库连接池的默认配置顺序是 HikariCP → Tomcat pool→ CommonsDBCP2。</p>
<h2 id=tomcat-jdbc-pool>Tomcat JDBC Pool</h2>
<p>在 DBCP 2.0 之前，为什么需要一个新的连接池：</p>
<ul>
<li>DBCP 1.x 是单线程。为了线程安全，在对象分配或对象返回的短期内，Commons 锁定了全部池。</li>
<li>DBCP 1.x 可能会变得很慢。当逻辑 CPU 数目增长，或者试图借出或归还对象的并发线程增加时，性能就会受到影响。高并发系统受到的影响会更为显著。</li>
<li>DBCP 拥有 60 多个类，而 tomcat-jdbc-pool 核心只有 8 个类。因此为了未来需求变更着想，肯定需要更少的改动。我们真正需要的只是连接池本身，其余的只是附属。</li>
<li>DBCP 使用静态接口，因此对于指定版本的 JRE，只能采用正确版本的 DBCP，否则就会出现 NoSuchMethodException 异常。</li>
<li>当 DBCP 可以用其他更简便的实现来替代时，实在不值得重写那 60 个类。</li>
<li>Tomcat JDBC 连接池无需为库本身添加额外线程，就能异步获取连接。</li>
<li>Tomcat JDBC 连接池是 Tomcat 的一个模块，依靠 Tomcat JULI 这个简化了的日志架构。</li>
<li>使用 javax.sql.PooledConnection 接口获取底层连接。</li>
<li>防止饥饿。如果池变空，线程将等待一个连接。当连接返回时，池就将唤醒正确的等待线程。大多数连接池只会一直维持饥饿状态。</li>
</ul>
<p>Tomcat JDBC Pool 还具有其他连接池没有的特点：</p>
<ul>
<li>支持高并发环境与多 核/CPU 系统。</li>
<li>接口的动态实现。支持 java.sql 与 java.sql 接口(只要JDBC驱动)，甚至在利用低版本的 JDK 来编译时也支持。</li>
<li>验证间隔时间。我们不必每次使用单个连接时都进行验证，可以在借出或归还连接时进行验证，只要不低于我们所设定的间隔时间就行。</li>
<li>只执行一次查询。当与数据库建立起连接时，只执行一次可配置查询。这项功能对会话设置非常有用，因为你可能会想在连接建立的整个时段内都保持会话。</li>
<li>能够配置自定义拦截器。通过自定义拦截器来增强功能。可以使用拦截器来采集查询统计，缓存会话状态，重新连接之前失败的连接，重新查询，缓存查询结果，等等。由于可以使用大量的选项，所以这种自定义拦截器也是没有限制的，与 java.sql/javax.sql 接口的 JDK 版本没有任何关系。</li>
<li>高性能。后面将举例展示一些性能差异。</li>
<li>极其简单。它的实现非常简单，代码行数与源文件都非常少，这都有赖于从一开始研发它时，就把简洁当作重中之重。核心只有8个文件。</li>
<li>异步连接获取。可将连接请求队列化，系统返回 <code>Future&lt;Connection></code>。</li>
<li>更好地处理空闲连接。不再简单粗暴地直接关闭空闲连接，而是把连接仍然保留在池中，通过更为巧妙的算法控制空闲连接池的规模。</li>
<li>可以控制连接应被废弃的时间。当池满了即废弃，或者指定一个池使用容差值，发生超时就进行废弃处理。</li>
<li>通过查询或语句来重置废弃连接计时器。允许一个使用了很长时间的连接不会因为超时而被废弃。这一点是通过使用 ResetAbandonedTimer 来实现的。</li>
<li>经过指定时间后，关闭连接。与返回池的时间相类似。</li>
<li>当连接要被释放时，获取 JMX 通知并记录所有日志。它类似于 remove-AbandonedTimeout，但却不需要采取任何行为，只需要报告信息即可。通过 suspectTimeout 属性来实现。</li>
<li>可以通过 java.sql.Driver、javax.sql.DataSource 或 javax.sql.XADataSource 获取连接。通过 dataSource 与 dataSourceJNDI 属性实现这一点。</li>
<li>支持 XA 连接。</li>
</ul>
<p>其缺点有：</p>
<ul>
<li>默认配置也存在类似 c3p0 的问题，就是在 getConnection 的时候并不会默认测试连接可用性。</li>
<li>不完全遵守 JDBC 规范，默认也不会重置连接状态(如自动提交、事务隔离级别等)，用户必须手动配置名为 ConnectionState 的 JDBCInterceptor。</li>
<li>在自动提交中，如果连接池配置了 <code>autocommit=false</code>，就需要在自己的事务中执行连接有效性测试 <code>isValid()</code>，否则使用者获取的连接有可能就在一个事务进行中。</li>
<li>对于创建连接时可以在连接上运行的初始化 initSQL 也是如此，Tomcat 不会在自己的事务中封装连接测试或 initSQL。</li>
<li>连接池应该在 Connection 返回到池时或从池中取出之前，调用 <code>clearWarnings()</code> 方法清除 SQL 警告，然而 TomcatJDBC 也没有这么做。</li>
<li>JDBC 规范还规定，连接关闭时，所有没有关闭的、已经打开的 Statements 都应该自动关闭，但是默认情况下 Tomcat JDBC 并不会跟踪 Statements，除非手动配置一个 StatementFinalizer 拦截。</li>
<li>不幸的是，StatementFinalizer 使用一组 WeakReference 对象跟踪 Statements，当 JVM 受到 GC压力时，在 Tomcat 有机会关闭这些语句之前，可能会对废弃的 Statements 进行垃圾收集，这可能导致资源的泄漏，但是只有在 GC 压力下才会发生，因此可能很难追踪。</li>
</ul>
<h2 id=bonecp>BoneCP</h2>
<p>在 c3p0 和 DBCP 已经存在的时代，BoneCP 的出现就是为了追求极致，它几乎比下一个最快的连接池选项快 25 倍，而且 BoneCP 从不自旋锁定，因此它不会减慢应用程序速度。</p>
<p>BoneCP 可以说是极致数据库连接池的领军开源项目。它和 HikariCP 也是非常有渊源的，除了 HikariCP 捐赠了 BoneCP 几美金的故事以外，BoneCP 在浪潮之巅功成身退，深藏功与名，将一身衣钵传给了 HikariCP。</p>
<p>BoneCP 的特点如下：</p>
<ul>
<li>具有高可扩展性的快速连接池。</li>
<li>在 connection 状态改变时，可配置回调机制(钩式拦截器)。</li>
<li>通过分区(Partitioning)来提升性能。</li>
<li>允许用户直接访问 connection 或 statement。</li>
<li>自动扩展 pool 容量。</li>
<li>支持 statement caching。</li>
<li>支持异步地获取connection，通过返回一个 <code>Future&lt;Connection></code> 实现。</li>
<li>以异步的方式施放辅助线程，来关闭 connection 和 statement，以获得高性能。</li>
<li>在每个新获取的 connection 上，通过简单的机制，执行自定义的 statement。即通过简单的 SQL 语句来测试 connection 是否有效，对应的配置属性为 initSQL。</li>
<li>支持运行时切换数据库，而不需要停止应用。</li>
<li>能够自动地回放任何失败的事务(如数据库或网络出现故障等)。</li>
<li>支持JMX。</li>
<li>可以延迟初始化(lazy initialization)。</li>
<li>支持使用 XML 或 property 文件的配置方式。</li>
<li>支持 idle connection timeouts 和 max connection age。</li>
<li>自动检验 connection 是否活跃等等。</li>
<li>允许直接从数据库获取连接，而不通过 Driver。</li>
<li>支持 Datasouce 和 Hibernate。</li>
<li>支持通过 debugging hooks 来定位获取后未关闭的 connection。</li>
<li>支持通过 debugging 来显示被关闭了两次的 connection 的堆栈轨迹(stack locations)。</li>
<li>支持自定义 pool name。</li>
<li>代码整洁有序。</li>
<li>免费，开源，纯 Java 编写，具有完整的文档。</li>
</ul>
<p>BoneCP 最大的一个问题是无法在 getConnection() 的时候配置数据库连接池来测试连接。然而其他每个数据库连接池大多都可以这样配置。它这样做是为了提升速度，但却牺牲了可靠性。</p>
<ul>
<li>在默认配置方面，BoneCP 也不会在 Connection 返回到池时或从池中取出之前通过 <code>Connection.clearWarnings()</code> 方法清除 SQL 警告；</li>
<li>默认情况下也不会关闭废弃的、已经打开的 statements；</li>
<li>也不会在自己的事务中封装连接测试或 initSQL。</li>
</ul>
<h2 id=druid>Druid</h2>
<p>主要功能：</p>
<ul>
<li>替换 DBCP 和 c3p0。Druid 提供了一个高效、功能强大、扩展性好的数据库连接池。</li>
<li>可以监控数据库访问性能。Druid 内置了一个功能强大的 StatFilter 插件，能够详细统计 SQL 的执行性能，这有助于对线上数据库访问性能进行分析。</li>
<li>数据库加密。直接把数据库密码写在配置文件中是不好的行为，容易导致安全问题。DruidDruiver 和 DruidDataSource 都支持 PasswordCallback。</li>
<li>SQL 执行日志。Druid 提供了不同的 LogFilter，能够支持 Common-Logging、Log4j 和 JdkLog，用户可以按需要选择相应的 LogFilter，监控自己的应用的数据库访问情况。</li>
<li>扩展 JDBC。如果用户对 JDBC 层有编程的需求，可以通过 Druid 提供的 Filter 机制，很方便地编写 JDBC 层的扩展插件。</li>
</ul>
<p>Druid 在监控、可扩展性、稳定性和性能方面都有明显的优势：</p>
<ul>
<li>强大的监控特性，通过 Druid 提供的监控功能，可以清楚地知道连接池和 SQL 的工作情况。
<ul>
<li>监控 SQL 的执行时间、ResultSet 持有时间、返回行数、更新行数、错误次数、错误堆栈信息。</li>
<li>SQ L执行的耗时区间分布。什么是耗时区间分布？比如，某个 SQL 执行了 1000 次，其中在 0～1 毫秒区间50次&mldr;</li>
<li>监控连接池的物理连接创建和销毁次数、逻辑连接的申请和关闭次数、非空等待次数、PSCache 命中率等。</li>
</ul>
</li>
<li>方便扩展。Druid 提供了 Filter-Chain 模式的扩展 API，可以自己编写 Filter 拦截 JDBC 中的任何方法。</li>
<li>Druid 集合了开源和商业数据库连接池的优秀特性，并结合阿里巴巴公司大规模苛刻生产环境的使用经验进行了优化。</li>
<li>性能不是 Druid 的设计目标，但是测试数据表明，Druid 性能比 DBCP、c3p0、Proxool、JBoss 都好。
<ul>
<li>Druid 代码将近 50 万行。</li>
</ul>
</li>
</ul>
<h2 id=功能对比>功能对比</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210712234246.png style=display:block;width:90% alt=NAME align=center> </div>
<ul>
<li>LRU。LRU 是一个性能关键指标，特别是 Oracle，其中每个 Connection 对应数据库端的一个进程，如果数据库连接池遵从 LRU，有助于数据库服务器优化，这是重要的指标。</li>
<li>PSCache。PSCache 是数据库连接池的关键指标。在 Oracle 中，类似 SELECT NAME FROM USER WHERE ID =？这样的 SQL，启用 PSCache 和不启用 PSCache 的性能可能会相差一个数量级。</li>
<li>PSCache-Oracle-Optimized。在 Oracle 10 系列的 Driver 中，如果开启 PSCache，会占用大量的内存，必须做特别的处理，启用内部的 EnterImplicitCache 等方法优化才能够减少内存的占用。</li>
<li>ExceptionSorter。ExceptionSorter 是一个很重要的容错特性，如果一个连接产生了一个不可恢复的错误，必须立刻将其从连接池中去掉，否则会连续产生大量错误。</li>
</ul>
<h3 id=中断测试>中断测试</h3>
<p>将数据库连接池执行 <code>getConnection()</code> 在5秒的调用后超时，应用程序应在指定时间内获得连接，或获得异常。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210712234444.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-bf5289a54cb90ff13efab472717f661d>5.3 - 配置参数</h1>
<h2 id=时间校准>时间校准</h2>
<p>HikariCP 在很大程度上依赖于精确的高分辨率的定时器来提高性能和可靠性，所以使用数据库连接池 HikariCP 的应用服务器最好能够与时间源做同步，比如 NTP 服务器，否则由于 HikariCP 源码对于时间的处理可能会导致一些问题。</p>
<p>不稳定的时间影响的不仅仅是数据库连接池，任何定时等待、并发集合的定时轮询、带有超时的 <code>Object.wait()</code>、<code>Thread.sleep()</code> 调用等，以及任何 Java 中需要测量时间的功能都会受到影响。</p>
<h2 id=必要配置>必要配置</h2>
<h3 id=datasourceclassname>dataSourceClassName</h3>
<p>dataSourceClassName 和 jdbcUrl 是两种数据源的配置方式。</p>
<p>HikariCP 更加建议使用 dataSourceClassName，当然，两者都可以接受。需要注意的是，如果是 Spring Boot 自动装配的用户，需要使用 jdbcUrl 的基于配置的方式；当前已知的 MySQL DataSource 并不支持网络超时，建议改用 jdbcUrl 的方式。</p>
<h3 id=jdbcurl>jdbcUrl</h3>
<p>表示 HikariCP 使用传统的、基于驱动管理器 DriverManager 的配置。虽然 HikariCP 作者认为两种配置方式中，基于 dataSourceClassName 的配置由于各种原因而更优越，但对于许多部署而言，几乎没有显著差异。</p>
<p>将此属性与“旧”驱动程序一起使用时，可能还需要设置 driverClassName 属性，但首先尝试不使用该属性。如果使用此属性，用户仍可以使用 DataSource 属性来配置驱动程序，实际上建议使用 URL 本身中指定的驱动程序参数。</p>
<h3 id=username--password>username & password</h3>
<p>username 和 password 分别表示从基础驱动程序获取 Connections 时使用的默认身份验证用户名和密码。</p>
<p>HikariCP 会将 username 属性和 password 属性分别配置在 Properties 文件中，从而传递给驱动 Driver 的 DriverManager.getConnection(jdbcUrl, props) 调用。</p>
<h2 id=非必要配置>非必要配置</h2>
<h3 id=autocommit>autoCommit</h3>
<p>此属性控制从池返回的连接的默认自动提交行为。它是一个布尔值。默认值：true。</p>
<h3 id=connectiontimeout>connectionTimeout</h3>
<p>此属性控制客户端（即用户的程序）等待池中连接的最长毫秒数。如果在没有连接可用的情况下超过此时间，则将抛出 SQLException 异常。最低可接受的连接超时为250毫秒。默认值：30000（30秒）。这是一个很重要的问题排查指标。</p>
<h3 id=idletimeout>idleTimeout</h3>
<p>此属性控制连接允许被闲置在池中的最大时间。此设置仅适用于 minimumIdle 定义为比 maximumPoolSize 小的时候。一旦池到达 minimumIdle 连接的时候，空闲连接将不会退役。连接是否空闲而退役的最大变化为 +30 秒，平均变化为 +15 秒。在此超时之前，连接永远不会因空闲状态而退役。值为 0 意味着空闲连接永远不会从池中删除即永不超时。minimum 允许的最小值为 10000 毫秒（10秒）。默认值：600000（10分钟）。</p>
<p>许多防火墙和负载均衡器（通常位于应用程序和数据库之间）会占用套接字生存周期。通常，达到 idleTimeout 时，无论当前流量如何，都会切断连接。</p>
<p>HikariCP 设计之初就不支持空闲连接检测 test-while-idle，这是因为数据库管理员 DBA 往往会默认设置数据库最长连接时间是 60 秒，test-while-idle 会对数据库产生不必要的查询，这样就有可能导致数据库空闲连接出现超时的问题。</p>
<p>旧版本中，maxLifetime 由管家线程 HouseKeeper 强制执行，每 30 秒执行一次，因为 wait_timeout 减去 30 秒是推荐的 maxLifetime。但是最新版本的 HikariCP 对每个连接 connection 进行专用计时器任务，提供了几十毫秒（在高负载下长达几秒）的时间间隔，此时 maxLifetime 被安全地设置为 wait_timeout 减去5秒。如果连接退出，后台线程会执行添加操作，创建新的连接大约是 5 毫秒。如果 maxLifetime 是60秒，那么 idleTimeout 可以被设置为 0，显得就并不那么重要。</p>
<h3 id=maxlifetime>maxLifetime</h3>
<p>此属性控制池中连接的最大生命周期。使用中的连接永远不会退役，除非它被关闭然后移除。在逐个连接的基础上，应用轻微的负衰减可以避免池中的大量消亡（在源码解析部分会深入分析）。HikariCP 作者强烈建议用户设置此值，并且它应比任何数据库或基础设施实施的连接时间限制短几秒。值为 0 表示没有最大生存期（无限生存期），当然这取决于 idleTimeout 设置。默认值：1800000（30分钟）。</p>
<p>30 分钟的默认超时是非常合理的，很多开发人员都会发现，在应用程序与很多数据库之间，会有高可用代理、负载均衡、防火墙等，通常这些组件会自动且独立地终止连接 30 分钟左右。</p>
<p>一般来说，可以将 maxLifetime 设置缩短到 900000 毫秒（15分钟）然而更好的方法是，确定 MySQL 配置的 wait_timeout 值是什么，并将 HikariCP 设置为比 maxLifetime 短几分钟。</p>
<h3 id=connectiontestquery>connectionTestQuery</h3>
<p>如果您的驱动程序支持 JDBC4，我们强烈建议不要设置此属性。这适用于不支持 JDBC4 的 Connection.isValid() 的“遗留”驱动程序 API。这是一个检测查询，在数据库连接池给出连接之前进行查询，以验证与数据库的连接是否仍然存在且有效。</p>
<p>如果你追求极致性能的话，建议不要配置该属性，因为不配置的时候会通过 ping 命令进行连接检测，性能会更高。</p>
<h3 id=minimumidle>minimumIdle</h3>
<p>此属性控制 HikariCP 尝试在池中维护的最小空闲连接数。若空闲连接低于此值且池中的总连接数小于 maximumPoolSize，则 HikariCP 将尽最大努力快速有效地添加其他连接。</p>
<p>然而，为了最大限度地提高性能和对峰值需求的响应能力，HikariCP 作者建议不要设置此值，而是允许 HikariCP 充当一个固定大小的连接池（如果 minimumIdle 未设置则默认为是 maximumPoolSize，因此即使 idleTimeout 设置为 1 分钟，一旦连接关闭，它将在池中被替换）。</p>
<p>如果设置这个值，那么 HikariCP 就会是一个大小可变的池，通过 minimumIdle 进行调解控制，即使使用情况上下浮动，HikariCP 也会保持 minimumIdle 连接可用。默认值：与 maximumPoolSize 相同。</p>
<p>minimumIdle 应始终小于或等于 maximumPoolSize。如果 minimumIdle 设置为更高的值，它将推高 maximumPoolSize 到相等的值。minimumIdle 逻辑上不能超过 maximumPoolSize，因为 maximumPoolSize 指定了后端数据库的实际连接的最大数量。</p>
<p>如果有比 minimumIdle 的数目更多的连接数，如果一个连接退役了，它不会被自动替换。但是如果数据库连接池被配置为固定大小的，或者连接关闭后如果空闲连接小于 minimumIdle 的数量，那么就会立即自动替换连接。</p>
<p>启用 HikariCP 的 metrics 采集，在可视化界面上可直观地显示连接的直方图，便于用户研究并确定正确的、合理的 minimumIdle 及 idleTimeout 等值。数据库连接池的调优最好基于经验数据，具体问题具体分析。</p>
<h3 id=maximumpoolsize>maximumPoolSize</h3>
<p>此属性控制允许数据库连接池到达的最大大小，包括空闲和正在使用的连接。基本上，此值将确定到数据库后端的实际连接的最大数量。合理值最好由用户的执行环境决定。当池达到此大小且没有空闲连接可用时，对 getConnection() 的调用将阻塞到超时前 connectionTimeout 毫秒。关于连接池大小 PoolSize 的相关知识请关注本章后续内容。默认值：10。</p>
<h3 id=metricregistry>metricRegistry</h3>
<p>此属性仅通过编程配置或 IoC 容器可用。此属性允许用户指定池使用的 Codahale /Dropwizard 实例 MetricRegistry，来记录各种度量标准。如果用户需要使用 Prometheus 等监控的话，还需要做一些操作。</p>
<h3 id=healthcheckregistry>healthCheckRegistry</h3>
<p>此属性仅通过编程配置或 IoC 容器可用。此属性允许用户指定池使用的 Codahale /Dropwizard 实例 HealthCheckRegistry，来报告当前系统的健康信息。默认值：无。</p>
<h3 id=poolname>poolName</h3>
<p>此属性表示连接池的用户定义名称，主要显示在日志记录和JMX管理控制台中，以标识池和池配置。默认值：自动生成。</p>
<h2 id=非常用配置>非常用配置</h2>
<h3 id=initializationfailtimeout>initializationFailTimeout</h3>
<p>如果池无法成功初始化连接，则此属性控制池是否“快速失败”。任何正数都被认为是尝试获取初始连接的毫秒数；在此期间，应用程序线程将被阻塞。如果在超时发生之前无法获取连接，则将引发异常。initializationFailTimeout超时发生在connectionTimeout阶段之后。如果值为0, HikariCP将尝试获取并验证连接。如果获得连接但验证失败，则抛出异常，而不会启动池。但是，如果无法获得连接，则池将启动，但稍后获取连接的尝试会失败。小于0的值将绕过任何初始连接尝试，并且池将在尝试在后台获取连接时立即启动。因此，以后获得连接的尝试可能会失败。默认值：1。</p>
<h3 id=isolatelnternalqueries>isolatelnternalQueries</h3>
<p>此属性决定HikariCP是否在自己的事务中隔离内部池查询，例如连接存活测试。由于这些通常是只读查询，因此很少有必要将它们封装在自己的事务中。此属性仅在autoCommit禁用时适用。默认值：false。</p>
<h3 id=allowpoolsuspension>allowPoolSuspension</h3>
<p>此属性控制池是否可以通过JMX挂起和恢复。这对某些故障转移自动化方案很有用。当池被挂起时，调用getConnection()将不会超时，并将一直保持到池恢复为止。默认值：false。</p>
<h3 id=readonly>readOnly</h3>
<p>此属性控制默认情况下从池中获取的Connections是否处于只读模式。请注意，某些数据库不支持只读模式的概念，而其他数据库在Connection设置为只读时提供查询优化。是否需要此属性将在很大程度上取决于那的应用程序和数据库。默认值：false。</p>
<h3 id=registermbeans>registerMbeans</h3>
<p>此属性控制是否注册JMX管理Bean（“MBean”）。默认值：false。</p>
<h3 id=catalog>catalog</h3>
<p>此属性为支持catalog的数据库设置默认catalog。如果未指定此属性，则使用JDBC驱动程序定义的默认catalog。默认值：driver default。</p>
<h3 id=connectionlnitsql>connectionlnitSql</h3>
<p>此属性设置一个SQL语句，该语句将在每次创建新连接之后执行，然后再将该连接添加到池中。如果此SQL无效或抛出异常，它将被视为连接失败，并将遵循标准重试逻辑。默认值：无。</p>
<h3 id=driverclassname>driverClassName</h3>
<p>HikariCP将尝试仅基于jdbcUrl通过DriverManager解析驱动程序，但对于某些较旧的驱动程序必须指定driverClassName。除非用户收到明显的错误消息，表明未找到驱动程序，否则可忽略此属性。默认值：无。</p>
<h3 id=transactionlsolation>transactionlsolation</h3>
<p>此属性控制从池返回的连接的默认事务隔离级别。若未指定，则用JDBC驱动程序定义的默认事务隔离级别。仅当有针对所有查询的特定隔离需求时，才使用此属性。此属性的值是Connection类的常量名，如TRANSACTION_READ_COMMITTED、TRANSACTION_REPEATABLE_READ等。默认值：driverdefault。</p>
<h3 id=validationtimeout>validationTimeout</h3>
<p>此属性控制连接测试活性的最长时间。该值必须小于connectionTimeout。最低可接受的验证超时为250毫秒。默认值：5000。</p>
<h3 id=leakdetectionthreshold>leakDetectionThreshold</h3>
<p>此属性控制连接在记录一条指示可能连接泄漏的消息之前流出池的时间。值为0表示禁用泄漏检测。启用泄漏检测的最低可接受值是2000（2秒）。默认值：0。</p>
<h3 id=datasource>dataSource</h3>
<p>此属性仅可通过编程配置或IoC容器获得。此属性允许用户直接设置DataSource要由池包装的实例，而不是让HikariCP通过反射构造它。这在一些依赖注入框架中很有用。指定此属性后，dataSourceClassName将忽略该属性和所有特定于DataSource的属性。默认值：无。</p>
<h3 id=schema>schema</h3>
<p>该属性为支持schema概念数据库设置默认schema。如果未指定此属性，则使用JDBC驱动程序定义的默认模式。默认值：driver default。</p>
<h3 id=threadfactory>threadFactory</h3>
<p>此属性仅可通过编程配置或IoC容器获得。此属性允许设置java.util.concurrent. ThreadFactory将用于创建池使用的所有线程的实例。在注入线程只能通过应用程序容器提供的ThreadFactory创建的某些受限执行环境中使用它。默认值：无。</p>
<h3 id=scheduledexecutor>scheduledExecutor</h3>
<p>仅可通过编程配置或IoC容器获得。允许设置java.util.concurrent.Scheduled-ExecutorService用于各种内部调度任务的实例。如果向HikariCP提供ScheduledThread-PoolExecutor实例，建议设置setRemoveOnCancelPolicy(true)。默认值：无。</p>
<h2 id=容量设置>容量设置</h2>
<h3 id=公式>公式</h3>
<p>拥有一个CPU内核的计算机可以同时执行数十或数百个线程，其实这只是操作系统的一个time-slicing（时间切片）的把戏。实际上，单核只能一次执行一个线程，然后由操作系统切换上下文，并且内核为另一个线程执行代码，依此类推。这是一个基本的计算法则，给定一个CPU资源，按顺序执行A和B总是比通过时间片“同时”执行A和B要快。一旦线程数量超过了CPU核心的数量，添加更多的线程速度就会变慢，而不是更快。</p>
<p>设计多线程是为了尽可能地利用CPU空闲等待时间（及IO、交互等），它的代价就是要增加部分CPU时间来实现线程切换。如果CPU空闲等待时间已经比线程切换更短（线程越多，切换消耗越大），那么线程切换会非常影响性能，成为系统瓶颈。</p>
<p>当我们查看数据库的主要瓶颈是什么时，它们可以归纳为3个基本类别：CPU、磁盘、网络。</p>
<p>可以在PostgreSQL基准测试中看到，TPS速率开始在大约50个连接处变平：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210714233613.png style=display:block;width:50% alt=NAME align=center> </div>
<p>下面的公式也是由PostgreSQL项目提供的，它同样在很大程度上适用于数据库。实际生产中，用户测试应用程序，即模拟预期的负载，并在此起点周围尝试不同的池设置。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>connections =（（core_count×2）+ effective_spindle_count）
</code></pre></div><p>effective_spindle_count 就是磁盘列阵中的硬盘数。某PostgreSQL项目做过测试，拥有一个硬盘的小型4核i7服务器的连接池大小设置为：9 = ((4×2) + 1)。这样的连接池大小居然可以轻松处理3000个前端用户在6000 TPS下进行简单查询。这里的线程数指的是数据库进程中的线程，通常通过连接调度的查询将在数据库的单个线程上执行，连接和线程在大多数情况下几乎都是一对一的关系。</p>
<p>在公式的配置上，如果加大压力，TPS会下降，RT会上升，可以适当地根据情况进行调整加大。这时应考虑整体系统性能，同时考虑线程执行需要的等待时间，合理地设计线程数目。但是，不要过度配置你的数据库。如果一直给HikariCP增加压力，那么性能也可能会产生急剧的下降。</p>
<ul>
<li>如果查询是5毫秒，则通过单个连接每秒可以处理大约200个查询。</li>
<li>如果查询是100毫秒，单个连接每秒可以处理大约10个查询。</li>
<li>对数据库而言，5台Server各自拥有一个连接和每台Server拥有5个连接几乎相同。</li>
<li>如果有慢查询和快速查询的混合，由于慢查询会锁定数据库连接池，建议长时间运行的查询使用单独的数据库连接池。</li>
</ul>
<p>数据库连接池的大小设置针对的是单个组件、应用程序和单个数据库。在多个微服务同时访问单个共享数据库的时候，情况就会变得比较棘手，这时就需要提炼出一些应对它的方法。对于单个应用程序来说，如果同时运行任何超过10个查询会产生较低的吞吐量和较高的延迟，如果平均查询时间是2ms，那么在2ms的时间内可以满足10个查询。如果我们允许20个查询（HikariCP数据库连接池的大小为20），则在2ms内无法满足同时运行20个查询，并且由于调度程序的时间分片开销，实际上可能超过2倍。如果微服务A和微服务B同时对该数据库进行查询，并持续生成连续负载，按照10个查询的稳定性大小，服务A和服务B分别设置数据库连接池大小为5是有意义的。对于生成连续负载的N服务，最大池大小的公式很简单：（最大同时数据库查询）/ N。</p>
<p>但是服务A和服务B之间还有一些突发性，比如A或者B一段时间内爆发大量查询，一段时间内相对空闲，这时候最大数据库连接池大小设为5～10会比较好。微服务越多，这个就越复杂。度量标准Metrics是进行数据库连接池大小评估的很有效的工具。首先，根据对其需求的最佳预测，为每个微服务选择一个池大小，而不考虑其他服务，并收集每项服务的指标：Active connections（活动连接）、Idle connections（空闲连接）、Waiting threadcount（等待线程数）、Usage（每个连接离开池多长时间）。然后，根据这些指标找到峰值并尝试确定原因，进行分类对比，并确定总活动超过数据库容量和CPU的点是否与峰值对应。最后，通过不断重复这些过程，根据收集的指标慢慢进行匹配对比，观察分析，从而找到数据库连接池最合适的大小。</p>
<h3 id=池锁>池锁</h3>
<p>池锁代表数据库连接池由于由于竞争资源或者由于彼此通信而造成的一种阻塞的现象。</p>
<p>很多实际使用数据库连接池的用户在开发过程中或多或少遇到过池锁的问题。增大连接池大小可以缓解池锁问题，但是扩大池之前可以先检查一下应用层面是否能够调优，而不要直接调整连接池大小。</p>
<p>避免池锁有一个简单的资源分配公式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>pool size = Tn x (Cm -1) + 1
</code></pre></div><p>Tn 是线程的最大数量，Cm 是单个线程持有的同时连接的最大数量。例如，有3个线程（Tn = 3），每个线程需要4个连接来执行某个任务（Cm = 4）。确保永不死锁的池大小是： 3 x（4-1）+ 1 = 10。</p>
<p>如果有10个线程（Tn = 10），每个线程需要2个连接（Cm =2）来执行某个任务，确保永不出现死锁所需的池大小是：10x（2-1）+ 1 = 11。</p>
<p>再比如，最多有8个线程（Tn = 8），每个线程需要3个连接来执行一些任务（Cm =3）。确保永远不可能死锁的池大小是： 8×（3-1）+ 1 = 17注意，这不一定是最佳池大小，但是是避免死锁所需的最低限度，也就是最小的池大小。</p>
<p>在某些环境中，使用JTA（Java事务管理器）可以显著减少从同一个Connection返回getConnection()到当前事务中已经存储Connection的线程所需的连接数。</p>
<h3 id=建议>建议</h3>
<p>混合了长时间运行事务和非常短的事务的系统通常是最难调整任何连接池的系统。在这些情况下，创建两个池实例可以很好地工作（例如，一个用于长时间运行的事务，另一个用于“实时”查询）。</p>
<p>对于长期运行的外部系统，例如只允许一定数量的作业同时运行的作业执行队列，这时作业队列大小就是连接池非常合适的大小。</p>
<p>总结如下：连接池是综合每个应用系统的业务逻辑特性，加上应用硬件配置，加上应用部署数量，再加上DB硬件配置和最大允许连接数等测试出来的，很难用一个公式简单进行计算。连接数及超时时间设置不正确经常会带来较大的性能问题，并影响整个服务能力的稳定性。具体设置多少，要看系统的访问量，可通过反复测试，找到最佳点。压测很重要。</p>
<h2 id=fixed-pool-design>Fixed Pool Design</h2>
<p>基于大量实践得到的经验值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>maximumPoolSize: 20
minimumIdle: 10
</code></pre></div><p>HikariCP的初始版本只支持固定大小的池。作者初衷是，HikariCP是专门为具有相当恒定负载的系统而设计的，并且倾向于连接池大小保持其运行时允许达到的最大大小，所以作者认为没有必要将代码复杂化以支持动态调整大小。</p>
<p>如果想要支持动态调整不同负载的最佳池大小设置，可以配合Hikari使用同为the Mutual Admiration Society成员的VladMihalcea研究的FlexyPool。当然，连接池上限受到数据库最优并发查询容量的限制，这正是HikariCP关于池大小起作用的地方。然而，在池的最小值和最大值之间，FlexyPool不断尝试递增，确保该池大小在提供服务的过程中动态负载一直是正确的。</p>
<p>FlexyPool具有以下默认策略：</p>
<ul>
<li>在超时时递增池。此策略将增加连接获取超时时的目标连接池最大大小。连接池具有最小的大小，并可根据需要增长到最大大小。该溢出是多余的连接，让连接池增长超过其初始的缓冲区最大尺寸。每当检测到连接获取超时时，如果池未增长到其最大溢出大小，则当前请求不会失败。</li>
<li>重试尝试。此策略对于那些缺少连接获取重试机制的连接池非常有用。</li>
</ul>
<h3 id=核心逻辑>核心逻辑</h3>
<p>minIdle来指定空闲连接的最小数量，maxPoolSize指定连接池连接最大值，默认初始化的时候，是初始化minIdle大小的连接，如果minIdle与maxPool-Size值相等，那就是初始化时把连接池填满。idleTimeout用来指定空闲连接的时长，maxLifetime用来指定所有连接的时长。com.zaxxer.hikari.housekeeping.periodMs用来指定连接池空闲连接处理及连接池数补充的HouseKeeper任务的调度时间间隔。所有的连接在maxLifetime之后都得重连一次，以保证连接池的活性。</p>
<h2 id=mysql-配置>MySQL 配置</h2>
<p>MySQL 的主要性能配置参数是：</p>
<ul>
<li>prepStmtCacheSize：这将设置MySQL驱动程序将为每个连接缓存的预准备语句数。默认值为保守25。我们建议将其设置为250～500。</li>
<li>prepStmtCacheSqlLimit：这是驱动程序将缓存的已准备SQL语句的最大长度。MySQL的默认值是256。根据我们的经验，特别是对于像Hibernate这样的ORM框架，这个默认值远低于生成的语句长度的阈值。我们推荐的设置是2048。</li>
<li>cachePrepStmts：如果事实上禁用了高速缓存，则上述任何参数都不会产生任何影响，因为它是默认情况下。必须将此参数设置为true。</li>
<li>useServerPrepStmts：较新版本的MySQL支持服务器端预处理语句，这可以提供显著的性能提升。应将此属性设置为true。</li>
</ul>
<p>HikariCP 的典型 MySQL 配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>jdbcUrl=jdbc:mysql://localhost:3306/simpsons
user=test
password=test
dataSource.cachePrepStmts=true
dataSource.prepStmtCacheSize=250
dataSource.prepStmtCacheSqlLimit=2048
dataSource.useServerPrepStmts=true
dataSource.useLocalSessionState=true
dataSource.rewriteBatchedStatements=true
dataSource.cacheResultSetMetadata=true
dataSource.cacheServerConfiguration=true
dataSource.elideSetAutoCommits=true
dataSource.maintainTimeStats=false
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-69b3ca93e755caee774ee61d37a37b29>5.4 - JDBC API</h1>
<h2 id=hikaricp-jdbc-logging>HikariCP JDBC Logging</h2>
<p>HikariCP 目前并不包含 JDBC 的日志记录。因为作者认为日志记录是性能杀手，甚至检查是否启用或禁用日志记录的布尔值对 HikariCP 来说也是多余的开销，几乎每个驱动程序都支持某种类型的日志记录，并且 ORM 框架也不可避免这样去做。</p>
<p>对于驱动程序不支持 JDBC 直接记录，或者希望此解决方案的灵活性优于数据库供应商的产品，log4jdbc-log4j2 是一个不错的选择。</p>
<p>另外还有 P6spy，它似乎略微比 log4jdbc-log4j2 更易于维护。</p>
<h2 id=jdbc>JDBC</h2>
<p>在 Vlad Mihalcea 的 &ldquo;High-Performance JavaPersistence&rdquo; 一书中给出了一张数据访问技术栈的图片，如图所示。我们可以看到 JDBC 在整个数据访问技术栈中起着非常重要的作用。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210714235606.png style=display:block;width:50% alt=NAME align=center> </div>
<p>JDBC 代表 Java 数据库连接，是基于 Java 开发的系统中程序员和数据库打交道的主要途径，提供了完备的数据库操作方法接口。</p>
<h2 id=jdbc-定义>JDBC 定义</h2>
<p>JDBC，Java DataBase Connectivity。</p>
<p>JDBC API 是一个 Java API，可以访问任何类型表列数据，特别是存储在关系数据库中的数据。</p>
<p>JDBC API 由一组用 Java 编写的类和接口组成。为工具/数据库开发人员提供标准 API 的编程语言，可以使用全 Java API 编写工业级数据库应用程序。JDBC API 可以轻松地将 SQL 语句发送到关系数据库系统，并支持所有 SQL 方言。但是 JDBC 2.0 API 超越了 SQL，也使得与其他类型的数据源(例如包含表格数据的文件)进行交互成为可能。</p>
<p>JDBC API 的价值在于，应用程序几乎可以访问任何数据源，并可以在任何具有 Java 虚拟机的平台上运行。换句话说，使用 JDBC API，不必编写一个程序来访问 Sybase 数据库，另一个程序访问 Oracle 数据库，另一个程序访问 IBM DB2 数据库，等等。</p>
<p>JDBC API 是 Java 编程语言与各种数据库之间数据库无关连接的行业标准。JDBC API 为基于 SQL 的数据库访问提供了调用级 API。JDBC 技术允许您使用 Java 编程语言为需要访问企业数据的应用程序提供“一次编写，随处运行”功能。</p>
<p>JDBC API 是一种执行 SQL 语句的 API, JDBC 驱动才是真正的接口实现，所有的网络逻辑和特定于数据库的通信协议都隐藏于、独立于供应商的 JDBC API 后面。Sun 公司只是提供了JDBC API，每个数据库厂商都有自己的驱动来连接自己公司的数据库，如图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000314.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们可以看到，JDBC API 采用了桥接的设计模式，提供了两套接口，JDBC Driver Planager 面向数据库厂商，如Oracle、SQL Seruer 等；JDBC API 面向 JDBC 使用者，如 Java Application。</p>
<p>JDBC 接口相当于实现化角色接口，数据库厂商实现的驱动相当于具体实现化子类，应用程序相当于抽象化角色，内部持有一个实现化角色的对象。桥接模式将实现化和抽象化解耦，从而让两个部分可以沿着不同的方向拓展，只要遵循接口即可，从而学习成本低。</p>
<p>JDBC 连接数据库时，在各个数据库之间进行切换，基本上不需要动太多的代码，甚至丝毫不动，原因就是 JDBC 提供了统一接口，每个数据库提供各自的实现，用一个叫作数据库驱动的程序来桥接就行了。</p>
<p>JDBC 定义了 4 种驱动类型：JDBC-ODBC 桥、本地 API 驱动、网络协议驱动、本地协议驱动。由于易于设置和调试，第 4 种类型本地协议驱动纯粹基于 Java 的多驱动程序，通过 Socket 连接与厂商的数据库进行通信，是首选的方案。</p>
<p>通过 DriverManager 获取连接：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000611.png style=display:block;width:70% alt=NAME align=center> </div>
<p>通过 DataSource 获取连接：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000647.png style=display:block;width:70% alt=NAME align=center> </div>
<p>由于减少了创建和关闭连接的开销，HikariCP 等数据库连接池的出现又将 JDBC 的性能大大提升了一个档次。使用数据库连接池作为 JDBC 的最佳实践已经几乎成了公认的标准。</p>
<p>除此之外，JDBC 的最佳实践还有如下内容：</p>
<ul>
<li>使用 PrearedStatement，通过预编译的方式避免在拼接SQL时造成SQL注入，使用“? ”或其他占位符等变量绑定的形式可以使用不同的参数执行相同的查询也能防止 SQL 注入。</li>
<li>禁用自动提交，这样可以将数据库操作放在一个事务中，而不是每次执行 SQL 语句都在执行结束时提交自己独立的事务。</li>
<li>JDBC 批处理可以降低数据库传输频率，进而提升性能。</li>
<li>使用列名而不是列序号获取 ResultSet 中的数据，避免 invalidColumIndexError，从而提升程序的健壮性、可读性。</li>
<li>在 Java 7 中，可以通过 Automatic ResourceManagement Block 来自动关闭资源。要记得关闭所有的Connection、Statement 等资源。</li>
<li>使用标准的 SQL 语句(如标准的ANSI SQL)，避免数据库对 SQL 支持的差异。</li>
</ul>
<h2 id=jdbc-剖析>JDBC 剖析</h2>
<p>JDK 规定了 JDBC 的相关接口，JDBC 是 SPI(服务提供者接口) 框架的良好应用。JDBC API 主要位于 JDK 中的 java.sql 包中，扩展的内容位于 javax.sql 包中。</p>
<p><code>java.sql.*</code> 采用传统的 C/S 体系结构思想设计它所包含的接口和类，核心类图如图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000932.png style=display:block;width:70% alt=NAME align=center> </div>
<p>它包含生成连接、执行语句等功能，包括一些诸如批处理更新、可滚动结果集、事务隔离、封装 SQLException 等功能。<code>java.sql.*</code> 属于 JDBC2.0 之前，通常被称为 JDBC 内核 API; <code>javax.sql.*</code> 包括了 JDBC 3.0 的很多新特性，被称为 JDBC 标准扩展。</p>
<p><code>javax.sql.*</code> 作为标准扩展，提供了很多对<code>java.sql.*</code>的补充和新特性。体现在 Datasource 接口提供了一种可选择性的方式去建立连接，分布式事务处理，增加 rowset，增加连接池等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715001102.png style=display:block;width:70% alt=NAME align=center> </div>
<p>了解 JDBC，关注点更多的还是 <code>java.sql.*</code> 包，在这个包里，有 4 个核心接口(Driver、Connection、Statement和ResultSet)和两个核心类(DriverManager和SQLException)。类型的对象。它还提取与使用 Driver 对象相关的信息。不同的数据库有不同的装载方法。</p>
<ul>
<li><strong>DriverManager</strong>：管理一组数据库驱动程序的基本服务。使用通信子协议将来自 Java 应用程序的连接请求与适当的数据库驱动程序进行匹配。在 JDBC 下识别某个子协议的第一个驱动程序将用于建立数据库连接。其初始化时用到 ServiceLoader 机制，所以可以直接用 Class.forName(driver)；就可以完成加载驱动。在 DriverManager 里面，有一个 ArrayList，专门用来保存注册好的 Driver，并使用了 CopyOnWriteArrayList 来保证多线程环境下的线程安全。</li>
<li><strong>Driver</strong>：此接口处理与特定数据库服务器的通信，是每个数据库驱动都必须继承的接口。我们很少会直接与 Driver 对象进行交互。但会使用 DriverManager 对象来管理。</li>
<li><strong>Connection</strong>：此接口具有用于链接数据库的所有方法。连接(Connection)对象表示通信上下文，即，与数据库的所有通信仅通过连接对象。拥有创建 SQL 语句的方法，以完成基本的 SQL 操作，同时为数据库事务提供提交和回滚方法。
<ul>
<li><code>createStatement()</code>：创建向数据库发送 SQL 的 statement 对象。</li>
<li><code>prepareStatement(sql)</code>：创建向数据库发送预编译 SQL 的 PrepareSatement 对象。</li>
<li><code>prepareCall(sql)</code>：创建执行存储过程的 callableStatement 对象。</li>
<li><code>setAutoCommit(boolean autoCommit)</code>：设置事务是否自动提交。</li>
<li><code>commit()</code>：在连接上提交事务。</li>
<li><code>rollback()</code>：在此连接上回滚事务。</li>
</ul>
</li>
<li><strong>Statement</strong>：使用从此接口创建的对象将 SQL 语句提交到数据库。除了执行存储过程之外，一些派生接口还接受参数。它由 createStatement 创建，用于发送简单的 SQL 语句(不带参数)。除此以外，还有两种Statement：PreparedStatement 和 CallableStatement，如图上图所示．CallableStatement 继承自 PreparedStatement，PreparedStatement 继承自 Statement。
<ul>
<li><strong>PreparedStatement</strong>：PreparedStatement 接口扩展了 Statement 接口，它添加了比 Statement 对象更好一些的功能。此语句由 preparedStatement 创建，可以动态地提供/接受参数，进行 SQL 语句的预编译，也可以动态拼接。因为会进行预编译，所以当用动态拼接的时候，会对传入的参数进行强制转换，所以会对参数进行校验，可以避免 SQL 注入。开发的时候尽量用 preparedStatement，少用 statement。PreparedStatement 对象有能力使用提供参数数据的输入和输出流。它可以将整个文件输入数据库中，可容纳较大的值，如 CLOB 和 BLOB 数据类型的列。对于 PreparedStatement，会有一个 LRUCache 来存放，先到那里去取，取不到再创建一个新的，这个 LRUCache 的默认大小是 25。</li>
<li><strong>CallableStatement</strong>：由方法 prepareCall 创建，为所有的 DBMS 提供了一种以标准形式调用数据库储存过程的方法。</li>
<li>常用方法：
<ul>
<li><code>execute(String sql)</code>：运行语句，返回是否有结果集。</li>
<li><code>executeQuery(String sql)</code>：运行 select 语句，返回 ResultSet 结果集。</li>
<li><code>executeUpdate(String sql)</code>：运行 insert/update/delete 操作，返回更新的行数。</li>
<li><code>addBatch(String sql)</code>：把多条 SQL 语句放到一个批处理中。</li>
<li><code>executeBatch()</code>：向数据库发送一批 SQL 语句执行。</li>
</ul>
</li>
</ul>
</li>
<li><strong>ResultSet</strong>：在使用 Statement 对象执行 SQL 查询后，这些对象保存从数据库检索到的数据。它作为一个迭代器并可移动 ResultSet 对象查询的数据。但是结果集并不仅仅具有存储的功能，它同时还具有操纵数据的功能，可能完成对数据的更新等。
<ul>
<li><code>getString(int index)</code>、<code>getString(StringcolumnName)</code>：获得数据库里 varchar、char 等类型的数据对象。</li>
<li><code>getFloat(int index)</code>、<code>getFloat(StringcolumnName)</code>：获得数据库里 Float 类型的数据对象。</li>
<li><code>getDate(int index)</code>、<code>getDate(StringcolumnName)</code>：获得数据库里 Date 类型的数据。</li>
<li><code>getBoolean(int index)</code>、<code>getBoolean(StringcolumnName)</code>：获得数据库里 Boolean 类型的数据。</li>
<li><code>getObject(int index)</code>、<code>getObject(StringcolumnName)</code>：获取数据库里任意类型的数据。</li>
<li><code>next()</code>：移动到下一行。</li>
<li><code>previous()</code>：移动到前一行。</li>
<li><code>absolute(int row)</code>：移动到指定行。</li>
<li><code>beforeFirst()</code>：移动到 ResultSet 的最前面。</li>
<li><code>afterLast()</code>：移动到 ResultSet 的最后面。</li>
</ul>
</li>
<li><strong>SQLException</strong>：此类处理数据库应用程序中发生的任何错误。</li>
</ul>
<p>需要强调的是，Connection、Statement 和 Result 是一种“爷—父—子”的关系，对 Connection 的管理，就是对数据库资源的管理。如果想确定某个数据库连接(Connection)是否超时，则需要确定其(所有的)子 Statement 是否超时，同样，需要确定所有相关的 ResultSet 是否超时；Statement 关闭会导致 ResultSet 关闭，但是 Connection 关闭却不一定会导致 Statement 关闭。</p>
<p>在数据库连接池里，Connection 关闭并不是物理关闭，只是归还连接池，所以 Statement 和 ResultSet 有可能被持有，并且实际占用相关的数据库的游标资源。所以在关闭 Connection 前，需要关闭所有相关的 Statement 和 ResultSet。这就是 HikariCP 作者所强调的 JDBC 的最基本的规范，也是他创造 HikariCP 的原因，数据库连接池一定不能违背这样的规则。</p>
<p>最好方案就是顺序关闭 ResultSet、Statement、Connection；在 <code>rs.close()</code> 和 <code>stmt.close()</code> 后面加上 <code>rs= null</code> 和 <code>stmt = null</code> 来防止内存泄漏；RowSet 不依赖于 Connection 和 Statement 可以作为一种传递 ResultSet 的替代方案。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715002026.png style=display:block;width:50% alt=NAME align=center> </div>
<p>通过 DriverManger 获得 Connection，一个 Connection 对应一个实际的物理连接，每次操作都需要打开物理连接，使用完后立即关闭；这样频繁地打开/关闭连接会造成不必要的数据库系统性能消耗。</p>
<p>这样的背景下催生了数据库连接池的产生，数据库连接池提供的解决方案是：当应用启动时，主动建立足够多的数据库连接，并将这些连接组织成连接池，每次请求连接时，无须重新打开连接，而是从池中取出已有连接，使用完后并不实际关闭连接，而是将其归还给池。</p>
<p>所以这里需要涉及两项技术，<strong>一是连接使用 List 之类的集合进行初始化、装载和归还，二是使用动态代理来把资源归回给 List 集合。</strong></p>
<p>而HikariCP之所以这么快，也主要是将这两项技术做到了极致。</p>
<p>JDBC 数据库连接池使用<code> javax.sql.DataSource</code> 表示，DataSource 只是一个接口，其实现通常由服务器提供商(如WebLogic、WebShere)或开源组织(如 DBCP、c3p0 和 HikariCP)提供。</p>
<h3 id=preparedstatement--statement>PreparedStatement & Statement</h3>
<p>PreparedStatement 在企业开发中被强烈推荐使用，原因主要有以下方面：</p>
<ul>
<li>
<p>Statement 会频繁编译 SQL。如果 JDBC 驱动支持的话(一般来说数据库系统库系统初次分析、编译时会对查询语句做最大的性能优化), PreparedStatement 可对 SQL 进行预编译，提高效率，预编译的 SQL 存储在 PreparedStatement 对象中。从这个意义上来说，PreparedStatement 比 Statement 更快，使用 PreparedStatement 也可以降低生产环境的数据库负载。</p>
</li>
<li>
<p>Statement 对象编译 SQL 语句时，如果 SQL 语句有变量，就需要使用分隔符来隔开，如果变量非常多，就会使 SQL 变得非常复杂。PreparedStatement 可以使用占位符，通过动态参数化的查询来简化 SQL 的编写。比如下面这个参数化查询例子，通过使用相同的 SQL 语句和不同的参数值来做查询，比创建一个不同的查询语句要好。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>SELECT telephone_number FROM city WHERE username =?
</code></pre></div></li>
<li>
<p>PreparedStatement 可防止 SQL 注入。因为 Statement 对象需要拼接，通过分隔符“++”编写永等式就可以实现 SQL 注入；而 PreparedStatement 使用占位符，就不会有 SQL 注入的问题。</p>
</li>
</ul>
<h2 id=jdbc--spi>JDBC & SPI</h2>
<p>为了实现在模块装配的时候能不在程序里动态指明，需要一种服务发现机制。JDK 内置的 SPI(Service ProviderInterface)就能提供这样的一个机制：为某个接口寻找服务实现的机制。有点类似 IOC 的思想，就是将装配的控制权移到程序之外，在模块化设计中这个机制尤其重要。</p>
<p>JDBC 4.0 以前，开发人员还需要基于 <code>Class.forName(“xxx”)</code> 的方式来装载驱动，而 JDBC 4.0 基于 SPI 机制来发现驱动提供商，可以通过 <code>META-INF/services/java.sql.Driver</code> 文件里指定实现类的方式来暴露驱动提供者。开发者只需要编写一行代码，使用不同厂商的 jar 包，就可以轻松创建连接了。</p>
<h2 id=线程池技术>线程池技术</h2>
<p>池化技术，包括线程池、连接池、内存池、对象池等，其作用就是提前保存大量的资源，或者将用过的资源保存起来，等下一次需要使用该资源时再取出来重复使用。</p>
<p>线程池和连接池是两个不同的概念，连接池一般在客户端设置，而线程池是在如数据库这样的服务器上配置。通常来说，比较好的方式是将连接池和线程池结合起来使用。线程池具有线程复用、控制最大并发数、管理线程、保护系统4个优点，线程池的目的类似于连接池，通过复用线程来减少频繁创建和销毁线程，从而降低性能损耗。</p>
<p>线程池往往配合队列一起工作，限制并发处理任务的数量，从而保护系统。线程池的工作方式大同小异：先将任务提交到一个或者多个队列中，接着一定数量的线程从该队列中领取任务并执行，任务的结果再做处理，比如保存到MySQL数据库、调用别的服务等；任务完成以后，该线程会返回任务队列，等待下一个任务。</p>
<h3 id=mysql-线程池>MySQL 线程池</h3>
<p>传统方式下，MySQL 线程调度方式有两种：每个连接一个线程(One-Thread-Per-Connection)和所有连接一个线程(no-threads)。</p>
<p>MySQL 线程池是 MySQL 5.6 企业版的一个核心功能，是为了解决 One-Thread-Per-Connection 的实际生产常用选择的问题而引入的，通过有效管理大量客户端连接的语句执行线程数量，减少内存消耗，降低上下文切换(提高CPU Cache命中率)等来提高服务器性能。</p>
<p>在线程池 Thread Pool 处理方案中，最小单位是 statement，一个线程可以处理多个连接的请求，可以避免瞬间连接风暴造成的抖动。MySQL 线程池只在 Percona、MariaDB、Oracle 的 MySQL 企业版中提供，Oracle MySQL 社区版并不提供。MariaDB 在 5.5 版本中引入并最先实现线程池 Thread Pool 方案，Oracle 在 6.10 企业版本以 plugin 插件形式引入，Percona 在移植 MariaDB 的 Thread Pool 方案后又修复了一系列问题并优化了线程池性能。</p>
<p>使用“show variables like ‘thread%'”命令可以看到 thread_handling 的配置，默认情况是 one-thread-per-connection，即不启用线程池；将该参数设置为 pool-of-threads 即启用了线程池。</p>
<p>可以这么说，在 Percona 版本以后，MySQL 支持 No-Threads、One-Thread-Per-Connection 和 Pool-Threads 三种管理方式。Oracle Mysql 官方的性能测试表明：</p>
<ul>
<li>在并发达到 128 个连接以后．没有线程池的 MySQL 性能会迅速降低。使用线程池以后，性能不会出现波动，会一直保持在较好的状态运行。</li>
<li>在读写模式下，128 个连接以后，有线程池的 MySQL 比没有线程池的 MySQL 性能高出 60 倍。</li>
<li>在只读模式下，512 个连接以后，有线程池的 MySQL 比没有线程池的 MySQL 性能高出 18 倍。</li>
</ul>
<p>我们可以看到，Thread Pool 极大地提升了性能，并且解决了 One-Thread-Per-Connection 的如下 3 个问题：</p>
<ul>
<li>太多的线程堆栈使 CPU 缓存在高度并行的执行工作负载中几乎无用。线程池促进了线程堆栈重用，以最小化 CPU 缓存占用空间。</li>
<li>由于太多线程并行执行，因此上下文切换开销很高。这也给操作系统调度程序带来了挑战性的任务。线程池控制活动线程的数量，以使 MySQL 服务器内的并行性保持在它可以处理的水平，并且适用于 MySQL 正在执行的服务器主机。</li>
<li>并行执行的事务太多会增加资源争用。</li>
</ul>
<h3 id=mysql-线程池内部>MySQL 线程池内部</h3>
<p>排队理论中存在一个众所周知的关系：尝试访问共享资源的用户越多，响应时间越长，并呈指数级增长。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003135.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在吞吐量上，随着用户的不断增多，由于内部通信和同步，系统每秒能够处理的请求就越来越少，甚至会导致系统没有反应并且直接卡死，如图所示。众所周知的 DDoS 攻击就是类似这样的行为。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003154.png style=display:block;width:50% alt=NAME align=center> </div>
<p>而 MySQL 线程池在面对上述困难时，旨在提供如图所示的吞吐量曲线。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003217.png style=display:block;width:50% alt=NAME align=center> </div>
<p>MySQL 线程池本身并不会神奇地提高性能，但是它可以保护 MySQL 突然过载的情况，打造上图所示的稳定性曲线，这是通过其限制 MySQL 内部的工作线程数量来实现的。</p>
<p>如图下所示，这是 MySQL Thread Pool 的架构图，MySQL 的线程池提出了一个线程组的概念，工作线程被放在了线程组内部。我们可以看到 Thread Pool 由一个 Timer 线程和多个线程组构成，每个线程组内部由优先队列、普通队列两个队列，以及一个 Listener 线程和多个工作线程组成。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003309.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>线程组，在初始化以后会由底层的 IO 库分配到一个特殊的句柄 pollfd，每个线程组都有一个对应的 pollfd。</li>
<li>Worker 线程，是真正干活的线程，它具有活跃、空闲和等待3种状态。</li>
<li>Listener 线程，主要用来监听该线程组的语句，通过 pollfd 中轮询 IO 任务来决定是 Listener 线程自身处理这些任务，还是放入队列交给并唤醒多少个 Worker 线程去处理。从这个意义上来说，Listener 线程也是可以转换为 Worker 线程的。所以，线程组中，总线程数等于正在工作且未被阻塞的线程数+工作线程任务的过程中被阻塞的个数+空闲线程的个数 + Listener 线程的个数。</li>
<li>任务队列，由普通队列和优先任务队列构成，是 Listene r每次从 pollfd 轮询出来的就绪任务。官方定义将符合连接处于事务中和连接关联的 priority tickets 值大于 0 两种情况认为是优先队列。所以可以这么认为，如果同一个事务中有两个 insert的SQL，有 1 个已经执行，那么另一个 insert0 任务就会放在高优先级中。如果是非事务引擎，或者开启了 autocommit 的事务引擎，都会放到普通队列中。还有一种情况是如果语句在普通队列中停留太久，该语句也会移到优先队列中，防止它饿死，thread_pool_prio_kickup_timer 系统变量控制了这个“停留时间”，对每个线程组来说，语句停留的最大时间为 10ms。另外，还有一个 <code>priority tickets(thread_pool_high_prio_tickets)</code> 的设计，以优先的任务每次被放入优先队列中就对 priority tickets 减 1，以避免永久优先的问题。</li>
<li>Timer 线程，是一种 Check Stall 机制，用来周期性地检查 group 是否超时或阻塞状态，并通过检测线程组的负载来进行工作线程的唤醒和创建行。创建线程必须满足两个条件：其一，如果没有空闲线程且没有活跃线程则立刻创建，这种情况可能因为没有任何工作线程或者工作线程都被阻塞了，或者是存在潜在的死锁；其二，如果距离上次创建的时间大于一定阈值才创建线程，这个阈值由线程组内的线程数决定。</li>
</ul>
<p>介绍完 Thread Pool 架构和架构中的各个组件，我们再来看一下一次完整的用户请求是如何从数据库连接池进入 MySQL 的线程池，通过 Thread Pool 而进行运作的。</p>
<ol>
<li>在初始化时，MySQL 线程池根据宿主机的 CPU 核心数设置 thread_pool_size，并分成若干 group，每个 group 各自维护客服端发起的连接。当用户的请求通过数据库连接池访问到 MySQL 服务端时，MySQL 服务端再进行 <code>threadid % thread_pool_size</code> 取模计算，确定落在哪个线程组中。</li>
<li>线程组中的 Listener 线程监听到所在的线程组有新的请求后，检查队列中是否有请求还未处理，并决定是自己亲自转化为 Worker 线程进行处理，还是把这些任务放入队列中让 Worker 线程进行处理。在这个过程中先处理优先队列，再处理普通队列。如果任务队列不为空，Listener 线程还需要考虑应调度唤醒多少个工作线程。</li>
</ol>
<p>在以上两步中，还有两个自检程序在运行着。一个是 Worker 线程会自己判断最大空闲时间，如果超过最大空闲时间(默认60秒)就会退出；还有一个是 Timer 线程不断进行 CheckStall 机制，用来周期性地检查 group 是否处于超时或阻塞状态，并通过检测线程组的负载来进行工作线程的唤醒和创建。</p>
<h3 id=mysql-线程池实战>MySQL 线程池实战</h3>
<p>基本参数：</p>
<ul>
<li>thread_pool_size 是线程池性能最重要的参数，其设置线程池的 group 的数量，默认为系统CPU的个数。MySQL 官方文档给出的经验性建议[插图]是：如果主引擎(primary storage engine)为InnoDB, thread_pool_size 最佳设置可能为16～36，最常见的优化值倾向于24～36；如果主引擎为 MyISAM，那么 thread_pool_size 设置应该相当低。该值设置为4～8，倾向于获取最优性能。更高值设置对性能倾向于有点负面但不显著的影响。</li>
<li>thread_pool_stall_limit 表示 Timer Thread 检测 group 是否异常的时间间隔，默认是 500ms。其用来处理被阻塞和长时间运行的语句，确保服务器不会完全被阻塞。thread_pool_stall_limit 有个 6 秒的上限值，防止服务器死锁的风险。在合适范围内，该值越大，MySQL 服务器的整体处理性能就越好，因为较少数量的线程，会降低对于系统资源的征用。但是，并不是越大越好，因为该值越大，新线程的创建将等待时间越长，用户的查询延迟就会越明显。</li>
<li>thread_pool_max_threads 控制线程池的最大线程数，默认为 10000。若该值为 1000，代表线程池中所能创建的最大线程数不能超过 1000。</li>
<li>thread_handling 默认是 one-thread-per-connection，如果要使用连接池功能，则必须设置为 pool-of-threads。</li>
<li>thread_pool_oversubscribe 用于控制单个 CPU 核心在同一时间活跃的线程数。类似于一种“超频”的概念，默认值是 3。</li>
<li>thread_pool_idle_timeout 设置空闲线程销毁前的等待时间，单位为秒，默认是 60 秒。用户可以根据自己的业务场景来调整该参数的值。设置得太短，会导致线程频繁地销毁与创建；设置得太长，则会导致线程池中的线程数长时间不会下降。</li>
<li>thread_pool_idle_timeout 设置空闲线程销毁前的等待时间，单位为秒，默认是 60 秒。用户可以根据自己的业务场景来调整该参数的值。设置得太短，会导致线程频繁地销毁与创建；设置得太长，则会导致线程池中的线程数长时间不会下降。</li>
<li>extra_port 用于设置 MySQL 服务端口之外的端口，供管理员管理服务器。</li>
<li>extra_max_connections 用于设置 extra_port 端口允许的最大连接数，通过 extra_port 端口创建的连接，采用的是 one-thread-per-connection 的方式。</li>
<li>thread_pool_high_prio_mode，线程池分组内的待处理任务会放到任务队列中，等待 Worker 线程处理。每个分组有两个队列：优先队列和普通队列，Worker 线程先从优先队列取事务处理，只有当优先队列为空时才从普通队列取事务处理。通过优先队列，可以让已经开启的事务或短事务得到优先处理，及时提交释放锁等资源。该参数可设置为3种模式：
<ul>
<li>transactions。默认的，只有一个已经开启了事务的SQL，并且 thread_pool_high_prio_tickets 不为 0，才会进入优先队列中，每个连接在 thread_pool_high_prio_tickets 次被放到优先队列后，会移到普通队列中。</li>
<li>statements。单独的 SQL 总是进入优先队列。</li>
<li>none。禁用优先队列功能，所有的连接都放到普通队列中处理。</li>
</ul>
</li>
<li>thread_pool_high_prio_tickets，当 <code>thread_pool_high_prio_mode = transactions</code> 的时候，每个连接的任务最多被放入优先队列 thread_pool_high_prio_tickets 次，并且每放一次递减，直到小于等于 0 的时候放入普通队列，这个值默认是 4294967295。</li>
</ul>
<p>实战经验：</p>
<ul>
<li>在 Percona 5.7 的部分低版本中，如果开启了 Performance_Schema 和 ThreadPool 会出现内存泄漏问题，需要将 performance_schema 设置为 off 并重启 MySQL。</li>
<li>慢 SQL 导致线程池卡住。慢 SQL 的问题往往是压倒团队的“最后一根稻草”，慢 SQL 引发的惨痛故障不胜枚举，甚至造成资损。不符合规范的 SQL、全表查询、没建索引等都是可能造成慢 SQL 的原因，而 thread_pool_oversubscribe 可以暂时缓解这个问题。但是这咱方法治标不治本，根本解决方法还是开启 MySQL 服务端的日志，将慢SQL每天反馈给各个技术研发团队，甚至直接通过中间件过滤掉慢 SQL，不让其访问到 MySQL 服务端。</li>
<li>MySQL 主备切换及容灾演练。生产数据库往往会默认设置几千个连接数，可是如果发生业务洪峰、机房故障以后迅速重连导致的连接风暴等情况，都容易将 MySQL 的最大连接数和并发线程数迅速提高到峰值。业务上可以提前做好预案及压测，技术上可以考虑通过配置中心进行 MySQL 的多机房切换、主备切换及容灾，也可以做探测脚本，在即将达到最大连接数时进行及时的扩容。</li>
<li>调度死锁解决。引入线程池解决了多线程高并发的问题，但也带来一个隐患。假设，A、B 两个事务被分配到不同的 group 中执行，A 事务已经开始，并且持有锁，但由于 A 所在的 group 比较繁忙，导致A执行一条语句后，不能立即获得调度执行；而 B 事务依赖A事务释放锁资源，虽然B事务可以被调度起来，但由于无法获得锁资源，导致 B 仍然需要等待，这就是所谓的调度死锁。由于一个 group 会同时处理多个连接，但多个连接不是对等的。比如，有的连接是第一次发送请求，而有的连接对应的事务已经开启，并且持有了部分锁资源。为了减少锁资源争用，后者显然应该比前者优先得到处理，以达到尽早释放锁资源的目的。因此在 group 里面，可以添加一个优先队列，将已经持有锁的连接，或者已经开启的事务的连接发起的请求放入优先队列，工作线程首先从优先队列获取任务执行。</li>
<li>大查询处理。假设一种场景，某个 group 里面的连接都是大查询，那么 group 里面的工作线程数很快就会达到 thread_pool_oversubscribe 参数设置值，对于后续的连接请求，则会响应不及时(没有更多的连接来处理)，这时候 group 就发生了 stall。通过前面的分析知道，Timer 线程会定期检查这种情况，并创建一个新的 Worker 线程来处理请求。如果长查询来源于业务请求，则此时所有 group 都面临这种问题，此时主机可能会由于负载过大，发生 hang 住的情况。这种情况线程池本身无能为力，因为源头可能是烂 SQL 并发，或者 SQL 没有走对执行计划而导致，通过其他方法，比如 SQL 高低水位限流或者 SQL 过滤手段可以应急处理。但是，还有另外一种情况，就是 dump 任务。很多下游依赖于数据库的原始数据，通常通过 dump 命令将数据拉到下游，而这种 dump 任务通常都耗时比较长，所以也可以认为是大查询。如果 dump 任务集中在一个 group 内，并导致其他正常业务请求无法立即响应，这个是不能容忍的。因为此时数据库并没有压力，只是因为采用了线程池策略，才导致了请求响应不及时。为了解决这个问题，我们将 group 中处理 dump 任务的线程不计入 thread_pool_oversubscribe 累计值，即可避免上述问题。</li>
<li>thread_cache_size 设置优化。每建立一个连接，都需要一个线程来与之匹配，此参数用来缓存空闲的线程，以至不被销毁。如果线程缓存中有空闲线程，这时候如果建立新连接，MySQL 就会很快地响应连接请求。MySQL 如果采用多线程来处理并发的连接，那么采用 mysqlreport 的 Threads 部分可以看到线程创建的频率非常高。一个比较好的方法就是使用持久连接，这将在一定程度上减少线程的重复创建。将 thread_cache_size 从 0 适当地提高到一定的业务需求值，虽然每秒处理的连接数不变，但是创建的线程数可以大大减少，同时提高线程池的命中率。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4b9d150e32675cf552baf43c5f76029b>5.5 - 性能原理</h1>
<h2 id=为什么快>为什么快</h2>
<p>在 HikariCP 官网详细了介绍 HikariCP 所做的优化，总结如下：</p>
<ul>
<li><strong>优化并精简字节码、优化代码和拦截器</strong>。</li>
<li><strong>使用 FastList 替代 ArrayList</strong>。</li>
<li><strong>更好的并发集合类实现 ConcurrentBag</strong>。</li>
<li><strong>其他针对 BoneCP 缺陷的优化，比如对于耗时超过一个 CPU 时间片的方法调用的研究</strong>。</li>
</ul>
<h2 id=精简字节码>精简字节码</h2>
<p>HikariCP 的代码只有 130 Kb，它是一个轻量级数据库连接池。</p>
<p>HikariCP 利用了一个第三方的 Java 字节码修改类库 Javassist 来生成委托实现动态代理。</p>
<p>动态代理的实现在 <code>com.zaxxer.hikari.pool.ProxyFactory</code> 类，源码非常简单。如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ProxyFactory</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ProxyFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ProxyConnection</span> <span style=color:#000>getProxyConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FastList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Statement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyLeakTask</span> <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isReadOnly</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>){</span>  
    <span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Statement</span> <span style=color:#000>getProxyStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyConnection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span>
<span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>CallableStatement</span> <span style=color:#000>getProxyCallableStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyConnection</span>
<span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CallableStatement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>PreparedStatement</span> <span style=color:#000>getProxyPreparedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyConnection</span>
<span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PreparedStatement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>static</span>  <span style=color:#000>ResultSet</span>  <span style=color:#000>getProxyResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>ProxyConnection</span>  <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span>  <span style=color:#204a87;font-weight:700>final</span>
<span style=color:#000>ProxyStatement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ResultSet</span> <span style=color:#000>resultSet</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这些代码基本代理了 JDBC 常用的核心接口，一共是 5 个：ProxyConnection、Statement、CallableStatement、PreparedStatement、ResultSet。并且每个方法都抛出了异常。其实每个方法都是抛异常之前都有一段 body，这段 body 是在编译时调用 JavassistProxyFactory 才生成的。</p>
<p>JavassistProxyFactory 存在于 <code>com.zaxxer.hikari.util</code> 包中，是 Javassist 的工具包，它主要有两个核心方法： generateProxyClass 方法负责生成实际使用的代理类字节码，<code>modifyProxyFactory</code> 对应修改工厂类中的代理类获取方法 <code>Proxy*.java</code> 为 <code>HikariProxy*. java</code>。这个工具包的作用是将 ProxyConnection、ProxyStatement、ProxyPreparedStatement、ProxyCallableStatement、ProxyResultSet 这 5 个 com.zaxxer.hikari.pool 包下代理类，利用 Javassist 重构后生成实际的 HikariCP 的对应代理类 HikariProxyConnection、HikariProxyStatement、HikariProxyPreparedStatement、HikariProxyCallableStatement、HikariProxyResultSet。</p>
<p>之所以使用 Javassist 生成动态代理，是因为其速度更快，比 JDK Proxy 生成的字节码更少，精简了很多不必要的字节码。</p>
<p>此外，HikariCP 在字节码工程中还对 JIT 进行了优化。比如，JIT 方法内联优化默认的字节码个数阈值是 35 字节，低于 35 字节才会进行优化。HikariCP 在精简字节码的时候，研究了编译器的字节码输出，甚至是 JIT 的汇编输出，以将关键部分限制为小于 JIT 内联阈值，展平了继承层次结构，阴影成员变量，消除了强制转换。</p>
<h2 id=fastlist>FastList</h2>
<p>HikariCP 一个性能方面的出彩优化突破就是 FastList。我们先看一组 HikariCP 中关于 FastList 的结论：</p>
<ol>
<li>当调用 <code>Connection.prepareStatement()</code> 的时候，新的 PreparedStatement 就被添加到 FastList。</li>
<li>当调用 <code>PreparedStatement.close()</code> 的时候，这个 statement 就从 FastList 中被移除。</li>
<li>如果调用 <code>Connection.close()</code> 的时候，任何未明确关闭的语句都将从 FastList 移除并关闭。</li>
</ol>
<p>但是 HikariCP 并没有拦截 <code>PreparedStatement.addBatch()</code> 方法，所以实际上 <code>addBatch()</code> 不可能添加任何内容到 FastList。executeBatch 方法即不会清除批处理，也不会将 PreparedStatement 从 FastList 中移除。唯一能够清除批处理的是<code> PreparedStatement.clearBatch()</code> 方法，而唯一能够从 FastList 移除 PreparedStatement 的方法就是调用 <code>PreparedStatement. close()</code> 或者 <code>Connection.close()</code> 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
     <span style=color:#000>PreparedStatement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(...))</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>something</span> <span style=color:#000>in</span> <span style=color:#000>somelist</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setString</span><span style=color:#ce5c00;font-weight:700>(...);</span>
        <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setInt</span><span style=color:#ce5c00;font-weight:700>(...);</span>
        <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBatch</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 记录异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上述代码所示，对于批处理语句执行清理的过程分为如下几步：<code>DataSource.getConnection()</code>、<code>Connection.prepareStatement()</code>、多次调用 <code>PreparedStatement.addBatch()</code>、<code>PreparedStatement.executeBatch()/clearBatch() </code>的调用、依赖 Java 7 的 try-with-resources 语法进行资源的清理。</p>
<p>FastList 是一个 List 接口的精简实现，只实现了接口中必要的几个方法。JDK ArrayList 每次调用 get() 方法时都会进行 rangeCheck，检查索引是否越界，FastList 的实现中去除了这一检查，只要保证索引合法那么 rangeCheck 就成为了不必要的计算开销(当然开销极小)。</p>
<p>此外，HikariCP 使用 List 来保存打开的 Statement，当 Statement 关闭或 Connection 关闭时需要将对应的 Statement 从 List 中移除。通常情况下，JDBC 在同一个 Connection 创建了多个 Statement 时，后打开的 Statement 会先关闭。这种情况从尾部开始扫描将表现更好。ArrayList 的 remove(Object) 方法是从头开始遍历数组，而 FastList 是从数组的尾部开始遍历，因此更为高效，它消除了范围检查，并从尾部到头部执行移除扫描。</p>
<p><strong>简而言之就是用自定义数组类型 FastList 代替 ArrayList：避免每次 get() 调用都要进行范围检查，避免调用 remove() 时的从头到尾的扫描。</strong></p>
<h2 id=concurrentbag>ConcurrentBag</h2>
<p>ConcurrentBag 取名来源于 C# .NET 的同名类，但是实现却不一样。它是一个 lock-free 集合，在连接池(多线程数据交互)的实现上具有比 LinkedBlockingQueue 和 LinkedTransferQueue 更优越的并发读写性能。它具有无锁设计、ThreadLocal 缓存、队列窃取、直接切换优化四大特点。</p>
<p>ConcurrentBag 采用了 queue-stealing 的机制获取元素：首先尝试从 ThreadLocal 中获取属于当前线程的元素来避免锁竞争，如果没有可用元素则再次从共享的 CopyOnWriteArrayList 中获取。此外，ThreadLocal 和 CopyOnWriteArrayList 在 ConcurrentBag 中都是成员变量，线程间不共享，避免了伪共享(false sharing)的发生。作者评价这款设计具有高度并发性，极低的延迟，并最大限度地减少了伪共享的发生。</p>
<p>ConcurrentBag 的性能提升主要源于如下 3 个组成部分：</p>
<ul>
<li>CopyOnWriteArrayList：负责存放 ConcurrentBag 中全部用于出借的资源。</li>
<li>ThreadLocal：用于加速线程本地化资源访问。</li>
<li>SynchronousQueue：用于存在资源等待线程时的第一手资源交接。</li>
</ul>
<h3 id=源码解析>源码解析</h3>
<p>ConcurrentBag 内部同时使用 ThreadLocal 和 CopyOnWriteArrayList 来存储元素，其中 CopyOnWriteArrayList 是线程共享的。</p>
<p>ConcurrentBag 采用了 queue-stealing 的机制获取元素：首先尝试从 ThreadLocal 中获取属于当前线程的元素来避免锁竞争，如果没有可用元素则扫描公共集合，再从共享的 CopyOnWriteArrayList 中获取。ThreadLocal 列表中没有被使用的 items 在借用线程没有属于自己的时候，是可以被“窃取”的。</p>
<p>ThreadLocal 和 CopyOnWriteArrayList 在 ConcurrentBag 中都是成员变量，线程间不共享，避免了伪共享的发生。</p>
<p>使用专门的 AbstractQueuedLongSynchronizer 来管理跨线程信号，这是一个 lock-less 的实现。</p>
<p>ConcurrentBag 通过 borrow 方法进行数据资源借用，通过 requite 方法进行资源回收，注意其中 borrow 方法只提供对象引用，不移除对象。所以从 bag 中“借用”的 items 实际上并没有从任何集合中删除，因此即使引用废弃了，垃圾收集也不会发生。因此使用时通过 borrow 取出的对象必须通过 requite 方法进行放回，否则会导致内存泄露，只有 remove 方法才能完全从 bag 中删除一个对象。</p>
<h4 id=concurrentbag-1>ConcurrentBag：</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210718151715.png style=display:block;width:80% alt=NAME align=center> </div>
<p>对 CopyOnWriteArrayList 的使用：通过 add 添加资源，通过 remove 方法借出资源：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210718151809.png style=display:block;width:80% alt=NAME align=center> </div>
<p>add 方法向 bag 中添加 bagEntry 对象，以供别人借用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ConcurrentBag has been closed, ignoring add()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ConcurrentBag has been closed, ignoring
</span><span style=color:#4e9a06>add()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//新添加的资源优先放入CopyOnWriteArrayList
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 当有等待资源的线程时，将资源交到某个等待线程后才返回（SynchronousQueue）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>handoffQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>yield</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>remove 方法从 bag 中删除一个 bagEntry，仅在 <code>borrow(long, TimeUnit)</code> 和 <code>reserve(T)</code> 时被调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>){</span>
		<span style=color:#8f5902;font-style:italic>// 如果资源正在使用且无法进行状态切换，则返回失败
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_REMOVED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> 
        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_RESERVED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_REMOVED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> 
        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Attempt to remove an object from the bag that was not borrowed or reserved: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 移出
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span> <span style=color:#000>removed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Attempt to remove an object from the bag that does not exist: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>removed</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// ConcurrentBag中通过borrow方法进行数据资源借用。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>borrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>timeUnit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 优先查看有没有可用的本地化的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>threadList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>weakThreadLocals</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>).</span>
    <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//优先从当前线程的ThreadLocal中获取连接，若获得则直接返回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#8f5902;font-style:italic>// 当无可用本地化资源时，遍历全部资源，查看是否存在可用资源
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#8f5902;font-style:italic>// 因此被一个线程本地化的资源也可能被另一个线程&#34;抢走&#34;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 因为可能&#34;抢走&#34;了其他线程的资源，因此提醒包裹进行资源添加
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>timeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 若现有资源全部在使用中，则等待一个被释放的资源或者一个新资源
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handoffQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NANOSECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> 
                <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>elapsedNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>requite</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 将状态转为未在使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>// 判断是否存在等待线程，若存在，则直接转手资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STATE_NOT_IN_USE</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>handoffQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>parkNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MICROSECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>yield</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 否则，进行资源本地化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>threadLocalList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>threadList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>threadLocalList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weakThreadLocals</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#a40000>：</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=synchronousqueue>SynchronousQueue</h4>
<p>SynchronousQueue 来自于 JUC 并发包 java.util.concurrent，在 HikariCP 中的体现就是 ConcurrentBag 结构中的 handoffQueue，它主要用于存在资源等待线程时的第一手资源交接：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210718152506.png style=display:block;width:80% alt=NAME align=center> </div>
<p>SynchronousQueue 的初始化是在 ConcurrentBag 的构造方法中，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentBag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>IBagStateListener</span> <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>listener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>weakThreadLocals</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>useWeakThreadLocals</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handoffQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SynchronousQueue</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waiters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sharedList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weakThreadLocals</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>withInitial</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>withInitial</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FastList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IConcurrentBagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>SynchronousQueue 提供了以下两个构造函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SynchronousQueue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SynchronousQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>fair</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 通过fair值来决定公平和不公平
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 公平使用TransferQueue，不公平使用TransferStack
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>transferer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fair</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransferQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransferStack</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 HikariCP 中，选择的是公平模式 <code>this.handoffQueue = newSynchronousQueue&lt;>(true)</code>。公平模式总结下来就是：队尾入队队头出队，先进先出，体现公平原则。</p>
<p>SynchronousQueue 是一个无存储空间的阻塞队列(是实现 newFixedThreadPool 的核心)，非常适合做交换工作，生产者和消费者的线程同步以传递某些信息、事件或者任务。作为 BlockingQueue 中的一员，SynchronousQueue 的吞吐量高于 ArrayBlockingQueue 和 LinkedBlockingQueue，与其他 BlockingQueue 有着不同特性。</p>
<ul>
<li>SynchronousQueue 无存储空间。与其他 BlockingQueue 不同，SynchronousQueue 是一个不存储元素的 BlockingQueue。它的特点是每一个 put 操作必须要等待一个 take 操作或者 poll 方法，才能使用 off、add 方法，否则不能继续添加元素，反之亦然。</li>
<li>因为没有容量，所以对应 peek、contains、clear、isEmpty 等方法其实是无效的。例如 clear 是不执行任何操作的，contains 始终返回 false, peek 始终返回 null, peek 方法直接返回 null。</li>
<li>SynchronousQueue 分为公平和不公平，默认情况下采用不公平访问策略。当然也可以通过构造函数来设置为公平访问策略。</li>
<li>若使用 TransferQueue，则队列中永远会存在一个 dummynode。</li>
</ul>
<h4 id=copyonwritearraylist>CopyOnWriteArrayList</h4>
<p>CopyOnWriteArrayList 负责存放 ConcurrentBag 中全部用于出借的资源。顾名思义，Write 的时候总是要 Copy，也就是说对于任何可变的操作都是伴随复制这个动作的，这是 ArrayList 的一个线程安全的变体，底层通过复制数组的方式来实现。和 SynchronousQueue 一样，它也位于 java.util.concurrent 包下，为并发而生。CopyOnWriteArrayList 在遍历的时候不会抛出 ConcurrentModificationException 异常，并且遍历的时候就不用额外加锁，元素也可以为 null。</p>
<p>CopyOnWriteArrayList 底层是一个数组，通过 ReentrantLock 进行加锁，它初始化的时候底层是一个 <code>Object[] array</code>, <code>Object array</code> 指向一个大小为 0 的数组。一次 add 操作经历了 5 个步骤，都是在锁的保护下进行的，在添加的时候先上锁，拿到原数组并复制一个新数组(原数组大小+1)，增加操作在新数组上进行，最后再将 <code>Object array</code> 引用指向新数组，解锁。这样做是为了避免在多线程并发add的时候，复制多个副本出来，把数据搞乱了，导致最终的数组数据不是我们期望的。这是一种写时复制的理念。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>RandomAccess</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cloneable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//可重入锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#8f5902;font-style:italic>//非private，得到数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#8f5902;font-style:italic>//设置数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span> <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#8f5902;font-style:italic>//初始化
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//1）加锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//得到原数组的长度和元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//2）复制数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//3）将元素加入到新数组中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//4）将array引用指向到新数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//5）解锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>插入、删除、修改操作也都是一样，每一次的操作都是以对Object[] array进行一次复制为基础的。写加锁，读不加锁。由于所有的写操作都是在新数组进行的，这个时候如果有线程并发的写，则通过锁来控制。如果有线程并发的读，则分以下几种情况：</p>
<ul>
<li>如果写操作未完成，那么直接读取原数组的数据。</li>
<li>如果写操作完成，但是引用还未指向新数组，那么也是读取原数组数据。</li>
<li>如果写操作完成，并且引用已经指向了新的数组，那么直接从新数组中读取数据。</li>
</ul>
<p>CopyOnWriteArrayList 非常适用于数据库连接池这种读操作远远多于修改操作的场景，它反映的是 3 个十分重要的分布式理念：</p>
<ul>
<li>读写分离。读取 CopyOnWriteArrayList 的时候，读取的是 CopyOnWriteArrayList 中的 <code>Object[] array</code>，但是修改的时候，操作的是一个新的 <code>Object[] array</code>。读和写操作的不是同一个对象，这就是读写分离。这种技术数据库用的非常多，在高并发下为了缓解数据库的压力，即使做了缓存也要对数据库做读写分离，读的时候使用读库，写的时候使用写库，然后读库、写库之间进行一定的同步，这样就避免同一个库上读、写的 IO 操作太多。</li>
<li>最终一致。对 CopyOnWriteArrayList 来说，线程1读取集合里面的数据，未必是最新的数据。因为线程2、线程3、线程4都修改了 CopyOnWriteArrayList 里面的数据，但是线程1拿到的还是最老的那个 <code>Object[] array</code>，新添加进去的数据并没有，所以线程1读取的内容未必准确。不过这些数据虽然对于线程1是不一致的，但是对于之后的线程一定是一致的，它们拿到的 <code>Object[] array</code> 一定是3个线程都操作完毕之后的 <code>Object array[]</code>，这就是最终一致。最终一致对于分布式系统也非常重要，它通过容忍一定时间的数据不一致，提升整个分布式系统的可用性与分区容错性。当然，最终一致并不是任何场景都适用的，像火车站售票这种系统用户对于数据的实时性要求非常非常高，就必须做成强一致性的。</li>
<li>使用另外开辟空间的思路，来解决并发冲突。</li>
</ul>
<p>但是它有着以下缺点：</p>
<ul>
<li>因为 CopyOnWrite 的写时复制机制，所以在进行写操作的时候，内存里会同时驻扎两个对象的内存，旧的对象和新写入的对象（注意：在复制的时候只是复制容器里的引用，只是在写的时候会创建新对象添加到新容器里，而旧容器的对象还在使用，所以有两份对象内存）。如果这些对象占用的内存比较大，比如200M左右，再写入100M数据，内存就会占用300M，那么这个时候很有可能造成频繁的Yong GC和Full GC。</li>
<li>不能用于实时读的场景，像复制数组、新增元素都需要时间，所以调用一个 set 操作后，读取到数据可能还是旧的。虽 CopyOnWriteArrayList 能做到最终一致性，但是还是没法满足实时性要求。所以如果你希望写入的的数据马上能读到，就不要使用 CopyOnWrite 容器。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-15ec1a8762b47ae9a5a642074c2fb45b>5.6 - 优化原理</h1>
<h2 id=获取连接>获取连接</h2>
<p>HikariCP 可以被理解为一个简单的 BlockingQueue，它实际上并没有使用 BlockingQueue，而是使用了一种被称为 ConcurrentBag 的专用集合，但在行为概念上是类似的。在这个 BlockingQueue 的模型上，可以想象你的客户端调用 HikariDataSource 的 getConnection 方法执行着如下的工作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>显然会有更多的事情发生，比如抛出超时异常等，如上是基本的思路。调用 Connection.close 方法实质上返回到池的连接，同样，还有很多具体细节，但概念是相通的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariCP 确实有几个自己的线程，有一个 HouseKeeper 管家线程定期运行以退出空闲连接，有一个调度线程可以退出到达 maxLifetime 的连接，还有一个用于添加连接的线程，以及一个用于关闭它们的线程等。接下来，我们从获取连接部分开始仔细研究源码级的原理。</p>
<p>获取连接是 HikariCP 的核心功能，HikariDataSource 对象首先通过 getConnection 方法获得 HikariPool 真正的 getConnection 方法，HikariPool 内部通过我们介绍过的 ConcurrentBag 的 borrow 方法获取 PoolEntry，它将首先尝试从线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。最后通过 PoolEntry 执行 Create Proxy Connection 方法创建一个物理连接并返回其代理连接 Proxy Connection。具体的时序图如图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719225932.png style=display:block;width:80% alt=NAME align=center> </div>
<p>HikariDataSource，顾名思义，就是 HikariCP 对外提供给用户的定制化的 DataSource，使用 Spring 的用户可以直接将它作为数据源。用户也可以直接初始化 HikariDataSource：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>HikariDataSource</span> <span style=color:#000>ds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HikariDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setJdbcUrl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbc:mysql://localhost:3306/simpsons&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bart&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPassword</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;51mp50n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>HikariDataSource 继承了 HikariConfig，并且实现了 JDCB 基础中介绍过的 javax.sql 扩展包中的 DataSource 接口。作为 DriverManager 设施的替代项，DataSource 对象是获取连接的首选方法，实现 DataSource 接口的对象通常在基于 JavaTM Naming and Directory Interface (JNDI) API 的命名服务中注册。</p>
<p>HikariConfig 是 HikariCP 的配置管理核心类，它实现了 HikariConfigMXBean 接口，用来对外暴露 HikariCP 配置相关的 JMX 监控和管理功能。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719230214.png style=display:block;width:70% alt=NAME align=center> </div>
<p>在创建连接的过程中，有几个细节性的问题可以从源码级重点关注一下。</p>
<h3 id=细节单例池初始化>细节：单例池初始化</h3>
<p>HikariDataSource 获取连接 getConnection 的单例处理。大家都知道，在实现单例模式时，如果未考虑多线程的情况，很可能会造成实例化了多次并且被不同对象持有。在 JDK1.5 或者更晚的版本中，扩展了 volatile 的语义，使用了 volatile 关键字后，重排序被禁止，双重检查锁可以减少开销。如果没有 volatile 关键字则可能由于指令重排导致 HikariPool 对象 pool 在多线程下无法正确地初始化，volatile 禁止了指令重排，并强制本地线程读取主存。由于数据库连接池处于一个激烈的被频繁调用的位置，HikariCP 的源码部分就使用双重检查锁进行单例初始化。以下是 HikariDataSource 中的部分源码代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HikariPool</span> <span style=color:#000>fastPathPool</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>HikariPool</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//注意这里引入了volatile
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isClosed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>//检查数据源是否已经关闭，如果关闭则抛出异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;HikariDataSource &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; has been
</span><span style=color:#4e9a06>closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fastPathPool</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//如果当前引用HikariPool不为空，则直接返回连接
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fastPathPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>HikariPool</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//典型的双重检验锁代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>validate</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//参数校验，主要是检查参数是否合法并给予默认值
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                      <span style=color:#000>pool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HikariPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//初始化连接池
</span><span style=color:#8f5902;font-style:italic></span>                      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>seal</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PoolInitializationException</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Start completed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//从连接池中返回一个连接，返回给HikariPool资源池与ConcurrentBag进行交互
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=细节连接有效性>细节：连接有效性</h3>
<p>另一个细节是获取连接时的有效性检查。当从资源池里面获取到资源后，需要检查该资源的有效性，如果失效，则再次获取连接，这样可以避免执行业务的时候报错。这部分的工作是由 HikariPool 做的，它通过判断 PoolEntry 是否已经被标记清除了、当前 PoolEntry 的存活时间是否过期及当前连接是否活着 3 项进行判断，如果超时则关闭这个 PoolEntry 的连接、重置超时时间、再次获取连接。这部分的核心实现在 HikariPool 的 getConnection 方法里，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hardTimeout</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//从connectionBag中借用连接，借用过程中会发生创建连接、连接过期、空闲等事情
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>borrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//中断，跳出循环，并抛出异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>now</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//记录当前时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastAccessed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>aliveBypassWindowMs</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isConnectionAlive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//有效性检查
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>EVICTED_</span> <span style=color:#000>CONNECTION_MESSAGE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>DEAD_CONNECTION_MESSAGE</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//关闭当前失效连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hardTimeout</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//重置超时时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//借用的连接若未过期未丢弃进入此逻辑，则设置metrics监控指标
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>metricsTracker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recordBorrowTimeoutStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>//最核心部分，通过代理创建连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createProxyConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leakTaskFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//只要超时时间大于0则不断重试
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>createTimeoutException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//抛出创建连接超时异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上述代码中，有效性检查的部分是 isConnectionAlive，在这里用户可以自行配置心跳语句的检测，如果追求极致性能，那么使用 JDBC4 的用户还是强烈建议不要配置心跳语句，而是采用 HikariCP 默认的 com.mysql.jdbc. JDBC4Connection 的 isValid 实现，因为它的实现是 ping 命令，一般来说原生 ping 命令的性能是 select 1 的两倍。刚才我们看到的 HikariPool 的 getConnection 方法，其心跳语句检测的 isConnectionAlive 是在其父类中实现的，核心代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isConnectionAlive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>setNetworkTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>validationSeconds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationTimeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isUseJdbc4Validation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//如果是JDBC4，则直接使用ping命令进行验证
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isValid</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>validationSeconds</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//性能可以大大提升
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStatement</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isNetworkTimeoutSupported</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TRUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>setQueryTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationSeconds</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnectionTestQuery</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//否则执行测试语句验证
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>setNetworkTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>networkTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isIsolateInternalQueries</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lastConnectionFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Failed to validate connection {} ({}). Possiblyconsider using a shorter maxLifetime value.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>poolName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码中有一个 validationTimeout 属性，默认值是 5000 毫秒，所以默认情况下 <code>final int validationSeconds = (int)Math.max(1000L, validationTimeout) / 1000</code> 它的值应该为 1～5 秒。又由于 validationTimeout 的值必须小于 connectionTimeout(默认值30000毫秒，如果小于250毫秒，则被重置回30秒)，所以默认情况下，调整 validationTimeout 却不调整 connectionTimeou t情况下，validationSeconds 的默认峰值应该是 30 毫秒。</p>
<p>如果是 JDBC4 的话，使用 isUseJdbc4Validation(就是 <code>config.getConnectionTestQuery()== null</code> 的时候)，用 <code>connection.isValid(validationSeconds)</code> 来验证连接的有效性，否则的话则用 connectionTestQuery 查询语句来查询验证。</p>
<h3 id=细节创建形式>细节：创建形式</h3>
<p>第 3 个细节就是连接的创建。连接的创建可以同步创建，也可以异步创建，这与 HikariCP 的配置息息相关，这也是 HikariCP 作者别具匠心的设计之处。</p>
<h3 id=过程总结>过程总结</h3>
<ol>
<li>实现了 JDBC 扩展包 javax.sql 的 DataSource 接口的 HikariDataSource，执行 getConnection 方法时会进行 Double-checked_locking 单例、配置检查等流程，再向 HikariPool 资源池请求获取连接。</li>
<li>HikariPool 则向其 lock-free 的资源集合 ConcurrentBag 借用 PoolEntry，若没有 poolEntry 则超时抛出异常，若有 poolEntry 则创建一个 JDBC 代理连接 ProxyConnection。</li>
<li>ProxyConnection 是由 ProxyFactory 产生的，它是一个生产标准 JDBC 接口代理的工厂类，HikariDataSource 最终获取的 Connection 连接就是代理工厂返回的 JDBC 物理连接，而 poolEntry 就是对这个物理连接的一对一封装。</li>
</ol>
<h3 id=连接有效性>连接有效性</h3>
<p>Java.sql.Connection 的 isValid() 和 isClosed() 区别：</p>
<ul>
<li>isValid：如果连接尚未关闭并且仍然有效，则返回true。驱动程序将提交一个关于该连接的查询，或者使用其他某种能确切验证在调用此方法时连接是否仍然有效的机制。由驱动程序提交的用来验证该连接的查询将在当前事务的上下文中执行。
<ul>
<li>参数：timeout。等待用来验证连接是否完成的数据库操作的时间，以秒为单位。如果在操作完成之前超时期满，则此方法返回 false。0值表示不对数据库操作应用超时值。</li>
<li>返回：如果连接有效，则返回 true，否则返回 false。</li>
</ul>
</li>
<li>isClosed：查询此 Connection 对象是否已经被关闭。如果在连接上调用了 close 方法或者发生某些严重的错误，则连接被关闭。只有在调用了 Connection.close 方法之后被调用时，此方法才保证返回 true。通常不能调用此方法确定到数据库的连接是有效的还是无效的。通过捕获在试图进行某一操作时可能抛出的异常，典型的客户端可以确定某一连接是无效的。
<ul>
<li>返回：如果此 Connection 对象是关闭的，则返回 true；如果它仍然处于打开状态，则返回 false。</li>
</ul>
</li>
</ul>
<h3 id=连接监控>连接监控</h3>
<p>HikariPool 继承了 PoolBase，实现了 HikariPoolMXBean 接口用于对外暴露 HikariCP 连接池相关的监控管理功能：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719231458.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=归还连接>归还连接</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719231944.png style=display:block;width:70% alt=NAME align=center> </div>
<p>连接的归还和连接的借用是两个大致相反的过程，归还部分的源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//由于关闭语句可能导致连接被驱逐，所以优先执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCommitStateDirty</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//如果存在脏提交或者没有自动提交，则连接回滚
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>lastAccess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Executed rollback on connection {} due to dirty commit state on close().&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dirtyBits</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetConnectionState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dirtyBits</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>lastAccess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearWarnings</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//当连接中止时，通常会抛出不适用于应用程序的异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>checkException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//这里开始调用PoolEntry的recycle方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recycle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastAccess</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 ProxyConnection 代理层获取到的连接，进行归还时调用了代理层的 close 方法。HikariCP 归还连接是一系列没有返回值的 void 操作，ProxyConnection 的 close 方法并没有直接调用 JDBC 的 close 方法，而是依次调用了 PoolEnry 的 recycle 方法、HikariPool 的 recycle 方法及 ConcurrentBag 的 requite 方法，这一系列方法传递的参数都是 PoolEntry。</p>
<p>数据库连接池 HikariCP 的 close 方法返回的连接其实是封装在这个 ProxyConnection 代理连接中的，当调用它的时候，它只返回与池的连接，但是依然保持与数据库的基础连接是打开的。数据库连接池通常都是以这种方式工作的，数据库连接池的性能优势就是来自于连接保持打开，通过代理连接，对用户来说是透明的。如果需要关闭这个连接，可以将它先转换为 ProxyConnection，然后调用它的 unwrap 方法，最后关闭这个内部连接。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//ProxyConnection内部提供的unwrap方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
		
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Wrapped connection is not an instance of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>unwrap 是一个很有意思的工具，如果你想跳过代理获取数据库的源信息，那么还可以直接使用 JDBC 的 unwrap 的 API 来获取(这里不是 ProxyConnection 的 unwrap )。如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConnectionProperties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConnectionProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span>
	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNullCatalogMeansCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>在归还连接的代码中，也存在很多细节。比如代理层的 close 方法第 1 行就这么讲究：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//由于关闭语句可能导致连接被驱逐，所以优先执行
</span></code></pre></div><p>本书前面章节介绍的 HikariCP 诞生的理由——很多数据库连接池违反了 JDBC 规范。当 Connection 连接 close 或者 return 时，清除警告或回滚未提交的事务时，一些数据库连接池并不会自动关闭语句 Statement，并且它们也不会重置用户更改过的属性，如自动提交或事务隔离级别等，从而导致下一个消费者获得“脏”连接。</p>
<p>JDBC 最佳实践中有一条就是最顺序关闭 ResultSet、Statement、Connection。因此，在 HikariCP 中，ProxyConnection 的源码中，它的 close 方法覆盖了 java.sql.Connection 的方法，覆盖 JDBC 的 close 方法时，第一件事就是关闭了 Statement 语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>(){</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>ignored</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//自动资源清理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Connection {} marked as broken because of an exception closing open statements during Connection.close()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;(exception closing Statements during Connection.close())&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上述 closeStatements 的具体方法实现里，在执行 clear 之前，将所有不是关闭状态的 Statement 都遍历了一遍，进行了资源的自动清理，对于遇到异常的连接，PoolEntry 对象标记具体问题原因是关闭 Statement 时产生的，并将连接设置为关闭状态。</p>
<p>从 ProxyConnection 覆盖 JDBC 的 close 方法，一步步调用到了 ConcurrentBag 的 requite 方法放回，就像后者方法前的注释说的那样：“有借必有还。如果你只借不还，那么就会导致内存泄漏。”</p>
<p>结合连接时序图和归还连接时序图我们可以发现，PoolEntry 对象通过 borrow 方法从 ConcurrentBag 中取出，再通过 requite 方法被放回，有借有还。当线程调用 getConnection 的时候，会调用 ConcurrentBag 的 borrow 方法，它将首先尝试从该线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。</p>
<p>当关闭连接时，又会通过 remove 方法删除 PoolEntry。ConcurrentBag 就是 HikariCP 的数据库连接存储结构，它在 HikariCP 中起着举足轻重的作用，其性能直接决定 HikariCP 的整体性能。</p>
<h2 id=关闭连接>关闭连接</h2>
<p>在可以热部署的 Web 应用程序中，关闭 DataSource 非常重要。通常可以调用 HikariDataSource 实例的 shutdown 或者 close 方法，也可以配置 Spring 或其他 IOC 容器来指定 destroy 方法。<strong>一旦 Connection 进入关闭连接阶段，它立即从池中被移除，但是仍然和数据库 DB 有活动连接，直到 Connection.close 完成。HikariCP 永远不会杀死正在使用的连接，除非池本身被关闭。</strong></p>
<p>关闭分为 HikariDataSouce 和 HikariPool 两种关闭，这两者截然不同。</p>
<p>HikariDatasource 作为 HikariCP 对外对使用方提供的 DataSource，它的 close 方法是粗暴的 shutdown 操作。其 close 方法就是直接关闭数据源及其连接池，源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>(){</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isShutdown</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>HikariPool</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Shutdown initiated...&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Shutdown completed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Interrupted during closing&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariDataSouce 的 close 直接调用了 HikariPool 的 shutdown 操作，其具体实现在 HikariPool 的 shutdown 方法里，不但关闭连接池，还关闭了所有空闲连接，中止或关闭活动连接。此外，它还会进行直接取消定时任务、关闭 ConcurrentBag 等一系列清理工作，可以认为就是一个 shutdown 的强硬操作。HikariPool 的 shutdown 源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>POOL_SHUTDOWN</span><span style=color:#ce5c00;font-weight:700>;</span>
  
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//如果连接池从未启动
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  
      <span style=color:#000>logPoolState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Before shutdown &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>houseKeeperTask</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//关闭houseKeeper的任务
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>houseKeeperTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>houseKeeperTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  
      <span style=color:#000>softEvictConnections</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//软驱逐连接
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//关闭增加连接线程池
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getLoginTimeout</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>destroyHouseKeepingExecutorService</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//关闭connectionBag
</span><span style=color:#8f5902;font-style:italic></span>  
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>assassinExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(),</span> 
          <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; connection assassinator&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThreadFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> 
          <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CallerRunsPolicy</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>abortActiveConnections</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>softEvictConnections</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>shutdownNetworkTimeoutExecutor</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logPoolState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;After shutdown &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>handleMBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>metricsTracker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>与 HikariDataSource 对外提供的 close 接口不同，HikariPool 提供的内部 closeConnection 方法才是我们通常意义上理解的数据库连接池内部的连接关闭逻辑。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210902213134.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当 HikariPool 执行 closeConnection 方法时，首先先从 ConcurrentBag 中移除 PoolEntry，然后 PoolEntry 自身 close，接着独立线程池 closeConnectionExecutor(本质是ThreadPoolExecutor) 调用 JDBC 的方法进行物理连接的关闭。如果 poolState 的状态为 0，还会使用另一个独立线程池 addConnectionExecutor(与 closeConnectionExecutor 对称，本质上也是 ThreadPoolExecutor)进行新连接的生成，fillPool 补足到 HikariCP 的配置值。其核心源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>closureReason</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//ConcurrentBag移除poolEntry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//poolEntry关闭
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>quietlyCloseConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>closureReason</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//jdbc关闭连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>POOL_NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>fillPool</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//填充连接池
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到 HikariCP 使用了线程池 closeConnectionExecutor 进行了物理连接的关闭。其实在 HikariCP 的源码里，closeConnectionExecutor 还有一个孪生兄弟 addConnectionExecutor，在 com.zaxxer.hikari.pool.HikariPool 的源码中构造函数初始化的时候就可以看到 <code>public HikariPool(final HikariConfigconfig)</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadPoolExecutor</span> <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadPoolExecutor</span> <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//......
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>addQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addConnectionQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unmodifiableCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;connection adder&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DiscardPolicy</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(),</span> 
  <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; connection closer&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CallerRunsPolicy</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>addConnectionExecutor 和 closeConnectionExecuto r的初始化就是命中了Java 5 种线程池、4 种拒绝策略、3 种阻塞队列的知识点。addConnectionExecutor 用于创建物理连接，它使用了 DiscardPolicy 策略，默认情况下它就是丢弃被拒绝的任务，实际上就是任务满了就不会抛出异常；而 closeConnectionExecutor 用了 CallerRunsPolicy 策略，如果添加到线程池失败，主线程会直接在 execute 方法的调用线程中运行被拒绝的任务，若执行程序已关闭，则会丢弃该任务。</p>
<p>使用 HikariCP 的用户可能经常会看到类似 connection isevicted or dead 这样的异常，其实这是合理的，关闭死连接对于连接池的资源清理至关重要。</p>
<p>HikariCP 关闭连接的 5 种情况：</p>
<ul>
<li>连接验证失败。这对应用程序是不可见的。连接已停用并已替换。用户会看到一条日志消息：“Failed tovalidate connection&mldr;”。</li>
<li>连接达到了其 maxLifetime。这对应用程序是不可见的。连接已停用并已替换。用户会看到一个关闭原因：“connection has passed maxLifetime”，或者如果在到达时 maxLifetime 正在使用该连接，用户会晚一点看到原因：“connection is evicted or dead”。</li>
<li>用户手动驱逐连接。这对应用程序是不可见的。连接已停用并已替换。用户会看到关闭的原因：“connectionevicted by user”。</li>
<li>JDBC 调用引发了无法恢复的问题 SQLException。这应该对应用程序可见。用户会看到关闭的原因：“connection is broken”。</li>
</ul>
<h2 id=生成连接>生成连接</h2>
<p>独立的线程池 addConnectionExecutor 用于创建物理连接，它是在 HikariPool 的构造函数中被初始化的。HikariPool 中的 addConnectionExecutor 在 addBagItem() 和 fillPool() 的时候进行新的物理连接的创建。addBagItem 代表向我们之前介绍的 HikariCP 的数据结构 ConcurrentBag 中放置 Bag 项，它的源码实现其实是在 ConcurrentBag 的 borrrow 也就是连接的借用时执行的。核心代码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//如果我们已经窃取了另一个等待着的连接，那么请求会新增另一个bag
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>在上述代码中，有两处分别执行了 <code>listener.addBagItem(waiting-1)</code> 和 <code>listener.addBagItem(waiting)</code>，当有并发连接产生时，如果存在等待的连接或者连接已经不可用，则会进行物理连接的创建。</p>
<p>另一个 addConnectionExecutor 在 addBagItem() 来源于 HikariPool 的 fillPool 的方法，它是来源于 HikariPool 内部的单独线程 HouseKeeper，用来将当前的数据库连接池从当前的空闲连接填充到最小空闲连接的指标。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fillPool</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>connectionsToAdd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinimumIdle</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>getIdleConnections</span><span style=color:#ce5c00;font-weight:700>())</span>
                              <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>addConnectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>connectionsToAdd</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>connectionsToAdd</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
<span style=color:#000>poolEntryCreator</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postFillPoolEntryCreator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>PoolEntry 是一个封装了物理连接的对象，在 HikariPool 中定义了两个 PoolEntry，分别代表我们刚才介绍的连接生成的两种场景(addBagItem 和 fillPool)：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span>  <span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>PoolEntryCreator</span>  <span style=color:#000>poolEntryCreator</span>  <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#204a87;font-weight:700>new</span>  <span style=color:#000>PoolEntryCreator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#a40000>＊</span><span style=color:#000>logging</span> <span style=color:#000>prefix</span><span style=color:#a40000>＊</span><span style=color:#ce5c00;font-weight:700>/);</span>
<span style=color:#204a87;font-weight:700>private</span>  <span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>PoolEntryCreator</span>  <span style=color:#000>postFillPoolEntryCreator</span>  <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#204a87;font-weight:700>new</span>  <span style=color:#000>PoolEntryCreator</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;After adding &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>addConnectionExecutor 线程调用 HikariPool 的 createPoolEntry 方法进行连接生成，HikariPool 继承的父类 PoolBase 提供的 newPoolEntry 会先进行物理连接的创建，创建完成以后的连接会被封装为 PoolEntry 后放入ConcurrentBag。createPoolEntry 的源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>createPoolEntry</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPoolEntry</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxLifetime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 设置maxlifetime的2.5%的差额
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>variance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>nextLong</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>40</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//随机数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>lifetime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>variance</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFutureEol</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>houseKeepingExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//设置异步任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>softEvictConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;(connection has passed
</span><span style=color:#4e9a06>maxLifetime)&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#a40000>＊</span> <span style=color:#000>not</span> <span style=color:#000>owner</span> <span style=color:#a40000>＊</span><span style=color:#ce5c00;font-weight:700>/))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                          <span style=color:#000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWaitingThreadCount</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>},</span>
                <span style=color:#000>lifetime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConnectionSetupException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>POOL_NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//如果shutdown()同时运行，我们检查POOL_NORMAL以避免消息泛滥
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Error thrown while acquiring connection from data
</span><span style=color:#4e9a06>source&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>lastConnectionFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//设置上一次连接失败的异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariCP 的 maxLifetime 默认是 1800000毫秒(30分钟)。在上述代码中，有一段重要的随机数逻辑，这段代码主要就是根据 maxLifetime 的 2.5% 来设置一个差额，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 设置maxlifetime的2.5%的差额
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>variance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>().</span>
<span style=color:#000>nextLong</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>40</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//随机数
</span></code></pre></div><p>连接生成的时候让每个连接的最大存活时间错开一点，防止同时过期，加一点点随机因素，防止一件事情大量同时发生，比如防止 HikariCP 的连接同时大量死亡。如果 maxLifetime 大于 10000 就是大于 10 秒钟，就执行这个策略，用 maxLifetime 的 2.5% 的时间和 0 之间的随机数来随机设定一个 variance，在 maxLifetime - variance 之后触发 evict。比如，配置 maxLifetime 为 15 分钟时，HikariCP 为每个连接最大寿命注入了 2.5% 的变化，寿命为 15 分钟时，相当于 22.5 秒的变化。一些连接可能在 14 分 38 秒退休，其他连接可能在 14 分 53 秒退休等。</p>
<p>在创建 poolEntry 的时候，注册了一个延时任务，在连接存活将要到达 maxLifetime 之前触发 evit(标记连接池中的连接不可用)，用来防止出现大面积连接因为 maxLifetim e是一样的而同时失效，从而造成 HikariCP 数据库连接池不稳定的情况。</p>
<p>在 HikariCP 的 3.3.1 版本中，修复了一个 issue 1287 “setcore pool size before max pool size”，这正是与我们介绍的连接生成 addConnectionExecutor 有关系的。提交这个 issue 的用户反馈：他在执行大量并发耗时查询（查询10～30秒）的时候，启动时的有尖峰请求，在尖峰需求完毕以前池中无空闲连接的情况下反应非常慢，获得新的连接是一个严重阻塞的过程。</p>
<p>根据这个用户的问题，HikariCP 3.3.1 版本在 HikariPool 的初始化过程中统一将 addConnectionExecutor.setMaximumPoolSize 挪到了 addConnectionExecutor.setCorePoolSize 的后面。其源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.zaxxer.hikari.blockUntilFilled&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
<span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitializationFailTimeout</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>setCorePoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>  <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>setMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitializationFailTimeout</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinimumIdle</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>quietlySleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCorePoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>com.zaxxer.hikari.blockUntilFilled 是 HikariCP 新版本的一个新功能，它是 HikariCP 官方文档没有提供的系统属性，它的作用是阻塞应用程序直到数据库连接池达到 minimumIdle 值的大小。这个行为在 HikariCP 旧版本期间是单线程的，所以就有可能出现初始化时大量并发连接的长慢查询容易导致 HikariCP 的 getConnection 方法产生阻塞；在 3.3.0 版本中可以进行调整，如果 com.zaxxer.hikari.blockUntilFilled 的属性为 true，并且 initializationFailTimeout 大于 1，则池将由多个线程填充。这线程数由 Runtime.getRuntime().availableProcessors() 确定。初始化后，线程数会在池的生命周期内下降回 1。</p>
<p>那么为什么又要将 setMaximumPoolSize 挪到 setCorePoolSize 后面呢？因为这里有一个 Bug，根据 ThreadPoolExecutor 文档，需要在设置最大池大小之前设置核心池大小，因为在将最大池大小设置为低于核心池大小的值时会抛出 IllegalArgumentException。而这个修复是在 HikariCP 3.3.1 版本中调整的。</p>
<p>setMaximumPoolSize 文档：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public void setMaximumPoolSize(int maximumPoolSize)
    Sets the maximum allowed number of threads. This overrides any value set in
the constructor. If the new value is smaller than the current value, excess existing
threads will be terminated when they next become idle.
Parameters：
    maximumPoolSize - the new maximum
Throws：
    IllegalArgumentException - if the new maximum is less than or equal to zero,
or less than the core pool size
See Also：
    getMaximumPoolSize()
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a68d253e10a456aa43583ccceb08ed00>5.7 - 参数解析</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0571ba633db8293a9c18653c90e33707>5.8 - 动态代理</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-563c823956cc6c18f29bf3dac344c4ed>5.9 - 应用实践</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-fd9d53e36c38a6c8387036a57dd6ad34>5.10 - 监控度量</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d0760fe5aebcb44b4fb0547d4e258a2f>5.11 - 常见问题</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-132362e06a52e754bd5f4df7fdd855b0>5.12 - 扩展技术</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3d1e7c2a6f7ffc9f4f8eab6963ee28b0>6 - Udf Modeling</h1>
</div>
<div class=td-content>
<h1 id=pg-44b7f71194b5e8e3e24267b6e8584135>6.1 - Transport UDF at Linkedin</h1>
<blockquote>
<p><strong>如何使用户能够仅编写一次 UDF，并在任何引擎中复用，同时又不牺牲性能。</strong></p>
</blockquote>
<h1 id=transport-udf-at-linkedin>Transport UDF at Linkedin</h1>
<p>在<a href>统一数据视图</a>一文中，我们介绍了 Dali 的新型架构，它使得数据和逻辑在 Linkedin 的各种环境中能够被无缝访问和共享。Dali 通过采用物理与逻辑独立的原则来实现这一目标。<strong>物理独立性</strong>指的是用户能够透明的访问数据，无论其物理位置、存储格式、分区策略，甚至是跨机房的分片策略。<strong>逻辑独立性</strong>指的是 Dali 的用户自定义逻辑能够用于任何引擎或数据处理框架，而无论其语言接口或数据处理能力如何。作为一个<strong>数据和逻辑的共享层</strong>，Dali 致力于实现这些目标，同时致力于为其服务的关键任务系统提供几乎相同的性能保证。</p>
<p>这里将介绍逻辑独立性的实现原理：可翻译和可移植的 UDF，或者称为可传输的 UDF。</p>
<p>Dali 中的逻辑以 SQL 视图的形式表示。一个 SQL 视图由一系列应用在输入数据集(基本数据集或其他视图)的逻辑转换构成。在 Linkedin，Dali 视图广泛用于汇总和聚合数据、清除数据噪音、提取感兴趣的或相关信息、应用隐私过滤器，或用于组合来自不同源头的数据以从这些数据中创建洞察力和业务价值。<strong>UDF 被广泛的应用于当单纯的 SQL 无法表达应用需要的转换逻辑时</strong>，并且通常涉及诸如 Java 这种命令式语言中所表达的相当复杂的操作。只有在视图逻辑和 UDF 定义都能够跨引擎移植时，才能实现真正的逻辑独立性。虽然用于表达视图转换的关系代数表达式可以映射到不同数据处理引擎的不同声明性语言结构，但 UDF 定义却不同，它是命令式且不透明的，因此这也是挑战所在。</p>
<p>UDF 的 API 在数据处理引擎之间存在很大的差异，因为这些 API 必须考虑每个引擎所选择的 <strong>内部数据表示</strong>，并且必须提供 <strong>将数据表示连接到关系模式的能力</strong>。这种差异则给应用程序开发人员带来了负担，一旦需要进行引擎迁移或者跨引擎共享相同的逻辑，他们必须学习 UDF 的 API 和每个引擎的数据模型，然后在不同的引擎上以不同的 API 来重新实现相同的逻辑。这引入了我们称之为“UDF 非规范化”的概念，即有害的冗余，这会对生产力和工艺产生负面的影响。</p>
<p>基于这些挑战，问题则变成了：<strong>我们如何使用户能够仅编写一次 UDF，并在任何引擎中复用，同时又不牺牲性能</strong>。为了解决这个问题，我们将可翻译、可移植的 UDF 构建为一个框架，名为 Transport。虽然在一开始这似乎是一个疯狂而模糊的想法，但到目前为止，我们已经有很多用户在生产中使用了这些功能，我们目前覆盖了 3 个引擎(Hive/Presto/Spark)和一种数据格式(Avro)，并且仍在扩展其他处理引擎。</p>
<p>Transport 是一套 API 和框架。<strong>用户使用可翻译的 UDF API 来实现 UDF，然后框架再将这些 UDF 转换为各种目标引擎特定的原生 UDF</strong>。比如，用于可以基于 Transport UDF API 实现自己的 UDF，框架可以透明的将这些 UDF 转换为原生的 Hive UDF，就像用户直接编写的就是 Hive UDF。现在，如果用户想要在其他引擎中使用这些 UDF 也同样没有问题。比如，如果用户想要在 Presto 查询中使用相同的 UDF，框架同样可以透明的将这些 UDF 转换为 Presto 原生的 UDF，就像用户直接编写的就是 Presto UDF 一样。</p>
<p>在解释 Transport 的工作原理之前，我们先来浏览一下该想法背后的动机，主要有两点：UDF API 的差异性和复杂性。</p>
<h2 id=udf-api-的差异性>UDF API 的差异性</h2>
<p>数据处理世界中有很多引擎，每个都有各自的特性以满足某个特定的应用场景。同样，每个引擎也都拥有与其他引擎完全不同的 UDF API，这里具体列举其中一些主要的不同点，包括 3 个比较流行的引擎：Hive、Presto、Spark。</p>
<h3 id=udf-类型验证与推断>UDF 类型验证与推断</h3>
<p>UDF API 通常会为用户提供一些手段来指定 UDF 预期的数据类型(如类型验证)、UDF 的输出类型与输入类型的关联关系(类型推断)。比如 Presto 的 UDF API 使用类型签名来描述 UDF 对类型的预期要求，而 Hive 和 Spark 则要求用户通过遍历给定的类型对象树来编写命令式的代码来表示类型验证和推断。</p>
<h3 id=引擎内部数据模型>引擎内部数据模型</h3>
<p>不同的平台使用不同的数据模型来表示执行引擎中处理的数据，同样也会将这些数据模型直接暴露给 UDF API。比如，Presto 的 UDF 使用 Presto 的 Type Object、Block、Slice、Long、boolean、double 等数据类型来描述数据，而 Hive 的 UDF 使用 ObjectInspectors 和 Objects。其他引擎也类似。</p>
<h3 id=udf-的定义-api>UDF 的定义 API</h3>
<p>此外，用户定义 UDF 的方式也随着引擎的不同的不同。比如，Presto 使用特殊的类型注解来声明一个表示 UDF 的类。Hive UDF 类则需要继承 GenericUDF 抽象类，而 Spark UDF 实现则使用 SQL API 或 Expression API。</p>
<h3 id=udf-的-api-特性>UDF 的 API 特性</h3>
<p>最后，UDF API 提供的特性集也不尽相同。比如，Hive UDF 提供了将文件添加到 MapReduce 分布式缓存的钩子，允许在不同工作程序上执行的 UDF 处理这些文件。Presto 或 Spark 的 UDF 则不提供这种功能。即使多个引擎中都存在某个功能，其在 API 中的表达方式也会有所不同。Presto UDF 允许用户声明哪些参数可以为空，而 Hive 和 Spark UDF 将 null 直接委托给用户。Presto 通过在使用相同名称的情况下多次实现 UDF 来实现 UDF 重载。在 Hive 和 Spark 中，用户使用相同的类，但需要手动检查输入类型是否是符合预期的类型。</p>
<h2 id=udf-api-的复杂性>UDF API 的复杂性</h2>
<p>当前引擎的 API 具有不同程度的复杂性和对 UDF 开发者技能集的期望。比如，Hive UDF 要求开发者理解 Object 和 ObjectInspector 模型。期望用户在 UDF 初始化时捕获输入的 ObjectInspectors，并以树遍历的方式逐级检查来验证它是否符合预期类型。此外，还期望用户通过捕获输入的 ObjectInspectors 子树并从中创建新的 ObjectInspectors 树来显式绑定参数，以作为输出 ObjectInspectors 返回。比如 UDF 期望类型为 <code>Map[String, Array[K]] => Map[K, K]</code>，在查询执行时，会使用 <code>Map[String, Array[K]]</code> 来调用 UDF，下面的对象检查器树会被传给 UDF 的初始化方法：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190116144344.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>需要由开发者来完成树遍历的工作，验证上面的蓝色节点是否符合用户预期，然后再捕获灰色节点的值(或子树)，这里是 K，然后通过将绿色节点添加到从 K 子树捕获的内容来构建下面的树，从而构造返回类型，如下图所示：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190116171758.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>此外在 Hive 中，甚至是单个类的 ObjectInspectors(如 StringObjectInspector)也具有该类相同顶级 ObjectInspector 类的变体和不同实现。编写 Hive UDF 的用户必须了解这些差异，并且不同的实现不可互换。处理这些可互换性检查和保证时会带来大量的代码复杂性。</p>
<p>在 Presto UDF 中可以发现另一种形式的 API 复杂性。Presto UDF 允许用户通过 Block API 处理容器数据类型，如 Array、Map、Struct，Block API 是用于操作字节数组的 API。因此，用户会接触到字节数组内复杂数据类型的物理布局，并且必须编写多个步骤的低级操作来表示在这些容器类型上的简单高级操作。另一个例子是使用依赖项注入来解析与泛型类型数组相对应的具体运行时类型，以及解析 UDF 依赖项。此外，当 UDF 期望顶级泛型类型(即它可以采用任何类型)时，必须为每个匹配的顶级具体类型的每个实例重新实现，实现数量的增加使得泛型参数的数量呈指数级增长。虽然通过编写代码生成的 UDF 可以缓解这个问题，但也仍然是一种复杂的方法。</p>
<h2 id=可传输的-udf>可传输的 UDF</h2>
<p>在物理和逻辑独立性的驱动下，以及 API 差异和复杂性问题的推动下，我们设计的 Transport UDF API，它支持用户专注于 UDF 逻辑，而不是实现和遵守特定于平台的接口。用户编写一次逻辑就可以在任何平台上运行。</p>
<p>高阶想法是为用户提供一个用于实现 UDF 的标准数据 API。该标准数据 API 可以由任何平台、使用其在原生 UDF 中使用的原生数据类型来实现。比如，Map 对象将在 Presto 中显示为 PrestoMapType 以及 Block 数据类型。在 Hive 中则是 MapObjectInspector 和一个 Object。这些标准数据 API 被操作仅可传输 UDF API，来表达标准数据上的实际逻辑。</p>
<p>可传输 UDF API 可以通过类型签名来操作泛型容器类型，如 <code>Array[T]</code> 或 <code>Map[K,V]</code>。可传输 UDF 被构造为抽象类，并被表达实际逻辑的具体 UDF 继承。最后，可以从自动生成的特定于平台的包装器来调用这些 UDF API。这意味着，可传输 UDF API 实现是一个独立于平台的中间表示逻辑。它也有两个特定于平台的外观，可以很容易的提供给用户。一个外观向下，这是特定于平台的标准数据 API 实现，另一个外观向上，这是特定于平台的自动生成的包装器。该家头如图所示：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190116151520.png style=display:block;width:50% alt=NAME align=center>
</div>
<h3 id=示例>示例</h3>
<p>如上所述，用户所要做的就是定义可传输 UDF。在下面的例子中，接收两个数组作为输入来构造一个 Map——第一个数组作为 Map 的键，第二个数组作为 Map 的值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MapFromTwoArraysFunction</span> 
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>StdUDF2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StdArray</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StdArray</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StdMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span> 
  <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TopLevelStdUDF</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>StdType</span> <span style=color:#000>_mapType</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getInputParameterSignatures</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ImmutableList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;array(K)&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;array(V)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getOutputParameterSignature</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;map(K,V)&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StdFactory</span> <span style=color:#000>stdFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stdFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>_mapType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStdFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createStdType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getOutputParameterSignature</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StdMap</span> <span style=color:#000>eval</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StdArray</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StdArray</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>StdMap</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStdFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>_mapType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFunctionName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;map_from_two_arrays&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFunctionDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;A function to create a map out of two arrays&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面的例子中，StdMap 和 StdArray 作为接口为 Map 和 Array 对象提供了高阶操作方法。基于 UDF 所要执行的引擎，这些接口会以不同的方式来处理特定引擎的原生数据类型。<code>getStdFactory()</code> 方法会以给定的数据类型来创建对象，比如上面的例子中，Map 的键类型以第一个数组的元素类型为准，Map 的值类型以第二个数组的元素类型为准。StdUDF2 是一个抽象类，表示一个接收两个参数的 UDF，被具体 UDF 的输入输出类型来参数化。</p>
<h2 id=总结>总结</h2>
<p>Transport 作为定义 UDF 的 API 和框架，在不牺牲任何性能的同时能够在不同平台上像使用原生 UDF 一样来复用 UDF。这是实现物理与逻辑独立性目标的第一步。被当前 UDF 的差异性和复杂性所驱动。在 LinkedIn，事实证明，可传输 UDF 是提供开发人员工作效率的强大工具，使他们能够共享 UDF 逻辑并确保跨引擎的数据处理一致性。</p>
<h2 id=udf-的其他应用场景与问题>UDF 的其他应用场景与问题</h2>
<h3 id=统一数据处理-apiapache-beam>统一数据处理 API：Apache Beam</h3>
<p>在 Apache Beam 的技术愿景中，希望可以使用任意语言 Beam SDK 编写 Beam Pipeline，然后可以运行在任何 Runner 中(每个 Runner 对应一个底层的大数据引擎，例如 Flink Runner、Spark Runner)的能力。设计中通过两个可移植的层来实现这个目标：</p>
<ul>
<li>Runner API 层提供了 SDK 和 Runner 无关的 Pipeline 定义。</li>
<li>Fn API 层，允许 Runner 调用使用特定语言 SDK 编写的 UDF(用户自定义函数)。</li>
</ul>
<h3 id=通用数据处理框架apache-nifi>通用数据处理框架：Apache Nifi</h3>
<p>Nifi 中预定义了大量的 Processor，并支持自定义。Processor 本身仍然可以被看做是扩展了 Nifi 执行上下文的 Function。</p>
<p>Nifi 提供了表达式来操作 FlowFile 的属性，用于配置处理器。表达式有 Antlr 解析，其中的执行函数由 <code>Evaluator</code> 类建模，Evaluator 的建模过程也与 Function 抽象类似，值得借鉴。</p>
<h3 id=流式计算引擎apache-flink>流式计算引擎：Apache Flink</h3>
<p>Flink 中将函数分为 3 类：</p>
<ul>
<li>Scalar Functions，将零个、一个或多个标量值转换到一个标量值。</li>
<li>Table Functions，将零个、一个或多个标量值转换到多个数据行。</li>
<li>Aggregation Functions，将一个表转换为一个标量值。</li>
</ul>
<p>用户自定义并注册函数之后，可以直接在 Table、SQL API 中使用。</p>
<h3 id=流式计算引擎aliyunantfin-maxcompute>流式计算引擎：Aliyun(Antfin) MaxCompute</h3>
<p>MaxCompute 与 Flink 类似将函数分为三类，但通过注解或反射来获得函数的类型签名。</p>
<h3 id=规则引擎drools>规则引擎：Drools</h3>
<p>如果业务逻辑复杂，通常会使用规则引擎来代替大量的 if-else 语句。在 Drools 规则定义中，when 部分的断言函数和字段引用、then 部分的数据操作函数都需要应用到函数建模来实现业务特定的计算逻辑。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>when
  $s : Order(amout &gt; 500 &amp;&amp; amout &lt;= 1000)
then
  $s.setScore(500);
  update($s);
</code></pre></div><h3 id=消息路由规则apache-camel>消息路由规则：Apache Camel</h3>
<p>Camel 中提供了各种 DSL 或 XML 配置来完成路由规则的定义，如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>from(&#34;file:src/data?noop=true&#34;)
  .choice()
  .when(xpath(&#34;/person/city = &#39;London&#39;&#34;))
    .to(&#34;file:target/messages/uk&#34;)
  .otherwise()
    .to(&#34;file:target/messages/others&#34;);
</code></pre></div><p>对函数的应用主要集中在 when 部分的数据引用与值判定，这里使用的是 xpath 表达式。</p>
<h3 id=有限状态机>有限状态机</h3>
<p>在有限状态机中，需要定义状态的迁移条件，迁移条件中包含对领域模型的数据引用、求值与判定，同样需要使用函数建模。</p>
<h3 id=业务应用集成>业务应用集成</h3>
<p>总的来说，需要在各个层次和维度上，面向业务场景或业务层框架提供一组通用的函数建模 API，以提升业务开发和框架开发的效率。比如：</p>
<ul>
<li>定义较为宽泛的类型系统，以支持对各种引擎、框架中 UDF 的集成。</li>
<li>为原生类型提供预定义的函数(或称为算子)，以便直接引用来(动态)构建更加复杂的函数。</li>
<li>支持基于原生类型构建复杂类型，并为这些复杂类型定义函数。</li>
<li>支持直接以代码形式，定义、注册、调用类型安全的函数。</li>
<li>支持以字符串表达式形式来定义函数，以满足动态(定义、更新、执行)场景。</li>
<li>支持以类似 IDE GUI Plugin 插件的形式定义、引用、执行函数。</li>
<li>支持函数式的、类型安全的链式调用、组合、柯里化。</li>
<li>提供良好的扩展机制，以优雅的、类型安全的方式扩展、引用函数。</li>
<li>提供良好的集成机制，以简便的方式将函数适配到其他框架、引擎以实现复用。</li>
<li>提供良好的测试机制，使得函数可测试、且能简化测试过程。</li>
</ul>
<h2 id=references>References</h2>
<ul>
<li><a href=https://engineering.linkedin.com/blog/2018/11/using-translatable-portable-UDFs>Transport UDFs</a></li>
<li><a href=https://beam.apache.org/documentation/programming-guide/#composite-transforms>Apache Beam</a></li>
<li><a href=https://nifi.apache.org/docs/nifi-docs/html/nifi-in-depth.html>Apache NiFi In Depth</a></li>
<li><a href=https://nifi.apache.org/docs.html>Apache NiFi Docs</a></li>
<li><a href=https://ci.apache.org/projects/flink/flink-docs-release-1.7/dev/table/udfs.html#scalar-functions>Flink UDF</a></li>
<li><a href=https://tech.antfin.com/docs/2/27867#h2-url-5>Aliyun(Antfin) MaxCompute UDF</a></li>
<li><a href=https://docs.jboss.org/drools/release/7.15.0.Final/drools-docs/html_single/>Drools Docs</a></li>
<li><a href=http://camel.apache.org/java-dsl.html>Apache Camel Routing DSL</a></li>
<li><a href=http://www.vavr.io/vavr-docs/#_functions>Java Vavr functions</a></li>
<li><a href=https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/Lambda-QuickStart/index.html>Java SE8 Lambda</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7b184dd3e82373d1771186dcbfbbe498>6.2 - Flink Type System</h1>
<blockquote>
<p><strong>为什么以及如何构建一个类型系统。</strong></p>
</blockquote>
<p>Flink 在内部构建了一套自己的类型系统，因为 Flink 需要推导那些在分布式计算过程中被传输和存储的数据的相关类型信息。就像数据库对表结构的引用一样。在大多数情况下，Flink 均使用自己的这套类型系统来无缝的推导类型信息。基于丰富的类型类型信息，Flink 可以完成更多功能的实现，如：</p>
<ul>
<li>使用 POJO 类型，并通过对其字段名的引用来执行 grouping、joining、aggregating。类型信息能够帮助 Flink 在早期完成检查(拼写错误或类型兼容性)，而非在运行时导致失败。</li>
<li>Flink 对类型信息了解越多，序列化和数据布局结构则会更好。这对于 Flink 中内存的应用范式是非常重要的(尽可能在堆内外处理序列化数据，以使得序列化过程变得廉价)。</li>
<li>避免用户在大多数情况下对序列化框架的担心，同时避免对类型的手动注册过程。</li>
</ul>
<h2 id=类型层级>类型层级</h2>
<ul>
<li>Basic
<ul>
<li>Java Primitive Types</li>
<li>void/String/Date/BigDecimal/BigInteger</li>
</ul>
</li>
<li>Array
<ul>
<li>Array of Primitive</li>
<li>Array of Object</li>
</ul>
</li>
<li>Composite
<ul>
<li>Java Tuple, max 25 fields</li>
<li>Scala case class/tuple, max 22 fields</li>
<li>Row, tuples with any number fields</li>
<li>POJO, bean-like class</li>
</ul>
</li>
<li>Auxiliary
<ul>
<li>Option/Either/List/Map&mldr;</li>
</ul>
</li>
<li>Generic
<ul>
<li>Using Kryo</li>
</ul>
</li>
</ul>
<h2 id=抽象结构>抽象结构</h2>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/:Users:zhange:Downloads:FlowStateModeler.jpg style=display:block;width:90% alt=NAME align=center>
</div>
<p>可以看到，抽象结构与类型层级定义基本对应。<code>TypeInformation</code> 是所有类型的基类。</p>
<blockquote>
<p>module: flink-core</p>
<p>package: org.apache.flink.api.common.typeinfo</p>
<p>Comments on TypeInformation class:</p>
<ul>
<li>这是 Flink 类型系统的核心类。对于一个用户函数来说(UDF)，Flink 需要一个类型信息来作为该函数的输入输出类型。该类型信息类作为一个工具来生成对应类型的序列化器和比较器，并用于执行语义检查，比如当一些字段在作为 joing 或 grouping 的键时，检查这些字段是否在该类型中存在。</li>
<li>该类型信息同时连接了编程语言对象模型和逻辑扁平模式(ligical flat schema)。它将类型的字段映射到扁平模式的列(字段)。</li>
</ul>
</blockquote>
<h2 id=类型提取>类型提取</h2>
<p><code>TypeExtractor</code> 类可以根据方法签名、子类信息等蛛丝马迹自动提取或恢复类型信息。</p>
<blockquote>
<p>module: flink-core</p>
<p>package: org.apache.flink.api.java.typeutils
s
Comments on TypeExtractor class:</p>
<p>一个对类进行反射分析的工具类，用于检测转换函数的返回类型。
该类可以从 function、operator、Class、实例等对象中提取类型信息。</p>
</blockquote>
<p>由于 Java 中的类型擦除机制，自动提起并不是很有效，因此有些情况下(比如由 URLClassLoader 动态加载的类)仍然需要手动处理。比如下面的示例中使用 <code>returns</code> 方法来声明返回类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>inputDS</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>groupBy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>gourpKeys</span><span style=color:#204a87;font-weight:700>:_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reduce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DistinctReduce</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setCombineHint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CombineHint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HASH</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;distinct&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>returns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getType</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p><code>returns</code> 方法接收 3 种类型的参数：</p>
<ol>
<li>字符串描述的类名，如 “String”。</li>
<li>用于泛型类型参数的 TypeHint。</li>
<li>Java 原生 Class 对象。</li>
</ol>
<h2 id=类型注册>类型注册</h2>
<p><code>ExecutionEnvironment</code> 提供的 <code>registerType</code> 方法可以用来向 Flink 注册子类信息(Flink 认识父类，但不一定认识子类的一些独特特性，因此需要注册)。以 Flink-ML 为例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>registerFlinkMLTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Vector types
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.DenseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.SparseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  
  <span style=color:#8f5902;font-style:italic>// Matrix types
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.DenseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.SparseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  
  <span style=color:#8f5902;font-style:italic>// Breeze Vector types
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>breeze.linalg.DenseVector</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]])</span>
  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>breeze.linalg.SparseVector</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]])</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <code>registerType</code> 方法内部，会使用 <code>TypeExtractor</code> 来提取类型信息。上面注册过程中调用的方法是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointException</span><span style=color:#ce5c00;font-weight:700>(...);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>TypeInformation</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TypeExtractor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTypeInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeInfo</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>PojoTypeInfo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerPojoType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerKryoType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以发现，获取到的类型信息属于 PojoTypeInfo 及其子类，那么将其注册到一起；否则统一交给 Kryo 去处理，Flink 并不过问(这种情况下性能会变差)。</p>
<h2 id=类型声明>类型声明</h2>
<p>通过 <code>TypeInformation.of()</code> 方法可以非常方便的创建类型信息对象。</p>
<ol>
<li>对于非泛型类，直接传入 Class 对象即可：
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=color:#000>Outer</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Inner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>4L</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>PojoTypeInfo</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>typeInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PojoTypeInfo</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>TypeInformation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li>
<li>对于泛型类，需要借助 TypeHint 来保存泛型类型信息。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TypeInfomation</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Tuple2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> 
     <span style=color:#000>TypeInformation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeHint</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Tuple2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;(){});</span>
</code></pre></div><ul>
<li>TypeHint 的原理是创建一个匿名子类，运行时 TypeExtractor 可以通过 <code>getGenericSuperclass().getActuralTypeArguments()</code> 方法来回去保存的实际类型。</li>
</ul>
<ol start=3>
<li>预定义常量。如 BasicTypeInfo 中定义了一系列常用原生类型的类型信息实例。或者直接使用更简单的 Types 类。</li>
<li>自定义 TypeInfo 和 TypeInfoFactory。
<ul>
<li>通过自定义 TypeInfo 为任意类提供 Flink 原生内存管理(而非 Kryo)，可令存储更紧凑，运行时也更高效。</li>
<li>开发者在自定义类上使用 @TypeInfo 注解，随后创建相应的 TypeInfoFactory 并覆盖 createTypeInfo 方法。</li>
<li>注意需要继承 TypeInformation 类，为每个字段定义类型，并覆盖元数据方法，例如 isBasicType、isTupleType、元数(对于一维的 Row 类型，等于字段的个数)等等，从而为 TypeExtractor 提供决策依据。</li>
</ul>
</li>
</ol>
<h2 id=类型序列化>类型序列化</h2>
<p>Flink 自带了很多 TypeSerializer 子类，大多数情况下各种自定义类型都是常用类型的排列组合，因而可以直接复用。</p>
<p>如果不能满足，可以继承 TypeSerializer 及其子类来实现自己的特定类型的序列化器。</p>
<h3 id=kryo-序列化>Kryo 序列化</h3>
<h2 id=陷阱与缺陷>陷阱与缺陷</h2>
<ul>
<li>Lambda 函数的类型提取?</li>
<li>Kryo 的 JavaSerializer 在 Flink 下存在 Bug?</li>
</ul>
<h2 id=类型机制与内存管理>类型机制与内存管理</h2>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190130161127.png style=display:block;width:40% alt=类型信息到内存块 align=center>
</div>
<p>下面以 StringSerializer 为例，来看下 Flink 是如何紧凑管理内存的。下面是 StringSerializer 的序列化方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>serialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DataOutputView</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>StringValue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后是具体的序列化过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writeString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CharSequence</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DataOutput</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>thorws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// the length we write is offset by one, because a length of zero indicates a null value
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// write the length, variable-length ecdoded
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;=</span> <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lenToWrite</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>charAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
      
      <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;=</span> <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，Flink 对于内存管理是非常细致的，层次分明，代码也容易理解。</p>
<h2 id=reference>Reference</h2>
<ul>
<li><a href=https://ci.apache.org/projects/flink/flink-docs-release-1.7/dev/types_serialization.html>Apache Flink Reference</a></li>
<li><a href=https://www.cnblogs.com/fxjwind/p/6294237.html>Flink - TypeInformation</a></li>
<li><a href=https://segmentfault.com/a/1190000016350098>Flink - Type System</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-87d04a505f4113248f48de1fa6ff0993>7 - Parboiled</h1>
<p><a href=https://github.com/sirthias/parboiled>Parboiled</a> 是一个轻量、易用、强大且优雅的解析库，用于解析任意任意输入文本，基于 “解析表达式文法(PEGs)”，同时支持 Java 和 Scala。PEGs 是一种针对形式特定语法的上下文无关文法，是对正则表达式的很好替代，通过 CFGs 来构建解析器通常也会比传统的方式要有很多优势。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9128c2dc49c622f7600933c8d1ea1035>7.1 - CH01-Motivation</h1>
<p>Parboiled 的诞生源自对 JVM 上现有解析器构建工具的挫败感。</p>
<p>近年来流行动态语言(如 Ruby、Groovy)的巨大增长，很大一部分原因是它们将自身作为 DSL 的模型。虽然这些语言(甚至是一些静态类型的语言，如 Scala)具有简洁灵活的语法，通常直接可以用作内部 DSL 的基础，但相当笨拙的 Java 语法使得内部 DSL 非常缺乏吸引力。</p>
<p>对于很多项目来说，一个很小的 DSL 久能够构建出一个优雅的“用户接口”，以在没有 GUI 的情况下提供丰富的表现力以及灵活性。在 Java 中，内部 DSL 并不在规划之内，你不得不为外部 DSL 构建一个解析器以获得便利。尽管外部 DSL 并非解析器的唯一用例，像 Java 中这样对语言的传统解析支持工具并不出众。很多时候支持 DSL 并非项目的核心目标(如下编译器实现中)，而是解决各种问题之一的优雅方案。因此，你可能并不希望将太多时间用于上下文无关的文法、词法理论以及错综复杂的外部解析器生成器。您只想以某种方式指定解析语法的外观并使其快速轻松地工作。这也就是 Parboiled 存在的原因。</p>
<p>下面是一些传统解析器生成器的缺点：</p>
<ul>
<li>专有性，以非 Java 语法的形式保存在单独的项目文件(如外部 DSL)。</li>
<li>对文法文件没有 IDE 内置支持(语法高亮、内联检查、重构、代码导航等)。</li>
<li>运行外部解析器生成器需要特殊的构建步骤。</li>
<li>“谜不可触”，在你项目中生成的 Java 源文件需要与文法规范保持同步。</li>
<li>通过词法分析(令牌生成)和令牌解析阶段中的分离解析过程进行更复杂的设计和维护。</li>
<li>综合占用(ANTLR 分发的生成器加上运行时占用多余 1.8 MB)。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-05a361d8cd94e1828f1031c78fe17a96>7.2 - CH02-Features</h1>
<ol>
<li>以 Java、Scala 源码的形式定义文法。
<ul>
<li>没有外部的、非 Java/Scala 源码格式的文件。</li>
<li>无需学习额外的特有语法。</li>
<li>无需破坏 IDE 支持。</li>
</ul>
</li>
<li>真实世界可读。
<ul>
<li>来自<a href=https://en.wikipedia.org/wiki/Parsing_expression_grammar>PEG</a>的完整表现力。</li>
<li>支持强大且灵活的解析器动作。</li>
<li>游戏的解析错误包括与恢复。</li>
<li>高性能。</li>
</ul>
</li>
<li>非常易于集成。
<ul>
<li>无需管理外部的解析器生成器。</li>
<li>没有特殊的步骤使你的构建过程复杂化。</li>
<li>你的项目结构中不再有“谜不可触”的、生成的源文件。</li>
<li>开放、轻量的结构使得非常易于集成到现有项目结构。</li>
</ul>
</li>
<li>轻量、易用。</li>
</ol>
<ul>
<li>仅有一个解析阶段(词法分析代码不是必须的)。</li>
<li>少量且简单的 API。</li>
<li>整个库仅占用 300/450 KB，依赖较少。</li>
</ul>
<p>虽然 Parboiled 最初设计的速度低于易用性和可维护性，但其解析性能自早期版本以来已显着改善，现在对于大多数应用程序来说已经足够了。它可以以近似的速率解析其自身的 Java 5 源码。以每秒 55,000 行或每秒 200 万个字符的速度运行(2.4 GHz Intel Core i5 单核，OS/X Java 6)。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c01e1d6286ccead6f7f8fe20b1de6a82>7.3 - CH03-Java Example</h1>
<p>首先是一个计算器的文法定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Expression &lt;- Term ((&#39;+&#39; / &#39;-&#39;) Term)*
Term &lt;- Factor ((&#39;*&#39; / &#39;/&#39;) Factor)*
Factor &lt;- Number / &#39;(&#39; Expression &#39;)&#39;
Number &lt;- [0-9]+
</code></pre></div><p>然后是基于 Java 代码的解析器定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@BuildParseTree</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CalculatorParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Expression</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>(),</span>
      <span style=color:#000>ZeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;+-&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>(),</span>
      <span style=color:#000>ZeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;*/&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>FirstOf</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>(),</span>
      <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;(&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Expression</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#4e9a06>&#39;)&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>OneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CharRange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;0&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;9&#39;</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后是对该解析器的应用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1+2&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>CalculatorParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Parboiled</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CalculatorParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ParsingResult</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReportingParseRunner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Expression</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>String</span> <span style=color:#000>parseTreePrintOut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ParseTreeUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printNodeTree</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseTreePrintOut</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>第 2 行创建了一个解释器实例，其方法可以被用于各种不同的 ParserRunner 来执行实际的解析过程并创建 ParsingResult。ParsingResult 对象除了包含输入是否匹配的信息之外，还包含表达式的解析树的根(如果启用了解析书构建)、结果值、解析错误列表。理解解析器是如何处理输入的方式是使用 ParseTreeUtils.printNodeTree，如上面示例中第 4~5 行那样。</p>
<p>通常来说，Parboiled 会在 Java 语法的约束下使你的规则规范尽可能的可读。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-58a76c5a3dcaf6862a60be2d58ff89be>7.4 - CH04-Scala Example</h1>
<p>首先是一个计算器的文法定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Expression &lt;- Term ((&#39;+&#39; / &#39;-&#39;) Term)*
Term &lt;- Factor ((&#39;*&#39; / &#39;/&#39;) Factor)*
Factor &lt;- Number / &#39;(&#39; Expression &#39;)&#39;
Number &lt;- [0-9]+
</code></pre></div><p>然后是基于 Scala 代码的解析器定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.parboiled.scala._</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimpleCalculator</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Parser</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Expression</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rule0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Term</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>zeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>anyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;+-&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Term</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Factor</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>zeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>anyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;*/&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Factor</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Number</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>Expression</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Number</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>oneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#4e9a06>&#34;9&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后是对该解析器的应用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>input</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1+2&#34;</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>parser</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleCalculator</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>buildParseTree</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ReportingParseRunner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Expression</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>parseTreePrintOut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parboiled</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>support</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ParseTreeUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printNodeTree</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseTreePrintOut</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-aefd071109bac895cd9af8eb4428de7d>7.5 - CH05-Comparison</h1>
<p>如果你将解析需求想象为一个光谱，一边是“脏且快”的正则表达式，一边是像 ANTLR 一样完整的解析器生成器，Parboiled 则旨在填补两端之间的巨大空间。对于非常简单的用例，正则表达式可能是一个具有最小开销的适当解决方案。然而，正则表达式可以很快变成丑陋的混乱、难以阅读理解并最终难以维护。在许多情况下，它们也缺乏表达能力来解析像嵌套构造这样需要递归规则定义的东西。它们也不会生成正确的错误消息或从输入的错误中恢复，而这可以在开发过程中节省大量时间。</p>
<p>在光谱的另一端，像 ANTLR 和 Rats! 这样强大的工具当然也有其适用场景。当必须解析那些用复杂语言编写的大量源码时，解析器生成器可能是合适的工具。比如，你可能想要使用现有的语法，或者需要一些发展多年的企业工具的完整特性集。</p>
<p>然而，当你需要定义自己的语法，并且对解析器生成器没有丰富的经验，Parboiled 则可以快速简便的帮你达到目的。Parboiled 可以用于小的任务，如解析日期与时间；也可以用于复杂的任务，如解析 Java 源码或像 Markdown 这样的标记语言。占用小、轻量的架构使其很容易与其他应用集成，同时又能为多种定制需求提供良好的基础。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0b8da0caaa67951e41a357509aa1eb83>7.6 - CH06-Concepts</h1>
<h2 id=纵观全局>纵观全局</h2>
<p>Parboiled 提供了一个递归下降的 PEG 解析器实现来操作你指定的 PEG 规则。</p>
<p>你的语法规范可以包含解析器动作，这些动作可以在解析过程中的任意一点执行额外的逻辑，比如使用自定义条件来增强输入识别，或者构造抽象语法树(AST)。</p>
<h3 id=两个阶段>两个阶段</h3>
<p>你的代码会在两个阶段与 Parboiled 交互。在第一个阶段——“规则构造”阶段，Parboiled 会基于你定义的 Java/Scala 代码为解析器规则构建一个树(一个有向图)。该阶段与实际的输入阶段没有依赖，仅需要在整个 JVM 的生命周期中执行一次，即构建过的规则树是可复用的。第二个阶段是实际的解析阶段，使用第一阶段中的规则来处理特定的输入文本。最终的执行结构将包含以下信息：</p>
<ul>
<li>一个布尔值来表示输入是否与根规则匹配。</li>
<li>可能遇到的所有解析错误。</li>
<li>由你的解析器动作构造的一个或多个值对象。</li>
</ul>
<h3 id=规则构造>规则构造</h3>
<p>在执行由 Java/Scala 定义的规则代码时将触发规则构造。Parboiled 分别为 Java 和 Scala 提供了单独的 DSL 来使得规则的定义过程与语言本身结合的更加舒适。</p>
<p>在 Java 中你需要实现一个自定义类来继承 BaseParser 类，并定义一些方法来返回 Rule 实例。这些方法可以通过调用其他自定义方法、终止符、预定义原语、动作表达式来构造规则实例。由于 Java 语法的限制，Parboiled 则使用了一个名为“解析器扩展(Parser Extension)”的过程来支持比其他方式更加简洁的规则构造代码。</p>
<p>因为 Scala 本身就富有较强的表现力，因此 Parboiled 并不需要为 Scala 再提供一个单独的解析器扩展步骤。在 Scala 中，你可以直接通过 Scala 语言元素来构造解析器规则树。</p>
<h3 id=解析动作>解析动作</h3>
<p>为了避免你的解析器仅仅是一个“识别器”(一段仅能检测输入是否与定义的语法匹配的代码)，在你的解析器中需要包含一些动作。解析器动作是一段自定义的代码，在规则执行期间的一些特定点被执行。除了检查解析器状态(如查看匹配的输入文本片段)，解析器动作通常用于构造“值”(如 AST 节点)，并可以作为语义谓词主动影响解析过程。</p>
<h3 id=值栈>值栈</h3>
<p>在规则执行阶段，你的解析器动作可以利用“值栈”来组织自定义对象的构造，如 AST 节点。值栈是一个简单的栈结构，作为一个临时存储为自定义对象提供服务。使用值栈的方式取决于你使用的是 Parboiled Java 还是 Parboiled Scala。</p>
<h3 id=解析树>解析树</h3>
<p>在规则执行阶段 Parboiled 能够以可选的方式构造一个解析树，其节点对应于已识别的规则。每个解析树 Node 包含一个对应规则的 Matcher，同时，被匹配的输入文本(位置)也会作为当前值栈的栈顶元素。该解析树可以被看做是输入对已匹配规则的记录，在调试过程中尤其有用。</p>
<h3 id=解析执行器>解析执行器</h3>
<p>ParseRunner 的职责是“监管”解析的执行过程，并能以可选的方式提供额外的逻辑，尤其重要的是对非法输入字符的处理(基于语法)。当你使用 Parboiled 执行解析时可以选择一下 5 种预定义的 ParseRunner：</p>
<ol>
<li>BasicParseRunner，最快最基本的 ParseRunner，不执行错误处理。</li>
<li>ReportingParseRunner，为输入的第一个错误创建衣蛾 InvalidInputError。</li>
<li>RecoveringParseRunner，最复杂的 ParseRunner，报告输入中的所有错误，并尝试从错误中恢复。</li>
<li>TracingParseRunner，为每条匹配的或未匹配的规则有选择的打印追踪信息。</li>
<li>ProfilingParseRunner，在你的解析器处理一个或多个输入时生成详细的统计信息。</li>
</ol>
<h2 id=rule-tree>Rule Tree</h2>
<p>像大多数解析相关的程序一样，Parboiled 严重依赖于图和树结构。第一个这样的结构会在解析过程中创建，即规则“树”。该规则树这时尚未与实际的输入产生依赖。解析输入会在解析执行的过程中被解析器消费并被应用到规则树上，该过程可以以可选的方式生成一个解析树。</p>
<p>假设以下示例语法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>a ← b ‘a’ c
b ← ‘b’ d
c ← ‘c’ d
d ← ‘d’ c?
</code></pre></div><p>如果你将该语法转换为一个图，仅将规则作为图的节点，规则引用作为有向边，这时该语法可以用以下结构来表示：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190212174806.png style=display:block;width:20% alt=NAME align=center>
</div>
<p>你会发现该图存在一个环，同时节点 d 拥有两个父亲，这也就是为什么该图不是一个树而仅仅是一个有向图。很多真实世界的语法的大多部分都像是一个树，带有非常清晰的规则到子规则层级引用。虽然回环(递归)并不十分罕见，但与“常规”分层引用相比，它们的数量确实很少。</p>
<p>因此这样的原因(以及对许多人而言，“树”是一种更常见的心理图景)，你可能会选择将这样的规则图看做是带有两个特殊异常的规则树：多父亲、回环。</p>
<p>顺便提一下，PEG 语法的这种有向图特性几乎与方法调用在 JVM 中的工作方式一致：方法调用其他方法，可能包括调用堆栈祖先。这也是为什么 Parboiled 会或多或少的将规则声明映射到 Java/Scala 的方法调用。你的每个解析器规则方法都会构造一个规则对象，并在构造过程中潜在的调用其他规则构造方法。</p>
<p>然而这里还有两个问题：</p>
<ul>
<li>Java/Scala 方法递归到方法自身或其祖先时需要一种方式来终止递归。通常这是通过一些逻辑实现的，可以在逻辑中通过一些条件来退出递归。然而规则声明无法做到这一点，只有解析的输入文本(是有限的)将会终止任何规则递归。因此为了防止用于构造规则的 Java/Scala 方法出现无限递归，需要采取一些技巧。</li>
<li>当一个规则构造方法被调用多次时(可能被多起其他规则构造方法调用)，通常会为每次调用创建结构相同的全新的规则实例。虽然这不是什么问题，但在规模较大的语法中则会比较低效，这时一个大型的规则树中会包含很多重复的规则实例。</li>
</ul>
<p>Parboiled 在 Java 中通过重写解析类的规则方法来、并注入开发者不可见的代码来解决这两个问题。这些代码会确保每个方法仅会被调用一次，即背个规则仅被创建一次，后续的调用则会返回已创建的相同规则实例。如果规则的创建过程递归会自身，则插入代理规则以防止无限递归。所有这些事情都在幕后透明地发生，开发者无需关心。</p>
<p>Parboiled 在 Scala 中则不需要重写实际的字节码，而是将实际的规则创建代码封装到一个函数块，并作为主规则构建方法的参数。</p>
<p>最后，当你调用你的顶级规则方法并传给所选的 ParseRunner 时，则会得到一个规则树，没有重复节点，正确的链接关系，甚至还有递归。</p>
<h3 id=mathcers>Mathcers</h3>
<p>你可能已经在 Javadoc API 文档中看到 Rule 接口仅仅是一个外观接口，带有很少的方法以指定特殊的规则属性。所有实现该接口的类被定义在 <code>org.parboiled.matchers</code> 中。有一个用于所有规则原语的 Matcher 实现，它实现了实际规则类型的逻辑。因此规则树实际上是一个 Matcher 树。然而，大多时候你不必了解这些内部细节，仅需关注于解析器规则和值栈。</p>
<h2 id=value-stack>Value Stack</h2>
<p>在规则执行阶段，你的解析器动作可以利用“值栈”来组织自定义对象(如 AST 节点)的构造。值栈是一个简单的栈结构，作为临时存储服务于自定义对象。</p>
<p>通常，规则可以以任何方式修改值栈。可以创建新的值并推到栈上，或者消费已有的值，或者转换已有的值并重新推到栈上，等等。Parboiled 解析引擎并不关心你的规则和解析器动作与值栈之间的交互。</p>
<p>有两个特殊异常：</p>
<h3 id=规则未匹配>规则未匹配</h3>
<p>如果规则因任何原因未匹配成功，则将值栈重置为执行该失败规则之前的状态。这意味着失败的规则无法修改值栈(这包括失败的语义判定动作)。</p>
<p>此行为的原因是使您不仅可以将动作放在一系列规则的最后位置。考虑如下规则：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Rule ← ‘a’ ‘b’ action ‘c’
</code></pre></div><p>假设匹配规则 “b” 之后将一个新值推到栈上。如果因为最终的元素 “c” 不能匹配到规则而导致规则序列失败，该值栈仍然会包含刚才被动作推入的新值。即使您的规则逻辑可能能够处理这些情况，这也会使动作设计复杂化并使解析器逻辑更加脆弱。</p>
<p>事实上，当规则不匹配时 Parboiled 重置堆栈的行为使得你可以自由的放置解析器动作，并将值栈用于规则内临时存储，这在很多情况下都非常方便。</p>
<h3 id=语义判定>语义判定</h3>
<p>Test 和 TestNot 规则永远不会影响值栈。Parboiled 会使用一个以保存的快照将值栈重置回 Test/TestNot 规则匹配之前的状态。因此，您可以确定语法判定永远不会“混乱”您的值栈设置，即使它们包含解析器动作或引用其他规则。</p>
<h2 id=parse-tree>Parse Tree</h2>
<p>Parboiled 在规则执行阶段以可选的方式支持构建一个解析树。查看解析树可以更好的理解你的解析器对输入的消费过程，因此有助于解析器的开发和调试。</p>
<p>由 Parboiled 创建的解析树由一系列实现 Node 接口的不可变对象组成。除了基本的树节点功能(父亲、儿子)之外，该接口定义了节点名、所匹配输入文本的起始终止位置，以及一个自定义值对象。一些工具类为解析树提供了额外的处理方法，有 ParseTreeUtils、TreeUtils、GraphUtils。</p>
<p>需要注意的是解析树的节点是不可变的，即一旦被创建则不再能被修改。这实际上意味着它们的子节点结构和它们的值对象“引用”不能被修改。(尽管它们的值对象可以是可变的，或者仍然能够被修改。)整个解析树会从底向上被构建，先从叶子节点开始。通常来说，如果开启了解析树构建选项，匹配成功的每个规则都会创建一个解析树节点，该节点将匹配成功的子规则所创建的节点作为子节点。匹配失败的规则不会创建节点。解析树可以被认为是“已匹配规则的记录”。Parboiled 将解析树节点的 value 字段值设置为节点构造时值栈的栈顶元素。因此产看解析树值对象可以为你提供解析器如何使用值栈的线索。</p>
<p>或许对解析树最有用的使用方式是使用 ParseTreeUtils 的 printNodeTree 来将其打印出来。</p>
<h3 id=在-java-中开启解析树构建>在 Java 中开启解析树构建</h3>
<p>可以在解析器实现类上添加 <code>@BuildParseTree</code> 注解来开启解析树构建。还可以在解析器方法上使用 <code>@SuppressNode</code>/<code>@SuppresssSubnodes</code>/<code>@SkipNode</code> 来对解析树进行微调。</p>
<h3 id=在-scala-中开启解析树构建>在 Scala 中开启解析树构建</h3>
<p>在 Scala 中，Parser 特质拥有一个 <code>buildParseTree</code> 标记方法，将其设置为 true 则可以开启解析树构建。最简单的方式是在解析器类的构造方法上调用 <code>.withParseTreeBuilding()</code> 方法。类似 Java API，可以使用 <code>Parser$RuleOption</code> 中的选项来对解析树的构建过程进行微调。</p>
<h2 id=ast-construction>AST Construction</h2>
<p>和解析树与语法之间的紧密关联关系相反，你想要构造的抽象语法树(AST)则完全取决于你的项目需要。这就是为什么 Parboiled 采用非常开放和灵活的方法来支持它。</p>
<p>事实上对 AST 节点的类型没有任何约束。Parboiled 没有提供任何不变或可变的对象来使用，因此也不会强制你使用什么。可以查看 <code>org.parboiled.trees</code> 包来开始。</p>
<p>通常你可以使用解析器值栈来作为构造 AST 的“工作台”。对于 Java API 可以参考 Calculators 示例，Scala API 可以参考 JSON Parser 示例。</p>
<h2 id=error-handling>Error Handling</h2>
<p>对非法输入的适当处理是任何要被应用到真实项目的解析器的关键特性，这也是正则比倒是的最大缺陷之一。比如，如果用户在自定义 DSL 中提供了输入，你可以清楚的知道其中的语法或语义错误。语义错误可以被更高级的应用程序捕获并报告，但是语法错误必须在解析器中直接被捕获并报告。Parboiled 通过提供 4 种不同的 ParseRunner 实现来支持你选择处理解析错误的方式。</p>
<h3 id=basicparserunner>BasicParseRunner</h3>
<p>这是最简单的实现。它不会执行任何错误处理，如果输入与指定的语法规则无效，则会简单的导致解析过程不匹配。这时，它的行为就像正则表达式引擎一样。它只执行一次解析，是确定指定输入是否符合解析器语法定义的最快方式。</p>
<h3 id=recordingparserunner>RecordingParseRunner</h3>
<p>比 BasicParseRunner 多一点特性：跟踪输入字符流中成功匹配的最远输入位置。如果给定的语法根规则不匹配，则紧随其后的位置必须是错误位置。和 BasicParseRunner 一样，仅执行一次解析运行。</p>
<h3 id=reportingparserunner>ReportingParseRunner</h3>
<p>不提供任何错误恢复功能，但是会在发现输入中的第一个匹配错误时报告错误。它在无错误输入上执行一次解析运行，但如果输入包含解析错误，则内部触发另外两次运行。在第二次运行期间，它会记录第一个解析错误的位置，并且在第三次运行期间，它会“监视”解析器尝试匹配错误字符时的行为，以便为用户创建有意义的错误消息。然后实例化一个 InvalidInputError 并将其添加到 ParsingResult 中返回的错误解析列表中。</p>
<h3 id=recoveringparserunner>RecoveringParseRunner</h3>
<p>这是 4 种 ParseRunner 实现中最复杂的一个，它提供了自动的、只能的错误恢复，并且即便是存在解析错误也能完整的解析整个输入文本。Parboiled 提供的这种策略与 ANTLR 类似。如果可能的话，Parboiled 会在识别到非法输入时尝试进行单字符删除、插入或替换。如果仍然失败，Parboiled 会在当前规则堆栈中找到合适的重新同步规则，并是由所有非法字符，知道解析器可以重新同步以继续解析为止。</p>
<h4 id=解析错误恢复细节>解析错误恢复细节</h4>
<p>类似于 ReportingParseRunner，RecoveringParseRunner 首先会尝试一次快速的基本运行以发现输入是否存在错误。如果整个输入没有任何错误则直接结束执行。</p>
<p>如果首次运行出现错误，RecoveringParseRunner 则会执行以下算法来尝试克服错误：</p>
<ol>
<li>首先执行一次“记录运行”以检测当前错误的位置。</li>
<li>然后执行一次“报告运行”，并将有意义的 InvalidInputError 添加到解析错误列表。</li>
<li>然后当前错误位置的字符会被临时性的删除，随后再次执行“记录运行”来发现下个错误的位置，以此类推。如果没有发现更多错误，则表示所有错误已被解决，然后直接结束解析。</li>
<li>在“报告运行”期间，运行器会收集所有在预期字符发生错误的规则并失败。对于所有这些规则，运行期会尝试插入临时性的“虚拟”字符到输入字符流，然后执行一次“记录运行”来检测下个错误的位置。如果这些插入的字符能够使得完整运行整个输入文本，则直接结束解析。</li>
<li>运行器尝试使用一个配件“虚拟”字符来替换错误字符(像上一步一些样)。如果这样能够使得错误得到解决则直接结束解析。</li>
<li>在这一步中，运行器知道没有单个字符恢复能够完全修复错误输入。但是它现在知道是否有一个动作(单个字符删除、插入、替换)允许解析器能够继续解析直到超出错误的位置。如果是这种情况，则可以通过单个字符恢复来克服错误，并且运行器应用允许解析器继续解析最远输入流的修复。因此，如果有可用的话，运行器总是选择最好的单字符修复。</li>
<li>如果没有单字符修复能够使得将下一个错误位置推送到当前错误位置之外，则会强制运行程序重新同步并重新执行“记录运行”以确定下一个错误的位置。为了做到这一点，运行器首先识别重新同步规则，该规则是作为序列并且已经匹配至少一个字符的第一个父规则。运行器确定运行哪些字符在合法解析中遵循此重新同步规则，并跳过所有不符合条件的字符。</li>
<li>既然最佳单字符修复或重新同步已经克服了当前的解析错误，则运行器继续解析到下一个错误并从步骤 1 开始从该错误中恢复。</li>
</ol>
<h3 id=动作设计的后果>动作设计的后果</h3>
<p>由于上述概述的解析错误恢复策略允许解析即使已存在错误，如果你决定使用 RecoveringParseRunner，解析器动作应该能够处理一些意外情况。</p>
<p>单字符修复通常不会对你的动作产生任何影响，因为解析器动作所能看到的匹配输入文本已经包含错误更正，即排除掉了非法字符，并且在错误恢复期间插入的虚拟字符也包含在其结果中。但是，通过重新同步进行错误恢复会导致不匹配的规则序列“神奇的”匹配，即使并非是所有序列子规则都匹配或甚至运行。由于这会抛弃预期的值栈设置，因此在重新同步期间，Parboiled 会在重新同步序列中执行所有低限度要求的解析器动作。所有这些动作都会看到空匹配，因此可以提供有意义的默认值。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-63d9481a39ef551c7e8a0cb56828ef77>7.7 - CH07-Java APIs</h1>
<p>Parboiled Java 的应用步骤：</p>
<ol>
<li>安装依赖。</li>
<li>确定要解析器值栈中要参数化的类型，继承 BaseParser 实现自定义解析类。</li>
<li>在该解析类中添加返回类型为 Rule 的规则方法。</li>
<li>通过 <code>Parboiled.createParser</code> 创建解析器实例。</li>
<li>调用解析器的根规则方法来创建规则树。</li>
<li>选择 ParseRunner 的特定实现，调用其 run 方法并传入根规则和输入文本。</li>
<li>查看 ParsingResult 对象的属性。</li>
</ol>
<h2 id=rule-construction>Rule Construction</h2>
<p>一个 PEG 由任意数量的规则组成，规则又可以由其他规则、终止符、或下表中的原语规则组成：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Name</th>
<th style=text-align:center>Common Notation</th>
<th style=text-align:left>Primitive</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>Sequence</td>
<td style=text-align:center>a b</td>
<td style=text-align:left>Sequence(a, b)</td>
</tr>
<tr>
<td style=text-align:left>Ordered Choice</td>
<td style=text-align:center>a | b</td>
<td style=text-align:left>FisrtOf(a, b)</td>
</tr>
<tr>
<td style=text-align:left>Zero-Or-More</td>
<td style=text-align:center>a *</td>
<td style=text-align:left>ZeroOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>One-Or-More</td>
<td style=text-align:center>a +</td>
<td style=text-align:left>OneOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>Optional</td>
<td style=text-align:center>a ?</td>
<td style=text-align:left>Optional(a)</td>
</tr>
<tr>
<td style=text-align:left>And-Predicate</td>
<td style=text-align:center>& a</td>
<td style=text-align:left>Test(a)</td>
</tr>
<tr>
<td style=text-align:left>Non-Predicate</td>
<td style=text-align:center>! a</td>
<td style=text-align:left>TestNot(a)</td>
</tr>
</tbody>
</table>
<p>这些原语实际是 BaseParser 类的实例方法，即所有自定义解析器的必要父类。这些原语规则创建方法可以接收一个或多个 Object 参数，这些参数的类型可以是：</p>
<ul>
<li>一个 Rule 实例</li>
<li>一个字符字面量</li>
<li>一个字符串字面量</li>
<li>一个字符数组</li>
<li>一个动作表达式</li>
<li>实现了 Action 接口的类的实例</li>
</ul>
<p>除了以上原语方法，还有以下原语可供使用：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Method/Field</th>
<th style=text-align:left>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>ANY</td>
<td style=text-align:left>匹配任何除了 EOI 的单个字符</td>
</tr>
<tr>
<td style=text-align:left>NOTHING</td>
<td style=text-align:left>不匹配任何，总是失败</td>
</tr>
<tr>
<td style=text-align:left>EMPTY</td>
<td style=text-align:left>不匹配任何，总是成功</td>
</tr>
<tr>
<td style=text-align:left>EOI</td>
<td style=text-align:left>匹配特殊的 EOI 字符</td>
</tr>
<tr>
<td style=text-align:left>Ch(char)</td>
<td style=text-align:left>创建一个匹配单个字符的规则</td>
</tr>
<tr>
<td style=text-align:left>CharRange(char, char)</td>
<td style=text-align:left>匹配给定的字符范围</td>
</tr>
<tr>
<td style=text-align:left>AnyOf(string)</td>
<td style=text-align:left>匹配给定字符串中的任意字符</td>
</tr>
<tr>
<td style=text-align:left>NoneOf(string)</td>
<td style=text-align:left>不匹配给定字符串中的任意字符和 EOI</td>
</tr>
<tr>
<td style=text-align:left>IgnoreCase(char)</td>
<td style=text-align:left>匹配单个字符且忽略大小写</td>
</tr>
<tr>
<td style=text-align:left>IgnoreCase(String)</td>
<td style=text-align:left>匹配整个字符串且胡烈大小写</td>
</tr>
<tr>
<td style=text-align:left>String(string)</td>
<td style=text-align:left>创建一个匹配整个字符串的</td>
</tr>
</tbody>
</table>
<h2 id=parser-action-expressions>Parser Action Expressions</h2>
<p>Parboiled Java 的解析器可以在规则定义的任意位置包含解析器动作。这些动作可以分为 4 类。</p>
<h3 id=regular-objects-implementing-the-action-interface>“Regular” objects implementing the Action interface</h3>
<p>如果你的动作代码较多，则可以将其封装到一个实现了 Action 接口的自定义类中，然后再在规则定义方法中使用该自定义类的实例。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Action</span> <span style=color:#000>myAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyActionClass</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#000>myAction</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果使用这种方式，你的自定义动作类也可以实现 SkippableAction 接口以告诉解析器引擎在执行内部的语法判定时是否跳过这些动作。</p>
<h3 id=anonymous-inner-classes-implementing-the-action-interface>Anonymous inner classes implementing the Action interface</h3>
<p>更多时候动作仅会包含少量的代码，这时可以直接使用匿名类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Action</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Context</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#ce5c00;font-weight:700>...;</span> <span style=color:#8f5902;font-style:italic>// arbitrary action code
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// could also return false to stop matching the Sequence and continue looking for other matching alternatives
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=explicit-action-expressions>Explicit action expressions</h3>
<p>虽然匿名类要比独立的动作类定义简单一点，但仍然显得冗余。可以继续简化为一个布尔表达式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#000>ACTION</span><span style=color:#ce5c00;font-weight:700>(...),</span> <span style=color:#8f5902;font-style:italic>// the argument being the boolean expression to wrap
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>BaseParser.ACTION</code> 是一个特殊的标记方法，其告诉 Parboiled 将参数表达式封装到一个单独的、自动创建的动作类中，类似上面匿名类的例子。这样的动作表达式中可以包含对本地变量的访问代码或方法参数、读写非私有的解析器字段、调用非私有的解析器方法。</p>
<p>此外，如果动作表达式中调用实现了 ContextAware 接口的类对象方法，将自动在调用方法之前插入 setContext 方法。比如你想将所有的动作代码移出到解析器类之外以简化实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MyActions</span> <span style=color:#000>actions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyActions</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#000>ACTION</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>someAction</span><span style=color:#ce5c00;font-weight:700>()),</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果 MyActions 实现了 ContextAware 接口，Parboiled 将会自动在内部转换为类似下列清单的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MyActions</span> <span style=color:#000>actions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyActions</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Action</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Context</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>actions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>actions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>someAction</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意 BaseParser 已经继承了 BaseActions，其实现了 ContextAware 接口，所以解析器类中的所有动作方法可以通过 getContext 方法获得当前的上下文。</p>
<h3 id=implicit-action-expressions>Implicit action expressions</h3>
<p>大多数情况下，Parboiled 可以自动识别你的规则定义中哪些是动作表达式。比如下面的规则定义中包含了一个隐式的动作表达式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>OneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CharRange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;0&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;9&#39;</span><span style=color:#ce5c00;font-weight:700>)),</span>
        <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>random</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>5</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>extractIntegerValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>someObj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doSomething</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Parboiled 的检测逻辑如下：</p>
<p>BaseParser 中所有的默认规则创建器方法都拥有通用的 Java Object 参数，Java 编译器会自动将原始布尔表达式的结果作为一个 Boolean 对象传递。这是通过在布尔动作表达式的代码之后隐式地插入对 Boolean.valueOf 的调用来实现的。Parboiled 会在你的规则方法字节码中查找这些调用然后将其当做隐式动作表达式来处理，如果其结果直接被用作规则创建方法的参数的话。也可以通过 <code>@ExplicitActionsOnly</code> 注解(定义在解析类或规则方法上)来关闭该功能。</p>
<h3 id=return-values>Return Values</h3>
<p>动作表达式均为布尔表达式。其返回值将影响对当前值的解析进度。如果动作表达式的结果为 false，解析将继续，就像替换动作表达式的假设解析规则失败一样。因此，你可以将动作表达式视作可以(匹配)成功或(匹配)失败的“规则”，具体则取决于其返回值。</p>
<h2 id=value-stack>Value Stack</h2>
<p>在任何特定的解析项目中，解析器动作都希望能够以某种方式来创建对应输入文本结构的自定义对象。Parboiled Java 提供了两种工具来在解析器规则中管理创建的自定义对象：</p>
<ul>
<li>值栈</li>
<li>动作变量</li>
</ul>
<p>值栈是一个简单的栈结构，作为一个临时存储为你的自定义对象提供服务。你的解析器动作可以将对象推到栈上、推出栈、推出再推入栈交换对象，等等。值栈的实现隐藏在 ValueStack 接口下面，其定义了操作值栈的一系列方法。</p>
<p>所有的解析器动作可以通过当前 context 的 getValueStack 来获得当前值栈。为了简化值栈操作的冗余，BaseActions 类(BaseParser)的父类提供了一些值栈操作的快捷方法，可以直接在解析器动作表达式中内联使用。</p>
<p>在解析器规则中使用值栈的方式通常有以下几种：</p>
<ul>
<li>匹配分隔符、空格或其他辅助结构的规则通常不会影响值栈。</li>
<li>较底层的规则会从匹配到的输入中创建基本对象并推到栈上。</li>
<li>调用一个或多个底层规则的高级别规则，会从栈上推出值对象，然后创建高级别的对象并重新推到栈上。</li>
<li>根规则作为最高级别的规则会创建自定义结构的根对象。</li>
</ul>
<p>大多时候，但一个规则被完整处理过后，最多会推一个对象到栈上(尽管在处理过程中会推多个对象到栈上)。那么你可以认为：如果规则匹配，一个规则会在栈上创建一个特定类型的对象，否则则不会影响栈。</p>
<h3 id=规则定义须知>规则定义须知</h3>
<p>一条重要的原则是一个规则总是应该确保其对值栈的操作是“稳定的行为”，而无论输入是什么。因此，如果一个规则将一个特定类型的值对象推到栈上，则其应该为所有可能的输入都推一个值到栈上。如果不然，那么引用该规则之外的规则时将无法在规则匹配之后会值栈的状态进行假设，这将使动作设计复杂化。以下讨论着眼于各种 PEG 原语以及在使用影响值栈的解析器操作时需要注意的事项。</p>
<h4 id=sequence-规则>Sequence 规则</h4>
<p>由于它们不提供任何可选组件，因此关于值栈操作，序列规则相当直接。它们的最终结果本质上是稳定的，仅包括所有子操作的串联。</p>
<h4 id=firstof-规则>FirstOf 规则</h4>
<p>FirstOf 规则提供了几种替代子规则匹配。为了向外部提供稳定的“输出”，重要的是所有替代方案都表现出兼容的值堆栈行为。考虑以下例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>FirstOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>C</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果子规则 A 将推一个对象到栈，则 B 和 C 也需要这样做。</p>
<h4 id=optional-规则>Optional 规则</h4>
<p>Optional 规则的子规则通常不应该在值栈中添加或删除对象。由于 Optional 规则始终会匹配成功，即使其子规则不匹配，对值栈上的对象数量的任何影响都将违反“稳定行为”的原则。但是，Optional 规则可以很好的转换值栈上的内容，而避免不稳定的行为。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#8f5902;font-style:italic>// number adds an Integer object to the stack
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#39;+&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#8f5902;font-style:italic>// another Integer object on the stack
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// pop two and repush one Integer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该规则的行为始终是稳定的，因为它总是会将一个值推送到栈上。</p>
<h4 id=zeroormoreoneormore-规则>ZeroOrMore/OneOrMore 规则</h4>
<p>与 Optional 规则类似，不能添加或删除值栈的元素，而可以修改值栈的元素内容。</p>
<h2 id=action-variables>Action Variables</h2>
<p>对值栈的操作需要一些设计素养，同时为了类型安全，值栈中仅能使用一个较为宽泛的通用类型，然后再在解析器动作使用使用强制类型转换，这会带来维护成本。为了提供更多的灵活性，提供了动作变量功能。</p>
<p>通常，一个规则方法会在规则的子结构中包含多个动作表达式，以协同的方式来构造出最终规则。在很多情况下如果能够通过一个通用的临时辅助变量来访问规则中所有的动作，则会大有帮助。考虑如下例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>Verbatim</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>StringVar</span> <span style=color:#000>text</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>StringVar</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>OneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>ZeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BlankLine</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\n&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span>
                <span style=color:#000>NonblankIndentedLine</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getText</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>VerbatimNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该规则用于解析 Markdown 的逐行结构，其中包含一行或多行的缩进文本。这些缩进行可以通过完全的空行来拆分，如果其跟随的有最少一个缩进行则也可以被匹配。该规则的工作是创建一个 AST 节点并初始化为匹配到的文本(不带有行缩进)。</p>
<p>为了能够构建该 AST 节点的文本参数，如果能够访问一个字符串变量——作为构建字符串的临时容器，则会非常有帮助。在通常的 Java 方法中可以使用一个本地变量，然而，因为规则方法仅包含规则的构造代码而非规则实际运行的代码，因此本地变量起不了作用。因为本地变量仅能在规则的构造期间而非运行期间可见。</p>
<p>这就是为什么 Parboiled Java 提供了一个名为 Var 的类，它可以用作规则执行阶段的本地变量。Var 对象包装一个任意类型的值，可以拥有初始值，支持对值的读写，可以在嵌套规则方法之间传递。每轮规则调用(如规则匹配重试)都会接受到自己的 Var 域，因此递归规则中的动作也会像预期一样运行。此外，Var 类还定义了一系列简便的辅助方法来简化其在动作表达式中的应用过程。</p>
<p>如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Var</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Var</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#ce5c00;font-weight:700>...,</span>
        <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>42</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Rule</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Var</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#ce5c00;font-weight:700>...,</span>
        <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>26</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>规则方法 A 传递一个其域内定义的 Var 作为参数到规则方法 B，规则方法 B 内的动作向该 Var 写入一个新值，规则方法 A 中所有运行在 B 之后的动作都能看到该新写入的 Var 的值。上面的例子中，A 中的 action 读取 Var 值时会得到 26。</p>
<h2 id=parser-extension>Parser Extension</h2>
<p>当你首次调用 <code>Parboiled.createParser</code> 来构造你的解析器实例时，Parboiled Java 会在内部运行解析器扩展逻辑来为你的解析器类增加所有可能的特殊功能。因为你定义的解析器类一定不是 private 和 final 的，因此可以被子类化。新创建的类与你原有的解析器类处于同一个包下，使用原有的类名并加上 <code>$$parboiled</code> 后缀。</p>
<p>自动穿件的解析器子类会覆写所有返回 Rule 实例的方法。这些覆写会在某个点将调用为派给父方法(即原始解析器类中的方法)，或者甚至完全重写而不会父类方法做任何调用。</p>
<p>以下规则方法扩展需要完全重写而不会对父方法执行委派调用：</p>
<ul>
<li>解析器动作表达式</li>
<li>动作变量</li>
</ul>
<p>以下规则方法扩展可以无需方法重写而应用，如果方法中没有上面列出的转换时也可以调用父方法：</p>
<ul>
<li>@Label</li>
<li>@Cache</li>
<li>@SuppressNode</li>
<li>@SuppressSubnodes</li>
<li>@SkipNode</li>
<li>@MemoMismatches</li>
</ul>
<p>通常你不必担心是否需要进行方法覆写的问题。然而在调试环节，当你需要在规则方法中添加断点以追踪执行过程时，如果你的规则方法被重写，则端点就无法没命中。因此，比如你需要调试一个带有隐式或显式动作表达式的规则方法时，需要临时将动作表达式改写为显式匿名内部 Action 类，来避免对该规则方法的完全重写。</p>
<p>解析器扩展逻辑不会触碰那些不返回 Rule 实例的方法则，而是直接保留。</p>
<h2 id=examples>Examples</h2>
<ul>
<li><a href=https://github.com/sirthias/parboiled/tree/master/examples-java/src/main/java/org/parboiled/examples/abc>ABC Grammar</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Calculators>Calculators</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Java-Parser>Java Parser</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Time-Parser>Time Parser</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e7fc3f9332a7db16b99b057d62a76d6f>7.8 - CH08-Scala APIs</h1>
<p>与 Java 的区别在于规则的构造过程，在 Scala 中使用了特殊的 Scala DSL 构造。相比 Java API，Scala API 更具优势：</p>
<ul>
<li>更加简明的规则构建 DSL(Scala 语言的丰富表现力)。</li>
<li>通过对值栈的进一步抽象隐藏了值栈，增加了类型安全性(Scala Type Inference)。</li>
<li>高阶规则构造。</li>
<li>更快的初次规则构建(不再有昂贵的解析器扩展步骤)。</li>
</ul>
<h2 id=rule-construction>Rule Construction</h2>
<p>一个 PEG 由任意数量的规则组成，规则又可以由其他规则、终止符、或下表中的原语规则组成：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Name</th>
<th style=text-align:center>Common Notation</th>
<th style=text-align:left>Primitive</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>Sequence</td>
<td style=text-align:center>a b</td>
<td style=text-align:left>a ~ b</td>
</tr>
<tr>
<td style=text-align:left>Ordered Choice</td>
<td style=text-align:center>a | b</td>
<td style=text-align:left>a | b</td>
</tr>
<tr>
<td style=text-align:left>Zero-Or-More</td>
<td style=text-align:center>a *</td>
<td style=text-align:left>zeroOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>One-Or-More</td>
<td style=text-align:center>a +</td>
<td style=text-align:left>oneOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>Optional</td>
<td style=text-align:center>a ?</td>
<td style=text-align:left>optional(a)</td>
</tr>
<tr>
<td style=text-align:left>And-Predicate</td>
<td style=text-align:center>& a</td>
<td style=text-align:left>&(a)</td>
</tr>
<tr>
<td style=text-align:left>Non-Predicate</td>
<td style=text-align:center>! a</td>
<td style=text-align:left>!a</td>
</tr>
</tbody>
</table>
<p>除了以上原语方法，还有以下原语可供使用：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Method/Field</th>
<th style=text-align:left>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>ANY</td>
<td style=text-align:left>匹配任何除了 EOI 的单个字符</td>
</tr>
<tr>
<td style=text-align:left>NOTHING</td>
<td style=text-align:left>不匹配任何，总是失败</td>
</tr>
<tr>
<td style=text-align:left>EMPTY</td>
<td style=text-align:left>不匹配任何，总是成功</td>
</tr>
<tr>
<td style=text-align:left>EOI</td>
<td style=text-align:left>匹配特殊的 EOI 字符</td>
</tr>
<tr>
<td style=text-align:left>ch(Char)</td>
<td style=text-align:left>创建一个匹配单个字符的规则</td>
</tr>
<tr>
<td style=text-align:left>{String} ~ {String}</td>
<td style=text-align:left>匹配给定的字符范围</td>
</tr>
<tr>
<td style=text-align:left>anyOf(String)</td>
<td style=text-align:left>匹配给定字符串中的任意字符</td>
</tr>
<tr>
<td style=text-align:left>ignoreCase(Char)</td>
<td style=text-align:left>匹配单个字符且忽略大小写</td>
</tr>
<tr>
<td style=text-align:left>ignoreCase(String)</td>
<td style=text-align:left>匹配整个字符串且胡烈大小写</td>
</tr>
<tr>
<td style=text-align:left>str(String)</td>
<td style=text-align:left>创建一个匹配整个字符串的</td>
</tr>
<tr>
<td style=text-align:left>nTimes(Int, Rule)</td>
<td style=text-align:left>创建一个匹配子规则 N 次的规则</td>
</tr>
</tbody>
</table>
<h2 id=parser-actions>Parser Actions</h2>
<p>在 Parboiled Java 中需要以布尔表达式的形式设置解析器动作，然后再被自动转换为解析器动作规则。没有进一步的动作类型来支持 Parboiled Java 对值栈操作元素数量进行区分。这意味着 Java 开发者不能依赖编译器来检测解析器动作对值栈操作的一致性(主要是元素数量)。因此在动作的设计期间需要更多对人的规范约束。</p>
<p>在 Parboiled Scala 中，Scala 的类型推断能力使得解析器动作支持比 Java 中更高级别的抽象。在 Scala 解析器动作中，无需对值栈进行操作，而是将其指定为函数。因此，它们不仅仅是简单的代码块，其本身就是类型。</p>
<p>根据规则中包含的解析器动作，规则的实际类型会发生变化。对值栈没有任何影响的规则类型为 Rule0。将类型为 A 的值对象推送到值栈的规则具有类型 <code>Rule1[A]</code>。导致类型分别为 A 和 B 的两个值对象被推送到值栈的规则类型为 <code>Rule2[A,B]</code>。导致类型为 Z 的一个值对象从堆栈中弹出的规则具有类型 <code>PopRule1[Z]</code>。目前共 15 种具体的规则类型。</p>
<p>这种稍微复杂的类结构允许 Scala 在规则类型中进行编码，以确定规则如何影响解析器值堆栈，并确保所有解析器操作正确地协同工作以生成解析器最终结果值。请注意，这不会对值对象的类型施加任何限制！</p>
<p>支持 3 种形式的解析器动作：</p>
<ol>
<li>动作操作符</li>
<li>push/test/run 方法</li>
<li>独立动作</li>
</ol>
<h3 id=action-operators>Action Operators</h3>
<p>共定义了 9 种动作操作符。每种都会链接一个动作函数到语法规则结构，但与它们的动作函数参数的类型和语义不同。下表是一个概览：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Action Result</th>
<th style=text-align:left>Action Argument(String)</th>
<th>Action Argument(Value Object Pop)</th>
<th>Action Argument(Value Object Peek)</th>
<th>Action Argument(Char)</th>
<th>Action Argument(IndexRange)</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>Value Object</td>
<td style=text-align:left>~></td>
<td>~~></td>
<td>~~~></td>
<td>~:></td>
<td>~&#187;</td>
</tr>
<tr>
<td style=text-align:left>Boolean</td>
<td style=text-align:left>~?</td>
<td>~~?</td>
<td>~~~?</td>
<td></td>
<td></td>
</tr>
<tr>
<td style=text-align:left>Unit</td>
<td style=text-align:left>~%</td>
<td>~~%</td>
<td><code>~~~%</code></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>以单个 <code>~</code> 字符起始的操作符通常是解析器动作接收已匹配输入文本的方式。其参数是一个类型为 <code>String => ...</code> 的函数。该操作符内部会创建一个新的动作规则，在运行时，将与紧邻的规则匹配的输入文本作为参数传递给该函数。</p>
<p>以 <code>~~</code> 和 <code>~~~</code> 字符起始的操作符接收一个或多个值对象作为参数。</p>
<p>以 <code>></code> 字符结尾的操作符创建一个或多个新的值对象，在动作函数运行之后推送到值栈。这些动作结构值的类型会被编码到操作符的返回类型。</p>
<p>以 <code>?</code> 字符结尾的操作符接收一个返回布尔值的函数作为语义判定。如果动作函数返回 false 则停止当前规则序列的求值，即为匹配，然后强制解析器回退并查找其他匹配可能。</p>
<p>以 <code>%</code> 字符结尾的操作符支持你运行任意逻辑而不会对处理过程产生影响。其动作函数返回 Unit，一旦解析器经过，它们就会被运行。</p>
<h3 id=pushtestrun-方法>push/test/run 方法</h3>
<p>上述讨论的动作操作符均为将你的动作链接到当前的解析处理过程，要么是接收已匹配的输入文本作为参数，要么是生成新的栈值元素。但有时你的动作并不需要任何输入，因为其在规则结构中的位置就是其需要的所有上下文。这时你可以使用 push/test/run 方法来实现与上述讨论的操作符相同的功能，这些方法由 Parser 特质提供。</p>
<p>由这些方法构造的动作规则可以通过被链接在一起。如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>JsonTrue</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>True</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=独立动作>独立动作</h3>
<p>独立动作是以 Context 对象作为参数的独立函数。它们可以像普通规则一样被使用，因为 Parser 特质提供了以下两种隐式转换：</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td>toRunAction(f:(Context[Any]) => Unit):Rule0</td>
<td>通用非判断动作</td>
</tr>
<tr>
<td>toTestAction(f:(Context[Any]) => Boolean):Rule0</td>
<td>通用语义判定动作</td>
</tr>
</tbody>
</table>
<p>当前解析的 Context 为通用动作提供了对解析器的所有状态访问能力。它们可以通过 getValueStack 方法来修改解析器的值栈。但并不推荐这种用法，因为这将导致 Scala 编译器无法有效的验证值栈操作的一致性。</p>
<h3 id=withcontext-动作>“withContext” 动作</h3>
<p>Parser 特质提供的另一个便利的工具是 withContext 方法，通过该方法，你可以包装一个动作函数然后再将其传递给动作操作符。该方法支持你的动作函数除了其常规的参数之外还能接收当前解析器的 Context。</p>
<p>withContext 的签名类似如下定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>withContext</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Context</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>因此，被该方法包装的动作函数在外部会显示为一个函数，比如，弹出值栈的两个对象并生成一个新的值。但是，在内部你的动作同样也可以接受到当前上下文的实例，比如可以查看当前输入位置以及行号。</p>
<h2 id=parser-tesing>Parser Tesing</h2>
<p>从 0.9.9.0 开始提供了一个 ParboiledTest 特质来简化测试的开发工作。Parboiled 使用它来完成内部测试，你可以参考 <a href=https://github.com/sirthias/parboiled/blob/master/parboiled-scala/src/test/scala/org/parboiled/scala/WithContextTest.scala>WithContextTest</a> 来查看应用方式。</p>
<h2 id=examples>Examples</h2>
<ul>
<li><a href=https://github.com/sirthias/parboiled/wiki/Simple-Calculator>Simple Calculator</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/JSON-Parser>JSON Parser</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d172300b36f276e75efe2961e9416e8d>7.9 - CH09-Advanced Topics</h1>
<ul>
<li><a href=https://github.com/sirthias/parboiled/wiki/Handling-Whitespace>Handling Whitespace</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Parsing-Performance-Tuning>Performance Tuning</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Indentation-Based-Grammars>Indentation Based Grammars</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/The-ProfilingParseRunner>ProfilingParseRunner</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Grammar-and-Parser-Debugging>Debugging</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Thread-Safety>Thread Safety</a></li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>