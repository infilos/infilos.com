<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>框架库 | infilos.com</title><meta property="og:title" content="框架库">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="框架库">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="框架库">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>框架库</h1>
<ul>
<li>1: <a href=#pg-2ec71341b8ce816d988919fa56fdc511>Spring</a></li>
<ul>
<li>1.1: <a href=#pg-0b0012bf149a4cf96b8074281a8541a8>CH01-IOC</a></li>
<li>1.2: <a href=#pg-2a6c4c04bf13071ae484b315e9244cd2>CH02-Spring IOC</a></li>
<li>1.3: <a href=#pg-7202eaa44b8f3d3daee17478a4ca42ec>CH03-Bean加载</a></li>
<li>1.4: <a href=#pg-a8a1a8038660c1cf3b1cbee6a84a454c>CH04-IOC源码</a></li>
<li>1.5: <a href=#pg-7f4178b3d93842e955c6e1949a1a8205>CH05-循环依赖</a></li>
<li>1.6: <a href=#pg-4cea3cc2683c0ae92393e6cee8ea20fa>CH06-AOP</a></li>
</ul>
<li>2: <a href=#pg-c1e8f2365fc6e91852aa984062de81f7>Hikari</a></li>
<ul>
<li>2.1: <a href=#pg-4044b0e6448e84d3abca221838625d38>基本概念</a></li>
<li>2.2: <a href=#pg-d65e1cea2e403108cd2bf982d6f46006>开源实现</a></li>
<li>2.3: <a href=#pg-bf5289a54cb90ff13efab472717f661d>配置参数</a></li>
<li>2.4: <a href=#pg-69b3ca93e755caee774ee61d37a37b29>JDBC API</a></li>
<li>2.5: <a href=#pg-4b9d150e32675cf552baf43c5f76029b>性能原理</a></li>
<li>2.6: <a href=#pg-15ec1a8762b47ae9a5a642074c2fb45b>优化原理</a></li>
<li>2.7: <a href=#pg-a68d253e10a456aa43583ccceb08ed00>参数解析</a></li>
<li>2.8: <a href=#pg-0571ba633db8293a9c18653c90e33707>动态代理</a></li>
<li>2.9: <a href=#pg-563c823956cc6c18f29bf3dac344c4ed>应用实践</a></li>
<li>2.10: <a href=#pg-fd9d53e36c38a6c8387036a57dd6ad34>监控度量</a></li>
<li>2.11: <a href=#pg-d0760fe5aebcb44b4fb0547d4e258a2f>常见问题</a></li>
<li>2.12: <a href=#pg-132362e06a52e754bd5f4df7fdd855b0>扩展技术</a></li>
</ul>
<li>3: <a href=#pg-87d04a505f4113248f48de1fa6ff0993>Parboiled</a></li>
<ul>
<li>3.1: <a href=#pg-9128c2dc49c622f7600933c8d1ea1035>CH01-Motivation</a></li>
<li>3.2: <a href=#pg-05a361d8cd94e1828f1031c78fe17a96>CH02-Features</a></li>
<li>3.3: <a href=#pg-c01e1d6286ccead6f7f8fe20b1de6a82>CH03-Java Example</a></li>
<li>3.4: <a href=#pg-58a76c5a3dcaf6862a60be2d58ff89be>CH04-Scala Example</a></li>
<li>3.5: <a href=#pg-aefd071109bac895cd9af8eb4428de7d>CH05-Comparison</a></li>
<li>3.6: <a href=#pg-0b8da0caaa67951e41a357509aa1eb83>CH06-Concepts</a></li>
<li>3.7: <a href=#pg-63d9481a39ef551c7e8a0cb56828ef77>CH07-Java APIs</a></li>
<li>3.8: <a href=#pg-e7fc3f9332a7db16b99b057d62a76d6f>CH08-Scala APIs</a></li>
<li>3.9: <a href=#pg-d172300b36f276e75efe2961e9416e8d>CH09-Advanced Topics</a></li>
</ul>
<li>4: <a href=#pg-3d1e7c2a6f7ffc9f4f8eab6963ee28b0>Udf Modeling</a></li>
<ul>
<li>4.1: <a href=#pg-44b7f71194b5e8e3e24267b6e8584135>Transport UDF at Linkedin</a></li>
<li>4.2: <a href=#pg-7b184dd3e82373d1771186dcbfbbe498>Flink Type System</a></li>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-2ec71341b8ce816d988919fa56fdc511>1 - Spring</h1>
</div>
<div class=td-content>
<h1 id=pg-0b0012bf149a4cf96b8074281a8541a8>1.1 - CH01-IOC</h1>
<h2 id=ioc-是什么>IOC 是什么</h2>
<p>**IoC，是 Inversion of Control 的缩写，即控制反转。*<em>他还有一个别名叫*<em>依赖注入</em></em>（Dependency Injection）有些资料也称依赖注入是IOC的一种常见方式。</p>
<p>IoC 不是什么技术，而是一种设计思想。在 Java 开发中，IoC 意味着将你设计好的对象交给容器控制，而不是传统的在你的对象内部直接控制。如何理解 Ioc 呢？理解 Ioc 的关键是要明确“谁控制谁，控制什么，为何是反转（有反转就应该有正转了），哪些方面反转了”，那我们来深入分析一下：</p>
<ul>
<li>**谁控制谁，控制什么：**传统 JavaSE 程序设计，我们直接在对象内部通过 new 进行创建对象，是程序主动去创建依赖对象；而 IoC 是有专门一个容器来创建这些对象，即由 IoC 容器来控制对象的创建；谁控制谁？当然是 IoC 容器控制了对象；控制什么？那就是主要控制了外部资源获取（不只是对象包括比如文件等）。</li>
<li>**为何是反转，哪些方面反转了：**有反转就有正转，传统应用程序是由我们自己在对象中主动控制去直接获取依赖对象，也就是正转；而反转则是由容器来帮忙创建及注入依赖对象；为何是反转？因为由容器帮我们查找及注入依赖对象，对象只是被动的接受依赖对象，所以是反转；哪些方面反转了？依赖对象的获取方式被反转了。</li>
</ul>
<h2 id=ioc-能做什么>IOC 能做什么</h2>
<p>IoC 不是一种技术，只是一种思想，一个重要的面向对象编程的法则，它能指导我们如何设计出松耦合、更优良的程序。传统应用程序都是由我们在类内部主动创建依赖对象，从而导致类与类之间高耦合，难于测试；有了 IoC 容器后，把创建和查找依赖对象的控制权交给了容器，由容器进行注入组合对象，所以对象与对象之间是松散耦合，这样也方便测试，利于功能复用，更重要的是使得程序的整个体系结构变得非常灵活。</p>
<p>其实 IoC 对编程带来的最大改变不是从代码上，而是从思想上，发生了“主从换位”的变化。应用程序原本是老大，要获取什么资源都是主动出击，但是在 IoC/DI 思想中，应用程序就变成被动的了，被动的等待 IoC 容器来创建并注入它所需要的资源了。</p>
<p>IoC 很好的体现了面向对象设计法则之一—— 好莱坞法则：“Don&rsquo;t call us,we will call you”；即由 IoC 容器帮对象找相应的依赖对象并注入，而不是由对象主动去找。</p>
<h3 id=依赖注入>依赖注入</h3>
<p>DI，是 <strong>Dependency Injection</strong> 的缩写，即依赖注入。依赖注入是 IoC 的最常见形式。</p>
<p>容器全权负责的组件的装配，它会把符合依赖关系的对象通过 JavaBean 属性或者构造函数传递给需要的对象。</p>
<p>DI 是组件之间依赖关系由容器在运行期决定，形象的说，即由容器动态的将某个依赖关系注入到组件之中。依赖注入的目的并非为软件系统带来更多功能，而是为了提升组件重用的频率，并为系统搭建一个灵活、可扩展的平台。通过依赖注入机制，我们只需要通过简单的配置，而无需任何代码就可指定目标需要的资源，完成自身的业务逻辑，而不需要关心具体的资源来自何处，由谁实现。</p>
<p>理解 DI 的关键是：“谁依赖谁，为什么需要依赖，谁注入谁，注入了什么”，那我们来深入分析一下：</p>
<ul>
<li>**谁依赖于谁：**当然是应用程序依赖于 IoC 容器；</li>
<li>**为什么需要依赖：**应用程序需要 IoC 容器来提供对象需要的外部资源；</li>
<li>**谁注入谁：**很明显是 IoC 容器注入应用程序某个对象，应用程序依赖的对象；</li>
<li><strong>注入了什么</strong>：就是注入某个对象所需要的外部资源（包括对象、资源、常量数据）。</li>
</ul>
<h3 id=ioc-与-di>IOC 与 DI</h3>
<p>其实它们是同一个概念的不同角度描述，由于控制反转概念比较含糊（可能只是理解为容器控制对象这一个层面，很难让人想到谁来维护对象关系），所以 2004 年大师级人物 Martin Fowler 又给出了一个新的名字：“依赖注入”，相对 IoC 而言，“依赖注入”明确描述了“被注入对象依赖 IoC 容器配置依赖对象”。</p>
<blockquote>
<p><a href=http://www.martinfowler.com/articles/injection.html>Martin Fowler—Inversion of Control Containers and the Dependency Injection pattern</a></p>
</blockquote>
<h3 id=ioc-容器>IOC 容器</h3>
<p>IoC 容器就是具有依赖注入功能的容器。IoC 容器负责实例化、定位、配置应用程序中的对象及建立这些对象间的依赖。应用程序无需直接在代码中 new 相关的对象，应用程序由 IoC 容器进行组装。在 Spring 中 BeanFactory 是 IoC 容器的实际代表者。</p>
<p>Spring IoC 容器如何知道哪些是它管理的对象呢？这就需要配置文件，Spring IoC 容器通过读取配置文件中的配置元数据，通过元数据对应用中的各个对象进行实例化及装配。一般使用基于 xml 配置文件进行配置元数据，而且 Spring 与配置文件完全解耦的，可以使用其他任何可能的方式进行配置元数据，比如注解、基于 java 文件的、基于属性文件的配置都可以</p>
<p>那 Spring IoC 容器管理的对象叫什么呢？</p>
<h3 id=bean>Bean</h3>
<p>JavaBean 是一种JAVA语言写成的可重用组件。为写成JavaBean，类必须是具体的和公共的，并且具有<strong>无参数的构造器</strong>。JavaBean 通过提供符合一致性设计模式的公共方法（getter / setter 方法）将内部域暴露成员属性。众所周知，属性名称符合这种模式，其他Java 类可以通过自省机制发现和操作这些JavaBean 的属性。</p>
<p>一个javaBean由三部分组成：<strong>属性、方法、事件</strong></p>
<p>JavaBean的任务就是: “Write once, run anywhere, reuse everywhere”，即“一次性编写，任何地方执行，任何地方重用”。</p>
<p>由 IoC 容器管理的那些组成你应用程序的对象我们就叫它 Bean。Bean 就是由 Spring 容器初始化、装配及管理的对象，除此之外，bean 就与应用程序中的其他对象没有什么区别了。</p>
<h2 id=ioc-容器-1>IOC 容器</h2>
<h3 id=核心接口>核心接口</h3>
<p><code>org.springframework.beans</code> 和 <code>org.springframework.context</code> 是 IoC 容器的基础。</p>
<p>在 Spring 中，有两种 IoC 容器：<code>BeanFactory</code> 和 <code>ApplicationContext</code>。</p>
<ul>
<li><code>BeanFactory</code>：Spring 实例化、配置和管理对象的最基本接口。</li>
<li><code>ApplicationContext</code>：BeanFactory 的子接口。它还扩展了其他一些接口，以支持更丰富的功能，如：国际化、访问资源、事件机制、更方便的支持 AOP、在 web 应用中指定应用层上下文等。</li>
</ul>
<p>实际开发中，更推荐使用 <code>ApplicationContext</code> 作为 IoC 容器的操作入口，因为它的功能远多于 <code>FactoryBean</code>。</p>
<p>常见 <code>ApplicationContext</code> 实现：</p>
<ul>
<li><strong>ClassPathXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从 classpath 获取配置文件；
<ul>
<li><code>new ClassPathXmlApplicationContext("classpath.xml");</code></li>
</ul>
</li>
<li><strong>FileSystemXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从文件系统获取配置文件。
<ul>
<li><code>new FileSystemXmlApplicationContext("fileSystemConfig.xml");</code></li>
</ul>
</li>
</ul>
<h3 id=应用流程>应用流程</h3>
<p>使用 IoC 容器可分为三步骤：</p>
<ol>
<li>配置元数据：需要配置一些元数据来告诉 Spring，你希望容器如何工作，具体来说，就是如何去初始化、配置、管理 JavaBean 对象。</li>
<li>实例化容器：由 IoC 容器解析配置的元数据。IoC 容器的 Bean Reader 读取并解析配置文件，根据定义生成 BeanDefinition 配置元数据对象，IoC 容器根据 BeanDefinition 进行实例化、配置及组装 Bean。</li>
<li>使用容器：由客户端实例化容器，获取需要的 Bean。</li>
</ol>
<h3 id=配置元数据>配置元数据</h3>
<blockquote>
<p><strong>元数据（Metadata）</strong> 又称中介数据、中继数据，为描述数据的数据（data about data），主要是描述数据属性（property）的信息。</p>
</blockquote>
<p>配置元数据的方式：</p>
<ul>
<li>
<p><strong>基于 xml 配置</strong>：Spring 的传统配置方式。在 <code>&lt;beans></code> 标签中配置元数据内容。</p>
<p>缺点是当 JavaBean 过多时，产生的配置文件足以让你眼花缭乱。</p>
</li>
<li>
<p><strong>基于注解配置</strong>：Spring2.5 引入。可以大大简化你的配置。</p>
</li>
<li>
<p><strong>基于 Java 配置</strong>：可以使用 Java 类来定义 JavaBean 。</p>
<p>为了使用这个新特性，需要用到 <code>@Configuration</code> 、<code>@Bean</code> 、<code>@Import</code> 和 <code>@DependsOn</code> 注解。</p>
</li>
</ul>
<h3 id=bean-概述>Bean 概述</h3>
<p>一个 Spring 容器管理一个或多个 bean。 这些 bean 根据你配置的元数据（比如 xml 形式）来创建。 Spring IoC 容器本身，并不能识别你配置的元数据。为此，要将这些配置信息转为 Spring 能识别的格式——BeanDefinition 对象。</p>
<h4 id=命名-bean>命名 Bean</h4>
<p>指定 id 和 name 属性不是必须的。 Spring 中，并非一定要指定 id 和 name 属性。实际上，Spring 会自动为其分配一个特殊名。 如果你需要引用声明的 bean，这时你才需要一个标识。官方推荐驼峰命名法来命名。</p>
<h4 id=支持别名>支持别名</h4>
<p>可能存在这样的场景，不同系统中对于同一 bean 的命名方式不一样。 为了适配，Spring 支持 <code>&lt;alias></code> 为 bean 添加别名的功能。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;subsystemA-dataSource&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;subsystemB-dataSource&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;subsystemA-dataSource&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;myApp-dataSource&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h4 id=实例化-bean>实例化 Bean</h4>
<p><strong>构造器方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;exampleBean&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;examples.ExampleBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p><strong>静态工厂方法</strong></p>
<h3 id=依赖>依赖</h3>
<p>依赖注入 依赖注入有两种主要方式：</p>
<ul>
<li>构造器注入</li>
<li>Setter 注入 构造器注入有可能出现循环注入的错误。如：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>B</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>){}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>B</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>){}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>依赖和配置细节</strong> 使用 depends-on Lazy-initialized Bean 自动装配 方法注入。</p>
<h2 id=ioc-容器配置>IoC 容器配置</h2>
<p>IoC 容器的配置有三种方式：</p>
<ul>
<li>基于 xml 配置</li>
<li>基于注解配置</li>
<li>基于 Java 配置</li>
</ul>
<p>作为 Spring 传统的配置方式，xml 配置方式一般为大家所熟知。</p>
<p>如果厌倦了 xml 配置，Spring 也提供了注解配置方式或 Java 配置方式来简化配置。</p>
<h3 id=xml-配置>Xml 配置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>         http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;resource1.xml&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;bean1&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;bean2&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;bean2&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;bean3&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;bean2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;resource2.xml&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</code></pre></div><p>标签说明：</p>
<ul>
<li><code>&lt;beans></code> 是 Spring 配置文件的根节点。</li>
<li><code>&lt;bean></code> 用来定义一个 JavaBean。<code>id</code> 属性是它的标识，在文件中必须唯一；<code>class</code> 属性是它关联的类。</li>
<li><code>&lt;alias></code> 用来定义 Bean 的别名。</li>
<li><code>&lt;import></code> 用来导入其他配置文件的 Bean 定义。这是为了加载多个配置文件，当然也可以把这些配置文件构造为一个数组（new String[] {“config1.xml”, config2.xml}）传给 <code>ApplicationContext</code> 实现类进行加载多个配置文件，那一个更适合由用户决定；这两种方式都是通过调用 Bean Definition Reader 读取 Bean 定义，内部实现没有任何区别。<code>&lt;import></code> 标签可以放在 <code>&lt;beans></code> 下的任何位置，没有顺序关系。</li>
</ul>
<h4 id=实例化容器>实例化容器</h4>
<p>实例化容器的过程： 定位资源（XML 配置文件） 读取配置信息(Resource) 转化为 Spring 可识别的数据形式（BeanDefinition）</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;services.xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;daos.xml&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
</code></pre></div><p>组合 xml 配置文件 配置的 Bean 功能各不相同，都放在一个 xml 文件中，不便管理。 Java 设计模式讲究职责单一原则。配置其实也是如此，功能不同的 JavaBean 应该被组织在不同的 xml 文件中。然后使用 import 标签把它们统一导入。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;classpath:spring/applicationContext.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;/WEB-INF/spring/service.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h4 id=使用容器>使用容器</h4>
<p>使用容器的方式就是通过<code>getBean</code>获取 IoC 容器中的 JavaBean。 Spring 也有其他方法去获得 JavaBean，但是 Spring 并不推荐其他方式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// create and configure beans
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;services.xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;daos.xml&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#8f5902;font-style:italic>// retrieve configured instance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>PetStoreService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;petStore&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PetStoreService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// use configured instance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>userList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsernameList</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=注解配置>注解配置</h3>
<p>Spring2.5 引入了注解。 <strong>优点</strong>：大大减少了配置，并且可以使配置更加精细——类，方法，字段都可以用注解去标记。 <strong>缺点</strong>：使用注解，不可避免产生了侵入式编程，也产生了一些问题。</p>
<ul>
<li>你需要将注解加入你的源码并编译它；</li>
<li>注解往往比较分散，不易管控。</li>
</ul>
<blockquote>
<p>注：spring 中，先进行注解注入，然后才是 xml 注入，因此如果注入的目标相同，后者会覆盖前者。</p>
</blockquote>
<h4 id=启动注解>启动注解</h4>
<p>Spring 默认是不启用注解的。如果想使用注解，需要先在 xml 中启动注解。 启动方式：在 xml 中加入一个标签，很简单吧。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context:annotation-config/&gt;</span>
</code></pre></div><blockquote>
<p>注：<code>&lt;context:annotation-config/></code> 只会检索定义它的上下文。什么意思呢？就是说，如果你 为 DispatcherServlet 指定了一个<code>WebApplicationContext</code>，那么它只在 controller 中查找<code>@Autowired</code>注解，而不会检查其它的路径。</p>
</blockquote>
<h4 id=spring-注解>Spring 注解</h4>
<ul>
<li><strong><code>@Required</code></strong>：只能用于修饰 bean 属性的 setter 方法。受影响的 bean 属性必须在配置时被填充在 xml 配置文件中，否则容器将抛出<code>BeanInitializationException</code>。</li>
<li><strong><code>@Autowired</code></strong>：可用于修饰属性、setter 方法、构造方法。
<ul>
<li>可以使用 JSR330 的注解<code>@Inject</code>来替代<code>@Autowired</code>。</li>
</ul>
</li>
<li><strong><code>@Qualifier</code></strong>：如果发现有多个候选的 bean 都符合修饰类型，指定 bean 名称来锁定真正需要的那个 bean。</li>
<li>JSR 250 注解
<ul>
<li><code>@Resource</code></li>
<li><strong><code>@PostConstruct</code> 和 <code>@PreDestroy</code></strong></li>
</ul>
</li>
<li>JSR 330 注解
<ul>
<li><code>@Inject</code></li>
</ul>
</li>
</ul>
<h3 id=java-配置>Java 配置</h3>
<p>基于 Java 配置 Spring IoC 容器，实际上是 Spring 允许用户定义一个类，在这个类中去管理 IoC 容器的配置。</p>
<p>为了让 Spring 识别这个定义类为一个 Spring 配置类，需要用到两个注解：<code>@Configuration</code> 和 <code>@Bean</code>。</p>
<p>如果你熟悉 Spring 的 xml 配置方式，你可以将 <code>@Configuration</code> 等价于 <code>&lt;beans></code> 标签；将 <code>@Bean</code> 等价于 <code>&lt;bean></code> 标签。</p>
<h4 id=bean-1>@Bean</h4>
<ul>
<li>
<p>@Bean 的修饰目标只能是方法或注解。</p>
</li>
<li>
<p>@Bean 只能定义在@Configuration 或@Component 注解修饰的类中。</p>
</li>
<li>
<p>@Configuration 类允许在同一个类中通过@Bean 定义内部 bean 依赖。</p>
</li>
<li>
<p>声明一个 bean，只需要在 bean 属性的 set 方法上标注@Bean 即可。</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotationConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Job</span> <span style=color:#000>getPolice</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Police</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Job</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Component</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;police&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Police</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Job</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;抓罪犯&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=configuration>@Configuration</h4>
<p><code>@Configuration</code> 是一个类级别的注解，用来标记被修饰类的对象是一个<code>BeanDefinition</code>。</p>
<p><code>@Configuration</code> 声明 bean 是通过被 <code>@Bean</code> 修饰的公共方法。此外，<code>@Configuration</code> 允许在同一个类中通过 <code>@Bean</code> 定义内部 bean 依赖。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyService</span> <span style=color:#000>myService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyServiceImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2a6c4c04bf13071ae484b315e9244cd2>1.2 - CH02-Spring IOC</h1>
<h2 id=基本概念>基本概念</h2>
<p>IoC（Inverse of Control:控制反转）是一种<strong>设计思想</strong>，就是 <strong>将原本在程序中手动创建对象的控制权，交由Spring框架来管理</strong>。 IoC 在其他语言中也有应用，并非 Spring 特有。 <strong>IoC 容器是 Spring 用来实现 IoC 的载体， IoC 容器实际上就是个Map（key，value），Map 中存放的是各种对象</strong>。</p>
<p>将对象之间的相互依赖关系交给 IoC 容器来管理，并由 IoC 容器完成对象的注入。这样可以很大程度上简化应用的开发，把应用从复杂的依赖关系中解放出来。 <strong>IoC 容器就像是一个工厂一样，当我们需要创建一个对象的时候，只需要配置好配置文件/注解即可，完全不用考虑对象是如何被创建出来的。</strong> 在实际项目中一个 Service 类可能有几百甚至上千个类作为它的底层，假如我们需要实例化这个 Service，你可能要每次都要搞清这个 Service 所有底层类的构造函数，这可能会把人逼疯。如果利用 IoC 的话，你只需要配置好，然后在需要的地方引用就行了，这大大增加了项目的可维护性且降低了开发难度。</p>
<p>Spring IOC 通过引入 xml 配置，由 IOC 容器来管理对象的生命周期，依赖关系等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503105756.png style=display:block;width:50% alt=NAME align=center> </div>
<p>从图中可以看出，我们以前获取两个有依赖关系的对象，要用 set 方法，而用容器之后，它们之间的关系就由容器来管理。</p>
<h2 id=什么是-spring-ioc-容器>什么是 Spring IOC 容器？</h2>
<p>Spring 框架的核心是 Spring 容器。容器创建对象，将它们装配在一起，配置它们并管理它们的完整生命周期。Spring 容器使用<strong>依赖注入</strong>来管理组成应用程序的组件。容器通过读取提供的配置元数据来接收对象进行实例化，配置和组装的指令。该元数据可以通过 XML，Java 注解或 Java 代码提供。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503105847.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=什么是依赖注入>什么是依赖注入？</h2>
<p><strong>依赖注入（DI,Dependency Injection）是在编译阶段尚未知所需的功能是来自哪个的类的情况下，将其他对象所依赖的功能对象实例化的模式</strong>。这就需要一种机制用来激活相应的组件以提供特定的功能，所以<strong>依赖注入是控制反转的基础</strong>。否则如果在组件不受框架控制的情况下，框架又怎么知道要创建哪个组件？</p>
<p>依赖注入有以下三种实现方式：</p>
<ol>
<li>构造器注入</li>
<li>Setter方法注入（属性注入）</li>
<li>接口注入</li>
</ol>
<h2 id=spring-中有多少种-ioc-容器>Spring 中有多少种 IOC 容器？</h2>
<p>在 Spring IOC 容器读取 Bean 配置创建 Bean 实例之前，必须对它进行实例化。只有在容器实例化后， 才可以从 IOC 容器里获取 Bean 实例并使用。</p>
<p>Spring 提供了两种类型的 IOC 容器实现</p>
<ul>
<li><strong>BeanFactory</strong>：IOC 容器的基本实现</li>
<li><strong>ApplicationContext</strong>：提供了更多的高级特性，是 BeanFactory 的子接口</li>
</ul>
<p>BeanFactory 是 Spring 框架的基础设施，面向 Spring 本身；ApplicationContext 面向使用 Spring 框架的开发者，几乎所有的应用场合都直接使用 ApplicationContext 而非底层的 BeanFactory；</p>
<p>无论使用何种方式，配置文件是相同的。</p>
<h2 id=beanfactory>BeanFactory</h2>
<p>BeanFactory，从名字上可以看出来它是 bean 的工厂，它负责生产和管理各个 bean 实例。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503110013.png style=display:block;width:50% alt=NAME align=center> </div>
<p>大概了解下这里提到的几个类：</p>
<ul>
<li><strong>ListableBeanFactory</strong>：这个 Listable 的意思就是，通过这个接口，我们可以获取多个 Bean，大家看源码会发现，最顶层 BeanFactory 接口的方法都是获取单个 Bean 的。</li>
<li><strong>HierarchicalBeanFactory</strong>：Hierarchical 单词本身已经能说明问题了，也就是说我们可以在应用中起多个 BeanFactory，然后可以将各个 BeanFactory 设置为父子关系。</li>
<li><strong>AutowireCapableBeanFactory</strong>： 这个名字中的 Autowire 大家都非常熟悉，它就是用来自动装配 Bean 用的，但是仔细看上图，ApplicationContext 并没有继承它，不过不用担心，不使用继承，不代表不可以使用组合，如果你看到 ApplicationContext 接口定义中的最后一个方法 getAutowireCapableBeanFactory() 就知道了。</li>
<li><strong>ConfigurableListableBeanFactory</strong> ：也是一个特殊的接口，看图，特殊之处在于它继承了第二层所有的三个接口，而 ApplicationContext 没有。这点之后会用到。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7202eaa44b8f3d3daee17478a4ca42ec>1.3 - CH03-Bean加载</h1>
<h2 id=解析流程>解析流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503121759.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=获取流程>获取流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503122924.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=创建流程>创建流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503123004.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a8a1a8038660c1cf3b1cbee6a84a454c>1.4 - CH04-IOC源码</h1>
<h2 id=applicationcontext-实例化-bean-的过程>ApplicationContext 实例化 Bean 的过程</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:applicationContext.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>ac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sayHello</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。</p>
<p>当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120343.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=启动过程分析>启动过程分析</h3>
<p>第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>setConfigLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，就是 <code>refresh()</code>，这里简单说下为什么是 <code>refresh()</code>，而不是 <code>init()</code> 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 <code>refresh()</code> 这个方法重建的，<code>refresh()</code> 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Prepare this context for refreshing.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Tell the subclass to refresh the internal bean factory.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Prepare the bean factory for use in this context.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Allows post-processing of the bean factory in context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//提供给子类实现一些postProcess的注册，如AbstractRefreshableWebApplicationContext注册一些Servlet相关的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Invoke factory processors registered as beans in the context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//调用所有BeanFactoryProcessor的postProcessBeanFactory()方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Register bean processors that intercept bean creation.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册BeanPostProcessor，BeanPostProcessor作用是用于拦截Bean的创建
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Initialize message source for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化消息Bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize event multicaster for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化上下文的事件多播组建，ApplicationEvent触发时由multicaster通知给ApplicationListener
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize other special beans in specific context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//ApplicationContext初始化一些特殊的bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Check for listener beans and register them.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册事件监听器，事件监听Bean统一注册到multicaster里头，ApplicationEvent事件触发后会由multicaster广播
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Instantiate all remaining (non-lazy-init) singletons.(重点)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 非延迟加载的单例Bean实例化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Last step: publish corresponding event.(最后，广播事件，ApplicationContext 初始化完成)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Propagate exception to caller.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面，我们开始一步步来肢解这个 <code>refresh()</code> 方法。</p>
<h3 id=创建-bean-容器前的准备工作>创建 Bean 容器前的准备工作</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Prepare this context for refreshing, setting its startup date and
</span><span style=color:#8f5902;font-style:italic> * active flag as well as performing any initialization of property sources.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// Switch to active.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupDate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>active</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Refreshing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize any placeholder property sources in the context environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initPropertySources</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Validate that all properties marked as required are resolvable:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// see ConfigurablePropertyResolver#setRequiredProperties
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 校验 xml 配置文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>validateRequiredProperties</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Store pre-refresh ApplicationListeners...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Reset local application listeners to pre-refresh state.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Allow for the collection of early ApplicationEvents,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// to be published once the multicaster is available...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationEvents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-bean-容器加载并注册-bean>创建 Bean 容器，加载并注册 Bean</h3>
<p>我们回到 <code>refresh()</code> 方法中的下一行 <code>obtainFreshBeanFactory()</code>。</p>
<p>注意，这个方法是全文最重要的部分之一，这里将会初始化 BeanFactory、加载 Bean、注册 Bean 等等。</p>
<p>当然，这步结束后，Bean 并没有完成初始化。这里指的是 Bean 实例并未在这一步生成。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 关闭旧的 BeanFactory (如果有)，创建新的 BeanFactory，加载 Bean 定义、注册 Bean 等等
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 返回刚刚创建的 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean factory for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>// AbstractRefreshableApplicationContext.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 如果 ApplicationContext 中已经加载过 BeanFactory 了，销毁所有 Bean，关闭 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意，应用中 BeanFactory 本来就是可以多个的，这里可不是说应用全局是否有 BeanFactory，而是当前
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// ApplicationContext 是否有 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanFactory</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 初始化一个 DefaultListableBeanFactory，为什么用这个，我们马上说。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 用于 BeanFactory 的序列化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSerializationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#8f5902;font-style:italic>// 下面这两个方法很重要，别跟丢了，具体细节之后说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的两个配置属性：是否允许 Bean 覆盖、是否允许循环引用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 加载 Bean 到 BeanFactory 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactoryMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O error parsing bean definition source for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>看到这里的时候，我觉得读者就应该站在高处看 ApplicationContext 了，ApplicationContext 继承自 BeanFactory，但是它不应该被理解为 BeanFactory 的实现类，而是说其内部持有一个实例化的 BeanFactory（DefaultListableBeanFactory）。以后所有的 BeanFactory 相关的操作其实是委托给这个实例来处理的。</p>
</blockquote>
<p>我们说说为什么选择实例化 <strong>DefaultListableBeanFactory</strong> ？前面我们说了有个很重要的接口 ConfigurableListableBeanFactory，它实现了 BeanFactory 下面一层的所有三个接口，我把之前的继承图再拿过来大家再仔细看一下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120653.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们可以看到 ConfigurableListableBeanFactory 只有一个实现类 DefaultListableBeanFactory，而且实现类 DefaultListableBeanFactory 还通过实现右边的 AbstractAutowireCapableBeanFactory 通吃了右路。所以结论就是，最底下这个家伙 DefaultListableBeanFactory 基本上是最牛的 BeanFactory 了，这也是为什么这边会使用这个类来实例化的原因。</p>
<blockquote>
<p>如果你想要在程序运行的时候动态往 Spring IOC 容器注册新的 bean，就会使用到这个类。那我们怎么在运行时获得这个实例呢？</p>
<p>之前我们说过 ApplicationContext 接口能获取到 AutowireCapableBeanFactory，就是最右上角那个，然后它向下转型就能得到 DefaultListableBeanFactory 了。</p>
</blockquote>
<p>在继续往下之前，我们需要先了解 BeanDefinition。<strong>我们说 BeanFactory 是 Bean 容器，那么 Bean 又是什么呢？</strong></p>
<p>这里的 BeanDefinition 就是我们所说的 Spring 的 Bean，我们自己定义的各个 Bean 其实会转换成一个个 BeanDefinition 存在于 Spring 的 BeanFactory 中。</p>
<p>所以，如果有人问你 Bean 是什么的时候，你要知道 Bean 在代码层面上可以认为是 BeanDefinition 的实例。</p>
<blockquote>
<p>BeanDefinition 中保存了我们的 Bean 信息，比如这个 Bean 指向的是哪个类、是否是单例的、是否懒加载、这个 Bean 依赖了哪些 Bean 等等。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120722.png style=display:block;width:50% alt=NAME align=center> </div>
<p>BeanDefinition 是一个接口，用于属性承载，比如 <bean> 元素标签拥有 class、scope、lazy-init 等配置。bean的定义方式有千千万万种，无论是何种标签，无论是何种资源定义，无论是何种容器，只要按照 Spring 的规范编写xml配置文件，最终的 bean 定义内部表示都将转换为内部的唯一结构：BeanDefinition。当 BeanDefinition 注册完毕以后，Spring 的 BeanFactory 就可以随时根据需要进行实例化了。</p>
<h5 id=beandefinition-接口定义>BeanDefinition 接口定义</h5>
<p>我们来看下 BeanDefinition 的接口定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanDefinition</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AttributeAccessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 我们可以看到，默认只提供 sington 和 prototype 两种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 很多读者可能知道还有 request, session, globalSession, application, websocket 这几种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 不过，它们属于基于 web 的扩展。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>SCOPE_SINGLETON</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_SINGLETON</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>String</span> <span style=color:#000>SCOPE_PROTOTYPE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_PROTOTYPE</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 比较不重要，直接跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_APPLICATION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_SUPPORT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_INFRASTRUCTURE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 设置父 Bean，这里涉及到 bean 继承，不是 java 继承。请参见附录的详细介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：继承父 Bean 的配置信息而已
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>parentName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取父 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getParentName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 Bean 的类名称，将来是要通过反射来生成实例的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanClassName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取 Bean 的类名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 bean 的 scope
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>);</span>
   
   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#000>String</span> <span style=color:#000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置是否懒加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLazyInit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInit</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 依赖的所有的 Bean，注意，这里的依赖不是指属性依赖(如 @Autowire 标记的)，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 是 depends-on=&#34;&#34; 属性设置的值。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 返回该 Bean 的所有依赖
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 是否可以注入到其他 Bean 中，只对根据类型注入有效，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果根据名称注入，即使这边设置了 false，也是可以的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireCandidate</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 该 Bean 是否可以注入到其他 Bean 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 主要的。同一接口的多个实现，如果不指定名字的话，Spring 会优先选择设置 primary 为 true 的 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPrimary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>primary</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 是否是 primary 的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrimary</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果该 Bean 采用工厂方法生成，指定工厂名称。对工厂不熟悉的读者，请参加附录
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：有些实例不是用反射生成的，而是用工厂模式生成的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 指定工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryMethodName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 构造器参数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Bean 中的属性值，后面给 bean 注入属性值的时候会说到
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 singleton
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 prototype
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrototype</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果这个 Bean 是被设置为 abstract，那么不能实例化，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 常用于作为 父bean 用于继承，其实也很少用......
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAbstract</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getRole</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>BeanDefinition</span> <span style=color:#000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>这个 BeanDefinition 其实已经包含很多的信息了，暂时不清楚所有的方法对应什么东西没关系，希望看完本文后读者可以彻底搞清楚里面的所有东西。</p>
<p>这里接口虽然那么多，但是没有类似 getInstance() 这种方法来获取我们定义的类的实例，真正的我们定义的类生成的实例到哪里去了呢？别着急，这个要很后面才能讲到。</p>
</blockquote>
<p>有了 BeanDefinition 的概念以后，我们再往下看 <code>refreshBeanFactory()</code> 方法中的剩余部分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=customizebeanfactory>customizeBeanFactory()</h4>
<p>customizeBeanFactory(beanFactory) 比较简单，就是配置是否允许 BeanDefinition 覆盖、是否允许循环引用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 定义覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 间的循环依赖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowCircularReferences</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span><span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BeanDefinition 的覆盖问题可能会有开发者碰到这个坑，就是在配置文件中定义 bean 时使用了相同的 id 或 name，默认情况下，allowBeanDefinitionOverriding 属性为 null，如果在同一配置文件中重复了，会抛错，但是如果不是同一配置文件中，会发生覆盖。</p>
<p>循环引用也很好理解：A 依赖 B，而 B 依赖 A。或 A 依赖 B，B 依赖 C，而 C 依赖 A。</p>
<p>默认情况下，Spring 允许循环依赖，当然如果你在 A 的构造方法中依赖 B，在 B 的构造方法中依赖 A 是不行的。</p>
<p>至于这两个属性怎么配置？我在附录中进行了介绍，尤其对于覆盖问题，很多人都希望禁止出现 Bean 覆盖，可是 Spring 默认是不同文件的时候可以覆盖的。</p>
<p>之后的源码中还会出现这两个属性，先有个印象就可以了。</p>
<h4 id=loadbeandefinitions加载-bean>loadBeanDefinitions()：加载 Bean</h4>
<p>接下来是最重要的 <code>loadBeanDefinitions(beanFactory)</code> 方法了，这个方法将根据配置，加载各个 Bean，然后放到 BeanFactory 中。</p>
<p>读取配置的操作在 XmlBeanDefinitionReader 中，其负责加载配置、解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 我们可以看到，此方法将通过一个 XmlBeanDefinitionReader 实例来加载各个 Bean。*/</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 给这个 BeanFactory 实例化一个 XmlBeanDefinitionReader
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>beanDefinitionReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XmlBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// Configure the bean definition reader with this context&#39;s
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// resource loading environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 初始化 BeanDefinitionReader，其实这个是提供给子类覆写的，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我看了一下，没有类覆写这个方法，我们姑且当做不重要吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 重点来了，继续往下
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在还在这个类中，接下来用刚刚初始化的 Reader 开始来加载 xml 配置，这块代码读者可以选择性跳过，不是很重要。也就是说，下面这个代码块，读者可以很轻松地略过。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigResources</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigLocations</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 上面虽然有两个分支，不过第二个分支很快通过解析路径转换为 Resource 以后也会进到这里
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Resource array must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 注意这里是个 for 循环，也就是每个文件是一个 resource
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 继续往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 最后返回 counter，表示总共加载了多少的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 303
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 314
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EncodedResource</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;EncodedResource must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading XML bean definitions from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 用一个 ThreadLocal 来存放配置文件资源
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;Detected cyclic loading of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; - check your import definitions!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEncoding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#8f5902;font-style:italic>// 核心部分是这里，往下面看
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;IOException parsing XML document from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 388 行
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这里就不看了，将 xml 文件转换为 Document 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Document</span> <span style=color:#000>doc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doLoadDocument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 继续
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 505 行
</span><span style=color:#8f5902;font-style:italic>// 返回值：返回从当前配置文件加载了多少数量的 Bean
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>BeanDefinitionDocumentReader</span> <span style=color:#000>documentReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinitionDocumentReader</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>countBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 这里
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>documentReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>createReaderContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>countBefore</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XmlReaderContext</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading bean definitions&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Element</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDocumentElement</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 从 xml 根节点开始解析文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>经过漫长的链路，一个配置文件终于转换为一颗 DOM 树了，注意，这里指的是其中一个配置文件，不是所有的，读者可以看到上面有个 for 循环的。下面开始从根节点开始解析：</p>
<h4 id=doregisterbeandefinitions>doRegisterBeanDefinitions()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 我们看名字就知道，BeanDefinitionParserDelegate 必定是一个重要的类，它负责解析 Bean 定义，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里为什么要定义一个 parent? 看到后面就知道了，是递归问题，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 因为 &lt;beans /&gt; 内部是可以定义 &lt;beans /&gt; 的，所以这个方法的 root 其实不一定就是 xml 的根节点，也可以是嵌套在里面的 &lt;beans /&gt; 节点，从源码分析的角度，我们当做根节点就好了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这块说的是根节点 &lt;beans ... profile=&#34;dev&#34; /&gt; 中的 profile 是否是当前环境需要的，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果当前环境配置的 profile 不包含此 profile，那就直接 return 了，不对此 &lt;beans /&gt; 解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 不熟悉 profile 为何物，不熟悉怎么配置 profile 读者的请移步附录区
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PROFILE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specifiedProfiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>acceptsProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specifiedProfiles</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Skipped XML bean definition file due to specified profiles [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] not matching: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>preProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>postProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>preProcessXml(root)</code> 和 <code>postProcessXml(root)</code> 是给子类用的钩子方法，鉴于没有被使用到，也不是我们的重点，我们直接跳过。</p>
<p>这里涉及到了 profile 的问题，对于不了解的读者，我在附录中对 profile 做了简单的解释，读者可以参考一下。接下来，看核心解析方法</p>
<h4 id=parsebeandefinitionsroot-thisdelegate>parseBeanDefinitions(root, this.delegate)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// default namespace 涉及到的就四个标签 &lt;import /&gt;、&lt;alias /&gt;、&lt;bean /&gt; 和 &lt;beans /&gt;，
</span><span style=color:#8f5902;font-style:italic>// 其他的属于 custom 的
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>NodeList</span> <span style=color:#000>nl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Element</span> <span style=color:#000>ele</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析 default namespace 下面的几个元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析其他 namespace 的元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码，我们可以看到，对于每个配置来说，分别进入到 <code>parseDefaultElement(ele, delegate);</code> 和 <code>delegate.parseCustomElement(ele);</code> 这两个分支了。</p>
<p><code>parseDefaultElement(ele, delegate)</code> 代表解析的节点是 <code>&lt;import /></code>、<code>&lt;alias /></code>、<code>&lt;bean /></code>、<code>&lt;beans /></code> 这几个。</p>
<blockquote>
<p>这里的四个标签之所以是 default 的，是因为它们是处于这个 namespace 下定义的：</p>
<p><a href=http://www.springframework.org/schema/beans>http://www.springframework.org/schema/beans</a></p>
<p>又到初学者科普时间，不熟悉 namespace 的读者请看下面贴出来的 xml，这里的第二行 <strong>xmlns</strong> 就是咯。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>            http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>          http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span>
       <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div><p>而对于其他的标签，将进入到 <code>delegate.parseCustomElement(element)</code> 这个分支。如我们经常会使用到的 <code>&lt;mvc /></code>、<code>&lt;task /></code>、<code>&lt;context /></code>、<code>&lt;aop /></code>等。</p>
<p>这些属于扩展，如果需要使用上面这些 ”非 default“ 标签，那么上面的 xml 头部的地方也要引入相应的 namespace 和 .xsd 文件的路径，如下所示。同时代码中需要提供相应的 parser 来解析，如 MvcNamespaceHandler、TaskNamespaceHandler、ContextNamespaceHandler、AopNamespaceHandler 等。</p>
<p>假如读者想分析 <code>&lt;context:property-placeholder location="classpath:xx.properties" /></code> 的实现原理，就应该到 ContextNamespaceHandler 中找答案。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
      <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
      <span style=color:#c4a000>xmlns:context=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/context&#34;</span>
      <span style=color:#c4a000>xmlns:mvc=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/mvc&#34;</span>
      <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans 
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans/spring-beans.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context/spring-context.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc   
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc/spring-mvc.xsd  
</span><span style=color:#4e9a06>       &#34;</span>
      <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div></blockquote>
<p>回过神来，看看处理 default 标签的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IMPORT_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;import /&gt; 标签
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>importBeanDefinitionResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ALIAS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;alias /&gt; 标签定义
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// &lt;alias name=&#34;fromName&#34; alias=&#34;toName&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processAliasRegistration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BEAN_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;bean /&gt; 标签定义，这也算是我们的重点吧
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NESTED_BEANS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果碰到的是嵌套的 &lt;beans /&gt; 标签，需要递归
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果每个标签都说，那我不吐血，你们都要吐血了。我们挑我们的重点 <code>&lt;bean /></code> 标签出来说。</p>
<h4 id=processbeandefinition-解析-bean-标签>processBeanDefinition 解析 bean 标签</h4>
<p>下面是 processBeanDefinition 解析 <code>&lt;bean /></code> 标签：</p>
<p>// DefaultBeanDefinitionDocumentReader.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点中的信息提取出来，然后封装到一个 BeanDefinitionHolder 中，细节往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 下面的几行先不要看，跳过先，跳过先，跳过先，后面会继续说的
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Register the final decorated instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// Send registration event.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继续往下看怎么解析之前，我们先看下 <code>&lt;bean /></code> 标签中可以定义哪些属性：</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>类的全限定名</td>
</tr>
<tr>
<td>name</td>
<td>可指定 id、name(用逗号、分号、空格分隔)</td>
</tr>
<tr>
<td>scope</td>
<td>作用域</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>指定构造参数</td>
</tr>
<tr>
<td>properties</td>
<td>设置属性的值</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(默认值)、byName、byType、 constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>是否懒加载(如果被非懒加载的bean依赖了那么其实也就不能懒加载了)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean 属性设置完成后，会调用这个方法</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean 销毁后的回调方法</td>
</tr>
</tbody>
</table>
<p>上面表格中的内容我想大家都非常熟悉吧，如果不熟悉，那就是你不够了解 Spring 的配置了。</p>
<p>简单地说就是像下面这样子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;exampleBean&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name1, name2, name3&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.javadoop.ExampleBean&#34;</span>
      <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;singleton&#34;</span> <span style=color:#c4a000>lazy-init=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;init&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;cleanup&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- 可以用下面三种形式指定构造参数 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;years&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- property 的几种情况 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanOne&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;ref</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;anotherExampleBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanTwo&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;yetAnotherBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;integerProperty&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>当然，除了上面举例出来的这些，还有 factory-bean、factory-method、<code>&lt;lockup-method /></code>、<code>&lt;replaced-method /></code>、<code>&lt;meta /></code>、<code>&lt;qualifier /></code> 这几个，大家是不是熟悉呢？自己检验一下自己对 Spring 中 bean 的了解程度。</p>
<p>有了以上这些知识以后，我们再继续往里看怎么解析 bean 元素，是怎么转换到 BeanDefinitionHolder 的。</p>
<p>// BeanDefinitionParserDelegate.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>String</span> <span style=color:#000>nameAttr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NAME_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

   <span style=color:#8f5902;font-style:italic>// 将 name 属性的定义按照 “逗号、分号、空格” 切分，形成一个 别名列表数组，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 当然，如果你不定义 name 属性的话，就是空的了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中简单介绍了一下 id 和 name 的配置，大家可以看一眼，有个20秒就可以了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>nameArr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameArr</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有指定id, 那么用别名列表的第一个名字作为beanName
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No XML &#39;id&#39; specified - using &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; as bean name and &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; as aliases&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>checkNameUniqueness</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 根据 &lt;bean ...&gt;...&lt;/bean&gt; 中的配置创建 BeanDefinition，然后把配置中的信息都设置到实例中,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 细节后面细说，先知道下面这行结束后，一个 BeanDefinition 实例就出来了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 到这里，整个 &lt;bean /&gt; 标签就算解析结束了，一个 BeanDefinition 就形成了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果都没有设置 id 和 name，那么此时的 beanName 就会为 null，进入下面这块代码产生
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果读者不感兴趣的话，我觉得不需要关心这块代码，对本文源码分析来说，这些东西不重要
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 按照我们的思路，这里 containingBean 是 null 的
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span>
                     <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 如果我们不定义 id 和 name，那么我们引言里的那个例子：
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   1. beanName 为：com.javadoop.example.MessageServiceImpl#0
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   2. beanClassName 为：com.javadoop.example.MessageServiceImpl
</span><span style=color:#8f5902;font-style:italic></span>
               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>

               <span style=color:#000>String</span> <span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isBeanNameInUse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#8f5902;font-style:italic>// 把 beanClassName 设置为 Bean 的别名
</span><span style=color:#8f5902;font-style:italic></span>                  <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Neither XML &#39;id&#39; nor &#39;name&#39; specified - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;using generated bean name [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliasesArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 返回 BeanDefinitionHolder
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliasesArray</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后，我们再看看怎么根据配置创建 BeanDefinition 实例的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#000>String</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 创建 BeanDefinition，然后设置类信息而已，很简单，就不贴代码了
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanDefinition 的一堆属性，这些属性定义在 AbstractBeanDefinition 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseBeanDefinitionAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDescription</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DomUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildElementValueByTagName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DESCRIPTION_ELEMENT</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>       * 下面的一堆是解析 &lt;bean&gt;......&lt;/bean&gt; 内部的子元素，
</span><span style=color:#8f5902;font-style:italic>       * 解析出来以后的信息都放到 bd 的属性中
</span><span style=color:#8f5902;font-style:italic>       */</span>

      <span style=color:#8f5902;font-style:italic>// 解析 &lt;meta /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseMetaElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;lookup-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseLookupOverrideSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;replaced-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseReplacedMethodSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 解析 &lt;constructor-arg /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseConstructorArgElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;property /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parsePropertyElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;qualifier /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseQualifierElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extractSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoClassDefFoundError</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Class that bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] depends on not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unexpected failure during bean definition parsing&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pop</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经完成了根据 <code>&lt;bean /></code> 配置创建了一个 BeanDefinitionHolder 实例。注意，是一个。</p>
<p>我们回到解析 <code>&lt;bean /></code> 的入口方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点转换为 BeanDefinitionHolder，就是上面说的一堆
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果有自定义属性的话，进行相应的解析，先忽略
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 我们把这步叫做 注册Bean 吧
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 注册完成后，发送事件，本文不展开说这个
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家再仔细看一下这块吧，我们后面就不回来说这个了。这里已经根据一个 <code>&lt;bean /></code> 标签产生了一个 BeanDefinitionHolder 的实例，这个实例里面也就是一个 BeanDefinition 的实例和它的 beanName、aliases 这三个信息，注意，我们的关注点始终在 BeanDefinition 上：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>然后我们准备注册这个 BeanDefinition，最后，把这个注册事件发送出去。</p>
<p>下面，我们开始说说注册 Bean 吧。</p>
<h3 id=注册-bean>注册 Bean</h3>
<p>// BeanDefinitionReaderUtils.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 注册这个 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 如果还有别名的话，也要根据别名全部注册一遍，不然根据别名就会找不到 Bean 了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAliases</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// alias -&gt; beanName 保存它们的别名信息，这个很简单，用一个 map 保存一下就可以了，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 获取的时候，会先将 alias 转换为 beanName，然后再查找
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>别名注册的放一边，毕竟它很简单，我们看看怎么注册 Bean。</p>
<p>// DefaultListableBeanFactory.java 793</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Bean name must not be empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;BeanDefinition must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(...);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// old? 还记得 “允许 bean 覆盖” 这个配置吗？allowBeanDefinitionOverriding
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinition</span> <span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 之后会看到，所有的 Bean 注册后会放入这个 beanDefinitionMap 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 处理重复名称的 Bean 定义的情况
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 如果不允许覆盖的话，抛异常
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()...</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用框架定义的 Bean 覆盖用户自定义的 Bean 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用新的 Bean 覆盖旧的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用同等的 Bean 覆盖旧的 Bean，这里指的是 equals 方法返回 true 的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 判断是否已经有其他的 Bean 开始初始化了.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注意，&#34;注册Bean&#34; 这个动作结束，Bean 依然还没有初始化，我们后面会有大篇幅说初始化过程，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 在 Spring 容器启动的最后，会 预初始化 所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanCreationStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Cannot modify startup-time collection elements anymore (for stable iteration)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedSingletons</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 最正常的应该是进到这个分支。
</span><span style=color:#8f5902;font-style:italic></span>
         <span style=color:#8f5902;font-style:italic>// 将 BeanDefinition 放到这个 map 中，这个 map 保存了所有的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 ArrayList，所以会按照 bean 配置的顺序保存每一个注册的 Bean 的名字
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 LinkedHashSet，代表的是手动注册的 singleton bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 注意这里是 remove 方法，到这里的 Bean 当然不是手动注册的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 手动指的是通过调用以下方法注册的 bean ：
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//     registerSingleton(String beanName, Object singletonObject)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这不是重点，解释只是为了不让大家疑惑。Spring 会在后面&#34;手动&#34;注册一些 Bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 如 &#34;environment&#34;、&#34;systemProperties&#34; 等 bean，我们自己也可以在运行时注册 Bean 到容器中的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 这个不重要，在预初始化的时候会用到，不必管它。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>frozenBeanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>resetBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>总结一下，到这里已经初始化了 Bean 容器，<code>&lt;bean /></code> 配置也相应的转换为了一个个 BeanDefinition，然后注册了各个 BeanDefinition 到注册中心，并且发送了注册事件。</p>
<blockquote>
<p>到这里是一个分水岭，前面的内容都还算比较简单，大家要清楚地知道前面都做了哪些事情。</p>
</blockquote>
<h3 id=bean-容器实例化完成后>Bean 容器实例化完成后</h3>
<p>说到这里，我们回到 refresh() 方法，我重新贴了一遍代码，看看我们说到哪了。是的，我们才说完 <code>obtainFreshBeanFactory()</code> 方法。</p>
<p>考虑到篇幅，这里开始大幅缩减掉没必要详细介绍的部分，大家直接看下面的代码中的注释就好了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
     
      <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 这块待会会展开说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 【这里需要知道 BeanFactoryPostProcessor 这个知识点，Bean 如果实现了此接口，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 那么在容器初始化以后，Spring 会负责调用里面的 postProcessBeanFactory 方法。】
</span><span style=color:#8f5902;font-style:italic></span>        
         <span style=color:#8f5902;font-style:italic>// 这里是提供给子类的扩展点，到这里的时候，所有的 Bean 都加载、注册完成了，但是都还没有初始化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这步的时候添加一些特殊的 BeanFactoryPostProcessor 的实现类或做点什么事
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 回调方法
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>          
         
          

         <span style=color:#8f5902;font-style:italic>// 注册 BeanPostProcessor 的实现类，注意看和 BeanFactoryPostProcessor 的区别
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 此接口两个方法: postProcessBeforeInitialization 和 postProcessAfterInitialization
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 两个方法分别在 Bean 初始化之前和初始化之后得到执行。这里仅仅是注册，之后会看到回调这两方法的时机
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的 MessageSource，国际化这里就不展开说了，不然没完没了了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的事件广播器，这里也不展开了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 从方法名就可以知道，典型的模板方法(钩子方法)，不展开说
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这里初始化一些特殊的 Bean（在初始化 singleton beans 之前）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 注册事件监听器，监听器需要实现 ApplicationListener 接口。这也不是我们的重点，过
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 重点，重点，重点
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 初始化所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//（lazy-init 的除外）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 最后，广播事件，ApplicationContext 初始化完成，不展开
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                  <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>

         <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 销毁已经初始化的 singleton 的 Beans，以免有些 bean 会一直占用资源
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 把异常往外抛
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=准备-bean-容器-preparebeanfactory>准备 Bean 容器: prepareBeanFactory</h3>
<p>之前我们说过，Spring 把我们在 xml 配置的 bean 都注册以后，会"手动"注册一些特殊的 bean。</p>
<p>这里简单介绍下 <code>prepareBeanFactory(factory)</code> 方法：</p>
<h3 id=preparebeanfactoryfactory>prepareBeanFactory(factory)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Configure the factory&#39;s standard context characteristics,
</span><span style=color:#8f5902;font-style:italic> * such as the context&#39;s ClassLoader and post-processors.
</span><span style=color:#8f5902;font-style:italic> * @param beanFactory the BeanFactory to configure
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，我们知道 BeanFactory 需要加载类，也就需要类加载器，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里设置为加载当前 ApplicationContext 类的类加载器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 设置 BeanExpressionResolver
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StandardBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>()));</span>

   <span style=color:#8f5902;font-style:italic>// 添加一个 BeanPostProcessor，这个 processor 比较简单：
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 实现了 Aware 接口的 beans 在初始化的时候，这个 processor 负责回调，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这个我们很常用，如我们会为了获取 ApplicationContext 而 implement ApplicationContextAware
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意：它不仅仅回调 ApplicationContextAware，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//   还会负责回调 EnvironmentAware、ResourceLoaderAware 等，看下源码就清楚了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 下面几行的意思就是，如果某个 bean 依赖于以下几个接口的实现类，在自动装配的时候忽略它们，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// Spring 会通过其他方式来处理这些依赖。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnvironmentAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageSourceAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 下面几行就是为特殊的几个 bean 赋值，如果有 bean 依赖了以下几个，会注入这边相应的值，
</span><span style=color:#8f5902;font-style:italic>    * 之前我们说过，&#34;当前 ApplicationContext 持有一个 BeanFactory&#34;，这里解释了第一行
</span><span style=color:#8f5902;font-style:italic>    * ApplicationContext 还继承了 ResourceLoader、ApplicationEventPublisher、MessageSource
</span><span style=color:#8f5902;font-style:italic>    * 所以对于这几个依赖，可以赋值为 this，注意 this 是一个 ApplicationContext
</span><span style=color:#8f5902;font-style:italic>    * 那这里怎么没看到为 MessageSource 赋值呢？那是因为 MessageSource 被注册成为了一个普通的 bean
</span><span style=color:#8f5902;font-style:italic>    */</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 这个 BeanPostProcessor 也很简单，在 bean 实例化后，如果是 ApplicationListener 的子类，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 那么将其添加到 listener 列表中，可以理解成：注册 事件监听器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationListenerDetector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 这里涉及到特殊的 bean，名为：loadTimeWeaver，这不是我们的重点，忽略它
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// tips: ltw 是 AspectJ 的概念，指的是在运行期进行织入，这个和 Spring AOP 不一样，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//    感兴趣的读者请参考我写的关于 AspectJ 的另一篇文章 https://www.javadoop.com/post/aspectj
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOAD_TIME_WEAVER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// Set a temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextTypeMatchClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 从下面几行代码我们可以知道，Spring 往往很 &#34;智能&#34; 就是因为它会帮我们默认注册一些有用的 bean，
</span><span style=color:#8f5902;font-style:italic>    * 我们也可以选择覆盖
</span><span style=color:#8f5902;font-style:italic>    */</span>

   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;environment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemProperties&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemEnvironment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面这块代码中，Spring 对一些特殊的 bean 进行了处理，读者如果暂时还不能消化它们也没有关系，慢慢往下看。</p>
<h3 id=初始化所有的-singleton-beans>初始化所有的 singleton beans</h3>
<p>我们的重点当然是 <code>finishBeanFactoryInitialization(beanFactory);</code> 这个巨头了，这里会负责初始化所有的 singleton beans。</p>
<p>注意，后面的描述中，我都会使用<strong>初始化</strong>或<strong>预初始化</strong>来代表这个阶段，Spring 会在这个阶段完成所有的 singleton beans 的实例化。</p>
<p>我们来总结一下，到目前为止，应该说 BeanFactory 已经创建完成，并且所有的实现了 BeanFactoryPostProcessor 接口的 Bean 都已经初始化并且其中的 postProcessBeanFactory(factory) 方法已经得到回调执行了。而且 Spring 已经“手动”注册了一些特殊的 Bean，如 ‘environment’、‘systemProperties’ 等。</p>
<p>剩下的就是初始化 singleton beans 了，我们知道它们是单例的，如果没有设置懒加载，那么 Spring 会在接下来初始化所有的 singleton beans。</p>
<p>// AbstractApplicationContext.java 834</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 初始化剩余的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 首先，初始化名字为 conversionService 的 Bean。本着送佛送到西的精神，我在附录中简单介绍了一下 ConversionService，因为这实在太实用了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 什么，看代码这里没有初始化 Bean 啊！
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意了，初始化的动作包装在 beanFactory.getBean(...) 中，这里先不说细节，先往下看吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConversionService</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register a default embedded value resolver if no bean post-processor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// (such as a PropertyPlaceholderConfigurer bean) registered any before:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// at this point, primarily for resolution in annotation attribute values.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringValueResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>resolveStringValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolvePlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 先初始化 LoadTimeWeaverAware 类型的 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 之前也说过，这是 AspectJ 相关的内容，放心跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>weaverAwareNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoadTimeWeaverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>weaverAwareName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>weaverAwareNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weaverAwareName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Stop using the temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 没什么别的目的，因为到这一步的时候，Spring 已经开始预初始化 singleton beans 了，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 肯定不希望这个时候还出现 bean 定义解析、加载、注册。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>freezeConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 开始初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面最后一行往里看，我们就又回到 DefaultListableBeanFactory 这个类了，这个类大家应该都不陌生了吧。</p>
<p>// DefaultListableBeanFactory.java 728</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pre-instantiating singletons in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// this.beanDefinitionNames 保存了所有的 beanNames
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 触发所有的非懒加载的 singleton beans 的初始化操作
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 合并父 Bean 中的配置，注意 &lt;bean id=&#34;&#34; class=&#34;&#34; parent=&#34;&#34; /&gt; 中的 parent，用的不多吧，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 考虑到这可能会影响大家的理解，我在附录中解释了一下 &#34;Bean 继承&#34;，不了解的请到附录中看一下
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 非抽象、非懒加载的 singletons。如果配置了 &#39;abstract = true&#39;，那是不需要初始化的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 处理 FactoryBean(读者如果不熟悉 FactoryBean，请移步附录区了解)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// FactoryBean 的话，在 beanName 前面加上 ‘&amp;’ 符号。再调用 getBean，getBean 方法别急
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FACTORY_BEAN_PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 判断当前 FactoryBean 是否是 SmartFactoryBean 的实现，此处忽略，直接跳过
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#5c35cc;font-weight:700>@Override</span>
                  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 对于普通的 Bean，只要调用 getBean(beanName) 这个方法就可以进行初始化了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>


   <span style=color:#8f5902;font-style:italic>// 到这里说明所有的非懒加载的 singleton beans 已经完成了初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果我们定义的 bean 是实现了 SmartInitializingSingleton 接口的，那么在这里得到回调，忽略
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>singletonInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SmartInitializingSingleton</span> <span style=color:#000>smartSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>singletonInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#5c35cc;font-weight:700>@Override</span>
               <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，我们就进入到 getBean(beanName) 方法了，这个方法我们经常用来从 BeanFactory 中获取一个 Bean，而初始化的过程也封装到了这个方法里。</p>
<h2 id=获取-bean>获取 Bean</h2>
<p>容器和 Bean 已经准备好了，接着就是获取 Bean 去使用了。</p>
<h3 id=俯瞰-getbeanstring-源码>俯瞰 getBean(String) 源码</h3>
<p>在本小节，我们先从战略上俯瞰 getBean(String) 方法的实现源码。代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// getBean 是一个空壳方法，所有的逻辑都封装在 doGetBean 方法中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 通过 name 获取 beanName。这里不使用 name 直接作为 beanName 有两点原因：
</span><span style=color:#8f5902;font-style:italic>     * 1. name 可能会以 &amp; 字符开头，表明调用者想获取 FactoryBean 本身，而非 FactoryBean 
</span><span style=color:#8f5902;font-style:italic>     *    实现类所创建的 bean。在 BeanFactory 中，FactoryBean 的实现类和其他的 bean 存储
</span><span style=color:#8f5902;font-style:italic>     *    方式是一致的，即 &lt;beanName, bean&gt;，beanName 中是没有 &amp; 这个字符的。所以我们需要
</span><span style=color:#8f5902;font-style:italic>     *    将 name 的首字符 &amp; 移除，这样才能从缓存里取到 FactoryBean 实例。
</span><span style=color:#8f5902;font-style:italic>     * 2. 若 name 是一个别名，则应将别名转换为具体的实例名，也就是 beanName。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 注意跟着这个，这个是返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 从缓存中获取单例 bean。Spring 是使用 Map 作为 beanName 和 bean 实例的缓存的，所以这
</span><span style=color:#8f5902;font-style:italic>     * 里暂时可以把 getSingleton(beanName) 等价于 beanMap.get(beanName)。当然，实际的
</span><span style=color:#8f5902;font-style:italic>     * 逻辑并非如此简单，后面再细说。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。
</span><span style=color:#8f5902;font-style:italic>     * BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取 
</span><span style=color:#8f5902;font-style:italic>     * bean 时再实例化，也就是懒加载。
</span><span style=color:#8f5902;font-style:italic>     * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取
</span><span style=color:#8f5902;font-style:italic>     * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数
</span><span style=color:#8f5902;font-style:italic>     * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有
</span><span style=color:#8f5902;font-style:italic>     * 用了，BeanFactory 不会多次实例化单例 bean。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果 
</span><span style=color:#8f5902;font-style:italic>         * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的 
</span><span style=color:#8f5902;font-style:italic>         * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回
</span><span style=color:#8f5902;font-style:italic>         * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean 
</span><span style=color:#8f5902;font-style:italic>     * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例
</span><span style=color:#8f5902;font-style:italic>     * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 如果 sharedInstance = null，则到父容器中查找 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 name 对应的 beanName，如果 name 是以 &amp; 字符开头，则返回 &amp; + beanName
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 根据 args 是否为空，以决定调用父容器哪个方法获取 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 返回父容器的查询结果
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> 
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

       <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>       * 稍稍总结一下：
</span><span style=color:#8f5902;font-style:italic>       * 到这里的话，要准备创建 Bean 了，对于 singleton 的 Bean 来说，容器中还没创建过此 Bean；
</span><span style=color:#8f5902;font-style:italic>       * 对于 prototype 的 Bean 来说，本来就是要创建一个新的 Bean。
</span><span style=color:#8f5902;font-style:italic>       */</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并父 BeanDefinition 与子 BeanDefinition，后面会单独分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，
</span><span style=color:#8f5902;font-style:italic>                     * B 又依赖 A，他们的配置如下：
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanA&#34; class=&#34;BeanA&#34; depends-on=&#34;beanB&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanB&#34; class=&#34;BeanB&#34; depends-on=&#34;beanA&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   
</span><span style=color:#8f5902;font-style:italic>                     * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它
</span><span style=color:#8f5902;font-style:italic>                     * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接
</span><span style=color:#8f5902;font-style:italic>                     * 抛出异常
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; and &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 注册依赖记录
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 先初始化被依赖项 加载 depends-on 依赖 
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> 
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过 
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法会在内部调用 
</span><span style=color:#8f5902;font-style:italic>                 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，
</span><span style=color:#8f5902;font-style:italic>                 * 将 bean 放入缓存中。关于 getSingleton 方法的分析，本文先不展开，我会在
</span><span style=color:#8f5902;font-style:italic>                 * 后面的文章中进行分析
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
                <span style=color:#8f5902;font-style:italic>// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 prototype 类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建其他类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@Override</span>
                        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Scope &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 如果需要进行类型转换，则在此处进行转换。类型转换这一块我没细看，就不多说了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQualifiedName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=createbean>createBean</h3>
<p>大家应该也猜到了，接下来当然是分析 createBean 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>第三个参数 args 数组代表创建实例需要的参数，不就是给构造方法用的参数，或者是工厂 Bean 的参数嘛，不过要注意，在我们的初始化阶段，args 是 null。</p>
<p>这回我们要到一个新的类了 AbstractAutowireCapableBeanFactory，看类名，AutowireCapable？类名是不是也说明了点问题了。</p>
<p>主要是为了以下场景，采用 @Autowired 注解注入属性值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserService</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;messageService&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;com.example.MessageServiceImpl&#34;</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</code></pre></div><p>以上这种属于混用了 xml 和 注解 两种方式的配置方式，Spring 会处理这种情况。</p>
<p>好了，读者要知道这么回事就可以了，继续向前。</p>
<p>// AbstractAutowireCapableBeanFactory.java 447</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Central method of this class: creates a bean instance,
</span><span style=color:#8f5902;font-style:italic> * populates the bean instance, applies post-processors, etc.
</span><span style=color:#8f5902;font-style:italic> * @see #doCreateBean
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 确保 BeanDefinition 中的 Class 被加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 准备方法覆写，这里又涉及到一个概念：MethodOverrides，它来自于 bean 定义中的 &lt;lookup-method /&gt; 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 和 &lt;replaced-method /&gt;，如果读者感兴趣，回到 bean 解析的地方看看对这两个标签的解析。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中也对这两个标签的相关知识点进行了介绍，读者可以移步去看看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Validation of method overrides failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 让 InstantiationAwareBeanPostProcessor 在这一步有机会返回代理，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span> 
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 重头戏，创建 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finished creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们继续往里看 doCreateBean 这个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// Instantiate the bean.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanInstanceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 说明不是 FactoryBean，这里实例化 Bean，这里非常关键，细节之后再说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 这个就是 Bean 里面的 我们定义的类 的实例，很多地方我直接描述成 &#34;bean 实例&#34;
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 类型
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedTargetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 建议跳过吧，涉及接口：MergedBeanDefinitionPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// MergedBeanDefinitionPostProcessor，这个我真不展开说了，直接跳过吧，很少用的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                  <span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Eagerly cache singletons to be able to resolve circular references
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// even when triggered by lifecycle interfaces like BeanFactoryAware.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 下面这块代码是为了解决循环依赖的问题
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize the bean instance.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这一步也是非常关键的，这一步负责属性装配，因为前面的实例只是实例化了，并没有设值，这里就是设值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 还记得 init-method 吗？还有 InitializingBean 接口？还有 BeanPostProcessor 接口？
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这里就是处理 bean 初始化完成后的各种回调
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowRawInjectionDespiteWrapping</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#4e9a06>&#34;Bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collectionToCommaDelimitedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register bean as disposable.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经分析完了 doCreateBean 方法，总的来说，我们已经说完了整个初始化流程。</p>
<p>接下来我们挑 doCreateBean 中的三个细节出来说说。</p>
<p>一个是创建 Bean 实例的 createBeanInstance 方法，一个是依赖注入的 populateBean 方法，还有就是回调方法 initializeBean。</p>
<p>注意了，接下来的这三个方法要认真说那也是极其复杂的，很多地方我就点到为止了，感兴趣的读者可以自己往里看，最好就是碰到不懂的，自己写代码去调试它。</p>
<h4 id=创建-bean-实例>创建 Bean 实例</h4>
<p>我们先看看 createBeanInstance 方法。需要说明的是，这个方法如果每个分支都分析下去，必然也是极其复杂冗长的，我们挑重点说。此方法的目的就是实例化我们指定的类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 确保已经加载了此 class
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 校验一下这个类的访问权限
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;Bean class isn&#39;t public, and non-public access not allowed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 采用工厂方法实例化，不熟悉这个概念的读者请看附录，注意，不是 FactoryBean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateUsingFactoryMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 如果不是第一次创建，比如第二次创建 prototype bean。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这种情况下，我们可以从第一次创建知道，采用无参构造函数，还是构造函数依赖注入 来完成实例化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowireNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 判断是否采用有参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineConstructorsFromBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 调用无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>挑个简单的<strong>无参构造函数</strong>构造实例来看看：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 实例化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 包装一下，返回
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到，关键的地方在于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里会进行实际的实例化过程，我们进去看看:</p>
<p>// SimpleInstantiationStrategy 59</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 如果不存在方法覆写，那就使用 java 反射进行实例化，否则使用 CGLIB,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 方法覆写 请参见附录&#34;方法注入&#34;中对 lookup-method 和 replaced-method 的介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Specified class is an interface&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#5c35cc;font-weight:700>@Override</span>
                     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                     <span style=color:#ce5c00;font-weight:700>}</span>
                  <span style=color:#ce5c00;font-weight:700>});</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No default constructor found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 利用构造方法进行实例化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存在方法覆写，利用 CGLIB 来完成实例化，需要依赖于 CGLIB 生成子类，这里就不展开了。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// tips: 因为如果不使用 CGLIB 的话，存在 override 的情况 JDK 并没有提供相应的实例化支持
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateWithMethodInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们就算实例化完成了。我们开始说怎么进行属性注入。</p>
<h4 id=bean-属性注入>bean 属性注入</h4>
<p>看完了 createBeanInstance(&mldr;) 方法，我们来看看 populateBean(&mldr;) 方法，该方法负责进行属性设值，处理依赖。</p>
<p>// AbstractAutowireCapableBeanFactory 1203</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// bean 实例的所有属性都在这里了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Cannot apply property values to null instance&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Skip property population phase for null instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 到这步的时候，bean 实例化完成（通过工厂方法或构造方法），但是还没开始属性设值，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// InstantiationAwareBeanPostProcessor 的实现类可以在这里对 bean 进行状态修改，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我也没找到有实际的使用，所以我们暂且忽略这块吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 如果返回 false，代表不需要进行后续的属性设值，也不需要再经过其他的 BeanPostProcessor 的处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>continueWithPropertyPopulation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>newPvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 通过名字找到所有属性值，如果是 bean 依赖，先初始化依赖的 bean。记录依赖关系
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// 通过类型装配。复杂一些
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsDepCheck</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyCheck</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPENDENCY_CHECK_NONE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredPds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>filterPropertyDescriptorsForDependencyCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCaching</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#8f5902;font-style:italic>// 这里有个非常有用的 BeanPostProcessor 进到这里: AutowiredAnnotationBeanPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>// 对采用 @Autowired、@Value 注解的依赖进行设值，这里的内容也是非常丰富的，不过本文不会展开说了，感兴趣的读者请自行研究
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>checkDependencies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 设置 bean 实例的属性值
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=initializebean>initializeBean</h4>
<p>属性注入完成后，这一步其实就是处理各种回调了，这块代码比较简单。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果 bean 实现了 BeanNameAware、BeanClassLoaderAware 或 BeanFactoryAware 接口，回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>Object</span> <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessBeforeInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 bean 中定义的 init-method，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 或者如果 bean 实现了 InitializingBean 接口，调用 afterPropertiesSet() 方法
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invocation of init method failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessAfterInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家发现没有，BeanPostProcessor 的两个回调都发生在这边，只不过中间处理了 init-method，是不是和读者原来的认知有点不一样了？</p>
<h2 id=相关疑问>相关疑问</h2>
<h4 id=spring-的-bean-在什么时候实例化>Spring 的 bean 在什么时候实例化?</h4>
<p>如果你使用BeanFactory，如 XmlBeanFactory 作为 Spring Bean 的工厂类，则所有的 bean 都是在第一次使用该bean 的时候实例化 。</p>
<p>如果你使用 ApplicationContext 作为 Spring Bean 的工厂类，则又分为以下几种情况：</p>
<ol>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 false（默认是false，所以可以不用设置），则ApplicationContext 启动的时候就实例化该 bean，并且将实例化的 bean 放在一个线程安全的 ConcurrentHashMap 结构的缓存中，下次再使用该 Bean 的时候，直接从这个缓存中取</li>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 true，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化</li>
<li>如果 bean 的 scope 是 prototype 的，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化 。</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7f4178b3d93842e955c6e1949a1a8205>1.5 - CH05-循环依赖</h1>
<h2 id=创建过程>创建过程</h2>
<p>Java 对象的创建步骤很多，可以 <code>new XXX</code>、序列化、<code>clone()</code> 等等， 只是 Spring 是通过反射 + 工厂的方式创建对象并放在容器的，创建好的对象我们一般还会对对象属性进行赋值，才去使用，可以理解是分了两个步骤。</p>
<h2 id=什么是循环依赖>什么是循环依赖</h2>
<p>所谓的循环依赖是指，A 依赖 B，B 又依赖 A，它们之间形成了循环依赖。或者是 A 依赖 B，B 依赖 C，C 又依赖 A，形成了循环依赖。更或者是自己依赖自己。它们之间的依赖关系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134049.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这里以两个类直接相互依赖为例，他们的实现代码可能如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanB</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanA</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanB</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置信息如下（用注解方式注入同理，只是为了方便理解，用了配置文件）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanA&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanB&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>Spring 启动后，读取如上的配置文件，会按顺序先实例化 A，但是创建的时候又发现它依赖了 B，接着就去实例化 B ，同样又发现它依赖了 A ，这尼玛咋整？无限循环呀</p>
<p>Spring “肯定”不会让这种事情发生的，如前言我们说的 Spring 实例化对象分两步，第一步会先创建一个原始对象，只是没有设置属性，可以理解为"半成品"—— 官方叫 A 对象的早期引用（EarlyBeanReference），所以当实例化 B 的时候发现依赖了 A， B 就会把这个“半成品”设置进去先完成实例化，既然 B 完成了实例化，所以 A 就可以获得 B 的引用，也完成实例化了，这其实就是 Spring 解决循环依赖的思想。</p>
<h2 id=源码实现>源码实现</h2>
<p>在 Spring IOC 容器读取 Bean 配置创建 Bean 实例之前, 必须对它进行实例化。只有在容器实例化后，才可以从 IOC 容器里获取 Bean 实例并使用，循环依赖问题也就是发生在实例化 Bean 的过程中的，所以我们先回顾下获取 Bean 的过程。</p>
<h3 id=获取-bean-流程>获取 Bean 流程</h3>
<p>Spring IOC 容器中获取 bean 实例的简化版流程如下（排除了各种包装和检查的过程）</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134307.png style=display:block;width:50% alt=NAME align=center> </div>
<p>大概的流程顺序：</p>
<ol>
<li>流程从 <code>getBean</code> 方法开始，<code>getBean</code> 是个空壳方法，所有逻辑直接到 <code>doGetBean</code> 方法中</li>
<li><code>transformedBeanName</code> 将 name 转换为真正的 beanName（name 可能是 FactoryBean 以 & 字符开头或者有别名的情况，所以需要转化下）</li>
<li>然后通过 <code>getSingleton(beanName)</code> 方法尝试从缓存中查找是不是有该实例 sharedInstance（单例在 Spring 的同一容器只会被创建一次，后续再获取 bean，就直接从缓存获取即可）</li>
<li>如果有的话，sharedInstance 可能是完全实例化好的 bean，也可能是一个原始的 bean，所以再经 <code>getObjectForBeanInstance</code> 处理即可返回</li>
<li>当然 sharedInstance 也可能是 null，这时候就会执行创建 bean 的逻辑，将结果返回</li>
</ol>
<p>第三步的时候我们提到了一个缓存的概念，这个就是 Spring 为了解决单例的循环依赖问题而设计的 <strong>三级缓存</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** Cache of singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>singletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>256</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>singletonFactories</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of early singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>earlySingletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这三级缓存的作用分别是：</p>
<ul>
<li><code>singletonObjects</code>：完成初始化的单例对象的 cache，这里的 bean 经历过 <code>实例化->属性填充->初始化</code> 以及各种后置处理（一级缓存）</li>
<li><code>earlySingletonObjects</code>：存放原始的 bean 对象（<strong>完成实例化但是尚未填充属性和初始化</strong>），仅仅能作为指针提前曝光，被其他 bean 所引用，用于解决循环依赖的 （二级缓存）</li>
<li><code>singletonFactories</code>：在 bean 实例化完之后，属性填充以及初始化之前，如果允许提前曝光，Spring 会将实例化后的 bean 提前曝光，也就是把该 bean 转换成 <code>beanFactory</code> 并加入到 <code>singletonFactories</code>（三级缓存）</li>
</ul>
<p>我们首先从缓存中试着获取 bean，就是从这三级缓存中查找：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从 singletonObjects 获取实例，singletonObjects 中的实例都是准备好的 bean 实例，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//isSingletonCurrentlyInCreation() 判断当前单例bean是否正在创建中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 一级缓存没有，就去二级缓存找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 二级缓存也没有，就去三级缓存找
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 三级缓存有的话，就把他移动到二级缓存,.getObject() 后续会讲到
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果缓存没有的话，我们就要创建了，接着我们以单例对象为例，再看下创建 bean 的逻辑（大括号表示内部类调用方法）：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134749.png style=display:block;width:50% alt=NAME align=center> </div>
<ol>
<li>
<p>创建 bean 从以下代码开始，一个匿名内部类方法参数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>getSingleton()</code> 方法内部主要有两个方法</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建 singletonObject
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 将 singletonObject 放入缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p><code>getObject()</code> 匿名内部类的实现真正调用的又是 <code>createBean(beanName, mbd, args)</code></p>
</li>
<li>
<p>往里走，主要的实现逻辑在 <code>doCreateBean</code>方法，先通过 <code>createBeanInstance</code> 创建一个原始 bean 对象</p>
</li>
<li>
<p>接着 <code>addSingletonFactory</code> 添加 bean 工厂对象到 singletonFactories 缓存（三级缓存）</p>
</li>
<li>
<p>通过 <code>populateBean</code> 方法向原始 bean 对象中填充属性，并解析依赖，假设这时候创建 A 之后填充属性时发现依赖 B，然后创建依赖对象 B 的时候又发现依赖 A，还是同样的流程，又去 <code>getBean(A)</code>，这个时候三级缓存已经有了 beanA 的“半成品”，这时就可以把 A 对象的原始引用注入 B 对象（并将其移动到二级缓存）来解决循环依赖问题。这时候 <code>getObject()</code> 方法就算执行结束了，返回完全实例化的 bean</p>
</li>
<li>
<p>最后调用 <code>addSingleton</code> 把完全实例化好的 bean 对象放入 singletonObjects 缓存（一级缓存）中</p>
</li>
</ol>
<h2 id=spring-解决循环依赖>Spring 解决循环依赖</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134858.png style=display:block;width:50% alt=NAME align=center> </div>
<p>流程其实上边都已经说过了，结合着上图我们再看下具体细节，用大白话再捋一捋：</p>
<ol>
<li>Spring 创建 bean 主要分为两个步骤，创建原始 bean 对象，接着去填充对象属性和初始化</li>
<li>每次创建 bean 之前，我们都会从缓存中查下有没有该 bean，因为是单例，只能有一个</li>
<li>当我们创建 beanA 的原始对象后，并把它放到三级缓存中，接下来就该填充对象属性了，这时候发现依赖了 beanB，接着就又去创建 beanB，同样的流程，创建完 beanB 填充属性时又发现它依赖了 beanA，又是同样的流程，不同的是，这时候可以在三级缓存中查到刚放进去的原始对象 beanA，所以不需要继续创建，用它注入 beanB，完成 beanB 的创建</li>
<li>既然 beanB 创建好了，所以 beanA 就可以完成填充属性的步骤了，接着执行剩下的逻辑，闭环完成</li>
</ol>
<p>但是为什么需要三级缓存，二级缓存不够用吗？</p>
<p>跟源码的时候，发现在创建 beanB 需要引用 beanA 这个“半成品”的时候，就会触发"前期引用"，即如下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 三级缓存有的话，就把他移动到二级缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>singletonFactory.getObject()</code> 是一个接口方法，这里具体的实现方法在</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 这么一大段就这句话是核心，也就是当bean要进行提前曝光时，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 给一个机会，通过重写后置处理器的getEarlyBeanReference方法，来自定义操作bean
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 值得注意的是，如果提前曝光了，但是没有被提前引用，则该后置处理器并不生效!!!
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 这也正式三级缓存存在的意义，否则二级缓存就可以解决循环依赖的问题
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>它的目的是为了后置处理，如果没有 AOP 后置处理，就不会走进 if 语句，直接返回了 exposedObject ，相当于啥都没干，二级缓存就够用了。</p>
<p>所以又得出结论，这个三级缓存应该和 AOP 有关系，继续。</p>
<p>在 Spring 的源码中<code>getEarlyBeanReference</code> 是 <code>SmartInstantiationAwareBeanPostProcessor</code> 接口的默认方法，真正实现这个方法的只有**<code>AbstractAutoProxyCreator</code>** 这个类，用于提前曝光的 AOP 代理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyProxyReferences</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 对bean进行提前Spring AOP代理
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这么说有点干，来个小 demo 吧，我们都知道 <strong>Spring AOP、事务</strong>等都是通过代理对象来实现的，而<strong>事务</strong>的代理对象是由自动代理创建器来自动完成的。也就是说 Spring 最终给我们放进容器里面的是一个代理对象，<strong>而非原始对象</strong>，假设我们有如下一段业务代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>HelloService</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#5c35cc;font-weight:700>@Autowired</span>
   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HelloService</span> <span style=color:#000>helloService</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#5c35cc;font-weight:700>@Override</span>
   <span style=color:#5c35cc;font-weight:700>@Transactional</span>
   <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Hello JavaKeeper&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此 <code>Service</code> 类使用到了事务，所以最终会生成一个 JDK 动态代理对象 <code>Proxy</code>。刚好它又存在<strong>自己引用自己</strong>的循环依赖，完美符合我们的场景需求。</p>
<p>我们再自定义一个后置处理，来看下效果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;提前曝光了：&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，调用方法栈中有我们自己实现的 <code>HelloProcessor</code>，说明这个 bean 会通过 AOP 代理处理。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503135143.png style=display:block;width:50% alt=NAME align=center> </div>
<p>再从源码看下这个自己循环自己的 bean 的创建流程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>){</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
	
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 需要提前暴露（支持循环依赖），就注册一个ObjectFactory到三级缓存
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#8f5902;font-style:italic>// 添加 bean 工厂对象到 singletonFactories 缓存中，并获取原始对象的早期引用
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//匿名内部方法 getEarlyBeanReference 就是后置处理器	
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// SmartInstantiationAwareBeanPostProcessor 的一个方法，
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 它的功效为：保证自己被循环依赖的时候，即使被别的Bean @Autowire进去的也是代理对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// 此处注意：如果此处自己被循环依赖了  那它会走上面的getEarlyBeanReference，从而创建一个代理对象从		三级缓存转移到二级缓存里
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// 注意此时候对象还在二级缓存里，并没有在一级缓存。并且此时后续的这两步操作还是用的 exposedObject，它仍旧是原始对象~~~
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// 因为事务的AOP自动代理创建器在getEarlyBeanReference 创建代理后，initializeBean 就不会再重复创建了，二选一的）
</span><span style=color:#8f5902;font-style:italic></span>    	
	<span style=color:#8f5902;font-style:italic>// 所以经过这两大步后，exposedObject 还是原始对象，通过 getEarlyBeanReference 创建的代理对象还在三级缓存呢
</span><span style=color:#8f5902;font-style:italic></span>	
	<span style=color:#ce5c00;font-weight:700>...</span>
	
	<span style=color:#8f5902;font-style:italic>// 循环依赖校验
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 注意此处第二个参数传的false，表示不去三级缓存里再去调用一次getObject()方法了~~~，此时代理对象还在二级缓存，所以这里拿出来的就是个 代理对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 最后赋值给exposedObject  然后return出去，进而最终被addSingleton()添加进一级缓存里面去  
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 这样就保证了我们容器里 最终实际上是代理对象，而非原始对象~~~~~
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
				<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>...</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=非单例循环依赖>非单例循环依赖</h3>
<p>看完了单例模式的循环依赖，我们再看下非单例的情况，假设我们的配置文件是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanA&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanB&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>启动 Spring，结果如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span> <span style=color:#000>defined</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>path</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xml</span><span style=color:#ce5c00;font-weight:700>]:</span> <span style=color:#000>Cannot</span> <span style=color:#000>resolve</span> <span style=color:#000>reference</span> <span style=color:#000>to</span> <span style=color:#000>bean</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000>setting</span> <span style=color:#000>bean</span> <span style=color:#000>property</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span> <span style=color:#000>defined</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>path</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xml</span><span style=color:#ce5c00;font-weight:700>]:</span> <span style=color:#000>Cannot</span> <span style=color:#000>resolve</span> <span style=color:#000>reference</span> <span style=color:#000>to</span> <span style=color:#000>bean</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000>setting</span> <span style=color:#000>bean</span> <span style=color:#000>property</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>Caused</span> <span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Requested</span> <span style=color:#000>bean</span> <span style=color:#000>is</span> <span style=color:#000>currently</span> <span style=color:#000>in</span> <span style=color:#000>creation</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Is</span> <span style=color:#000>there</span> <span style=color:#000>an</span> <span style=color:#000>unresolvable</span> <span style=color:#000>circular</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>?</span>
</code></pre></div><p>对于 <code>prototype</code> 作用域的 bean，Spring 容器无法完成依赖注入，因为 Spring 容器不进行缓存 <code>prototype</code> 作用域的 bean ，因此无法提前暴露一个创建中的bean 。</p>
<p>原因也挺好理解的，原型模式每次请求都会创建一个实例对象，即使加了缓存，循环引用太多的话，就比较麻烦了就，所以 Spring 不支持这种方式，直接抛出异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=构造器循环依赖>构造器循环依赖</h3>
<p>如果您主要使用构造器注入，循环依赖场景是无法解决的。建议你用 setter 注入方式代替构造器注入</p>
<p>其实也不是说只要是构造器注入就会有循环依赖问题，Spring 在创建 Bean 的时候默认是<strong>按照自然排序来进行创建的</strong>，我们暂且把先创建的 bean 叫主 bean，上文的 A 即主 bean，<strong>只要主 bean 注入依赖 bean 的方式是 setter 方式，依赖 bean 的注入方式无所谓，都可以解决，反之亦然</strong></p>
<p>所以上文我们 AB 循环依赖问题，只要 A 的注入方式是 setter ，就不会有循环依赖问题。</p>
<blockquote>
<p><strong>Spring 解决循环依赖依靠的是 Bean 的“中间态”这个概念，而这个中间态指的是已经实例化，但还没初始化的状态。实例化的过程又是通过构造器创建的，如果 A 还没创建好出来，怎么可能提前曝光，所以构造器的循环依赖无法解决，我一直认为应该先有鸡才能有蛋</strong>。</p>
</blockquote>
<h2 id=总结>总结</h2>
<h4 id=b-中提前注入了一个没有经过初始化的-a-类型对象不会有问题吗>B 中提前注入了一个没有经过初始化的 A 类型对象不会有问题吗？</h4>
<p>虽然在创建 B 时会提前给 B 注入了一个还未初始化的 A 对象，但是在创建 A 的流程中一直使用的是注入到 B 中的 A 对象的引用，之后会根据这个引用对 A 进行初始化，所以这是没有问题的。</p>
<h4 id=spring-是如何解决的循环依赖>Spring 是如何解决的循环依赖？</h4>
<p>Spring 为了解决单例的循环依赖问题，使用了三级缓存。其中一级缓存为单例池（<code>singletonObjects</code>），二级缓存为提前曝光对象（<code>earlySingletonObjects</code>），三级缓存为提前曝光对象工厂（<code>singletonFactories</code>）。</p>
<p>假设A、B循环引用，实例化 A 的时候就将其放入三级缓存中，接着填充属性的时候，发现依赖了 B，同样的流程也是实例化后放入三级缓存，接着去填充属性时又发现自己依赖 A，这时候从缓存中查找到早期暴露的 A，没有 AOP 代理的话，直接将 A 的原始对象注入 B，完成 B 的初始化后，进行属性填充和初始化，这时候 B 完成后，就去完成剩下的 A 的步骤，如果有 AOP 代理，就进行 AOP 处理获取代理后的对象 A，注入 B，走剩下的流程。</p>
<h4 id=为什么要使用三级缓存呢二级缓存能解决循环依赖吗>为什么要使用三级缓存呢？二级缓存能解决循环依赖吗？</h4>
<p>如果没有 AOP 代理，二级缓存可以解决问题，但是有 AOP 代理的情况下，只用二级缓存就意味着所有 Bean 在实例化后就要完成 AOP 代理，这样违背了 Spring 设计的原则，Spring 在设计之初就是通过 <code>AnnotationAwareAspectJAutoProxyCreator</code> 这个后置处理器来在 Bean 生命周期的最后一步来完成 AOP 代理，而不是在实例化后就立马进行 AOP 代理。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4cea3cc2683c0ae92393e6cee8ea20fa>1.6 - CH06-AOP</h1>
<p>/AOP的实现机制.pdf</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c1e8f2365fc6e91852aa984062de81f7>2 - Hikari</h1>
<p>Hikari 读作 <strong>Hi-ka-li</strong>。</p>
</div>
<div class=td-content>
<h1 id=pg-4044b0e6448e84d3abca221838625d38>2.1 - 基本概念</h1>
<h2 id=定义>定义</h2>
<ul>
<li>数据库连接池负责分配、管理和释放数据库连接，它允许应用程序重复使用一个现有的数据库连接，而不是重新建立一个；</li>
<li>释放空闲时间超过最大空闲时间的数据库连接，来避免因为没有释放数据库连接而引起的数据库连接遗漏。</li>
</ul>
<h2 id=传统过程>传统过程</h2>
<p>经典的 JDBC 连接数据库的大致步骤：</p>
<ul>
<li>加载 JDBC 驱动</li>
<li>创建数据库连接</li>
<li>创建 preparedStatement</li>
<li>执行 SQL 语句</li>
<li>遍历结果</li>
<li>关闭数据库连接</li>
</ul>
<p>在网络层面，以访问 MySQL 为例，执行一个 SQL 语句的完整 TCP 流程包括：</p>
<ul>
<li>TCP 三次握手建立连接</li>
<li>MySQL 三次握手认证</li>
<li>SQL 语句执行</li>
<li>MySQL 关闭</li>
<li>TCP 四次挥手关闭连接</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210711223145.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=存在问题>存在问题</h2>
<p>这种传统连接方式的问题有：</p>
<ul>
<li>创建和关闭连接的过程比较耗时，并发时系统会变得卡顿。</li>
<li>数据库同时支持的连接数有限，如果并发量很大，数据库的连接数则会被耗尽，增加了数据库负载，新的数据库连接请求将会失败。
<ul>
<li>这会极大的浪费数据库资源，极易造成数据库服务内存溢出、宕机。</li>
</ul>
</li>
<li>为了执行一条 SQL，却产生了很多我们并不关心的网络 IO。</li>
<li>应用如果频繁的创建和关闭连接，会导致 JVM 临时对象较多，GC 频繁。</li>
<li>频繁关闭连接后，会出现大量 TIME_WAIT 的 TCP 状态(在 2 个 MSL 之后关闭)。</li>
<li>应用的响应时间和 QPS 较低。</li>
</ul>
<h2 id=池化优点>池化优点</h2>
<p>使用数据库连接池后，最直接的改变就是仅需在首次访问时创建连接，之后的访问直接可以复用已有连接。</p>
<ul>
<li>资源重用。由于数据库连接得到复用，减少了大量创建和关闭连接带来的开销，也减少了内存碎片和数据库临时进程、线程的珊瑚粮，整体系统的运行更加平稳。</li>
<li>系统调优更简便。TIME_WAIT 的调优非常繁琐，使用了数据库连接池以后，由于资源重用，大大减少了频繁关闭连接的开销，大大降低 TIME_WAIT 的出现频率。</li>
<li>系统响应更快。数据库连接池在应用初始化的过程中一般都会提前准备好一些数据库连接，业务请求可以直接使用已经创建的连接而不需要等待创建连接的开销。初始化数据库连接配合资源重用，使得数据库连接池可以大大缩短系统整体响应时间。</li>
<li>连接管理更灵活。数据库连接池作为一款中间件，除了扮演有界缓冲的角色以外，在统一的连接管理上同样可以做很多文章。用户可以自行配置连接的最小数量、最大数量、最常空闲时间、获取连接超时间、心跳检测等。另外，用户也可以结合新的技术趋势，增加数据库连接池的动态配置、监控、故障演习等一系列实用的功能。</li>
</ul>
<h2 id=实现原理>实现原理</h2>
<p>在系统初始化的时候，在内存中开辟一片空间，将一定数量的数据库连接作为对象存储在对象池里，并对外提供数据库连接的获取和归还方法。</p>
<p>用户访问数据库时，并不是建立一个新的连接，而是从数据库连接池中取出一个已有的空闲连接对象；使用完毕归还后的连接也不会马上被关闭，而是由数据库连接池统一管理回收，为下一次借用做好准备。</p>
<p>如果由于高并发请求导致数据库连接池中的连接被借用完毕，其他线程就会等待，直到有连接被归还。</p>
<p>整个过程中，连接并不会被关闭，而是源源不断地循环使用，有借有还。数据库连接池还可以通过设置其参数来控制连接池中的初始连接数、连接的上下限数，以及每个连接的最大使用次数、最大空闲时间等，也可以通过其自身的管理机制来监视数据库连接的数量、使用情况等。</p>
<h2 id=基本构成>基本构成</h2>
<p>数据库连接池的核心功能是建立和释放连接。通常完整的连接池实现会提供更多功能：</p>
<ul>
<li>并发优化：锁性能优化，甚至无锁</li>
<li>连接数控制：不同的系统对连接数的要求不同</li>
<li>监控：提供管理机制来监视连接数量或用量</li>
<li>外部配置</li>
<li>资源重用</li>
<li>检测/容灾：面对网络、时间问题的自愈</li>
<li>多库：不同的数据库、不同的用户与密码、分库分表</li>
<li>事务处理：对数据库的操作符合 ALL-ALL-NOTHING 原则</li>
<li>定时任务：空闲检查、最小连接数控制</li>
<li>缓存：如 PSCache 等避免 SQL 重复解析</li>
<li>异常处理：对 JDBC 异常的统处理</li>
<li>组件维护：连接状态、JDBC 封装维护</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210711224709.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d65e1cea2e403108cd2bf982d6f46006>2.2 - 开源实现</h1>
<p>按采用的线程模型分类：</p>
<table>
<thead>
<tr>
<th>单线程</th>
<th>多线程</th>
</tr>
</thead>
<tbody>
<tr>
<td>c3p0</td>
<td>DBCP 2.x</td>
</tr>
<tr>
<td>Proxool</td>
<td>Tomact JDBC Pool</td>
</tr>
<tr>
<td>XAPool</td>
<td>BoneCP</td>
</tr>
<tr>
<td>DBCP 1.x</td>
<td>Druid</td>
</tr>
<tr>
<td></td>
<td>Hakari</td>
</tr>
</tbody>
</table>
<h2 id=c3p0>c3p0</h2>
<p>c3p0 具有超过 230 个 <code>synchronize</code> 同步块和方法，在不同的类中充斥着大量 <code>wait()</code> 及 <code>notifyAll()</code> 方法，这些导致死锁倾向的代码造成了在网络上搜索“c3p0死锁”可以查到大量的资料。由于代码量复杂等原因，c3p0 在基准测试中也始终排在最后。c3p0 在默认情况下不会在 <code>getConnection </code>的时候测试连接可用性，这点也是不安全的默认配置。</p>
<p>但 c3p0 也提供了一些有用的功能：</p>
<ul>
<li>一个将传统的基于 <code>DriverManager</code> 的 JDBC 驱动程序调整为较新的 <code>javax.sql. DataSource</code> 方案的类，以获取数据库连接。</li>
<li>基于 <code>DataSources</code> 的 <code>Connection</code> 和 <code>PreparedStatements</code> 的透明池，可以“包装”传统驱动程序或任意非池化数据源。</li>
</ul>
<p>c3p0 在以下细节上进行了打磨以确保正确性：</p>
<ul>
<li><code>DataSources</code> 都是可引用和可序列化的，因此其适合绑定到各种基于 JNDI 的命名服务。</li>
<li>当引入 <code>Connection</code> 和 <code>Statement</code> 时，都会仔细清理 <code>Statement</code> 和 <code>ResultSets</code>，这是为了防止客户端使用Lazy模式。但常见的资源管理策略仅仅清理 <code>Connection</code> 而造成资源耗尽。</li>
<li>该库采用 JDBC 2 和 JDBC 3 规范定义的方法(即使这些方法与库作者的首选项冲突)。 <code>DataSources</code> 以 JavaBean 样式编写，提供所有必需和大多数可选属性（以及一些非标准属性）和无参构造函数。
<ul>
<li>实现了所有 JDBC 定义的内部接口（<code>ConnectionPoolDataSource</code>, <code>PooledConnection</code>,<code>ConnectionEvent-generating Connections</code>等）。</li>
<li>用户可以将 c3p0 类与兼容的第三方实现混合使用(尽管并非所有 c3p0 功能都可以与 <code>ConnectionPoolDataSource</code> 的外部实现一起使用)。</li>
</ul>
</li>
</ul>
<h2 id=proxool>Proxool</h2>
<p>Proxool 以JDBC 驱动的身份为用户提供透明的连接池服务，所以 Proxool 移植到现有代码中特别容易，用户可以轻松地使用 JDBC API、XML 或 Java 属性文件进行配置。</p>
<p>Proxool 在那个年代另辟蹊径，开创性地提供了连接池监控功能，便于发现连接泄漏的等性能情况及连接事件。</p>
<p>它的很多设计理念都被 HikariCP 认可并吸收，HikariCP 在继承过程中进行了独具匠心的打磨。例如，关于 Cglib 等字节码的代理，这也是 HikariCP 仔细打磨的地方。</p>
<h2 id=xapool>XAPool</h2>
<p>XA 是 X/Open CAE Specification(Distributed TransactionProcessing) 模型中定义的 TM(Transaction Manager) 与 RM(Resource Manager) 之间进行通信的接口。</p>
<p>Java 中的 <code>javax.transaction.xa.XAResource</code> 定义了XA接口，它依赖数据库厂商对 jdbc-driver 的具体实现。在 XA 规范中，数据库充当 RM 角色，应用需要充当 TM 的角色，即生成全局的 txId，调用 <code>XAResource</code> 接口，把多个本地事务协调为全局统一的分布式事务。</p>
<p>XAPool 是一个 XA 数据库连接池，它实现了 <code>javax.sql.XADataSource</code>，并提供了连接池工具。这是一款主打分布式事务的数据库连接池，它允许池对象，JDBC 连接和 XA 连接。</p>
<h2 id=dbcp>DBCP</h2>
<p>Apache Commons DBCP 并不是独立实现连接池功能的，它内部依赖于 Commons 中的另一个子项目 Apache Commons Pool。数据库连接池中最核心的“池”，就是由 Pool 组件提供的，Apache Commons Pool 决定着数据库连接池的整体性能。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210711231029.png style=display:block;width:80% alt=NAME align=center> </div>
<p>在2014年3月，DBCP终于更新到了2.x版本，基于新的线程模型的数据库连接池让DBCP焕然一新重获新生，稳定性得到提升，性能也有了质的提升。Apache Commons Pool 2类库是对象池技术的一种具体实现，它的出现是为了解决频繁的创建和销毁对象带来的性能损耗问题。</p>
<p>其原理就是建立一个对象池，池中预先生成了一些对象，需要对象的时候借用，用完后进行归还，对象不够时灵活地自动创建，对象池满后提供参数控制是阻塞还是非阻塞响应租借用。</p>
<p>在 SpringBoot 1.5.x 版本中，数据库连接池的默认配置是 Tomcat Pool → HikariCP →Commons DBCP → Commons DBCP2；然而在 2.x 版本中，HikariCP 被提升为默认的数据库连接池，数据库连接池的默认配置顺序是 HikariCP → Tomcat pool→ CommonsDBCP2。</p>
<h2 id=tomcat-jdbc-pool>Tomcat JDBC Pool</h2>
<p>在 DBCP 2.0 之前，为什么需要一个新的连接池：</p>
<ul>
<li>DBCP 1.x 是单线程。为了线程安全，在对象分配或对象返回的短期内，Commons 锁定了全部池。</li>
<li>DBCP 1.x 可能会变得很慢。当逻辑 CPU 数目增长，或者试图借出或归还对象的并发线程增加时，性能就会受到影响。高并发系统受到的影响会更为显著。</li>
<li>DBCP 拥有 60 多个类，而 tomcat-jdbc-pool 核心只有 8 个类。因此为了未来需求变更着想，肯定需要更少的改动。我们真正需要的只是连接池本身，其余的只是附属。</li>
<li>DBCP 使用静态接口，因此对于指定版本的 JRE，只能采用正确版本的 DBCP，否则就会出现 NoSuchMethodException 异常。</li>
<li>当 DBCP 可以用其他更简便的实现来替代时，实在不值得重写那 60 个类。</li>
<li>Tomcat JDBC 连接池无需为库本身添加额外线程，就能异步获取连接。</li>
<li>Tomcat JDBC 连接池是 Tomcat 的一个模块，依靠 Tomcat JULI 这个简化了的日志架构。</li>
<li>使用 javax.sql.PooledConnection 接口获取底层连接。</li>
<li>防止饥饿。如果池变空，线程将等待一个连接。当连接返回时，池就将唤醒正确的等待线程。大多数连接池只会一直维持饥饿状态。</li>
</ul>
<p>Tomcat JDBC Pool 还具有其他连接池没有的特点：</p>
<ul>
<li>支持高并发环境与多 核/CPU 系统。</li>
<li>接口的动态实现。支持 java.sql 与 java.sql 接口(只要JDBC驱动)，甚至在利用低版本的 JDK 来编译时也支持。</li>
<li>验证间隔时间。我们不必每次使用单个连接时都进行验证，可以在借出或归还连接时进行验证，只要不低于我们所设定的间隔时间就行。</li>
<li>只执行一次查询。当与数据库建立起连接时，只执行一次可配置查询。这项功能对会话设置非常有用，因为你可能会想在连接建立的整个时段内都保持会话。</li>
<li>能够配置自定义拦截器。通过自定义拦截器来增强功能。可以使用拦截器来采集查询统计，缓存会话状态，重新连接之前失败的连接，重新查询，缓存查询结果，等等。由于可以使用大量的选项，所以这种自定义拦截器也是没有限制的，与 java.sql/javax.sql 接口的 JDK 版本没有任何关系。</li>
<li>高性能。后面将举例展示一些性能差异。</li>
<li>极其简单。它的实现非常简单，代码行数与源文件都非常少，这都有赖于从一开始研发它时，就把简洁当作重中之重。核心只有8个文件。</li>
<li>异步连接获取。可将连接请求队列化，系统返回 <code>Future&lt;Connection></code>。</li>
<li>更好地处理空闲连接。不再简单粗暴地直接关闭空闲连接，而是把连接仍然保留在池中，通过更为巧妙的算法控制空闲连接池的规模。</li>
<li>可以控制连接应被废弃的时间。当池满了即废弃，或者指定一个池使用容差值，发生超时就进行废弃处理。</li>
<li>通过查询或语句来重置废弃连接计时器。允许一个使用了很长时间的连接不会因为超时而被废弃。这一点是通过使用 ResetAbandonedTimer 来实现的。</li>
<li>经过指定时间后，关闭连接。与返回池的时间相类似。</li>
<li>当连接要被释放时，获取 JMX 通知并记录所有日志。它类似于 remove-AbandonedTimeout，但却不需要采取任何行为，只需要报告信息即可。通过 suspectTimeout 属性来实现。</li>
<li>可以通过 java.sql.Driver、javax.sql.DataSource 或 javax.sql.XADataSource 获取连接。通过 dataSource 与 dataSourceJNDI 属性实现这一点。</li>
<li>支持 XA 连接。</li>
</ul>
<p>其缺点有：</p>
<ul>
<li>默认配置也存在类似 c3p0 的问题，就是在 getConnection 的时候并不会默认测试连接可用性。</li>
<li>不完全遵守 JDBC 规范，默认也不会重置连接状态(如自动提交、事务隔离级别等)，用户必须手动配置名为 ConnectionState 的 JDBCInterceptor。</li>
<li>在自动提交中，如果连接池配置了 <code>autocommit=false</code>，就需要在自己的事务中执行连接有效性测试 <code>isValid()</code>，否则使用者获取的连接有可能就在一个事务进行中。</li>
<li>对于创建连接时可以在连接上运行的初始化 initSQL 也是如此，Tomcat 不会在自己的事务中封装连接测试或 initSQL。</li>
<li>连接池应该在 Connection 返回到池时或从池中取出之前，调用 <code>clearWarnings()</code> 方法清除 SQL 警告，然而 TomcatJDBC 也没有这么做。</li>
<li>JDBC 规范还规定，连接关闭时，所有没有关闭的、已经打开的 Statements 都应该自动关闭，但是默认情况下 Tomcat JDBC 并不会跟踪 Statements，除非手动配置一个 StatementFinalizer 拦截。</li>
<li>不幸的是，StatementFinalizer 使用一组 WeakReference 对象跟踪 Statements，当 JVM 受到 GC压力时，在 Tomcat 有机会关闭这些语句之前，可能会对废弃的 Statements 进行垃圾收集，这可能导致资源的泄漏，但是只有在 GC 压力下才会发生，因此可能很难追踪。</li>
</ul>
<h2 id=bonecp>BoneCP</h2>
<p>在 c3p0 和 DBCP 已经存在的时代，BoneCP 的出现就是为了追求极致，它几乎比下一个最快的连接池选项快 25 倍，而且 BoneCP 从不自旋锁定，因此它不会减慢应用程序速度。</p>
<p>BoneCP 可以说是极致数据库连接池的领军开源项目。它和 HikariCP 也是非常有渊源的，除了 HikariCP 捐赠了 BoneCP 几美金的故事以外，BoneCP 在浪潮之巅功成身退，深藏功与名，将一身衣钵传给了 HikariCP。</p>
<p>BoneCP 的特点如下：</p>
<ul>
<li>具有高可扩展性的快速连接池。</li>
<li>在 connection 状态改变时，可配置回调机制(钩式拦截器)。</li>
<li>通过分区(Partitioning)来提升性能。</li>
<li>允许用户直接访问 connection 或 statement。</li>
<li>自动扩展 pool 容量。</li>
<li>支持 statement caching。</li>
<li>支持异步地获取connection，通过返回一个 <code>Future&lt;Connection></code> 实现。</li>
<li>以异步的方式施放辅助线程，来关闭 connection 和 statement，以获得高性能。</li>
<li>在每个新获取的 connection 上，通过简单的机制，执行自定义的 statement。即通过简单的 SQL 语句来测试 connection 是否有效，对应的配置属性为 initSQL。</li>
<li>支持运行时切换数据库，而不需要停止应用。</li>
<li>能够自动地回放任何失败的事务(如数据库或网络出现故障等)。</li>
<li>支持JMX。</li>
<li>可以延迟初始化(lazy initialization)。</li>
<li>支持使用 XML 或 property 文件的配置方式。</li>
<li>支持 idle connection timeouts 和 max connection age。</li>
<li>自动检验 connection 是否活跃等等。</li>
<li>允许直接从数据库获取连接，而不通过 Driver。</li>
<li>支持 Datasouce 和 Hibernate。</li>
<li>支持通过 debugging hooks 来定位获取后未关闭的 connection。</li>
<li>支持通过 debugging 来显示被关闭了两次的 connection 的堆栈轨迹(stack locations)。</li>
<li>支持自定义 pool name。</li>
<li>代码整洁有序。</li>
<li>免费，开源，纯 Java 编写，具有完整的文档。</li>
</ul>
<p>BoneCP 最大的一个问题是无法在 getConnection() 的时候配置数据库连接池来测试连接。然而其他每个数据库连接池大多都可以这样配置。它这样做是为了提升速度，但却牺牲了可靠性。</p>
<ul>
<li>在默认配置方面，BoneCP 也不会在 Connection 返回到池时或从池中取出之前通过 <code>Connection.clearWarnings()</code> 方法清除 SQL 警告；</li>
<li>默认情况下也不会关闭废弃的、已经打开的 statements；</li>
<li>也不会在自己的事务中封装连接测试或 initSQL。</li>
</ul>
<h2 id=druid>Druid</h2>
<p>主要功能：</p>
<ul>
<li>替换 DBCP 和 c3p0。Druid 提供了一个高效、功能强大、扩展性好的数据库连接池。</li>
<li>可以监控数据库访问性能。Druid 内置了一个功能强大的 StatFilter 插件，能够详细统计 SQL 的执行性能，这有助于对线上数据库访问性能进行分析。</li>
<li>数据库加密。直接把数据库密码写在配置文件中是不好的行为，容易导致安全问题。DruidDruiver 和 DruidDataSource 都支持 PasswordCallback。</li>
<li>SQL 执行日志。Druid 提供了不同的 LogFilter，能够支持 Common-Logging、Log4j 和 JdkLog，用户可以按需要选择相应的 LogFilter，监控自己的应用的数据库访问情况。</li>
<li>扩展 JDBC。如果用户对 JDBC 层有编程的需求，可以通过 Druid 提供的 Filter 机制，很方便地编写 JDBC 层的扩展插件。</li>
</ul>
<p>Druid 在监控、可扩展性、稳定性和性能方面都有明显的优势：</p>
<ul>
<li>强大的监控特性，通过 Druid 提供的监控功能，可以清楚地知道连接池和 SQL 的工作情况。
<ul>
<li>监控 SQL 的执行时间、ResultSet 持有时间、返回行数、更新行数、错误次数、错误堆栈信息。</li>
<li>SQ L执行的耗时区间分布。什么是耗时区间分布？比如，某个 SQL 执行了 1000 次，其中在 0～1 毫秒区间50次&mldr;</li>
<li>监控连接池的物理连接创建和销毁次数、逻辑连接的申请和关闭次数、非空等待次数、PSCache 命中率等。</li>
</ul>
</li>
<li>方便扩展。Druid 提供了 Filter-Chain 模式的扩展 API，可以自己编写 Filter 拦截 JDBC 中的任何方法。</li>
<li>Druid 集合了开源和商业数据库连接池的优秀特性，并结合阿里巴巴公司大规模苛刻生产环境的使用经验进行了优化。</li>
<li>性能不是 Druid 的设计目标，但是测试数据表明，Druid 性能比 DBCP、c3p0、Proxool、JBoss 都好。
<ul>
<li>Druid 代码将近 50 万行。</li>
</ul>
</li>
</ul>
<h2 id=功能对比>功能对比</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210712234246.png style=display:block;width:90% alt=NAME align=center> </div>
<ul>
<li>LRU。LRU 是一个性能关键指标，特别是 Oracle，其中每个 Connection 对应数据库端的一个进程，如果数据库连接池遵从 LRU，有助于数据库服务器优化，这是重要的指标。</li>
<li>PSCache。PSCache 是数据库连接池的关键指标。在 Oracle 中，类似 SELECT NAME FROM USER WHERE ID =？这样的 SQL，启用 PSCache 和不启用 PSCache 的性能可能会相差一个数量级。</li>
<li>PSCache-Oracle-Optimized。在 Oracle 10 系列的 Driver 中，如果开启 PSCache，会占用大量的内存，必须做特别的处理，启用内部的 EnterImplicitCache 等方法优化才能够减少内存的占用。</li>
<li>ExceptionSorter。ExceptionSorter 是一个很重要的容错特性，如果一个连接产生了一个不可恢复的错误，必须立刻将其从连接池中去掉，否则会连续产生大量错误。</li>
</ul>
<h3 id=中断测试>中断测试</h3>
<p>将数据库连接池执行 <code>getConnection()</code> 在5秒的调用后超时，应用程序应在指定时间内获得连接，或获得异常。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210712234444.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-bf5289a54cb90ff13efab472717f661d>2.3 - 配置参数</h1>
<h2 id=时间校准>时间校准</h2>
<p>HikariCP 在很大程度上依赖于精确的高分辨率的定时器来提高性能和可靠性，所以使用数据库连接池 HikariCP 的应用服务器最好能够与时间源做同步，比如 NTP 服务器，否则由于 HikariCP 源码对于时间的处理可能会导致一些问题。</p>
<p>不稳定的时间影响的不仅仅是数据库连接池，任何定时等待、并发集合的定时轮询、带有超时的 <code>Object.wait()</code>、<code>Thread.sleep()</code> 调用等，以及任何 Java 中需要测量时间的功能都会受到影响。</p>
<h2 id=必要配置>必要配置</h2>
<h3 id=datasourceclassname>dataSourceClassName</h3>
<p>dataSourceClassName 和 jdbcUrl 是两种数据源的配置方式。</p>
<p>HikariCP 更加建议使用 dataSourceClassName，当然，两者都可以接受。需要注意的是，如果是 Spring Boot 自动装配的用户，需要使用 jdbcUrl 的基于配置的方式；当前已知的 MySQL DataSource 并不支持网络超时，建议改用 jdbcUrl 的方式。</p>
<h3 id=jdbcurl>jdbcUrl</h3>
<p>表示 HikariCP 使用传统的、基于驱动管理器 DriverManager 的配置。虽然 HikariCP 作者认为两种配置方式中，基于 dataSourceClassName 的配置由于各种原因而更优越，但对于许多部署而言，几乎没有显著差异。</p>
<p>将此属性与“旧”驱动程序一起使用时，可能还需要设置 driverClassName 属性，但首先尝试不使用该属性。如果使用此属性，用户仍可以使用 DataSource 属性来配置驱动程序，实际上建议使用 URL 本身中指定的驱动程序参数。</p>
<h3 id=username--password>username & password</h3>
<p>username 和 password 分别表示从基础驱动程序获取 Connections 时使用的默认身份验证用户名和密码。</p>
<p>HikariCP 会将 username 属性和 password 属性分别配置在 Properties 文件中，从而传递给驱动 Driver 的 DriverManager.getConnection(jdbcUrl, props) 调用。</p>
<h2 id=非必要配置>非必要配置</h2>
<h3 id=autocommit>autoCommit</h3>
<p>此属性控制从池返回的连接的默认自动提交行为。它是一个布尔值。默认值：true。</p>
<h3 id=connectiontimeout>connectionTimeout</h3>
<p>此属性控制客户端（即用户的程序）等待池中连接的最长毫秒数。如果在没有连接可用的情况下超过此时间，则将抛出 SQLException 异常。最低可接受的连接超时为250毫秒。默认值：30000（30秒）。这是一个很重要的问题排查指标。</p>
<h3 id=idletimeout>idleTimeout</h3>
<p>此属性控制连接允许被闲置在池中的最大时间。此设置仅适用于 minimumIdle 定义为比 maximumPoolSize 小的时候。一旦池到达 minimumIdle 连接的时候，空闲连接将不会退役。连接是否空闲而退役的最大变化为 +30 秒，平均变化为 +15 秒。在此超时之前，连接永远不会因空闲状态而退役。值为 0 意味着空闲连接永远不会从池中删除即永不超时。minimum 允许的最小值为 10000 毫秒（10秒）。默认值：600000（10分钟）。</p>
<p>许多防火墙和负载均衡器（通常位于应用程序和数据库之间）会占用套接字生存周期。通常，达到 idleTimeout 时，无论当前流量如何，都会切断连接。</p>
<p>HikariCP 设计之初就不支持空闲连接检测 test-while-idle，这是因为数据库管理员 DBA 往往会默认设置数据库最长连接时间是 60 秒，test-while-idle 会对数据库产生不必要的查询，这样就有可能导致数据库空闲连接出现超时的问题。</p>
<p>旧版本中，maxLifetime 由管家线程 HouseKeeper 强制执行，每 30 秒执行一次，因为 wait_timeout 减去 30 秒是推荐的 maxLifetime。但是最新版本的 HikariCP 对每个连接 connection 进行专用计时器任务，提供了几十毫秒（在高负载下长达几秒）的时间间隔，此时 maxLifetime 被安全地设置为 wait_timeout 减去5秒。如果连接退出，后台线程会执行添加操作，创建新的连接大约是 5 毫秒。如果 maxLifetime 是60秒，那么 idleTimeout 可以被设置为 0，显得就并不那么重要。</p>
<h3 id=maxlifetime>maxLifetime</h3>
<p>此属性控制池中连接的最大生命周期。使用中的连接永远不会退役，除非它被关闭然后移除。在逐个连接的基础上，应用轻微的负衰减可以避免池中的大量消亡（在源码解析部分会深入分析）。HikariCP 作者强烈建议用户设置此值，并且它应比任何数据库或基础设施实施的连接时间限制短几秒。值为 0 表示没有最大生存期（无限生存期），当然这取决于 idleTimeout 设置。默认值：1800000（30分钟）。</p>
<p>30 分钟的默认超时是非常合理的，很多开发人员都会发现，在应用程序与很多数据库之间，会有高可用代理、负载均衡、防火墙等，通常这些组件会自动且独立地终止连接 30 分钟左右。</p>
<p>一般来说，可以将 maxLifetime 设置缩短到 900000 毫秒（15分钟）然而更好的方法是，确定 MySQL 配置的 wait_timeout 值是什么，并将 HikariCP 设置为比 maxLifetime 短几分钟。</p>
<h3 id=connectiontestquery>connectionTestQuery</h3>
<p>如果您的驱动程序支持 JDBC4，我们强烈建议不要设置此属性。这适用于不支持 JDBC4 的 Connection.isValid() 的“遗留”驱动程序 API。这是一个检测查询，在数据库连接池给出连接之前进行查询，以验证与数据库的连接是否仍然存在且有效。</p>
<p>如果你追求极致性能的话，建议不要配置该属性，因为不配置的时候会通过 ping 命令进行连接检测，性能会更高。</p>
<h3 id=minimumidle>minimumIdle</h3>
<p>此属性控制 HikariCP 尝试在池中维护的最小空闲连接数。若空闲连接低于此值且池中的总连接数小于 maximumPoolSize，则 HikariCP 将尽最大努力快速有效地添加其他连接。</p>
<p>然而，为了最大限度地提高性能和对峰值需求的响应能力，HikariCP 作者建议不要设置此值，而是允许 HikariCP 充当一个固定大小的连接池（如果 minimumIdle 未设置则默认为是 maximumPoolSize，因此即使 idleTimeout 设置为 1 分钟，一旦连接关闭，它将在池中被替换）。</p>
<p>如果设置这个值，那么 HikariCP 就会是一个大小可变的池，通过 minimumIdle 进行调解控制，即使使用情况上下浮动，HikariCP 也会保持 minimumIdle 连接可用。默认值：与 maximumPoolSize 相同。</p>
<p>minimumIdle 应始终小于或等于 maximumPoolSize。如果 minimumIdle 设置为更高的值，它将推高 maximumPoolSize 到相等的值。minimumIdle 逻辑上不能超过 maximumPoolSize，因为 maximumPoolSize 指定了后端数据库的实际连接的最大数量。</p>
<p>如果有比 minimumIdle 的数目更多的连接数，如果一个连接退役了，它不会被自动替换。但是如果数据库连接池被配置为固定大小的，或者连接关闭后如果空闲连接小于 minimumIdle 的数量，那么就会立即自动替换连接。</p>
<p>启用 HikariCP 的 metrics 采集，在可视化界面上可直观地显示连接的直方图，便于用户研究并确定正确的、合理的 minimumIdle 及 idleTimeout 等值。数据库连接池的调优最好基于经验数据，具体问题具体分析。</p>
<h3 id=maximumpoolsize>maximumPoolSize</h3>
<p>此属性控制允许数据库连接池到达的最大大小，包括空闲和正在使用的连接。基本上，此值将确定到数据库后端的实际连接的最大数量。合理值最好由用户的执行环境决定。当池达到此大小且没有空闲连接可用时，对 getConnection() 的调用将阻塞到超时前 connectionTimeout 毫秒。关于连接池大小 PoolSize 的相关知识请关注本章后续内容。默认值：10。</p>
<h3 id=metricregistry>metricRegistry</h3>
<p>此属性仅通过编程配置或 IoC 容器可用。此属性允许用户指定池使用的 Codahale /Dropwizard 实例 MetricRegistry，来记录各种度量标准。如果用户需要使用 Prometheus 等监控的话，还需要做一些操作。</p>
<h3 id=healthcheckregistry>healthCheckRegistry</h3>
<p>此属性仅通过编程配置或 IoC 容器可用。此属性允许用户指定池使用的 Codahale /Dropwizard 实例 HealthCheckRegistry，来报告当前系统的健康信息。默认值：无。</p>
<h3 id=poolname>poolName</h3>
<p>此属性表示连接池的用户定义名称，主要显示在日志记录和JMX管理控制台中，以标识池和池配置。默认值：自动生成。</p>
<h2 id=非常用配置>非常用配置</h2>
<h3 id=initializationfailtimeout>initializationFailTimeout</h3>
<p>如果池无法成功初始化连接，则此属性控制池是否“快速失败”。任何正数都被认为是尝试获取初始连接的毫秒数；在此期间，应用程序线程将被阻塞。如果在超时发生之前无法获取连接，则将引发异常。initializationFailTimeout超时发生在connectionTimeout阶段之后。如果值为0, HikariCP将尝试获取并验证连接。如果获得连接但验证失败，则抛出异常，而不会启动池。但是，如果无法获得连接，则池将启动，但稍后获取连接的尝试会失败。小于0的值将绕过任何初始连接尝试，并且池将在尝试在后台获取连接时立即启动。因此，以后获得连接的尝试可能会失败。默认值：1。</p>
<h3 id=isolatelnternalqueries>isolatelnternalQueries</h3>
<p>此属性决定HikariCP是否在自己的事务中隔离内部池查询，例如连接存活测试。由于这些通常是只读查询，因此很少有必要将它们封装在自己的事务中。此属性仅在autoCommit禁用时适用。默认值：false。</p>
<h3 id=allowpoolsuspension>allowPoolSuspension</h3>
<p>此属性控制池是否可以通过JMX挂起和恢复。这对某些故障转移自动化方案很有用。当池被挂起时，调用getConnection()将不会超时，并将一直保持到池恢复为止。默认值：false。</p>
<h3 id=readonly>readOnly</h3>
<p>此属性控制默认情况下从池中获取的Connections是否处于只读模式。请注意，某些数据库不支持只读模式的概念，而其他数据库在Connection设置为只读时提供查询优化。是否需要此属性将在很大程度上取决于那的应用程序和数据库。默认值：false。</p>
<h3 id=registermbeans>registerMbeans</h3>
<p>此属性控制是否注册JMX管理Bean（“MBean”）。默认值：false。</p>
<h3 id=catalog>catalog</h3>
<p>此属性为支持catalog的数据库设置默认catalog。如果未指定此属性，则使用JDBC驱动程序定义的默认catalog。默认值：driver default。</p>
<h3 id=connectionlnitsql>connectionlnitSql</h3>
<p>此属性设置一个SQL语句，该语句将在每次创建新连接之后执行，然后再将该连接添加到池中。如果此SQL无效或抛出异常，它将被视为连接失败，并将遵循标准重试逻辑。默认值：无。</p>
<h3 id=driverclassname>driverClassName</h3>
<p>HikariCP将尝试仅基于jdbcUrl通过DriverManager解析驱动程序，但对于某些较旧的驱动程序必须指定driverClassName。除非用户收到明显的错误消息，表明未找到驱动程序，否则可忽略此属性。默认值：无。</p>
<h3 id=transactionlsolation>transactionlsolation</h3>
<p>此属性控制从池返回的连接的默认事务隔离级别。若未指定，则用JDBC驱动程序定义的默认事务隔离级别。仅当有针对所有查询的特定隔离需求时，才使用此属性。此属性的值是Connection类的常量名，如TRANSACTION_READ_COMMITTED、TRANSACTION_REPEATABLE_READ等。默认值：driverdefault。</p>
<h3 id=validationtimeout>validationTimeout</h3>
<p>此属性控制连接测试活性的最长时间。该值必须小于connectionTimeout。最低可接受的验证超时为250毫秒。默认值：5000。</p>
<h3 id=leakdetectionthreshold>leakDetectionThreshold</h3>
<p>此属性控制连接在记录一条指示可能连接泄漏的消息之前流出池的时间。值为0表示禁用泄漏检测。启用泄漏检测的最低可接受值是2000（2秒）。默认值：0。</p>
<h3 id=datasource>dataSource</h3>
<p>此属性仅可通过编程配置或IoC容器获得。此属性允许用户直接设置DataSource要由池包装的实例，而不是让HikariCP通过反射构造它。这在一些依赖注入框架中很有用。指定此属性后，dataSourceClassName将忽略该属性和所有特定于DataSource的属性。默认值：无。</p>
<h3 id=schema>schema</h3>
<p>该属性为支持schema概念数据库设置默认schema。如果未指定此属性，则使用JDBC驱动程序定义的默认模式。默认值：driver default。</p>
<h3 id=threadfactory>threadFactory</h3>
<p>此属性仅可通过编程配置或IoC容器获得。此属性允许设置java.util.concurrent. ThreadFactory将用于创建池使用的所有线程的实例。在注入线程只能通过应用程序容器提供的ThreadFactory创建的某些受限执行环境中使用它。默认值：无。</p>
<h3 id=scheduledexecutor>scheduledExecutor</h3>
<p>仅可通过编程配置或IoC容器获得。允许设置java.util.concurrent.Scheduled-ExecutorService用于各种内部调度任务的实例。如果向HikariCP提供ScheduledThread-PoolExecutor实例，建议设置setRemoveOnCancelPolicy(true)。默认值：无。</p>
<h2 id=容量设置>容量设置</h2>
<h3 id=公式>公式</h3>
<p>拥有一个CPU内核的计算机可以同时执行数十或数百个线程，其实这只是操作系统的一个time-slicing（时间切片）的把戏。实际上，单核只能一次执行一个线程，然后由操作系统切换上下文，并且内核为另一个线程执行代码，依此类推。这是一个基本的计算法则，给定一个CPU资源，按顺序执行A和B总是比通过时间片“同时”执行A和B要快。一旦线程数量超过了CPU核心的数量，添加更多的线程速度就会变慢，而不是更快。</p>
<p>设计多线程是为了尽可能地利用CPU空闲等待时间（及IO、交互等），它的代价就是要增加部分CPU时间来实现线程切换。如果CPU空闲等待时间已经比线程切换更短（线程越多，切换消耗越大），那么线程切换会非常影响性能，成为系统瓶颈。</p>
<p>当我们查看数据库的主要瓶颈是什么时，它们可以归纳为3个基本类别：CPU、磁盘、网络。</p>
<p>可以在PostgreSQL基准测试中看到，TPS速率开始在大约50个连接处变平：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210714233613.png style=display:block;width:50% alt=NAME align=center> </div>
<p>下面的公式也是由PostgreSQL项目提供的，它同样在很大程度上适用于数据库。实际生产中，用户测试应用程序，即模拟预期的负载，并在此起点周围尝试不同的池设置。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>connections =（（core_count×2）+ effective_spindle_count）
</code></pre></div><p>effective_spindle_count 就是磁盘列阵中的硬盘数。某PostgreSQL项目做过测试，拥有一个硬盘的小型4核i7服务器的连接池大小设置为：9 = ((4×2) + 1)。这样的连接池大小居然可以轻松处理3000个前端用户在6000 TPS下进行简单查询。这里的线程数指的是数据库进程中的线程，通常通过连接调度的查询将在数据库的单个线程上执行，连接和线程在大多数情况下几乎都是一对一的关系。</p>
<p>在公式的配置上，如果加大压力，TPS会下降，RT会上升，可以适当地根据情况进行调整加大。这时应考虑整体系统性能，同时考虑线程执行需要的等待时间，合理地设计线程数目。但是，不要过度配置你的数据库。如果一直给HikariCP增加压力，那么性能也可能会产生急剧的下降。</p>
<ul>
<li>如果查询是5毫秒，则通过单个连接每秒可以处理大约200个查询。</li>
<li>如果查询是100毫秒，单个连接每秒可以处理大约10个查询。</li>
<li>对数据库而言，5台Server各自拥有一个连接和每台Server拥有5个连接几乎相同。</li>
<li>如果有慢查询和快速查询的混合，由于慢查询会锁定数据库连接池，建议长时间运行的查询使用单独的数据库连接池。</li>
</ul>
<p>数据库连接池的大小设置针对的是单个组件、应用程序和单个数据库。在多个微服务同时访问单个共享数据库的时候，情况就会变得比较棘手，这时就需要提炼出一些应对它的方法。对于单个应用程序来说，如果同时运行任何超过10个查询会产生较低的吞吐量和较高的延迟，如果平均查询时间是2ms，那么在2ms的时间内可以满足10个查询。如果我们允许20个查询（HikariCP数据库连接池的大小为20），则在2ms内无法满足同时运行20个查询，并且由于调度程序的时间分片开销，实际上可能超过2倍。如果微服务A和微服务B同时对该数据库进行查询，并持续生成连续负载，按照10个查询的稳定性大小，服务A和服务B分别设置数据库连接池大小为5是有意义的。对于生成连续负载的N服务，最大池大小的公式很简单：（最大同时数据库查询）/ N。</p>
<p>但是服务A和服务B之间还有一些突发性，比如A或者B一段时间内爆发大量查询，一段时间内相对空闲，这时候最大数据库连接池大小设为5～10会比较好。微服务越多，这个就越复杂。度量标准Metrics是进行数据库连接池大小评估的很有效的工具。首先，根据对其需求的最佳预测，为每个微服务选择一个池大小，而不考虑其他服务，并收集每项服务的指标：Active connections（活动连接）、Idle connections（空闲连接）、Waiting threadcount（等待线程数）、Usage（每个连接离开池多长时间）。然后，根据这些指标找到峰值并尝试确定原因，进行分类对比，并确定总活动超过数据库容量和CPU的点是否与峰值对应。最后，通过不断重复这些过程，根据收集的指标慢慢进行匹配对比，观察分析，从而找到数据库连接池最合适的大小。</p>
<h3 id=池锁>池锁</h3>
<p>池锁代表数据库连接池由于由于竞争资源或者由于彼此通信而造成的一种阻塞的现象。</p>
<p>很多实际使用数据库连接池的用户在开发过程中或多或少遇到过池锁的问题。增大连接池大小可以缓解池锁问题，但是扩大池之前可以先检查一下应用层面是否能够调优，而不要直接调整连接池大小。</p>
<p>避免池锁有一个简单的资源分配公式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>pool size = Tn x (Cm -1) + 1
</code></pre></div><p>Tn 是线程的最大数量，Cm 是单个线程持有的同时连接的最大数量。例如，有3个线程（Tn = 3），每个线程需要4个连接来执行某个任务（Cm = 4）。确保永不死锁的池大小是： 3 x（4-1）+ 1 = 10。</p>
<p>如果有10个线程（Tn = 10），每个线程需要2个连接（Cm =2）来执行某个任务，确保永不出现死锁所需的池大小是：10x（2-1）+ 1 = 11。</p>
<p>再比如，最多有8个线程（Tn = 8），每个线程需要3个连接来执行一些任务（Cm =3）。确保永远不可能死锁的池大小是： 8×（3-1）+ 1 = 17注意，这不一定是最佳池大小，但是是避免死锁所需的最低限度，也就是最小的池大小。</p>
<p>在某些环境中，使用JTA（Java事务管理器）可以显著减少从同一个Connection返回getConnection()到当前事务中已经存储Connection的线程所需的连接数。</p>
<h3 id=建议>建议</h3>
<p>混合了长时间运行事务和非常短的事务的系统通常是最难调整任何连接池的系统。在这些情况下，创建两个池实例可以很好地工作（例如，一个用于长时间运行的事务，另一个用于“实时”查询）。</p>
<p>对于长期运行的外部系统，例如只允许一定数量的作业同时运行的作业执行队列，这时作业队列大小就是连接池非常合适的大小。</p>
<p>总结如下：连接池是综合每个应用系统的业务逻辑特性，加上应用硬件配置，加上应用部署数量，再加上DB硬件配置和最大允许连接数等测试出来的，很难用一个公式简单进行计算。连接数及超时时间设置不正确经常会带来较大的性能问题，并影响整个服务能力的稳定性。具体设置多少，要看系统的访问量，可通过反复测试，找到最佳点。压测很重要。</p>
<h2 id=fixed-pool-design>Fixed Pool Design</h2>
<p>基于大量实践得到的经验值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>maximumPoolSize: 20
minimumIdle: 10
</code></pre></div><p>HikariCP的初始版本只支持固定大小的池。作者初衷是，HikariCP是专门为具有相当恒定负载的系统而设计的，并且倾向于连接池大小保持其运行时允许达到的最大大小，所以作者认为没有必要将代码复杂化以支持动态调整大小。</p>
<p>如果想要支持动态调整不同负载的最佳池大小设置，可以配合Hikari使用同为the Mutual Admiration Society成员的VladMihalcea研究的FlexyPool。当然，连接池上限受到数据库最优并发查询容量的限制，这正是HikariCP关于池大小起作用的地方。然而，在池的最小值和最大值之间，FlexyPool不断尝试递增，确保该池大小在提供服务的过程中动态负载一直是正确的。</p>
<p>FlexyPool具有以下默认策略：</p>
<ul>
<li>在超时时递增池。此策略将增加连接获取超时时的目标连接池最大大小。连接池具有最小的大小，并可根据需要增长到最大大小。该溢出是多余的连接，让连接池增长超过其初始的缓冲区最大尺寸。每当检测到连接获取超时时，如果池未增长到其最大溢出大小，则当前请求不会失败。</li>
<li>重试尝试。此策略对于那些缺少连接获取重试机制的连接池非常有用。</li>
</ul>
<h3 id=核心逻辑>核心逻辑</h3>
<p>minIdle来指定空闲连接的最小数量，maxPoolSize指定连接池连接最大值，默认初始化的时候，是初始化minIdle大小的连接，如果minIdle与maxPool-Size值相等，那就是初始化时把连接池填满。idleTimeout用来指定空闲连接的时长，maxLifetime用来指定所有连接的时长。com.zaxxer.hikari.housekeeping.periodMs用来指定连接池空闲连接处理及连接池数补充的HouseKeeper任务的调度时间间隔。所有的连接在maxLifetime之后都得重连一次，以保证连接池的活性。</p>
<h2 id=mysql-配置>MySQL 配置</h2>
<p>MySQL 的主要性能配置参数是：</p>
<ul>
<li>prepStmtCacheSize：这将设置MySQL驱动程序将为每个连接缓存的预准备语句数。默认值为保守25。我们建议将其设置为250～500。</li>
<li>prepStmtCacheSqlLimit：这是驱动程序将缓存的已准备SQL语句的最大长度。MySQL的默认值是256。根据我们的经验，特别是对于像Hibernate这样的ORM框架，这个默认值远低于生成的语句长度的阈值。我们推荐的设置是2048。</li>
<li>cachePrepStmts：如果事实上禁用了高速缓存，则上述任何参数都不会产生任何影响，因为它是默认情况下。必须将此参数设置为true。</li>
<li>useServerPrepStmts：较新版本的MySQL支持服务器端预处理语句，这可以提供显著的性能提升。应将此属性设置为true。</li>
</ul>
<p>HikariCP 的典型 MySQL 配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>jdbcUrl=jdbc:mysql://localhost:3306/simpsons
user=test
password=test
dataSource.cachePrepStmts=true
dataSource.prepStmtCacheSize=250
dataSource.prepStmtCacheSqlLimit=2048
dataSource.useServerPrepStmts=true
dataSource.useLocalSessionState=true
dataSource.rewriteBatchedStatements=true
dataSource.cacheResultSetMetadata=true
dataSource.cacheServerConfiguration=true
dataSource.elideSetAutoCommits=true
dataSource.maintainTimeStats=false
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-69b3ca93e755caee774ee61d37a37b29>2.4 - JDBC API</h1>
<h2 id=hikaricp-jdbc-logging>HikariCP JDBC Logging</h2>
<p>HikariCP 目前并不包含 JDBC 的日志记录。因为作者认为日志记录是性能杀手，甚至检查是否启用或禁用日志记录的布尔值对 HikariCP 来说也是多余的开销，几乎每个驱动程序都支持某种类型的日志记录，并且 ORM 框架也不可避免这样去做。</p>
<p>对于驱动程序不支持 JDBC 直接记录，或者希望此解决方案的灵活性优于数据库供应商的产品，log4jdbc-log4j2 是一个不错的选择。</p>
<p>另外还有 P6spy，它似乎略微比 log4jdbc-log4j2 更易于维护。</p>
<h2 id=jdbc>JDBC</h2>
<p>在 Vlad Mihalcea 的 &ldquo;High-Performance JavaPersistence&rdquo; 一书中给出了一张数据访问技术栈的图片，如图所示。我们可以看到 JDBC 在整个数据访问技术栈中起着非常重要的作用。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210714235606.png style=display:block;width:50% alt=NAME align=center> </div>
<p>JDBC 代表 Java 数据库连接，是基于 Java 开发的系统中程序员和数据库打交道的主要途径，提供了完备的数据库操作方法接口。</p>
<h2 id=jdbc-定义>JDBC 定义</h2>
<p>JDBC，Java DataBase Connectivity。</p>
<p>JDBC API 是一个 Java API，可以访问任何类型表列数据，特别是存储在关系数据库中的数据。</p>
<p>JDBC API 由一组用 Java 编写的类和接口组成。为工具/数据库开发人员提供标准 API 的编程语言，可以使用全 Java API 编写工业级数据库应用程序。JDBC API 可以轻松地将 SQL 语句发送到关系数据库系统，并支持所有 SQL 方言。但是 JDBC 2.0 API 超越了 SQL，也使得与其他类型的数据源(例如包含表格数据的文件)进行交互成为可能。</p>
<p>JDBC API 的价值在于，应用程序几乎可以访问任何数据源，并可以在任何具有 Java 虚拟机的平台上运行。换句话说，使用 JDBC API，不必编写一个程序来访问 Sybase 数据库，另一个程序访问 Oracle 数据库，另一个程序访问 IBM DB2 数据库，等等。</p>
<p>JDBC API 是 Java 编程语言与各种数据库之间数据库无关连接的行业标准。JDBC API 为基于 SQL 的数据库访问提供了调用级 API。JDBC 技术允许您使用 Java 编程语言为需要访问企业数据的应用程序提供“一次编写，随处运行”功能。</p>
<p>JDBC API 是一种执行 SQL 语句的 API, JDBC 驱动才是真正的接口实现，所有的网络逻辑和特定于数据库的通信协议都隐藏于、独立于供应商的 JDBC API 后面。Sun 公司只是提供了JDBC API，每个数据库厂商都有自己的驱动来连接自己公司的数据库，如图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000314.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们可以看到，JDBC API 采用了桥接的设计模式，提供了两套接口，JDBC Driver Planager 面向数据库厂商，如Oracle、SQL Seruer 等；JDBC API 面向 JDBC 使用者，如 Java Application。</p>
<p>JDBC 接口相当于实现化角色接口，数据库厂商实现的驱动相当于具体实现化子类，应用程序相当于抽象化角色，内部持有一个实现化角色的对象。桥接模式将实现化和抽象化解耦，从而让两个部分可以沿着不同的方向拓展，只要遵循接口即可，从而学习成本低。</p>
<p>JDBC 连接数据库时，在各个数据库之间进行切换，基本上不需要动太多的代码，甚至丝毫不动，原因就是 JDBC 提供了统一接口，每个数据库提供各自的实现，用一个叫作数据库驱动的程序来桥接就行了。</p>
<p>JDBC 定义了 4 种驱动类型：JDBC-ODBC 桥、本地 API 驱动、网络协议驱动、本地协议驱动。由于易于设置和调试，第 4 种类型本地协议驱动纯粹基于 Java 的多驱动程序，通过 Socket 连接与厂商的数据库进行通信，是首选的方案。</p>
<p>通过 DriverManager 获取连接：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000611.png style=display:block;width:70% alt=NAME align=center> </div>
<p>通过 DataSource 获取连接：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000647.png style=display:block;width:70% alt=NAME align=center> </div>
<p>由于减少了创建和关闭连接的开销，HikariCP 等数据库连接池的出现又将 JDBC 的性能大大提升了一个档次。使用数据库连接池作为 JDBC 的最佳实践已经几乎成了公认的标准。</p>
<p>除此之外，JDBC 的最佳实践还有如下内容：</p>
<ul>
<li>使用 PrearedStatement，通过预编译的方式避免在拼接SQL时造成SQL注入，使用“? ”或其他占位符等变量绑定的形式可以使用不同的参数执行相同的查询也能防止 SQL 注入。</li>
<li>禁用自动提交，这样可以将数据库操作放在一个事务中，而不是每次执行 SQL 语句都在执行结束时提交自己独立的事务。</li>
<li>JDBC 批处理可以降低数据库传输频率，进而提升性能。</li>
<li>使用列名而不是列序号获取 ResultSet 中的数据，避免 invalidColumIndexError，从而提升程序的健壮性、可读性。</li>
<li>在 Java 7 中，可以通过 Automatic ResourceManagement Block 来自动关闭资源。要记得关闭所有的Connection、Statement 等资源。</li>
<li>使用标准的 SQL 语句(如标准的ANSI SQL)，避免数据库对 SQL 支持的差异。</li>
</ul>
<h2 id=jdbc-剖析>JDBC 剖析</h2>
<p>JDK 规定了 JDBC 的相关接口，JDBC 是 SPI(服务提供者接口) 框架的良好应用。JDBC API 主要位于 JDK 中的 java.sql 包中，扩展的内容位于 javax.sql 包中。</p>
<p><code>java.sql.*</code> 采用传统的 C/S 体系结构思想设计它所包含的接口和类，核心类图如图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715000932.png style=display:block;width:70% alt=NAME align=center> </div>
<p>它包含生成连接、执行语句等功能，包括一些诸如批处理更新、可滚动结果集、事务隔离、封装 SQLException 等功能。<code>java.sql.*</code> 属于 JDBC2.0 之前，通常被称为 JDBC 内核 API; <code>javax.sql.*</code> 包括了 JDBC 3.0 的很多新特性，被称为 JDBC 标准扩展。</p>
<p><code>javax.sql.*</code> 作为标准扩展，提供了很多对<code>java.sql.*</code>的补充和新特性。体现在 Datasource 接口提供了一种可选择性的方式去建立连接，分布式事务处理，增加 rowset，增加连接池等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715001102.png style=display:block;width:70% alt=NAME align=center> </div>
<p>了解 JDBC，关注点更多的还是 <code>java.sql.*</code> 包，在这个包里，有 4 个核心接口(Driver、Connection、Statement和ResultSet)和两个核心类(DriverManager和SQLException)。类型的对象。它还提取与使用 Driver 对象相关的信息。不同的数据库有不同的装载方法。</p>
<ul>
<li><strong>DriverManager</strong>：管理一组数据库驱动程序的基本服务。使用通信子协议将来自 Java 应用程序的连接请求与适当的数据库驱动程序进行匹配。在 JDBC 下识别某个子协议的第一个驱动程序将用于建立数据库连接。其初始化时用到 ServiceLoader 机制，所以可以直接用 Class.forName(driver)；就可以完成加载驱动。在 DriverManager 里面，有一个 ArrayList，专门用来保存注册好的 Driver，并使用了 CopyOnWriteArrayList 来保证多线程环境下的线程安全。</li>
<li><strong>Driver</strong>：此接口处理与特定数据库服务器的通信，是每个数据库驱动都必须继承的接口。我们很少会直接与 Driver 对象进行交互。但会使用 DriverManager 对象来管理。</li>
<li><strong>Connection</strong>：此接口具有用于链接数据库的所有方法。连接(Connection)对象表示通信上下文，即，与数据库的所有通信仅通过连接对象。拥有创建 SQL 语句的方法，以完成基本的 SQL 操作，同时为数据库事务提供提交和回滚方法。
<ul>
<li><code>createStatement()</code>：创建向数据库发送 SQL 的 statement 对象。</li>
<li><code>prepareStatement(sql)</code>：创建向数据库发送预编译 SQL 的 PrepareSatement 对象。</li>
<li><code>prepareCall(sql)</code>：创建执行存储过程的 callableStatement 对象。</li>
<li><code>setAutoCommit(boolean autoCommit)</code>：设置事务是否自动提交。</li>
<li><code>commit()</code>：在连接上提交事务。</li>
<li><code>rollback()</code>：在此连接上回滚事务。</li>
</ul>
</li>
<li><strong>Statement</strong>：使用从此接口创建的对象将 SQL 语句提交到数据库。除了执行存储过程之外，一些派生接口还接受参数。它由 createStatement 创建，用于发送简单的 SQL 语句(不带参数)。除此以外，还有两种Statement：PreparedStatement 和 CallableStatement，如图上图所示．CallableStatement 继承自 PreparedStatement，PreparedStatement 继承自 Statement。
<ul>
<li><strong>PreparedStatement</strong>：PreparedStatement 接口扩展了 Statement 接口，它添加了比 Statement 对象更好一些的功能。此语句由 preparedStatement 创建，可以动态地提供/接受参数，进行 SQL 语句的预编译，也可以动态拼接。因为会进行预编译，所以当用动态拼接的时候，会对传入的参数进行强制转换，所以会对参数进行校验，可以避免 SQL 注入。开发的时候尽量用 preparedStatement，少用 statement。PreparedStatement 对象有能力使用提供参数数据的输入和输出流。它可以将整个文件输入数据库中，可容纳较大的值，如 CLOB 和 BLOB 数据类型的列。对于 PreparedStatement，会有一个 LRUCache 来存放，先到那里去取，取不到再创建一个新的，这个 LRUCache 的默认大小是 25。</li>
<li><strong>CallableStatement</strong>：由方法 prepareCall 创建，为所有的 DBMS 提供了一种以标准形式调用数据库储存过程的方法。</li>
<li>常用方法：
<ul>
<li><code>execute(String sql)</code>：运行语句，返回是否有结果集。</li>
<li><code>executeQuery(String sql)</code>：运行 select 语句，返回 ResultSet 结果集。</li>
<li><code>executeUpdate(String sql)</code>：运行 insert/update/delete 操作，返回更新的行数。</li>
<li><code>addBatch(String sql)</code>：把多条 SQL 语句放到一个批处理中。</li>
<li><code>executeBatch()</code>：向数据库发送一批 SQL 语句执行。</li>
</ul>
</li>
</ul>
</li>
<li><strong>ResultSet</strong>：在使用 Statement 对象执行 SQL 查询后，这些对象保存从数据库检索到的数据。它作为一个迭代器并可移动 ResultSet 对象查询的数据。但是结果集并不仅仅具有存储的功能，它同时还具有操纵数据的功能，可能完成对数据的更新等。
<ul>
<li><code>getString(int index)</code>、<code>getString(StringcolumnName)</code>：获得数据库里 varchar、char 等类型的数据对象。</li>
<li><code>getFloat(int index)</code>、<code>getFloat(StringcolumnName)</code>：获得数据库里 Float 类型的数据对象。</li>
<li><code>getDate(int index)</code>、<code>getDate(StringcolumnName)</code>：获得数据库里 Date 类型的数据。</li>
<li><code>getBoolean(int index)</code>、<code>getBoolean(StringcolumnName)</code>：获得数据库里 Boolean 类型的数据。</li>
<li><code>getObject(int index)</code>、<code>getObject(StringcolumnName)</code>：获取数据库里任意类型的数据。</li>
<li><code>next()</code>：移动到下一行。</li>
<li><code>previous()</code>：移动到前一行。</li>
<li><code>absolute(int row)</code>：移动到指定行。</li>
<li><code>beforeFirst()</code>：移动到 ResultSet 的最前面。</li>
<li><code>afterLast()</code>：移动到 ResultSet 的最后面。</li>
</ul>
</li>
<li><strong>SQLException</strong>：此类处理数据库应用程序中发生的任何错误。</li>
</ul>
<p>需要强调的是，Connection、Statement 和 Result 是一种“爷—父—子”的关系，对 Connection 的管理，就是对数据库资源的管理。如果想确定某个数据库连接(Connection)是否超时，则需要确定其(所有的)子 Statement 是否超时，同样，需要确定所有相关的 ResultSet 是否超时；Statement 关闭会导致 ResultSet 关闭，但是 Connection 关闭却不一定会导致 Statement 关闭。</p>
<p>在数据库连接池里，Connection 关闭并不是物理关闭，只是归还连接池，所以 Statement 和 ResultSet 有可能被持有，并且实际占用相关的数据库的游标资源。所以在关闭 Connection 前，需要关闭所有相关的 Statement 和 ResultSet。这就是 HikariCP 作者所强调的 JDBC 的最基本的规范，也是他创造 HikariCP 的原因，数据库连接池一定不能违背这样的规则。</p>
<p>最好方案就是顺序关闭 ResultSet、Statement、Connection；在 <code>rs.close()</code> 和 <code>stmt.close()</code> 后面加上 <code>rs= null</code> 和 <code>stmt = null</code> 来防止内存泄漏；RowSet 不依赖于 Connection 和 Statement 可以作为一种传递 ResultSet 的替代方案。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715002026.png style=display:block;width:50% alt=NAME align=center> </div>
<p>通过 DriverManger 获得 Connection，一个 Connection 对应一个实际的物理连接，每次操作都需要打开物理连接，使用完后立即关闭；这样频繁地打开/关闭连接会造成不必要的数据库系统性能消耗。</p>
<p>这样的背景下催生了数据库连接池的产生，数据库连接池提供的解决方案是：当应用启动时，主动建立足够多的数据库连接，并将这些连接组织成连接池，每次请求连接时，无须重新打开连接，而是从池中取出已有连接，使用完后并不实际关闭连接，而是将其归还给池。</p>
<p>所以这里需要涉及两项技术，<strong>一是连接使用 List 之类的集合进行初始化、装载和归还，二是使用动态代理来把资源归回给 List 集合。</strong></p>
<p>而HikariCP之所以这么快，也主要是将这两项技术做到了极致。</p>
<p>JDBC 数据库连接池使用<code> javax.sql.DataSource</code> 表示，DataSource 只是一个接口，其实现通常由服务器提供商(如WebLogic、WebShere)或开源组织(如 DBCP、c3p0 和 HikariCP)提供。</p>
<h3 id=preparedstatement--statement>PreparedStatement & Statement</h3>
<p>PreparedStatement 在企业开发中被强烈推荐使用，原因主要有以下方面：</p>
<ul>
<li>
<p>Statement 会频繁编译 SQL。如果 JDBC 驱动支持的话(一般来说数据库系统库系统初次分析、编译时会对查询语句做最大的性能优化), PreparedStatement 可对 SQL 进行预编译，提高效率，预编译的 SQL 存储在 PreparedStatement 对象中。从这个意义上来说，PreparedStatement 比 Statement 更快，使用 PreparedStatement 也可以降低生产环境的数据库负载。</p>
</li>
<li>
<p>Statement 对象编译 SQL 语句时，如果 SQL 语句有变量，就需要使用分隔符来隔开，如果变量非常多，就会使 SQL 变得非常复杂。PreparedStatement 可以使用占位符，通过动态参数化的查询来简化 SQL 的编写。比如下面这个参数化查询例子，通过使用相同的 SQL 语句和不同的参数值来做查询，比创建一个不同的查询语句要好。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>SELECT telephone_number FROM city WHERE username =?
</code></pre></div></li>
<li>
<p>PreparedStatement 可防止 SQL 注入。因为 Statement 对象需要拼接，通过分隔符“++”编写永等式就可以实现 SQL 注入；而 PreparedStatement 使用占位符，就不会有 SQL 注入的问题。</p>
</li>
</ul>
<h2 id=jdbc--spi>JDBC & SPI</h2>
<p>为了实现在模块装配的时候能不在程序里动态指明，需要一种服务发现机制。JDK 内置的 SPI(Service ProviderInterface)就能提供这样的一个机制：为某个接口寻找服务实现的机制。有点类似 IOC 的思想，就是将装配的控制权移到程序之外，在模块化设计中这个机制尤其重要。</p>
<p>JDBC 4.0 以前，开发人员还需要基于 <code>Class.forName(“xxx”)</code> 的方式来装载驱动，而 JDBC 4.0 基于 SPI 机制来发现驱动提供商，可以通过 <code>META-INF/services/java.sql.Driver</code> 文件里指定实现类的方式来暴露驱动提供者。开发者只需要编写一行代码，使用不同厂商的 jar 包，就可以轻松创建连接了。</p>
<h2 id=线程池技术>线程池技术</h2>
<p>池化技术，包括线程池、连接池、内存池、对象池等，其作用就是提前保存大量的资源，或者将用过的资源保存起来，等下一次需要使用该资源时再取出来重复使用。</p>
<p>线程池和连接池是两个不同的概念，连接池一般在客户端设置，而线程池是在如数据库这样的服务器上配置。通常来说，比较好的方式是将连接池和线程池结合起来使用。线程池具有线程复用、控制最大并发数、管理线程、保护系统4个优点，线程池的目的类似于连接池，通过复用线程来减少频繁创建和销毁线程，从而降低性能损耗。</p>
<p>线程池往往配合队列一起工作，限制并发处理任务的数量，从而保护系统。线程池的工作方式大同小异：先将任务提交到一个或者多个队列中，接着一定数量的线程从该队列中领取任务并执行，任务的结果再做处理，比如保存到MySQL数据库、调用别的服务等；任务完成以后，该线程会返回任务队列，等待下一个任务。</p>
<h3 id=mysql-线程池>MySQL 线程池</h3>
<p>传统方式下，MySQL 线程调度方式有两种：每个连接一个线程(One-Thread-Per-Connection)和所有连接一个线程(no-threads)。</p>
<p>MySQL 线程池是 MySQL 5.6 企业版的一个核心功能，是为了解决 One-Thread-Per-Connection 的实际生产常用选择的问题而引入的，通过有效管理大量客户端连接的语句执行线程数量，减少内存消耗，降低上下文切换(提高CPU Cache命中率)等来提高服务器性能。</p>
<p>在线程池 Thread Pool 处理方案中，最小单位是 statement，一个线程可以处理多个连接的请求，可以避免瞬间连接风暴造成的抖动。MySQL 线程池只在 Percona、MariaDB、Oracle 的 MySQL 企业版中提供，Oracle MySQL 社区版并不提供。MariaDB 在 5.5 版本中引入并最先实现线程池 Thread Pool 方案，Oracle 在 6.10 企业版本以 plugin 插件形式引入，Percona 在移植 MariaDB 的 Thread Pool 方案后又修复了一系列问题并优化了线程池性能。</p>
<p>使用“show variables like ‘thread%'”命令可以看到 thread_handling 的配置，默认情况是 one-thread-per-connection，即不启用线程池；将该参数设置为 pool-of-threads 即启用了线程池。</p>
<p>可以这么说，在 Percona 版本以后，MySQL 支持 No-Threads、One-Thread-Per-Connection 和 Pool-Threads 三种管理方式。Oracle Mysql 官方的性能测试表明：</p>
<ul>
<li>在并发达到 128 个连接以后．没有线程池的 MySQL 性能会迅速降低。使用线程池以后，性能不会出现波动，会一直保持在较好的状态运行。</li>
<li>在读写模式下，128 个连接以后，有线程池的 MySQL 比没有线程池的 MySQL 性能高出 60 倍。</li>
<li>在只读模式下，512 个连接以后，有线程池的 MySQL 比没有线程池的 MySQL 性能高出 18 倍。</li>
</ul>
<p>我们可以看到，Thread Pool 极大地提升了性能，并且解决了 One-Thread-Per-Connection 的如下 3 个问题：</p>
<ul>
<li>太多的线程堆栈使 CPU 缓存在高度并行的执行工作负载中几乎无用。线程池促进了线程堆栈重用，以最小化 CPU 缓存占用空间。</li>
<li>由于太多线程并行执行，因此上下文切换开销很高。这也给操作系统调度程序带来了挑战性的任务。线程池控制活动线程的数量，以使 MySQL 服务器内的并行性保持在它可以处理的水平，并且适用于 MySQL 正在执行的服务器主机。</li>
<li>并行执行的事务太多会增加资源争用。</li>
</ul>
<h3 id=mysql-线程池内部>MySQL 线程池内部</h3>
<p>排队理论中存在一个众所周知的关系：尝试访问共享资源的用户越多，响应时间越长，并呈指数级增长。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003135.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在吞吐量上，随着用户的不断增多，由于内部通信和同步，系统每秒能够处理的请求就越来越少，甚至会导致系统没有反应并且直接卡死，如图所示。众所周知的 DDoS 攻击就是类似这样的行为。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003154.png style=display:block;width:50% alt=NAME align=center> </div>
<p>而 MySQL 线程池在面对上述困难时，旨在提供如图所示的吞吐量曲线。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003217.png style=display:block;width:50% alt=NAME align=center> </div>
<p>MySQL 线程池本身并不会神奇地提高性能，但是它可以保护 MySQL 突然过载的情况，打造上图所示的稳定性曲线，这是通过其限制 MySQL 内部的工作线程数量来实现的。</p>
<p>如图下所示，这是 MySQL Thread Pool 的架构图，MySQL 的线程池提出了一个线程组的概念，工作线程被放在了线程组内部。我们可以看到 Thread Pool 由一个 Timer 线程和多个线程组构成，每个线程组内部由优先队列、普通队列两个队列，以及一个 Listener 线程和多个工作线程组成。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210715003309.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>线程组，在初始化以后会由底层的 IO 库分配到一个特殊的句柄 pollfd，每个线程组都有一个对应的 pollfd。</li>
<li>Worker 线程，是真正干活的线程，它具有活跃、空闲和等待3种状态。</li>
<li>Listener 线程，主要用来监听该线程组的语句，通过 pollfd 中轮询 IO 任务来决定是 Listener 线程自身处理这些任务，还是放入队列交给并唤醒多少个 Worker 线程去处理。从这个意义上来说，Listener 线程也是可以转换为 Worker 线程的。所以，线程组中，总线程数等于正在工作且未被阻塞的线程数+工作线程任务的过程中被阻塞的个数+空闲线程的个数 + Listener 线程的个数。</li>
<li>任务队列，由普通队列和优先任务队列构成，是 Listene r每次从 pollfd 轮询出来的就绪任务。官方定义将符合连接处于事务中和连接关联的 priority tickets 值大于 0 两种情况认为是优先队列。所以可以这么认为，如果同一个事务中有两个 insert的SQL，有 1 个已经执行，那么另一个 insert0 任务就会放在高优先级中。如果是非事务引擎，或者开启了 autocommit 的事务引擎，都会放到普通队列中。还有一种情况是如果语句在普通队列中停留太久，该语句也会移到优先队列中，防止它饿死，thread_pool_prio_kickup_timer 系统变量控制了这个“停留时间”，对每个线程组来说，语句停留的最大时间为 10ms。另外，还有一个 <code>priority tickets(thread_pool_high_prio_tickets)</code> 的设计，以优先的任务每次被放入优先队列中就对 priority tickets 减 1，以避免永久优先的问题。</li>
<li>Timer 线程，是一种 Check Stall 机制，用来周期性地检查 group 是否超时或阻塞状态，并通过检测线程组的负载来进行工作线程的唤醒和创建行。创建线程必须满足两个条件：其一，如果没有空闲线程且没有活跃线程则立刻创建，这种情况可能因为没有任何工作线程或者工作线程都被阻塞了，或者是存在潜在的死锁；其二，如果距离上次创建的时间大于一定阈值才创建线程，这个阈值由线程组内的线程数决定。</li>
</ul>
<p>介绍完 Thread Pool 架构和架构中的各个组件，我们再来看一下一次完整的用户请求是如何从数据库连接池进入 MySQL 的线程池，通过 Thread Pool 而进行运作的。</p>
<ol>
<li>在初始化时，MySQL 线程池根据宿主机的 CPU 核心数设置 thread_pool_size，并分成若干 group，每个 group 各自维护客服端发起的连接。当用户的请求通过数据库连接池访问到 MySQL 服务端时，MySQL 服务端再进行 <code>threadid % thread_pool_size</code> 取模计算，确定落在哪个线程组中。</li>
<li>线程组中的 Listener 线程监听到所在的线程组有新的请求后，检查队列中是否有请求还未处理，并决定是自己亲自转化为 Worker 线程进行处理，还是把这些任务放入队列中让 Worker 线程进行处理。在这个过程中先处理优先队列，再处理普通队列。如果任务队列不为空，Listener 线程还需要考虑应调度唤醒多少个工作线程。</li>
</ol>
<p>在以上两步中，还有两个自检程序在运行着。一个是 Worker 线程会自己判断最大空闲时间，如果超过最大空闲时间(默认60秒)就会退出；还有一个是 Timer 线程不断进行 CheckStall 机制，用来周期性地检查 group 是否处于超时或阻塞状态，并通过检测线程组的负载来进行工作线程的唤醒和创建。</p>
<h3 id=mysql-线程池实战>MySQL 线程池实战</h3>
<p>基本参数：</p>
<ul>
<li>thread_pool_size 是线程池性能最重要的参数，其设置线程池的 group 的数量，默认为系统CPU的个数。MySQL 官方文档给出的经验性建议[插图]是：如果主引擎(primary storage engine)为InnoDB, thread_pool_size 最佳设置可能为16～36，最常见的优化值倾向于24～36；如果主引擎为 MyISAM，那么 thread_pool_size 设置应该相当低。该值设置为4～8，倾向于获取最优性能。更高值设置对性能倾向于有点负面但不显著的影响。</li>
<li>thread_pool_stall_limit 表示 Timer Thread 检测 group 是否异常的时间间隔，默认是 500ms。其用来处理被阻塞和长时间运行的语句，确保服务器不会完全被阻塞。thread_pool_stall_limit 有个 6 秒的上限值，防止服务器死锁的风险。在合适范围内，该值越大，MySQL 服务器的整体处理性能就越好，因为较少数量的线程，会降低对于系统资源的征用。但是，并不是越大越好，因为该值越大，新线程的创建将等待时间越长，用户的查询延迟就会越明显。</li>
<li>thread_pool_max_threads 控制线程池的最大线程数，默认为 10000。若该值为 1000，代表线程池中所能创建的最大线程数不能超过 1000。</li>
<li>thread_handling 默认是 one-thread-per-connection，如果要使用连接池功能，则必须设置为 pool-of-threads。</li>
<li>thread_pool_oversubscribe 用于控制单个 CPU 核心在同一时间活跃的线程数。类似于一种“超频”的概念，默认值是 3。</li>
<li>thread_pool_idle_timeout 设置空闲线程销毁前的等待时间，单位为秒，默认是 60 秒。用户可以根据自己的业务场景来调整该参数的值。设置得太短，会导致线程频繁地销毁与创建；设置得太长，则会导致线程池中的线程数长时间不会下降。</li>
<li>thread_pool_idle_timeout 设置空闲线程销毁前的等待时间，单位为秒，默认是 60 秒。用户可以根据自己的业务场景来调整该参数的值。设置得太短，会导致线程频繁地销毁与创建；设置得太长，则会导致线程池中的线程数长时间不会下降。</li>
<li>extra_port 用于设置 MySQL 服务端口之外的端口，供管理员管理服务器。</li>
<li>extra_max_connections 用于设置 extra_port 端口允许的最大连接数，通过 extra_port 端口创建的连接，采用的是 one-thread-per-connection 的方式。</li>
<li>thread_pool_high_prio_mode，线程池分组内的待处理任务会放到任务队列中，等待 Worker 线程处理。每个分组有两个队列：优先队列和普通队列，Worker 线程先从优先队列取事务处理，只有当优先队列为空时才从普通队列取事务处理。通过优先队列，可以让已经开启的事务或短事务得到优先处理，及时提交释放锁等资源。该参数可设置为3种模式：
<ul>
<li>transactions。默认的，只有一个已经开启了事务的SQL，并且 thread_pool_high_prio_tickets 不为 0，才会进入优先队列中，每个连接在 thread_pool_high_prio_tickets 次被放到优先队列后，会移到普通队列中。</li>
<li>statements。单独的 SQL 总是进入优先队列。</li>
<li>none。禁用优先队列功能，所有的连接都放到普通队列中处理。</li>
</ul>
</li>
<li>thread_pool_high_prio_tickets，当 <code>thread_pool_high_prio_mode = transactions</code> 的时候，每个连接的任务最多被放入优先队列 thread_pool_high_prio_tickets 次，并且每放一次递减，直到小于等于 0 的时候放入普通队列，这个值默认是 4294967295。</li>
</ul>
<p>实战经验：</p>
<ul>
<li>在 Percona 5.7 的部分低版本中，如果开启了 Performance_Schema 和 ThreadPool 会出现内存泄漏问题，需要将 performance_schema 设置为 off 并重启 MySQL。</li>
<li>慢 SQL 导致线程池卡住。慢 SQL 的问题往往是压倒团队的“最后一根稻草”，慢 SQL 引发的惨痛故障不胜枚举，甚至造成资损。不符合规范的 SQL、全表查询、没建索引等都是可能造成慢 SQL 的原因，而 thread_pool_oversubscribe 可以暂时缓解这个问题。但是这咱方法治标不治本，根本解决方法还是开启 MySQL 服务端的日志，将慢SQL每天反馈给各个技术研发团队，甚至直接通过中间件过滤掉慢 SQL，不让其访问到 MySQL 服务端。</li>
<li>MySQL 主备切换及容灾演练。生产数据库往往会默认设置几千个连接数，可是如果发生业务洪峰、机房故障以后迅速重连导致的连接风暴等情况，都容易将 MySQL 的最大连接数和并发线程数迅速提高到峰值。业务上可以提前做好预案及压测，技术上可以考虑通过配置中心进行 MySQL 的多机房切换、主备切换及容灾，也可以做探测脚本，在即将达到最大连接数时进行及时的扩容。</li>
<li>调度死锁解决。引入线程池解决了多线程高并发的问题，但也带来一个隐患。假设，A、B 两个事务被分配到不同的 group 中执行，A 事务已经开始，并且持有锁，但由于 A 所在的 group 比较繁忙，导致A执行一条语句后，不能立即获得调度执行；而 B 事务依赖A事务释放锁资源，虽然B事务可以被调度起来，但由于无法获得锁资源，导致 B 仍然需要等待，这就是所谓的调度死锁。由于一个 group 会同时处理多个连接，但多个连接不是对等的。比如，有的连接是第一次发送请求，而有的连接对应的事务已经开启，并且持有了部分锁资源。为了减少锁资源争用，后者显然应该比前者优先得到处理，以达到尽早释放锁资源的目的。因此在 group 里面，可以添加一个优先队列，将已经持有锁的连接，或者已经开启的事务的连接发起的请求放入优先队列，工作线程首先从优先队列获取任务执行。</li>
<li>大查询处理。假设一种场景，某个 group 里面的连接都是大查询，那么 group 里面的工作线程数很快就会达到 thread_pool_oversubscribe 参数设置值，对于后续的连接请求，则会响应不及时(没有更多的连接来处理)，这时候 group 就发生了 stall。通过前面的分析知道，Timer 线程会定期检查这种情况，并创建一个新的 Worker 线程来处理请求。如果长查询来源于业务请求，则此时所有 group 都面临这种问题，此时主机可能会由于负载过大，发生 hang 住的情况。这种情况线程池本身无能为力，因为源头可能是烂 SQL 并发，或者 SQL 没有走对执行计划而导致，通过其他方法，比如 SQL 高低水位限流或者 SQL 过滤手段可以应急处理。但是，还有另外一种情况，就是 dump 任务。很多下游依赖于数据库的原始数据，通常通过 dump 命令将数据拉到下游，而这种 dump 任务通常都耗时比较长，所以也可以认为是大查询。如果 dump 任务集中在一个 group 内，并导致其他正常业务请求无法立即响应，这个是不能容忍的。因为此时数据库并没有压力，只是因为采用了线程池策略，才导致了请求响应不及时。为了解决这个问题，我们将 group 中处理 dump 任务的线程不计入 thread_pool_oversubscribe 累计值，即可避免上述问题。</li>
<li>thread_cache_size 设置优化。每建立一个连接，都需要一个线程来与之匹配，此参数用来缓存空闲的线程，以至不被销毁。如果线程缓存中有空闲线程，这时候如果建立新连接，MySQL 就会很快地响应连接请求。MySQL 如果采用多线程来处理并发的连接，那么采用 mysqlreport 的 Threads 部分可以看到线程创建的频率非常高。一个比较好的方法就是使用持久连接，这将在一定程度上减少线程的重复创建。将 thread_cache_size 从 0 适当地提高到一定的业务需求值，虽然每秒处理的连接数不变，但是创建的线程数可以大大减少，同时提高线程池的命中率。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4b9d150e32675cf552baf43c5f76029b>2.5 - 性能原理</h1>
<h2 id=为什么快>为什么快</h2>
<p>在 HikariCP 官网详细了介绍 HikariCP 所做的优化，总结如下：</p>
<ul>
<li><strong>优化并精简字节码、优化代码和拦截器</strong>。</li>
<li><strong>使用 FastList 替代 ArrayList</strong>。</li>
<li><strong>更好的并发集合类实现 ConcurrentBag</strong>。</li>
<li><strong>其他针对 BoneCP 缺陷的优化，比如对于耗时超过一个 CPU 时间片的方法调用的研究</strong>。</li>
</ul>
<h2 id=精简字节码>精简字节码</h2>
<p>HikariCP 的代码只有 130 Kb，它是一个轻量级数据库连接池。</p>
<p>HikariCP 利用了一个第三方的 Java 字节码修改类库 Javassist 来生成委托实现动态代理。</p>
<p>动态代理的实现在 <code>com.zaxxer.hikari.pool.ProxyFactory</code> 类，源码非常简单。如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ProxyFactory</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ProxyFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ProxyConnection</span> <span style=color:#000>getProxyConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FastList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Statement</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyLeakTask</span> <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isReadOnly</span><span style=color:#ce5c00;font-weight:700>,</span> 
                                              <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>){</span>  
    <span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Statement</span> <span style=color:#000>getProxyStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyConnection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span>
<span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>CallableStatement</span> <span style=color:#000>getProxyCallableStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyConnection</span>
<span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CallableStatement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>PreparedStatement</span> <span style=color:#000>getProxyPreparedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ProxyConnection</span>
<span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PreparedStatement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>static</span>  <span style=color:#000>ResultSet</span>  <span style=color:#000>getProxyResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>ProxyConnection</span>  <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span>  <span style=color:#204a87;font-weight:700>final</span>
<span style=color:#000>ProxyStatement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ResultSet</span> <span style=color:#000>resultSet</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//body部分被JavassistProxyFactory重新注入了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You need to run the CLI build and you
</span><span style=color:#4e9a06>need target/classes in your classpath to run.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这些代码基本代理了 JDBC 常用的核心接口，一共是 5 个：ProxyConnection、Statement、CallableStatement、PreparedStatement、ResultSet。并且每个方法都抛出了异常。其实每个方法都是抛异常之前都有一段 body，这段 body 是在编译时调用 JavassistProxyFactory 才生成的。</p>
<p>JavassistProxyFactory 存在于 <code>com.zaxxer.hikari.util</code> 包中，是 Javassist 的工具包，它主要有两个核心方法： generateProxyClass 方法负责生成实际使用的代理类字节码，<code>modifyProxyFactory</code> 对应修改工厂类中的代理类获取方法 <code>Proxy*.java</code> 为 <code>HikariProxy*. java</code>。这个工具包的作用是将 ProxyConnection、ProxyStatement、ProxyPreparedStatement、ProxyCallableStatement、ProxyResultSet 这 5 个 com.zaxxer.hikari.pool 包下代理类，利用 Javassist 重构后生成实际的 HikariCP 的对应代理类 HikariProxyConnection、HikariProxyStatement、HikariProxyPreparedStatement、HikariProxyCallableStatement、HikariProxyResultSet。</p>
<p>之所以使用 Javassist 生成动态代理，是因为其速度更快，比 JDK Proxy 生成的字节码更少，精简了很多不必要的字节码。</p>
<p>此外，HikariCP 在字节码工程中还对 JIT 进行了优化。比如，JIT 方法内联优化默认的字节码个数阈值是 35 字节，低于 35 字节才会进行优化。HikariCP 在精简字节码的时候，研究了编译器的字节码输出，甚至是 JIT 的汇编输出，以将关键部分限制为小于 JIT 内联阈值，展平了继承层次结构，阴影成员变量，消除了强制转换。</p>
<h2 id=fastlist>FastList</h2>
<p>HikariCP 一个性能方面的出彩优化突破就是 FastList。我们先看一组 HikariCP 中关于 FastList 的结论：</p>
<ol>
<li>当调用 <code>Connection.prepareStatement()</code> 的时候，新的 PreparedStatement 就被添加到 FastList。</li>
<li>当调用 <code>PreparedStatement.close()</code> 的时候，这个 statement 就从 FastList 中被移除。</li>
<li>如果调用 <code>Connection.close()</code> 的时候，任何未明确关闭的语句都将从 FastList 移除并关闭。</li>
</ol>
<p>但是 HikariCP 并没有拦截 <code>PreparedStatement.addBatch()</code> 方法，所以实际上 <code>addBatch()</code> 不可能添加任何内容到 FastList。executeBatch 方法即不会清除批处理，也不会将 PreparedStatement 从 FastList 中移除。唯一能够清除批处理的是<code> PreparedStatement.clearBatch()</code> 方法，而唯一能够从 FastList 移除 PreparedStatement 的方法就是调用 <code>PreparedStatement. close()</code> 或者 <code>Connection.close()</code> 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
     <span style=color:#000>PreparedStatement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(...))</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>something</span> <span style=color:#000>in</span> <span style=color:#000>somelist</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setString</span><span style=color:#ce5c00;font-weight:700>(...);</span>
        <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setInt</span><span style=color:#ce5c00;font-weight:700>(...);</span>
        <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBatch</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>batchCount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearBatch</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 记录异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上述代码所示，对于批处理语句执行清理的过程分为如下几步：<code>DataSource.getConnection()</code>、<code>Connection.prepareStatement()</code>、多次调用 <code>PreparedStatement.addBatch()</code>、<code>PreparedStatement.executeBatch()/clearBatch() </code>的调用、依赖 Java 7 的 try-with-resources 语法进行资源的清理。</p>
<p>FastList 是一个 List 接口的精简实现，只实现了接口中必要的几个方法。JDK ArrayList 每次调用 get() 方法时都会进行 rangeCheck，检查索引是否越界，FastList 的实现中去除了这一检查，只要保证索引合法那么 rangeCheck 就成为了不必要的计算开销(当然开销极小)。</p>
<p>此外，HikariCP 使用 List 来保存打开的 Statement，当 Statement 关闭或 Connection 关闭时需要将对应的 Statement 从 List 中移除。通常情况下，JDBC 在同一个 Connection 创建了多个 Statement 时，后打开的 Statement 会先关闭。这种情况从尾部开始扫描将表现更好。ArrayList 的 remove(Object) 方法是从头开始遍历数组，而 FastList 是从数组的尾部开始遍历，因此更为高效，它消除了范围检查，并从尾部到头部执行移除扫描。</p>
<p><strong>简而言之就是用自定义数组类型 FastList 代替 ArrayList：避免每次 get() 调用都要进行范围检查，避免调用 remove() 时的从头到尾的扫描。</strong></p>
<h2 id=concurrentbag>ConcurrentBag</h2>
<p>ConcurrentBag 取名来源于 C# .NET 的同名类，但是实现却不一样。它是一个 lock-free 集合，在连接池(多线程数据交互)的实现上具有比 LinkedBlockingQueue 和 LinkedTransferQueue 更优越的并发读写性能。它具有无锁设计、ThreadLocal 缓存、队列窃取、直接切换优化四大特点。</p>
<p>ConcurrentBag 采用了 queue-stealing 的机制获取元素：首先尝试从 ThreadLocal 中获取属于当前线程的元素来避免锁竞争，如果没有可用元素则再次从共享的 CopyOnWriteArrayList 中获取。此外，ThreadLocal 和 CopyOnWriteArrayList 在 ConcurrentBag 中都是成员变量，线程间不共享，避免了伪共享(false sharing)的发生。作者评价这款设计具有高度并发性，极低的延迟，并最大限度地减少了伪共享的发生。</p>
<p>ConcurrentBag 的性能提升主要源于如下 3 个组成部分：</p>
<ul>
<li>CopyOnWriteArrayList：负责存放 ConcurrentBag 中全部用于出借的资源。</li>
<li>ThreadLocal：用于加速线程本地化资源访问。</li>
<li>SynchronousQueue：用于存在资源等待线程时的第一手资源交接。</li>
</ul>
<h3 id=源码解析>源码解析</h3>
<p>ConcurrentBag 内部同时使用 ThreadLocal 和 CopyOnWriteArrayList 来存储元素，其中 CopyOnWriteArrayList 是线程共享的。</p>
<p>ConcurrentBag 采用了 queue-stealing 的机制获取元素：首先尝试从 ThreadLocal 中获取属于当前线程的元素来避免锁竞争，如果没有可用元素则扫描公共集合，再从共享的 CopyOnWriteArrayList 中获取。ThreadLocal 列表中没有被使用的 items 在借用线程没有属于自己的时候，是可以被“窃取”的。</p>
<p>ThreadLocal 和 CopyOnWriteArrayList 在 ConcurrentBag 中都是成员变量，线程间不共享，避免了伪共享的发生。</p>
<p>使用专门的 AbstractQueuedLongSynchronizer 来管理跨线程信号，这是一个 lock-less 的实现。</p>
<p>ConcurrentBag 通过 borrow 方法进行数据资源借用，通过 requite 方法进行资源回收，注意其中 borrow 方法只提供对象引用，不移除对象。所以从 bag 中“借用”的 items 实际上并没有从任何集合中删除，因此即使引用废弃了，垃圾收集也不会发生。因此使用时通过 borrow 取出的对象必须通过 requite 方法进行放回，否则会导致内存泄露，只有 remove 方法才能完全从 bag 中删除一个对象。</p>
<h4 id=concurrentbag-1>ConcurrentBag：</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210718151715.png style=display:block;width:80% alt=NAME align=center> </div>
<p>对 CopyOnWriteArrayList 的使用：通过 add 添加资源，通过 remove 方法借出资源：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210718151809.png style=display:block;width:80% alt=NAME align=center> </div>
<p>add 方法向 bag 中添加 bagEntry 对象，以供别人借用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ConcurrentBag has been closed, ignoring add()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ConcurrentBag has been closed, ignoring
</span><span style=color:#4e9a06>add()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//新添加的资源优先放入CopyOnWriteArrayList
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 当有等待资源的线程时，将资源交到某个等待线程后才返回（SynchronousQueue）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>handoffQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>yield</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>remove 方法从 bag 中删除一个 bagEntry，仅在 <code>borrow(long, TimeUnit)</code> 和 <code>reserve(T)</code> 时被调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>){</span>
		<span style=color:#8f5902;font-style:italic>// 如果资源正在使用且无法进行状态切换，则返回失败
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_REMOVED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> 
        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_RESERVED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_REMOVED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> 
        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Attempt to remove an object from the bag that was not borrowed or reserved: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 移出
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span> <span style=color:#000>removed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Attempt to remove an object from the bag that does not exist: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>removed</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// ConcurrentBag中通过borrow方法进行数据资源借用。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>borrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>timeUnit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 优先查看有没有可用的本地化的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>threadList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>weakThreadLocals</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>).</span>
    <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//优先从当前线程的ThreadLocal中获取连接，若获得则直接返回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#8f5902;font-style:italic>// 当无可用本地化资源时，遍历全部资源，查看是否存在可用资源
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#8f5902;font-style:italic>// 因此被一个线程本地化的资源也可能被另一个线程&#34;抢走&#34;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 因为可能&#34;抢走&#34;了其他线程的资源，因此提醒包裹进行资源添加
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>timeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 若现有资源全部在使用中，则等待一个被释放的资源或者一个新资源
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handoffQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NANOSECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> 
                <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>elapsedNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decrementAndGet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>requite</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 将状态转为未在使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#8f5902;font-style:italic>// 判断是否存在等待线程，若存在，则直接转手资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STATE_NOT_IN_USE</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>handoffQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>parkNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MICROSECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>yield</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 否则，进行资源本地化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>threadLocalList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>threadList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>threadLocalList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weakThreadLocals</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WeakReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#a40000>：</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=synchronousqueue>SynchronousQueue</h4>
<p>SynchronousQueue 来自于 JUC 并发包 java.util.concurrent，在 HikariCP 中的体现就是 ConcurrentBag 结构中的 handoffQueue，它主要用于存在资源等待线程时的第一手资源交接：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210718152506.png style=display:block;width:80% alt=NAME align=center> </div>
<p>SynchronousQueue 的初始化是在 ConcurrentBag 的构造方法中，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentBag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>IBagStateListener</span> <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>listener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>weakThreadLocals</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>useWeakThreadLocals</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handoffQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SynchronousQueue</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waiters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sharedList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weakThreadLocals</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>withInitial</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>withInitial</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FastList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IConcurrentBagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>SynchronousQueue 提供了以下两个构造函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SynchronousQueue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SynchronousQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>fair</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 通过fair值来决定公平和不公平
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 公平使用TransferQueue，不公平使用TransferStack
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>transferer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fair</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransferQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransferStack</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 HikariCP 中，选择的是公平模式 <code>this.handoffQueue = newSynchronousQueue&lt;>(true)</code>。公平模式总结下来就是：队尾入队队头出队，先进先出，体现公平原则。</p>
<p>SynchronousQueue 是一个无存储空间的阻塞队列(是实现 newFixedThreadPool 的核心)，非常适合做交换工作，生产者和消费者的线程同步以传递某些信息、事件或者任务。作为 BlockingQueue 中的一员，SynchronousQueue 的吞吐量高于 ArrayBlockingQueue 和 LinkedBlockingQueue，与其他 BlockingQueue 有着不同特性。</p>
<ul>
<li>SynchronousQueue 无存储空间。与其他 BlockingQueue 不同，SynchronousQueue 是一个不存储元素的 BlockingQueue。它的特点是每一个 put 操作必须要等待一个 take 操作或者 poll 方法，才能使用 off、add 方法，否则不能继续添加元素，反之亦然。</li>
<li>因为没有容量，所以对应 peek、contains、clear、isEmpty 等方法其实是无效的。例如 clear 是不执行任何操作的，contains 始终返回 false, peek 始终返回 null, peek 方法直接返回 null。</li>
<li>SynchronousQueue 分为公平和不公平，默认情况下采用不公平访问策略。当然也可以通过构造函数来设置为公平访问策略。</li>
<li>若使用 TransferQueue，则队列中永远会存在一个 dummynode。</li>
</ul>
<h4 id=copyonwritearraylist>CopyOnWriteArrayList</h4>
<p>CopyOnWriteArrayList 负责存放 ConcurrentBag 中全部用于出借的资源。顾名思义，Write 的时候总是要 Copy，也就是说对于任何可变的操作都是伴随复制这个动作的，这是 ArrayList 的一个线程安全的变体，底层通过复制数组的方式来实现。和 SynchronousQueue 一样，它也位于 java.util.concurrent 包下，为并发而生。CopyOnWriteArrayList 在遍历的时候不会抛出 ConcurrentModificationException 异常，并且遍历的时候就不用额外加锁，元素也可以为 null。</p>
<p>CopyOnWriteArrayList 底层是一个数组，通过 ReentrantLock 进行加锁，它初始化的时候底层是一个 <code>Object[] array</code>, <code>Object array</code> 指向一个大小为 0 的数组。一次 add 操作经历了 5 个步骤，都是在锁的保护下进行的，在添加的时候先上锁，拿到原数组并复制一个新数组(原数组大小+1)，增加操作在新数组上进行，最后再将 <code>Object array</code> 引用指向新数组，解锁。这样做是为了避免在多线程并发add的时候，复制多个副本出来，把数据搞乱了，导致最终的数组数据不是我们期望的。这是一种写时复制的理念。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>RandomAccess</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cloneable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//可重入锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#8f5902;font-style:italic>//非private，得到数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#8f5902;font-style:italic>//设置数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CopyOnWriteArrayList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span> <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#8f5902;font-style:italic>//初始化
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//1）加锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getArray</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//得到原数组的长度和元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//2）复制数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//3）将元素加入到新数组中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>setArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newElements</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//4）将array引用指向到新数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//5）解锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>插入、删除、修改操作也都是一样，每一次的操作都是以对Object[] array进行一次复制为基础的。写加锁，读不加锁。由于所有的写操作都是在新数组进行的，这个时候如果有线程并发的写，则通过锁来控制。如果有线程并发的读，则分以下几种情况：</p>
<ul>
<li>如果写操作未完成，那么直接读取原数组的数据。</li>
<li>如果写操作完成，但是引用还未指向新数组，那么也是读取原数组数据。</li>
<li>如果写操作完成，并且引用已经指向了新的数组，那么直接从新数组中读取数据。</li>
</ul>
<p>CopyOnWriteArrayList 非常适用于数据库连接池这种读操作远远多于修改操作的场景，它反映的是 3 个十分重要的分布式理念：</p>
<ul>
<li>读写分离。读取 CopyOnWriteArrayList 的时候，读取的是 CopyOnWriteArrayList 中的 <code>Object[] array</code>，但是修改的时候，操作的是一个新的 <code>Object[] array</code>。读和写操作的不是同一个对象，这就是读写分离。这种技术数据库用的非常多，在高并发下为了缓解数据库的压力，即使做了缓存也要对数据库做读写分离，读的时候使用读库，写的时候使用写库，然后读库、写库之间进行一定的同步，这样就避免同一个库上读、写的 IO 操作太多。</li>
<li>最终一致。对 CopyOnWriteArrayList 来说，线程1读取集合里面的数据，未必是最新的数据。因为线程2、线程3、线程4都修改了 CopyOnWriteArrayList 里面的数据，但是线程1拿到的还是最老的那个 <code>Object[] array</code>，新添加进去的数据并没有，所以线程1读取的内容未必准确。不过这些数据虽然对于线程1是不一致的，但是对于之后的线程一定是一致的，它们拿到的 <code>Object[] array</code> 一定是3个线程都操作完毕之后的 <code>Object array[]</code>，这就是最终一致。最终一致对于分布式系统也非常重要，它通过容忍一定时间的数据不一致，提升整个分布式系统的可用性与分区容错性。当然，最终一致并不是任何场景都适用的，像火车站售票这种系统用户对于数据的实时性要求非常非常高，就必须做成强一致性的。</li>
<li>使用另外开辟空间的思路，来解决并发冲突。</li>
</ul>
<p>但是它有着以下缺点：</p>
<ul>
<li>因为 CopyOnWrite 的写时复制机制，所以在进行写操作的时候，内存里会同时驻扎两个对象的内存，旧的对象和新写入的对象（注意：在复制的时候只是复制容器里的引用，只是在写的时候会创建新对象添加到新容器里，而旧容器的对象还在使用，所以有两份对象内存）。如果这些对象占用的内存比较大，比如200M左右，再写入100M数据，内存就会占用300M，那么这个时候很有可能造成频繁的Yong GC和Full GC。</li>
<li>不能用于实时读的场景，像复制数组、新增元素都需要时间，所以调用一个 set 操作后，读取到数据可能还是旧的。虽 CopyOnWriteArrayList 能做到最终一致性，但是还是没法满足实时性要求。所以如果你希望写入的的数据马上能读到，就不要使用 CopyOnWrite 容器。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-15ec1a8762b47ae9a5a642074c2fb45b>2.6 - 优化原理</h1>
<h2 id=获取连接>获取连接</h2>
<p>HikariCP 可以被理解为一个简单的 BlockingQueue，它实际上并没有使用 BlockingQueue，而是使用了一种被称为 ConcurrentBag 的专用集合，但在行为概念上是类似的。在这个 BlockingQueue 的模型上，可以想象你的客户端调用 HikariDataSource 的 getConnection 方法执行着如下的工作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>显然会有更多的事情发生，比如抛出超时异常等，如上是基本的思路。调用 Connection.close 方法实质上返回到池的连接，同样，还有很多具体细节，但概念是相通的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariCP 确实有几个自己的线程，有一个 HouseKeeper 管家线程定期运行以退出空闲连接，有一个调度线程可以退出到达 maxLifetime 的连接，还有一个用于添加连接的线程，以及一个用于关闭它们的线程等。接下来，我们从获取连接部分开始仔细研究源码级的原理。</p>
<p>获取连接是 HikariCP 的核心功能，HikariDataSource 对象首先通过 getConnection 方法获得 HikariPool 真正的 getConnection 方法，HikariPool 内部通过我们介绍过的 ConcurrentBag 的 borrow 方法获取 PoolEntry，它将首先尝试从线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。最后通过 PoolEntry 执行 Create Proxy Connection 方法创建一个物理连接并返回其代理连接 Proxy Connection。具体的时序图如图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719225932.png style=display:block;width:80% alt=NAME align=center> </div>
<p>HikariDataSource，顾名思义，就是 HikariCP 对外提供给用户的定制化的 DataSource，使用 Spring 的用户可以直接将它作为数据源。用户也可以直接初始化 HikariDataSource：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>HikariDataSource</span> <span style=color:#000>ds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HikariDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setJdbcUrl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbc:mysql://localhost:3306/simpsons&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bart&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPassword</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;51mp50n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>HikariDataSource 继承了 HikariConfig，并且实现了 JDCB 基础中介绍过的 javax.sql 扩展包中的 DataSource 接口。作为 DriverManager 设施的替代项，DataSource 对象是获取连接的首选方法，实现 DataSource 接口的对象通常在基于 JavaTM Naming and Directory Interface (JNDI) API 的命名服务中注册。</p>
<p>HikariConfig 是 HikariCP 的配置管理核心类，它实现了 HikariConfigMXBean 接口，用来对外暴露 HikariCP 配置相关的 JMX 监控和管理功能。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719230214.png style=display:block;width:70% alt=NAME align=center> </div>
<p>在创建连接的过程中，有几个细节性的问题可以从源码级重点关注一下。</p>
<h3 id=细节单例池初始化>细节：单例池初始化</h3>
<p>HikariDataSource 获取连接 getConnection 的单例处理。大家都知道，在实现单例模式时，如果未考虑多线程的情况，很可能会造成实例化了多次并且被不同对象持有。在 JDK1.5 或者更晚的版本中，扩展了 volatile 的语义，使用了 volatile 关键字后，重排序被禁止，双重检查锁可以减少开销。如果没有 volatile 关键字则可能由于指令重排导致 HikariPool 对象 pool 在多线程下无法正确地初始化，volatile 禁止了指令重排，并强制本地线程读取主存。由于数据库连接池处于一个激烈的被频繁调用的位置，HikariCP 的源码部分就使用双重检查锁进行单例初始化。以下是 HikariDataSource 中的部分源码代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HikariPool</span> <span style=color:#000>fastPathPool</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>HikariPool</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//注意这里引入了volatile
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isClosed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>//检查数据源是否已经关闭，如果关闭则抛出异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;HikariDataSource &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; has been
</span><span style=color:#4e9a06>closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fastPathPool</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//如果当前引用HikariPool不为空，则直接返回连接
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fastPathPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>HikariPool</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//典型的双重检验锁代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>validate</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//参数校验，主要是检查参数是否合法并给予默认值
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                      <span style=color:#000>pool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HikariPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//初始化连接池
</span><span style=color:#8f5902;font-style:italic></span>                      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>seal</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PoolInitializationException</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Start completed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//从连接池中返回一个连接，返回给HikariPool资源池与ConcurrentBag进行交互
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=细节连接有效性>细节：连接有效性</h3>
<p>另一个细节是获取连接时的有效性检查。当从资源池里面获取到资源后，需要检查该资源的有效性，如果失效，则再次获取连接，这样可以避免执行业务的时候报错。这部分的工作是由 HikariPool 做的，它通过判断 PoolEntry 是否已经被标记清除了、当前 PoolEntry 的存活时间是否过期及当前连接是否活着 3 项进行判断，如果超时则关闭这个 PoolEntry 的连接、重置超时时间、再次获取连接。这部分的核心实现在 HikariPool 的 getConnection 方法里，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hardTimeout</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//从connectionBag中借用连接，借用过程中会发生创建连接、连接过期、空闲等事情
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>borrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//中断，跳出循环，并抛出异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>now</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//记录当前时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastAccessed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>aliveBypassWindowMs</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isConnectionAlive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//有效性检查
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>EVICTED_</span> <span style=color:#000>CONNECTION_MESSAGE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>DEAD_CONNECTION_MESSAGE</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//关闭当前失效连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hardTimeout</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//重置超时时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//借用的连接若未过期未丢弃进入此逻辑，则设置metrics监控指标
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>metricsTracker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recordBorrowTimeoutStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>//最核心部分，通过代理创建连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createProxyConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leakTaskFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//只要超时时间大于0则不断重试
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>createTimeoutException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//抛出创建连接超时异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上述代码中，有效性检查的部分是 isConnectionAlive，在这里用户可以自行配置心跳语句的检测，如果追求极致性能，那么使用 JDBC4 的用户还是强烈建议不要配置心跳语句，而是采用 HikariCP 默认的 com.mysql.jdbc. JDBC4Connection 的 isValid 实现，因为它的实现是 ping 命令，一般来说原生 ping 命令的性能是 select 1 的两倍。刚才我们看到的 HikariPool 的 getConnection 方法，其心跳语句检测的 isConnectionAlive 是在其父类中实现的，核心代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isConnectionAlive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>setNetworkTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>validationSeconds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationTimeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isUseJdbc4Validation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//如果是JDBC4，则直接使用ping命令进行验证
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isValid</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>validationSeconds</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//性能可以大大提升
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStatement</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isNetworkTimeoutSupported</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TRUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>setQueryTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationSeconds</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnectionTestQuery</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//否则执行测试语句验证
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>setNetworkTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>networkTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isIsolateInternalQueries</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lastConnectionFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Failed to validate connection {} ({}). Possiblyconsider using a shorter maxLifetime value.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>poolName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码中有一个 validationTimeout 属性，默认值是 5000 毫秒，所以默认情况下 <code>final int validationSeconds = (int)Math.max(1000L, validationTimeout) / 1000</code> 它的值应该为 1～5 秒。又由于 validationTimeout 的值必须小于 connectionTimeout(默认值30000毫秒，如果小于250毫秒，则被重置回30秒)，所以默认情况下，调整 validationTimeout 却不调整 connectionTimeou t情况下，validationSeconds 的默认峰值应该是 30 毫秒。</p>
<p>如果是 JDBC4 的话，使用 isUseJdbc4Validation(就是 <code>config.getConnectionTestQuery()== null</code> 的时候)，用 <code>connection.isValid(validationSeconds)</code> 来验证连接的有效性，否则的话则用 connectionTestQuery 查询语句来查询验证。</p>
<h3 id=细节创建形式>细节：创建形式</h3>
<p>第 3 个细节就是连接的创建。连接的创建可以同步创建，也可以异步创建，这与 HikariCP 的配置息息相关，这也是 HikariCP 作者别具匠心的设计之处。</p>
<h3 id=过程总结>过程总结</h3>
<ol>
<li>实现了 JDBC 扩展包 javax.sql 的 DataSource 接口的 HikariDataSource，执行 getConnection 方法时会进行 Double-checked_locking 单例、配置检查等流程，再向 HikariPool 资源池请求获取连接。</li>
<li>HikariPool 则向其 lock-free 的资源集合 ConcurrentBag 借用 PoolEntry，若没有 poolEntry 则超时抛出异常，若有 poolEntry 则创建一个 JDBC 代理连接 ProxyConnection。</li>
<li>ProxyConnection 是由 ProxyFactory 产生的，它是一个生产标准 JDBC 接口代理的工厂类，HikariDataSource 最终获取的 Connection 连接就是代理工厂返回的 JDBC 物理连接，而 poolEntry 就是对这个物理连接的一对一封装。</li>
</ol>
<h3 id=连接有效性>连接有效性</h3>
<p>Java.sql.Connection 的 isValid() 和 isClosed() 区别：</p>
<ul>
<li>isValid：如果连接尚未关闭并且仍然有效，则返回true。驱动程序将提交一个关于该连接的查询，或者使用其他某种能确切验证在调用此方法时连接是否仍然有效的机制。由驱动程序提交的用来验证该连接的查询将在当前事务的上下文中执行。
<ul>
<li>参数：timeout。等待用来验证连接是否完成的数据库操作的时间，以秒为单位。如果在操作完成之前超时期满，则此方法返回 false。0值表示不对数据库操作应用超时值。</li>
<li>返回：如果连接有效，则返回 true，否则返回 false。</li>
</ul>
</li>
<li>isClosed：查询此 Connection 对象是否已经被关闭。如果在连接上调用了 close 方法或者发生某些严重的错误，则连接被关闭。只有在调用了 Connection.close 方法之后被调用时，此方法才保证返回 true。通常不能调用此方法确定到数据库的连接是有效的还是无效的。通过捕获在试图进行某一操作时可能抛出的异常，典型的客户端可以确定某一连接是无效的。
<ul>
<li>返回：如果此 Connection 对象是关闭的，则返回 true；如果它仍然处于打开状态，则返回 false。</li>
</ul>
</li>
</ul>
<h3 id=连接监控>连接监控</h3>
<p>HikariPool 继承了 PoolBase，实现了 HikariPoolMXBean 接口用于对外暴露 HikariCP 连接池相关的监控管理功能：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719231458.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=归还连接>归还连接</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719231944.png style=display:block;width:70% alt=NAME align=center> </div>
<p>连接的归还和连接的借用是两个大致相反的过程，归还部分的源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//由于关闭语句可能导致连接被驱逐，所以优先执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCommitStateDirty</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//如果存在脏提交或者没有自动提交，则连接回滚
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>lastAccess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Executed rollback on connection {} due to dirty commit state on close().&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dirtyBits</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetConnectionState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dirtyBits</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>lastAccess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearWarnings</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//当连接中止时，通常会抛出不适用于应用程序的异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>checkException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//这里开始调用PoolEntry的recycle方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recycle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastAccess</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 ProxyConnection 代理层获取到的连接，进行归还时调用了代理层的 close 方法。HikariCP 归还连接是一系列没有返回值的 void 操作，ProxyConnection 的 close 方法并没有直接调用 JDBC 的 close 方法，而是依次调用了 PoolEnry 的 recycle 方法、HikariPool 的 recycle 方法及 ConcurrentBag 的 requite 方法，这一系列方法传递的参数都是 PoolEntry。</p>
<p>数据库连接池 HikariCP 的 close 方法返回的连接其实是封装在这个 ProxyConnection 代理连接中的，当调用它的时候，它只返回与池的连接，但是依然保持与数据库的基础连接是打开的。数据库连接池通常都是以这种方式工作的，数据库连接池的性能优势就是来自于连接保持打开，通过代理连接，对用户来说是透明的。如果需要关闭这个连接，可以将它先转换为 ProxyConnection，然后调用它的 unwrap 方法，最后关闭这个内部连接。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//ProxyConnection内部提供的unwrap方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
		
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Wrapped connection is not an instance of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>unwrap 是一个很有意思的工具，如果你想跳过代理获取数据库的源信息，那么还可以直接使用 JDBC 的 unwrap 的 API 来获取(这里不是 ProxyConnection 的 unwrap )。如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConnectionProperties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConnectionProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span>
	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNullCatalogMeansCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>在归还连接的代码中，也存在很多细节。比如代理层的 close 方法第 1 行就这么讲究：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//由于关闭语句可能导致连接被驱逐，所以优先执行
</span></code></pre></div><p>本书前面章节介绍的 HikariCP 诞生的理由——很多数据库连接池违反了 JDBC 规范。当 Connection 连接 close 或者 return 时，清除警告或回滚未提交的事务时，一些数据库连接池并不会自动关闭语句 Statement，并且它们也不会重置用户更改过的属性，如自动提交或事务隔离级别等，从而导致下一个消费者获得“脏”连接。</p>
<p>JDBC 最佳实践中有一条就是最顺序关闭 ResultSet、Statement、Connection。因此，在 HikariCP 中，ProxyConnection 的源码中，它的 close 方法覆盖了 java.sql.Connection 的方法，覆盖 JDBC 的 close 方法时，第一件事就是关闭了 Statement 语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>(){</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>ignored</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//自动资源清理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Connection {} marked as broken because of an exception closing open statements during Connection.close()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;(exception closing Statements during Connection.close())&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上述 closeStatements 的具体方法实现里，在执行 clear 之前，将所有不是关闭状态的 Statement 都遍历了一遍，进行了资源的自动清理，对于遇到异常的连接，PoolEntry 对象标记具体问题原因是关闭 Statement 时产生的，并将连接设置为关闭状态。</p>
<p>从 ProxyConnection 覆盖 JDBC 的 close 方法，一步步调用到了 ConcurrentBag 的 requite 方法放回，就像后者方法前的注释说的那样：“有借必有还。如果你只借不还，那么就会导致内存泄漏。”</p>
<p>结合连接时序图和归还连接时序图我们可以发现，PoolEntry 对象通过 borrow 方法从 ConcurrentBag 中取出，再通过 requite 方法被放回，有借有还。当线程调用 getConnection 的时候，会调用 ConcurrentBag 的 borrow 方法，它将首先尝试从该线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。</p>
<p>当关闭连接时，又会通过 remove 方法删除 PoolEntry。ConcurrentBag 就是 HikariCP 的数据库连接存储结构，它在 HikariCP 中起着举足轻重的作用，其性能直接决定 HikariCP 的整体性能。</p>
<h2 id=关闭连接>关闭连接</h2>
<p>在可以热部署的 Web 应用程序中，关闭 DataSource 非常重要。通常可以调用 HikariDataSource 实例的 shutdown 或者 close 方法，也可以配置 Spring 或其他 IOC 容器来指定 destroy 方法。<strong>一旦 Connection 进入关闭连接阶段，它立即从池中被移除，但是仍然和数据库 DB 有活动连接，直到 Connection.close 完成。HikariCP 永远不会杀死正在使用的连接，除非池本身被关闭。</strong></p>
<p>关闭分为 HikariDataSouce 和 HikariPool 两种关闭，这两者截然不同。</p>
<p>HikariDatasource 作为 HikariCP 对外对使用方提供的 DataSource，它的 close 方法是粗暴的 shutdown 操作。其 close 方法就是直接关闭数据源及其连接池，源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>(){</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isShutdown</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>HikariPool</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Shutdown initiated...&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Shutdown completed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Interrupted during closing&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariDataSouce 的 close 直接调用了 HikariPool 的 shutdown 操作，其具体实现在 HikariPool 的 shutdown 方法里，不但关闭连接池，还关闭了所有空闲连接，中止或关闭活动连接。此外，它还会进行直接取消定时任务、关闭 ConcurrentBag 等一系列清理工作，可以认为就是一个 shutdown 的强硬操作。HikariPool 的 shutdown 源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>POOL_SHUTDOWN</span><span style=color:#ce5c00;font-weight:700>;</span>
  
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//如果连接池从未启动
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  
      <span style=color:#000>logPoolState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Before shutdown &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>houseKeeperTask</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//关闭houseKeeper的任务
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>houseKeeperTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>houseKeeperTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  
      <span style=color:#000>softEvictConnections</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//软驱逐连接
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//关闭增加连接线程池
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getLoginTimeout</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>destroyHouseKeepingExecutorService</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//关闭connectionBag
</span><span style=color:#8f5902;font-style:italic></span>  
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>assassinExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(),</span> 
          <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; connection assassinator&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThreadFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> 
          <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CallerRunsPolicy</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>abortActiveConnections</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>softEvictConnections</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>shutdownNetworkTimeoutExecutor</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logPoolState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;After shutdown &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>handleMBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>metricsTracker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>与 HikariDataSource 对外提供的 close 接口不同，HikariPool 提供的内部 closeConnection 方法才是我们通常意义上理解的数据库连接池内部的连接关闭逻辑。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210902213134.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当 HikariPool 执行 closeConnection 方法时，首先先从 ConcurrentBag 中移除 PoolEntry，然后 PoolEntry 自身 close，接着独立线程池 closeConnectionExecutor(本质是ThreadPoolExecutor) 调用 JDBC 的方法进行物理连接的关闭。如果 poolState 的状态为 0，还会使用另一个独立线程池 addConnectionExecutor(与 closeConnectionExecutor 对称，本质上也是 ThreadPoolExecutor)进行新连接的生成，fillPool 补足到 HikariCP 的配置值。其核心源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>closureReason</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//ConcurrentBag移除poolEntry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//poolEntry关闭
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>quietlyCloseConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>closureReason</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//jdbc关闭连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>POOL_NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>fillPool</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//填充连接池
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到 HikariCP 使用了线程池 closeConnectionExecutor 进行了物理连接的关闭。其实在 HikariCP 的源码里，closeConnectionExecutor 还有一个孪生兄弟 addConnectionExecutor，在 com.zaxxer.hikari.pool.HikariPool 的源码中构造函数初始化的时候就可以看到 <code>public HikariPool(final HikariConfigconfig)</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadPoolExecutor</span> <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadPoolExecutor</span> <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//......
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>addQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addConnectionQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unmodifiableCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;connection adder&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DiscardPolicy</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(),</span> 
  <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; connection closer&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CallerRunsPolicy</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>addConnectionExecutor 和 closeConnectionExecuto r的初始化就是命中了Java 5 种线程池、4 种拒绝策略、3 种阻塞队列的知识点。addConnectionExecutor 用于创建物理连接，它使用了 DiscardPolicy 策略，默认情况下它就是丢弃被拒绝的任务，实际上就是任务满了就不会抛出异常；而 closeConnectionExecutor 用了 CallerRunsPolicy 策略，如果添加到线程池失败，主线程会直接在 execute 方法的调用线程中运行被拒绝的任务，若执行程序已关闭，则会丢弃该任务。</p>
<p>使用 HikariCP 的用户可能经常会看到类似 connection isevicted or dead 这样的异常，其实这是合理的，关闭死连接对于连接池的资源清理至关重要。</p>
<p>HikariCP 关闭连接的 5 种情况：</p>
<ul>
<li>连接验证失败。这对应用程序是不可见的。连接已停用并已替换。用户会看到一条日志消息：“Failed tovalidate connection&mldr;”。</li>
<li>连接达到了其 maxLifetime。这对应用程序是不可见的。连接已停用并已替换。用户会看到一个关闭原因：“connection has passed maxLifetime”，或者如果在到达时 maxLifetime 正在使用该连接，用户会晚一点看到原因：“connection is evicted or dead”。</li>
<li>用户手动驱逐连接。这对应用程序是不可见的。连接已停用并已替换。用户会看到关闭的原因：“connectionevicted by user”。</li>
<li>JDBC 调用引发了无法恢复的问题 SQLException。这应该对应用程序可见。用户会看到关闭的原因：“connection is broken”。</li>
</ul>
<h2 id=生成连接>生成连接</h2>
<p>独立的线程池 addConnectionExecutor 用于创建物理连接，它是在 HikariPool 的构造函数中被初始化的。HikariPool 中的 addConnectionExecutor 在 addBagItem() 和 fillPool() 的时候进行新的物理连接的创建。addBagItem 代表向我们之前介绍的 HikariCP 的数据结构 ConcurrentBag 中放置 Bag 项，它的源码实现其实是在 ConcurrentBag 的 borrrow 也就是连接的借用时执行的。核心代码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//如果我们已经窃取了另一个等待着的连接，那么请求会新增另一个bag
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>在上述代码中，有两处分别执行了 <code>listener.addBagItem(waiting-1)</code> 和 <code>listener.addBagItem(waiting)</code>，当有并发连接产生时，如果存在等待的连接或者连接已经不可用，则会进行物理连接的创建。</p>
<p>另一个 addConnectionExecutor 在 addBagItem() 来源于 HikariPool 的 fillPool 的方法，它是来源于 HikariPool 内部的单独线程 HouseKeeper，用来将当前的数据库连接池从当前的空闲连接填充到最小空闲连接的指标。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fillPool</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>connectionsToAdd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinimumIdle</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>getIdleConnections</span><span style=color:#ce5c00;font-weight:700>())</span>
                              <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>addConnectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>connectionsToAdd</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>connectionsToAdd</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
<span style=color:#000>poolEntryCreator</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postFillPoolEntryCreator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>PoolEntry 是一个封装了物理连接的对象，在 HikariPool 中定义了两个 PoolEntry，分别代表我们刚才介绍的连接生成的两种场景(addBagItem 和 fillPool)：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span>  <span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>PoolEntryCreator</span>  <span style=color:#000>poolEntryCreator</span>  <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#204a87;font-weight:700>new</span>  <span style=color:#000>PoolEntryCreator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#a40000>＊</span><span style=color:#000>logging</span> <span style=color:#000>prefix</span><span style=color:#a40000>＊</span><span style=color:#ce5c00;font-weight:700>/);</span>
<span style=color:#204a87;font-weight:700>private</span>  <span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>PoolEntryCreator</span>  <span style=color:#000>postFillPoolEntryCreator</span>  <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#204a87;font-weight:700>new</span>  <span style=color:#000>PoolEntryCreator</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;After adding &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>addConnectionExecutor 线程调用 HikariPool 的 createPoolEntry 方法进行连接生成，HikariPool 继承的父类 PoolBase 提供的 newPoolEntry 会先进行物理连接的创建，创建完成以后的连接会被封装为 PoolEntry 后放入ConcurrentBag。createPoolEntry 的源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>createPoolEntry</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPoolEntry</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxLifetime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 设置maxlifetime的2.5%的差额
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>variance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>nextLong</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>40</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//随机数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>lifetime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>variance</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFutureEol</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>houseKeepingExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//设置异步任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>softEvictConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;(connection has passed
</span><span style=color:#4e9a06>maxLifetime)&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#a40000>＊</span> <span style=color:#000>not</span> <span style=color:#000>owner</span> <span style=color:#a40000>＊</span><span style=color:#ce5c00;font-weight:700>/))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                          <span style=color:#000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWaitingThreadCount</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>},</span>
                <span style=color:#000>lifetime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConnectionSetupException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>POOL_NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//如果shutdown()同时运行，我们检查POOL_NORMAL以避免消息泛滥
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Error thrown while acquiring connection from data
</span><span style=color:#4e9a06>source&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>lastConnectionFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//设置上一次连接失败的异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariCP 的 maxLifetime 默认是 1800000毫秒(30分钟)。在上述代码中，有一段重要的随机数逻辑，这段代码主要就是根据 maxLifetime 的 2.5% 来设置一个差额，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 设置maxlifetime的2.5%的差额
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>variance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>().</span>
<span style=color:#000>nextLong</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>40</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//随机数
</span></code></pre></div><p>连接生成的时候让每个连接的最大存活时间错开一点，防止同时过期，加一点点随机因素，防止一件事情大量同时发生，比如防止 HikariCP 的连接同时大量死亡。如果 maxLifetime 大于 10000 就是大于 10 秒钟，就执行这个策略，用 maxLifetime 的 2.5% 的时间和 0 之间的随机数来随机设定一个 variance，在 maxLifetime - variance 之后触发 evict。比如，配置 maxLifetime 为 15 分钟时，HikariCP 为每个连接最大寿命注入了 2.5% 的变化，寿命为 15 分钟时，相当于 22.5 秒的变化。一些连接可能在 14 分 38 秒退休，其他连接可能在 14 分 53 秒退休等。</p>
<p>在创建 poolEntry 的时候，注册了一个延时任务，在连接存活将要到达 maxLifetime 之前触发 evit(标记连接池中的连接不可用)，用来防止出现大面积连接因为 maxLifetim e是一样的而同时失效，从而造成 HikariCP 数据库连接池不稳定的情况。</p>
<p>在 HikariCP 的 3.3.1 版本中，修复了一个 issue 1287 “setcore pool size before max pool size”，这正是与我们介绍的连接生成 addConnectionExecutor 有关系的。提交这个 issue 的用户反馈：他在执行大量并发耗时查询（查询10～30秒）的时候，启动时的有尖峰请求，在尖峰需求完毕以前池中无空闲连接的情况下反应非常慢，获得新的连接是一个严重阻塞的过程。</p>
<p>根据这个用户的问题，HikariCP 3.3.1 版本在 HikariPool 的初始化过程中统一将 addConnectionExecutor.setMaximumPoolSize 挪到了 addConnectionExecutor.setCorePoolSize 的后面。其源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.zaxxer.hikari.blockUntilFilled&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
<span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitializationFailTimeout</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>setCorePoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>  <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>setMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitializationFailTimeout</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinimumIdle</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>quietlySleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCorePoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>com.zaxxer.hikari.blockUntilFilled 是 HikariCP 新版本的一个新功能，它是 HikariCP 官方文档没有提供的系统属性，它的作用是阻塞应用程序直到数据库连接池达到 minimumIdle 值的大小。这个行为在 HikariCP 旧版本期间是单线程的，所以就有可能出现初始化时大量并发连接的长慢查询容易导致 HikariCP 的 getConnection 方法产生阻塞；在 3.3.0 版本中可以进行调整，如果 com.zaxxer.hikari.blockUntilFilled 的属性为 true，并且 initializationFailTimeout 大于 1，则池将由多个线程填充。这线程数由 Runtime.getRuntime().availableProcessors() 确定。初始化后，线程数会在池的生命周期内下降回 1。</p>
<p>那么为什么又要将 setMaximumPoolSize 挪到 setCorePoolSize 后面呢？因为这里有一个 Bug，根据 ThreadPoolExecutor 文档，需要在设置最大池大小之前设置核心池大小，因为在将最大池大小设置为低于核心池大小的值时会抛出 IllegalArgumentException。而这个修复是在 HikariCP 3.3.1 版本中调整的。</p>
<p>setMaximumPoolSize 文档：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public void setMaximumPoolSize(int maximumPoolSize)
    Sets the maximum allowed number of threads. This overrides any value set in
the constructor. If the new value is smaller than the current value, excess existing
threads will be terminated when they next become idle.
Parameters：
    maximumPoolSize - the new maximum
Throws：
    IllegalArgumentException - if the new maximum is less than or equal to zero,
or less than the core pool size
See Also：
    getMaximumPoolSize()
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a68d253e10a456aa43583ccceb08ed00>2.7 - 参数解析</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0571ba633db8293a9c18653c90e33707>2.8 - 动态代理</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-563c823956cc6c18f29bf3dac344c4ed>2.9 - 应用实践</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-fd9d53e36c38a6c8387036a57dd6ad34>2.10 - 监控度量</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d0760fe5aebcb44b4fb0547d4e258a2f>2.11 - 常见问题</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-132362e06a52e754bd5f4df7fdd855b0>2.12 - 扩展技术</h1>
<h2 id=working-in-progress>Working in Progress</h2>
<p><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif alt=WIP></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-87d04a505f4113248f48de1fa6ff0993>3 - Parboiled</h1>
<p><a href=https://github.com/sirthias/parboiled>Parboiled</a> 是一个轻量、易用、强大且优雅的解析库，用于解析任意任意输入文本，基于 “解析表达式文法(PEGs)”，同时支持 Java 和 Scala。PEGs 是一种针对形式特定语法的上下文无关文法，是对正则表达式的很好替代，通过 CFGs 来构建解析器通常也会比传统的方式要有很多优势。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9128c2dc49c622f7600933c8d1ea1035>3.1 - CH01-Motivation</h1>
<p>Parboiled 的诞生源自对 JVM 上现有解析器构建工具的挫败感。</p>
<p>近年来流行动态语言(如 Ruby、Groovy)的巨大增长，很大一部分原因是它们将自身作为 DSL 的模型。虽然这些语言(甚至是一些静态类型的语言，如 Scala)具有简洁灵活的语法，通常直接可以用作内部 DSL 的基础，但相当笨拙的 Java 语法使得内部 DSL 非常缺乏吸引力。</p>
<p>对于很多项目来说，一个很小的 DSL 久能够构建出一个优雅的“用户接口”，以在没有 GUI 的情况下提供丰富的表现力以及灵活性。在 Java 中，内部 DSL 并不在规划之内，你不得不为外部 DSL 构建一个解析器以获得便利。尽管外部 DSL 并非解析器的唯一用例，像 Java 中这样对语言的传统解析支持工具并不出众。很多时候支持 DSL 并非项目的核心目标(如下编译器实现中)，而是解决各种问题之一的优雅方案。因此，你可能并不希望将太多时间用于上下文无关的文法、词法理论以及错综复杂的外部解析器生成器。您只想以某种方式指定解析语法的外观并使其快速轻松地工作。这也就是 Parboiled 存在的原因。</p>
<p>下面是一些传统解析器生成器的缺点：</p>
<ul>
<li>专有性，以非 Java 语法的形式保存在单独的项目文件(如外部 DSL)。</li>
<li>对文法文件没有 IDE 内置支持(语法高亮、内联检查、重构、代码导航等)。</li>
<li>运行外部解析器生成器需要特殊的构建步骤。</li>
<li>“谜不可触”，在你项目中生成的 Java 源文件需要与文法规范保持同步。</li>
<li>通过词法分析(令牌生成)和令牌解析阶段中的分离解析过程进行更复杂的设计和维护。</li>
<li>综合占用(ANTLR 分发的生成器加上运行时占用多余 1.8 MB)。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-05a361d8cd94e1828f1031c78fe17a96>3.2 - CH02-Features</h1>
<ol>
<li>以 Java、Scala 源码的形式定义文法。
<ul>
<li>没有外部的、非 Java/Scala 源码格式的文件。</li>
<li>无需学习额外的特有语法。</li>
<li>无需破坏 IDE 支持。</li>
</ul>
</li>
<li>真实世界可读。
<ul>
<li>来自<a href=https://en.wikipedia.org/wiki/Parsing_expression_grammar>PEG</a>的完整表现力。</li>
<li>支持强大且灵活的解析器动作。</li>
<li>游戏的解析错误包括与恢复。</li>
<li>高性能。</li>
</ul>
</li>
<li>非常易于集成。
<ul>
<li>无需管理外部的解析器生成器。</li>
<li>没有特殊的步骤使你的构建过程复杂化。</li>
<li>你的项目结构中不再有“谜不可触”的、生成的源文件。</li>
<li>开放、轻量的结构使得非常易于集成到现有项目结构。</li>
</ul>
</li>
<li>轻量、易用。</li>
</ol>
<ul>
<li>仅有一个解析阶段(词法分析代码不是必须的)。</li>
<li>少量且简单的 API。</li>
<li>整个库仅占用 300/450 KB，依赖较少。</li>
</ul>
<p>虽然 Parboiled 最初设计的速度低于易用性和可维护性，但其解析性能自早期版本以来已显着改善，现在对于大多数应用程序来说已经足够了。它可以以近似的速率解析其自身的 Java 5 源码。以每秒 55,000 行或每秒 200 万个字符的速度运行(2.4 GHz Intel Core i5 单核，OS/X Java 6)。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c01e1d6286ccead6f7f8fe20b1de6a82>3.3 - CH03-Java Example</h1>
<p>首先是一个计算器的文法定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Expression &lt;- Term ((&#39;+&#39; / &#39;-&#39;) Term)*
Term &lt;- Factor ((&#39;*&#39; / &#39;/&#39;) Factor)*
Factor &lt;- Number / &#39;(&#39; Expression &#39;)&#39;
Number &lt;- [0-9]+
</code></pre></div><p>然后是基于 Java 代码的解析器定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@BuildParseTree</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CalculatorParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Expression</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>(),</span>
      <span style=color:#000>ZeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;+-&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>(),</span>
      <span style=color:#000>ZeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AnyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;*/&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>FirstOf</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>(),</span>
      <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;(&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Expression</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#4e9a06>&#39;)&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>Rule</span> <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>OneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CharRange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;0&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;9&#39;</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后是对该解析器的应用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1+2&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>CalculatorParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Parboiled</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CalculatorParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ParsingResult</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReportingParseRunner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Expression</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>String</span> <span style=color:#000>parseTreePrintOut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ParseTreeUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printNodeTree</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseTreePrintOut</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>第 2 行创建了一个解释器实例，其方法可以被用于各种不同的 ParserRunner 来执行实际的解析过程并创建 ParsingResult。ParsingResult 对象除了包含输入是否匹配的信息之外，还包含表达式的解析树的根(如果启用了解析书构建)、结果值、解析错误列表。理解解析器是如何处理输入的方式是使用 ParseTreeUtils.printNodeTree，如上面示例中第 4~5 行那样。</p>
<p>通常来说，Parboiled 会在 Java 语法的约束下使你的规则规范尽可能的可读。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-58a76c5a3dcaf6862a60be2d58ff89be>3.4 - CH04-Scala Example</h1>
<p>首先是一个计算器的文法定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Expression &lt;- Term ((&#39;+&#39; / &#39;-&#39;) Term)*
Term &lt;- Factor ((&#39;*&#39; / &#39;/&#39;) Factor)*
Factor &lt;- Number / &#39;(&#39; Expression &#39;)&#39;
Number &lt;- [0-9]+
</code></pre></div><p>然后是基于 Scala 代码的解析器定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.parboiled.scala._</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimpleCalculator</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Parser</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Expression</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rule0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Term</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>zeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>anyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;+-&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>Term</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Term</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Factor</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>zeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>anyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;*/&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>Factor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Factor</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Number</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>Expression</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>Number</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>oneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#4e9a06>&#34;9&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后是对该解析器的应用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>input</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1+2&#34;</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>parser</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleCalculator</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>buildParseTree</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ReportingParseRunner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Expression</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>parseTreePrintOut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parboiled</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>support</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ParseTreeUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printNodeTree</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseTreePrintOut</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-aefd071109bac895cd9af8eb4428de7d>3.5 - CH05-Comparison</h1>
<p>如果你将解析需求想象为一个光谱，一边是“脏且快”的正则表达式，一边是像 ANTLR 一样完整的解析器生成器，Parboiled 则旨在填补两端之间的巨大空间。对于非常简单的用例，正则表达式可能是一个具有最小开销的适当解决方案。然而，正则表达式可以很快变成丑陋的混乱、难以阅读理解并最终难以维护。在许多情况下，它们也缺乏表达能力来解析像嵌套构造这样需要递归规则定义的东西。它们也不会生成正确的错误消息或从输入的错误中恢复，而这可以在开发过程中节省大量时间。</p>
<p>在光谱的另一端，像 ANTLR 和 Rats! 这样强大的工具当然也有其适用场景。当必须解析那些用复杂语言编写的大量源码时，解析器生成器可能是合适的工具。比如，你可能想要使用现有的语法，或者需要一些发展多年的企业工具的完整特性集。</p>
<p>然而，当你需要定义自己的语法，并且对解析器生成器没有丰富的经验，Parboiled 则可以快速简便的帮你达到目的。Parboiled 可以用于小的任务，如解析日期与时间；也可以用于复杂的任务，如解析 Java 源码或像 Markdown 这样的标记语言。占用小、轻量的架构使其很容易与其他应用集成，同时又能为多种定制需求提供良好的基础。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0b8da0caaa67951e41a357509aa1eb83>3.6 - CH06-Concepts</h1>
<h2 id=纵观全局>纵观全局</h2>
<p>Parboiled 提供了一个递归下降的 PEG 解析器实现来操作你指定的 PEG 规则。</p>
<p>你的语法规范可以包含解析器动作，这些动作可以在解析过程中的任意一点执行额外的逻辑，比如使用自定义条件来增强输入识别，或者构造抽象语法树(AST)。</p>
<h3 id=两个阶段>两个阶段</h3>
<p>你的代码会在两个阶段与 Parboiled 交互。在第一个阶段——“规则构造”阶段，Parboiled 会基于你定义的 Java/Scala 代码为解析器规则构建一个树(一个有向图)。该阶段与实际的输入阶段没有依赖，仅需要在整个 JVM 的生命周期中执行一次，即构建过的规则树是可复用的。第二个阶段是实际的解析阶段，使用第一阶段中的规则来处理特定的输入文本。最终的执行结构将包含以下信息：</p>
<ul>
<li>一个布尔值来表示输入是否与根规则匹配。</li>
<li>可能遇到的所有解析错误。</li>
<li>由你的解析器动作构造的一个或多个值对象。</li>
</ul>
<h3 id=规则构造>规则构造</h3>
<p>在执行由 Java/Scala 定义的规则代码时将触发规则构造。Parboiled 分别为 Java 和 Scala 提供了单独的 DSL 来使得规则的定义过程与语言本身结合的更加舒适。</p>
<p>在 Java 中你需要实现一个自定义类来继承 BaseParser 类，并定义一些方法来返回 Rule 实例。这些方法可以通过调用其他自定义方法、终止符、预定义原语、动作表达式来构造规则实例。由于 Java 语法的限制，Parboiled 则使用了一个名为“解析器扩展(Parser Extension)”的过程来支持比其他方式更加简洁的规则构造代码。</p>
<p>因为 Scala 本身就富有较强的表现力，因此 Parboiled 并不需要为 Scala 再提供一个单独的解析器扩展步骤。在 Scala 中，你可以直接通过 Scala 语言元素来构造解析器规则树。</p>
<h3 id=解析动作>解析动作</h3>
<p>为了避免你的解析器仅仅是一个“识别器”(一段仅能检测输入是否与定义的语法匹配的代码)，在你的解析器中需要包含一些动作。解析器动作是一段自定义的代码，在规则执行期间的一些特定点被执行。除了检查解析器状态(如查看匹配的输入文本片段)，解析器动作通常用于构造“值”(如 AST 节点)，并可以作为语义谓词主动影响解析过程。</p>
<h3 id=值栈>值栈</h3>
<p>在规则执行阶段，你的解析器动作可以利用“值栈”来组织自定义对象的构造，如 AST 节点。值栈是一个简单的栈结构，作为一个临时存储为自定义对象提供服务。使用值栈的方式取决于你使用的是 Parboiled Java 还是 Parboiled Scala。</p>
<h3 id=解析树>解析树</h3>
<p>在规则执行阶段 Parboiled 能够以可选的方式构造一个解析树，其节点对应于已识别的规则。每个解析树 Node 包含一个对应规则的 Matcher，同时，被匹配的输入文本(位置)也会作为当前值栈的栈顶元素。该解析树可以被看做是输入对已匹配规则的记录，在调试过程中尤其有用。</p>
<h3 id=解析执行器>解析执行器</h3>
<p>ParseRunner 的职责是“监管”解析的执行过程，并能以可选的方式提供额外的逻辑，尤其重要的是对非法输入字符的处理(基于语法)。当你使用 Parboiled 执行解析时可以选择一下 5 种预定义的 ParseRunner：</p>
<ol>
<li>BasicParseRunner，最快最基本的 ParseRunner，不执行错误处理。</li>
<li>ReportingParseRunner，为输入的第一个错误创建衣蛾 InvalidInputError。</li>
<li>RecoveringParseRunner，最复杂的 ParseRunner，报告输入中的所有错误，并尝试从错误中恢复。</li>
<li>TracingParseRunner，为每条匹配的或未匹配的规则有选择的打印追踪信息。</li>
<li>ProfilingParseRunner，在你的解析器处理一个或多个输入时生成详细的统计信息。</li>
</ol>
<h2 id=rule-tree>Rule Tree</h2>
<p>像大多数解析相关的程序一样，Parboiled 严重依赖于图和树结构。第一个这样的结构会在解析过程中创建，即规则“树”。该规则树这时尚未与实际的输入产生依赖。解析输入会在解析执行的过程中被解析器消费并被应用到规则树上，该过程可以以可选的方式生成一个解析树。</p>
<p>假设以下示例语法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>a ← b ‘a’ c
b ← ‘b’ d
c ← ‘c’ d
d ← ‘d’ c?
</code></pre></div><p>如果你将该语法转换为一个图，仅将规则作为图的节点，规则引用作为有向边，这时该语法可以用以下结构来表示：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190212174806.png style=display:block;width:20% alt=NAME align=center>
</div>
<p>你会发现该图存在一个环，同时节点 d 拥有两个父亲，这也就是为什么该图不是一个树而仅仅是一个有向图。很多真实世界的语法的大多部分都像是一个树，带有非常清晰的规则到子规则层级引用。虽然回环(递归)并不十分罕见，但与“常规”分层引用相比，它们的数量确实很少。</p>
<p>因此这样的原因(以及对许多人而言，“树”是一种更常见的心理图景)，你可能会选择将这样的规则图看做是带有两个特殊异常的规则树：多父亲、回环。</p>
<p>顺便提一下，PEG 语法的这种有向图特性几乎与方法调用在 JVM 中的工作方式一致：方法调用其他方法，可能包括调用堆栈祖先。这也是为什么 Parboiled 会或多或少的将规则声明映射到 Java/Scala 的方法调用。你的每个解析器规则方法都会构造一个规则对象，并在构造过程中潜在的调用其他规则构造方法。</p>
<p>然而这里还有两个问题：</p>
<ul>
<li>Java/Scala 方法递归到方法自身或其祖先时需要一种方式来终止递归。通常这是通过一些逻辑实现的，可以在逻辑中通过一些条件来退出递归。然而规则声明无法做到这一点，只有解析的输入文本(是有限的)将会终止任何规则递归。因此为了防止用于构造规则的 Java/Scala 方法出现无限递归，需要采取一些技巧。</li>
<li>当一个规则构造方法被调用多次时(可能被多起其他规则构造方法调用)，通常会为每次调用创建结构相同的全新的规则实例。虽然这不是什么问题，但在规模较大的语法中则会比较低效，这时一个大型的规则树中会包含很多重复的规则实例。</li>
</ul>
<p>Parboiled 在 Java 中通过重写解析类的规则方法来、并注入开发者不可见的代码来解决这两个问题。这些代码会确保每个方法仅会被调用一次，即背个规则仅被创建一次，后续的调用则会返回已创建的相同规则实例。如果规则的创建过程递归会自身，则插入代理规则以防止无限递归。所有这些事情都在幕后透明地发生，开发者无需关心。</p>
<p>Parboiled 在 Scala 中则不需要重写实际的字节码，而是将实际的规则创建代码封装到一个函数块，并作为主规则构建方法的参数。</p>
<p>最后，当你调用你的顶级规则方法并传给所选的 ParseRunner 时，则会得到一个规则树，没有重复节点，正确的链接关系，甚至还有递归。</p>
<h3 id=mathcers>Mathcers</h3>
<p>你可能已经在 Javadoc API 文档中看到 Rule 接口仅仅是一个外观接口，带有很少的方法以指定特殊的规则属性。所有实现该接口的类被定义在 <code>org.parboiled.matchers</code> 中。有一个用于所有规则原语的 Matcher 实现，它实现了实际规则类型的逻辑。因此规则树实际上是一个 Matcher 树。然而，大多时候你不必了解这些内部细节，仅需关注于解析器规则和值栈。</p>
<h2 id=value-stack>Value Stack</h2>
<p>在规则执行阶段，你的解析器动作可以利用“值栈”来组织自定义对象(如 AST 节点)的构造。值栈是一个简单的栈结构，作为临时存储服务于自定义对象。</p>
<p>通常，规则可以以任何方式修改值栈。可以创建新的值并推到栈上，或者消费已有的值，或者转换已有的值并重新推到栈上，等等。Parboiled 解析引擎并不关心你的规则和解析器动作与值栈之间的交互。</p>
<p>有两个特殊异常：</p>
<h3 id=规则未匹配>规则未匹配</h3>
<p>如果规则因任何原因未匹配成功，则将值栈重置为执行该失败规则之前的状态。这意味着失败的规则无法修改值栈(这包括失败的语义判定动作)。</p>
<p>此行为的原因是使您不仅可以将动作放在一系列规则的最后位置。考虑如下规则：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Rule ← ‘a’ ‘b’ action ‘c’
</code></pre></div><p>假设匹配规则 “b” 之后将一个新值推到栈上。如果因为最终的元素 “c” 不能匹配到规则而导致规则序列失败，该值栈仍然会包含刚才被动作推入的新值。即使您的规则逻辑可能能够处理这些情况，这也会使动作设计复杂化并使解析器逻辑更加脆弱。</p>
<p>事实上，当规则不匹配时 Parboiled 重置堆栈的行为使得你可以自由的放置解析器动作，并将值栈用于规则内临时存储，这在很多情况下都非常方便。</p>
<h3 id=语义判定>语义判定</h3>
<p>Test 和 TestNot 规则永远不会影响值栈。Parboiled 会使用一个以保存的快照将值栈重置回 Test/TestNot 规则匹配之前的状态。因此，您可以确定语法判定永远不会“混乱”您的值栈设置，即使它们包含解析器动作或引用其他规则。</p>
<h2 id=parse-tree>Parse Tree</h2>
<p>Parboiled 在规则执行阶段以可选的方式支持构建一个解析树。查看解析树可以更好的理解你的解析器对输入的消费过程，因此有助于解析器的开发和调试。</p>
<p>由 Parboiled 创建的解析树由一系列实现 Node 接口的不可变对象组成。除了基本的树节点功能(父亲、儿子)之外，该接口定义了节点名、所匹配输入文本的起始终止位置，以及一个自定义值对象。一些工具类为解析树提供了额外的处理方法，有 ParseTreeUtils、TreeUtils、GraphUtils。</p>
<p>需要注意的是解析树的节点是不可变的，即一旦被创建则不再能被修改。这实际上意味着它们的子节点结构和它们的值对象“引用”不能被修改。(尽管它们的值对象可以是可变的，或者仍然能够被修改。)整个解析树会从底向上被构建，先从叶子节点开始。通常来说，如果开启了解析树构建选项，匹配成功的每个规则都会创建一个解析树节点，该节点将匹配成功的子规则所创建的节点作为子节点。匹配失败的规则不会创建节点。解析树可以被认为是“已匹配规则的记录”。Parboiled 将解析树节点的 value 字段值设置为节点构造时值栈的栈顶元素。因此产看解析树值对象可以为你提供解析器如何使用值栈的线索。</p>
<p>或许对解析树最有用的使用方式是使用 ParseTreeUtils 的 printNodeTree 来将其打印出来。</p>
<h3 id=在-java-中开启解析树构建>在 Java 中开启解析树构建</h3>
<p>可以在解析器实现类上添加 <code>@BuildParseTree</code> 注解来开启解析树构建。还可以在解析器方法上使用 <code>@SuppressNode</code>/<code>@SuppresssSubnodes</code>/<code>@SkipNode</code> 来对解析树进行微调。</p>
<h3 id=在-scala-中开启解析树构建>在 Scala 中开启解析树构建</h3>
<p>在 Scala 中，Parser 特质拥有一个 <code>buildParseTree</code> 标记方法，将其设置为 true 则可以开启解析树构建。最简单的方式是在解析器类的构造方法上调用 <code>.withParseTreeBuilding()</code> 方法。类似 Java API，可以使用 <code>Parser$RuleOption</code> 中的选项来对解析树的构建过程进行微调。</p>
<h2 id=ast-construction>AST Construction</h2>
<p>和解析树与语法之间的紧密关联关系相反，你想要构造的抽象语法树(AST)则完全取决于你的项目需要。这就是为什么 Parboiled 采用非常开放和灵活的方法来支持它。</p>
<p>事实上对 AST 节点的类型没有任何约束。Parboiled 没有提供任何不变或可变的对象来使用，因此也不会强制你使用什么。可以查看 <code>org.parboiled.trees</code> 包来开始。</p>
<p>通常你可以使用解析器值栈来作为构造 AST 的“工作台”。对于 Java API 可以参考 Calculators 示例，Scala API 可以参考 JSON Parser 示例。</p>
<h2 id=error-handling>Error Handling</h2>
<p>对非法输入的适当处理是任何要被应用到真实项目的解析器的关键特性，这也是正则比倒是的最大缺陷之一。比如，如果用户在自定义 DSL 中提供了输入，你可以清楚的知道其中的语法或语义错误。语义错误可以被更高级的应用程序捕获并报告，但是语法错误必须在解析器中直接被捕获并报告。Parboiled 通过提供 4 种不同的 ParseRunner 实现来支持你选择处理解析错误的方式。</p>
<h3 id=basicparserunner>BasicParseRunner</h3>
<p>这是最简单的实现。它不会执行任何错误处理，如果输入与指定的语法规则无效，则会简单的导致解析过程不匹配。这时，它的行为就像正则表达式引擎一样。它只执行一次解析，是确定指定输入是否符合解析器语法定义的最快方式。</p>
<h3 id=recordingparserunner>RecordingParseRunner</h3>
<p>比 BasicParseRunner 多一点特性：跟踪输入字符流中成功匹配的最远输入位置。如果给定的语法根规则不匹配，则紧随其后的位置必须是错误位置。和 BasicParseRunner 一样，仅执行一次解析运行。</p>
<h3 id=reportingparserunner>ReportingParseRunner</h3>
<p>不提供任何错误恢复功能，但是会在发现输入中的第一个匹配错误时报告错误。它在无错误输入上执行一次解析运行，但如果输入包含解析错误，则内部触发另外两次运行。在第二次运行期间，它会记录第一个解析错误的位置，并且在第三次运行期间，它会“监视”解析器尝试匹配错误字符时的行为，以便为用户创建有意义的错误消息。然后实例化一个 InvalidInputError 并将其添加到 ParsingResult 中返回的错误解析列表中。</p>
<h3 id=recoveringparserunner>RecoveringParseRunner</h3>
<p>这是 4 种 ParseRunner 实现中最复杂的一个，它提供了自动的、只能的错误恢复，并且即便是存在解析错误也能完整的解析整个输入文本。Parboiled 提供的这种策略与 ANTLR 类似。如果可能的话，Parboiled 会在识别到非法输入时尝试进行单字符删除、插入或替换。如果仍然失败，Parboiled 会在当前规则堆栈中找到合适的重新同步规则，并是由所有非法字符，知道解析器可以重新同步以继续解析为止。</p>
<h4 id=解析错误恢复细节>解析错误恢复细节</h4>
<p>类似于 ReportingParseRunner，RecoveringParseRunner 首先会尝试一次快速的基本运行以发现输入是否存在错误。如果整个输入没有任何错误则直接结束执行。</p>
<p>如果首次运行出现错误，RecoveringParseRunner 则会执行以下算法来尝试克服错误：</p>
<ol>
<li>首先执行一次“记录运行”以检测当前错误的位置。</li>
<li>然后执行一次“报告运行”，并将有意义的 InvalidInputError 添加到解析错误列表。</li>
<li>然后当前错误位置的字符会被临时性的删除，随后再次执行“记录运行”来发现下个错误的位置，以此类推。如果没有发现更多错误，则表示所有错误已被解决，然后直接结束解析。</li>
<li>在“报告运行”期间，运行器会收集所有在预期字符发生错误的规则并失败。对于所有这些规则，运行期会尝试插入临时性的“虚拟”字符到输入字符流，然后执行一次“记录运行”来检测下个错误的位置。如果这些插入的字符能够使得完整运行整个输入文本，则直接结束解析。</li>
<li>运行器尝试使用一个配件“虚拟”字符来替换错误字符(像上一步一些样)。如果这样能够使得错误得到解决则直接结束解析。</li>
<li>在这一步中，运行器知道没有单个字符恢复能够完全修复错误输入。但是它现在知道是否有一个动作(单个字符删除、插入、替换)允许解析器能够继续解析直到超出错误的位置。如果是这种情况，则可以通过单个字符恢复来克服错误，并且运行器应用允许解析器继续解析最远输入流的修复。因此，如果有可用的话，运行器总是选择最好的单字符修复。</li>
<li>如果没有单字符修复能够使得将下一个错误位置推送到当前错误位置之外，则会强制运行程序重新同步并重新执行“记录运行”以确定下一个错误的位置。为了做到这一点，运行器首先识别重新同步规则，该规则是作为序列并且已经匹配至少一个字符的第一个父规则。运行器确定运行哪些字符在合法解析中遵循此重新同步规则，并跳过所有不符合条件的字符。</li>
<li>既然最佳单字符修复或重新同步已经克服了当前的解析错误，则运行器继续解析到下一个错误并从步骤 1 开始从该错误中恢复。</li>
</ol>
<h3 id=动作设计的后果>动作设计的后果</h3>
<p>由于上述概述的解析错误恢复策略允许解析即使已存在错误，如果你决定使用 RecoveringParseRunner，解析器动作应该能够处理一些意外情况。</p>
<p>单字符修复通常不会对你的动作产生任何影响，因为解析器动作所能看到的匹配输入文本已经包含错误更正，即排除掉了非法字符，并且在错误恢复期间插入的虚拟字符也包含在其结果中。但是，通过重新同步进行错误恢复会导致不匹配的规则序列“神奇的”匹配，即使并非是所有序列子规则都匹配或甚至运行。由于这会抛弃预期的值栈设置，因此在重新同步期间，Parboiled 会在重新同步序列中执行所有低限度要求的解析器动作。所有这些动作都会看到空匹配，因此可以提供有意义的默认值。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-63d9481a39ef551c7e8a0cb56828ef77>3.7 - CH07-Java APIs</h1>
<p>Parboiled Java 的应用步骤：</p>
<ol>
<li>安装依赖。</li>
<li>确定要解析器值栈中要参数化的类型，继承 BaseParser 实现自定义解析类。</li>
<li>在该解析类中添加返回类型为 Rule 的规则方法。</li>
<li>通过 <code>Parboiled.createParser</code> 创建解析器实例。</li>
<li>调用解析器的根规则方法来创建规则树。</li>
<li>选择 ParseRunner 的特定实现，调用其 run 方法并传入根规则和输入文本。</li>
<li>查看 ParsingResult 对象的属性。</li>
</ol>
<h2 id=rule-construction>Rule Construction</h2>
<p>一个 PEG 由任意数量的规则组成，规则又可以由其他规则、终止符、或下表中的原语规则组成：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Name</th>
<th style=text-align:center>Common Notation</th>
<th style=text-align:left>Primitive</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>Sequence</td>
<td style=text-align:center>a b</td>
<td style=text-align:left>Sequence(a, b)</td>
</tr>
<tr>
<td style=text-align:left>Ordered Choice</td>
<td style=text-align:center>a | b</td>
<td style=text-align:left>FisrtOf(a, b)</td>
</tr>
<tr>
<td style=text-align:left>Zero-Or-More</td>
<td style=text-align:center>a *</td>
<td style=text-align:left>ZeroOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>One-Or-More</td>
<td style=text-align:center>a +</td>
<td style=text-align:left>OneOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>Optional</td>
<td style=text-align:center>a ?</td>
<td style=text-align:left>Optional(a)</td>
</tr>
<tr>
<td style=text-align:left>And-Predicate</td>
<td style=text-align:center>& a</td>
<td style=text-align:left>Test(a)</td>
</tr>
<tr>
<td style=text-align:left>Non-Predicate</td>
<td style=text-align:center>! a</td>
<td style=text-align:left>TestNot(a)</td>
</tr>
</tbody>
</table>
<p>这些原语实际是 BaseParser 类的实例方法，即所有自定义解析器的必要父类。这些原语规则创建方法可以接收一个或多个 Object 参数，这些参数的类型可以是：</p>
<ul>
<li>一个 Rule 实例</li>
<li>一个字符字面量</li>
<li>一个字符串字面量</li>
<li>一个字符数组</li>
<li>一个动作表达式</li>
<li>实现了 Action 接口的类的实例</li>
</ul>
<p>除了以上原语方法，还有以下原语可供使用：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Method/Field</th>
<th style=text-align:left>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>ANY</td>
<td style=text-align:left>匹配任何除了 EOI 的单个字符</td>
</tr>
<tr>
<td style=text-align:left>NOTHING</td>
<td style=text-align:left>不匹配任何，总是失败</td>
</tr>
<tr>
<td style=text-align:left>EMPTY</td>
<td style=text-align:left>不匹配任何，总是成功</td>
</tr>
<tr>
<td style=text-align:left>EOI</td>
<td style=text-align:left>匹配特殊的 EOI 字符</td>
</tr>
<tr>
<td style=text-align:left>Ch(char)</td>
<td style=text-align:left>创建一个匹配单个字符的规则</td>
</tr>
<tr>
<td style=text-align:left>CharRange(char, char)</td>
<td style=text-align:left>匹配给定的字符范围</td>
</tr>
<tr>
<td style=text-align:left>AnyOf(string)</td>
<td style=text-align:left>匹配给定字符串中的任意字符</td>
</tr>
<tr>
<td style=text-align:left>NoneOf(string)</td>
<td style=text-align:left>不匹配给定字符串中的任意字符和 EOI</td>
</tr>
<tr>
<td style=text-align:left>IgnoreCase(char)</td>
<td style=text-align:left>匹配单个字符且忽略大小写</td>
</tr>
<tr>
<td style=text-align:left>IgnoreCase(String)</td>
<td style=text-align:left>匹配整个字符串且胡烈大小写</td>
</tr>
<tr>
<td style=text-align:left>String(string)</td>
<td style=text-align:left>创建一个匹配整个字符串的</td>
</tr>
</tbody>
</table>
<h2 id=parser-action-expressions>Parser Action Expressions</h2>
<p>Parboiled Java 的解析器可以在规则定义的任意位置包含解析器动作。这些动作可以分为 4 类。</p>
<h3 id=regular-objects-implementing-the-action-interface>“Regular” objects implementing the Action interface</h3>
<p>如果你的动作代码较多，则可以将其封装到一个实现了 Action 接口的自定义类中，然后再在规则定义方法中使用该自定义类的实例。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Action</span> <span style=color:#000>myAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyActionClass</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#000>myAction</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果使用这种方式，你的自定义动作类也可以实现 SkippableAction 接口以告诉解析器引擎在执行内部的语法判定时是否跳过这些动作。</p>
<h3 id=anonymous-inner-classes-implementing-the-action-interface>Anonymous inner classes implementing the Action interface</h3>
<p>更多时候动作仅会包含少量的代码，这时可以直接使用匿名类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Action</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Context</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#ce5c00;font-weight:700>...;</span> <span style=color:#8f5902;font-style:italic>// arbitrary action code
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// could also return false to stop matching the Sequence and continue looking for other matching alternatives
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=explicit-action-expressions>Explicit action expressions</h3>
<p>虽然匿名类要比独立的动作类定义简单一点，但仍然显得冗余。可以继续简化为一个布尔表达式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#000>ACTION</span><span style=color:#ce5c00;font-weight:700>(...),</span> <span style=color:#8f5902;font-style:italic>// the argument being the boolean expression to wrap
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>BaseParser.ACTION</code> 是一个特殊的标记方法，其告诉 Parboiled 将参数表达式封装到一个单独的、自动创建的动作类中，类似上面匿名类的例子。这样的动作表达式中可以包含对本地变量的访问代码或方法参数、读写非私有的解析器字段、调用非私有的解析器方法。</p>
<p>此外，如果动作表达式中调用实现了 ContextAware 接口的类对象方法，将自动在调用方法之前插入 setContext 方法。比如你想将所有的动作代码移出到解析器类之外以简化实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MyActions</span> <span style=color:#000>actions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyActions</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#000>ACTION</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>someAction</span><span style=color:#ce5c00;font-weight:700>()),</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果 MyActions 实现了 ContextAware 接口，Parboiled 将会自动在内部转换为类似下列清单的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyParser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseParser</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MyActions</span> <span style=color:#000>actions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyActions</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Rule</span> <span style=color:#000>MyRule</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...,</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Action</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Context</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>actions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>actions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>someAction</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意 BaseParser 已经继承了 BaseActions，其实现了 ContextAware 接口，所以解析器类中的所有动作方法可以通过 getContext 方法获得当前的上下文。</p>
<h3 id=implicit-action-expressions>Implicit action expressions</h3>
<p>大多数情况下，Parboiled 可以自动识别你的规则定义中哪些是动作表达式。比如下面的规则定义中包含了一个隐式的动作表达式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>OneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CharRange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;0&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;9&#39;</span><span style=color:#ce5c00;font-weight:700>)),</span>
        <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>random</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>5</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>extractIntegerValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>someObj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doSomething</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Parboiled 的检测逻辑如下：</p>
<p>BaseParser 中所有的默认规则创建器方法都拥有通用的 Java Object 参数，Java 编译器会自动将原始布尔表达式的结果作为一个 Boolean 对象传递。这是通过在布尔动作表达式的代码之后隐式地插入对 Boolean.valueOf 的调用来实现的。Parboiled 会在你的规则方法字节码中查找这些调用然后将其当做隐式动作表达式来处理，如果其结果直接被用作规则创建方法的参数的话。也可以通过 <code>@ExplicitActionsOnly</code> 注解(定义在解析类或规则方法上)来关闭该功能。</p>
<h3 id=return-values>Return Values</h3>
<p>动作表达式均为布尔表达式。其返回值将影响对当前值的解析进度。如果动作表达式的结果为 false，解析将继续，就像替换动作表达式的假设解析规则失败一样。因此，你可以将动作表达式视作可以(匹配)成功或(匹配)失败的“规则”，具体则取决于其返回值。</p>
<h2 id=value-stack>Value Stack</h2>
<p>在任何特定的解析项目中，解析器动作都希望能够以某种方式来创建对应输入文本结构的自定义对象。Parboiled Java 提供了两种工具来在解析器规则中管理创建的自定义对象：</p>
<ul>
<li>值栈</li>
<li>动作变量</li>
</ul>
<p>值栈是一个简单的栈结构，作为一个临时存储为你的自定义对象提供服务。你的解析器动作可以将对象推到栈上、推出栈、推出再推入栈交换对象，等等。值栈的实现隐藏在 ValueStack 接口下面，其定义了操作值栈的一系列方法。</p>
<p>所有的解析器动作可以通过当前 context 的 getValueStack 来获得当前值栈。为了简化值栈操作的冗余，BaseActions 类(BaseParser)的父类提供了一些值栈操作的快捷方法，可以直接在解析器动作表达式中内联使用。</p>
<p>在解析器规则中使用值栈的方式通常有以下几种：</p>
<ul>
<li>匹配分隔符、空格或其他辅助结构的规则通常不会影响值栈。</li>
<li>较底层的规则会从匹配到的输入中创建基本对象并推到栈上。</li>
<li>调用一个或多个底层规则的高级别规则，会从栈上推出值对象，然后创建高级别的对象并重新推到栈上。</li>
<li>根规则作为最高级别的规则会创建自定义结构的根对象。</li>
</ul>
<p>大多时候，但一个规则被完整处理过后，最多会推一个对象到栈上(尽管在处理过程中会推多个对象到栈上)。那么你可以认为：如果规则匹配，一个规则会在栈上创建一个特定类型的对象，否则则不会影响栈。</p>
<h3 id=规则定义须知>规则定义须知</h3>
<p>一条重要的原则是一个规则总是应该确保其对值栈的操作是“稳定的行为”，而无论输入是什么。因此，如果一个规则将一个特定类型的值对象推到栈上，则其应该为所有可能的输入都推一个值到栈上。如果不然，那么引用该规则之外的规则时将无法在规则匹配之后会值栈的状态进行假设，这将使动作设计复杂化。以下讨论着眼于各种 PEG 原语以及在使用影响值栈的解析器操作时需要注意的事项。</p>
<h4 id=sequence-规则>Sequence 规则</h4>
<p>由于它们不提供任何可选组件，因此关于值栈操作，序列规则相当直接。它们的最终结果本质上是稳定的，仅包括所有子操作的串联。</p>
<h4 id=firstof-规则>FirstOf 规则</h4>
<p>FirstOf 规则提供了几种替代子规则匹配。为了向外部提供稳定的“输出”，重要的是所有替代方案都表现出兼容的值堆栈行为。考虑以下例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>FirstOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>C</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果子规则 A 将推一个对象到栈，则 B 和 C 也需要这样做。</p>
<h4 id=optional-规则>Optional 规则</h4>
<p>Optional 规则的子规则通常不应该在值栈中添加或删除对象。由于 Optional 规则始终会匹配成功，即使其子规则不匹配，对值栈上的对象数量的任何影响都将违反“稳定行为”的原则。但是，Optional 规则可以很好的转换值栈上的内容，而避免不稳定的行为。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#8f5902;font-style:italic>// number adds an Integer object to the stack
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#39;+&#39;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#8f5902;font-style:italic>// another Integer object on the stack
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// pop two and repush one Integer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该规则的行为始终是稳定的，因为它总是会将一个值推送到栈上。</p>
<h4 id=zeroormoreoneormore-规则>ZeroOrMore/OneOrMore 规则</h4>
<p>与 Optional 规则类似，不能添加或删除值栈的元素，而可以修改值栈的元素内容。</p>
<h2 id=action-variables>Action Variables</h2>
<p>对值栈的操作需要一些设计素养，同时为了类型安全，值栈中仅能使用一个较为宽泛的通用类型，然后再在解析器动作使用使用强制类型转换，这会带来维护成本。为了提供更多的灵活性，提供了动作变量功能。</p>
<p>通常，一个规则方法会在规则的子结构中包含多个动作表达式，以协同的方式来构造出最终规则。在很多情况下如果能够通过一个通用的临时辅助变量来访问规则中所有的动作，则会大有帮助。考虑如下例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>Verbatim</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>StringVar</span> <span style=color:#000>text</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>StringVar</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>OneOrMore</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>ZeroOrMore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BlankLine</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\n&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span>
                <span style=color:#000>NonblankIndentedLine</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getText</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>VerbatimNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该规则用于解析 Markdown 的逐行结构，其中包含一行或多行的缩进文本。这些缩进行可以通过完全的空行来拆分，如果其跟随的有最少一个缩进行则也可以被匹配。该规则的工作是创建一个 AST 节点并初始化为匹配到的文本(不带有行缩进)。</p>
<p>为了能够构建该 AST 节点的文本参数，如果能够访问一个字符串变量——作为构建字符串的临时容器，则会非常有帮助。在通常的 Java 方法中可以使用一个本地变量，然而，因为规则方法仅包含规则的构造代码而非规则实际运行的代码，因此本地变量起不了作用。因为本地变量仅能在规则的构造期间而非运行期间可见。</p>
<p>这就是为什么 Parboiled Java 提供了一个名为 Var 的类，它可以用作规则执行阶段的本地变量。Var 对象包装一个任意类型的值，可以拥有初始值，支持对值的读写，可以在嵌套规则方法之间传递。每轮规则调用(如规则匹配重试)都会接受到自己的 Var 域，因此递归规则中的动作也会像预期一样运行。此外，Var 类还定义了一系列简便的辅助方法来简化其在动作表达式中的应用过程。</p>
<p>如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Rule</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Var</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Var</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#ce5c00;font-weight:700>...,</span>
        <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>42</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>())</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Rule</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Var</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Sequence</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#ce5c00;font-weight:700>...,</span>
        <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>26</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>规则方法 A 传递一个其域内定义的 Var 作为参数到规则方法 B，规则方法 B 内的动作向该 Var 写入一个新值，规则方法 A 中所有运行在 B 之后的动作都能看到该新写入的 Var 的值。上面的例子中，A 中的 action 读取 Var 值时会得到 26。</p>
<h2 id=parser-extension>Parser Extension</h2>
<p>当你首次调用 <code>Parboiled.createParser</code> 来构造你的解析器实例时，Parboiled Java 会在内部运行解析器扩展逻辑来为你的解析器类增加所有可能的特殊功能。因为你定义的解析器类一定不是 private 和 final 的，因此可以被子类化。新创建的类与你原有的解析器类处于同一个包下，使用原有的类名并加上 <code>$$parboiled</code> 后缀。</p>
<p>自动穿件的解析器子类会覆写所有返回 Rule 实例的方法。这些覆写会在某个点将调用为派给父方法(即原始解析器类中的方法)，或者甚至完全重写而不会父类方法做任何调用。</p>
<p>以下规则方法扩展需要完全重写而不会对父方法执行委派调用：</p>
<ul>
<li>解析器动作表达式</li>
<li>动作变量</li>
</ul>
<p>以下规则方法扩展可以无需方法重写而应用，如果方法中没有上面列出的转换时也可以调用父方法：</p>
<ul>
<li>@Label</li>
<li>@Cache</li>
<li>@SuppressNode</li>
<li>@SuppressSubnodes</li>
<li>@SkipNode</li>
<li>@MemoMismatches</li>
</ul>
<p>通常你不必担心是否需要进行方法覆写的问题。然而在调试环节，当你需要在规则方法中添加断点以追踪执行过程时，如果你的规则方法被重写，则端点就无法没命中。因此，比如你需要调试一个带有隐式或显式动作表达式的规则方法时，需要临时将动作表达式改写为显式匿名内部 Action 类，来避免对该规则方法的完全重写。</p>
<p>解析器扩展逻辑不会触碰那些不返回 Rule 实例的方法则，而是直接保留。</p>
<h2 id=examples>Examples</h2>
<ul>
<li><a href=https://github.com/sirthias/parboiled/tree/master/examples-java/src/main/java/org/parboiled/examples/abc>ABC Grammar</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Calculators>Calculators</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Java-Parser>Java Parser</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Time-Parser>Time Parser</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e7fc3f9332a7db16b99b057d62a76d6f>3.8 - CH08-Scala APIs</h1>
<p>与 Java 的区别在于规则的构造过程，在 Scala 中使用了特殊的 Scala DSL 构造。相比 Java API，Scala API 更具优势：</p>
<ul>
<li>更加简明的规则构建 DSL(Scala 语言的丰富表现力)。</li>
<li>通过对值栈的进一步抽象隐藏了值栈，增加了类型安全性(Scala Type Inference)。</li>
<li>高阶规则构造。</li>
<li>更快的初次规则构建(不再有昂贵的解析器扩展步骤)。</li>
</ul>
<h2 id=rule-construction>Rule Construction</h2>
<p>一个 PEG 由任意数量的规则组成，规则又可以由其他规则、终止符、或下表中的原语规则组成：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Name</th>
<th style=text-align:center>Common Notation</th>
<th style=text-align:left>Primitive</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>Sequence</td>
<td style=text-align:center>a b</td>
<td style=text-align:left>a ~ b</td>
</tr>
<tr>
<td style=text-align:left>Ordered Choice</td>
<td style=text-align:center>a | b</td>
<td style=text-align:left>a | b</td>
</tr>
<tr>
<td style=text-align:left>Zero-Or-More</td>
<td style=text-align:center>a *</td>
<td style=text-align:left>zeroOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>One-Or-More</td>
<td style=text-align:center>a +</td>
<td style=text-align:left>oneOrMore(a)</td>
</tr>
<tr>
<td style=text-align:left>Optional</td>
<td style=text-align:center>a ?</td>
<td style=text-align:left>optional(a)</td>
</tr>
<tr>
<td style=text-align:left>And-Predicate</td>
<td style=text-align:center>& a</td>
<td style=text-align:left>&(a)</td>
</tr>
<tr>
<td style=text-align:left>Non-Predicate</td>
<td style=text-align:center>! a</td>
<td style=text-align:left>!a</td>
</tr>
</tbody>
</table>
<p>除了以上原语方法，还有以下原语可供使用：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Method/Field</th>
<th style=text-align:left>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>ANY</td>
<td style=text-align:left>匹配任何除了 EOI 的单个字符</td>
</tr>
<tr>
<td style=text-align:left>NOTHING</td>
<td style=text-align:left>不匹配任何，总是失败</td>
</tr>
<tr>
<td style=text-align:left>EMPTY</td>
<td style=text-align:left>不匹配任何，总是成功</td>
</tr>
<tr>
<td style=text-align:left>EOI</td>
<td style=text-align:left>匹配特殊的 EOI 字符</td>
</tr>
<tr>
<td style=text-align:left>ch(Char)</td>
<td style=text-align:left>创建一个匹配单个字符的规则</td>
</tr>
<tr>
<td style=text-align:left>{String} ~ {String}</td>
<td style=text-align:left>匹配给定的字符范围</td>
</tr>
<tr>
<td style=text-align:left>anyOf(String)</td>
<td style=text-align:left>匹配给定字符串中的任意字符</td>
</tr>
<tr>
<td style=text-align:left>ignoreCase(Char)</td>
<td style=text-align:left>匹配单个字符且忽略大小写</td>
</tr>
<tr>
<td style=text-align:left>ignoreCase(String)</td>
<td style=text-align:left>匹配整个字符串且胡烈大小写</td>
</tr>
<tr>
<td style=text-align:left>str(String)</td>
<td style=text-align:left>创建一个匹配整个字符串的</td>
</tr>
<tr>
<td style=text-align:left>nTimes(Int, Rule)</td>
<td style=text-align:left>创建一个匹配子规则 N 次的规则</td>
</tr>
</tbody>
</table>
<h2 id=parser-actions>Parser Actions</h2>
<p>在 Parboiled Java 中需要以布尔表达式的形式设置解析器动作，然后再被自动转换为解析器动作规则。没有进一步的动作类型来支持 Parboiled Java 对值栈操作元素数量进行区分。这意味着 Java 开发者不能依赖编译器来检测解析器动作对值栈操作的一致性(主要是元素数量)。因此在动作的设计期间需要更多对人的规范约束。</p>
<p>在 Parboiled Scala 中，Scala 的类型推断能力使得解析器动作支持比 Java 中更高级别的抽象。在 Scala 解析器动作中，无需对值栈进行操作，而是将其指定为函数。因此，它们不仅仅是简单的代码块，其本身就是类型。</p>
<p>根据规则中包含的解析器动作，规则的实际类型会发生变化。对值栈没有任何影响的规则类型为 Rule0。将类型为 A 的值对象推送到值栈的规则具有类型 <code>Rule1[A]</code>。导致类型分别为 A 和 B 的两个值对象被推送到值栈的规则类型为 <code>Rule2[A,B]</code>。导致类型为 Z 的一个值对象从堆栈中弹出的规则具有类型 <code>PopRule1[Z]</code>。目前共 15 种具体的规则类型。</p>
<p>这种稍微复杂的类结构允许 Scala 在规则类型中进行编码，以确定规则如何影响解析器值堆栈，并确保所有解析器操作正确地协同工作以生成解析器最终结果值。请注意，这不会对值对象的类型施加任何限制！</p>
<p>支持 3 种形式的解析器动作：</p>
<ol>
<li>动作操作符</li>
<li>push/test/run 方法</li>
<li>独立动作</li>
</ol>
<h3 id=action-operators>Action Operators</h3>
<p>共定义了 9 种动作操作符。每种都会链接一个动作函数到语法规则结构，但与它们的动作函数参数的类型和语义不同。下表是一个概览：</p>
<table>
<thead>
<tr>
<th style=text-align:left>Action Result</th>
<th style=text-align:left>Action Argument(String)</th>
<th>Action Argument(Value Object Pop)</th>
<th>Action Argument(Value Object Peek)</th>
<th>Action Argument(Char)</th>
<th>Action Argument(IndexRange)</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>Value Object</td>
<td style=text-align:left>~></td>
<td>~~></td>
<td>~~~></td>
<td>~:></td>
<td>~&#187;</td>
</tr>
<tr>
<td style=text-align:left>Boolean</td>
<td style=text-align:left>~?</td>
<td>~~?</td>
<td>~~~?</td>
<td></td>
<td></td>
</tr>
<tr>
<td style=text-align:left>Unit</td>
<td style=text-align:left>~%</td>
<td>~~%</td>
<td><code>~~~%</code></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>以单个 <code>~</code> 字符起始的操作符通常是解析器动作接收已匹配输入文本的方式。其参数是一个类型为 <code>String => ...</code> 的函数。该操作符内部会创建一个新的动作规则，在运行时，将与紧邻的规则匹配的输入文本作为参数传递给该函数。</p>
<p>以 <code>~~</code> 和 <code>~~~</code> 字符起始的操作符接收一个或多个值对象作为参数。</p>
<p>以 <code>></code> 字符结尾的操作符创建一个或多个新的值对象，在动作函数运行之后推送到值栈。这些动作结构值的类型会被编码到操作符的返回类型。</p>
<p>以 <code>?</code> 字符结尾的操作符接收一个返回布尔值的函数作为语义判定。如果动作函数返回 false 则停止当前规则序列的求值，即为匹配，然后强制解析器回退并查找其他匹配可能。</p>
<p>以 <code>%</code> 字符结尾的操作符支持你运行任意逻辑而不会对处理过程产生影响。其动作函数返回 Unit，一旦解析器经过，它们就会被运行。</p>
<h3 id=pushtestrun-方法>push/test/run 方法</h3>
<p>上述讨论的动作操作符均为将你的动作链接到当前的解析处理过程，要么是接收已匹配的输入文本作为参数，要么是生成新的栈值元素。但有时你的动作并不需要任何输入，因为其在规则结构中的位置就是其需要的所有上下文。这时你可以使用 push/test/run 方法来实现与上述讨论的操作符相同的功能，这些方法由 Parser 特质提供。</p>
<p>由这些方法构造的动作规则可以通过被链接在一起。如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>JsonTrue</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>rule</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#ce5c00;font-weight:700>~</span> <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>True</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=独立动作>独立动作</h3>
<p>独立动作是以 Context 对象作为参数的独立函数。它们可以像普通规则一样被使用，因为 Parser 特质提供了以下两种隐式转换：</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td>toRunAction(f:(Context[Any]) => Unit):Rule0</td>
<td>通用非判断动作</td>
</tr>
<tr>
<td>toTestAction(f:(Context[Any]) => Boolean):Rule0</td>
<td>通用语义判定动作</td>
</tr>
</tbody>
</table>
<p>当前解析的 Context 为通用动作提供了对解析器的所有状态访问能力。它们可以通过 getValueStack 方法来修改解析器的值栈。但并不推荐这种用法，因为这将导致 Scala 编译器无法有效的验证值栈操作的一致性。</p>
<h3 id=withcontext-动作>“withContext” 动作</h3>
<p>Parser 特质提供的另一个便利的工具是 withContext 方法，通过该方法，你可以包装一个动作函数然后再将其传递给动作操作符。该方法支持你的动作函数除了其常规的参数之外还能接收当前解析器的 Context。</p>
<p>withContext 的签名类似如下定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>withContext</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Context</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>因此，被该方法包装的动作函数在外部会显示为一个函数，比如，弹出值栈的两个对象并生成一个新的值。但是，在内部你的动作同样也可以接受到当前上下文的实例，比如可以查看当前输入位置以及行号。</p>
<h2 id=parser-tesing>Parser Tesing</h2>
<p>从 0.9.9.0 开始提供了一个 ParboiledTest 特质来简化测试的开发工作。Parboiled 使用它来完成内部测试，你可以参考 <a href=https://github.com/sirthias/parboiled/blob/master/parboiled-scala/src/test/scala/org/parboiled/scala/WithContextTest.scala>WithContextTest</a> 来查看应用方式。</p>
<h2 id=examples>Examples</h2>
<ul>
<li><a href=https://github.com/sirthias/parboiled/wiki/Simple-Calculator>Simple Calculator</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/JSON-Parser>JSON Parser</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d172300b36f276e75efe2961e9416e8d>3.9 - CH09-Advanced Topics</h1>
<ul>
<li><a href=https://github.com/sirthias/parboiled/wiki/Handling-Whitespace>Handling Whitespace</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Parsing-Performance-Tuning>Performance Tuning</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Indentation-Based-Grammars>Indentation Based Grammars</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/The-ProfilingParseRunner>ProfilingParseRunner</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Grammar-and-Parser-Debugging>Debugging</a></li>
<li><a href=https://github.com/sirthias/parboiled/wiki/Thread-Safety>Thread Safety</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3d1e7c2a6f7ffc9f4f8eab6963ee28b0>4 - Udf Modeling</h1>
</div>
<div class=td-content>
<h1 id=pg-44b7f71194b5e8e3e24267b6e8584135>4.1 - Transport UDF at Linkedin</h1>
<blockquote>
<p><strong>如何使用户能够仅编写一次 UDF，并在任何引擎中复用，同时又不牺牲性能。</strong></p>
</blockquote>
<h1 id=transport-udf-at-linkedin>Transport UDF at Linkedin</h1>
<p>在<a href>统一数据视图</a>一文中，我们介绍了 Dali 的新型架构，它使得数据和逻辑在 Linkedin 的各种环境中能够被无缝访问和共享。Dali 通过采用物理与逻辑独立的原则来实现这一目标。<strong>物理独立性</strong>指的是用户能够透明的访问数据，无论其物理位置、存储格式、分区策略，甚至是跨机房的分片策略。<strong>逻辑独立性</strong>指的是 Dali 的用户自定义逻辑能够用于任何引擎或数据处理框架，而无论其语言接口或数据处理能力如何。作为一个<strong>数据和逻辑的共享层</strong>，Dali 致力于实现这些目标，同时致力于为其服务的关键任务系统提供几乎相同的性能保证。</p>
<p>这里将介绍逻辑独立性的实现原理：可翻译和可移植的 UDF，或者称为可传输的 UDF。</p>
<p>Dali 中的逻辑以 SQL 视图的形式表示。一个 SQL 视图由一系列应用在输入数据集(基本数据集或其他视图)的逻辑转换构成。在 Linkedin，Dali 视图广泛用于汇总和聚合数据、清除数据噪音、提取感兴趣的或相关信息、应用隐私过滤器，或用于组合来自不同源头的数据以从这些数据中创建洞察力和业务价值。<strong>UDF 被广泛的应用于当单纯的 SQL 无法表达应用需要的转换逻辑时</strong>，并且通常涉及诸如 Java 这种命令式语言中所表达的相当复杂的操作。只有在视图逻辑和 UDF 定义都能够跨引擎移植时，才能实现真正的逻辑独立性。虽然用于表达视图转换的关系代数表达式可以映射到不同数据处理引擎的不同声明性语言结构，但 UDF 定义却不同，它是命令式且不透明的，因此这也是挑战所在。</p>
<p>UDF 的 API 在数据处理引擎之间存在很大的差异，因为这些 API 必须考虑每个引擎所选择的 <strong>内部数据表示</strong>，并且必须提供 <strong>将数据表示连接到关系模式的能力</strong>。这种差异则给应用程序开发人员带来了负担，一旦需要进行引擎迁移或者跨引擎共享相同的逻辑，他们必须学习 UDF 的 API 和每个引擎的数据模型，然后在不同的引擎上以不同的 API 来重新实现相同的逻辑。这引入了我们称之为“UDF 非规范化”的概念，即有害的冗余，这会对生产力和工艺产生负面的影响。</p>
<p>基于这些挑战，问题则变成了：<strong>我们如何使用户能够仅编写一次 UDF，并在任何引擎中复用，同时又不牺牲性能</strong>。为了解决这个问题，我们将可翻译、可移植的 UDF 构建为一个框架，名为 Transport。虽然在一开始这似乎是一个疯狂而模糊的想法，但到目前为止，我们已经有很多用户在生产中使用了这些功能，我们目前覆盖了 3 个引擎(Hive/Presto/Spark)和一种数据格式(Avro)，并且仍在扩展其他处理引擎。</p>
<p>Transport 是一套 API 和框架。<strong>用户使用可翻译的 UDF API 来实现 UDF，然后框架再将这些 UDF 转换为各种目标引擎特定的原生 UDF</strong>。比如，用于可以基于 Transport UDF API 实现自己的 UDF，框架可以透明的将这些 UDF 转换为原生的 Hive UDF，就像用户直接编写的就是 Hive UDF。现在，如果用户想要在其他引擎中使用这些 UDF 也同样没有问题。比如，如果用户想要在 Presto 查询中使用相同的 UDF，框架同样可以透明的将这些 UDF 转换为 Presto 原生的 UDF，就像用户直接编写的就是 Presto UDF 一样。</p>
<p>在解释 Transport 的工作原理之前，我们先来浏览一下该想法背后的动机，主要有两点：UDF API 的差异性和复杂性。</p>
<h2 id=udf-api-的差异性>UDF API 的差异性</h2>
<p>数据处理世界中有很多引擎，每个都有各自的特性以满足某个特定的应用场景。同样，每个引擎也都拥有与其他引擎完全不同的 UDF API，这里具体列举其中一些主要的不同点，包括 3 个比较流行的引擎：Hive、Presto、Spark。</p>
<h3 id=udf-类型验证与推断>UDF 类型验证与推断</h3>
<p>UDF API 通常会为用户提供一些手段来指定 UDF 预期的数据类型(如类型验证)、UDF 的输出类型与输入类型的关联关系(类型推断)。比如 Presto 的 UDF API 使用类型签名来描述 UDF 对类型的预期要求，而 Hive 和 Spark 则要求用户通过遍历给定的类型对象树来编写命令式的代码来表示类型验证和推断。</p>
<h3 id=引擎内部数据模型>引擎内部数据模型</h3>
<p>不同的平台使用不同的数据模型来表示执行引擎中处理的数据，同样也会将这些数据模型直接暴露给 UDF API。比如，Presto 的 UDF 使用 Presto 的 Type Object、Block、Slice、Long、boolean、double 等数据类型来描述数据，而 Hive 的 UDF 使用 ObjectInspectors 和 Objects。其他引擎也类似。</p>
<h3 id=udf-的定义-api>UDF 的定义 API</h3>
<p>此外，用户定义 UDF 的方式也随着引擎的不同的不同。比如，Presto 使用特殊的类型注解来声明一个表示 UDF 的类。Hive UDF 类则需要继承 GenericUDF 抽象类，而 Spark UDF 实现则使用 SQL API 或 Expression API。</p>
<h3 id=udf-的-api-特性>UDF 的 API 特性</h3>
<p>最后，UDF API 提供的特性集也不尽相同。比如，Hive UDF 提供了将文件添加到 MapReduce 分布式缓存的钩子，允许在不同工作程序上执行的 UDF 处理这些文件。Presto 或 Spark 的 UDF 则不提供这种功能。即使多个引擎中都存在某个功能，其在 API 中的表达方式也会有所不同。Presto UDF 允许用户声明哪些参数可以为空，而 Hive 和 Spark UDF 将 null 直接委托给用户。Presto 通过在使用相同名称的情况下多次实现 UDF 来实现 UDF 重载。在 Hive 和 Spark 中，用户使用相同的类，但需要手动检查输入类型是否是符合预期的类型。</p>
<h2 id=udf-api-的复杂性>UDF API 的复杂性</h2>
<p>当前引擎的 API 具有不同程度的复杂性和对 UDF 开发者技能集的期望。比如，Hive UDF 要求开发者理解 Object 和 ObjectInspector 模型。期望用户在 UDF 初始化时捕获输入的 ObjectInspectors，并以树遍历的方式逐级检查来验证它是否符合预期类型。此外，还期望用户通过捕获输入的 ObjectInspectors 子树并从中创建新的 ObjectInspectors 树来显式绑定参数，以作为输出 ObjectInspectors 返回。比如 UDF 期望类型为 <code>Map[String, Array[K]] => Map[K, K]</code>，在查询执行时，会使用 <code>Map[String, Array[K]]</code> 来调用 UDF，下面的对象检查器树会被传给 UDF 的初始化方法：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190116144344.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>需要由开发者来完成树遍历的工作，验证上面的蓝色节点是否符合用户预期，然后再捕获灰色节点的值(或子树)，这里是 K，然后通过将绿色节点添加到从 K 子树捕获的内容来构建下面的树，从而构造返回类型，如下图所示：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190116171758.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>此外在 Hive 中，甚至是单个类的 ObjectInspectors(如 StringObjectInspector)也具有该类相同顶级 ObjectInspector 类的变体和不同实现。编写 Hive UDF 的用户必须了解这些差异，并且不同的实现不可互换。处理这些可互换性检查和保证时会带来大量的代码复杂性。</p>
<p>在 Presto UDF 中可以发现另一种形式的 API 复杂性。Presto UDF 允许用户通过 Block API 处理容器数据类型，如 Array、Map、Struct，Block API 是用于操作字节数组的 API。因此，用户会接触到字节数组内复杂数据类型的物理布局，并且必须编写多个步骤的低级操作来表示在这些容器类型上的简单高级操作。另一个例子是使用依赖项注入来解析与泛型类型数组相对应的具体运行时类型，以及解析 UDF 依赖项。此外，当 UDF 期望顶级泛型类型(即它可以采用任何类型)时，必须为每个匹配的顶级具体类型的每个实例重新实现，实现数量的增加使得泛型参数的数量呈指数级增长。虽然通过编写代码生成的 UDF 可以缓解这个问题，但也仍然是一种复杂的方法。</p>
<h2 id=可传输的-udf>可传输的 UDF</h2>
<p>在物理和逻辑独立性的驱动下，以及 API 差异和复杂性问题的推动下，我们设计的 Transport UDF API，它支持用户专注于 UDF 逻辑，而不是实现和遵守特定于平台的接口。用户编写一次逻辑就可以在任何平台上运行。</p>
<p>高阶想法是为用户提供一个用于实现 UDF 的标准数据 API。该标准数据 API 可以由任何平台、使用其在原生 UDF 中使用的原生数据类型来实现。比如，Map 对象将在 Presto 中显示为 PrestoMapType 以及 Block 数据类型。在 Hive 中则是 MapObjectInspector 和一个 Object。这些标准数据 API 被操作仅可传输 UDF API，来表达标准数据上的实际逻辑。</p>
<p>可传输 UDF API 可以通过类型签名来操作泛型容器类型，如 <code>Array[T]</code> 或 <code>Map[K,V]</code>。可传输 UDF 被构造为抽象类，并被表达实际逻辑的具体 UDF 继承。最后，可以从自动生成的特定于平台的包装器来调用这些 UDF API。这意味着，可传输 UDF API 实现是一个独立于平台的中间表示逻辑。它也有两个特定于平台的外观，可以很容易的提供给用户。一个外观向下，这是特定于平台的标准数据 API 实现，另一个外观向上，这是特定于平台的自动生成的包装器。该家头如图所示：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190116151520.png style=display:block;width:50% alt=NAME align=center>
</div>
<h3 id=示例>示例</h3>
<p>如上所述，用户所要做的就是定义可传输 UDF。在下面的例子中，接收两个数组作为输入来构造一个 Map——第一个数组作为 Map 的键，第二个数组作为 Map 的值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MapFromTwoArraysFunction</span> 
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>StdUDF2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StdArray</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StdArray</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StdMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span> 
  <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TopLevelStdUDF</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>StdType</span> <span style=color:#000>_mapType</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getInputParameterSignatures</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ImmutableList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;array(K)&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;array(V)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getOutputParameterSignature</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;map(K,V)&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StdFactory</span> <span style=color:#000>stdFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stdFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>_mapType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStdFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createStdType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getOutputParameterSignature</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StdMap</span> <span style=color:#000>eval</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StdArray</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StdArray</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>StdMap</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStdFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>_mapType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFunctionName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;map_from_two_arrays&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFunctionDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;A function to create a map out of two arrays&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面的例子中，StdMap 和 StdArray 作为接口为 Map 和 Array 对象提供了高阶操作方法。基于 UDF 所要执行的引擎，这些接口会以不同的方式来处理特定引擎的原生数据类型。<code>getStdFactory()</code> 方法会以给定的数据类型来创建对象，比如上面的例子中，Map 的键类型以第一个数组的元素类型为准，Map 的值类型以第二个数组的元素类型为准。StdUDF2 是一个抽象类，表示一个接收两个参数的 UDF，被具体 UDF 的输入输出类型来参数化。</p>
<h2 id=总结>总结</h2>
<p>Transport 作为定义 UDF 的 API 和框架，在不牺牲任何性能的同时能够在不同平台上像使用原生 UDF 一样来复用 UDF。这是实现物理与逻辑独立性目标的第一步。被当前 UDF 的差异性和复杂性所驱动。在 LinkedIn，事实证明，可传输 UDF 是提供开发人员工作效率的强大工具，使他们能够共享 UDF 逻辑并确保跨引擎的数据处理一致性。</p>
<h2 id=udf-的其他应用场景与问题>UDF 的其他应用场景与问题</h2>
<h3 id=统一数据处理-apiapache-beam>统一数据处理 API：Apache Beam</h3>
<p>在 Apache Beam 的技术愿景中，希望可以使用任意语言 Beam SDK 编写 Beam Pipeline，然后可以运行在任何 Runner 中(每个 Runner 对应一个底层的大数据引擎，例如 Flink Runner、Spark Runner)的能力。设计中通过两个可移植的层来实现这个目标：</p>
<ul>
<li>Runner API 层提供了 SDK 和 Runner 无关的 Pipeline 定义。</li>
<li>Fn API 层，允许 Runner 调用使用特定语言 SDK 编写的 UDF(用户自定义函数)。</li>
</ul>
<h3 id=通用数据处理框架apache-nifi>通用数据处理框架：Apache Nifi</h3>
<p>Nifi 中预定义了大量的 Processor，并支持自定义。Processor 本身仍然可以被看做是扩展了 Nifi 执行上下文的 Function。</p>
<p>Nifi 提供了表达式来操作 FlowFile 的属性，用于配置处理器。表达式有 Antlr 解析，其中的执行函数由 <code>Evaluator</code> 类建模，Evaluator 的建模过程也与 Function 抽象类似，值得借鉴。</p>
<h3 id=流式计算引擎apache-flink>流式计算引擎：Apache Flink</h3>
<p>Flink 中将函数分为 3 类：</p>
<ul>
<li>Scalar Functions，将零个、一个或多个标量值转换到一个标量值。</li>
<li>Table Functions，将零个、一个或多个标量值转换到多个数据行。</li>
<li>Aggregation Functions，将一个表转换为一个标量值。</li>
</ul>
<p>用户自定义并注册函数之后，可以直接在 Table、SQL API 中使用。</p>
<h3 id=流式计算引擎aliyunantfin-maxcompute>流式计算引擎：Aliyun(Antfin) MaxCompute</h3>
<p>MaxCompute 与 Flink 类似将函数分为三类，但通过注解或反射来获得函数的类型签名。</p>
<h3 id=规则引擎drools>规则引擎：Drools</h3>
<p>如果业务逻辑复杂，通常会使用规则引擎来代替大量的 if-else 语句。在 Drools 规则定义中，when 部分的断言函数和字段引用、then 部分的数据操作函数都需要应用到函数建模来实现业务特定的计算逻辑。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>when
  $s : Order(amout &gt; 500 &amp;&amp; amout &lt;= 1000)
then
  $s.setScore(500);
  update($s);
</code></pre></div><h3 id=消息路由规则apache-camel>消息路由规则：Apache Camel</h3>
<p>Camel 中提供了各种 DSL 或 XML 配置来完成路由规则的定义，如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>from(&#34;file:src/data?noop=true&#34;)
  .choice()
  .when(xpath(&#34;/person/city = &#39;London&#39;&#34;))
    .to(&#34;file:target/messages/uk&#34;)
  .otherwise()
    .to(&#34;file:target/messages/others&#34;);
</code></pre></div><p>对函数的应用主要集中在 when 部分的数据引用与值判定，这里使用的是 xpath 表达式。</p>
<h3 id=有限状态机>有限状态机</h3>
<p>在有限状态机中，需要定义状态的迁移条件，迁移条件中包含对领域模型的数据引用、求值与判定，同样需要使用函数建模。</p>
<h3 id=业务应用集成>业务应用集成</h3>
<p>总的来说，需要在各个层次和维度上，面向业务场景或业务层框架提供一组通用的函数建模 API，以提升业务开发和框架开发的效率。比如：</p>
<ul>
<li>定义较为宽泛的类型系统，以支持对各种引擎、框架中 UDF 的集成。</li>
<li>为原生类型提供预定义的函数(或称为算子)，以便直接引用来(动态)构建更加复杂的函数。</li>
<li>支持基于原生类型构建复杂类型，并为这些复杂类型定义函数。</li>
<li>支持直接以代码形式，定义、注册、调用类型安全的函数。</li>
<li>支持以字符串表达式形式来定义函数，以满足动态(定义、更新、执行)场景。</li>
<li>支持以类似 IDE GUI Plugin 插件的形式定义、引用、执行函数。</li>
<li>支持函数式的、类型安全的链式调用、组合、柯里化。</li>
<li>提供良好的扩展机制，以优雅的、类型安全的方式扩展、引用函数。</li>
<li>提供良好的集成机制，以简便的方式将函数适配到其他框架、引擎以实现复用。</li>
<li>提供良好的测试机制，使得函数可测试、且能简化测试过程。</li>
</ul>
<h2 id=references>References</h2>
<ul>
<li><a href=https://engineering.linkedin.com/blog/2018/11/using-translatable-portable-UDFs>Transport UDFs</a></li>
<li><a href=https://beam.apache.org/documentation/programming-guide/#composite-transforms>Apache Beam</a></li>
<li><a href=https://nifi.apache.org/docs/nifi-docs/html/nifi-in-depth.html>Apache NiFi In Depth</a></li>
<li><a href=https://nifi.apache.org/docs.html>Apache NiFi Docs</a></li>
<li><a href=https://ci.apache.org/projects/flink/flink-docs-release-1.7/dev/table/udfs.html#scalar-functions>Flink UDF</a></li>
<li><a href=https://tech.antfin.com/docs/2/27867#h2-url-5>Aliyun(Antfin) MaxCompute UDF</a></li>
<li><a href=https://docs.jboss.org/drools/release/7.15.0.Final/drools-docs/html_single/>Drools Docs</a></li>
<li><a href=http://camel.apache.org/java-dsl.html>Apache Camel Routing DSL</a></li>
<li><a href=http://www.vavr.io/vavr-docs/#_functions>Java Vavr functions</a></li>
<li><a href=https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/Lambda-QuickStart/index.html>Java SE8 Lambda</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7b184dd3e82373d1771186dcbfbbe498>4.2 - Flink Type System</h1>
<blockquote>
<p><strong>为什么以及如何构建一个类型系统。</strong></p>
</blockquote>
<p>Flink 在内部构建了一套自己的类型系统，因为 Flink 需要推导那些在分布式计算过程中被传输和存储的数据的相关类型信息。就像数据库对表结构的引用一样。在大多数情况下，Flink 均使用自己的这套类型系统来无缝的推导类型信息。基于丰富的类型类型信息，Flink 可以完成更多功能的实现，如：</p>
<ul>
<li>使用 POJO 类型，并通过对其字段名的引用来执行 grouping、joining、aggregating。类型信息能够帮助 Flink 在早期完成检查(拼写错误或类型兼容性)，而非在运行时导致失败。</li>
<li>Flink 对类型信息了解越多，序列化和数据布局结构则会更好。这对于 Flink 中内存的应用范式是非常重要的(尽可能在堆内外处理序列化数据，以使得序列化过程变得廉价)。</li>
<li>避免用户在大多数情况下对序列化框架的担心，同时避免对类型的手动注册过程。</li>
</ul>
<h2 id=类型层级>类型层级</h2>
<ul>
<li>Basic
<ul>
<li>Java Primitive Types</li>
<li>void/String/Date/BigDecimal/BigInteger</li>
</ul>
</li>
<li>Array
<ul>
<li>Array of Primitive</li>
<li>Array of Object</li>
</ul>
</li>
<li>Composite
<ul>
<li>Java Tuple, max 25 fields</li>
<li>Scala case class/tuple, max 22 fields</li>
<li>Row, tuples with any number fields</li>
<li>POJO, bean-like class</li>
</ul>
</li>
<li>Auxiliary
<ul>
<li>Option/Either/List/Map&mldr;</li>
</ul>
</li>
<li>Generic
<ul>
<li>Using Kryo</li>
</ul>
</li>
</ul>
<h2 id=抽象结构>抽象结构</h2>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/:Users:zhange:Downloads:FlowStateModeler.jpg style=display:block;width:90% alt=NAME align=center>
</div>
<p>可以看到，抽象结构与类型层级定义基本对应。<code>TypeInformation</code> 是所有类型的基类。</p>
<blockquote>
<p>module: flink-core</p>
<p>package: org.apache.flink.api.common.typeinfo</p>
<p>Comments on TypeInformation class:</p>
<ul>
<li>这是 Flink 类型系统的核心类。对于一个用户函数来说(UDF)，Flink 需要一个类型信息来作为该函数的输入输出类型。该类型信息类作为一个工具来生成对应类型的序列化器和比较器，并用于执行语义检查，比如当一些字段在作为 joing 或 grouping 的键时，检查这些字段是否在该类型中存在。</li>
<li>该类型信息同时连接了编程语言对象模型和逻辑扁平模式(ligical flat schema)。它将类型的字段映射到扁平模式的列(字段)。</li>
</ul>
</blockquote>
<h2 id=类型提取>类型提取</h2>
<p><code>TypeExtractor</code> 类可以根据方法签名、子类信息等蛛丝马迹自动提取或恢复类型信息。</p>
<blockquote>
<p>module: flink-core</p>
<p>package: org.apache.flink.api.java.typeutils
s
Comments on TypeExtractor class:</p>
<p>一个对类进行反射分析的工具类，用于检测转换函数的返回类型。
该类可以从 function、operator、Class、实例等对象中提取类型信息。</p>
</blockquote>
<p>由于 Java 中的类型擦除机制，自动提起并不是很有效，因此有些情况下(比如由 URLClassLoader 动态加载的类)仍然需要手动处理。比如下面的示例中使用 <code>returns</code> 方法来声明返回类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>inputDS</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>groupBy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>gourpKeys</span><span style=color:#204a87;font-weight:700>:_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reduce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DistinctReduce</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setCombineHint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CombineHint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HASH</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;distinct&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>returns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getType</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p><code>returns</code> 方法接收 3 种类型的参数：</p>
<ol>
<li>字符串描述的类名，如 “String”。</li>
<li>用于泛型类型参数的 TypeHint。</li>
<li>Java 原生 Class 对象。</li>
</ol>
<h2 id=类型注册>类型注册</h2>
<p><code>ExecutionEnvironment</code> 提供的 <code>registerType</code> 方法可以用来向 Flink 注册子类信息(Flink 认识父类，但不一定认识子类的一些独特特性，因此需要注册)。以 Flink-ML 为例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>registerFlinkMLTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionEnvironment</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Vector types
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.DenseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.SparseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  
  <span style=color:#8f5902;font-style:italic>// Matrix types
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.DenseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>org.apache.flink.ml.math.SparseVector</span><span style=color:#ce5c00;font-weight:700>])</span>
  
  <span style=color:#8f5902;font-style:italic>// Breeze Vector types
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>breeze.linalg.DenseVector</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]])</span>
  <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>breeze.linalg.SparseVector</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]])</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 <code>registerType</code> 方法内部，会使用 <code>TypeExtractor</code> 来提取类型信息。上面注册过程中调用的方法是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointException</span><span style=color:#ce5c00;font-weight:700>(...);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>TypeInformation</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TypeExtractor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTypeInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeInfo</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>PojoTypeInfo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerPojoType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerKryoType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以发现，获取到的类型信息属于 PojoTypeInfo 及其子类，那么将其注册到一起；否则统一交给 Kryo 去处理，Flink 并不过问(这种情况下性能会变差)。</p>
<h2 id=类型声明>类型声明</h2>
<p>通过 <code>TypeInformation.of()</code> 方法可以非常方便的创建类型信息对象。</p>
<ol>
<li>对于非泛型类，直接传入 Class 对象即可：
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=color:#000>Outer</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Inner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>4L</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>PojoTypeInfo</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>typeInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PojoTypeInfo</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>TypeInformation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li>
<li>对于泛型类，需要借助 TypeHint 来保存泛型类型信息。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TypeInfomation</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Tuple2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> 
     <span style=color:#000>TypeInformation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeHint</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Tuple2</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;(){});</span>
</code></pre></div><ul>
<li>TypeHint 的原理是创建一个匿名子类，运行时 TypeExtractor 可以通过 <code>getGenericSuperclass().getActuralTypeArguments()</code> 方法来回去保存的实际类型。</li>
</ul>
<ol start=3>
<li>预定义常量。如 BasicTypeInfo 中定义了一系列常用原生类型的类型信息实例。或者直接使用更简单的 Types 类。</li>
<li>自定义 TypeInfo 和 TypeInfoFactory。
<ul>
<li>通过自定义 TypeInfo 为任意类提供 Flink 原生内存管理(而非 Kryo)，可令存储更紧凑，运行时也更高效。</li>
<li>开发者在自定义类上使用 @TypeInfo 注解，随后创建相应的 TypeInfoFactory 并覆盖 createTypeInfo 方法。</li>
<li>注意需要继承 TypeInformation 类，为每个字段定义类型，并覆盖元数据方法，例如 isBasicType、isTupleType、元数(对于一维的 Row 类型，等于字段的个数)等等，从而为 TypeExtractor 提供决策依据。</li>
</ul>
</li>
</ol>
<h2 id=类型序列化>类型序列化</h2>
<p>Flink 自带了很多 TypeSerializer 子类，大多数情况下各种自定义类型都是常用类型的排列组合，因而可以直接复用。</p>
<p>如果不能满足，可以继承 TypeSerializer 及其子类来实现自己的特定类型的序列化器。</p>
<h3 id=kryo-序列化>Kryo 序列化</h3>
<h2 id=陷阱与缺陷>陷阱与缺陷</h2>
<ul>
<li>Lambda 函数的类型提取?</li>
<li>Kryo 的 JavaSerializer 在 Flink 下存在 Bug?</li>
</ul>
<h2 id=类型机制与内存管理>类型机制与内存管理</h2>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190130161127.png style=display:block;width:40% alt=类型信息到内存块 align=center>
</div>
<p>下面以 StringSerializer 为例，来看下 Flink 是如何紧凑管理内存的。下面是 StringSerializer 的序列化方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>serialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DataOutputView</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>StringValue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后是具体的序列化过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writeString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CharSequence</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DataOutput</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>thorws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// the length we write is offset by one, because a length of zero indicates a null value
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// write the length, variable-length ecdoded
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>lenToWrite</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;=</span> <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lenToWrite</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>charAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
      
      <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>HIGH_BIT</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;=</span> <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，Flink 对于内存管理是非常细致的，层次分明，代码也容易理解。</p>
<h2 id=reference>Reference</h2>
<ul>
<li><a href=https://ci.apache.org/projects/flink/flink-docs-release-1.7/dev/types_serialization.html>Apache Flink Reference</a></li>
<li><a href=https://www.cnblogs.com/fxjwind/p/6294237.html>Flink - TypeInformation</a></li>
<li><a href=https://segmentfault.com/a/1190000016350098>Flink - Type System</a></li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script>
<script>docsearch({apiKey:'123',indexName:'infilos_com',inputSelector:'.td-search-input',debug:!1})</script>
</body>
</html>