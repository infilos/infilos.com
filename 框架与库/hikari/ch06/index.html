<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>优化原理 | infilos.com</title><meta property="og:title" content="优化原理">
<meta property="og:description" content="获取连接 HikariCP 可以被理解为一个简单的 BlockingQueue，它实际上并没有使用 BlockingQueue，而是使用了一种被称为 ConcurrentBag 的专用集合，但在行为概念上是类似的。在这个 BlockingQueue 的模型上，可以想象你的客户端调用 HikariDataSource 的 getConnection 方法执行着如下的工作：
public Connection getConnection() throws SQLException { return connectionQueue.poll(timeout); } 显然会有更多的事情发生，比如抛出超时异常等，如上是基本的思路。调用 Connection.close 方法实质上返回到池的连接，同样，还有很多具体细节，但概念是相通的。
public void close() throws SQLException { connectionQueue.put(this); } HikariCP 确实有几个自己的线程，有一个 HouseKeeper 管家线程定期运行以退出空闲连接，有一个调度线程可以退出到达 maxLifetime 的连接，还有一个用于添加连接的线程，以及一个用于关闭它们的线程等。接下来，我们从获取连接部分开始仔细研究源码级的原理。
获取连接是 HikariCP 的核心功能，HikariDataSource 对象首先通过 getConnection 方法获得 HikariPool 真正的 getConnection 方法，HikariPool 内部通过我们介绍过的 ConcurrentBag 的 borrow 方法获取 PoolEntry，它将首先尝试从线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。最后通过 PoolEntry 执行 Create Proxy Connection 方法创建一个物理连接并返回其代理连接 Proxy Connection。具体的时序图如图所示。
 HikariDataSource，顾名思义，就是 HikariCP 对外提供给用户的定制化的 DataSource，使用 Spring 的用户可以直接将它作为数据源。用户也可以直接初始化 HikariDataSource：">
<meta property="og:type" content="article">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch06/"><meta property="article:section" content="框架与库">
<meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="优化原理">
<meta itemprop=description content="获取连接 HikariCP 可以被理解为一个简单的 BlockingQueue，它实际上并没有使用 BlockingQueue，而是使用了一种被称为 ConcurrentBag 的专用集合，但在行为概念上是类似的。在这个 BlockingQueue 的模型上，可以想象你的客户端调用 HikariDataSource 的 getConnection 方法执行着如下的工作：
public Connection getConnection() throws SQLException { return connectionQueue.poll(timeout); } 显然会有更多的事情发生，比如抛出超时异常等，如上是基本的思路。调用 Connection.close 方法实质上返回到池的连接，同样，还有很多具体细节，但概念是相通的。
public void close() throws SQLException { connectionQueue.put(this); } HikariCP 确实有几个自己的线程，有一个 HouseKeeper 管家线程定期运行以退出空闲连接，有一个调度线程可以退出到达 maxLifetime 的连接，还有一个用于添加连接的线程，以及一个用于关闭它们的线程等。接下来，我们从获取连接部分开始仔细研究源码级的原理。
获取连接是 HikariCP 的核心功能，HikariDataSource 对象首先通过 getConnection 方法获得 HikariPool 真正的 getConnection 方法，HikariPool 内部通过我们介绍过的 ConcurrentBag 的 borrow 方法获取 PoolEntry，它将首先尝试从线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。最后通过 PoolEntry 执行 Create Proxy Connection 方法创建一个物理连接并返回其代理连接 Proxy Connection。具体的时序图如图所示。
 HikariDataSource，顾名思义，就是 HikariCP 对外提供给用户的定制化的 DataSource，使用 Spring 的用户可以直接将它作为数据源。用户也可以直接初始化 HikariDataSource：">
<meta itemprop=wordCount content="1755">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="优化原理">
<meta name=twitter:description content="获取连接 HikariCP 可以被理解为一个简单的 BlockingQueue，它实际上并没有使用 BlockingQueue，而是使用了一种被称为 ConcurrentBag 的专用集合，但在行为概念上是类似的。在这个 BlockingQueue 的模型上，可以想象你的客户端调用 HikariDataSource 的 getConnection 方法执行着如下的工作：
public Connection getConnection() throws SQLException { return connectionQueue.poll(timeout); } 显然会有更多的事情发生，比如抛出超时异常等，如上是基本的思路。调用 Connection.close 方法实质上返回到池的连接，同样，还有很多具体细节，但概念是相通的。
public void close() throws SQLException { connectionQueue.put(this); } HikariCP 确实有几个自己的线程，有一个 HouseKeeper 管家线程定期运行以退出空闲连接，有一个调度线程可以退出到达 maxLifetime 的连接，还有一个用于添加连接的线程，以及一个用于关闭它们的线程等。接下来，我们从获取连接部分开始仔细研究源码级的原理。
获取连接是 HikariCP 的核心功能，HikariDataSource 对象首先通过 getConnection 方法获得 HikariPool 真正的 getConnection 方法，HikariPool 内部通过我们介绍过的 ConcurrentBag 的 borrow 方法获取 PoolEntry，它将首先尝试从线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。最后通过 PoolEntry 执行 Create Proxy Connection 方法创建一个物理连接并返回其代理连接 Proxy Connection。具体的时序图如图所示。
 HikariDataSource，顾名思义，就是 HikariCP 对外提供给用户的定制化的 DataSource，使用 Spring 的用户可以直接将它作为数据源。用户也可以直接初始化 HikariDataSource：">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
</div>
<div id=content-desktop></div>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-e6a186e69eb6e4b88ee5ba93><span>框架库</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring><span>Spring</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch01-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc><span>CH01-IOC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch02-springioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc><span>CH02-Spring IOC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch03-bean%E5%8A%A0%E8%BD%BD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd><span>CH03-Bean加载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch04-ioc%E6%BA%90%E7%A0%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081><span>CH04-IOC源码</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch05-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596><span>CH05-循环依赖</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch07><span>CH07-动态代理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch08><span>CH08-接口定义</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch09><span>CH09-请求过程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch10><span>CH10-配置注入</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch11><span>CH11-配置绑定</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch12><span>CH12-环境变量</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc><span>Spring IOC</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01><span>CH01-获取单例 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02><span>CH02-创建单例 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03><span>CH03-创建原始 Bean 对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04><span>CH04-解决循环依赖</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05><span>CH05-原始 Bean 属性填充</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06><span>CH06-后续初始化工作</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07><span>CH07-生命周期扩展</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08><span>CH08-控制加载顺序</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-aop-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-aop><span>Spring AOP</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01><span>AOP 理论</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02><span>AOP 实战</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93mybatis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93mybatis><span>Mybatis</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01><span>CH01-整体架构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02><span>CH02-反射模块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03><span>CH03-基础支持模块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04><span>CH04-运行配置解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05><span>CH05-通用配置解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06><span>CH06-语句解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07><span>CH07-接口层</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08><span>CH08-执行器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09><span>CH09-集成 Spring</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10><span>CH10-整体流程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11><span>CH11-插件机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12><span>CH12-代码生成</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13><span>CH13-多数据源</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14><span>CH14-常用片段</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93hikari-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93hikari><span>Hikari</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich01><span>基本概念</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich02><span>开源实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich03><span>配置参数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich04><span>JDBC API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich05><span>性能原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-e6a186e69eb6e4b88ee5ba93hikarich06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch06/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich06><span class=td-sidebar-nav-active-item>优化原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich07><span>参数解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich08><span>动态代理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich09><span>应用实践</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich10><span>监控度量</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich11><span>常见问题</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93hikarich12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich12><span>扩展技术</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93unified-udf-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93unified-udf><span>Udf Modeling</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/transport-at-linkedin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin><span>Transport UDF at Linkedin</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/flink-type-system/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system><span>Flink Type System</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93parboiled-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93parboiled><span>Parboiled</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch01-motivation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation><span>CH01-Motivation</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch02-features/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features><span>CH02-Features</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch03-java-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example><span>CH03-Java Example</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch04-scala-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example><span>CH04-Scala Example</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch05-comparison/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison><span>CH05-Comparison</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch06-concepts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts><span>CH06-Concepts</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch07-java-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis><span>CH07-Java APIs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch08-scala-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis><span>CH08-Scala APIs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch09-advanced-topics/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics><span>CH09-Advanced Topics</span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/infilos/infilos.com/edit/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari/CH06.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/infilos/infilos.com/new/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari/CH06.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/infilos/infilos.com/issues/new?title=%e4%bc%98%e5%8c%96%e5%8e%9f%e7%90%86" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#获取连接>获取连接</a>
<ul>
<li><a href=#细节单例池初始化>细节：单例池初始化</a></li>
<li><a href=#细节连接有效性>细节：连接有效性</a></li>
<li><a href=#细节创建形式>细节：创建形式</a></li>
<li><a href=#过程总结>过程总结</a></li>
<li><a href=#连接有效性>连接有效性</a></li>
<li><a href=#连接监控>连接监控</a></li>
</ul>
</li>
<li><a href=#归还连接>归还连接</a></li>
<li><a href=#关闭连接>关闭连接</a></li>
<li><a href=#生成连接>生成连接</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>框架库</a>
</li>
<li class=breadcrumb-item>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/>Hikari</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch06/>优化原理</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>优化原理</h1>
<header class=article-meta>
</header>
<h2 id=获取连接>获取连接</h2>
<p>HikariCP 可以被理解为一个简单的 BlockingQueue，它实际上并没有使用 BlockingQueue，而是使用了一种被称为 ConcurrentBag 的专用集合，但在行为概念上是类似的。在这个 BlockingQueue 的模型上，可以想象你的客户端调用 HikariDataSource 的 getConnection 方法执行着如下的工作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>显然会有更多的事情发生，比如抛出超时异常等，如上是基本的思路。调用 Connection.close 方法实质上返回到池的连接，同样，还有很多具体细节，但概念是相通的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariCP 确实有几个自己的线程，有一个 HouseKeeper 管家线程定期运行以退出空闲连接，有一个调度线程可以退出到达 maxLifetime 的连接，还有一个用于添加连接的线程，以及一个用于关闭它们的线程等。接下来，我们从获取连接部分开始仔细研究源码级的原理。</p>
<p>获取连接是 HikariCP 的核心功能，HikariDataSource 对象首先通过 getConnection 方法获得 HikariPool 真正的 getConnection 方法，HikariPool 内部通过我们介绍过的 ConcurrentBag 的 borrow 方法获取 PoolEntry，它将首先尝试从线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。最后通过 PoolEntry 执行 Create Proxy Connection 方法创建一个物理连接并返回其代理连接 Proxy Connection。具体的时序图如图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719225932.png style=display:block;width:80% alt=NAME align=center> </div>
<p>HikariDataSource，顾名思义，就是 HikariCP 对外提供给用户的定制化的 DataSource，使用 Spring 的用户可以直接将它作为数据源。用户也可以直接初始化 HikariDataSource：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>HikariDataSource</span> <span style=color:#000>ds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HikariDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setJdbcUrl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbc:mysql://localhost:3306/simpsons&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bart&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPassword</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;51mp50n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>HikariDataSource 继承了 HikariConfig，并且实现了 JDCB 基础中介绍过的 javax.sql 扩展包中的 DataSource 接口。作为 DriverManager 设施的替代项，DataSource 对象是获取连接的首选方法，实现 DataSource 接口的对象通常在基于 JavaTM Naming and Directory Interface (JNDI) API 的命名服务中注册。</p>
<p>HikariConfig 是 HikariCP 的配置管理核心类，它实现了 HikariConfigMXBean 接口，用来对外暴露 HikariCP 配置相关的 JMX 监控和管理功能。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719230214.png style=display:block;width:70% alt=NAME align=center> </div>
<p>在创建连接的过程中，有几个细节性的问题可以从源码级重点关注一下。</p>
<h3 id=细节单例池初始化>细节：单例池初始化</h3>
<p>HikariDataSource 获取连接 getConnection 的单例处理。大家都知道，在实现单例模式时，如果未考虑多线程的情况，很可能会造成实例化了多次并且被不同对象持有。在 JDK1.5 或者更晚的版本中，扩展了 volatile 的语义，使用了 volatile 关键字后，重排序被禁止，双重检查锁可以减少开销。如果没有 volatile 关键字则可能由于指令重排导致 HikariPool 对象 pool 在多线程下无法正确地初始化，volatile 禁止了指令重排，并强制本地线程读取主存。由于数据库连接池处于一个激烈的被频繁调用的位置，HikariCP 的源码部分就使用双重检查锁进行单例初始化。以下是 HikariDataSource 中的部分源码代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HikariPool</span> <span style=color:#000>fastPathPool</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>HikariPool</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//注意这里引入了volatile
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isClosed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>//检查数据源是否已经关闭，如果关闭则抛出异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;HikariDataSource &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; has been
</span><span style=color:#4e9a06>closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fastPathPool</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//如果当前引用HikariPool不为空，则直接返回连接
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fastPathPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>HikariPool</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//典型的双重检验锁代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>validate</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//参数校验，主要是检查参数是否合法并给予默认值
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                      <span style=color:#000>pool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HikariPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//初始化连接池
</span><span style=color:#8f5902;font-style:italic></span>                      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>seal</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PoolInitializationException</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>pie</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Start completed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//从连接池中返回一个连接，返回给HikariPool资源池与ConcurrentBag进行交互
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=细节连接有效性>细节：连接有效性</h3>
<p>另一个细节是获取连接时的有效性检查。当从资源池里面获取到资源后，需要检查该资源的有效性，如果失效，则再次获取连接，这样可以避免执行业务的时候报错。这部分的工作是由 HikariPool 做的，它通过判断 PoolEntry 是否已经被标记清除了、当前 PoolEntry 的存活时间是否过期及当前连接是否活着 3 项进行判断，如果超时则关闭这个 PoolEntry 的连接、重置超时时间、再次获取连接。这部分的核心实现在 HikariPool 的 getConnection 方法里，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hardTimeout</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//从connectionBag中借用连接，借用过程中会发生创建连接、连接过期、空闲等事情
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>borrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//中断，跳出循环，并抛出异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>now</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//记录当前时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastAccessed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>aliveBypassWindowMs</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isConnectionAlive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//有效性检查
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>EVICTED_</span> <span style=color:#000>CONNECTION_MESSAGE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>DEAD_CONNECTION_MESSAGE</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//关闭当前失效连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hardTimeout</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//重置超时时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//借用的连接若未过期未丢弃进入此逻辑，则设置metrics监控指标
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>metricsTracker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recordBorrowTimeoutStats</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>//最核心部分，通过代理创建连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createProxyConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leakTaskFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//只要超时时间大于0则不断重试
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>createTimeoutException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//抛出创建连接超时异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上述代码中，有效性检查的部分是 isConnectionAlive，在这里用户可以自行配置心跳语句的检测，如果追求极致性能，那么使用 JDBC4 的用户还是强烈建议不要配置心跳语句，而是采用 HikariCP 默认的 com.mysql.jdbc. JDBC4Connection 的 isValid 实现，因为它的实现是 ping 命令，一般来说原生 ping 命令的性能是 select 1 的两倍。刚才我们看到的 HikariPool 的 getConnection 方法，其心跳语句检测的 isConnectionAlive 是在其父类中实现的，核心代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isConnectionAlive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>setNetworkTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>validationSeconds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationTimeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isUseJdbc4Validation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//如果是JDBC4，则直接使用ping命令进行验证
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isValid</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>validationSeconds</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//性能可以大大提升
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStatement</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isNetworkTimeoutSupported</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TRUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>setQueryTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>validationSeconds</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnectionTestQuery</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//否则执行测试语句验证
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>setNetworkTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>networkTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isIsolateInternalQueries</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lastConnectionFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Failed to validate connection {} ({}). Possiblyconsider using a shorter maxLifetime value.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>poolName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码中有一个 validationTimeout 属性，默认值是 5000 毫秒，所以默认情况下 <code>final int validationSeconds = (int)Math.max(1000L, validationTimeout) / 1000</code> 它的值应该为 1～5 秒。又由于 validationTimeout 的值必须小于 connectionTimeout(默认值30000毫秒，如果小于250毫秒，则被重置回30秒)，所以默认情况下，调整 validationTimeout 却不调整 connectionTimeou t情况下，validationSeconds 的默认峰值应该是 30 毫秒。</p>
<p>如果是 JDBC4 的话，使用 isUseJdbc4Validation(就是 <code>config.getConnectionTestQuery()== null</code> 的时候)，用 <code>connection.isValid(validationSeconds)</code> 来验证连接的有效性，否则的话则用 connectionTestQuery 查询语句来查询验证。</p>
<h3 id=细节创建形式>细节：创建形式</h3>
<p>第 3 个细节就是连接的创建。连接的创建可以同步创建，也可以异步创建，这与 HikariCP 的配置息息相关，这也是 HikariCP 作者别具匠心的设计之处。</p>
<h3 id=过程总结>过程总结</h3>
<ol>
<li>实现了 JDBC 扩展包 javax.sql 的 DataSource 接口的 HikariDataSource，执行 getConnection 方法时会进行 Double-checked_locking 单例、配置检查等流程，再向 HikariPool 资源池请求获取连接。</li>
<li>HikariPool 则向其 lock-free 的资源集合 ConcurrentBag 借用 PoolEntry，若没有 poolEntry 则超时抛出异常，若有 poolEntry 则创建一个 JDBC 代理连接 ProxyConnection。</li>
<li>ProxyConnection 是由 ProxyFactory 产生的，它是一个生产标准 JDBC 接口代理的工厂类，HikariDataSource 最终获取的 Connection 连接就是代理工厂返回的 JDBC 物理连接，而 poolEntry 就是对这个物理连接的一对一封装。</li>
</ol>
<h3 id=连接有效性>连接有效性</h3>
<p>Java.sql.Connection 的 isValid() 和 isClosed() 区别：</p>
<ul>
<li>isValid：如果连接尚未关闭并且仍然有效，则返回true。驱动程序将提交一个关于该连接的查询，或者使用其他某种能确切验证在调用此方法时连接是否仍然有效的机制。由驱动程序提交的用来验证该连接的查询将在当前事务的上下文中执行。
<ul>
<li>参数：timeout。等待用来验证连接是否完成的数据库操作的时间，以秒为单位。如果在操作完成之前超时期满，则此方法返回 false。0值表示不对数据库操作应用超时值。</li>
<li>返回：如果连接有效，则返回 true，否则返回 false。</li>
</ul>
</li>
<li>isClosed：查询此 Connection 对象是否已经被关闭。如果在连接上调用了 close 方法或者发生某些严重的错误，则连接被关闭。只有在调用了 Connection.close 方法之后被调用时，此方法才保证返回 true。通常不能调用此方法确定到数据库的连接是有效的还是无效的。通过捕获在试图进行某一操作时可能抛出的异常，典型的客户端可以确定某一连接是无效的。
<ul>
<li>返回：如果此 Connection 对象是关闭的，则返回 true；如果它仍然处于打开状态，则返回 false。</li>
</ul>
</li>
</ul>
<h3 id=连接监控>连接监控</h3>
<p>HikariPool 继承了 PoolBase，实现了 HikariPoolMXBean 接口用于对外暴露 HikariCP 连接池相关的监控管理功能：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719231458.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=归还连接>归还连接</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210719231944.png style=display:block;width:70% alt=NAME align=center> </div>
<p>连接的归还和连接的借用是两个大致相反的过程，归还部分的源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//由于关闭语句可能导致连接被驱逐，所以优先执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCommitStateDirty</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>isAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//如果存在脏提交或者没有自动提交，则连接回滚
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>lastAccess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Executed rollback on connection {} due to dirty commit state on close().&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dirtyBits</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resetConnectionState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dirtyBits</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>lastAccess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearWarnings</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//当连接中止时，通常会抛出不适用于应用程序的异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMarkedEvicted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>checkException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//这里开始调用PoolEntry的recycle方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>recycle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastAccess</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 ProxyConnection 代理层获取到的连接，进行归还时调用了代理层的 close 方法。HikariCP 归还连接是一系列没有返回值的 void 操作，ProxyConnection 的 close 方法并没有直接调用 JDBC 的 close 方法，而是依次调用了 PoolEnry 的 recycle 方法、HikariPool 的 recycle 方法及 ConcurrentBag 的 requite 方法，这一系列方法传递的参数都是 PoolEntry。</p>
<p>数据库连接池 HikariCP 的 close 方法返回的连接其实是封装在这个 ProxyConnection 代理连接中的，当调用它的时候，它只返回与池的连接，但是依然保持与数据库的基础连接是打开的。数据库连接池通常都是以这种方式工作的，数据库连接池的性能优势就是来自于连接保持打开，通过代理连接，对用户来说是透明的。如果需要关闭这个连接，可以将它先转换为 ProxyConnection，然后调用它的 unwrap 方法，最后关闭这个内部连接。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//ProxyConnection内部提供的unwrap方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
		
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Wrapped connection is not an instance of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>iface</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>unwrap 是一个很有意思的工具，如果你想跳过代理获取数据库的源信息，那么还可以直接使用 JDBC 的 unwrap 的 API 来获取(这里不是 ProxyConnection 的 unwrap )。如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConnectionProperties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConnectionProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span>
	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNullCatalogMeansCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>在归还连接的代码中，也存在很多细节。比如代理层的 close 方法第 1 行就这么讲究：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//由于关闭语句可能导致连接被驱逐，所以优先执行
</span></code></pre></div><p>本书前面章节介绍的 HikariCP 诞生的理由——很多数据库连接池违反了 JDBC 规范。当 Connection 连接 close 或者 return 时，清除警告或回滚未提交的事务时，一些数据库连接池并不会自动关闭语句 Statement，并且它们也不会重置用户更改过的属性，如自动提交或事务隔离级别等，从而导致下一个消费者获得“脏”连接。</p>
<p>JDBC 最佳实践中有一条就是最顺序关闭 ResultSet、Statement、Connection。因此，在 HikariCP 中，ProxyConnection 的源码中，它的 close 方法覆盖了 java.sql.Connection 的方法，覆盖 JDBC 的 close 方法时，第一件事就是关闭了 Statement 语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeStatements</span><span style=color:#ce5c00;font-weight:700>(){</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>ignored</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//自动资源清理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Connection {} marked as broken because of an exception closing open statements during Connection.close()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>leakTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;(exception closing Statements during Connection.close())&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClosedConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CLOSED_CONNECTION</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>openStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上述 closeStatements 的具体方法实现里，在执行 clear 之前，将所有不是关闭状态的 Statement 都遍历了一遍，进行了资源的自动清理，对于遇到异常的连接，PoolEntry 对象标记具体问题原因是关闭 Statement 时产生的，并将连接设置为关闭状态。</p>
<p>从 ProxyConnection 覆盖 JDBC 的 close 方法，一步步调用到了 ConcurrentBag 的 requite 方法放回，就像后者方法前的注释说的那样：“有借必有还。如果你只借不还，那么就会导致内存泄漏。”</p>
<p>结合连接时序图和归还连接时序图我们可以发现，PoolEntry 对象通过 borrow 方法从 ConcurrentBag 中取出，再通过 requite 方法被放回，有借有还。当线程调用 getConnection 的时候，会调用 ConcurrentBag 的 borrow 方法，它将首先尝试从该线程的 ThreadLocal 最近使用的连接列表中获取未使用的连接。</p>
<p>当关闭连接时，又会通过 remove 方法删除 PoolEntry。ConcurrentBag 就是 HikariCP 的数据库连接存储结构，它在 HikariCP 中起着举足轻重的作用，其性能直接决定 HikariCP 的整体性能。</p>
<h2 id=关闭连接>关闭连接</h2>
<p>在可以热部署的 Web 应用程序中，关闭 DataSource 非常重要。通常可以调用 HikariDataSource 实例的 shutdown 或者 close 方法，也可以配置 Spring 或其他 IOC 容器来指定 destroy 方法。<strong>一旦 Connection 进入关闭连接阶段，它立即从池中被移除，但是仍然和数据库 DB 有活动连接，直到 Connection.close 完成。HikariCP 永远不会杀死正在使用的连接，除非池本身被关闭。</strong></p>
<p>关闭分为 HikariDataSouce 和 HikariPool 两种关闭，这两者截然不同。</p>
<p>HikariDatasource 作为 HikariCP 对外对使用方提供的 DataSource，它的 close 方法是粗暴的 shutdown 操作。其 close 方法就是直接关闭数据源及其连接池，源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>(){</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isShutdown</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>HikariPool</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Shutdown initiated...&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Shutdown completed.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Interrupted during closing&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getPoolName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariDataSouce 的 close 直接调用了 HikariPool 的 shutdown 操作，其具体实现在 HikariPool 的 shutdown 方法里，不但关闭连接池，还关闭了所有空闲连接，中止或关闭活动连接。此外，它还会进行直接取消定时任务、关闭 ConcurrentBag 等一系列清理工作，可以认为就是一个 shutdown 的强硬操作。HikariPool 的 shutdown 源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>POOL_SHUTDOWN</span><span style=color:#ce5c00;font-weight:700>;</span>
  
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//如果连接池从未启动
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  
      <span style=color:#000>logPoolState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Before shutdown &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>houseKeeperTask</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//关闭houseKeeper的任务
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>houseKeeperTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>houseKeeperTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  
      <span style=color:#000>softEvictConnections</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//软驱逐连接
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//关闭增加连接线程池
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getLoginTimeout</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>destroyHouseKeepingExecutorService</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//关闭connectionBag
</span><span style=color:#8f5902;font-style:italic></span>  
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>assassinExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(),</span> 
          <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; connection assassinator&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getThreadFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> 
          <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CallerRunsPolicy</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>abortActiveConnections</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>softEvictConnections</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>assassinExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>shutdownNetworkTimeoutExecutor</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logPoolState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;After shutdown &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>handleMBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>metricsTracker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>与 HikariDataSource 对外提供的 close 接口不同，HikariPool 提供的内部 closeConnection 方法才是我们通常意义上理解的数据库连接池内部的连接关闭逻辑。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210902213134.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当 HikariPool 执行 closeConnection 方法时，首先先从 ConcurrentBag 中移除 PoolEntry，然后 PoolEntry 自身 close，接着独立线程池 closeConnectionExecutor(本质是ThreadPoolExecutor) 调用 JDBC 的方法进行物理连接的关闭。如果 poolState 的状态为 0，还会使用另一个独立线程池 addConnectionExecutor(与 closeConnectionExecutor 对称，本质上也是 ThreadPoolExecutor)进行新连接的生成，fillPool 补足到 HikariCP 的配置值。其核心源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>closureReason</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//ConcurrentBag移除poolEntry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//poolEntry关闭
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>quietlyCloseConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>closureReason</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//jdbc关闭连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>POOL_NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>fillPool</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//填充连接池
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到 HikariCP 使用了线程池 closeConnectionExecutor 进行了物理连接的关闭。其实在 HikariCP 的源码里，closeConnectionExecutor 还有一个孪生兄弟 addConnectionExecutor，在 com.zaxxer.hikari.pool.HikariPool 的源码中构造函数初始化的时候就可以看到 <code>public HikariPool(final HikariConfigconfig)</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadPoolExecutor</span> <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadPoolExecutor</span> <span style=color:#000>closeConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//......
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>addQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addConnectionQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unmodifiableCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>addQueue</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;connection adder&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DiscardPolicy</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeConnectionExecutor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(),</span> 
  <span style=color:#000>poolName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; connection closer&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
  <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CallerRunsPolicy</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>addConnectionExecutor 和 closeConnectionExecuto r的初始化就是命中了Java 5 种线程池、4 种拒绝策略、3 种阻塞队列的知识点。addConnectionExecutor 用于创建物理连接，它使用了 DiscardPolicy 策略，默认情况下它就是丢弃被拒绝的任务，实际上就是任务满了就不会抛出异常；而 closeConnectionExecutor 用了 CallerRunsPolicy 策略，如果添加到线程池失败，主线程会直接在 execute 方法的调用线程中运行被拒绝的任务，若执行程序已关闭，则会丢弃该任务。</p>
<p>使用 HikariCP 的用户可能经常会看到类似 connection isevicted or dead 这样的异常，其实这是合理的，关闭死连接对于连接池的资源清理至关重要。</p>
<p>HikariCP 关闭连接的 5 种情况：</p>
<ul>
<li>连接验证失败。这对应用程序是不可见的。连接已停用并已替换。用户会看到一条日志消息：“Failed tovalidate connection&mldr;”。</li>
<li>连接达到了其 maxLifetime。这对应用程序是不可见的。连接已停用并已替换。用户会看到一个关闭原因：“connection has passed maxLifetime”，或者如果在到达时 maxLifetime 正在使用该连接，用户会晚一点看到原因：“connection is evicted or dead”。</li>
<li>用户手动驱逐连接。这对应用程序是不可见的。连接已停用并已替换。用户会看到关闭的原因：“connectionevicted by user”。</li>
<li>JDBC 调用引发了无法恢复的问题 SQLException。这应该对应用程序可见。用户会看到关闭的原因：“connection is broken”。</li>
</ul>
<h2 id=生成连接>生成连接</h2>
<p>独立的线程池 addConnectionExecutor 用于创建物理连接，它是在 HikariPool 的构造函数中被初始化的。HikariPool 中的 addConnectionExecutor 在 addBagItem() 和 fillPool() 的时候进行新的物理连接的创建。addBagItem 代表向我们之前介绍的 HikariCP 的数据结构 ConcurrentBag 中放置 Bag 项，它的源码实现其实是在 ConcurrentBag 的 borrrow 也就是连接的借用时执行的。核心代码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>bagEntry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sharedList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STATE_NOT_IN_USE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATE_IN_USE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//如果我们已经窃取了另一个等待着的连接，那么请求会新增另一个bag
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bagEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>waiting</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>在上述代码中，有两处分别执行了 <code>listener.addBagItem(waiting-1)</code> 和 <code>listener.addBagItem(waiting)</code>，当有并发连接产生时，如果存在等待的连接或者连接已经不可用，则会进行物理连接的创建。</p>
<p>另一个 addConnectionExecutor 在 addBagItem() 来源于 HikariPool 的 fillPool 的方法，它是来源于 HikariPool 内部的单独线程 HouseKeeper，用来将当前的数据库连接池从当前的空闲连接填充到最小空闲连接的指标。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fillPool</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>connectionsToAdd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinimumIdle</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>getIdleConnections</span><span style=color:#ce5c00;font-weight:700>())</span>
                              <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>addConnectionQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>connectionsToAdd</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>connectionsToAdd</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
<span style=color:#000>poolEntryCreator</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>postFillPoolEntryCreator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>PoolEntry 是一个封装了物理连接的对象，在 HikariPool 中定义了两个 PoolEntry，分别代表我们刚才介绍的连接生成的两种场景(addBagItem 和 fillPool)：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span>  <span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>PoolEntryCreator</span>  <span style=color:#000>poolEntryCreator</span>  <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#204a87;font-weight:700>new</span>  <span style=color:#000>PoolEntryCreator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#a40000>＊</span><span style=color:#000>logging</span> <span style=color:#000>prefix</span><span style=color:#a40000>＊</span><span style=color:#ce5c00;font-weight:700>/);</span>
<span style=color:#204a87;font-weight:700>private</span>  <span style=color:#204a87;font-weight:700>final</span>  <span style=color:#000>PoolEntryCreator</span>  <span style=color:#000>postFillPoolEntryCreator</span>  <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#204a87;font-weight:700>new</span>  <span style=color:#000>PoolEntryCreator</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;After adding &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>addConnectionExecutor 线程调用 HikariPool 的 createPoolEntry 方法进行连接生成，HikariPool 继承的父类 PoolBase 提供的 newPoolEntry 会先进行物理连接的创建，创建完成以后的连接会被封装为 PoolEntry 后放入ConcurrentBag。createPoolEntry 的源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>createPoolEntry</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PoolEntry</span> <span style=color:#000>poolEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPoolEntry</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMaxLifetime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 设置maxlifetime的2.5%的差额
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>variance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>nextLong</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>40</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//随机数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>lifetime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>variance</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFutureEol</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>houseKeepingExecutorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//设置异步任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>softEvictConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;(connection has passed
</span><span style=color:#4e9a06>maxLifetime)&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#a40000>＊</span> <span style=color:#000>not</span> <span style=color:#000>owner</span> <span style=color:#a40000>＊</span><span style=color:#ce5c00;font-weight:700>/))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                          <span style=color:#000>addBagItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connectionBag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWaitingThreadCount</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>},</span>
                <span style=color:#000>lifetime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>poolEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConnectionSetupException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>POOL_NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//如果shutdown()同时运行，我们检查POOL_NORMAL以避免消息泛滥
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{} - Error thrown while acquiring connection from data
</span><span style=color:#4e9a06>source&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>poolName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCause</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>lastConnectionFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//设置上一次连接失败的异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>HikariCP 的 maxLifetime 默认是 1800000毫秒(30分钟)。在上述代码中，有一段重要的随机数逻辑，这段代码主要就是根据 maxLifetime 的 2.5% 来设置一个差额，如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 设置maxlifetime的2.5%的差额
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>variance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10_000</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>().</span>
<span style=color:#000>nextLong</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>maxLifetime</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>40</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//随机数
</span></code></pre></div><p>连接生成的时候让每个连接的最大存活时间错开一点，防止同时过期，加一点点随机因素，防止一件事情大量同时发生，比如防止 HikariCP 的连接同时大量死亡。如果 maxLifetime 大于 10000 就是大于 10 秒钟，就执行这个策略，用 maxLifetime 的 2.5% 的时间和 0 之间的随机数来随机设定一个 variance，在 maxLifetime - variance 之后触发 evict。比如，配置 maxLifetime 为 15 分钟时，HikariCP 为每个连接最大寿命注入了 2.5% 的变化，寿命为 15 分钟时，相当于 22.5 秒的变化。一些连接可能在 14 分 38 秒退休，其他连接可能在 14 分 53 秒退休等。</p>
<p>在创建 poolEntry 的时候，注册了一个延时任务，在连接存活将要到达 maxLifetime 之前触发 evit(标记连接池中的连接不可用)，用来防止出现大面积连接因为 maxLifetim e是一样的而同时失效，从而造成 HikariCP 数据库连接池不稳定的情况。</p>
<p>在 HikariCP 的 3.3.1 版本中，修复了一个 issue 1287 “setcore pool size before max pool size”，这正是与我们介绍的连接生成 addConnectionExecutor 有关系的。提交这个 issue 的用户反馈：他在执行大量并发耗时查询（查询10～30秒）的时候，启动时的有尖峰请求，在尖峰需求完毕以前池中无空闲连接的情况下反应非常慢，获得新的连接是一个严重阻塞的过程。</p>
<p>根据这个用户的问题，HikariCP 3.3.1 版本在 HikariPool 的初始化过程中统一将 addConnectionExecutor.setMaximumPoolSize 挪到了 addConnectionExecutor.setCorePoolSize 的后面。其源码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.zaxxer.hikari.blockUntilFilled&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
<span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitializationFailTimeout</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>setCorePoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>  <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>setMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>currentTime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elapsedMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitializationFailTimeout</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>getTotalConnections</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMinimumIdle</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>quietlySleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCorePoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>addConnectionExecutor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMaximumPoolSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>com.zaxxer.hikari.blockUntilFilled 是 HikariCP 新版本的一个新功能，它是 HikariCP 官方文档没有提供的系统属性，它的作用是阻塞应用程序直到数据库连接池达到 minimumIdle 值的大小。这个行为在 HikariCP 旧版本期间是单线程的，所以就有可能出现初始化时大量并发连接的长慢查询容易导致 HikariCP 的 getConnection 方法产生阻塞；在 3.3.0 版本中可以进行调整，如果 com.zaxxer.hikari.blockUntilFilled 的属性为 true，并且 initializationFailTimeout 大于 1，则池将由多个线程填充。这线程数由 Runtime.getRuntime().availableProcessors() 确定。初始化后，线程数会在池的生命周期内下降回 1。</p>
<p>那么为什么又要将 setMaximumPoolSize 挪到 setCorePoolSize 后面呢？因为这里有一个 Bug，根据 ThreadPoolExecutor 文档，需要在设置最大池大小之前设置核心池大小，因为在将最大池大小设置为低于核心池大小的值时会抛出 IllegalArgumentException。而这个修复是在 HikariCP 3.3.1 版本中调整的。</p>
<p>setMaximumPoolSize 文档：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public void setMaximumPoolSize(int maximumPoolSize)
    Sets the maximum allowed number of threads. This overrides any value set in
the constructor. If the new value is smaller than the current value, excess existing
threads will be terminated when they next become idle.
Parameters：
    maximumPoolSize - the new maximum
Throws：
    IllegalArgumentException - if the new maximum is less than or equal to zero,
or less than the core pool size
See Also：
    getMaximumPoolSize()
</code></pre></div>
<style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style>
<div class=d-print-none>
<h2 class=feedback--title>Feedback</h2>
<p class=feedback--question>Was this page helpful?</p>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
Glad to hear it! Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
Sorry to hear that. Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
</div>
<script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script>
<br>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>