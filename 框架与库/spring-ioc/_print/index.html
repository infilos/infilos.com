<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.90.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Spring IOC | infilos.com</title><meta property="og:title" content="Spring IOC">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Spring IOC">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Spring IOC">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Spring IOC</h1>
<ul>
<li>1: <a href=#pg-058d34bd471ff0fb89f33ccbc6c6f744>CH01-获取单例 Bean</a></li>
<li>2: <a href=#pg-f162112b468f360d336fef678e9e61c1>CH02-创建单例 Bean</a></li>
<li>3: <a href=#pg-134a7abbdac972a86f3f7920807642b0>CH03-创建原始 Bean 对象</a></li>
<li>4: <a href=#pg-f226756c00275a43d5e85dc95b38990e>CH04-解决循环依赖</a></li>
<li>5: <a href=#pg-d9a521069fb4cad9079c5b918a21c5a1>CH05-原始 Bean 属性填充</a></li>
<li>6: <a href=#pg-af78074eb9a0b37dec4c27ffbf65a82b>CH06-后续初始化工作</a></li>
<li>7: <a href=#pg-df482e7d67cbcb67a71beecf0e6e8c46>CH07-生命周期扩展</a></li>
<li>8: <a href=#pg-b51917ad9041bab714580f7b22d13d9b>CH08-控制加载顺序</a></li>
</ul>
<div class=content>
<h2 id=spring-模块结构>Spring 模块结构</h2>
<p>Spring 是分模块开发的，Spring 包含了很多模块，其中最为核心的是 bean 容器相关模块。像 AOP、MVC、Data 等模块都要依赖 bean 容器。这里先看一下 Spring 框架的结构图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010163540.png style=display:block;width:80% alt=NAME align=center> </div>
<p>从上图中可以看出Core Container处于整个框架的最底层（忽略 Test 模块），在其之上有 AOP、Data、Web 等模块。既然 Spring 容器是最核心的部分，那么大家如果要读 Spring 的源码，容器部分必须先弄懂。</p>
<h2 id=spring-ioc-特性介绍>Spring IOC 特性介绍</h2>
<h3 id=alias>alias</h3>
<p>alias 的中文意思是“别名”，在 Spring 中，我们可以使用 alias 标签给 bean 起个别名。比如下面的配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.Hello&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;content&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;alias-hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;alias-hello&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;double-alias-hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>这里我们给<code>hello</code>这个 beanName 起了一个别名<code>alias-hello</code>，然后又给别名<code>alias-hello</code>起了一个别名<code>double-alias-hello</code>。我们可以通过这两个别名获取到<code>hello</code>这个 bean 实例，比如下面的测试代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testAlias</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-alias.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;    alias-hello -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;alias-hello&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;double-alias-hello -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;double-alias-hello&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=autowire>autowire</h3>
<p>autowire 即自动注入的意思，通过使用 autowire 特性，我们就不用再显式的配置 bean 之间的依赖了。把依赖的发现和注入都交给 Spring 去处理，省时又省力。autowire 几个可选项，比如 byName、byType 和 constructor 等。autowire 是一个常用特性，相信大家都比较熟悉了，所以本节我们就 byName 为例，快速结束 autowire 特性的介绍。</p>
<p>当 bean 配置中的 autowire = byName 时，Spring 会首先通过反射获取该 bean 所依赖 bean 的名字（beanName），然后再通过调用 BeanFactory.getName(beanName) 方法即可获取对应的依赖实例。autowire = byName 原理大致就是这样，接下来我们来演示一下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Service</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Dao</span> <span style=color:#000>mysqlDao</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Dao</span> <span style=color:#000>mongoDao</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 忽略 getter/setter
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;\n\t\t\t\t\t{&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
            <span style=color:#4e9a06>&#34;mysqlDao=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mysqlDao</span> <span style=color:#ce5c00;font-weight:700>+</span>
            <span style=color:#4e9a06>&#34;, mongoDao=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mongoDao</span> <span style=color:#ce5c00;font-weight:700>+</span>
            <span style=color:#4e9a06>&#39;}&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Dao</span> <span style=color:#ce5c00;font-weight:700>{}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MySqlDao</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Dao</span> <span style=color:#ce5c00;font-weight:700>{}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MongoDao</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Dao</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mongoDao&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.MongoDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mysqlDao&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.MySqlDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

<span style=color:#8f5902;font-style:italic>&lt;!-- 非自动注入，手动配置依赖 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;service-without-autowire&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.Service&#34;</span> <span style=color:#c4a000>autowire=</span><span style=color:#4e9a06>&#34;no&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mysqlDao&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;mysqlDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mongoDao&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;mongoDao&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#8f5902;font-style:italic>&lt;!-- 通过设置 autowire 属性，我们就不需要像上面那样显式配置依赖了 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;service-with-autowire&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.autowire.Service&#34;</span> <span style=color:#c4a000>autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-autowire.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-without-autowire -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-without-autowire&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-with-autowire -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;service-with-autowire&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</code></pre></div><p>两种方式配置方式都能完成解决 bean 之间的依赖问题。只不过使用 autowire 会更加省力一些，配置文件也不会冗长。这里举的例子比较简单，假使一个 bean 依赖了十几二十个 bean，再手动去配置，恐怕就很难受了。</p>
<h3 id=factorybean>FactoryBean</h3>
<p>FactoryBean？看起来是不是很像 BeanFactory 孪生兄弟。不错，他们看起来很像，但是他们是不一样的。FactoryBean 是一种工厂 bean，与普通的 bean 不一样，FactoryBean 是一种可以产生 bean 的 bean，好吧说起来很绕嘴。FactoryBean 是一个接口，我们可以实现这个接口。下面演示一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloFactoryBean</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Hello</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getObjectType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;helloFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.HelloFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testFactoryBean</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-factory-bean.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;helloFactory -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;helloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&amp;helloFactory -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&amp;helloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当我们调用 getBean(&ldquo;helloFactory&rdquo;) 时，ApplicationContext 会返回一个 Hello 对象，该对象是 HelloFactoryBean 的 getObject 方法所创建的。如果我们想获取 HelloFactoryBean 本身，则可以在 helloFactory 前加上一个前缀<code>&</code>，即<code>&helloFactory</code>。</p>
<h3 id=factory-method>factory-method</h3>
<p>介绍完 FactoryBean，本节再来看看了一个和工厂相关的特性 &ndash; factory-method。factory-method 可用于标识静态工厂的工厂方法（工厂方法是静态的），直接举例说明吧：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StaticHelloFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Hello</span> <span style=color:#000>getHello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;created by StaticHelloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;staticHelloFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.StaticHelloFactory&#34;</span> <span style=color:#c4a000>factory-method=</span><span style=color:#4e9a06>&#34;getHello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testFactoryMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-factory-method.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;staticHelloFactory -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;staticHelloFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于非静态工厂，需要使用 factory-bean 和 factory-method 两个属性配合。关于 factory-bean 这里就不继续说了，留给大家自己去探索吧。</p>
<h3 id=lookup-method>lookup-method</h3>
<p>我们通过 BeanFactory getBean 方法获取 bean 实例时，对于 singleton 类型的 bean，BeanFactory 每次返回的都是同一个 bean。对于 prototype 类型的 bean，BeanFactory 则会返回一个新的 bean。</p>
<p>现在考虑这样一种情况，一个 singleton 类型的 bean 中有一个 prototype 类型的成员变量。BeanFactory 在实例化 singleton 类型的 bean 时，会向其注入一个 prototype 类型的实例。但是 singleton 类型的 bean 只会实例化一次，那么它内部的 prototype 类型的成员变量也就不会再被改变。</p>
<p>但如果我们每次从 singleton bean 中获取这个 prototype 成员变量时，都想获取一个新的对象。这个时候怎么办？</p>
<p>举个例子，我们有一个新闻提供类（NewsProvider），这个类中有一个新闻类（News）成员变量。我们每次调用 getNews 方法都想获取一条新的新闻。这里我们有两种方式实现这个需求，一种方式是让 NewsProvider 类实现 ApplicationContextAware 接口（实现 BeanFactoryAware 接口也是可以的），每次调用 NewsProvider 的 getNews 方法时，都从 ApplicationContext 中获取一个新的 News 实例，返回给调用者。第二种方式就是这里的 lookup-method 了，Spring 会在运行时对 NewsProvider 进行增强，使其 getNews 可以每次都返回一个新的实例。说完了背景和解决方案，接下来就来写点测试代码验证一下。</p>
<p>在演示两种处理方式前，我们先来看看不使用任何处理方式，BeanFactory 所返回的 bean 实例情况。相关类定义如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>News</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 仅演示使用，News 类中无成员变量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NewsProvider</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>News</span> <span style=color:#000>getNews</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNews</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>news</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置信息如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;news&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.News&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.NewsProvider&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;news&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;news&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-lookup-method.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>NewsProvider</span> <span style=color:#000>newsProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NewsProvider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><p>从测试结果中可以看出，newsProvider.getNews() 方法两次返回的结果都是一样的，这个是不满足要求的。</p>
<h4 id=实现-applicationcontextaware-接口>实现 ApplicationContextAware 接口</h4>
<p>我们让 NewsProvider 实现 ApplicationContextAware 接口，实现代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NewsProvider</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationContextAware</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/** 每次都从 applicationContext 中获取一个新的 bean */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>News</span> <span style=color:#000>getNews</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;news&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>News</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNews</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>News</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>news</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>news</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=使用-lookup-method-特性>使用 lookup-method 特性</h4>
<p>使用 lookup-method 特性，配置文件需要改一下。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;news&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.News&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.lookupmethod.NewsProvider&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;lookup-method</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;getNews&#34;</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;news&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>NewsProvider 的代码沿用 4.5.1 小节之前贴的代码。测试代码稍微变一下，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-lookup-method.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>NewsProvider</span> <span style=color:#000>newsProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NewsProvider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;newsProvider&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;newsProvider -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;news 1 -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;news 2 -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newsProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNews</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><h3 id=depends-on>depends-on</h3>
<p>当一个 bean 直接依赖另一个 bean，可以使用 <code>&lt;ref/></code> 标签进行配置。不过如某个 bean 并不直接依赖于 其他 bean，但又需要其他 bean 先实例化好，这个时候就需要使用 depends-on 特性了。depends-on 特性比较简单，就不演示了。仅贴一下配置文件的内容，如下：</p>
<p>这里有两个简单的类，其中 Hello 需要 World 在其之前完成实例化。相关配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.depnedson.Hello&#34;</span> <span style=color:#c4a000>depends-on=</span><span style=color:#4e9a06>&#34;world&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;world&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.depnedson.World&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h3 id=beanpostprocessor>BeanPostProcessor</h3>
<p>BeanPostProcessor 是 bean 实例化时的后置处理器，包含两个方法，其源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// bean 初始化前的回调方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// bean 初始化后的回调方法    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BeanPostProcessor 是 Spring 框架的一个扩展点，通过实现 BeanPostProcessor 接口，我们就可插手 bean 实例化的过程。比如大家熟悉的 AOP 就是在 bean 实例后期间将切面逻辑织入 bean 实例中的，AOP 也正是通过 BeanPostProcessor 和 IOC 容器建立起了联系。这里我来演示一下 BeanPostProcessor 的使用方式，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 日志后置处理器，将会在 bean 创建前、后打印日志
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LoggerBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanPostProcessor</span> <span style=color:#000;font-weight:700>{</span>

    <span style=color:#a40000>@</span><span style=color:#000>Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>Object</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>String</span> <span style=color:#000>beanName</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Before &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; Initialization&#34;</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#a40000>@</span><span style=color:#000>Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>Object</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>String</span> <span style=color:#000>beanName</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;After &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; Initialization&#34;</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;xyz.coolblog.beanpostprocessor.LoggerBeanPostProcessor&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
    
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#204a87;font-weight:700>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.Hello&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;world&#34;</span> <span style=color:#204a87;font-weight:700>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;xyz.coolblog.service.World&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
</code></pre></div><p>测试代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationContextTest</span> <span style=color:#000;font-weight:700>{</span>

    <span style=color:#a40000>@</span><span style=color:#000>Test</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testBeanPostProcessor</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-bean-post-processor.xml&#34;</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>与 BeanPostProcessor 类似的还有一个叫 BeanFactoryPostProcessor 拓展点，顾名思义，用户可以通过这个拓展点插手容器启动的过程。不过这个不属于本系列文章范畴，暂时先不细说了。</p>
<h3 id=beanfactoryaware>BeanFactoryAware</h3>
<p>Spring 中定义了一些列的 Aware 接口，比如这里的 BeanFactoryAware，以及 BeanNameAware 和 BeanClassLoaderAware 等等。通过实现这些 Aware 接口，我们可以在运行时获取一些配置信息或者其他一些信息。比如实现 BeanNameAware 接口，我们可以获取 bean 的配置名称（beanName）。通过实现 BeanFactoryAware 接口，我们可以在运行时获取 BeanFactory 实例。关于 Aware 类型接口的使用，可以参考<code>实现 ApplicationContextAware 接口</code>一节中的叙述，这里就不演示了。</p>
<h2 id=reference>Reference</h2>
<ul>
<li>原文链接：<a href=https://cloud.tencent.com/developer/article/1138679>https://cloud.tencent.com/developer/article/1138679</a></li>
<li>原文链接：<a href=https://segmentfault.com/a/1190000023033670>https://segmentfault.com/a/1190000023033670</a></li>
</ul>
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-058d34bd471ff0fb89f33ccbc6c6f744>1 - CH01-获取单例 Bean</h1>
<h2 id=getbean>getBean</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// getBean 是一个空壳方法，所有的逻辑都封装在 doGetBean 方法中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 通过 name 获取 beanName。这里不使用 name 直接作为 beanName 有两点原因：
</span><span style=color:#8f5902;font-style:italic>     * 1. name 可能会以 &amp; 字符开头，表明调用者想获取 FactoryBean 本身，而非 FactoryBean 
</span><span style=color:#8f5902;font-style:italic>     *    实现类所创建的 bean。在 BeanFactory 中，FactoryBean 的实现类和其他的 bean 存储
</span><span style=color:#8f5902;font-style:italic>     *    方式是一致的，即 &lt;beanName, bean&gt;，beanName 中是没有 &amp; 这个字符的。所以我们需要
</span><span style=color:#8f5902;font-style:italic>     *    将 name 的首字符 &amp; 移除，这样才能从缓存里取到 FactoryBean 实例。
</span><span style=color:#8f5902;font-style:italic>     * 2. 若 name 是一个别名，则应将别名转换为具体的实例名，也就是 beanName。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 从缓存中获取单例 bean。Spring 是使用 Map 作为 beanName 和 bean 实例的缓存的，所以这
</span><span style=color:#8f5902;font-style:italic>     * 里暂时可以把 getSingleton(beanName) 等价于 beanMap.get(beanName)。当然，实际的
</span><span style=color:#8f5902;font-style:italic>     * 逻辑并非如此简单，后面再细说。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。
</span><span style=color:#8f5902;font-style:italic>     * BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取 
</span><span style=color:#8f5902;font-style:italic>     * bean 时再实例化，也就是懒加载。
</span><span style=color:#8f5902;font-style:italic>     * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取
</span><span style=color:#8f5902;font-style:italic>     * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数
</span><span style=color:#8f5902;font-style:italic>     * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有
</span><span style=color:#8f5902;font-style:italic>     * 用了，BeanFactory 不会多次实例化单例 bean。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果 
</span><span style=color:#8f5902;font-style:italic>         * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的 
</span><span style=color:#8f5902;font-style:italic>         * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回
</span><span style=color:#8f5902;font-style:italic>         * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean 
</span><span style=color:#8f5902;font-style:italic>     * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例
</span><span style=color:#8f5902;font-style:italic>     * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 如果 sharedInstance = null，则到父容器中查找 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 name 对应的 beanName，如果 name 是以 &amp; 字符开头，则返回 &amp; + beanName
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 根据 args 是否为空，以决定调用父容器哪个方法获取 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> 
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并父 BeanDefinition 与子 BeanDefinition，后面会单独分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，
</span><span style=color:#8f5902;font-style:italic>                     * B 又依赖 A，他们的配置如下：
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanA&#34; class=&#34;BeanA&#34; depends-on=&#34;beanB&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanB&#34; class=&#34;BeanB&#34; depends-on=&#34;beanA&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   
</span><span style=color:#8f5902;font-style:italic>                     * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它
</span><span style=color:#8f5902;font-style:italic>                     * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接
</span><span style=color:#8f5902;font-style:italic>                     * 抛出异常
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; and &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 注册依赖记录
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 加载 depends-on 依赖
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> 
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过 
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法会在内部调用 
</span><span style=color:#8f5902;font-style:italic>                 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，
</span><span style=color:#8f5902;font-style:italic>                 * 将 bean 放入缓存中。关于 getSingleton 方法的分析，本文先不展开，我会在
</span><span style=color:#8f5902;font-style:italic>                 * 后面的文章中进行分析
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
                <span style=color:#8f5902;font-style:italic>// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 prototype 类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建其他类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@Override</span>
                        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Scope &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 如果需要进行类型转换，则在此处进行转换。类型转换这一块我没细看，就不多说了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQualifiedName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=执行流程>执行流程</h2>
<ol>
<li>转换 beanName</li>
<li>从缓存中获取实例</li>
<li>如果实例不为空，且 args=null，调用 getObjectForBeanInstance 方法，并按 name 规则返回相应 bean 实例</li>
<li>如果实例为空，则到父容器中查找 beanName 对应的 bean 实例，存在则直接返回</li>
<li>如果父容器中不存在，则进行下一步操作——合并 BeanDefinition</li>
<li>处理 depends-on 依赖</li>
<li>创建并缓存 bean</li>
<li>调用 getObjectForBeanInstance 方法，并按那么规则返回对应 bean 实例</li>
<li>按需转换 bean 类型，并返回转换后的 bean 实例</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011224524.png style=display:block;width:60% alt=NAME align=center> </div>
<h2 id=beanname-转换>beanName 转换</h2>
<p>在获取 bean 实例之前，Spring 第一件要做的事情是对参数 name 进行转换。转换的目的主要是为了解决两个问题，第一个是处理以字符 & 开头的 name，防止 BeanFactory 无法找到与 name 对应的 bean 实例。第二个是处理别名问题，Spring 不会存储 &lt;别名, bean 实例> 这种映射，仅会存储 &lt;beanName, bean>。所以，同样是为了避免 BeanFactory 找不到 name 对应的 bean 的实例，对于别名也要进行转换。接下来，我们来简单分析一下转换的过程，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>String</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 这里调用了两个方法：BeanFactoryUtils.transformedBeanName(name) 和 canonicalName
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/** 该方法用于处理 &amp; 字符 */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#39;name&#39; must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 循环处理 &amp; 字符。比如 name = &#34;&amp;&amp;&amp;&amp;&amp;helloService&#34;，最终会被转成 helloService
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FACTORY_BEAN_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FACTORY_BEAN_PREFIX</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/** 该方法用于转换别名 */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>canonicalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>resolvedName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 这里使用 while 循环进行处理，原因是：可能会存在多重别名的问题，即别名指向别名。比如下面
</span><span style=color:#8f5902;font-style:italic>     * 的配置：
</span><span style=color:#8f5902;font-style:italic>     *   &lt;bean id=&#34;hello&#34; class=&#34;service.Hello&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>     *   &lt;alias name=&#34;hello&#34; alias=&#34;aliasA&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>     *   &lt;alias name=&#34;aliasA&#34; alias=&#34;aliasB&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * 上面的别名指向关系为 aliasB -&gt; aliasA -&gt; hello，对于上面的别名配置，aliasMap 中数据
</span><span style=color:#8f5902;font-style:italic>     * 视图为：aliasMap = [&lt;aliasB, aliasA&gt;, &lt;aliasA, hello&gt;]。通过下面的循环解析别名
</span><span style=color:#8f5902;font-style:italic>     * aliasB 最终指向的 beanName
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>aliasMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>canonicalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedName</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>canonicalName</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=从缓存获取-bean-实例>从缓存获取 bean 实例</h2>
<p>对于单例 bean，Spring 容器只会实例化一次。后续再次获取时，只需直接从缓存里获取即可，无需且不能再次实例化（否则单例就没意义了）。从缓存中取 bean 实例的方法是<code>getSingleton(String)</code>，下面我们就来看看这个方法实现方式吧。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 这里解释一下 allowEarlyReference 参数，allowEarlyReference 表示是否允许其他 bean 引用
</span><span style=color:#8f5902;font-style:italic> * 正在创建中的 bean，用于处理循环引用的问题。关于循环引用，这里先简单介绍一下。先看下面的配置：
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> *   &lt;bean id=&#34;hello&#34; class=&#34;xyz.coolblog.service.Hello&#34;&gt;
</span><span style=color:#8f5902;font-style:italic> *       &lt;property name=&#34;world&#34; ref=&#34;world&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic> *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic> *   &lt;bean id=&#34;world&#34; class=&#34;xyz.coolblog.service.World&#34;&gt;
</span><span style=color:#8f5902;font-style:italic> *       &lt;property name=&#34;hello&#34; ref=&#34;hello&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic> *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic> * 
</span><span style=color:#8f5902;font-style:italic> * 如上所示，hello 依赖 world，world 又依赖于 hello，他们之间形成了循环依赖。Spring 在构建 
</span><span style=color:#8f5902;font-style:italic> * hello 这个 bean 时，会检测到它依赖于 world，于是先去实例化 world。实例化 world 时，发现 
</span><span style=color:#8f5902;font-style:italic> * world 依赖 hello。这个时候容器又要去初始化 hello。由于 hello 已经在初始化进程中了，为了让 
</span><span style=color:#8f5902;font-style:italic> * world 能完成初始化，这里先让 world 引用正在初始化中的 hello。world 初始化完成后，hello 
</span><span style=color:#8f5902;font-style:italic> * 就可引用到 world 实例，这样 hello 也就能完成初始了。关于循环依赖，我后面会专门写一篇文章讲
</span><span style=color:#8f5902;font-style:italic> * 解，这里先说这么多。
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从 singletonObjects 获取实例，singletonObjects 中缓存的实例都是完全实例化好的 bean，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 singletonObject = null，表明还没创建，或者还没完全创建好。
</span><span style=color:#8f5902;font-style:italic>     * 这里判断 beanName 对应的 bean 是否正在创建中
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从 earlySingletonObjects 中获取提前曝光的 bean，用于处理循环引用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 如果如果 singletonObject = null，且允许提前曝光 bean 实例，则从相应的 ObjectFactory 获取一个原始的（raw）bean（尚未填充属性）
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获取相应的工厂类
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 提前曝光 bean 实例，用于解决循环依赖
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 放入缓存中，如果还有其他 bean 依赖当前 bean，其他 bean 可以直接从 earlySingletonObjects 取结果
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码虽然不长，但是涉及到了好几个缓存集合。如果不知道这些缓存的用途是什么，上面源码可能就很难弄懂了。这几个缓存集合用的很频繁，在后面的代码中还会出现，所以这里介绍一下。如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>缓存</th>
<th style=text-align:left>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>singletonObjects</td>
<td style=text-align:left>用于存放完全初始化好的 bean，从该缓存中取出的 bean 可以直接使用</td>
</tr>
<tr>
<td style=text-align:left>earlySingletonObjects</td>
<td style=text-align:left>用于存放还在初始化中的 bean，用于解决循环依赖</td>
</tr>
<tr>
<td style=text-align:left>singletonFactories</td>
<td style=text-align:left>用于存放 bean 工厂。bean 工厂所产生的 bean 是还未完成初始化的 bean。如代码所示，bean 工厂所生成的对象最终会被缓存到 earlySingletonObjects 中</td>
</tr>
</tbody>
</table>
<h2 id=合并-beandefinition>合并 BeanDefinition</h2>
<p>Spring 支持配置继承，在 <bean> 标签中可以使用<code>parent</code>属性配置父类 bean。这样子类 bean 可以继承父类 bean 的配置信息，同时也可覆盖父类中的配置。比如下面的配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.innerbean.Hello&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;content&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;hello-child&#34;</span> <span style=color:#c4a000>parent=</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;content&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;I`m hello-child&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>如上所示，hello-child 配置继承自 hello。hello-child 未配置 class 属性，这里我们让它继承父配置中的 class 属性。然后我们写点代码测试一下，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;application-parent-bean.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocation</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello-child -&gt; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello-child&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</code></pre></div><p>hello-child 在未配置 class 的属性下也可以实例化成功，表明它成功继承了父配置的 class 属性。</p>
<p>看完代码演示，接下来我们来看看源码吧。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 检查缓存中是否存在“已合并的 BeanDefinition”，若有直接返回即可
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 调用重载方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 继续调用重载方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 我暂时还没去详细了解 containingBd 的用途，尽管从方法的注释上可以知道 containingBd 的大致用途，但没经过详细分析，就不多说了。见谅
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// bd.getParentName() == null，表明无父配置，这时直接将当前的 BeanDefinition 升级为 RootBeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>cloneBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>BeanDefinition</span> <span style=color:#000>pbd</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>parentBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentName</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 判断父类 beanName 与子类 beanName 名称是否相同。若相同，则父类 bean 一定
</span><span style=color:#8f5902;font-style:italic>                     * 在父容器中。原因也很简单，容器底层是用 Map 缓存 &lt;beanName, bean&gt; 键值对
</span><span style=color:#8f5902;font-style:italic>                     * 的。同一个容器下，使用同一个 beanName 映射两个 bean 实例显然是不合适的。
</span><span style=color:#8f5902;font-style:italic>                     * 有的朋友可能会觉得可以这样存储：&lt;beanName, [bean1, bean2]&gt; ，似乎解决了
</span><span style=color:#8f5902;font-style:italic>                     * 一对多的问题。但是也有问题，调用 getName(beanName) 时，到底返回哪个 bean 
</span><span style=color:#8f5902;font-style:italic>                     * 实例好呢？
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                         * 这里再次调用 getMergedBeanDefinition，只不过参数值变为了 
</span><span style=color:#8f5902;font-style:italic>                         * parentBeanName，用于合并父 BeanDefinition 和爷爷辈的 
</span><span style=color:#8f5902;font-style:italic>                         * BeanDefinition。如果爷爷辈的 BeanDefinition 仍有父 
</span><span style=color:#8f5902;font-style:italic>                         * BeanDefinition，则继续合并
</span><span style=color:#8f5902;font-style:italic>                         */</span>
                        <span style=color:#000>pbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 获取父容器，并判断，父容器的类型，若不是 ConfigurableBeanFactory 则判抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>pbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchBeanDefinitionException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#4e9a06>&#34;Parent name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>parentBeanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is equal to bean name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                                    <span style=color:#4e9a06>&#34;&#39;: cannot be resolved without an AbstractBeanFactory parent&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Could not resolve parent bean definition &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 以父 BeanDefinition 的配置信息为蓝本创建 RootBeanDefinition，也就是“已合并的 BeanDefinition”
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 用子 BeanDefinition 中的属性覆盖父 BeanDefinition 中的属性
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>overrideFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 如果用户未配置 scope 属性，则默认将该属性配置为 singleton
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_SINGLETON</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isCacheBeanMetadata</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 缓存合并后的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mergedBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=factorybean-获取-bean>FactoryBean 获取 bean</h2>
<p>在经过前面这么多的步骤处理后，到这里差不多就接近 doGetBean 方法的尾声了。在本节中，我们来看看从 FactoryBean 实现类中获取 bean 实例的过程。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 如果 name 以 &amp; 开头，但 beanInstance 却不是 FactoryBean，则认为有问题。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFactoryDereference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>beanInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanIsNotAFactoryException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的判断通过了，表明 beanInstance 可能是一个普通的 bean，也可能是一个 
</span><span style=color:#8f5902;font-style:italic>     * FactoryBean。如果是一个普通的 bean，这里直接返回 beanInstance 即可。如果是 
</span><span style=color:#8f5902;font-style:italic>     * FactoryBean，则要调用工厂方法生成一个 bean 实例。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>beanInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>BeanFactoryUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFactoryDereference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 mbd 为空，则从缓存中加载 bean。FactoryBean 生成的单例 bean 会被缓存
</span><span style=color:#8f5902;font-style:italic>         * 在 factoryBeanObjectCache 集合中，不用每次都创建
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCachedObjectForFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 经过前面的判断，到这里可以保证 beanInstance 是 FactoryBean 类型的，所以可以进行类型转换
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果 mbd 为空，则判断是否存在名字为 beanName 的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// synthetic 字面意思是&#34;合成的&#34;。通过全局查找，我发现在 AOP 相关的类中会将该属性设为 true。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 所以我觉得该字段可能表示某个 bean 是不是被 AOP 增强过，也就是 AOP 基于原始类合成了一个新的代理类。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 不过目前只是猜测，没有深究。如果有朋友知道这个字段的具体意义，还望不吝赐教
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>synthetic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#8f5902;font-style:italic>// 调用 getObjectFromFactoryBean 方法继续获取实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>synthetic</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldPostProcess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * FactoryBean 也有单例和非单例之分，针对不同类型的 FactoryBean，这里有两种处理方式：
</span><span style=color:#8f5902;font-style:italic>     *   1. 单例 FactoryBean 生成的 bean 实例也认为是单例类型。需放入缓存中，供后续重复使用
</span><span style=color:#8f5902;font-style:italic>     *   2. 非单例 FactoryBean 生成的 bean 实例则不会被放入缓存中，每次都会创建新的实例
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getSingletonMutex</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从缓存中取 bean 实例，避免多次创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanObjectCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 使用工厂对象中创建实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>Object</span> <span style=color:#000>alreadyThere</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanObjectCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alreadyThere</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>alreadyThere</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// shouldPostProcess 等价于上一个方法中的 !synthetic，用于表示是否应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>shouldPostProcess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#000>beforeSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>postProcessObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#4e9a06>&#34;Post-processing of FactoryBean&#39;s singleton object failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>afterSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 这里的 beanName 对应于 FactoryBean 的实现类， FactoryBean 的实现类也会被实例化，并被缓存在 singletonObjects 中
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// FactoryBean 所创建的实例会被缓存在 factoryBeanObjectCache 中，供后续调用使用
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanObjectCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NULL_OBJECT</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 获取非单例实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 从工厂类中获取实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>shouldPostProcess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>postProcessObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Post-processing of FactoryBean&#39;s object failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>doGetObjectFromFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// if 分支的逻辑是 Java 安全方面的代码，可以忽略，直接看 else 分支的代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>AccessControlContext</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PrivilegedActionException</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 调用工厂方法生成 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBeanNotInitializedException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;FactoryBean threw exception on object creation&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;FactoryBean which is currently in creation returned null from getObject&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>getObjectForBeanInstance 及它所调用的方法主要做了如下几件事情：</p>
<ol>
<li>检测参数 beanInstance 的类型，如果是非 FactoryBean 类型的 bean，直接返回</li>
<li>检测 FactoryBean 实现类是否单例类型，针对单例和非单例类型进行不同处理</li>
<li>对于单例 FactoryBean，先从缓存里获取 FactoryBean 生成的实例</li>
<li>若缓存未命中，则调用 FactoryBean.getObject() 方法生成实例，并放入缓存中</li>
<li>对于非单例的 FactoryBean，每次直接创建新的实例即可，无需缓存</li>
<li>如果 shouldPostProcess = true，不管是单例还是非单例 FactoryBean 生成的实例，都要进行后置处理</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f162112b468f360d336fef678e9e61c1>2 - CH02-创建单例 Bean</h1>
<p>对于已实例化好的单例 bean，getBean(String) 方法并不会再一次去创建，而是从缓存中获取。如果某个 bean 还未实例化，这个时候就无法命中缓存。此时，就要根据 bean 的配置信息去创建这个 bean 了。相较于<code>getBean(String)</code>方法的实现逻辑，创建 bean 的方法<code>createBean(String, RootBeanDefinition, Object[])</code>及其所调用的方法逻辑上更为复杂一些。</p>
<h2 id=创建入口>创建入口</h2>
<p>在正式分析<code>createBean(String, RootBeanDefinition, Object[])</code>方法前，我们先来看看 createBean 方法是在哪里被调用的。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(...)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 省略不相关代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#5c35cc;font-weight:700>@Override</span>
    		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    		<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#ce5c00;font-weight:700>});</span>
    	<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 省略不相关代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面是 doGetBean 方法的代码片段，从中可以发现 createBean 方法。createBean 方法被匿名工厂类的 getObject 方法包裹，但这个匿名工厂类对象并未直接调用 getObject 方法。而是将自身作为参数传给了<code>getSingleton(String, ObjectFactory)</code>方法，那么我们接下来再去看看一下 <code>getSingleton(String, ObjectFactory) </code>方法的实现。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#39;beanName&#39; must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 从缓存中获取单例 bean，若不为空，则直接返回，不用再初始化
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonsCurrentlyInDestruction</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationNotAllowedException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#4e9a06>&#34;Singleton bean creation not allowed while singletons of this factory are in destruction &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
						<span style=color:#4e9a06>&#34;(Do not request a bean from a BeanFactory in a destroy method implementation!)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating shared instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>			 * 将 beanName 添加到 singletonsCurrentlyInCreation 集合中，
</span><span style=color:#8f5902;font-style:italic>			 * 用于表明 beanName 对应的 bean 正在创建中
</span><span style=color:#8f5902;font-style:italic>			 */</span>
			<span style=color:#000>beforeSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>recordSuppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>// 通过 getObject 方法调用 createBean 方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
				<span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>suppressedException</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addRelatedCause</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suppressedException</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recordSuppressedExceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suppressedExceptions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#8f5902;font-style:italic>// 将 beanName 从 singletonsCurrentlyInCreation 移除
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>afterSingletonCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>			     * 将 &lt;beanName, singletonObject&gt; 键值对添加到 singletonObjects 集合中，
</span><span style=color:#8f5902;font-style:italic>			     * 并从其他集合（比如 earlySingletonObjects）中移除 singletonObject 记录
</span><span style=color:#8f5902;font-style:italic>			     */</span>
				<span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>流程如下：</p>
<ol>
<li>先从 singletonObjects 集合获取 bean 实例，若不为空，则直接返回</li>
<li>若为空，进入创建 bean 实例阶段。先将 beanName 添加到 singletonsCurrentlyInCreation</li>
<li>通过 getObject 方法调用 createBean 方法创建 bean 实例</li>
<li>将 beanName 从 singletonsCurrentlyInCreation 集合中移除</li>
<li>将 &lt;beanName, singletonObject> 映射缓存到 singletonObjects 集合中</li>
</ol>
<p>从上面的分析中，我们知道了 createBean 方法在何处被调用的。那么接下来我们一起深入 createBean 方法的源码中，来看看这个方法具体都做了什么事情。</p>
<h2 id=创建流程>创建流程</h2>
<p>createBean 和 getBean 方法类似，基本上都是空壳方法，只不过 createBean 的逻辑稍微多点，多做了一些事情。下面我们一起看看这个方法的实现逻辑，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>// 解析 bean 的类型
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 处理 lookup-method 和 replace-method 配置，Spring 将这两个配置统称为 override method
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span>
				<span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Validation of method overrides failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 在 bean 初始化前应用后置处理，如果后置处理返回的 bean 不为空，则直接返回
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
				<span style=color:#4e9a06>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// 调用 doCreateBean 创建 bean
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finished creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>流程如下：</p>
<ol>
<li>解析 bean 类型</li>
<li>处理 lookup-method 和 replace-method 配置</li>
<li>在 bean 初始化前应用后置处理，若后置处理返回的 bean 不为空，则直接返回</li>
<li>若上一步后置处理返回的 bean 为空，则调用 doCreateBean 创建 bean 实例</li>
</ol>
<h2 id=验证准备-override-方法>验证准备 override 方法</h2>
<p>当用户配置了 lookup-method 和 replace-method 时，Spring 需要对目标 bean 进行增强。在增强之前，需要做一些准备工作，也就是 prepareMethodOverrides 中的逻辑。下面来看看这个方法的源码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>MethodOverrides</span> <span style=color:#000>methodOverrides</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>methodOverrides</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MethodOverride</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>overrides</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodOverrides</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 循环处理每个 MethodOverride 对象
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodOverride</span> <span style=color:#000>mo</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>prepareMethodOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareMethodOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodOverride</span> <span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// 获取方法名为 mo.getMethodName() 的方法数量，当方法重载时，count 的值就会大于1
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodCountForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodName</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#8f5902;font-style:italic>// count = 0，表明根据方法名未找到相应的方法，此时抛出异常
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionValidationException</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#4e9a06>&#34;Invalid method override: no method with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span>
				<span style=color:#4e9a06>&#34;&#39; on class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>// 若 count = 1，表明仅存在已方法名为 mo.getMethodName()，这意味着方法不存在重载
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 方法不存在重载，则将 overloaded 成员变量设为 false
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>mo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOverloaded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的源码中，<code>prepareMethodOverrides</code>方法循环调用了<code>prepareMethodOverride</code>方法，并没其他的太多逻辑。主要准备工作都是在 prepareMethodOverride 方法中进行的，所以我们重点关注一下这个方法。</p>
<p>prepareMethodOverride 这个方法主要用于获取指定方法的方法数量 count，并根据 count 的值进行相应的处理。count = 0 时，表明方法不存在，此时抛出异常。count = 1 时，设置 MethodOverride 对象的<code>overloaded</code>成员变量为 false。这样做的目的在于，提前标注名称<code>mo.getMethodName()</code>的方法不存在重载，在使用 CGLIB 增强阶段就不需要进行校验，直接找到某个方法进行增强即可。</p>
<h2 id=实例化前的后置处理>实例化前的后置处理</h2>
<p>后置处理是 Spring 的一个拓展点，用户通过实现 BeanPostProcessor 接口，并将实现类配置到 Spring 的配置文件中（或者使用注解），即可在 bean 初始化前后进行自定义操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#8f5902;font-style:italic>// 检测是否解析过，mbd.beforeInstantiationResolved 的值在下面的代码中会被设置
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeInstantiationResolved</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>targetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineTargetType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 应用前置处理
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#8f5902;font-style:italic>// 应用后置处理
</span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// 设置 mbd.beforeInstantiationResolved
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeInstantiationResolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>applyBeanPostProcessorsBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// InstantiationAwareBeanPostProcessor 一般在 Spring 框架内部使用，不建议用户直接使用
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#8f5902;font-style:italic>// bean 初始化前置处理
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>existingBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>existingBean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>beanProcessor</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
	   <span style=color:#8f5902;font-style:italic>// bean 初始化后置处理
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanProcessor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 resolveBeforeInstantiation 方法中，当前置处理方法返回的 bean 不为空时，后置处理才会被执行。前置处理器是 InstantiationAwareBeanPostProcessor 类型的，该种类型的处理器一般用在 Spring 框架内部，比如 AOP 模块中的<code>AbstractAutoProxyCreator</code>抽象类间接实现了这个接口中的 <code>postProcessBeforeInstantiation</code>方法，所以 AOP 可以在这个方法中生成为目标类的代理对象。</p>
<h2 id=调用-docreatebean>调用 doCreateBean</h2>
<p>在 Spring 中，做事情的方法基本上都是以<code>do</code>开头的，doCreateBean 也不例外。那下面我们就来看看这个方法都做了哪些事情。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>	 * BeanWrapper 是一个基础接口，由接口名可看出这个接口的实现类用于包裹 bean 实例。
</span><span style=color:#8f5902;font-style:italic>	 * 通过 BeanWrapper 的实现类可以方便的设置/获取 bean 实例的属性
</span><span style=color:#8f5902;font-style:italic>	 */</span>
	<span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// 从缓存中获取 BeanWrapper，并清理相关记录
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanInstanceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>	     * 创建 bean 实例，并将实例包裹在 BeanWrapper 实现类对象中返回。createBeanInstance 
</span><span style=color:#8f5902;font-style:italic>	     * 中包含三种创建 bean 实例的方式：
</span><span style=color:#8f5902;font-style:italic>	     *   1. 通过工厂方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic>	     *   2. 通过构造方法自动注入（autowire by constructor）的方式创建 bean 实例
</span><span style=color:#8f5902;font-style:italic>	     *   3. 通过无参构造方法方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic>		  *
</span><span style=color:#8f5902;font-style:italic>	     * 若 bean 的配置信息中配置了 lookup-method 和 replace-method，则会使用 CGLIB 
</span><span style=color:#8f5902;font-style:italic>	     * 增强 bean 实例。关于这个方法，后面会专门写一篇文章介绍，这里先说这么多。
</span><span style=color:#8f5902;font-style:italic>	     */</span>
		<span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#8f5902;font-style:italic>// 此处的 bean 可以认为是一个原始的 bean 实例，暂未填充属性
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedTargetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#8f5902;font-style:italic>// 这里又遇到后置处理了，此处的后置处理是用于处理已“合并的 BeanDefinition”。关于这种后置处理器具体的实现细节就不深入理解了，大家有兴趣可以自己去看
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
						<span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * earlySingletonExposure 是一个重要的变量，这里要说明一下。该变量用于表示是否提前暴露
</span><span style=color:#8f5902;font-style:italic>     * 单例 bean，用于解决循环依赖。earlySingletonExposure 由三个条件综合而成，如下：
</span><span style=color:#8f5902;font-style:italic>     *   条件1：mbd.isSingleton() - 表示 bean 是否是单例类型
</span><span style=color:#8f5902;font-style:italic>     *   条件2：allowCircularReferences - 是否允许循环依赖
</span><span style=color:#8f5902;font-style:italic>     *   条件3：isSingletonCurrentlyInCreation(beanName) - 当前 bean 是否处于创建的状态中
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * earlySingletonExposure = 条件1 &amp;&amp; 条件2 &amp;&amp; 条件3 
</span><span style=color:#8f5902;font-style:italic>     *                        = 单例 &amp;&amp; 是否允许循环依赖 &amp;&amp; 是否存于创建状态中。
</span><span style=color:#8f5902;font-style:italic>     */</span>
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
			<span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
					<span style=color:#4e9a06>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#8f5902;font-style:italic>// 添加工厂对象到 singletonFactories 缓存中
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#5c35cc;font-weight:700>@Override</span>
			<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#8f5902;font-style:italic>// 获取早期 bean 的引用，如果 bean 中的方法被 AOP 切点所匹配到，此时 AOP 相关逻辑会介入
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>});</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>// 向 bean 实例中填充属性，populateBean 方法也是一个很重要的方法，后面会专门写文章分析
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>		     * 进行余下的初始化工作，详细如下：
</span><span style=color:#8f5902;font-style:italic>             * 1. 判断 bean 是否实现了 BeanNameAware、BeanFactoryAware、
</span><span style=color:#8f5902;font-style:italic>             *    BeanClassLoaderAware 等接口，并执行接口方法
</span><span style=color:#8f5902;font-style:italic>             * 2. 应用 bean 初始化前置操作
</span><span style=color:#8f5902;font-style:italic>             * 3. 如果 bean 实现了 InitializingBean 接口，则执行 afterPropertiesSet 
</span><span style=color:#8f5902;font-style:italic>             *    方法。如果用户配置了 init-method，则调用相关方法执行自定义初始化逻辑
</span><span style=color:#8f5902;font-style:italic>             * 4. 应用 bean 初始化后置操作
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             * 另外，AOP 相关逻辑也会在该方法中织入切面逻辑，此时的 exposedObject 就变成了
</span><span style=color:#8f5902;font-style:italic>             * 一个代理对象了
</span><span style=color:#8f5902;font-style:italic>		     */</span>
			<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
					<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>// 若 initializeBean 方法未改变 exposedObject 的引用，则此处的条件为 true。
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>// 下面的逻辑我也没完全搞懂，就不分析了。见谅。
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowRawInjectionDespiteWrapping</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
						<span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>);</span>
					<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
					<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
							<span style=color:#4e9a06>&#34;Bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collectionToCommaDelimitedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
							<span style=color:#4e9a06>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	    <span style=color:#8f5902;font-style:italic>// 注册销毁逻辑
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行流程：</p>
<ol>
<li>从缓存中获取 BeanWrapper 实现类对象，并清理相关记录</li>
<li>若未命中缓存，则创建 bean 实例，并将实例包裹在 BeanWrapper 实现类对象中返回</li>
<li>应用 MergedBeanDefinitionPostProcessor 后置处理器相关逻辑</li>
<li>根据条件决定是否提前暴露 bean 的早期引用（early reference），用于处理循环依赖问题</li>
<li>调用 populateBean 方法向 bean 实例中填充属性</li>
<li>调用 initializeBean 方法完成余下的初始化工作</li>
<li>注册销毁逻辑</li>
</ol>
<p>由此也可了解到创建一个 bean 还是很复杂的，这中间要做的事情繁多。比如填充属性、对 BeanPostProcessor 拓展点提供支持等。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-134a7abbdac972a86f3f7920807642b0>3 - CH03-创建原始 Bean 对象</h1>
<h2 id=createbeaninstance>createBeanInstance</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 检测类的访问权限。默认情况下，对于非 public 的类，是允许访问的。
</span><span style=color:#8f5902;font-style:italic>     * 若禁止访问，这里会抛出异常
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;Bean class isn&#39;t public, and non-public access not allowed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果工厂方法不为空，则通过工厂方法构建 bean 对象。这种构建 bean 的方式
</span><span style=color:#8f5902;font-style:italic>     * 就不深入分析了，有兴趣的朋友可以自己去看一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 通过“工厂方法”的方式构建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateUsingFactoryMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 当多次构建同一个 bean 时，可以使用此处的快捷路径，即无需再次推断应该使用哪种方式构造实例，
</span><span style=color:#8f5902;font-style:italic>     * 以提高效率。比如在多次构建同一个 prototype 类型的 bean 时，就可以走此处的捷径。
</span><span style=color:#8f5902;font-style:italic>     * 这里的 resolved 和 mbd.constructorArgumentsResolved 将会在 bean 第一次实例
</span><span style=color:#8f5902;font-style:italic>     * 化的过程中被设置，在后面的源码中会分析到，先继续往下看。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowireNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 通过“构造方法自动注入”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 通过“默认构造方法”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 由后置处理器决定返回哪些构造方法，这里不深入分析了
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineConstructorsFromBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 下面的条件分支条件用于判断使用什么方式构造 bean 实例，有两种方式可选 - 构造方法自动
</span><span style=color:#8f5902;font-style:italic>     * 注入和默认构造方法。判断的条件由4部分综合而成，如下：
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     *    条件1：ctors != null -&gt; 后置处理器返回构造方法数组是否为空
</span><span style=color:#8f5902;font-style:italic>     *    
</span><span style=color:#8f5902;font-style:italic>     *    条件2：mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR 
</span><span style=color:#8f5902;font-style:italic>     *              -&gt; bean 配置中的 autowire 属性是否为 constructor    
</span><span style=color:#8f5902;font-style:italic>     *    条件3：mbd.hasConstructorArgumentValues() 
</span><span style=color:#8f5902;font-style:italic>     *              -&gt; constructorArgumentValues 是否存在元素，即 bean 配置文件中
</span><span style=color:#8f5902;font-style:italic>     *                 是否配置了 &lt;construct-arg/&gt;
</span><span style=color:#8f5902;font-style:italic>     *    条件4：!ObjectUtils.isEmpty(args) 
</span><span style=color:#8f5902;font-style:italic>     *              -&gt; args 数组是否存在元素，args 是由用户调用 
</span><span style=color:#8f5902;font-style:italic>     *                 getBean(String name, Object... args) 传入的
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * 上面4个条件，只要有一个为 true，就会通过构造方法自动注入的方式构造 bean 实例
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 通过“构造方法自动注入”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 通过“默认构造方法”的方式构造 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>流程如下：</p>
<ol>
<li>检测类的访问权限，若禁止访问，则抛出异常</li>
<li>若工厂方法不为空，则通过工厂方法构建 bean 对象，并返回结果</li>
<li>若构造方式已解析过，则走快捷路径构建 bean 对象，并返回结果</li>
<li>如第三步不满足，则通过组合条件决定使用哪种方式构建 bean 对象</li>
</ol>
<p>这里有三种构造 bean 对象的方式，如下：</p>
<ol>
<li>通过“工厂方法”的方式构造 bean 对象</li>
<li>通过“构造方法自动注入”的方式构造 bean 对象</li>
<li>通过“默认构造方法”的方式构造 bean 对象</li>
</ol>
<h2 id=创建构造方法自动注入>创建：构造方法自动注入</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 创建 ConstructorResolver 对象，并调用其 autowireConstructor 方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConstructorResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>chosenCtors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 创建 BeanWrapperImpl 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>BeanWrapperImpl</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ArgumentsHolder</span> <span style=color:#000>argsHolderToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 确定参数值列表（argsToUse）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>argsToResolve</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取已解析的构造方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获取已解析的构造方法参数列表
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorArguments</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 若 argsToUse 为空，则获取未解析的构造方法参数列表
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>argsToResolve</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preparedConstructorArguments</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argsToResolve</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 解析参数列表
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvePreparedArguments</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argsToResolve</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowiring</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chosenCtors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>resolvedValues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minNrOfArgs</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>minNrOfArgs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>cargs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>resolvedValues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 确定构造方法参数数量，比如下面的配置：
</span><span style=color:#8f5902;font-style:italic>             *     &lt;bean id=&#34;persion&#34; class=&#34;xyz.coolblog.autowire.Person&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *         &lt;constructor-arg index=&#34;0&#34; value=&#34;xiaoming&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *         &lt;constructor-arg index=&#34;1&#34; value=&#34;1&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *         &lt;constructor-arg index=&#34;2&#34; value=&#34;man&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *     &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 此时 minNrOfArgs = maxIndex + 1 = 2 + 1 = 3，除了计算 minNrOfArgs，
</span><span style=color:#8f5902;font-style:italic>             * 下面的方法还会将 cargs 中的参数数据转存到 resolvedValues 中
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>minNrOfArgs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveConstructorArguments</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cargs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resolvedValues</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 获取构造方法列表
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>chosenCtors</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>candidates</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span>
                        <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructors</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#4e9a06>&#34;Resolution of declared constructors on bean Class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;] from ClassLoader [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 按照构造方法的访问权限级别和参数数量进行排序
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>AutowireUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sortConstructors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minTypeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>candidates</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>paramTypes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 下面的 if 分支的用途是：若匹配到到合适的构造方法了，提前结束 for 循环
</span><span style=color:#8f5902;font-style:italic>             * constructorToUse != null 这个条件比较好理解，下面分析一下条件 argsToUse.length &gt; paramTypes.length：
</span><span style=color:#8f5902;font-style:italic>             * 前面说到 AutowireUtils.sortConstructors(candidates) 用于对构造方法进行
</span><span style=color:#8f5902;font-style:italic>             * 排序，排序规则如下：
</span><span style=color:#8f5902;font-style:italic>             *   1. 具有 public 访问权限的构造方法排在非 public 构造方法前
</span><span style=color:#8f5902;font-style:italic>             *   2. 参数数量多的构造方法排在前面
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 假设现在有一组构造方法按照上面的排序规则进行排序，排序结果如下（省略参数名称）：
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             *   1. public Hello(Object, Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   2. public Hello(Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   3. public Hello(Object)
</span><span style=color:#8f5902;font-style:italic>             *   4. protected Hello(Integer, Object, Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   5. protected Hello(Integer, Object, Object)
</span><span style=color:#8f5902;font-style:italic>             *   6. protected Hello(Integer, Object)
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * argsToUse = [num1, obj2]，可以匹配上的构造方法2和构造方法6。由于构造方法2有
</span><span style=color:#8f5902;font-style:italic>             * 更高的访问权限，所以没理由不选他（尽管后者在参数类型上更加匹配）。由于构造方法3
</span><span style=color:#8f5902;font-style:italic>             * 参数数量 &lt; argsToUse.length，参数数量上不匹配，也不应该选。所以 
</span><span style=color:#8f5902;font-style:italic>             * argsToUse.length &gt; paramTypes.length 这个条件用途是：在条件 
</span><span style=color:#8f5902;font-style:italic>             * constructorToUse != null 成立的情况下，通过判断参数数量与参数值数量
</span><span style=color:#8f5902;font-style:italic>             * （argsToUse.length）是否一致，来决定是否提前终止构造方法匹配逻辑。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>argsToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 构造方法参数数量低于配置的参数数量，则忽略当前构造方法，并重试。比如 
</span><span style=color:#8f5902;font-style:italic>             * argsToUse = [obj1, obj2, obj3, obj4]，上面的构造方法列表中，
</span><span style=color:#8f5902;font-style:italic>             * 构造方法1、2和3显然不是合适选择，忽略之。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>minNrOfArgs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#000>ArgumentsHolder</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedValues</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 判断否则方法是否有 ConstructorProperties 注解，若有，则取注解中的
</span><span style=color:#8f5902;font-style:italic>                     * 值。比如下面的代码：
</span><span style=color:#8f5902;font-style:italic>                     * 
</span><span style=color:#8f5902;font-style:italic>                     *  public class Persion {
</span><span style=color:#8f5902;font-style:italic>                     *      private String name;
</span><span style=color:#8f5902;font-style:italic>                     *      private Integer age;
</span><span style=color:#8f5902;font-style:italic>                     *
</span><span style=color:#8f5902;font-style:italic>                     *      @ConstructorProperties(value = {&#34;coolblog&#34;, &#34;20&#34;})
</span><span style=color:#8f5902;font-style:italic>                     *      public Persion(String name, Integer age) {
</span><span style=color:#8f5902;font-style:italic>                     *          this.name = name;
</span><span style=color:#8f5902;font-style:italic>                     *          this.age = age;
</span><span style=color:#8f5902;font-style:italic>                     *      }
</span><span style=color:#8f5902;font-style:italic>                     * }
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>paramNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConstructorPropertiesChecker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramNames</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>ParameterNameDiscoverer</span> <span style=color:#000>pnd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pnd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                             * 获取构造方法参数名称列表，比如有这样一个构造方法:
</span><span style=color:#8f5902;font-style:italic>                             *   public Person(String name, int age, String sex)
</span><span style=color:#8f5902;font-style:italic>                             *   
</span><span style=color:#8f5902;font-style:italic>                             * 调用 getParameterNames 方法返回 paramNames = [name, age, sex]
</span><span style=color:#8f5902;font-style:italic>                             */</span>
                            <span style=color:#000>paramNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pnd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterNames</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>                     * 创建参数值列表，返回 argsHolder 会包含进行类型转换后的参数值，比如下
</span><span style=color:#8f5902;font-style:italic>                     * 面的配置:
</span><span style=color:#8f5902;font-style:italic>                     *
</span><span style=color:#8f5902;font-style:italic>                     *     &lt;bean id=&#34;persion&#34; class=&#34;xyz.coolblog.autowire.Person&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *         &lt;constructor-arg name=&#34;name&#34; value=&#34;xiaoming&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>                     *         &lt;constructor-arg name=&#34;age&#34; value=&#34;1&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>                     *         &lt;constructor-arg name=&#34;sex&#34; value=&#34;man&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>                     *     &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>                     *
</span><span style=color:#8f5902;font-style:italic>                     * Person 的成员变量 age 是 Integer 类型的，但由于在 Spring 配置中
</span><span style=color:#8f5902;font-style:italic>                     * 只能配成 String 类型，所以这里要进行类型转换。
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#000>argsHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createArgumentArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resolvedValues</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramNames</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>getUserDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>autowiring</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UnsatisfiedDependencyException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span>
                                <span style=color:#4e9a06>&#34;Ignoring constructor [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#000>causes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>argsHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArgumentsHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 计算参数值（argsHolder.arguments）每个参数类型与构造方法参数列表
</span><span style=color:#8f5902;font-style:italic>             * （paramTypes）中参数的类型差异量，差异量越大表明参数类型差异越大。参数类型差异
</span><span style=color:#8f5902;font-style:italic>             * 越大，表明当前构造方法并不是一个最合适的候选项。引入差异量（typeDiffWeight）
</span><span style=color:#8f5902;font-style:italic>             * 变量目的：是将候选构造方法的参数列表类型与参数值列表类型的差异进行量化，通过量化
</span><span style=color:#8f5902;font-style:italic>             * 后的数值筛选出最合适的构造方法。
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             * 讲完差异量，再来说说 mbd.isLenientConstructorResolution() 条件。
</span><span style=color:#8f5902;font-style:italic>             * 官方的解释是：返回构造方法的解析模式，有宽松模式（lenient mode）和严格模式
</span><span style=color:#8f5902;font-style:italic>             * （strict mode）两种类型可选。具体的细节没去研究，就不多说了。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>typeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLenientConstructorResolution</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span>
                    <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeDifferenceWeight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAssignabilityWeight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramTypes</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>minTypeDiffWeight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>argsHolderToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>argsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>argsHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arguments</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>minTypeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeDiffWeight</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>             * 如果两个构造方法与参数值类型列表之间的差异量一致，那么这两个方法都可以作为
</span><span style=color:#8f5902;font-style:italic>             * 候选项，这个时候就出现歧义了，这里先把有歧义的构造方法放入 
</span><span style=color:#8f5902;font-style:italic>             * ambiguousConstructors 集合中
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>typeDiffWeight</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>minTypeDiffWeight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;();</span>
                    <span style=color:#000>ambiguousConstructors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>ambiguousConstructors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 若上面未能筛选出合适的构造方法，这里将抛出 BeanCreationException 异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>causes</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>UnsatisfiedDependencyException</span> <span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>causes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeLast</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>cause</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>causes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onSuppressedException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#4e9a06>&#34;Could not resolve matching constructor &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#4e9a06>&#34;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 constructorToUse != null，且 ambiguousConstructors 也不为空，表明解析
</span><span style=color:#8f5902;font-style:italic>         * 出了多个的合适的构造方法，此时就出现歧义了。Spring 不会擅自决定使用哪个构造方法，
</span><span style=color:#8f5902;font-style:italic>         * 所以抛出异常。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ambiguousConstructors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLenientConstructorResolution</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#4e9a06>&#34;Ambiguous constructor matches found in bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#4e9a06>&#34;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                    <span style=color:#000>ambiguousConstructors</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>explicitArgs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 缓存相关信息，比如：
</span><span style=color:#8f5902;font-style:italic>             *   1. 已解析出的构造方法对象 resolvedConstructorOrFactoryMethod
</span><span style=color:#8f5902;font-style:italic>             *   2. 构造方法参数列表是否已解析标志 constructorArgumentsResolved
</span><span style=color:#8f5902;font-style:italic>             *   3. 参数值列表 resolvedConstructorArguments 或 preparedConstructorArguments
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 这些信息可用在其他地方，用于进行快捷判断
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>argsHolderToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>storeCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ctorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>argumentsToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>argsToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span>
                            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctorToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argumentsToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 调用实例化策略创建实例，默认情况下使用反射创建实例。如果 bean 的配置信息中
</span><span style=color:#8f5902;font-style:italic>             * 包含 lookup-method 和 replace-method，则通过 CGLIB 增强 bean 实例
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>argsToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 设置 beanInstance 到 BeanWrapperImpl 对象中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;Bean instantiation via constructor failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法的核心逻辑是根据参数值类型筛选合适的构造方法。解析出合适的构造方法后，剩下的工作就是构建 bean 对象了，这个工作交给了实例化策略去做。下面罗列一下这个方法的工作流程吧：</p>
<ol>
<li>创建 BeanWrapperImpl 对象</li>
<li>解析构造方法参数，并算出 minNrOfArgs</li>
<li>获取构造方法列表，并排序</li>
<li>遍历排序好的构造方法列表，筛选合适的构造方法
<ol>
<li>获取构造方法参数列表中每个参数的名称</li>
<li>再次解析参数，此次解析会将 <code>&lt;constructor-arg/> value</code> 属性值进行类型转换，由 String 转为合适的类型。</li>
<li>计算构造方法参数列表与参数值列表之间的类型差异量，以筛选出更为合适的构造方法</li>
</ol>
</li>
<li>缓存已筛选出的构造方法以及参数值列表，若再次创建 bean 实例时，可直接使用，无需再次进行筛选</li>
<li>使用初始化策略创建 bean 对象</li>
<li>将 bean 对象放入 BeanWrapperImpl 对象中，并返回该对象</li>
</ol>
<h2 id=创建默认构造方法>创建：默认构造方法</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// if 条件分支里的一大坨是 Java 安全相关的代码，可以忽略，直接看 else 分支
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 调用实例化策略创建实例，默认情况下使用反射创建对象。如果 bean 的配置信息中
</span><span style=color:#8f5902;font-style:italic>             * 包含 lookup-method 和 replace-method，则通过 CGLIB 创建 bean 对象
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 创建 BeanWrapperImpl 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 检测 bean 配置中是否配置了 lookup-method 或 replace-method，若配置了，则需使用 CGLIB 构建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Specified class is an interface&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#5c35cc;font-weight:700>@Override</span>
                            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 获取默认构造方法
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 设置 resolvedConstructorOrFactoryMethod
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No default constructor found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 通过无参构造方法创建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用 GCLIG 创建 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateWithMethodInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面就是通过默认构造方法创建 bean 对象的过程，比较简单，就不多说了。最后我们再来看看简单看看通过无参构造方法刚创建 bean 对象的代码（通过 CGLIB 创建 bean 对象的方式就不看了）是怎样的，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanInstantiationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Constructor must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置构造方法为可访问
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ReflectionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 通过反射创建 bean 实例，这里的 args 是一个没有元素的空数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Is it an abstract class?&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalAccessException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Is the constructor accessible?&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal arguments for constructor&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationTargetException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Constructor threw exception&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetException</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f226756c00275a43d5e85dc95b38990e>4 - CH04-解决循环依赖</h1>
<h2 id=循环依赖>循环依赖</h2>
<p>所谓的循环依赖是指，A 依赖 B，B 又依赖 A，它们之间形成了循环依赖。或者是 A 依赖 B，B 依赖 C，C 又依赖 A。它们之间的依赖关系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230312.png style=display:block;width:60% alt=NAME align=center> </div>
<p>这里以两个类直接相互依赖为例，他们的实现代码可能如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanB</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 省略 getter/setter
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanA</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.BeanA&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.BeanB&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>IOC 容器在读到上面的配置时，会按照顺序，先去实例化 beanA。然后发现 beanA 依赖于 beanB，接在又去实例化 beanB。实例化 beanB 时，发现 beanB 又依赖于 beanA。</p>
<p>如果容器不处理循环依赖的话，容器会无限执行上面的流程，直到内存溢出，程序崩溃。当然，Spring 是不会让这种情况发生的。在容器再次发现 beanB 依赖于 beanA 时，容器会获取 beanA 对象的一个早期的引用（early reference），并把这个早期引用注入到 beanB 中，让 beanB 先完成实例化。beanB 完成实例化，beanA 就可以获取到 beanB 的引用，beanA 随之完成实例化。这里大家可能不知道“早期引用”是什么意思，这里先别着急，我会在下一章进行说明。</p>
<h2 id=缓存介绍>缓存介绍</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** Cache of singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>singletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>256</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>singletonFactories</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of early singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>earlySingletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>根据缓存变量上面的注释，大家应该能大致了解他们的用途。我这里简单说明一下吧：</p>
<table>
<thead>
<tr>
<th style=text-align:left>缓存</th>
<th style=text-align:left>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>singletonObjects</td>
<td style=text-align:left>用于存放完全初始化好的 bean，从该缓存中取出的 bean 可以直接使用</td>
</tr>
<tr>
<td style=text-align:left>earlySingletonObjects</td>
<td style=text-align:left>存放原始的 bean 对象（尚未填充属性），用于解决循环依赖</td>
</tr>
<tr>
<td style=text-align:left>singletonFactories</td>
<td style=text-align:left>存放 bean 工厂对象，用于解决循环依赖</td>
</tr>
</tbody>
</table>
<p>上一章提到了”早期引用“，所谓的”早期引用“是指向原始对象的引用。所谓的原始对象是指刚创建好的对象，但还未填充属性。这样讲大家不知道大家听明白了没，不过没听明白也不要紧。简单做个实验就知道了，这里我们先定义一个对象 Room：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** Room 包含了一些电器 */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Room</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>television</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>airConditioner</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>refrigerator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>washer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 省略 getter/setter
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;room&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;xyz.coolblog.demo.Room&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;television&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Xiaomi&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;airConditioner&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Gree&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;refrigerator&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Haier&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;washer&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Siemens&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>下图依次是原始 bean 和完全初始化后的 bean：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230533.png style=display:block;width:60% alt=NAME align=center> </div>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230608.png style=display:block;width:60% alt=NAME align=center> </div>
<p>这里的 bean 和上面的 bean 指向的是同一个对象<code>Room@1567</code>，但现在这个对象所有字段都是 null，我们把这种对象成为原始的对象。形象点说，上面的 bean 对象是一个装修好的房子，可以拎包入住了。而这里的 bean 对象还是个毛坯房，还要装修一下（填充属性）才行。</p>
<h2 id=bean-获取过程回顾>Bean 获取过程回顾</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230652.png style=display:block;width:80% alt=NAME align=center> </div>
<p>开始流程图中只有一条执行路径，在条件 sharedInstance != null 这里出现了岔路，形成了绿色和红色两条路径。在上图中，读取/添加缓存的方法我用蓝色的框和☆标注了出来。至于虚线的箭头，和虚线框里的路径，这个下面会说到。</p>
<p>我来按照上面的图，分析一下整个流程的执行顺序。这个流程从 getBean 方法开始，getBean 是个空壳方法，所有逻辑都在 doGetBean 方法中。doGetBean 首先会调用 getSingleton(beanName) 方法获取 sharedInstance，sharedInstance 可能是完全实例化好的 bean，也可能是一个原始的 bean，当然也有可能是 null。如果不为 null，则走绿色的那条路径。再经 getObjectForBeanInstance 这一步处理后，绿色的这条执行路径就结束了。</p>
<p>我们再来看一下红色的那条执行路径，也就是 sharedInstance = null 的情况。在第一次获取某个 bean 的时候，缓存中是没有记录的，所以这个时候要走创建逻辑。上图中的 getSingleton(beanName,</p>
<p><code>new ObjectFactory&lt;Object>() {...}) </code>方法会创建一个 bean 实例，上图虚线路径指的是 getSingleton 方法内部调用的两个方法，其逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上所示，getSingleton 会在内部先调用 getObject 方法创建 singletonObject，然后再调用 addSingleton 将 singletonObject 放入缓存中。getObject 在内部代用了 createBean 方法，createBean 方法基本上也属于空壳方法，更多的逻辑是写在 doCreateBean 方法中的。doCreateBean 方法中的逻辑很多，其首先调用了 createBeanInstance 方法创建了一个原始的 bean 对象，随后调用 addSingletonFactory 方法向缓存中添加单例 bean 工厂，从该工厂可以获取原始对象的引用，也就是所谓的“早期引用”。再之后，继续调用 populateBean 方法向原始 bean 对象中填充属性，并解析依赖。getObject 执行完成后，会返回完全实例化好的 bean。紧接着再调用 addSingleton 把完全实例化好的 bean 对象放入缓存中。到这里，红色执行路径差不多也就要结束的。</p>
<p>我这里没有把 getObject、addSingleton 方法和 getSingleton(String, ObjectFactory) 并列画在红色的路径里，目的是想简化一下方法的调用栈（都画进来有点复杂）。我们可以进一步简化上面的调用流程，比如下面：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011230747.png style=display:block;width:80% alt=NAME align=center> </div>
<p>这个流程看起来是不是简单多了，命中缓存走绿色路径，未命中走红色的创建路径。</p>
<h2 id=源码分析>源码分析</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// ...... 
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 从缓存中获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从 singletonObjects 获取实例，singletonObjects 中的实例都是准备好的 bean 实例，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 判断 beanName 对应的 bean 是否正在创建中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从 earlySingletonObjects 中获取提前曝光的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 获取相应的 bean 工厂
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 提前曝光 bean 实例（raw bean），用于解决循环依赖
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                    
                    <span style=color:#8f5902;font-style:italic>// 将 singletonObject 放入缓存中，并将 singletonFactory 从缓存中移除
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的源码中，doGetBean 所调用的方法 getSingleton(String) 是一个空壳方法，其主要逻辑在 getSingleton(String, boolean) 中。该方法逻辑比较简单，首先从 singletonObjects 缓存中获取 bean 实例。若未命中，再去 earlySingletonObjects 缓存中获取原始 bean 实例。如果仍未命中，则从 singletonFactory 缓存中获取 ObjectFactory 对象，然后再调用 getObject 方法获取原始 bean 实例的应用，也就是早期引用。获取成功后，将该实例放入 earlySingletonObjects 缓存中，并将 ObjectFactory 对象从 singletonFactories 移除。看完这个方法，我们再来看看 getSingleton(String, ObjectFactory) 方法，这个方法也是在 doGetBean 中被调用的。这次我会把 doGetBean 的代码多贴一点出来，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// ...... 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 从缓存中获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 这里先忽略 args == null 这个条件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 进行后续的处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#8f5902;font-style:italic>// mbd.isSingleton() 用于判断 bean 是否是单例模式
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 再次获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 创建 bean 实例，createBean 返回的 bean 是完全实例化好的
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#8f5902;font-style:italic>// 进行后续的处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的代码逻辑和我在 <code>回顾获取 bean 的过程</code> 一节的最后贴的主流程图已经很接近了，对照那张图和代码中的注释，大家应该可以理解 doGetBean 方法了。继续往下看：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#8f5902;font-style:italic>// 调用 getObject 方法创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>newSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 添加 bean 到 singletonObjects 缓存中，并从其他集合中将 bean 相关记录移除
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#8f5902;font-style:italic>// 返回 singletonObject
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 将 &lt;beanName, singletonObject&gt; 映射存入 singletonObjects 中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NULL_OBJECT</span><span style=color:#ce5c00;font-weight:700>));</span>

        <span style=color:#8f5902;font-style:italic>// 从其他缓存中移除 beanName 相关映射
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registeredSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码中包含两步操作，第一步操作是调用 getObject 创建 bean 实例，第二步是调用 addSingleton 方法将创建好的 bean 放入缓存中。代码逻辑并不复杂，相信大家都能看懂。那么接下来我们继续往下看，这次分析的是 doCreateBean 中的一些逻辑。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// ☆ 创建 bean 对象，并将 bean 对象包裹在 BeanWrapper 对象中返回
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 从 BeanWrapper 对象中获取 bean 对象，这里的 bean 指向的是一个原始的对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * earlySingletonExposure 用于表示是否”提前暴露“原始对象的引用，用于解决循环依赖。
</span><span style=color:#8f5902;font-style:italic>     * 对于单例 bean，该变量一般为 true。更详细的解释可以参考我之前的文章
</span><span style=color:#8f5902;font-style:italic>     */</span> 
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ☆ 添加 bean 工厂对象到 singletonFactories 缓存中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>                 * 获取原始对象的早期引用，在 getEarlyBeanReference 方法中，会执行 AOP 
</span><span style=color:#8f5902;font-style:italic>                 * 相关逻辑。若 bean 未被 AOP 拦截，getEarlyBeanReference 原样返回 
</span><span style=color:#8f5902;font-style:italic>                 * bean，所以大家可以把 
</span><span style=color:#8f5902;font-style:italic>                 *      return getEarlyBeanReference(beanName, mbd, bean) 
</span><span style=color:#8f5902;font-style:italic>                 * 等价于：
</span><span style=color:#8f5902;font-style:italic>                 *      return bean;
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// ☆ 填充属性，解析依赖
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// ......
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 将 singletonFactory 添加到 singletonFactories 缓存中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 从其他缓存中移除相关记录，即使没有
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registeredSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码简化了不少，不过看起来仍有点复杂。好在，上面代码的主线逻辑比较简单，由三个方法组成。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#0000cf;font-weight:700>1.</span> <span style=color:#000>创建原始</span> <span style=color:#000>bean</span> <span style=color:#000>实例</span> <span style=color:#a40000>→</span> <span style=color:#000>createBeanInstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#0000cf;font-weight:700>2.</span> <span style=color:#000>添加原始对象工厂对象到</span> <span style=color:#000>singletonFactories</span> <span style=color:#000>缓存中</span> 
        <span style=color:#a40000>→</span> <span style=color:#000>addSingletonFactory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>{...})</span>
<span style=color:#0000cf;font-weight:700>3.</span> <span style=color:#000>填充属性</span><span style=color:#a40000>，</span><span style=color:#000>解析依赖</span> <span style=color:#a40000>→</span> <span style=color:#000>populateBean</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><h2 id=关键步骤>关键步骤</h2>
<p>在上面的方法调用中，有几个关键的地方，下面一一列举出来：</p>
<h3 id=1-创建原始-bean-对象><strong>1. 创建原始 bean 对象</strong></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getWrappedInstance</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>假设 beanA 先被创建，创建后的原始对象为 <code>BeanA@1234</code>，上面代码中的 bean 变量指向就是这个对象。</p>
<p><strong>2. 暴露早期引用</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000>addSingletonFactory</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#a40000>@</span><span style=color:#000>Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87>Object</span> <span style=color:#000>getObject</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>});</span>
</code></pre></div><p>beanA 指向的原始对象创建好后，就开始把指向原始对象的引用通过 ObjectFactory 暴露出去。getEarlyBeanReference 方法的第三个参数 bean 指向的正是 createBeanInstance 方法创建出原始 bean 对象 BeanA@1234。</p>
<h3 id=3-解析依赖><strong>3. 解析依赖</strong></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#000>populateBean</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>populateBean 用于向 beanA 这个原始对象中填充属性，当它检测到 beanA 依赖于 beanB 时，会首先去实例化 beanB。beanB 在此方法处也会解析自己的依赖，当它检测到 beanA 这个依赖，于是调用 BeanFactry.getBean(&ldquo;beanA&rdquo;) 这个方法，从容器中获取 beanA。</p>
<h3 id=4-获取早期引用><strong>4. 获取早期引用</strong></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87>Object</span> <span style=color:#000>getSingleton</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>String</span> <span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonObjects</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonObjects</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// ☆ 从缓存中获取早期引用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>earlySingletonObjects</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonFactories</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// ☆ 从 SingletonFactory 中获取早期引用
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getObject</span><span style=color:#000;font-weight:700>();</span>
                    
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>earlySingletonObjects</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#000;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>singletonFactories</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL_OBJECT</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>接着上面的步骤讲，populateBean 调用 BeanFactry.getBean(&ldquo;beanA&rdquo;) 以获取 beanB 的依赖。getBean(&ldquo;beanA&rdquo;) 会先调用 getSingleton(&ldquo;beanA&rdquo;)，尝试从缓存中获取 beanA。此时由于 beanA 还没完全实例化好，于是 this.singletonObjects.get(&ldquo;beanA&rdquo;) 返回 null。接着 this.earlySingletonObjects.get(&ldquo;beanA&rdquo;) 也返回空，因为 beanA 早期引用还没放入到这个缓存中。最后调用 singletonFactory.getObject() 返回 singletonObject，此时 singletonObject != null。singletonObject 指向 BeanA@1234，也就是 createBeanInstance 创建的原始对象。此时 beanB 获取到了这个原始对象的引用，beanB 就能顺利完成实例化。beanB 完成实例化后，beanA 就能获取到 beanB 所指向的实例，beanA 随之也完成了实例化工作。由于 beanB.beanA 和 beanA 指向的是同一个对象 BeanA@1234，所以 beanB 中的 beanA 此时也处于可用状态了。</p>
<p>以上的过程对应下面的流程图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011231159.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d9a521069fb4cad9079c5b918a21c5a1>5 - CH05-原始 Bean 属性填充</h1>
<h2 id=populatebean-源码>populateBean 源码</h2>
<p>本节，我们先来看一下填充属性的方法，即 populateBean。该方法并不复杂，但它所调用的一些方法比较复杂。不过好在我们这里只需要知道这些方法都有什么用就行了，暂时不用纠结细节。好了，下面看源码吧。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取属性列表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Cannot apply property values to null instance&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 在属性被填充前，给 InstantiationAwareBeanPostProcessor 类型的后置处理器一个修改 
</span><span style=color:#8f5902;font-style:italic>     * bean 状态的机会。关于这段后置引用，官方的解释是：让用户可以自定义属性注入。比如用户实现一
</span><span style=color:#8f5902;font-style:italic>     * 个 InstantiationAwareBeanPostProcessor 类型的后置处理器，并通过 
</span><span style=color:#8f5902;font-style:italic>     * postProcessAfterInstantiation 方法向 bean 的成员变量注入自定义的信息。当然，如果无
</span><span style=color:#8f5902;font-style:italic>     * 特殊需求，直接使用配置中的信息注入即可。另外，Spring 并不建议大家直接实现 
</span><span style=color:#8f5902;font-style:italic>     * InstantiationAwareBeanPostProcessor 接口，如果想实现这种类型的后置处理器，更建议
</span><span style=color:#8f5902;font-style:italic>     * 通过继承 InstantiationAwareBeanPostProcessorAdapter 抽象类实现自定义后置处理器。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>     * 如果上面设置 continueWithPropertyPopulation = false，表明用户可能已经自己填充了
</span><span style=color:#8f5902;font-style:italic>     * bean 的属性，不需要 Spring 帮忙填充了。此时直接返回即可
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>continueWithPropertyPopulation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 根据名称或类型注入依赖
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>newPvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// 通过属性名称注入依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 通过属性类型注入依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsDepCheck</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyCheck</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPENDENCY_CHECK_NONE</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 这里又是一种后置处理，用于在 Spring 填充属性到 bean 对象前，对属性的值进行相应的处理，
</span><span style=color:#8f5902;font-style:italic>     * 比如可以修改某些属性的值。这时注入到 bean 中的值就不是配置文件中的内容了，
</span><span style=color:#8f5902;font-style:italic>     * 而是经过后置处理器修改后的内容
</span><span style=color:#8f5902;font-style:italic>     */</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredPds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>filterPropertyDescriptorsForDependencyCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCaching</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 对属性进行后置处理
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>checkDependencies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 应用属性值到 bean 对象中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的源码注释的比较详细了，下面我们来总结一下这个方法的执行流程。如下：</p>
<ol>
<li>获取属性列表 pvs</li>
<li>在属性被填充到 bean 前，应用后置处理自定义属性填充</li>
<li>根据名称或类型解析相关依赖</li>
<li>再次应用后置处理，用于动态修改属性列表 pvs 的内容</li>
<li>将属性应用到 bean 对象中</li>
</ol>
<p>注意第 3 步，也就是根据名称或类型解析相关依赖（autowire）。该逻辑只会解析依赖，并不会将解析出的依赖立即注入到 bean 对象中。所有的属性值是在 applyPropertyValues 方法中统一被注入到 bean 对象中的。</p>
<p>在下面的章节中，我将会对 populateBean 方法中比较重要的几个方法调用进行分析，也就是第3步和第5步中的三个方法。好了，本节先到这里。</p>
<h2 id=autowirebyname>autowireByName</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 获取非简单类型属性的名称，且该属性未被配置在配置文件中。这里从反面解释一下什么是&#34;非简单类型&#34;
</span><span style=color:#8f5902;font-style:italic>     * 属性，我们先来看看 Spring 认为的&#34;简单类型&#34;属性有哪些，如下：
</span><span style=color:#8f5902;font-style:italic>     *   1. CharSequence 接口的实现类，比如 String
</span><span style=color:#8f5902;font-style:italic>     *   2. Enum
</span><span style=color:#8f5902;font-style:italic>     *   3. Date
</span><span style=color:#8f5902;font-style:italic>     *   4. URI/URL
</span><span style=color:#8f5902;font-style:italic>     *   5. Number 的继承类，比如 Integer/Long
</span><span style=color:#8f5902;font-style:italic>     *   6. byte/short/int... 等基本类型
</span><span style=color:#8f5902;font-style:italic>     *   7. Locale
</span><span style=color:#8f5902;font-style:italic>     *   8. 以上所有类型的数组形式，比如 String[]、Date[]、int[] 等等
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * 除了要求非简单类型的属性外，还要求属性未在配置文件中配置过，也就是 pvs.contains(pd.getName()) = false。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>propertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsatisfiedNonSimpleProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>propertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 检测是否存在与 propertyName 相关的 bean 或 BeanDefinition。若存在，则调用 BeanFactory.getBean 方法获取 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 从容器中获取相应的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 将解析出的 bean 存入到属性值列表（pvs）中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Added autowiring by name from bean name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; via property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to bean named &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTraceEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Not autowiring property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; by name: no matching bean found&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>autowireByName 方法的逻辑比较简单，该方法首先获取非简单类型属性的名称，然后再根据名称到容器中获取相应的 bean 实例，最后再将获取到的 bean 添加到属性列表中即可。既然这个方法比较简单，那我也就不多说了，继续下面的分析。</p>
<h2 id=autowirebytype>autowireByType</h2>
<p>本节我们来分析一下 autowireByName 的孪生兄弟 autowireByType，相较于 autowireByName，autowireByType 则要复杂一些，复杂之处在于解析依赖的过程。不过也没关系，如果我们不过于纠结细节，我们完全可以把一些复杂的地方当做一个黑盒，我们只需要要知道这个黑盒有什么用即可。这样可以在很大程度上降低源码分析的难度。好了，其他的就不多说了，咱们来分析源码吧。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>TypeConverter</span> <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCustomTypeConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取非简单类型的属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>propertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsatisfiedNonSimpleProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>propertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>PropertyDescriptor</span> <span style=color:#000>pd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 如果属性类型为 Object，则忽略，不做解析
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 获取 setter 方法（write method）的参数信息，比如参数在参数列表中的
</span><span style=color:#8f5902;font-style:italic>                 * 位置，参数类型，以及该参数所归属的方法等信息
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>MethodParameter</span> <span style=color:#000>methodParam</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWriteMethodParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// Do not allow eager init for type matching in case of a prioritized post-processor.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>eager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>PriorityOrdered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#8f5902;font-style:italic>// 创建依赖描述对象
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>DependencyDescriptor</span> <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AutowireByTypeDependencyDescriptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodParam</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eager</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 下面的方法用于解析依赖。过程比较复杂，先把这里看成一个黑盒，我们只要知道这
</span><span style=color:#8f5902;font-style:italic>                 * 个方法可以帮我们解析出合适的依赖即可。
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>Object</span> <span style=color:#000>autowiredArgument</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredArgument</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 将解析出的 bean 存入到属性值列表（pvs）中
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredArgument</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Autowiring by type from bean name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; via property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                                <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to bean named &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsatisfiedDependencyException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上所示，autowireByType 的代码本身并不复杂。和 autowireByName 一样，autowireByType 首先也是获取非简单类型属性的名称。然后再根据属性名获取属性描述符，并由属性描述符获取方法参数对象 MethodParameter，随后再根据 MethodParameter 对象获取依赖描述符对象，整个过程为 <code>beanName → PropertyDescriptor → MethodParameter → DependencyDescriptor</code>。在获取到依赖描述符对象后，再根据依赖描述符解析出合适的依赖。最后将解析出的结果存入属性列表 pvs 中即可。</p>
<p>关于 autowireByType 方法中出现的几种描述符对象，大家自己去看一下他们的实现吧，我就不分析了。接下来，我们来分析一下解析依赖的方法 resolveDependency。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>resolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DependencyDescriptor</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>initParameterNameDiscovery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getParameterNameDiscoverer</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaUtilOptionalClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OptionalDependencyFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createOptionalDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>ObjectProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DependencyObjectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaxInjectProviderClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Jsr330ProviderFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createDependencyProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getLazyResolutionProxyIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 解析依赖
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doResolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestingBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>doResolveDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DependencyDescriptor</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeConverter</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>InjectionPoint</span> <span style=color:#000>previousInjectionPoint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConstructorResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentInjectionPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 该方法最终调用了 beanFactory.getBean(String, Class)，从容器中获取依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>shortcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveShortcut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 如果容器中存在所需依赖，这里进行断路操作，提前结束依赖解析逻辑
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortcut</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>shortcut</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyType</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 处理 @value 注解
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAutowireCandidateResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSuggestedValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>strVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveEmbeddedValue</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>BeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>getMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>evaluateBeanDefinitionString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>TypeConverter</span> <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeConverter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>typeConverter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getField</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span>
                    <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getField</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>:</span>
                    <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodParameter</span><span style=color:#ce5c00;font-weight:700>()));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 解析数组、list、map 等类型的依赖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>multipleBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveMultipleBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeConverter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>multipleBeans</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>multipleBeans</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 按类型查找候选列表，如果某个类型已经被实例化，则返回相应的实例。
</span><span style=color:#8f5902;font-style:italic>         * 比如下面的配置：
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         *   &lt;bean name=&#34;mongoDao&#34; class=&#34;xyz.coolblog.autowire.MongoDao&#34; primary=&#34;true&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>         *   &lt;bean name=&#34;service&#34; class=&#34;xyz.coolblog.autowire.Service&#34; autowire=&#34;byType&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>         *   &lt;bean name=&#34;mysqlDao&#34; class=&#34;xyz.coolblog.autowire.MySqlDao&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         * MongoDao 和 MySqlDao 均实现自 Dao 接口，Service 对象（不是接口）中有一个 Dao 
</span><span style=color:#8f5902;font-style:italic>         * 类型的属性。现在根据类型自动注入 Dao 的实现类。这里有两个候选 bean，一个是 
</span><span style=color:#8f5902;font-style:italic>         * mongoDao，另一个是 mysqlDao，其中 mongoDao 在 service 之前实例化，
</span><span style=color:#8f5902;font-style:italic>         * mysqlDao 在 service 之后实例化。此时 findAutowireCandidates 方法会返回如下的结果：
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         *   matchingBeans = [ &lt;mongoDao, Object@MongoDao&gt;, &lt;mysqlDao, Class@MySqlDao&gt; ]
</span><span style=color:#8f5902;font-style:italic>         *
</span><span style=color:#8f5902;font-style:italic>         * 注意 mysqlDao 还未实例化，所以返回的是 MySqlDao.class。
</span><span style=color:#8f5902;font-style:italic>         * 
</span><span style=color:#8f5902;font-style:italic>         * findAutowireCandidates 这个方法逻辑比较复杂，我简单说一下它的工作流程吧，如下：
</span><span style=color:#8f5902;font-style:italic>         *   1. 从 BeanFactory 中获取某种类型 bean 的名称，比如上面的配置中 
</span><span style=color:#8f5902;font-style:italic>         *      mongoDao 和 mysqlDao 均实现了 Dao 接口，所以他们是同一种类型的 bean。
</span><span style=color:#8f5902;font-style:italic>         *   2. 遍历上一步得到的名称列表，并判断 bean 名称对应的 bean 是否是合适的候选项，
</span><span style=color:#8f5902;font-style:italic>         *      若合适则添加到候选列表中，并在最后返回候选列表
</span><span style=color:#8f5902;font-style:italic>         *      
</span><span style=color:#8f5902;font-style:italic>         * findAutowireCandidates 比较复杂，我并未完全搞懂，就不深入分析了。见谅
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>matchingBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findAutowireCandidates</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 抛出 NoSuchBeanDefinitionException 异常
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>raiseNoMatchingBeanFound</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvableType</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>String</span> <span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Object</span> <span style=color:#000>instanceCandidate</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * matchingBeans.size() &gt; 1，则表明存在多个可注入的候选项，这里判断使用哪一个
</span><span style=color:#8f5902;font-style:italic>             * 候选项。比如下面的配置：
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean name=&#34;mongoDao&#34; class=&#34;xyz.coolblog.autowire.MongoDao&#34; primary=&#34;true&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean name=&#34;mysqlDao&#34; class=&#34;xyz.coolblog.autowire.MySqlDao&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * mongoDao 的配置中存在 primary 属性，所以 mongoDao 会被选为最终的候选项。如
</span><span style=color:#8f5902;font-style:italic>             * 果两个 bean 配置都没有 primary 属性，则需要根据优先级选择候选项。优先级这一块
</span><span style=color:#8f5902;font-style:italic>             * 的逻辑没细看，不多说了。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>indicatesMultipleBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 抛出 NoUniqueBeanDefinitionException 异常
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveNotUnique</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 根据解析出的 autowiredBeanName，获取相应的候选项
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>instanceCandidate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 只有一个候选项，直接取出来即可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>matchingBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>autowiredBeanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>instanceCandidate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanNames</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autowiredBeanNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 返回候选项实例，如果实例是 Class 类型，则调用 beanFactory.getBean(String, Class) 获取相应的 bean。否则直接返回即可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceCandidate</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Class</span> <span style=color:#ce5c00;font-weight:700>?</span>
                <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowiredBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>instanceCandidate</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConstructorResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentInjectionPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>previousInjectionPoint</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由上面的代码可以看出，doResolveDependency 这个方法还是挺复杂的。这里我就不继续分析 doResolveDependency 所调用的方法了，对于这些方法，我也是似懂非懂。好了，本节的最后我们来总结一下 doResolveDependency 的执行流程吧，如下：</p>
<ol>
<li>首先将 beanName 和 requiredType 作为参数，并尝试从 BeanFactory 中获取与此对于的 bean。若获取成功，就可以提前结束 doResolveDependency 的逻辑。</li>
<li>处理 @value 注解</li>
<li>解析数组、List、Map 等类型的依赖，如果解析结果不为空，则返回结果</li>
<li>根据类型查找合适的候选项</li>
<li>如果候选项的数量为0，则抛出异常。为1，直接从候选列表中取出即可。若候选项数量 > 1，则在多个候选项中确定最优候选项，若无法确定则抛出异常</li>
<li>若候选项是 Class 类型，表明候选项还没实例化，此时通过 BeanFactory.getBean 方法对其进行实例化。若候选项是非 Class 类型，则表明已经完成了实例化，此时直接返回即可。</li>
</ol>
<h2 id=applypropertyvalues>applyPropertyValues</h2>
<p>经过了上面的流程，现在终于可以将属性值注入到 bean 对象中了。当然，这里还不能立即将属性值注入到对象中，因为在 Spring 配置文件中属性值都是以 String 类型进行配置的，所以 Spring 框架需要对 String 类型进行转换。除此之外，对于 ref 属性，这里还需要根据 ref 属性值解析依赖。还有一些其他操作，这里就不多说了，更多的信息我们一起在源码探寻。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bw</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setSecurityContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>mpvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mpvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果属性列表 pvs 被转换过，则直接返回即可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConverted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                        <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Error setting property values&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>original</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValueList</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>original</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>TypeConverter</span> <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCustomTypeConverter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>BeanDefinitionValueResolver</span> <span style=color:#000>valueResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>deepCopy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolveNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 遍历属性列表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValue</span> <span style=color:#000>pv</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果属性值被转换过，则就不需要再次转换
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConverted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Object</span> <span style=color:#000>originalValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 解析属性值。举例说明，先看下面的配置：
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean id=&#34;macbook&#34; class=&#34;MacBookPro&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;manufacturer&#34; value=&#34;Apple&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;width&#34; value=&#34;280&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;cpu&#34; ref=&#34;cpu&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;property name=&#34;interface&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *           &lt;list&gt;
</span><span style=color:#8f5902;font-style:italic>             *               &lt;value&gt;USB&lt;/value&gt;
</span><span style=color:#8f5902;font-style:italic>             *               &lt;value&gt;HDMI&lt;/value&gt;
</span><span style=color:#8f5902;font-style:italic>             *               &lt;value&gt;Thunderbolt&lt;/value&gt;
</span><span style=color:#8f5902;font-style:italic>             *           &lt;/list&gt;
</span><span style=color:#8f5902;font-style:italic>             *       &lt;/property&gt;
</span><span style=color:#8f5902;font-style:italic>             *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 上面是一款电脑的配置信息，每个 property 配置经过下面的方法解析后，返回如下结果：
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;manufacturer&#34;, resolvedValue = &#34;Apple&#34;
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;width&#34;, resolvedValue = &#34;280&#34;
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;cpu&#34;, resolvedValue = &#34;CPU@1234&#34;  注：resolvedValue 是一个对象
</span><span style=color:#8f5902;font-style:italic>             *   propertyName = &#34;interface&#34;, resolvedValue = [&#34;USB&#34;, &#34;HDMI&#34;, &#34;Thunderbolt&#34;]
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * 如上所示，resolveValueIfNecessary 会将 ref 解析为具体的对象，将 &lt;list&gt; 
</span><span style=color:#8f5902;font-style:italic>             * 标签转换为 List 对象等。对于 int 类型的配置，这里并未做转换，所以 
</span><span style=color:#8f5902;font-style:italic>             * width = &#34;280&#34;，还是字符串。除了解析上面几种类型，该方法还会解析 &lt;set/&gt;、
</span><span style=color:#8f5902;font-style:italic>             * &lt;map/&gt;、&lt;array/&gt; 等集合配置
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#000>Object</span> <span style=color:#000>resolvedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>valueResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveValueIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>originalValue</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Object</span> <span style=color:#000>convertedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolvedValue</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * convertible 表示属性值是否可转换，由两个条件合成而来。第一个条件不难理解，解释
</span><span style=color:#8f5902;font-style:italic>             * 一下第二个条件。第二个条件用于检测 propertyName 是否是 nested 或者 indexed，
</span><span style=color:#8f5902;font-style:italic>             * 直接举例说明吧：
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             *   public class Room {
</span><span style=color:#8f5902;font-style:italic>             *       private Door door = new Door();
</span><span style=color:#8f5902;font-style:italic>             *   }
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             * room 对象里面包含了 door 对象，如果我们想向 door 对象中注入属性值，则可以这样配置：
</span><span style=color:#8f5902;font-style:italic>             *
</span><span style=color:#8f5902;font-style:italic>             *   &lt;bean id=&#34;room&#34; class=&#34;xyz.coolblog.Room&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>             *      &lt;property name=&#34;door.width&#34; value=&#34;123&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic>             *   &lt;/bean&gt;
</span><span style=color:#8f5902;font-style:italic>             * 
</span><span style=color:#8f5902;font-style:italic>             * isNestedOrIndexedProperty 会根据 propertyName 中是否包含 . 或 [  返回 
</span><span style=color:#8f5902;font-style:italic>             * true 和 false。包含则返回 true，否则返回 false。关于 nested 类型的属性，我
</span><span style=color:#8f5902;font-style:italic>             * 没在实践中用过，所以不知道上面举的例子是不是合理。若不合理，欢迎指正，也请多多指教。
</span><span style=color:#8f5902;font-style:italic>             * 关于 nested 类型的属性，大家还可以参考 Spring 的官方文档：
</span><span style=color:#8f5902;font-style:italic>             *     https://docs.spring.io/spring/docs/4.3.17.RELEASE/spring-framework-reference/htmlsingle/#beans-beans-conventions
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>convertible</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWritableProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>PropertyAccessorUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNestedOrIndexedProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 对于一般的属性，convertible 通常为 true
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertible</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 对属性值的类型进行转换，比如将 String 类型的属性值 &#34;123&#34; 转为 Integer 类型的 123
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>convertedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>convertForProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedValue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>converter</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 如果 originalValue 是通过 autowireByType 或 autowireByName 解析而来，
</span><span style=color:#8f5902;font-style:italic>             * 那么此处条件成立，即 (resolvedValue == originalValue) = true
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedValue</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>originalValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertible</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 将 convertedValue 设置到 pv 中，后续再次创建同一个 bean 时，就无需再次进行转换了
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConvertedValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>             * 如果原始值 originalValue 是 TypedStringValue，且转换后的值 
</span><span style=color:#8f5902;font-style:italic>             * convertedValue 不是 Collection 或数组类型，则将转换后的值存入到 pv 中。
</span><span style=color:#8f5902;font-style:italic>             */</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertible</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>originalValue</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TypedStringValue</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#ce5c00;font-weight:700>!((</span><span style=color:#000>TypedStringValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>originalValue</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isDynamic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>convertedValue</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Collection</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConvertedValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>resolveNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mpvs</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>resolveNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mpvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConverted</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 将所有的属性值设置到 bean 实例中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>deepCopy</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Error setting property values&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上就是 applyPropertyValues 方法的源码，配合着我写的注释，应该可以理解这个方法的流程。这个方法也调用了很多其他的方法，如果大家跟下去的话，会发现这些方法的调用栈也是很深的，比较复杂。这里说一下 bw.setPropertyValues 这个方法，如果大家跟到这个方法的调用栈的最底部，会发现这个方法是通过调用对象的 setter 方法进行属性设置的。这里贴一下简化后的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanWrapperImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractNestablePropertyAccessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanWrapper</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略部分代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanPropertyHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PropertyHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>valueToApply</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 writeMethod，也就是 setter 方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Method</span> <span style=color:#000>writeMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWriteMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAccessible</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>valueToApply</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 调用 setter 方法，getWrappedInstance() 返回的是 bean 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>writeMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>好了，本节的最后来总结一下 applyPropertyValues 方法的执行流程吧，如下：</p>
<ol>
<li>检测属性值列表是否已转换过的，若转换过，则直接填充属性，无需再次转换</li>
<li>遍历属性值列表 pvs，解析原始值 originalValue，得到解析值 resolvedValue</li>
<li>对解析后的属性值 resolvedValue 进行类型转换</li>
<li>将类型转换后的属性值设置到 PropertyValue 对象中，并将 PropertyValue 对象存入 deepCopy 集合中</li>
<li>将 deepCopy 中的属性信息注入到 bean 对象中</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-af78074eb9a0b37dec4c27ffbf65a82b>6 - CH06-后续初始化工作</h1>
<h2 id=initializebean>initializeBean</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 若 bean 实现了 BeanNameAware、BeanFactoryAware、BeanClassLoaderAware 等接口，则向 bean 中注入相关对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Object</span> <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 执行 bean 初始化前置操作
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 调用初始化方法：
</span><span style=color:#8f5902;font-style:italic>         * 1. 若 bean 实现了 InitializingBean 接口，则调用 afterPropertiesSet 方法
</span><span style=color:#8f5902;font-style:italic>         * 2. 若用户配置了 bean 的 init-method 属性，则调用用户在配置中指定的方法
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
                <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invocation of init method failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 执行 bean 初始化后置操作，AOP 会在此处向目标对象中织入切面逻辑
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上就是 initializeBean 方法的逻辑，很简单是不是。该方法做了如下几件事情：</p>
<ol>
<li>检测 bean 是否实现了 *Aware 类型接口，若实现，则向 bean 中注入相应的对象</li>
<li>执行 bean 初始化前置操作</li>
<li>执行初始化操作</li>
<li>执行 bean 初始化后置操作</li>
</ol>
<p>在上面的流程中，我们又发现了后置处理器的踪影。如果大家阅读过 Spring 的源码，会发现后置处理器在 Spring 源码中多次出现过。后置处理器是 Spring 拓展点之一，通过实现后置处理器 BeanPostProcessor 接口，我们就可以插手 bean 的初始化过程。比如大家所熟悉的 AOP 就是在后置处理 postProcessAfterInitialization 方法中向目标对象中织如切面逻辑的。关于“前置处理”和“后置处理”相关的源码，这里就不分析了，大家有兴趣自己去看一下。接下来分析一下 invokeAwareMethods 和 invokeInitMethods 方法，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Aware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanNameAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注入 beanName 字符串
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanNameAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注入 ClassLoader 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanFactoryAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注入 BeanFactory 对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>BeanFactoryAware</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractAutowireCapableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>invokeAwareMethods 方法的逻辑很简单，一句话总结：根据 bean 所实现的 Aware 的类型，向 bean 中注入不同类型的对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 检测 bean 是否是 InitializingBean 类型的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isInitializingBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isInitializingBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isExternallyManagedInitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;afterPropertiesSet&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Invoking afterPropertiesSet() on bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PrivilegedActionException</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>pae</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 如果 bean 实现了 InitializingBean，则调用 afterPropertiesSet 方法执行初始化逻辑
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>initMethodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInitMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initMethodName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>isInitializingBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>&#34;afterPropertiesSet&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initMethodName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isExternallyManagedInitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initMethodName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 调用用户自定义的初始化方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>invokeCustomInitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-df482e7d67cbcb67a71beecf0e6e8c46>7 - CH07-生命周期扩展</h1>
<p>Spring的核心思想就是容器，当容器refresh的时候，外部看上去风平浪静，其实内部则是一片惊涛骇浪，汪洋一片。Springboot更是封装了Spring，遵循约定大于配置，加上自动装配的机制。很多时候我们只要引用了一个依赖，几乎是零配置就能完成一个功能的装配。</p>
<p>我非常喜欢这种自动装配的机制，所以在自己开发中间件和公共依赖工具的时候也会用到这个特性。让使用者以最小的代价接入。想要把自动装配玩的转，就必须要了解spring对于bean的构造生命周期以及各个扩展接口。当然了解了bean的各个生命周期也能促进我们加深对spring的理解。业务代码也能合理利用这些扩展点写出更加漂亮的代码。</p>
<h2 id=0-扩展点调用顺序图>0. 扩展点调用顺序图</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011232128.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=1-applicationcontextinitializer>1. ApplicationContextInitializer</h2>
<blockquote>
<p>org.springframework.context.ApplicationContextInitializer</p>
</blockquote>
<p>这是整个spring容器在刷新之前初始化<code>ConfigurableApplicationContext</code>的回调接口，简单来说，就是在容器刷新之前调用此类的<code>initialize</code>方法。这个点允许被用户自己扩展。用户可以在整个spring容器还没被初始化之前做一些事情。</p>
<p>可以想到的场景可能为，在最开始激活一些配置，或者利用这时候 class 还没被类加载器加载的时机，进行动态字节码注入等操作。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestApplicationContextInitializer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationContextInitializer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[ApplicationContextInitializer]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为这时候spring容器还没被初始化，所以想要自己的扩展的生效，有以下三种方式：</p>
<ul>
<li>在启动类中用<code>springApplication.addInitializers(new TestApplicationContextInitializer())</code>语句加入</li>
<li>配置文件配置<code>context.initializer.classes=com.example.demo.TestApplicationContextInitializer</code></li>
<li>Spring SPI扩展，在spring.factories中加入<code>org.springframework.context.ApplicationContextInitializer=com.example.demo.TestApplicationContextInitializer</code></li>
</ul>
<h2 id=2-beandefinitionregistrypostprocessor>2. BeanDefinitionRegistryPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor</p>
</blockquote>
<p>这个接口在读取项目中的<code>beanDefinition</code>之后执行，提供一个补充的扩展点</p>
<p>使用场景：你可以在这里动态注册自己的<code>beanDefinition</code>，可以加载classpath之外的bean</p>
<p>扩展方式为:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestBeanDefinitionRegistryPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanDefinitionRegistryPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanDefinitionRegistryPostProcessor] postProcessBeanDefinitionRegistry&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanDefinitionRegistryPostProcessor] postProcessBeanFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=3-beanfactorypostprocessor>3. BeanFactoryPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.config.BeanFactoryPostProcessor</p>
</blockquote>
<p>这个接口是<code>beanFactory</code>的扩展接口，调用时机在spring在读取<code>beanDefinition</code>信息之后，实例化bean之前。</p>
<p>在这个时机，用户可以通过实现这个扩展接口来自行处理一些东西，比如修改已经注册的<code>beanDefinition</code>的元信息。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestBeanFactoryPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanFactoryPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanFactoryPostProcessor]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=4-instantiationawarebeanpostprocessor>4. InstantiationAwareBeanPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor</p>
</blockquote>
<p>该接口继承了<code>BeanPostProcess</code>接口，区别如下：</p>
<p><font color=red><strong><code>BeanPostProcess</code>接口只在bean的初始化阶段进行扩展（注入spring上下文前后），而<code>InstantiationAwareBeanPostProcessor</code>接口在此基础上增加了3个方法，把可扩展的范围增加了实例化阶段和属性注入阶段。</strong></font></p>
<p>该类主要的扩展点有以下5个方法，主要在bean生命周期的两大阶段：<font color=red><strong>实例化阶段</strong></font>和<font color=red><strong>初始化阶段</strong></font>，下面一起进行说明，按调用顺序为：</p>
<ul>
<li><code>postProcessBeforeInstantiation</code>：实例化bean之前，相当于new这个bean之前</li>
<li><code>postProcessAfterInstantiation</code>：实例化bean之后，相当于new这个bean之后</li>
<li><code>postProcessPropertyValues</code>：bean已经实例化完成，在属性注入时阶段触发，<code>@Autowired</code>,<code>@Resource</code>等注解原理基于此方法实现</li>
<li><code>postProcessBeforeInitialization</code>：初始化bean之前，相当于把bean注入spring上下文之前</li>
<li><code>postProcessAfterInitialization</code>：初始化bean之后，相当于把bean注入spring上下文之后</li>
</ul>
<p>使用场景：这个扩展点非常有用 ，无论是写中间件和业务中，都能利用这个特性。比如对实现了某一类接口的bean在各个生命期间进行收集，或者对某个类型的bean进行统一的设值等等。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestInstantiationAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] before initialization &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] after initialization &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] before instantiation &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] after instantiation &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyValues</span> <span style=color:#000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>pds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestInstantiationAwareBeanPostProcessor] postProcessPropertyValues &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=5-smartinstantiationawarebeanpostprocessor>5. SmartInstantiationAwareBeanPostProcessor</h2>
<blockquote>
<p>org.springframework.beans.factory.config.SmartInstantiationAwareBeanPostProcessor</p>
</blockquote>
<p>该扩展接口有3个触发点方法：</p>
<ul>
<li><code>predictBeanType</code>：该触发点发生在<code>postProcessBeforeInstantiation</code>之前(在图上并没有标明，因为一般不太需要扩展这个点)，这个方法用于预测Bean的类型，返回第一个预测成功的Class类型，如果不能预测返回null；当你调用<code>BeanFactory.getType(name)</code>时当通过bean的名字无法得到bean类型信息时就调用该回调方法来决定类型信息。</li>
<li><code>determineCandidateConstructors</code>：该触发点发生在<code>postProcessBeforeInstantiation</code>之后，用于确定该bean的构造函数之用，返回的是该bean的所有构造函数列表。用户可以扩展这个点，来自定义选择相应的构造器来实例化这个bean。</li>
<li><code>getEarlyBeanReference</code>：该触发点发生在<code>postProcessAfterInstantiation</code>之后，当有循环依赖的场景，当bean实例化好之后，为了防止有循环依赖，会提前暴露回调方法，用于bean实例化的后置处理。这个方法就是在提前暴露的回调方法中触发。</li>
</ul>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestSmartInstantiationAwareBeanPostProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>predictBeanType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInstantiationAwareBeanPostProcessor] predictBeanType &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>determineCandidateConstructors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInstantiationAwareBeanPostProcessor] determineCandidateConstructors &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInstantiationAwareBeanPostProcessor] getEarlyBeanReference &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=6-beanfactoryaware>6. BeanFactoryAware</h2>
<blockquote>
<p>org.springframework.beans.factory.BeanFactoryAware</p>
</blockquote>
<p>这个类只有一个触发点，发生在bean的实例化之后，注入属性之前，也就是Setter之前。这个类的扩展点方法为<code>setBeanFactory</code>，可以拿到<code>BeanFactory</code>这个属性。</p>
<p>使用场景为，你可以在bean实例化之后，但还未初始化之前，拿到 <code>BeanFactory</code>，在这个时候，可以对每个bean作特殊化的定制。也或者可以把<code>BeanFactory</code>拿到进行缓存，日后使用。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestBeanFactoryAware</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestBeanFactoryAware] &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TestBeanFactoryAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=7-applicationcontextawareprocessor>7. ApplicationContextAwareProcessor</h2>
<blockquote>
<p>org.springframework.context.support.ApplicationContextAwareProcessor</p>
</blockquote>
<p>该类本身并没有扩展点，但是该类内部却有6个扩展点可供实现 ，这些类触发的时机在bean实例化之后，初始化之前：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011232824.png style=display:block;width:80% alt=NAME align=center> </div>
<p>可以看到，该类用于执行各种驱动接口，在bean实例化之后，属性填充之后，通过执行以上红框标出的扩展接口，来获取对应容器的变量。<strong>所以这里应该来说是有6个扩展点</strong>，这里就放一起来说了</p>
<ul>
<li><code>EnvironmentAware</code>：用于获取<code>EnviromentAware</code>的一个扩展类，这个变量非常有用， 可以获得系统内的所有参数。当然个人认为这个Aware没必要去扩展，因为spring内部都可以通过注入的方式来直接获得。</li>
<li><code>EmbeddedValueResolverAware</code>：用于获取<code>StringValueResolver</code>的一个扩展类， <code>StringValueResolver</code>用于获取基于<code>String</code>类型的properties的变量，一般我们都用<code>@Value</code>的方式去获取，如果实现了这个Aware接口，把<code>StringValueResolver</code>缓存起来，通过这个类去获取<code>String</code>类型的变量，效果是一样的。</li>
<li><code>ResourceLoaderAware</code>：用于获取<code>ResourceLoader</code>的一个扩展类，<code>ResourceLoader</code>可以用于获取classpath内所有的资源对象，可以扩展此类来拿到<code>ResourceLoader</code>对象。</li>
<li><code>ApplicationEventPublisherAware</code>：用于获取<code>ApplicationEventPublisher</code>的一个扩展类，<code>ApplicationEventPublisher</code>可以用来发布事件，结合<code>ApplicationListener</code>来共同使用，下文在介绍<code>ApplicationListener</code>时会详细提到。这个对象也可以通过spring注入的方式来获得。</li>
<li><code>MessageSourceAware</code>：用于获取<code>MessageSource</code>的一个扩展类，<code>MessageSource</code>主要用来做国际化。</li>
<li><code>ApplicationContextAware</code>：用来获取<code>ApplicationContext</code>的一个扩展类，<code>ApplicationContext</code>应该是很多人非常熟悉的一个类了，就是spring上下文管理器，可以手动的获取任何在spring上下文注册的bean，我们经常扩展这个接口来缓存spring上下文，包装成静态方法。同时<code>ApplicationContext</code>也实现了<code>BeanFactory</code>，<code>MessageSource</code>，<code>ApplicationEventPublisher</code>等接口，也可以用来做相关接口的事情。</li>
</ul>
<h2 id=8-beannameaware>8. BeanNameAware</h2>
<blockquote>
<p>org.springframework.beans.factory.BeanNameAware</p>
</blockquote>
<p>可以看到，这个类也是Aware扩展的一种，触发点在bean的初始化之前，也就是<code>postProcessBeforeInitialization</code>之前，这个类的触发点方法只有一个：<code>setBeanName</code></p>
<p>使用场景为：用户可以扩展这个点，在初始化bean之前拿到spring容器中注册的的beanName，来自行修改这个beanName的值。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanNameAware</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>NormalBeanA</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;NormalBean constructor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[BeanNameAware] &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=9-postconstruct>9. @PostConstruct</h2>
<blockquote>
<p>javax.annotation.PostConstruct</p>
</blockquote>
<p>这个并不算一个扩展点，其实就是一个标注。其作用是在bean的初始化阶段，如果对一个方法标注了<code>@PostConstruct</code>，会先调用这个方法。这里重点是要关注下这个标准的触发点，这个触发点是在<code>postProcessBeforeInitialization</code>之后，<code>InitializingBean.afterPropertiesSet</code>之前。</p>
<p>使用场景：用户可以对某一方法进行标注，来进行初始化某一个属性</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>NormalBeanA</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;NormalBean constructor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@PostConstruct</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[PostConstruct] NormalBeanA&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=10-initializingbean>10. InitializingBean</h2>
<blockquote>
<p>org.springframework.beans.factory.InitializingBean</p>
</blockquote>
<p>这个类，顾名思义，也是用来初始化bean的。<code>InitializingBean</code>接口为bean提供了初始化方法的方式，它只包括<code>afterPropertiesSet</code>方法，凡是继承该接口的类，在初始化bean的时候都会执行该方法。这个扩展点的触发时机在<code>postProcessAfterInitialization</code>之前。</p>
<p>使用场景：用户实现此接口，来进行系统启动的时候一些业务指标的初始化工作。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InitializingBean</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[InitializingBean] NormalBeanA&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=11-factorybean>11. FactoryBean</h2>
<blockquote>
<p>org.springframework.beans.factory.FactoryBean</p>
</blockquote>
<p>一般情况下，Spring通过反射机制利用bean的class属性指定支线类去实例化bean，在某些情况下，实例化Bean过程比较复杂，如果按照传统的方式，则需要在bean中提供大量的配置信息。配置方式的灵活性是受限的，这时采用编码的方式可能会得到一个简单的方案。Spring为此提供了一个<code>org.springframework.bean.factory.FactoryBean</code>的工厂类接口，用户可以通过实现该接口定制实例化Bean的逻辑。<code>FactoryBean</code>接口对于Spring框架来说占用重要的地位，Spring自身就提供了70多个<code>FactoryBean</code>的实现。它们隐藏了实例化一些复杂bean的细节，给上层应用带来了便利。从Spring3.0开始，<code>FactoryBean</code>开始支持泛型，即接口声明改为<code>FactoryBean&lt;T></code>的形式</p>
<p>使用场景：用户可以扩展这个类，来为要实例化的bean作一个代理，比如为该对象的所有的方法作一个拦截，在调用前后输出一行log，模仿<code>ProxyFactoryBean</code>的功能。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestFactoryBean</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[FactoryBean] getObject&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getObjectType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>TestFactoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestFactoryInnerBean</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=12-smartinitializingsingleton>12. SmartInitializingSingleton</h2>
<blockquote>
<p>org.springframework.beans.factory.SmartInitializingSingleton</p>
</blockquote>
<p>这个接口中只有一个方法<code>afterSingletonsInstantiated</code>，其作用是是 在spring容器管理的所有单例对象（非懒加载对象）初始化完成之后调用的回调接口。其触发时机为<code>postProcessAfterInitialization</code>之后。</p>
<p>使用场景：用户可以扩展此接口在对所有单例对象初始化完毕后，做一些后置的业务处理。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestSmartInitializingSingleton</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SmartInitializingSingleton</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestSmartInitializingSingleton]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=13-commandlinerunner>13. CommandLineRunner</h2>
<blockquote>
<p>org.springframework.boot.CommandLineRunner</p>
</blockquote>
<p>这个接口也只有一个方法：<code>run(String... args)</code>，触发时机为整个项目启动完毕后，自动执行。如果有多个<code>CommandLineRunner</code>，可以利用<code>@Order</code>来进行排序。</p>
<p>使用场景：用户扩展此接口，进行启动项目之后一些业务的预处理。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestCommandLineRunner</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>CommandLineRunner</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[TestCommandLineRunner]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=14-disposablebean>14. DisposableBean</h2>
<blockquote>
<p>org.springframework.beans.factory.DisposableBean</p>
</blockquote>
<p>这个扩展点也只有一个方法：<code>destroy()</code>，其触发时机为当此对象销毁时，会自动执行这个方法。比如说运行<code>applicationContext.registerShutdownHook</code>时，就会触发这个方法。</p>
<p>扩展方式为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NormalBeanA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>DisposableBean</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[DisposableBean] NormalBeanA&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=15-applicationlistener>15. ApplicationListener</h2>
<blockquote>
<p>org.springframework.context.ApplicationListener</p>
</blockquote>
<p>准确的说，这个应该不算spring&springboot当中的一个扩展点，<code>ApplicationListener</code>可以监听某个事件的<code>event</code>，触发时机可以穿插在业务方法执行过程中，用户可以自定义某个业务事件。但是spring内部也有一些内置事件，这种事件，可以穿插在启动调用中。我们也可以利用这个特性，来自己做一些内置事件的监听器来达到和前面一些触发点大致相同的事情。</p>
<p>接下来罗列下spring主要的内置事件：</p>
<ul>
<li>
<p>ContextRefreshedEvent</p>
<p>ApplicationContext 被初始化或刷新时，该事件被发布。这也可以在<code> ConfigurableApplicationContext</code>接口中使用 <code>refresh() </code>方法来发生。此处的初始化是指：所有的Bean被成功装载，后处理Bean被检测并激活，所有Singleton Bean 被预实例化，<code>ApplicationContext</code>容器已就绪可用。</p>
</li>
<li>
<p>ContextStartedEvent</p>
<p>当使用 <code>ConfigurableApplicationContext</code> （ApplicationContext子接口）接口中的 start() 方法启动 <code>ApplicationContext </code>时，该事件被发布。你可以调查你的数据库，或者你可以在接受到这个事件后重启任何停止的应用程序。</p>
</li>
<li>
<p>ContextStoppedEvent</p>
<p>当使用 <code>ConfigurableApplicationContext </code>接口中的 <code>stop() </code>停止<code> ApplicationContext</code> 时，发布这个事件。你可以在接受到这个事件后做必要的清理的工作</p>
</li>
<li>
<p>ContextClosedEvent</p>
<p>当使用 <code>ConfigurableApplicationContext</code>接口中的 <code>close()</code>方法关闭 <code>ApplicationContext</code> 时，该事件被发布。一个已关闭的上下文到达生命周期末端；它不能被刷新或重启</p>
</li>
<li>
<p>RequestHandledEvent</p>
<p>这是一个 web-specific 事件，告诉所有 bean HTTP 请求已经被服务。只能应用于使用DispatcherServlet的Web应用。在使用Spring作为前端的MVC控制器时，当Spring处理用户请求结束后，系统会自动触发该事件</p>
</li>
</ul>
<h2 id=总结>总结</h2>
<p>我们从这些spring&springboot的扩展点当中，大致可以窥视到整个bean的生命周期。在业务开发或者写中间件业务的时候，可以合理利用spring提供给我们的扩展点，在spring启动的各个阶段内做一些事情。以达到自定义初始化的目的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b51917ad9041bab714580f7b22d13d9b>8 - CH08-控制加载顺序</h1>
<p><code>springboot</code>遵从约定大于配置的原则，极大程度的解决了配置繁琐的问题。在此基础上，又提供了spi机制，用<code>spring.factories</code>可以完成一个小组件的自动装配功能。</p>
<p>在一般业务场景，可能你不大关心一个bean是如何被注册进spring容器的。只需要把需要注册进容器的bean声明为<code>@Component</code>即可，spring会自动扫描到这个Bean完成初始化并加载到spring上下文容器。</p>
<p>而当你在项目启动时需要提前做一个业务的初始化工作时，或者你正在开发某个中间件需要完成自动装配时。你会声明自己的Configuration类，但是可能你面对的是好几个有互相依赖的Bean。如果不加以控制，这时候可能会报找不到依赖的错误。</p>
<p>但是你明明已经把相关的Bean都注册进spring上下文了呀。这时候你需要通过一些手段来控制springboot中的bean加载顺序。</p>
<h2 id=几个误区>几个误区</h2>
<p>在正式说如何控制加载顺序之前，先说2个误区。</p>
<p><strong>在标注了<code>@Configuration</code>的类中，写在前面的@Bean一定会被先注册</strong></p>
<p>这个不存在的，spring在以前xml的时代，也不存在写在前面一定会被先加载的逻辑。因为xml不是渐进的加载，而是全部parse好，再进行依赖分析和注册。到了springboot中，只是省去了xml被parse成spring内部对象的这一过程，但是加载方式并没有大的改变。</p>
<p><strong>利用<code>@Order</code>这个标注能进行加载顺序的控制</strong></p>
<p>严格的说，不是所有的Bean都可以通过<code>@Order</code>这个标注进行顺序的控制。你把<code>@Order</code>这个标注加在普通的方法上或者类上一点鸟用都没有。</p>
<p>那<code>@Order</code>能控制哪些bean的加载顺序呢，我们先看看官方的解释：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>{@code @Order} defines the sort order for an annotated component. Since Spring 4.0, annotation-based ordering is supported for many kinds of components in Spring, even for collection injection where the order values of the target components are taken into account (either from their target class or from their {@code @Bean} method). While such order values may influence priorities at injection points, please be aware that they do not influence singleton startup order which is an orthogonal concern determined by dependency relationships and {@code @DependsOn} declarations (influencing a runtime-determined dependency graph).
</code></pre></div><p>最开始<code>@Order</code>注解用于切面的优先级指定；在 4.0 之后对它的功能进行了增强，支持集合的注入时，指定集合中 bean 的顺序，并且特别指出了，它对于但实例的 bean 之间的顺序，没有任何影响。</p>
<p>目前用的比较多的有以下3点：</p>
<ul>
<li>控制AOP的类的加载顺序，也就是被<code>@Aspect</code>标注的类</li>
<li>控制<code>ApplicationListener</code>实现类的加载顺序</li>
<li>控制<code>CommandLineRunner</code>实现类的加载顺序</li>
</ul>
<h2 id=控制方法>控制方法</h2>
<h3 id=dependson>@DependsOn</h3>
<p><code>@DependsOn</code>注解可以用来控制bean的创建顺序，该注解用于声明当前bean依赖于另外一个bean。所依赖的bean会被容器确保在当前bean实例化之前被实例化。</p>
<p>示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@DependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@DependsOn</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;beanD&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;beanE&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanC</span> <span style=color:#000>beanC</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean C init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanC</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@DependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beanE&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanD</span> <span style=color:#000>beanD</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean D init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanD</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanE</span> <span style=color:#000>beanE</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean E init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanE</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上代码bean的加载顺序为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>bean B init
bean A init
bean E init
bean D init
bean C init
</code></pre></div><p><code>@DependsOn</code>的使用：</p>
<ul>
<li>直接或者间接标注在带有<code>@Component</code>注解的类上面;</li>
<li>直接或者间接标注在带有<code>@Bean</code>注解的方法上面;</li>
<li>使用<code>@DependsOn</code>注解到类层面仅仅在使用 component-scanning 方式时才有效，如果带有<code>@DependsOn</code>注解的类通过XML方式使用，该注解会被忽略，<code>&lt;bean depends-on="..."/></code>这种方式会生效。</li>
</ul>
<h3 id=参数注入>参数注入</h3>
<p>在<code>@Bean</code>标注的方法上，如果你传入了参数，springboot会自动会为这个参数在spring上下文里寻找这个类型的引用。并先初始化这个类的实例。</p>
<p>利用此特性，我们也可以控制bean的加载顺序。</p>
<p>示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Bean</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanB</span> <span style=color:#000>demoB</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Bean</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上结果，beanB先于beanA被初始化加载。</p>
<p>需要注意的是，springboot会按类型去寻找。如果这个类型有多个实例被注册到spring上下文，那你就需要加上<code>@Qualifier("Bean的名称")</code>来指定</p>
<h3 id=生命周期中的扩展点>生命周期中的扩展点</h3>
<p>在spring体系中，从容器到Bean实例化&初始化都是有生命周期的，并且提供了很多的扩展点，允许你在这些步骤时进行逻辑的扩展。</p>
<p>这些可扩展点的加载顺序由spring自己控制，大多数是无法进行干预的。我们可以利用这一点，扩展spring的扩展点。在相应的扩展点加入自己的业务初始化代码。从来达到顺序的控制。</p>
<h3 id=autoconfigureorder>@AutoConfigureOrder</h3>
<p>这个注解用来指定配置文件的加载顺序。但是在实际测试中发现，以下这样使用是不生效的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration1</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration2</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>无论你2个数字填多少，都不会改变其加载顺序结果。</p>
<p>那这个<code>@AutoConfigureOrder</code>到底是如何使用的呢。</p>
<p>经过测试发现，<code>@AutoConfigureOrder</code>只能改变外部依赖的<code>@Configuration</code>的顺序。如何理解是外部依赖呢。</p>
<p>能被你工程内部scan到的包，都是内部的Configuration，而spring引入外部的Configuration，都是通过spring特有的spi文件：<code>spring.factories</code></p>
<p><strong>换句话说，<code>@AutoConfigureOrder</code>能改变<code>spring.factories</code>中的<code>@Configuration</code>的顺序。</strong></p>
<p>具体使用方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration1</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean A init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanA</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@AutoConfigureOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanOrderConfiguration2</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bean B init&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanB</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>spring.factories</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-stylus data-lang=stylus><span style=color:#a40000>org</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>springframework</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>boot</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>autoconfigure</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>EnableAutoConfiguration</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#a40000>\</span>
  <span style=color:#a40000>com</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>demo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BeanOrderConfiguration1</span><span style=color:#000;font-weight:700>,</span><span style=color:#a40000>\</span>
  <span style=color:#a40000>com</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>demo</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BeanOrderConfiguration2</span>
</code></pre></div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>