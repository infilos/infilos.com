<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.100.2"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>CH17-监听器 | infilos.com</title><meta property="og:title" content="CH17-监听器"><meta property="og:description" content="观察者模式 在讲解事件监听机制前,我们先回顾下设计模式中的观察者模式,因为事件监听机制可以说是在典型观察者模式基础上的进一步抽象和改进。我们可以在JDK或者各种开源框架比如Spring中看到它的身影,从这个意义上说,事件监听机制也可以看做一种对传统观察者模式的具体实现,不同的框架对其实现方式会有些许差别。
典型的观察者模式将有依赖关系的对象抽象为了观察者和主题两个不同的角色,多个观察者同时观察一个主题,两者只通过抽象接口保持松耦合状态,这样双方可以相对独立的进行扩展和变化:比如可以很方便的增删观察者,修改观察者中的更新逻辑而不用修改主题中的代码。但是这种解耦进行的并不彻底,这具体体现在以下几个方面:
1.抽象主题需要依赖抽象观察者,而这种依赖关系完全可以去除。 2.主题需要维护观察者列表,并对外提供动态增删观察者的接口, 3.主题状态改变时需要由自己去通知观察者进行更新。 我们可以把主题(Subject)替换成事件(event),把对特定主题进行观察的观察者(Observer)替换成对特定事件进行监听的监听器(EventListener),而把原有主题中负责维护主题与观察者映射关系以及在自身状态改变时通知观察者的职责从中抽出,放入一个新的角色事件发布器(EventPublisher)中,事件监听模式的轮廓就展现在了我们眼前,如下图所示
常见事件监听机制的主要角色如下
事件及事件源:对应于观察者模式中的主题。事件源发生某事件是特定事件监听器被触发的原因。 事件监听器:对应于观察者模式中的观察者。监听器监听特定事件,并在内部定义了事件发生后的响应逻辑。 事件发布器:事件监听器的容器,对外提供发布事件和增删事件监听器的接口,维护事件和事件监听器之间的映射关系,并在事件发生时负责通知相关监听器。 Spring框架对事件的发布与监听提供了相对完整的支持,它扩展了JDK中对自定义事件监听提供的基础框架,并与Spring的IOC特性作了整合,使得用户可以根据自己的业务特点进行相关的自定义,并依托Spring容器方便的实现监听器的注册和事件的发布。因为Spring的事件监听依托于JDK提供的底层支持,为了更好的理解,先来看下JDK中为用户实现自定义事件监听提供的基础框架。
JDK中对事件监听机制的支持 JDK为用户实现自定义事件监听提供了两个基础的类。一个是代表所有可被监听事件的事件基类java.util.EventObject,所有自定义事件类型都必须继承该类,类结构如下所示
public class EventObject implements java.io.Serializable { private static final long serialVersionUID = 5516075349620653480L; /** * The object on which the Event initially occurred. */ protected transient Object source; /** * Constructs a prototypical Event. * * @param source The object on which the Event initially occurred. * @exception IllegalArgumentException if source is null. */ public EventObject(Object source) { if (source == null) throw new IllegalArgumentException(&#34;null source&#34;); this."><meta property="og:type" content="article"><meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch17/"><meta property="article:section" content="框架与库"><meta property="og:site_name" content="infilos.com"><meta itemprop=name content="CH17-监听器"><meta itemprop=description content="观察者模式 在讲解事件监听机制前,我们先回顾下设计模式中的观察者模式,因为事件监听机制可以说是在典型观察者模式基础上的进一步抽象和改进。我们可以在JDK或者各种开源框架比如Spring中看到它的身影,从这个意义上说,事件监听机制也可以看做一种对传统观察者模式的具体实现,不同的框架对其实现方式会有些许差别。
典型的观察者模式将有依赖关系的对象抽象为了观察者和主题两个不同的角色,多个观察者同时观察一个主题,两者只通过抽象接口保持松耦合状态,这样双方可以相对独立的进行扩展和变化:比如可以很方便的增删观察者,修改观察者中的更新逻辑而不用修改主题中的代码。但是这种解耦进行的并不彻底,这具体体现在以下几个方面:
1.抽象主题需要依赖抽象观察者,而这种依赖关系完全可以去除。 2.主题需要维护观察者列表,并对外提供动态增删观察者的接口, 3.主题状态改变时需要由自己去通知观察者进行更新。 我们可以把主题(Subject)替换成事件(event),把对特定主题进行观察的观察者(Observer)替换成对特定事件进行监听的监听器(EventListener),而把原有主题中负责维护主题与观察者映射关系以及在自身状态改变时通知观察者的职责从中抽出,放入一个新的角色事件发布器(EventPublisher)中,事件监听模式的轮廓就展现在了我们眼前,如下图所示
常见事件监听机制的主要角色如下
事件及事件源:对应于观察者模式中的主题。事件源发生某事件是特定事件监听器被触发的原因。 事件监听器:对应于观察者模式中的观察者。监听器监听特定事件,并在内部定义了事件发生后的响应逻辑。 事件发布器:事件监听器的容器,对外提供发布事件和增删事件监听器的接口,维护事件和事件监听器之间的映射关系,并在事件发生时负责通知相关监听器。 Spring框架对事件的发布与监听提供了相对完整的支持,它扩展了JDK中对自定义事件监听提供的基础框架,并与Spring的IOC特性作了整合,使得用户可以根据自己的业务特点进行相关的自定义,并依托Spring容器方便的实现监听器的注册和事件的发布。因为Spring的事件监听依托于JDK提供的底层支持,为了更好的理解,先来看下JDK中为用户实现自定义事件监听提供的基础框架。
JDK中对事件监听机制的支持 JDK为用户实现自定义事件监听提供了两个基础的类。一个是代表所有可被监听事件的事件基类java.util.EventObject,所有自定义事件类型都必须继承该类,类结构如下所示
public class EventObject implements java.io.Serializable { private static final long serialVersionUID = 5516075349620653480L; /** * The object on which the Event initially occurred. */ protected transient Object source; /** * Constructs a prototypical Event. * * @param source The object on which the Event initially occurred. * @exception IllegalArgumentException if source is null. */ public EventObject(Object source) { if (source == null) throw new IllegalArgumentException(&#34;null source&#34;); this."><meta itemprop=wordCount content="1494"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="CH17-监听器"><meta name=twitter:description content="观察者模式 在讲解事件监听机制前,我们先回顾下设计模式中的观察者模式,因为事件监听机制可以说是在典型观察者模式基础上的进一步抽象和改进。我们可以在JDK或者各种开源框架比如Spring中看到它的身影,从这个意义上说,事件监听机制也可以看做一种对传统观察者模式的具体实现,不同的框架对其实现方式会有些许差别。
典型的观察者模式将有依赖关系的对象抽象为了观察者和主题两个不同的角色,多个观察者同时观察一个主题,两者只通过抽象接口保持松耦合状态,这样双方可以相对独立的进行扩展和变化:比如可以很方便的增删观察者,修改观察者中的更新逻辑而不用修改主题中的代码。但是这种解耦进行的并不彻底,这具体体现在以下几个方面:
1.抽象主题需要依赖抽象观察者,而这种依赖关系完全可以去除。 2.主题需要维护观察者列表,并对外提供动态增删观察者的接口, 3.主题状态改变时需要由自己去通知观察者进行更新。 我们可以把主题(Subject)替换成事件(event),把对特定主题进行观察的观察者(Observer)替换成对特定事件进行监听的监听器(EventListener),而把原有主题中负责维护主题与观察者映射关系以及在自身状态改变时通知观察者的职责从中抽出,放入一个新的角色事件发布器(EventPublisher)中,事件监听模式的轮廓就展现在了我们眼前,如下图所示
常见事件监听机制的主要角色如下
事件及事件源:对应于观察者模式中的主题。事件源发生某事件是特定事件监听器被触发的原因。 事件监听器:对应于观察者模式中的观察者。监听器监听特定事件,并在内部定义了事件发生后的响应逻辑。 事件发布器:事件监听器的容器,对外提供发布事件和增删事件监听器的接口,维护事件和事件监听器之间的映射关系,并在事件发生时负责通知相关监听器。 Spring框架对事件的发布与监听提供了相对完整的支持,它扩展了JDK中对自定义事件监听提供的基础框架,并与Spring的IOC特性作了整合,使得用户可以根据自己的业务特点进行相关的自定义,并依托Spring容器方便的实现监听器的注册和事件的发布。因为Spring的事件监听依托于JDK提供的底层支持,为了更好的理解,先来看下JDK中为用户实现自定义事件监听提供的基础框架。
JDK中对事件监听机制的支持 JDK为用户实现自定义事件监听提供了两个基础的类。一个是代表所有可被监听事件的事件基类java.util.EventObject,所有自定义事件类型都必须继承该类,类结构如下所示
public class EventObject implements java.io.Serializable { private static final long serialVersionUID = 5516075349620653480L; /** * The object on which the Event initially occurred. */ protected transient Object source; /** * Constructs a prototypical Event. * * @param source The object on which the Event initially occurred. * @exception IllegalArgumentException if source is null. */ public EventObject(Object source) { if (source == null) throw new IllegalArgumentException(&#34;null source&#34;); this."><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style><link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity><script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand-lg navbar-dark td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item style=max-width:90px;min-width:10px><a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86><span>基础</span></a></li><li class=nav-item style=max-width:90px;min-width:10px><a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80><span>语言</span></a></li><li class=nav-item style=max-width:90px;min-width:10px><a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93><span>框架库</span></a></li><li class="nav-item dropdown" style=max-width:90px;min-width:10px><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>分布式
<span>+</span></a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a></div></li><li class="nav-item dropdown" style=max-width:90px;min-width:10px><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>大数据
<span>+</span></a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a></div></li><li class="nav-item dropdown" style=max-width:90px;min-width:10px><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中后台
<span>+</span></a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a></div></li><li class=nav-item style=max-width:90px;min-width:10px><a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84><span>模式架构</span></a></li><li class=nav-item style=max-width:90px;min-width:10px><a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94><span>面试</span></a></li><li class=nav-item style=max-width:90px;min-width:10px><a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84><span>管理</span></a></li><li class=nav-item style=max-width:90px;min-width:10px><a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae><span>开源</span></a></li></ul><div class="form-inline my-2 my-lg-0"><div class="nav-item nav-search-item my-2 my-md-0"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-e6a186e69eb6e4b88ee5ba93><span>框架库</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93spring-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring><span>Spring</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch01-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc><span>CH01-IOC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch02-springioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc><span>CH02-Spring IOC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch03-bean%E5%8A%A0%E8%BD%BD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd><span>CH03-Bean加载</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch04-ioc%E6%BA%90%E7%A0%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081><span>CH04-IOC源码</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch05-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596><span>CH05-循环依赖</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch07-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch07><span>CH07-动态代理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch08-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch08><span>CH08-定义接口</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch09-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch09><span>CH09-请求过程</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch10-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch10><span>CH10-配置注入</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch11-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch11><span>CH11-配置绑定</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch12-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch12><span>CH12-环境变量</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch13-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch13><span>CH13-事务原理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch14-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch14><span>CH14-定义 Bean</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch15-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch15><span>CH15-注入 Bean</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch16-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch16/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch16><span>CH16-拦截器</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch17-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch17/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch17><span class=td-sidebar-nav-active-item>CH17-监听器</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch18-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch18/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch18><span>CH18-设计模式</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch19-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch19/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch19><span>CH19-Servlet</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch20-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch20/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch20><span>CH20-缓存注解</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch21-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch21/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch21><span>CH21-跨域问题</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch22-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch22/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch22><span>CH22-SpEL表达式</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc><span>Spring IOC</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01><span>CH01-获取单例 Bean</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02><span>CH02-创建单例 Bean</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03><span>CH03-创建原始 Bean 对象</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04><span>CH04-解决循环依赖</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05><span>CH05-原始 Bean 属性填充</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06><span>CH06-后续初始化工作</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07><span>CH07-生命周期扩展</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08><span>CH08-控制加载顺序</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-aop-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-aop><span>Spring AOP</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01><span>AOP 理论</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02><span>AOP 实战</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93mybatis-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93mybatis><span>Mybatis</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01><span>CH01-整体架构</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02><span>CH02-反射模块</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03><span>CH03-基础支持模块</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04><span>CH04-运行配置解析</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05><span>CH05-通用配置解析</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06><span>CH06-语句解析</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07><span>CH07-接口层</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08><span>CH08-执行器</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09><span>CH09-集成 Spring</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10><span>CH10-整体流程</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11><span>CH11-插件机制</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12><span>CH12-代码生成</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13><span>CH13-多数据源</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14><span>CH14-常用片段</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch15-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch15><span>CH15-事务管理原理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch16-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch16/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch16><span>CH16-一级缓存原理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch17-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch17/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch17><span>CH17-二级缓存原理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch18-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch18/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch18><span>CH18-性能优化</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93hikari-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93hikari><span>Hikari</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich01-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich01><span>基本概念</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich02-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich02><span>开源实现</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich03-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich03><span>配置参数</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich04-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich04><span>JDBC API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich05-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich05><span>性能原理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich06-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich06><span>优化原理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich07-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich07><span>参数解析</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich08-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich08><span>动态代理</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich09-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich09><span>应用实践</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich10-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich10><span>监控度量</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich11-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich11><span>常见问题</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich12-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich12><span>扩展技术</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93unified-udf-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93unified-udf><span>Udf Modeling</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/transport-at-linkedin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin><span>Transport UDF at Linkedin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/flink-type-system/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system><span>Flink Type System</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93parboiled-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93parboiled><span>Parboiled</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch01-motivation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation><span>CH01-Motivation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch02-features/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features><span>CH02-Features</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch03-java-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example><span>CH03-Java Example</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch04-scala-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example><span>CH04-Scala Example</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch05-comparison/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison><span>CH05-Comparison</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch06-concepts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts><span>CH06-Concepts</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch07-java-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis><span>CH07-Java APIs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch08-scala-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis><span>CH08-Scala APIs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch09-advanced-topics/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics><span>CH09-Advanced Topics</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93netty-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93netty><span>Netty</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych01-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych01><span>CH01-Netty 概览</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych02-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych02><span>CH02-应用实例</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych04-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych04><span>CH04-Transport</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych05-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych05><span>CH05-Buffer</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych06-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych06><span>CH06-ChannelHandler 与 ChannelPipeline</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych07-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych07><span>CH07-Codec 框架</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych08-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych08><span>CH08-内置 ChannelHandler 与 Codec</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych09-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych09><span>CH09-Bootstraping</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych10-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych10><span>CH10-单元测试</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych11-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych11><span>CH11-Websocket</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych12-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych12><span>CH12-SPDY</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych13-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych13><span>CH13-UDP 广播</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych14-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych14><span>CH14-自定义编解码器</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych15-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych15><span>CH15-EventLoop 与线程模型</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych03-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych03><span></span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93reactor-netty-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/reactor-netty/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93reactor-netty><span>Reactor Netty</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93thymeleaf-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93thymeleaf><span>Thymeleaf</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch01-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch01><span>CH01-介绍</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch02-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch02><span>CH02-使用文本</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch03-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch03><span>CH03-表达式</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch04-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch04><span>CH04-设置属性值</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch05-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch05><span>CH05-迭代器</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch06-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch06><span>CH06-条件语句</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch07-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch07><span>CH07-模板布局</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch08-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch08><span>CH08-局部变量</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch09-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch09><span>CH09-属性优先级</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch10-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch10><span>CH10-注释及注释块</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch11-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch11><span>CH11-内联</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-cloud-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-cloud/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-cloud><span>Spring Cloud</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-cloudch01-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-cloud/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-cloudch01><span>Gateway 请求过程</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93dubbo-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/dubbo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93dubbo><span>Dubbo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93guava-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/guava/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93guava><span>Guava</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93guavaratelimiter-li><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/guava/ratelimiter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93guavaratelimiter><span>RateLimiter</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/infilos/infilos.com/edit/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring/CH17.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/infilos/infilos.com/new/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring/CH17.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/infilos/infilos.com/issues/new?title=CH17-%e7%9b%91%e5%90%ac%e5%99%a8" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#观察者模式>观察者模式</a></li><li><a href=#jdk中对事件监听机制的支持>JDK中对事件监听机制的支持</a><ul><li><a href=#基于jdk实现对任务执行结果的监听>基于JDK实现对任务执行结果的监听</a></li></ul></li><li><a href=#spring容器对事件监听机制的支持>Spring容器对事件监听机制的支持</a><ul><li><a href=#基本抽象>基本抽象</a></li><li><a href=#基于spring实现对任务执行结果的监听>基于Spring实现对任务执行结果的监听</a></li></ul></li><li><a href=#spring事件监听源码解析>Spring事件监听源码解析</a><ul><li><a href=#1-初始化事件发布器流程>1. 初始化事件发布器流程</a></li><li><a href=#2-注册事件监听器流程>2. 注册事件监听器流程</a></li><li><a href=#3-容器事件发布流程>3. 容器事件发布流程</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>框架库</a></li><li class=breadcrumb-item><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/>Spring</a></li><li class="breadcrumb-item active" aria-current=page><a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch17/>CH17-监听器</a></li></ol></nav><div class=td-content><h1>CH17-监听器</h1><header class=article-meta></header><h2 id=观察者模式>观察者模式</h2><p>在讲解事件监听机制前,我们先回顾下设计模式中的观察者模式,因为事件监听机制可以说是在典型观察者模式基础上的进一步抽象和改进。我们可以在JDK或者各种开源框架比如Spring中看到它的身影,从这个意义上说,事件监听机制也可以看做一种对传统观察者模式的具体实现,不同的框架对其实现方式会有些许差别。</p><p>典型的观察者模式将有依赖关系的对象抽象为了观察者和主题两个不同的角色,多个观察者同时观察一个主题,两者只通过抽象接口保持松耦合状态,这样双方可以相对独立的进行扩展和变化:比如可以很方便的增删观察者,修改观察者中的更新逻辑而不用修改主题中的代码。但是这种解耦进行的并不彻底,这具体体现在以下几个方面:</p><ul><li>1.抽象主题需要依赖抽象观察者,而这种依赖关系完全可以去除。</li><li>2.主题需要维护观察者列表,并对外提供动态增删观察者的接口,</li><li>3.主题状态改变时需要由自己去通知观察者进行更新。</li></ul><p>我们可以把主题(Subject)替换成事件(event),把对特定主题进行观察的观察者(Observer)替换成对特定事件进行监听的监听器(EventListener),而把原有主题中负责维护主题与观察者映射关系以及在自身状态改变时通知观察者的职责从中抽出,放入一个新的角色事件发布器(EventPublisher)中,事件监听模式的轮廓就展现在了我们眼前,如下图所示</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016153459.png style=display:block;width:50% alt=NAME align=center></div><p>常见事件监听机制的主要角色如下</p><ul><li>事件及事件源:对应于观察者模式中的主题。事件源发生某事件是特定事件监听器被触发的原因。</li><li>事件监听器:对应于观察者模式中的观察者。监听器监听特定事件,并在内部定义了事件发生后的响应逻辑。</li><li>事件发布器:事件监听器的容器,对外提供发布事件和增删事件监听器的接口,维护事件和事件监听器之间的映射关系,并在事件发生时负责通知相关监听器。</li></ul><p>Spring框架对事件的发布与监听提供了相对完整的支持,它扩展了JDK中对自定义事件监听提供的基础框架,并与Spring的IOC特性作了整合,使得用户可以根据自己的业务特点进行相关的自定义,并依托Spring容器方便的实现监听器的注册和事件的发布。因为Spring的事件监听依托于JDK提供的底层支持,为了更好的理解,先来看下JDK中为用户实现自定义事件监听提供的基础框架。</p><h2 id=jdk中对事件监听机制的支持>JDK中对事件监听机制的支持</h2><p>JDK为用户实现自定义事件监听提供了两个基础的类。一个是代表所有可被监听事件的事件基类java.util.EventObject,所有自定义事件类型都必须继承该类,类结构如下所示</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EventObject</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5516075349620653480L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * The object on which the Event initially occurred.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Object</span>  <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * Constructs a prototypical Event.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param    source    The object on which the Event initially occurred.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @exception  IllegalArgumentException  if source is null.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>EventObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;null source&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * The object on which the Event initially occurred.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return   The object on which the Event initially occurred.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * Returns a String representation of this EventObject.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return  A a String representation of this EventObject.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;[source=&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>source</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>该类内部有一个Object类型的source变量,逻辑上表示发生该事件的事件源,实际中可以用来存储包含该事件的一些相关信息。
另一个则是对所有事件监听器进行抽象的接口java.util.EventListener,这是一个标记接口,内部没有任何抽象方法,所有自定义事件监听器都必须实现该标记接口</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * A tagging interface that all event listener interfaces must extend.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @since JDK1.1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>EventListener</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>以上就是JDK为我们实现自定义事件监听提供的底层支持。针对具体业务场景,我们通过扩展java.util.EventObject来自定义事件类型,同时通过扩展java.util.EventListener来定义在特定事件发生时被触发的事件监听器。当然,不要忘了还要定义一个事件发布器来管理事件监听器并提供发布事件的功能。</p><h3 id=基于jdk实现对任务执行结果的监听>基于JDK实现对任务执行结果的监听</h3><p>想象我们正在做一个关于Spark的任务调度系统,我们需要把任务提交到集群中并监控任务的执行状态,当任务执行完毕(成功或者失败),除了必须对数据库进行更新外,还可以执行一些额外的工作:比如将任务执行结果以邮件的形式发送给用户。这些额外的工作后期还有较大的变动可能:比如还需要以短信的形式通知用户,对于特定的失败任务需要通知相关运维人员进行排查等等,所以不宜直接写死在主流程代码中。最好的方式自然是以事件监听的方式动态的增删对于任务执行结果的处理逻辑。为此我们可以基于JDK提供的事件框架,打造一个能够对任务执行结果进行监听的弹性系统。</p><h4 id=任务结束事件的事件源>任务结束事件的事件源</h4><p>因为要对任务执行结束这一事件进行监听,所以必须对任务这一概念进行定义,如下</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-02
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Data</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Task</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TaskFinishStatus</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>任务包含任务名和任务状态,其中任务状态是个枚举常量,只有成功和失败两种取值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-02
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span>  <span style=color:#000>TaskFinishStatus</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>SUCCEDD</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>FAIL</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=任务结束事件taskfinishevent>任务结束事件TaskFinishEvent</h4><p>自定义事件类型TaskFinishEvent继承自JDK中的EventObject,构造时会传入Task作为事件源。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-02
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TaskFinishEvent</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>EventObject</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * Constructs a prototypical Event.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param source The object on which the Event initially occurred.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @throws IllegalArgumentException if source is null.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TaskFinishEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=该事件的监听器抽象>该事件的监听器抽象</h4><p>继承标记接口EventListner表示该接口的实现类是一个监听器,同时在内部定义了事件发生时的响应方法onTaskFinish(event),接收一个TaskFinishEvent作为参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-02
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TaskFinishEventListner</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>EventListener</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onTaskFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>邮件服务监听器
该邮件服务监听器将在监听到任务结束事件时将任务的执行结果发送给用户。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-03
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Data</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MailTaskFinishListener</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TaskFinishEventListner</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>emial</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onTaskFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Send Emial to &#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>emial</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#4e9a06>&#34; Task:&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSource</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=自定义事件发布器>自定义事件发布器</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-03
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TaskFinishEventPublisher</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>TaskFinishEventListner</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>listners</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//注册监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEventListner</span> <span style=color:#000>listner</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>listners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listner</span><span style=color:#ce5c00;font-weight:700>)){</span>
</span></span><span style=display:flex><span>            <span style=color:#000>listners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listner</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//移除监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEventListner</span> <span style=color:#000>listner</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>listners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listner</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//发布任务结束事件
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>publishEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEventListner</span> <span style=color:#000>listner</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>listners</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>            <span style=color:#000>listner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>onTaskFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=测试代码>测试代码</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-03
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestTaskFinishListener</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//事件源
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Task</span> <span style=color:#000>source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;用户统计&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TaskFinishStatus</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUCCEDD</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//任务结束事件
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>TaskFinishEvent</span> <span style=color:#000>event</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TaskFinishEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//邮件服务监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MailTaskFinishListener</span> <span style=color:#000>mailListener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MailTaskFinishListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;takumiCX@163.com&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//事件发布器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>TaskFinishEventPublisher</span> <span style=color:#000>publisher</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TaskFinishEventPublisher</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//注册邮件服务监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>publisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mailListener</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//发布事件
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>publisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publishEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>如果后期因为需求变动需要在任务结束时将结果以短信的方式发送给用户,则可以再添加一个短信服务监听器</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-03
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Data</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@AllArgsConstructor</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SmsTaskFinishListener</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TaskFinishEventListner</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onTaskFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Send Message to &#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#4e9a06>&#34; Task:&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSource</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在测试代码中添加如下代码向事件发布器注册该监听器</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>SmsTaskFinishListener</span> <span style=color:#000>smsListener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SmsTaskFinishListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;123456789&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//注册短信服务监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>publisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>smsListener</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>基于JDK的支持要实现对自定义事件的监听还是比较麻烦的,要做的工作比较多。而且自定义的事件发布器也不能提供对所有事件的统一发布支持。基于Spring框架实现自定义事件监听则要简单很多,功能也更加强大。</p><h2 id=spring容器对事件监听机制的支持>Spring容器对事件监听机制的支持</h2><h3 id=基本抽象>基本抽象</h3><p>Spring容器,具体而言是ApplicationContext接口定义的容器提供了一套相对完善的事件发布和监听框架,其遵循了JDK中的事件监听标准,并使用容器来管理相关组件,使得用户不用关心事件发布和监听的具体细节,降低了开发难度也简化了开发流程。下面看看对于事件监听机制中的各主要角色,Spring框架中是如何定义的,以及相关的类体系结构</p><h4 id=事件>事件</h4><p>Spring为容器内事件定义了一个抽象类ApplicationEvent,该类继承了JDK中的事件基类EventObject。因而自定义容器内事件除了需要继承ApplicationEvent之外,还要传入事件源作为构造参数。</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016153700.png style=display:block;width:50% alt=NAME align=center></div><h4 id=事件监听器>事件监听器</h4><p>Spring定义了一个ApplicationListener接口作为为事件监听器的抽象,接口定义如下</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ApplicationEvent</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>EventListener</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    * Handle an application event.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    * @param event the event to respond to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    */</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onApplicationEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>该接口继承了JDK中表示事件监听器的标记接口EventListener,内部只定义了一个抽象方法onApplicationEvent(evnt),当监听的事件在容器中被发布,该方法将被调用。</li><li>同时,该接口是一个泛型接口,其实现类可以通过传入泛型参数指定该事件监听器要对哪些事件进行监听。这样有什么好处？这样所有的事件监听器就可以由一个事件发布器进行管理,并对所有事件进行统一发布,而具体的事件和事件监听器之间的映射关系,则可以通过反射读取泛型参数类型的方式进行匹配,稍后我们会对原理进行讲解。</li><li>最后,所有的事件监听器都必须向容器注册,容器能够对其进行识别并委托容器内真正的事件发布器进行管理。</li></ul><h4 id=事件发布器>事件发布器</h4><p>ApplicationContext接口继承了ApplicationEventPublisher接口,从而提供了对外发布事件的能力,如下所示</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016153847.png style=display:block;width:80% alt=NAME align=center></div><p>那么是否可以说ApplicationContext,即容器本身就担当了事件发布器的角色呢？其实这是不准确的,容器本身仅仅是对外提供了事件发布的接口,真正的工作其实是委托给了具体容器内部一个<code>ApplicationEventMulticaster</code>对象,其定义在AbstractApplicationContext抽象类内部,如下所示</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** Helper class used in event publishing */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ApplicationEventMulticaster</span> <span style=color:#000>applicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><p>所以,真正的事件发布器是ApplicationEventMulticaster,这是一个接口,定义了事件发布器需要具备的基本功能:管理事件监听器以及发布事件。其默认实现类是
SimpleApplicationEventMulticaster,该组件会在容器启动时被自动创建,并以单例的形式存在,管理了所有的事件监听器,并提供针对所有容器内事件的发布功能。</p><h3 id=基于spring实现对任务执行结果的监听>基于Spring实现对任务执行结果的监听</h3><p>业务场景在2.1中已经介绍过了,这里就不在啰嗦。基于Spring框架来实现对自定义事件的监听流程十分简单,只需要三部:1.自定义事件类 2.自定义事件监听器并向容器注册 3.发布事件</p><h4 id=1自定任务结束事件>1.自定任务结束事件</h4><p>定义一个任务结束事件TaskFinishEvent2,该类继承抽象类ApplicationEvent来遵循容器事件规范。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-04
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TaskFinishEvent2</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ApplicationEvent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * Create a new ApplicationEvent.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param source the object on which the event initially occurred (never {@code null})
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TaskFinishEvent2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=2自定义邮件服务监听器并向容器注册>2.自定义邮件服务监听器并向容器注册</h4><p>该类实现了容器事件规范定义的监听器接口,通过泛型参数指定对上面定义的任务结束事件进行监听,通过@Component注解向容器进行注册</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-04
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Component</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MailTaskFinishListener2</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>TaskFinishEvent2</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>emial</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;takumiCX@163.com&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onApplicationEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TaskFinishEvent2</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Send Emial to &#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>emial</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#4e9a06>&#34; Task:&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSource</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=3发布事件>3.发布事件</h4><p>从上面对Spring事件监听机制的类结构分析可知,发布事件的功能定义在ApplicationEventPublisher接口中,而ApplicationContext继承了该接口,所以最好的方法是通过实现ApplicationContextAware接口获取ApplicationContext实例,然后调用其发布事件方法。如下所示定义了一个发布容器事件的代理类</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @author: takumiCX
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> * @create: 2018-11-04
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic> **/</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Component</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EventPublisher</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationContextAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//发布事件
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>publishEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publishEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span> <span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在此基础上,还可以自定义一个短信服务监听器,在任务执行结束时发送短信通知用户。过程和上面自定义邮件服务监听器类似:实现ApplicationListner接口并重写抽象方法,然后通过注解或者xml的方式向容器注册。</p><h2 id=spring事件监听源码解析>Spring事件监听源码解析</h2><p>Spring事件监听机制离不开容器IOC特性提供的支持,比如容器会自动创建事件发布器,自动识别用户注册的监听器并进行管理,在特定的事件发布后会找到对应的事件监听器并对其监听方法进行回调。Spring帮助用户屏蔽了关于事件监听机制背后的很多细节,使用户可以专注于业务层面进行自定义事件开发。然而我们还是忍不住对其背后的实现原理进行一番探讨,比如:</p><ul><li>1.事件发布器ApplicationEventMulticaster是何时被初始化的,初始化过程中都做了什么？</li><li>2.注册事件监听器的过程是怎样的,容器怎么识别出它们并进行管理?</li><li>3.容器发布事件的流程是怎样的?它如何根据发布的事件找到对应的事件监听器,事件和由该事件触发的监听器之间的匹配规则是怎样的？</li></ul><p>为了对以上问题进行解答,我们不得不深入源码层面一探究竟。</p><h3 id=1-初始化事件发布器流程>1. 初始化事件发布器流程</h3><p>真正的事件发布器是ApplicationEventMulticaster,它定义在AbstractApplicationContext中,并在ApplicationContext容器启动的时候进行初始化。在容器启动的refrsh()方法中可以找到初始化事件发布器的入口方法,如下图所示</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154004.png style=display:block;width:80% alt=NAME align=center></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// 判断beanFactory里是否定义了id为applicationEventMulticaster的bean,默认是没有的
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>     <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Using ApplicationEventMulticaster [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#8f5902;font-style:italic>//一般情况会走这里,创建一个SimpleApplicationEventMulticaster并交由容器管理
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unable to locate ApplicationEventMulticaster with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#000>APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>      <span style=color:#4e9a06>&#34;&#39;: using default [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这里会根据核心容器beanFactory中是否有id为applicationEventMulticaster的bean分两种情况:</p><ul><li>1.容器中已有id为applicationEventMulticaster的bean
直接从容器缓存获取或是创建该bean实例,并交由成员变量applicationEventMulticaster保存。
当用户自定义了事件发布器并向容器注册时会执行该流程。</li><li>2.容器中不存在applicationEventMulticaster的bean
这是容器默认的执行流程,会创建一个SimpleApplicationEventMulticaster,其仅在实现事件发布器基本功能(管理事件监听器以及发布容器事件)的前提下,增加了可以设置任务执行器
Executor和错误处理器ErrorHandler的功能,当设置Executor为线程池时,则会以异步的方式对事件监听器进行回调,而ErrorHandler允许我们在回调方法执行错误时进行自定义处理。默认情况下，
这两个变量都为null。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimpleApplicationEventMulticaster</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractApplicationEventMulticaster</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Executor</span> <span style=color:#000>taskExecutor</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ErrorHandler</span> <span style=color:#000>errorHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractApplicationEventMulticaster</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanClassLoaderAware</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactoryAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ListenerRetriever</span> <span style=color:#000>defaultRetriever</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ListenerRetriever</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ListenerCacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ListenerRetriever</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>retrieverCache</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ListenerCacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ListenerRetriever</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>64</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>beanClassLoader</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>retrievalMutex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultRetriever</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><p>之后会调用beanFactory.registerSingleton方法将创建的SimpleApplicationEventMulticaster实例注册为容器的单实例bean。</p><p>初始化事件发布器的工作非常简单,一句话总结:由容器实例化用户自定义的事件发布器或者由容器帮我们创建一个简单的事件发布器并交由容器管理。</p><h3 id=2-注册事件监听器流程>2. 注册事件监听器流程</h3><p>注册事件监听器的流程在初始化事件发布器之后,如下图所示</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154035.png style=display:block;width:80% alt=NAME align=center></div><p>其关键代码如下所示</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// uninitialized to let post-processors apply to them!
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//获取实现ApplicationListener接口的所有bean的beanName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>listenerBeanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>listenerBeanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>listenerBeanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#8f5902;font-style:italic>//将监听器的beanName保存到事件发布器中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>getApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addApplicationListenerBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>首先遍历beanFactory中所有的bean,获取所有实现ApplicationListener接口的bean的beanName,并将这些beanName注册到ApplicationEventMulticaster中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addApplicationListenerBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>listenerBeanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrievalMutex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   	  <span style=color:#8f5902;font-style:italic>//保存所有监听器的beanName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultRetriever</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListenerBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>//清除维护事件和监听器映射关系的缓存
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrieverCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>defaultRetriever是定义在抽象类AbstractApplicationEventMulticaster中的成员,用来保存所有事件监听器及其beanName</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>private final ListenerRetriever defaultRetriever = new ListenerRetriever(false);
</span></span></code></pre></div><p>其以内部类形式定义在AbstractApplicationEventMulticaster中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * Helper class that encapsulates a specific set of target listeners,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * allowing for efficient retrieval of pre-filtered listeners.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * &lt;p&gt;An instance of this helper gets cached per event type and source type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ListenerRetriever</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//保存所有事件监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//保存所有事件监听器的beanName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>applicationListenerBeans</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><p>向事件发布器注册监听器的beanName,其实就是将beanName加入ListenerRetriever的集合中。</p><p>其实看到这里会有一个疑问,registerListeners()方法只是找到了所有监听器的beanName并将其保存到了事件发布器ApplicationEventMulticaster中,那么真正的事件监听器实例是何时被创建并被加入到事件发布器中的？
这里我们不得不退回到启动容器的refresh()方法中,在初始化beanFactory之后,初始化事件发布器之前,容器在prepareBeanFactory(beanFactory)方法中又注册了一些重要组件,其中就包括一个特殊的BeanPostProcessor:ApplicationListenerDetector,正如其类名暗示的那样,这是一个事件监听器的探测器。</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154057.png style=display:block;width:80% alt=NAME align=center></div><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154105.png style=display:block;width:80% alt=NAME align=center></div><p>该类实现了BeanPostProcessor接口,如下图所示</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154116.png style=display:block;width:80% alt=NAME align=center></div><p>ApplicationListenerDetector实现了BeanPostProcessor接口,可以在容器级别对所有bean的生命周期过程进行增强。这里主要是为了能够在初始化所有bean后识别出所有的事件监听器bean并
将其注册到事件发布器中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>postProcessAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//判断该bean是否实现了ApplicationListener接口
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#8f5902;font-style:italic>// potentially not detected as a listener by getBeanNamesForType retrieval
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Boolean</span> <span style=color:#000>flag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRUE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flag</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#8f5902;font-style:italic>// singleton bean (top-level or inner): register on the fly
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>//将实现了ApplicationListener接口的bean注册到事件发布器applicationEventMulticaster中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addApplicationListener</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>FALSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flag</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>					<span style=color:#8f5902;font-style:italic>// inner bean with other scope - can&#39;t reliably process events
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Inner bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; implements ApplicationListener interface &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>							<span style=color:#4e9a06>&#34;but is not reachable for event multicasting by its containing ApplicationContext &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>							<span style=color:#4e9a06>&#34;because it does not have singleton scope. Only top-level listener beans are allowed &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>							<span style=color:#4e9a06>&#34;to be of non-singleton scope.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在初始化所有的bean后,该ApplicationListenerDetector的postProcessAfterInitialization(Object bean, String beanName)方法会被作用在每一个bean上,通过判断传入的bean
是否是ApplicationListener实例进行过滤,然后将找到的事件监听器bean注册到事件发布器中。</p><h3 id=3-容器事件发布流程>3. 容器事件发布流程</h3><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154143.png style=display:block;width:80% alt=NAME align=center></div><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154151.png style=display:block;width:80% alt=NAME align=center></div><p>这里为了简化源码阅读的工作量,对一些细节和分支情形做了忽略,只考虑主流程,如上图箭头所示,这里调用了事件发布器的multicastEvent()方法进行事件发布,需要传入事件event和事件类型
eventType作为参数。不过通常这个eventType参数为null,因为事件的类型信息完全可以通过反射的方式从event对象中获得。继续跟进源码</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>multicastEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ApplicationEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResolvableType</span> <span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//获取事件类型
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ResolvableType</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eventType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>eventType</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resolveDefaultEventType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//遍历所有和事件匹配的事件监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getApplicationListeners</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#8f5902;font-style:italic>//获取事件发布器内的任务执行器,默认该方法返回null
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>Executor</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTaskExecutor</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#8f5902;font-style:italic>//异步回调监听方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>					<span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>					<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>						<span style=color:#000>invokeListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>					<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>});</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#8f5902;font-style:italic>//同步回调监听方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>invokeListener</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>首先通过传入的参数或者通过调用resolveDefaultEventType(event)方法获取事件的事件类型信息,之后会通过
getApplicationListeners(event, type)方法得到所有和该事件类型匹配的事件监听器,其实现逻辑后面会细说,这里先跳过。对于匹配的每一个监听器,视事件发布器内是否设置了
任务执行器实例Executor,决定以何种方式对监听器的监听方法进行回调。</p><ul><li>若执行器实例Executor未设置,则进行同步回调,即在当前线程执行监听器的回调方法</li><li>若用户设置了Executor实例(通常而言是线程池),则会进行异步回调,监听器的监听方法会交由线程池中的线程去执行。
默认情况下容器不会为用户创建执行器实例,因而对监听器的回调是同步进行的,即所有监听器的监听方法都在推送事件的线程中被执行,通常这也是处理业务逻辑的线程,若其中一个监听器回调执行
阻塞,则会阻塞整个业务处理的线程,造成严重的后果。而异步回调的方式,虽然不会导致业务处理线程被阻塞,但是不能共享一些业务线程的上下文资源,比如类加载器,事务等等。因而究竟选择哪种回调
方式,要视具体业务场景而定。</li></ul><p>好了,现在可以来探究下困扰我们很久的一个问题了,那就是:如何根据事件类型找到匹配的所有事件监听器？这部分逻辑在getApplicationListeners方法中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>getApplicationListeners</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>			<span style=color:#000>ApplicationEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResolvableType</span> <span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>//获取事件中的事件源对象
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSource</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//获取事件源类型
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>sourceType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//以事件类型和事件源类型为参数构建一个cacheKey,用于从缓存map中获取与之匹配的监听器列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ListenerCacheKey</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ListenerCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>// Quick check for existing entry on ConcurrentHashMap...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>ListenerRetriever</span> <span style=color:#000>retriever</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrieverCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retriever</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		    <span style=color:#8f5902;font-style:italic>//从缓存中获取监听器列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationListeners</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanClassLoader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCacheSafe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanClassLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
</span></span><span style=display:flex><span>						<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCacheSafe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanClassLoader</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#8f5902;font-style:italic>// Fully synchronized building and caching of a ListenerRetriever
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrievalMutex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#000>retriever</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrieverCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retriever</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>					<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationListeners</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>				<span style=color:#000>retriever</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ListenerRetriever</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#8f5902;font-style:italic>//查找所有与发布事件匹配的监听器列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>listeners</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>						<span style=color:#000>retrieveApplicationListeners</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#8f5902;font-style:italic>//将匹配结果缓存到map中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrieverCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>listeners</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#8f5902;font-style:italic>// No ListenerRetriever caching -&gt; no synchronization necessary
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>retrieveApplicationListeners</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>整个流程可以概括为：</p><ul><li>1.首先从缓存map中查找,这个map定义在事件发布器的抽象类中</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>final Map&lt;ListenerCacheKey, ListenerRetriever&gt; retrieverCache =
</span></span><span style=display:flex><span>      new ConcurrentHashMap&lt;ListenerCacheKey, ListenerRetriever&gt;(64);
</span></span></code></pre></div><p>ListenerCacheKey由事件类型eventType和事件源类型sourceType构成,ListenerRetriever内部则维护了一个监听器列表。当所发布的事件类型和事件源类型与Map中的key匹配时,
将直接返回value中的监听器列表作为匹配结果,通常这发生在事件不是第一次发布时,能避免遍历所有监听器并进行过滤,如果事件时第一次发布,则会执行流程2。</p><ul><li>2.遍历所有的事件监听器,并根据事件类型和事件源类型进行匹配。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>listeners</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>      <span style=color:#000>retrieveApplicationListeners</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * Actually retrieve the application listeners for the given event and source type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param eventType the event type
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param sourceType the event source type
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param retriever the ListenerRetriever, if supposed to populate one (for caching purposes)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @return the pre-filtered list of application listeners for the given event and source type
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>retrieveApplicationListeners</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>			<span style=color:#000>ResolvableType</span> <span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ListenerRetriever</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//这是存放匹配的监听器的列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>allListeners</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;();</span>
</span></span><span style=display:flex><span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>listeners</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>		<span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>listenerBeans</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrievalMutex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#000>listeners</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultRetriever</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>			<span style=color:#000>listenerBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultRetriever</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListenerBeans</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//遍历所有的监听器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>listeners</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#8f5902;font-style:italic>//判断该事件监听器是否匹配
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>supportsEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retriever</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>					<span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>				<span style=color:#8f5902;font-style:italic>//将匹配的监听器加入列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#000>allListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//这部分可以跳过
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>listenerBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#000>BeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>listenerBeanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>listenerBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>					<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>listenerType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>supportsEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>						<span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>								<span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerBeanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>						<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>allListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>supportsEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>							<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retriever</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>								<span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListenerBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listenerBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>							<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>							<span style=color:#000>allListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>						<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>					<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>					<span style=color:#8f5902;font-style:italic>// Singleton listener instance (without backing bean definition) disappeared -
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>					<span style=color:#8f5902;font-style:italic>// probably in the middle of the destruction phase
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#8f5902;font-style:italic>//对匹配的监听器列表进行排序
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>AnnotationAwareOrderComparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>allListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>allListeners</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>判断监听器是否匹配的逻辑在supportsEvent(listener, eventType, sourceType)中,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>protected boolean supportsEvent(ApplicationListener&lt;?&gt; listener, ResolvableType eventType, Class&lt;?&gt; sourceType) {
</span></span><span style=display:flex><span>		//对原始的ApplicationListener进行一层适配器包装成为GenericApplicationListener
</span></span><span style=display:flex><span>		GenericApplicationListener smartListener = (listener instanceof GenericApplicationListener ?
</span></span><span style=display:flex><span>				(GenericApplicationListener) listener : new GenericApplicationListenerAdapter(listener));
</span></span><span style=display:flex><span>				//判断监听器是否支持该事件类型以及该事件源类型
</span></span><span style=display:flex><span>		return (smartListener.supportsEventType(eventType) &amp;&amp; smartListener.supportsSourceType(sourceType));
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>首先对原始的ApplicationListener进行一层适配器包装成GenericApplicationListener,便于后面使用该接口中定义的方法判断监听器是否支持传入的事件类型或事件源类型</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>GenericApplicationListener</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationEvent</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Ordered</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    * Determine whether this listener actually supports the given event type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    */</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>supportsEventType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResolvableType</span> <span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//判断是否支持该事件类型
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    * Determine whether this listener actually supports the given source type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    */</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>supportsSourceType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>);</span>   <span style=color:#8f5902;font-style:italic>//判断是否支持该事件源类型
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>smartListener.supportsEventType(eventType)用来判断监听器是否支持该事件类型,因为我们的监听器实例通常都不是SmartApplicationListener类型,所以直接看下面箭头所指的方法就好</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154214.png style=display:block;width:80% alt=NAME align=center></div><p>declaredEventType是监听器泛型的实际类型,而eventType是发布的事件的类型
declaredEventType.isAssignableFrom(eventType)当以下两种情况返回true</p><ul><li>1.declaredEventType和eventType类型相同</li><li>2.declaredEventType是eventType的父类型
只要监听器泛型的实际类型和发布的事件类型一样或是它的父类型,则该监听器将被成功匹配。</li></ul><p>而对于事件源类型而言,通常默认会直接返回true,也就是说事件源的类型通常对于判断匹配的监听器没有意义。</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154225.png style=display:block;width:80% alt=NAME align=center></div><p>这里查找到所有匹配的监听器返回后会将匹配关系缓存到retrieverCache这个map中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>				<span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>listeners</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>						<span style=color:#000>retrieveApplicationListeners</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eventType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#8f5902;font-style:italic>//将匹配结果缓存到map中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retrieverCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>retriever</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>listeners</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><p>梳理下容器事件发布的整个流程,可以总结如下</p><div align=center><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211016154237.png style=display:block;width:80% alt=NAME align=center></div><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=t=>{if(typeof ga!='function')return;const e={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:t};ga(e.command,e.hitType,e.category,e.action,e.label,e.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script><br></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo><a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217><i class="fab fa-weibo"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com><i class="fab fa-stack-overflow"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 infilos.com All Rights Reserved</small></div></div></div></footer></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.234862a61a98834daa49494cfddb4df5f6d0196eaeb7db34a9ce068e7f17863e.js integrity="sha256-I0hiphqYg02qSUlM/dtN9fbQGW6ut9s0qc4Gjn8Xhj4=" crossorigin=anonymous></script></body></html>