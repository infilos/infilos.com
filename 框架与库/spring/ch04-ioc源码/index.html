<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.3">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>CH04-IOC源码 | infilos.com</title><meta property="og:title" content="CH04-IOC源码">
<meta property="og:description" content="ApplicationContext 实例化 Bean 的过程 ApplicationContext ac = new ClassPathXmlApplicationContext(&#34;classpath:applicationContext.xml&#34;); Hello hello = (Hello)ac.getBean(&#34;hello&#34;); hello.sayHello(); 这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。
当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：
 启动过程分析 第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。
public ClassPathXmlApplicationContext( String[] configLocations, boolean refresh, @Nullable ApplicationContext parent) throws BeansException { super(parent); // 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)  setConfigLocations(configLocations); if (refresh) { refresh(); } } 接下来，就是 refresh()，这里简单说下为什么是 refresh()，而不是 init() 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 refresh() 这个方法重建的，refresh() 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。">
<meta property="og:type" content="article">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch04-ioc%E6%BA%90%E7%A0%81/"><meta property="article:section" content="框架与库">
<meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="CH04-IOC源码">
<meta itemprop=description content="ApplicationContext 实例化 Bean 的过程 ApplicationContext ac = new ClassPathXmlApplicationContext(&#34;classpath:applicationContext.xml&#34;); Hello hello = (Hello)ac.getBean(&#34;hello&#34;); hello.sayHello(); 这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。
当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：
 启动过程分析 第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。
public ClassPathXmlApplicationContext( String[] configLocations, boolean refresh, @Nullable ApplicationContext parent) throws BeansException { super(parent); // 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)  setConfigLocations(configLocations); if (refresh) { refresh(); } } 接下来，就是 refresh()，这里简单说下为什么是 refresh()，而不是 init() 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 refresh() 这个方法重建的，refresh() 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。">
<meta itemprop=wordCount content="5935">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="CH04-IOC源码">
<meta name=twitter:description content="ApplicationContext 实例化 Bean 的过程 ApplicationContext ac = new ClassPathXmlApplicationContext(&#34;classpath:applicationContext.xml&#34;); Hello hello = (Hello)ac.getBean(&#34;hello&#34;); hello.sayHello(); 这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。
当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：
 启动过程分析 第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。
public ClassPathXmlApplicationContext( String[] configLocations, boolean refresh, @Nullable ApplicationContext parent) throws BeansException { super(parent); // 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)  setConfigLocations(configLocations); if (refresh) { refresh(); } } 接下来，就是 refresh()，这里简单说下为什么是 refresh()，而不是 init() 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 refresh() 这个方法重建的，refresh() 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
</div>
<div id=content-desktop></div>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-e6a186e69eb6e4b88ee5ba93><span>框架库</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93spring-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring><span>Spring</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch01-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc><span>CH01-IOC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch02-springioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc><span>CH02-Spring IOC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch03-bean%E5%8A%A0%E8%BD%BD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd><span>CH03-Bean加载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch04-ioc%E6%BA%90%E7%A0%81/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081><span class=td-sidebar-nav-active-item>CH04-IOC源码</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch05-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596><span>CH05-循环依赖</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch07><span>CH07-动态代理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch08><span>CH08-定义接口</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch09><span>CH09-请求过程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch10><span>CH10-配置注入</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch11><span>CH11-配置绑定</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch12><span>CH12-环境变量</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch13-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch13><span>CH13-事务原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch14-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch14><span>CH14-定义 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch15-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch15><span>CH15-注入 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch16-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch16/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch16><span>CH16-拦截器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch17-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch17/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch17><span>CH17-监听器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch18-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch18/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch18><span>CH18-设计模式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch19-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch19/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch19><span>CH19-Servlet</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93springch20-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch20/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch20><span>CH20-缓存注解</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc><span>Spring IOC</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01><span>CH01-获取单例 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02><span>CH02-创建单例 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03><span>CH03-创建原始 Bean 对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04><span>CH04-解决循环依赖</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05><span>CH05-原始 Bean 属性填充</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06><span>CH06-后续初始化工作</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07><span>CH07-生命周期扩展</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08><span>CH08-控制加载顺序</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-aop-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-aop><span>Spring AOP</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01><span>AOP 理论</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02><span>AOP 实战</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93mybatis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93mybatis><span>Mybatis</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01><span>CH01-整体架构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02><span>CH02-反射模块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03><span>CH03-基础支持模块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04><span>CH04-运行配置解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05><span>CH05-通用配置解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06><span>CH06-语句解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07><span>CH07-接口层</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08><span>CH08-执行器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09><span>CH09-集成 Spring</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10><span>CH10-整体流程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11><span>CH11-插件机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12><span>CH12-代码生成</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13><span>CH13-多数据源</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14><span>CH14-常用片段</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch15-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch15><span>CH15-事务管理原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch16-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch16/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch16><span>CH16-一级缓存原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch17-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch17/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch17><span>CH17-二级缓存原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93mybatisch18-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch18/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch18><span>CH18-性能优化</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93hikari-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93hikari><span>Hikari</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich01><span>基本概念</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich02><span>开源实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich03><span>配置参数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich04><span>JDBC API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich05><span>性能原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich06><span>优化原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich07><span>参数解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich08><span>动态代理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich09><span>应用实践</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich10><span>监控度量</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich11><span>常见问题</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich12><span>扩展技术</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93unified-udf-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93unified-udf><span>Udf Modeling</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/transport-at-linkedin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin><span>Transport UDF at Linkedin</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/flink-type-system/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system><span>Flink Type System</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93parboiled-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93parboiled><span>Parboiled</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch01-motivation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation><span>CH01-Motivation</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch02-features/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features><span>CH02-Features</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch03-java-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example><span>CH03-Java Example</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch04-scala-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example><span>CH04-Scala Example</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch05-comparison/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison><span>CH05-Comparison</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch06-concepts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts><span>CH06-Concepts</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch07-java-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis><span>CH07-Java APIs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch08-scala-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis><span>CH08-Scala APIs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch09-advanced-topics/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics><span>CH09-Advanced Topics</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93netty-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93netty><span>Netty</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych01><span>CH01-Netty 概览</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych02><span>CH02-应用实例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych04><span>CH04-Transport</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych05><span>CH05-Buffer</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych06><span>CH06-ChannelHandler 与 ChannelPipeline</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych07><span>CH07-Codec 框架</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych08><span>CH08-内置 ChannelHandler 与 Codec</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych09><span>CH09-Bootstraping</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych10><span>CH10-单元测试</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych11><span>CH11-Websocket</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych12><span>CH12-SPDY</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych13-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych13><span>CH13-UDP 广播</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych14-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych14><span>CH14-自定义编解码器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych15-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych15><span>CH15-EventLoop 与线程模型</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93nettych03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/netty/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93nettych03><span></span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93reactor-netty-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/reactor-netty/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93reactor-netty><span>Reactor Netty</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93thymeleaf-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93thymeleaf><span>Thymeleaf</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch01><span>CH01-介绍</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch02><span>CH02-使用文本</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch03><span>CH03-表达式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch04><span>CH04-设置属性值</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch05><span>CH05-迭代器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch06><span>CH06-条件语句</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch07><span>CH07-模板布局</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch08><span>CH08-局部变量</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch09><span>CH09-属性优先级</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch10><span>CH10-注释及注释块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/thymeleaf/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93thymeleafch11><span>CH11-内联</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-cloud-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-cloud/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-cloud><span>Spring Cloud</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-cloudch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-cloud/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-cloudch01><span>Gateway 请求过程</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93dubbo-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/dubbo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93dubbo><span>Dubbo</span></a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/infilos/infilos.com/edit/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring/CH04-IOC%e6%ba%90%e7%a0%81.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/infilos/infilos.com/new/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring/CH04-IOC%e6%ba%90%e7%a0%81.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/infilos/infilos.com/issues/new?title=CH04-IOC%e6%ba%90%e7%a0%81" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#applicationcontext-实例化-bean-的过程>ApplicationContext 实例化 Bean 的过程</a>
<ul>
<li><a href=#启动过程分析>启动过程分析</a></li>
<li><a href=#创建-bean-容器前的准备工作>创建 Bean 容器前的准备工作</a></li>
<li><a href=#创建-bean-容器加载并注册-bean>创建 Bean 容器，加载并注册 Bean</a></li>
<li><a href=#注册-bean>注册 Bean</a></li>
<li><a href=#bean-容器实例化完成后>Bean 容器实例化完成后</a></li>
<li><a href=#准备-bean-容器-preparebeanfactory>准备 Bean 容器: prepareBeanFactory</a></li>
<li><a href=#preparebeanfactoryfactory>prepareBeanFactory(factory)</a></li>
<li><a href=#初始化所有的-singleton-beans>初始化所有的 singleton beans</a></li>
</ul>
</li>
<li><a href=#获取-bean>获取 Bean</a>
<ul>
<li><a href=#俯瞰-getbeanstring-源码>俯瞰 getBean(String) 源码</a></li>
<li><a href=#createbean>createBean</a></li>
</ul>
</li>
<li><a href=#相关疑问>相关疑问</a>
<ul>
<li></li>
</ul>
</li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>框架库</a>
</li>
<li class=breadcrumb-item>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/>Spring</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch04-ioc%E6%BA%90%E7%A0%81/>CH04-IOC源码</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>CH04-IOC源码</h1>
<header class=article-meta>
</header>
<h2 id=applicationcontext-实例化-bean-的过程>ApplicationContext 实例化 Bean 的过程</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:applicationContext.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>ac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sayHello</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。</p>
<p>当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120343.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=启动过程分析>启动过程分析</h3>
<p>第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>setConfigLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，就是 <code>refresh()</code>，这里简单说下为什么是 <code>refresh()</code>，而不是 <code>init()</code> 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 <code>refresh()</code> 这个方法重建的，<code>refresh()</code> 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Prepare this context for refreshing.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Tell the subclass to refresh the internal bean factory.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Prepare the bean factory for use in this context.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Allows post-processing of the bean factory in context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//提供给子类实现一些postProcess的注册，如AbstractRefreshableWebApplicationContext注册一些Servlet相关的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Invoke factory processors registered as beans in the context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//调用所有BeanFactoryProcessor的postProcessBeanFactory()方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Register bean processors that intercept bean creation.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册BeanPostProcessor，BeanPostProcessor作用是用于拦截Bean的创建
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Initialize message source for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化消息Bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize event multicaster for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化上下文的事件多播组建，ApplicationEvent触发时由multicaster通知给ApplicationListener
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize other special beans in specific context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//ApplicationContext初始化一些特殊的bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Check for listener beans and register them.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册事件监听器，事件监听Bean统一注册到multicaster里头，ApplicationEvent事件触发后会由multicaster广播
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Instantiate all remaining (non-lazy-init) singletons.(重点)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 非延迟加载的单例Bean实例化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Last step: publish corresponding event.(最后，广播事件，ApplicationContext 初始化完成)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Propagate exception to caller.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面，我们开始一步步来肢解这个 <code>refresh()</code> 方法。</p>
<h3 id=创建-bean-容器前的准备工作>创建 Bean 容器前的准备工作</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Prepare this context for refreshing, setting its startup date and
</span><span style=color:#8f5902;font-style:italic> * active flag as well as performing any initialization of property sources.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// Switch to active.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupDate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>active</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Refreshing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize any placeholder property sources in the context environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initPropertySources</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Validate that all properties marked as required are resolvable:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// see ConfigurablePropertyResolver#setRequiredProperties
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 校验 xml 配置文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>validateRequiredProperties</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Store pre-refresh ApplicationListeners...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Reset local application listeners to pre-refresh state.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Allow for the collection of early ApplicationEvents,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// to be published once the multicaster is available...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationEvents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-bean-容器加载并注册-bean>创建 Bean 容器，加载并注册 Bean</h3>
<p>我们回到 <code>refresh()</code> 方法中的下一行 <code>obtainFreshBeanFactory()</code>。</p>
<p>注意，这个方法是全文最重要的部分之一，这里将会初始化 BeanFactory、加载 Bean、注册 Bean 等等。</p>
<p>当然，这步结束后，Bean 并没有完成初始化。这里指的是 Bean 实例并未在这一步生成。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 关闭旧的 BeanFactory (如果有)，创建新的 BeanFactory，加载 Bean 定义、注册 Bean 等等
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 返回刚刚创建的 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean factory for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>// AbstractRefreshableApplicationContext.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 如果 ApplicationContext 中已经加载过 BeanFactory 了，销毁所有 Bean，关闭 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意，应用中 BeanFactory 本来就是可以多个的，这里可不是说应用全局是否有 BeanFactory，而是当前
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// ApplicationContext 是否有 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanFactory</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 初始化一个 DefaultListableBeanFactory，为什么用这个，我们马上说。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 用于 BeanFactory 的序列化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSerializationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#8f5902;font-style:italic>// 下面这两个方法很重要，别跟丢了，具体细节之后说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的两个配置属性：是否允许 Bean 覆盖、是否允许循环引用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 加载 Bean 到 BeanFactory 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactoryMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O error parsing bean definition source for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>看到这里的时候，我觉得读者就应该站在高处看 ApplicationContext 了，ApplicationContext 继承自 BeanFactory，但是它不应该被理解为 BeanFactory 的实现类，而是说其内部持有一个实例化的 BeanFactory（DefaultListableBeanFactory）。以后所有的 BeanFactory 相关的操作其实是委托给这个实例来处理的。</p>
</blockquote>
<p>我们说说为什么选择实例化 <strong>DefaultListableBeanFactory</strong> ？前面我们说了有个很重要的接口 ConfigurableListableBeanFactory，它实现了 BeanFactory 下面一层的所有三个接口，我把之前的继承图再拿过来大家再仔细看一下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120653.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们可以看到 ConfigurableListableBeanFactory 只有一个实现类 DefaultListableBeanFactory，而且实现类 DefaultListableBeanFactory 还通过实现右边的 AbstractAutowireCapableBeanFactory 通吃了右路。所以结论就是，最底下这个家伙 DefaultListableBeanFactory 基本上是最牛的 BeanFactory 了，这也是为什么这边会使用这个类来实例化的原因。</p>
<blockquote>
<p>如果你想要在程序运行的时候动态往 Spring IOC 容器注册新的 bean，就会使用到这个类。那我们怎么在运行时获得这个实例呢？</p>
<p>之前我们说过 ApplicationContext 接口能获取到 AutowireCapableBeanFactory，就是最右上角那个，然后它向下转型就能得到 DefaultListableBeanFactory 了。</p>
</blockquote>
<p>在继续往下之前，我们需要先了解 BeanDefinition。<strong>我们说 BeanFactory 是 Bean 容器，那么 Bean 又是什么呢？</strong></p>
<p>这里的 BeanDefinition 就是我们所说的 Spring 的 Bean，我们自己定义的各个 Bean 其实会转换成一个个 BeanDefinition 存在于 Spring 的 BeanFactory 中。</p>
<p>所以，如果有人问你 Bean 是什么的时候，你要知道 Bean 在代码层面上可以认为是 BeanDefinition 的实例。</p>
<blockquote>
<p>BeanDefinition 中保存了我们的 Bean 信息，比如这个 Bean 指向的是哪个类、是否是单例的、是否懒加载、这个 Bean 依赖了哪些 Bean 等等。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120722.png style=display:block;width:50% alt=NAME align=center> </div>
<p>BeanDefinition 是一个接口，用于属性承载，比如 <bean> 元素标签拥有 class、scope、lazy-init 等配置。bean的定义方式有千千万万种，无论是何种标签，无论是何种资源定义，无论是何种容器，只要按照 Spring 的规范编写xml配置文件，最终的 bean 定义内部表示都将转换为内部的唯一结构：BeanDefinition。当 BeanDefinition 注册完毕以后，Spring 的 BeanFactory 就可以随时根据需要进行实例化了。</p>
<h5 id=beandefinition-接口定义>BeanDefinition 接口定义</h5>
<p>我们来看下 BeanDefinition 的接口定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanDefinition</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AttributeAccessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 我们可以看到，默认只提供 sington 和 prototype 两种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 很多读者可能知道还有 request, session, globalSession, application, websocket 这几种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 不过，它们属于基于 web 的扩展。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>SCOPE_SINGLETON</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_SINGLETON</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>String</span> <span style=color:#000>SCOPE_PROTOTYPE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_PROTOTYPE</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 比较不重要，直接跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_APPLICATION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_SUPPORT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_INFRASTRUCTURE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 设置父 Bean，这里涉及到 bean 继承，不是 java 继承。请参见附录的详细介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：继承父 Bean 的配置信息而已
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>parentName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取父 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getParentName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 Bean 的类名称，将来是要通过反射来生成实例的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanClassName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取 Bean 的类名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 bean 的 scope
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>);</span>
   
   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#000>String</span> <span style=color:#000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置是否懒加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLazyInit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInit</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 依赖的所有的 Bean，注意，这里的依赖不是指属性依赖(如 @Autowire 标记的)，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 是 depends-on=&#34;&#34; 属性设置的值。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 返回该 Bean 的所有依赖
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 是否可以注入到其他 Bean 中，只对根据类型注入有效，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果根据名称注入，即使这边设置了 false，也是可以的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireCandidate</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 该 Bean 是否可以注入到其他 Bean 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 主要的。同一接口的多个实现，如果不指定名字的话，Spring 会优先选择设置 primary 为 true 的 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPrimary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>primary</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 是否是 primary 的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrimary</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果该 Bean 采用工厂方法生成，指定工厂名称。对工厂不熟悉的读者，请参加附录
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：有些实例不是用反射生成的，而是用工厂模式生成的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 指定工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryMethodName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 构造器参数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Bean 中的属性值，后面给 bean 注入属性值的时候会说到
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 singleton
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 prototype
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrototype</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果这个 Bean 是被设置为 abstract，那么不能实例化，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 常用于作为 父bean 用于继承，其实也很少用......
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAbstract</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getRole</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>BeanDefinition</span> <span style=color:#000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>这个 BeanDefinition 其实已经包含很多的信息了，暂时不清楚所有的方法对应什么东西没关系，希望看完本文后读者可以彻底搞清楚里面的所有东西。</p>
<p>这里接口虽然那么多，但是没有类似 getInstance() 这种方法来获取我们定义的类的实例，真正的我们定义的类生成的实例到哪里去了呢？别着急，这个要很后面才能讲到。</p>
</blockquote>
<p>有了 BeanDefinition 的概念以后，我们再往下看 <code>refreshBeanFactory()</code> 方法中的剩余部分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=customizebeanfactory>customizeBeanFactory()</h4>
<p>customizeBeanFactory(beanFactory) 比较简单，就是配置是否允许 BeanDefinition 覆盖、是否允许循环引用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 定义覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 间的循环依赖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowCircularReferences</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span><span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BeanDefinition 的覆盖问题可能会有开发者碰到这个坑，就是在配置文件中定义 bean 时使用了相同的 id 或 name，默认情况下，allowBeanDefinitionOverriding 属性为 null，如果在同一配置文件中重复了，会抛错，但是如果不是同一配置文件中，会发生覆盖。</p>
<p>循环引用也很好理解：A 依赖 B，而 B 依赖 A。或 A 依赖 B，B 依赖 C，而 C 依赖 A。</p>
<p>默认情况下，Spring 允许循环依赖，当然如果你在 A 的构造方法中依赖 B，在 B 的构造方法中依赖 A 是不行的。</p>
<p>至于这两个属性怎么配置？我在附录中进行了介绍，尤其对于覆盖问题，很多人都希望禁止出现 Bean 覆盖，可是 Spring 默认是不同文件的时候可以覆盖的。</p>
<p>之后的源码中还会出现这两个属性，先有个印象就可以了。</p>
<h4 id=loadbeandefinitions加载-bean>loadBeanDefinitions()：加载 Bean</h4>
<p>接下来是最重要的 <code>loadBeanDefinitions(beanFactory)</code> 方法了，这个方法将根据配置，加载各个 Bean，然后放到 BeanFactory 中。</p>
<p>读取配置的操作在 XmlBeanDefinitionReader 中，其负责加载配置、解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 我们可以看到，此方法将通过一个 XmlBeanDefinitionReader 实例来加载各个 Bean。*/</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 给这个 BeanFactory 实例化一个 XmlBeanDefinitionReader
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>beanDefinitionReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XmlBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// Configure the bean definition reader with this context&#39;s
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// resource loading environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 初始化 BeanDefinitionReader，其实这个是提供给子类覆写的，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我看了一下，没有类覆写这个方法，我们姑且当做不重要吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 重点来了，继续往下
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在还在这个类中，接下来用刚刚初始化的 Reader 开始来加载 xml 配置，这块代码读者可以选择性跳过，不是很重要。也就是说，下面这个代码块，读者可以很轻松地略过。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigResources</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigLocations</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 上面虽然有两个分支，不过第二个分支很快通过解析路径转换为 Resource 以后也会进到这里
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Resource array must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 注意这里是个 for 循环，也就是每个文件是一个 resource
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 继续往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 最后返回 counter，表示总共加载了多少的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 303
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 314
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EncodedResource</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;EncodedResource must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading XML bean definitions from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 用一个 ThreadLocal 来存放配置文件资源
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;Detected cyclic loading of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; - check your import definitions!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEncoding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#8f5902;font-style:italic>// 核心部分是这里，往下面看
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;IOException parsing XML document from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 388 行
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这里就不看了，将 xml 文件转换为 Document 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Document</span> <span style=color:#000>doc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doLoadDocument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 继续
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 505 行
</span><span style=color:#8f5902;font-style:italic>// 返回值：返回从当前配置文件加载了多少数量的 Bean
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>BeanDefinitionDocumentReader</span> <span style=color:#000>documentReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinitionDocumentReader</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>countBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 这里
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>documentReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>createReaderContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>countBefore</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XmlReaderContext</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading bean definitions&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Element</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDocumentElement</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 从 xml 根节点开始解析文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>经过漫长的链路，一个配置文件终于转换为一颗 DOM 树了，注意，这里指的是其中一个配置文件，不是所有的，读者可以看到上面有个 for 循环的。下面开始从根节点开始解析：</p>
<h4 id=doregisterbeandefinitions>doRegisterBeanDefinitions()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 我们看名字就知道，BeanDefinitionParserDelegate 必定是一个重要的类，它负责解析 Bean 定义，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里为什么要定义一个 parent? 看到后面就知道了，是递归问题，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 因为 &lt;beans /&gt; 内部是可以定义 &lt;beans /&gt; 的，所以这个方法的 root 其实不一定就是 xml 的根节点，也可以是嵌套在里面的 &lt;beans /&gt; 节点，从源码分析的角度，我们当做根节点就好了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这块说的是根节点 &lt;beans ... profile=&#34;dev&#34; /&gt; 中的 profile 是否是当前环境需要的，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果当前环境配置的 profile 不包含此 profile，那就直接 return 了，不对此 &lt;beans /&gt; 解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 不熟悉 profile 为何物，不熟悉怎么配置 profile 读者的请移步附录区
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PROFILE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specifiedProfiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>acceptsProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specifiedProfiles</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Skipped XML bean definition file due to specified profiles [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] not matching: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>preProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>postProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>preProcessXml(root)</code> 和 <code>postProcessXml(root)</code> 是给子类用的钩子方法，鉴于没有被使用到，也不是我们的重点，我们直接跳过。</p>
<p>这里涉及到了 profile 的问题，对于不了解的读者，我在附录中对 profile 做了简单的解释，读者可以参考一下。接下来，看核心解析方法</p>
<h4 id=parsebeandefinitionsroot-thisdelegate>parseBeanDefinitions(root, this.delegate)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// default namespace 涉及到的就四个标签 &lt;import /&gt;、&lt;alias /&gt;、&lt;bean /&gt; 和 &lt;beans /&gt;，
</span><span style=color:#8f5902;font-style:italic>// 其他的属于 custom 的
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>NodeList</span> <span style=color:#000>nl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Element</span> <span style=color:#000>ele</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析 default namespace 下面的几个元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析其他 namespace 的元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码，我们可以看到，对于每个配置来说，分别进入到 <code>parseDefaultElement(ele, delegate);</code> 和 <code>delegate.parseCustomElement(ele);</code> 这两个分支了。</p>
<p><code>parseDefaultElement(ele, delegate)</code> 代表解析的节点是 <code>&lt;import /></code>、<code>&lt;alias /></code>、<code>&lt;bean /></code>、<code>&lt;beans /></code> 这几个。</p>
<blockquote>
<p>这里的四个标签之所以是 default 的，是因为它们是处于这个 namespace 下定义的：</p>
<p><a href=http://www.springframework.org/schema/beans>http://www.springframework.org/schema/beans</a></p>
<p>又到初学者科普时间，不熟悉 namespace 的读者请看下面贴出来的 xml，这里的第二行 <strong>xmlns</strong> 就是咯。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>            http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>          http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span>
       <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div><p>而对于其他的标签，将进入到 <code>delegate.parseCustomElement(element)</code> 这个分支。如我们经常会使用到的 <code>&lt;mvc /></code>、<code>&lt;task /></code>、<code>&lt;context /></code>、<code>&lt;aop /></code>等。</p>
<p>这些属于扩展，如果需要使用上面这些 ”非 default“ 标签，那么上面的 xml 头部的地方也要引入相应的 namespace 和 .xsd 文件的路径，如下所示。同时代码中需要提供相应的 parser 来解析，如 MvcNamespaceHandler、TaskNamespaceHandler、ContextNamespaceHandler、AopNamespaceHandler 等。</p>
<p>假如读者想分析 <code>&lt;context:property-placeholder location="classpath:xx.properties" /></code> 的实现原理，就应该到 ContextNamespaceHandler 中找答案。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
      <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
      <span style=color:#c4a000>xmlns:context=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/context&#34;</span>
      <span style=color:#c4a000>xmlns:mvc=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/mvc&#34;</span>
      <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans 
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans/spring-beans.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context/spring-context.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc   
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc/spring-mvc.xsd  
</span><span style=color:#4e9a06>       &#34;</span>
      <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div></blockquote>
<p>回过神来，看看处理 default 标签的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IMPORT_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;import /&gt; 标签
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>importBeanDefinitionResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ALIAS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;alias /&gt; 标签定义
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// &lt;alias name=&#34;fromName&#34; alias=&#34;toName&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processAliasRegistration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BEAN_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;bean /&gt; 标签定义，这也算是我们的重点吧
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NESTED_BEANS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果碰到的是嵌套的 &lt;beans /&gt; 标签，需要递归
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果每个标签都说，那我不吐血，你们都要吐血了。我们挑我们的重点 <code>&lt;bean /></code> 标签出来说。</p>
<h4 id=processbeandefinition-解析-bean-标签>processBeanDefinition 解析 bean 标签</h4>
<p>下面是 processBeanDefinition 解析 <code>&lt;bean /></code> 标签：</p>
<p>// DefaultBeanDefinitionDocumentReader.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点中的信息提取出来，然后封装到一个 BeanDefinitionHolder 中，细节往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 下面的几行先不要看，跳过先，跳过先，跳过先，后面会继续说的
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Register the final decorated instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// Send registration event.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继续往下看怎么解析之前，我们先看下 <code>&lt;bean /></code> 标签中可以定义哪些属性：</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>类的全限定名</td>
</tr>
<tr>
<td>name</td>
<td>可指定 id、name(用逗号、分号、空格分隔)</td>
</tr>
<tr>
<td>scope</td>
<td>作用域</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>指定构造参数</td>
</tr>
<tr>
<td>properties</td>
<td>设置属性的值</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(默认值)、byName、byType、 constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>是否懒加载(如果被非懒加载的bean依赖了那么其实也就不能懒加载了)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean 属性设置完成后，会调用这个方法</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean 销毁后的回调方法</td>
</tr>
</tbody>
</table>
<p>上面表格中的内容我想大家都非常熟悉吧，如果不熟悉，那就是你不够了解 Spring 的配置了。</p>
<p>简单地说就是像下面这样子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;exampleBean&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name1, name2, name3&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.javadoop.ExampleBean&#34;</span>
      <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;singleton&#34;</span> <span style=color:#c4a000>lazy-init=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;init&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;cleanup&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- 可以用下面三种形式指定构造参数 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;years&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- property 的几种情况 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanOne&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;ref</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;anotherExampleBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanTwo&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;yetAnotherBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;integerProperty&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>当然，除了上面举例出来的这些，还有 factory-bean、factory-method、<code>&lt;lockup-method /></code>、<code>&lt;replaced-method /></code>、<code>&lt;meta /></code>、<code>&lt;qualifier /></code> 这几个，大家是不是熟悉呢？自己检验一下自己对 Spring 中 bean 的了解程度。</p>
<p>有了以上这些知识以后，我们再继续往里看怎么解析 bean 元素，是怎么转换到 BeanDefinitionHolder 的。</p>
<p>// BeanDefinitionParserDelegate.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>String</span> <span style=color:#000>nameAttr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NAME_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

   <span style=color:#8f5902;font-style:italic>// 将 name 属性的定义按照 “逗号、分号、空格” 切分，形成一个 别名列表数组，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 当然，如果你不定义 name 属性的话，就是空的了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中简单介绍了一下 id 和 name 的配置，大家可以看一眼，有个20秒就可以了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>nameArr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameArr</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有指定id, 那么用别名列表的第一个名字作为beanName
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No XML &#39;id&#39; specified - using &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; as bean name and &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; as aliases&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>checkNameUniqueness</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 根据 &lt;bean ...&gt;...&lt;/bean&gt; 中的配置创建 BeanDefinition，然后把配置中的信息都设置到实例中,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 细节后面细说，先知道下面这行结束后，一个 BeanDefinition 实例就出来了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 到这里，整个 &lt;bean /&gt; 标签就算解析结束了，一个 BeanDefinition 就形成了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果都没有设置 id 和 name，那么此时的 beanName 就会为 null，进入下面这块代码产生
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果读者不感兴趣的话，我觉得不需要关心这块代码，对本文源码分析来说，这些东西不重要
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 按照我们的思路，这里 containingBean 是 null 的
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span>
                     <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 如果我们不定义 id 和 name，那么我们引言里的那个例子：
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   1. beanName 为：com.javadoop.example.MessageServiceImpl#0
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   2. beanClassName 为：com.javadoop.example.MessageServiceImpl
</span><span style=color:#8f5902;font-style:italic></span>
               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>

               <span style=color:#000>String</span> <span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isBeanNameInUse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#8f5902;font-style:italic>// 把 beanClassName 设置为 Bean 的别名
</span><span style=color:#8f5902;font-style:italic></span>                  <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Neither XML &#39;id&#39; nor &#39;name&#39; specified - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;using generated bean name [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliasesArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 返回 BeanDefinitionHolder
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliasesArray</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后，我们再看看怎么根据配置创建 BeanDefinition 实例的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#000>String</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 创建 BeanDefinition，然后设置类信息而已，很简单，就不贴代码了
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanDefinition 的一堆属性，这些属性定义在 AbstractBeanDefinition 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseBeanDefinitionAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDescription</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DomUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildElementValueByTagName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DESCRIPTION_ELEMENT</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>       * 下面的一堆是解析 &lt;bean&gt;......&lt;/bean&gt; 内部的子元素，
</span><span style=color:#8f5902;font-style:italic>       * 解析出来以后的信息都放到 bd 的属性中
</span><span style=color:#8f5902;font-style:italic>       */</span>

      <span style=color:#8f5902;font-style:italic>// 解析 &lt;meta /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseMetaElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;lookup-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseLookupOverrideSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;replaced-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseReplacedMethodSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 解析 &lt;constructor-arg /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseConstructorArgElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;property /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parsePropertyElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;qualifier /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseQualifierElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extractSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoClassDefFoundError</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Class that bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] depends on not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unexpected failure during bean definition parsing&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pop</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经完成了根据 <code>&lt;bean /></code> 配置创建了一个 BeanDefinitionHolder 实例。注意，是一个。</p>
<p>我们回到解析 <code>&lt;bean /></code> 的入口方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点转换为 BeanDefinitionHolder，就是上面说的一堆
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果有自定义属性的话，进行相应的解析，先忽略
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 我们把这步叫做 注册Bean 吧
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 注册完成后，发送事件，本文不展开说这个
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家再仔细看一下这块吧，我们后面就不回来说这个了。这里已经根据一个 <code>&lt;bean /></code> 标签产生了一个 BeanDefinitionHolder 的实例，这个实例里面也就是一个 BeanDefinition 的实例和它的 beanName、aliases 这三个信息，注意，我们的关注点始终在 BeanDefinition 上：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>然后我们准备注册这个 BeanDefinition，最后，把这个注册事件发送出去。</p>
<p>下面，我们开始说说注册 Bean 吧。</p>
<h3 id=注册-bean>注册 Bean</h3>
<p>// BeanDefinitionReaderUtils.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 注册这个 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 如果还有别名的话，也要根据别名全部注册一遍，不然根据别名就会找不到 Bean 了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAliases</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// alias -&gt; beanName 保存它们的别名信息，这个很简单，用一个 map 保存一下就可以了，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 获取的时候，会先将 alias 转换为 beanName，然后再查找
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>别名注册的放一边，毕竟它很简单，我们看看怎么注册 Bean。</p>
<p>// DefaultListableBeanFactory.java 793</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Bean name must not be empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;BeanDefinition must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(...);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// old? 还记得 “允许 bean 覆盖” 这个配置吗？allowBeanDefinitionOverriding
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinition</span> <span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 之后会看到，所有的 Bean 注册后会放入这个 beanDefinitionMap 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 处理重复名称的 Bean 定义的情况
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 如果不允许覆盖的话，抛异常
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()...</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用框架定义的 Bean 覆盖用户自定义的 Bean 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用新的 Bean 覆盖旧的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用同等的 Bean 覆盖旧的 Bean，这里指的是 equals 方法返回 true 的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 判断是否已经有其他的 Bean 开始初始化了.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注意，&#34;注册Bean&#34; 这个动作结束，Bean 依然还没有初始化，我们后面会有大篇幅说初始化过程，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 在 Spring 容器启动的最后，会 预初始化 所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanCreationStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Cannot modify startup-time collection elements anymore (for stable iteration)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedSingletons</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 最正常的应该是进到这个分支。
</span><span style=color:#8f5902;font-style:italic></span>
         <span style=color:#8f5902;font-style:italic>// 将 BeanDefinition 放到这个 map 中，这个 map 保存了所有的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 ArrayList，所以会按照 bean 配置的顺序保存每一个注册的 Bean 的名字
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 LinkedHashSet，代表的是手动注册的 singleton bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 注意这里是 remove 方法，到这里的 Bean 当然不是手动注册的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 手动指的是通过调用以下方法注册的 bean ：
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//     registerSingleton(String beanName, Object singletonObject)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这不是重点，解释只是为了不让大家疑惑。Spring 会在后面&#34;手动&#34;注册一些 Bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 如 &#34;environment&#34;、&#34;systemProperties&#34; 等 bean，我们自己也可以在运行时注册 Bean 到容器中的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 这个不重要，在预初始化的时候会用到，不必管它。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>frozenBeanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>resetBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>总结一下，到这里已经初始化了 Bean 容器，<code>&lt;bean /></code> 配置也相应的转换为了一个个 BeanDefinition，然后注册了各个 BeanDefinition 到注册中心，并且发送了注册事件。</p>
<blockquote>
<p>到这里是一个分水岭，前面的内容都还算比较简单，大家要清楚地知道前面都做了哪些事情。</p>
</blockquote>
<h3 id=bean-容器实例化完成后>Bean 容器实例化完成后</h3>
<p>说到这里，我们回到 refresh() 方法，我重新贴了一遍代码，看看我们说到哪了。是的，我们才说完 <code>obtainFreshBeanFactory()</code> 方法。</p>
<p>考虑到篇幅，这里开始大幅缩减掉没必要详细介绍的部分，大家直接看下面的代码中的注释就好了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
     
      <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 这块待会会展开说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 【这里需要知道 BeanFactoryPostProcessor 这个知识点，Bean 如果实现了此接口，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 那么在容器初始化以后，Spring 会负责调用里面的 postProcessBeanFactory 方法。】
</span><span style=color:#8f5902;font-style:italic></span>        
         <span style=color:#8f5902;font-style:italic>// 这里是提供给子类的扩展点，到这里的时候，所有的 Bean 都加载、注册完成了，但是都还没有初始化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这步的时候添加一些特殊的 BeanFactoryPostProcessor 的实现类或做点什么事
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 回调方法
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>          
         
          

         <span style=color:#8f5902;font-style:italic>// 注册 BeanPostProcessor 的实现类，注意看和 BeanFactoryPostProcessor 的区别
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 此接口两个方法: postProcessBeforeInitialization 和 postProcessAfterInitialization
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 两个方法分别在 Bean 初始化之前和初始化之后得到执行。这里仅仅是注册，之后会看到回调这两方法的时机
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的 MessageSource，国际化这里就不展开说了，不然没完没了了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的事件广播器，这里也不展开了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 从方法名就可以知道，典型的模板方法(钩子方法)，不展开说
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这里初始化一些特殊的 Bean（在初始化 singleton beans 之前）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 注册事件监听器，监听器需要实现 ApplicationListener 接口。这也不是我们的重点，过
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 重点，重点，重点
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 初始化所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//（lazy-init 的除外）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 最后，广播事件，ApplicationContext 初始化完成，不展开
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                  <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>

         <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 销毁已经初始化的 singleton 的 Beans，以免有些 bean 会一直占用资源
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 把异常往外抛
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=准备-bean-容器-preparebeanfactory>准备 Bean 容器: prepareBeanFactory</h3>
<p>之前我们说过，Spring 把我们在 xml 配置的 bean 都注册以后，会"手动"注册一些特殊的 bean。</p>
<p>这里简单介绍下 <code>prepareBeanFactory(factory)</code> 方法：</p>
<h3 id=preparebeanfactoryfactory>prepareBeanFactory(factory)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Configure the factory&#39;s standard context characteristics,
</span><span style=color:#8f5902;font-style:italic> * such as the context&#39;s ClassLoader and post-processors.
</span><span style=color:#8f5902;font-style:italic> * @param beanFactory the BeanFactory to configure
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，我们知道 BeanFactory 需要加载类，也就需要类加载器，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里设置为加载当前 ApplicationContext 类的类加载器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 设置 BeanExpressionResolver
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StandardBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>()));</span>

   <span style=color:#8f5902;font-style:italic>// 添加一个 BeanPostProcessor，这个 processor 比较简单：
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 实现了 Aware 接口的 beans 在初始化的时候，这个 processor 负责回调，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这个我们很常用，如我们会为了获取 ApplicationContext 而 implement ApplicationContextAware
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意：它不仅仅回调 ApplicationContextAware，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//   还会负责回调 EnvironmentAware、ResourceLoaderAware 等，看下源码就清楚了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 下面几行的意思就是，如果某个 bean 依赖于以下几个接口的实现类，在自动装配的时候忽略它们，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// Spring 会通过其他方式来处理这些依赖。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnvironmentAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageSourceAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 下面几行就是为特殊的几个 bean 赋值，如果有 bean 依赖了以下几个，会注入这边相应的值，
</span><span style=color:#8f5902;font-style:italic>    * 之前我们说过，&#34;当前 ApplicationContext 持有一个 BeanFactory&#34;，这里解释了第一行
</span><span style=color:#8f5902;font-style:italic>    * ApplicationContext 还继承了 ResourceLoader、ApplicationEventPublisher、MessageSource
</span><span style=color:#8f5902;font-style:italic>    * 所以对于这几个依赖，可以赋值为 this，注意 this 是一个 ApplicationContext
</span><span style=color:#8f5902;font-style:italic>    * 那这里怎么没看到为 MessageSource 赋值呢？那是因为 MessageSource 被注册成为了一个普通的 bean
</span><span style=color:#8f5902;font-style:italic>    */</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 这个 BeanPostProcessor 也很简单，在 bean 实例化后，如果是 ApplicationListener 的子类，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 那么将其添加到 listener 列表中，可以理解成：注册 事件监听器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationListenerDetector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 这里涉及到特殊的 bean，名为：loadTimeWeaver，这不是我们的重点，忽略它
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// tips: ltw 是 AspectJ 的概念，指的是在运行期进行织入，这个和 Spring AOP 不一样，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//    感兴趣的读者请参考我写的关于 AspectJ 的另一篇文章 https://www.javadoop.com/post/aspectj
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOAD_TIME_WEAVER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// Set a temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextTypeMatchClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 从下面几行代码我们可以知道，Spring 往往很 &#34;智能&#34; 就是因为它会帮我们默认注册一些有用的 bean，
</span><span style=color:#8f5902;font-style:italic>    * 我们也可以选择覆盖
</span><span style=color:#8f5902;font-style:italic>    */</span>

   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;environment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemProperties&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemEnvironment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面这块代码中，Spring 对一些特殊的 bean 进行了处理，读者如果暂时还不能消化它们也没有关系，慢慢往下看。</p>
<h3 id=初始化所有的-singleton-beans>初始化所有的 singleton beans</h3>
<p>我们的重点当然是 <code>finishBeanFactoryInitialization(beanFactory);</code> 这个巨头了，这里会负责初始化所有的 singleton beans。</p>
<p>注意，后面的描述中，我都会使用<strong>初始化</strong>或<strong>预初始化</strong>来代表这个阶段，Spring 会在这个阶段完成所有的 singleton beans 的实例化。</p>
<p>我们来总结一下，到目前为止，应该说 BeanFactory 已经创建完成，并且所有的实现了 BeanFactoryPostProcessor 接口的 Bean 都已经初始化并且其中的 postProcessBeanFactory(factory) 方法已经得到回调执行了。而且 Spring 已经“手动”注册了一些特殊的 Bean，如 ‘environment’、‘systemProperties’ 等。</p>
<p>剩下的就是初始化 singleton beans 了，我们知道它们是单例的，如果没有设置懒加载，那么 Spring 会在接下来初始化所有的 singleton beans。</p>
<p>// AbstractApplicationContext.java 834</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 初始化剩余的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 首先，初始化名字为 conversionService 的 Bean。本着送佛送到西的精神，我在附录中简单介绍了一下 ConversionService，因为这实在太实用了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 什么，看代码这里没有初始化 Bean 啊！
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意了，初始化的动作包装在 beanFactory.getBean(...) 中，这里先不说细节，先往下看吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConversionService</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register a default embedded value resolver if no bean post-processor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// (such as a PropertyPlaceholderConfigurer bean) registered any before:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// at this point, primarily for resolution in annotation attribute values.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringValueResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>resolveStringValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolvePlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 先初始化 LoadTimeWeaverAware 类型的 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 之前也说过，这是 AspectJ 相关的内容，放心跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>weaverAwareNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoadTimeWeaverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>weaverAwareName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>weaverAwareNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weaverAwareName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Stop using the temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 没什么别的目的，因为到这一步的时候，Spring 已经开始预初始化 singleton beans 了，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 肯定不希望这个时候还出现 bean 定义解析、加载、注册。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>freezeConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 开始初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面最后一行往里看，我们就又回到 DefaultListableBeanFactory 这个类了，这个类大家应该都不陌生了吧。</p>
<p>// DefaultListableBeanFactory.java 728</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pre-instantiating singletons in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// this.beanDefinitionNames 保存了所有的 beanNames
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 触发所有的非懒加载的 singleton beans 的初始化操作
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 合并父 Bean 中的配置，注意 &lt;bean id=&#34;&#34; class=&#34;&#34; parent=&#34;&#34; /&gt; 中的 parent，用的不多吧，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 考虑到这可能会影响大家的理解，我在附录中解释了一下 &#34;Bean 继承&#34;，不了解的请到附录中看一下
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 非抽象、非懒加载的 singletons。如果配置了 &#39;abstract = true&#39;，那是不需要初始化的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 处理 FactoryBean(读者如果不熟悉 FactoryBean，请移步附录区了解)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// FactoryBean 的话，在 beanName 前面加上 ‘&amp;’ 符号。再调用 getBean，getBean 方法别急
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FACTORY_BEAN_PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 判断当前 FactoryBean 是否是 SmartFactoryBean 的实现，此处忽略，直接跳过
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#5c35cc;font-weight:700>@Override</span>
                  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 对于普通的 Bean，只要调用 getBean(beanName) 这个方法就可以进行初始化了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>


   <span style=color:#8f5902;font-style:italic>// 到这里说明所有的非懒加载的 singleton beans 已经完成了初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果我们定义的 bean 是实现了 SmartInitializingSingleton 接口的，那么在这里得到回调，忽略
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>singletonInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SmartInitializingSingleton</span> <span style=color:#000>smartSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>singletonInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#5c35cc;font-weight:700>@Override</span>
               <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，我们就进入到 getBean(beanName) 方法了，这个方法我们经常用来从 BeanFactory 中获取一个 Bean，而初始化的过程也封装到了这个方法里。</p>
<h2 id=获取-bean>获取 Bean</h2>
<p>容器和 Bean 已经准备好了，接着就是获取 Bean 去使用了。</p>
<h3 id=俯瞰-getbeanstring-源码>俯瞰 getBean(String) 源码</h3>
<p>在本小节，我们先从战略上俯瞰 getBean(String) 方法的实现源码。代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// getBean 是一个空壳方法，所有的逻辑都封装在 doGetBean 方法中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 通过 name 获取 beanName。这里不使用 name 直接作为 beanName 有两点原因：
</span><span style=color:#8f5902;font-style:italic>     * 1. name 可能会以 &amp; 字符开头，表明调用者想获取 FactoryBean 本身，而非 FactoryBean 
</span><span style=color:#8f5902;font-style:italic>     *    实现类所创建的 bean。在 BeanFactory 中，FactoryBean 的实现类和其他的 bean 存储
</span><span style=color:#8f5902;font-style:italic>     *    方式是一致的，即 &lt;beanName, bean&gt;，beanName 中是没有 &amp; 这个字符的。所以我们需要
</span><span style=color:#8f5902;font-style:italic>     *    将 name 的首字符 &amp; 移除，这样才能从缓存里取到 FactoryBean 实例。
</span><span style=color:#8f5902;font-style:italic>     * 2. 若 name 是一个别名，则应将别名转换为具体的实例名，也就是 beanName。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 注意跟着这个，这个是返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 从缓存中获取单例 bean。Spring 是使用 Map 作为 beanName 和 bean 实例的缓存的，所以这
</span><span style=color:#8f5902;font-style:italic>     * 里暂时可以把 getSingleton(beanName) 等价于 beanMap.get(beanName)。当然，实际的
</span><span style=color:#8f5902;font-style:italic>     * 逻辑并非如此简单，后面再细说。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。
</span><span style=color:#8f5902;font-style:italic>     * BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取 
</span><span style=color:#8f5902;font-style:italic>     * bean 时再实例化，也就是懒加载。
</span><span style=color:#8f5902;font-style:italic>     * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取
</span><span style=color:#8f5902;font-style:italic>     * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数
</span><span style=color:#8f5902;font-style:italic>     * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有
</span><span style=color:#8f5902;font-style:italic>     * 用了，BeanFactory 不会多次实例化单例 bean。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果 
</span><span style=color:#8f5902;font-style:italic>         * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的 
</span><span style=color:#8f5902;font-style:italic>         * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回
</span><span style=color:#8f5902;font-style:italic>         * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean 
</span><span style=color:#8f5902;font-style:italic>     * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例
</span><span style=color:#8f5902;font-style:italic>     * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 如果 sharedInstance = null，则到父容器中查找 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 name 对应的 beanName，如果 name 是以 &amp; 字符开头，则返回 &amp; + beanName
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 根据 args 是否为空，以决定调用父容器哪个方法获取 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 返回父容器的查询结果
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> 
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

       <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>       * 稍稍总结一下：
</span><span style=color:#8f5902;font-style:italic>       * 到这里的话，要准备创建 Bean 了，对于 singleton 的 Bean 来说，容器中还没创建过此 Bean；
</span><span style=color:#8f5902;font-style:italic>       * 对于 prototype 的 Bean 来说，本来就是要创建一个新的 Bean。
</span><span style=color:#8f5902;font-style:italic>       */</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并父 BeanDefinition 与子 BeanDefinition，后面会单独分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，
</span><span style=color:#8f5902;font-style:italic>                     * B 又依赖 A，他们的配置如下：
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanA&#34; class=&#34;BeanA&#34; depends-on=&#34;beanB&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanB&#34; class=&#34;BeanB&#34; depends-on=&#34;beanA&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   
</span><span style=color:#8f5902;font-style:italic>                     * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它
</span><span style=color:#8f5902;font-style:italic>                     * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接
</span><span style=color:#8f5902;font-style:italic>                     * 抛出异常
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; and &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 注册依赖记录
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 先初始化被依赖项 加载 depends-on 依赖 
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> 
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过 
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法会在内部调用 
</span><span style=color:#8f5902;font-style:italic>                 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，
</span><span style=color:#8f5902;font-style:italic>                 * 将 bean 放入缓存中。关于 getSingleton 方法的分析，本文先不展开，我会在
</span><span style=color:#8f5902;font-style:italic>                 * 后面的文章中进行分析
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
                <span style=color:#8f5902;font-style:italic>// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 prototype 类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建其他类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@Override</span>
                        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Scope &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 如果需要进行类型转换，则在此处进行转换。类型转换这一块我没细看，就不多说了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQualifiedName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=createbean>createBean</h3>
<p>大家应该也猜到了，接下来当然是分析 createBean 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>第三个参数 args 数组代表创建实例需要的参数，不就是给构造方法用的参数，或者是工厂 Bean 的参数嘛，不过要注意，在我们的初始化阶段，args 是 null。</p>
<p>这回我们要到一个新的类了 AbstractAutowireCapableBeanFactory，看类名，AutowireCapable？类名是不是也说明了点问题了。</p>
<p>主要是为了以下场景，采用 @Autowired 注解注入属性值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserService</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;messageService&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;com.example.MessageServiceImpl&#34;</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</code></pre></div><p>以上这种属于混用了 xml 和 注解 两种方式的配置方式，Spring 会处理这种情况。</p>
<p>好了，读者要知道这么回事就可以了，继续向前。</p>
<p>// AbstractAutowireCapableBeanFactory.java 447</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Central method of this class: creates a bean instance,
</span><span style=color:#8f5902;font-style:italic> * populates the bean instance, applies post-processors, etc.
</span><span style=color:#8f5902;font-style:italic> * @see #doCreateBean
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 确保 BeanDefinition 中的 Class 被加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 准备方法覆写，这里又涉及到一个概念：MethodOverrides，它来自于 bean 定义中的 &lt;lookup-method /&gt; 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 和 &lt;replaced-method /&gt;，如果读者感兴趣，回到 bean 解析的地方看看对这两个标签的解析。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中也对这两个标签的相关知识点进行了介绍，读者可以移步去看看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Validation of method overrides failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 让 InstantiationAwareBeanPostProcessor 在这一步有机会返回代理，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span> 
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 重头戏，创建 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finished creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们继续往里看 doCreateBean 这个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// Instantiate the bean.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanInstanceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 说明不是 FactoryBean，这里实例化 Bean，这里非常关键，细节之后再说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 这个就是 Bean 里面的 我们定义的类 的实例，很多地方我直接描述成 &#34;bean 实例&#34;
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 类型
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedTargetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 建议跳过吧，涉及接口：MergedBeanDefinitionPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// MergedBeanDefinitionPostProcessor，这个我真不展开说了，直接跳过吧，很少用的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                  <span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Eagerly cache singletons to be able to resolve circular references
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// even when triggered by lifecycle interfaces like BeanFactoryAware.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 下面这块代码是为了解决循环依赖的问题
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize the bean instance.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这一步也是非常关键的，这一步负责属性装配，因为前面的实例只是实例化了，并没有设值，这里就是设值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 还记得 init-method 吗？还有 InitializingBean 接口？还有 BeanPostProcessor 接口？
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这里就是处理 bean 初始化完成后的各种回调
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowRawInjectionDespiteWrapping</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#4e9a06>&#34;Bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collectionToCommaDelimitedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register bean as disposable.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经分析完了 doCreateBean 方法，总的来说，我们已经说完了整个初始化流程。</p>
<p>接下来我们挑 doCreateBean 中的三个细节出来说说。</p>
<p>一个是创建 Bean 实例的 createBeanInstance 方法，一个是依赖注入的 populateBean 方法，还有就是回调方法 initializeBean。</p>
<p>注意了，接下来的这三个方法要认真说那也是极其复杂的，很多地方我就点到为止了，感兴趣的读者可以自己往里看，最好就是碰到不懂的，自己写代码去调试它。</p>
<h4 id=创建-bean-实例>创建 Bean 实例</h4>
<p>我们先看看 createBeanInstance 方法。需要说明的是，这个方法如果每个分支都分析下去，必然也是极其复杂冗长的，我们挑重点说。此方法的目的就是实例化我们指定的类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 确保已经加载了此 class
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 校验一下这个类的访问权限
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;Bean class isn&#39;t public, and non-public access not allowed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 采用工厂方法实例化，不熟悉这个概念的读者请看附录，注意，不是 FactoryBean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateUsingFactoryMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 如果不是第一次创建，比如第二次创建 prototype bean。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这种情况下，我们可以从第一次创建知道，采用无参构造函数，还是构造函数依赖注入 来完成实例化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowireNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 判断是否采用有参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineConstructorsFromBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 调用无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>挑个简单的<strong>无参构造函数</strong>构造实例来看看：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 实例化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 包装一下，返回
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到，关键的地方在于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里会进行实际的实例化过程，我们进去看看:</p>
<p>// SimpleInstantiationStrategy 59</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 如果不存在方法覆写，那就使用 java 反射进行实例化，否则使用 CGLIB,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 方法覆写 请参见附录&#34;方法注入&#34;中对 lookup-method 和 replaced-method 的介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Specified class is an interface&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#5c35cc;font-weight:700>@Override</span>
                     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                     <span style=color:#ce5c00;font-weight:700>}</span>
                  <span style=color:#ce5c00;font-weight:700>});</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No default constructor found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 利用构造方法进行实例化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存在方法覆写，利用 CGLIB 来完成实例化，需要依赖于 CGLIB 生成子类，这里就不展开了。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// tips: 因为如果不使用 CGLIB 的话，存在 override 的情况 JDK 并没有提供相应的实例化支持
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateWithMethodInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们就算实例化完成了。我们开始说怎么进行属性注入。</p>
<h4 id=bean-属性注入>bean 属性注入</h4>
<p>看完了 createBeanInstance(&mldr;) 方法，我们来看看 populateBean(&mldr;) 方法，该方法负责进行属性设值，处理依赖。</p>
<p>// AbstractAutowireCapableBeanFactory 1203</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// bean 实例的所有属性都在这里了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Cannot apply property values to null instance&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Skip property population phase for null instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 到这步的时候，bean 实例化完成（通过工厂方法或构造方法），但是还没开始属性设值，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// InstantiationAwareBeanPostProcessor 的实现类可以在这里对 bean 进行状态修改，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我也没找到有实际的使用，所以我们暂且忽略这块吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 如果返回 false，代表不需要进行后续的属性设值，也不需要再经过其他的 BeanPostProcessor 的处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>continueWithPropertyPopulation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>newPvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 通过名字找到所有属性值，如果是 bean 依赖，先初始化依赖的 bean。记录依赖关系
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// 通过类型装配。复杂一些
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsDepCheck</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyCheck</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPENDENCY_CHECK_NONE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredPds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>filterPropertyDescriptorsForDependencyCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCaching</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#8f5902;font-style:italic>// 这里有个非常有用的 BeanPostProcessor 进到这里: AutowiredAnnotationBeanPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>// 对采用 @Autowired、@Value 注解的依赖进行设值，这里的内容也是非常丰富的，不过本文不会展开说了，感兴趣的读者请自行研究
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>checkDependencies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 设置 bean 实例的属性值
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=initializebean>initializeBean</h4>
<p>属性注入完成后，这一步其实就是处理各种回调了，这块代码比较简单。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果 bean 实现了 BeanNameAware、BeanClassLoaderAware 或 BeanFactoryAware 接口，回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>Object</span> <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessBeforeInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 bean 中定义的 init-method，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 或者如果 bean 实现了 InitializingBean 接口，调用 afterPropertiesSet() 方法
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invocation of init method failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessAfterInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家发现没有，BeanPostProcessor 的两个回调都发生在这边，只不过中间处理了 init-method，是不是和读者原来的认知有点不一样了？</p>
<h2 id=相关疑问>相关疑问</h2>
<h4 id=spring-的-bean-在什么时候实例化>Spring 的 bean 在什么时候实例化?</h4>
<p>如果你使用BeanFactory，如 XmlBeanFactory 作为 Spring Bean 的工厂类，则所有的 bean 都是在第一次使用该bean 的时候实例化 。</p>
<p>如果你使用 ApplicationContext 作为 Spring Bean 的工厂类，则又分为以下几种情况：</p>
<ol>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 false（默认是false，所以可以不用设置），则ApplicationContext 启动的时候就实例化该 bean，并且将实例化的 bean 放在一个线程安全的 ConcurrentHashMap 结构的缓存中，下次再使用该 Bean 的时候，直接从这个缓存中取</li>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 true，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化</li>
<li>如果 bean 的 scope 是 prototype 的，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化 。</li>
</ol>
<style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style>
<div class=d-print-none>
<h2 class=feedback--title>Feedback</h2>
<p class=feedback--question>Was this page helpful?</p>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
Glad to hear it! Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
Sorry to hear that. Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
</div>
<script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script>
<br>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>