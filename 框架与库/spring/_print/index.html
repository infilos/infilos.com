<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Spring | infilos.com</title><meta property="og:title" content="Spring">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Spring">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Spring">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Spring</h1>
<ul>
<li>1: <a href=#pg-0b0012bf149a4cf96b8074281a8541a8>CH01-IOC</a></li>
<li>2: <a href=#pg-2a6c4c04bf13071ae484b315e9244cd2>CH02-Spring IOC</a></li>
<li>3: <a href=#pg-7202eaa44b8f3d3daee17478a4ca42ec>CH03-Bean加载</a></li>
<li>4: <a href=#pg-a8a1a8038660c1cf3b1cbee6a84a454c>CH04-IOC源码</a></li>
<li>5: <a href=#pg-7f4178b3d93842e955c6e1949a1a8205>CH05-循环依赖</a></li>
<li>6: <a href=#pg-c6fbf53ed8e298648885933a5a812487>CH07-动态代理</a></li>
<li>7: <a href=#pg-0460c594127706aa4329eb8831b746b4>CH08-接口定义</a></li>
<li>8: <a href=#pg-914aed954c02642f85974bcb8e314a42>CH09-请求过程</a></li>
<li>9: <a href=#pg-f318ab73b27584f92427d5fdaeaa969e>CH10-配置注入</a></li>
<li>10: <a href=#pg-edd784317807198b5ce95957ab1805fa>CH11-配置绑定</a></li>
<li>11: <a href=#pg-72976b5fc4d547c63c1244ea27bda80b>CH12-环境变量</a></li>
<li>12: <a href=#pg-ab6686a9d87d82772b5814cec7a2b8ef>CH13-缓存注解</a></li>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-0b0012bf149a4cf96b8074281a8541a8>1 - CH01-IOC</h1>
<h2 id=ioc-是什么>IOC 是什么</h2>
<p>**IoC，是 Inversion of Control 的缩写，即控制反转。*<em>他还有一个别名叫*<em>依赖注入</em></em>（Dependency Injection）有些资料也称依赖注入是IOC的一种常见方式。</p>
<p>IoC 不是什么技术，而是一种设计思想。在 Java 开发中，IoC 意味着将你设计好的对象交给容器控制，而不是传统的在你的对象内部直接控制。如何理解 Ioc 呢？理解 Ioc 的关键是要明确“谁控制谁，控制什么，为何是反转（有反转就应该有正转了），哪些方面反转了”，那我们来深入分析一下：</p>
<ul>
<li>**谁控制谁，控制什么：**传统 JavaSE 程序设计，我们直接在对象内部通过 new 进行创建对象，是程序主动去创建依赖对象；而 IoC 是有专门一个容器来创建这些对象，即由 IoC 容器来控制对象的创建；谁控制谁？当然是 IoC 容器控制了对象；控制什么？那就是主要控制了外部资源获取（不只是对象包括比如文件等）。</li>
<li>**为何是反转，哪些方面反转了：**有反转就有正转，传统应用程序是由我们自己在对象中主动控制去直接获取依赖对象，也就是正转；而反转则是由容器来帮忙创建及注入依赖对象；为何是反转？因为由容器帮我们查找及注入依赖对象，对象只是被动的接受依赖对象，所以是反转；哪些方面反转了？依赖对象的获取方式被反转了。</li>
</ul>
<h2 id=ioc-能做什么>IOC 能做什么</h2>
<p>IoC 不是一种技术，只是一种思想，一个重要的面向对象编程的法则，它能指导我们如何设计出松耦合、更优良的程序。传统应用程序都是由我们在类内部主动创建依赖对象，从而导致类与类之间高耦合，难于测试；有了 IoC 容器后，把创建和查找依赖对象的控制权交给了容器，由容器进行注入组合对象，所以对象与对象之间是松散耦合，这样也方便测试，利于功能复用，更重要的是使得程序的整个体系结构变得非常灵活。</p>
<p>其实 IoC 对编程带来的最大改变不是从代码上，而是从思想上，发生了“主从换位”的变化。应用程序原本是老大，要获取什么资源都是主动出击，但是在 IoC/DI 思想中，应用程序就变成被动的了，被动的等待 IoC 容器来创建并注入它所需要的资源了。</p>
<p>IoC 很好的体现了面向对象设计法则之一—— 好莱坞法则：“Don&rsquo;t call us,we will call you”；即由 IoC 容器帮对象找相应的依赖对象并注入，而不是由对象主动去找。</p>
<h3 id=依赖注入>依赖注入</h3>
<p>DI，是 <strong>Dependency Injection</strong> 的缩写，即依赖注入。依赖注入是 IoC 的最常见形式。</p>
<p>容器全权负责的组件的装配，它会把符合依赖关系的对象通过 JavaBean 属性或者构造函数传递给需要的对象。</p>
<p>DI 是组件之间依赖关系由容器在运行期决定，形象的说，即由容器动态的将某个依赖关系注入到组件之中。依赖注入的目的并非为软件系统带来更多功能，而是为了提升组件重用的频率，并为系统搭建一个灵活、可扩展的平台。通过依赖注入机制，我们只需要通过简单的配置，而无需任何代码就可指定目标需要的资源，完成自身的业务逻辑，而不需要关心具体的资源来自何处，由谁实现。</p>
<p>理解 DI 的关键是：“谁依赖谁，为什么需要依赖，谁注入谁，注入了什么”，那我们来深入分析一下：</p>
<ul>
<li>**谁依赖于谁：**当然是应用程序依赖于 IoC 容器；</li>
<li>**为什么需要依赖：**应用程序需要 IoC 容器来提供对象需要的外部资源；</li>
<li>**谁注入谁：**很明显是 IoC 容器注入应用程序某个对象，应用程序依赖的对象；</li>
<li><strong>注入了什么</strong>：就是注入某个对象所需要的外部资源（包括对象、资源、常量数据）。</li>
</ul>
<h3 id=ioc-与-di>IOC 与 DI</h3>
<p>其实它们是同一个概念的不同角度描述，由于控制反转概念比较含糊（可能只是理解为容器控制对象这一个层面，很难让人想到谁来维护对象关系），所以 2004 年大师级人物 Martin Fowler 又给出了一个新的名字：“依赖注入”，相对 IoC 而言，“依赖注入”明确描述了“被注入对象依赖 IoC 容器配置依赖对象”。</p>
<blockquote>
<p><a href=http://www.martinfowler.com/articles/injection.html>Martin Fowler—Inversion of Control Containers and the Dependency Injection pattern</a></p>
</blockquote>
<h3 id=ioc-容器>IOC 容器</h3>
<p>IoC 容器就是具有依赖注入功能的容器。IoC 容器负责实例化、定位、配置应用程序中的对象及建立这些对象间的依赖。应用程序无需直接在代码中 new 相关的对象，应用程序由 IoC 容器进行组装。在 Spring 中 BeanFactory 是 IoC 容器的实际代表者。</p>
<p>Spring IoC 容器如何知道哪些是它管理的对象呢？这就需要配置文件，Spring IoC 容器通过读取配置文件中的配置元数据，通过元数据对应用中的各个对象进行实例化及装配。一般使用基于 xml 配置文件进行配置元数据，而且 Spring 与配置文件完全解耦的，可以使用其他任何可能的方式进行配置元数据，比如注解、基于 java 文件的、基于属性文件的配置都可以</p>
<p>那 Spring IoC 容器管理的对象叫什么呢？</p>
<h3 id=bean>Bean</h3>
<p>JavaBean 是一种JAVA语言写成的可重用组件。为写成JavaBean，类必须是具体的和公共的，并且具有<strong>无参数的构造器</strong>。JavaBean 通过提供符合一致性设计模式的公共方法（getter / setter 方法）将内部域暴露成员属性。众所周知，属性名称符合这种模式，其他Java 类可以通过自省机制发现和操作这些JavaBean 的属性。</p>
<p>一个javaBean由三部分组成：<strong>属性、方法、事件</strong></p>
<p>JavaBean的任务就是: “Write once, run anywhere, reuse everywhere”，即“一次性编写，任何地方执行，任何地方重用”。</p>
<p>由 IoC 容器管理的那些组成你应用程序的对象我们就叫它 Bean。Bean 就是由 Spring 容器初始化、装配及管理的对象，除此之外，bean 就与应用程序中的其他对象没有什么区别了。</p>
<h2 id=ioc-容器-1>IOC 容器</h2>
<h3 id=核心接口>核心接口</h3>
<p><code>org.springframework.beans</code> 和 <code>org.springframework.context</code> 是 IoC 容器的基础。</p>
<p>在 Spring 中，有两种 IoC 容器：<code>BeanFactory</code> 和 <code>ApplicationContext</code>。</p>
<ul>
<li><code>BeanFactory</code>：Spring 实例化、配置和管理对象的最基本接口。</li>
<li><code>ApplicationContext</code>：BeanFactory 的子接口。它还扩展了其他一些接口，以支持更丰富的功能，如：国际化、访问资源、事件机制、更方便的支持 AOP、在 web 应用中指定应用层上下文等。</li>
</ul>
<p>实际开发中，更推荐使用 <code>ApplicationContext</code> 作为 IoC 容器的操作入口，因为它的功能远多于 <code>FactoryBean</code>。</p>
<p>常见 <code>ApplicationContext</code> 实现：</p>
<ul>
<li><strong>ClassPathXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从 classpath 获取配置文件；
<ul>
<li><code>new ClassPathXmlApplicationContext("classpath.xml");</code></li>
</ul>
</li>
<li><strong>FileSystemXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从文件系统获取配置文件。
<ul>
<li><code>new FileSystemXmlApplicationContext("fileSystemConfig.xml");</code></li>
</ul>
</li>
</ul>
<h3 id=应用流程>应用流程</h3>
<p>使用 IoC 容器可分为三步骤：</p>
<ol>
<li>配置元数据：需要配置一些元数据来告诉 Spring，你希望容器如何工作，具体来说，就是如何去初始化、配置、管理 JavaBean 对象。</li>
<li>实例化容器：由 IoC 容器解析配置的元数据。IoC 容器的 Bean Reader 读取并解析配置文件，根据定义生成 BeanDefinition 配置元数据对象，IoC 容器根据 BeanDefinition 进行实例化、配置及组装 Bean。</li>
<li>使用容器：由客户端实例化容器，获取需要的 Bean。</li>
</ol>
<h3 id=配置元数据>配置元数据</h3>
<blockquote>
<p><strong>元数据（Metadata）</strong> 又称中介数据、中继数据，为描述数据的数据（data about data），主要是描述数据属性（property）的信息。</p>
</blockquote>
<p>配置元数据的方式：</p>
<ul>
<li>
<p><strong>基于 xml 配置</strong>：Spring 的传统配置方式。在 <code>&lt;beans></code> 标签中配置元数据内容。</p>
<p>缺点是当 JavaBean 过多时，产生的配置文件足以让你眼花缭乱。</p>
</li>
<li>
<p><strong>基于注解配置</strong>：Spring2.5 引入。可以大大简化你的配置。</p>
</li>
<li>
<p><strong>基于 Java 配置</strong>：可以使用 Java 类来定义 JavaBean 。</p>
<p>为了使用这个新特性，需要用到 <code>@Configuration</code> 、<code>@Bean</code> 、<code>@Import</code> 和 <code>@DependsOn</code> 注解。</p>
</li>
</ul>
<h3 id=bean-概述>Bean 概述</h3>
<p>一个 Spring 容器管理一个或多个 bean。 这些 bean 根据你配置的元数据（比如 xml 形式）来创建。 Spring IoC 容器本身，并不能识别你配置的元数据。为此，要将这些配置信息转为 Spring 能识别的格式——BeanDefinition 对象。</p>
<h4 id=命名-bean>命名 Bean</h4>
<p>指定 id 和 name 属性不是必须的。 Spring 中，并非一定要指定 id 和 name 属性。实际上，Spring 会自动为其分配一个特殊名。 如果你需要引用声明的 bean，这时你才需要一个标识。官方推荐驼峰命名法来命名。</p>
<h4 id=支持别名>支持别名</h4>
<p>可能存在这样的场景，不同系统中对于同一 bean 的命名方式不一样。 为了适配，Spring 支持 <code>&lt;alias></code> 为 bean 添加别名的功能。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;subsystemA-dataSource&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;subsystemB-dataSource&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;subsystemA-dataSource&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;myApp-dataSource&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h4 id=实例化-bean>实例化 Bean</h4>
<p><strong>构造器方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;exampleBean&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;examples.ExampleBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p><strong>静态工厂方法</strong></p>
<h3 id=依赖>依赖</h3>
<p>依赖注入 依赖注入有两种主要方式：</p>
<ul>
<li>构造器注入</li>
<li>Setter 注入 构造器注入有可能出现循环注入的错误。如：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>B</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>){}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>B</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>){}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>依赖和配置细节</strong> 使用 depends-on Lazy-initialized Bean 自动装配 方法注入。</p>
<h2 id=ioc-容器配置>IoC 容器配置</h2>
<p>IoC 容器的配置有三种方式：</p>
<ul>
<li>基于 xml 配置</li>
<li>基于注解配置</li>
<li>基于 Java 配置</li>
</ul>
<p>作为 Spring 传统的配置方式，xml 配置方式一般为大家所熟知。</p>
<p>如果厌倦了 xml 配置，Spring 也提供了注解配置方式或 Java 配置方式来简化配置。</p>
<h3 id=xml-配置>Xml 配置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>         http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;resource1.xml&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;bean1&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;bean2&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;bean2&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;&lt;/bean&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;bean3&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;bean2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;resource2.xml&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</code></pre></div><p>标签说明：</p>
<ul>
<li><code>&lt;beans></code> 是 Spring 配置文件的根节点。</li>
<li><code>&lt;bean></code> 用来定义一个 JavaBean。<code>id</code> 属性是它的标识，在文件中必须唯一；<code>class</code> 属性是它关联的类。</li>
<li><code>&lt;alias></code> 用来定义 Bean 的别名。</li>
<li><code>&lt;import></code> 用来导入其他配置文件的 Bean 定义。这是为了加载多个配置文件，当然也可以把这些配置文件构造为一个数组（new String[] {“config1.xml”, config2.xml}）传给 <code>ApplicationContext</code> 实现类进行加载多个配置文件，那一个更适合由用户决定；这两种方式都是通过调用 Bean Definition Reader 读取 Bean 定义，内部实现没有任何区别。<code>&lt;import></code> 标签可以放在 <code>&lt;beans></code> 下的任何位置，没有顺序关系。</li>
</ul>
<h4 id=实例化容器>实例化容器</h4>
<p>实例化容器的过程： 定位资源（XML 配置文件） 读取配置信息(Resource) 转化为 Spring 可识别的数据形式（BeanDefinition）</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;services.xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;daos.xml&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
</code></pre></div><p>组合 xml 配置文件 配置的 Bean 功能各不相同，都放在一个 xml 文件中，不便管理。 Java 设计模式讲究职责单一原则。配置其实也是如此，功能不同的 JavaBean 应该被组织在不同的 xml 文件中。然后使用 import 标签把它们统一导入。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;classpath:spring/applicationContext.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;import</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;/WEB-INF/spring/service.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h4 id=使用容器>使用容器</h4>
<p>使用容器的方式就是通过<code>getBean</code>获取 IoC 容器中的 JavaBean。 Spring 也有其他方法去获得 JavaBean，但是 Spring 并不推荐其他方式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// create and configure beans
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ApplicationContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;services.xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;daos.xml&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#8f5902;font-style:italic>// retrieve configured instance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>PetStoreService</span> <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;petStore&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PetStoreService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// use configured instance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>userList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsernameList</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=注解配置>注解配置</h3>
<p>Spring2.5 引入了注解。 <strong>优点</strong>：大大减少了配置，并且可以使配置更加精细——类，方法，字段都可以用注解去标记。 <strong>缺点</strong>：使用注解，不可避免产生了侵入式编程，也产生了一些问题。</p>
<ul>
<li>你需要将注解加入你的源码并编译它；</li>
<li>注解往往比较分散，不易管控。</li>
</ul>
<blockquote>
<p>注：spring 中，先进行注解注入，然后才是 xml 注入，因此如果注入的目标相同，后者会覆盖前者。</p>
</blockquote>
<h4 id=启动注解>启动注解</h4>
<p>Spring 默认是不启用注解的。如果想使用注解，需要先在 xml 中启动注解。 启动方式：在 xml 中加入一个标签，很简单吧。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context:annotation-config/&gt;</span>
</code></pre></div><blockquote>
<p>注：<code>&lt;context:annotation-config/></code> 只会检索定义它的上下文。什么意思呢？就是说，如果你 为 DispatcherServlet 指定了一个<code>WebApplicationContext</code>，那么它只在 controller 中查找<code>@Autowired</code>注解，而不会检查其它的路径。</p>
</blockquote>
<h4 id=spring-注解>Spring 注解</h4>
<ul>
<li><strong><code>@Required</code></strong>：只能用于修饰 bean 属性的 setter 方法。受影响的 bean 属性必须在配置时被填充在 xml 配置文件中，否则容器将抛出<code>BeanInitializationException</code>。</li>
<li><strong><code>@Autowired</code></strong>：可用于修饰属性、setter 方法、构造方法。
<ul>
<li>可以使用 JSR330 的注解<code>@Inject</code>来替代<code>@Autowired</code>。</li>
</ul>
</li>
<li><strong><code>@Qualifier</code></strong>：如果发现有多个候选的 bean 都符合修饰类型，指定 bean 名称来锁定真正需要的那个 bean。</li>
<li>JSR 250 注解
<ul>
<li><code>@Resource</code></li>
<li><strong><code>@PostConstruct</code> 和 <code>@PreDestroy</code></strong></li>
</ul>
</li>
<li>JSR 330 注解
<ul>
<li><code>@Inject</code></li>
</ul>
</li>
</ul>
<h3 id=java-配置>Java 配置</h3>
<p>基于 Java 配置 Spring IoC 容器，实际上是 Spring 允许用户定义一个类，在这个类中去管理 IoC 容器的配置。</p>
<p>为了让 Spring 识别这个定义类为一个 Spring 配置类，需要用到两个注解：<code>@Configuration</code> 和 <code>@Bean</code>。</p>
<p>如果你熟悉 Spring 的 xml 配置方式，你可以将 <code>@Configuration</code> 等价于 <code>&lt;beans></code> 标签；将 <code>@Bean</code> 等价于 <code>&lt;bean></code> 标签。</p>
<h4 id=bean-1>@Bean</h4>
<ul>
<li>
<p>@Bean 的修饰目标只能是方法或注解。</p>
</li>
<li>
<p>@Bean 只能定义在@Configuration 或@Component 注解修饰的类中。</p>
</li>
<li>
<p>@Configuration 类允许在同一个类中通过@Bean 定义内部 bean 依赖。</p>
</li>
<li>
<p>声明一个 bean，只需要在 bean 属性的 set 方法上标注@Bean 即可。</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotationConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Job</span> <span style=color:#000>getPolice</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Police</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Job</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Component</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;police&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Police</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Job</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;抓罪犯&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=configuration>@Configuration</h4>
<p><code>@Configuration</code> 是一个类级别的注解，用来标记被修饰类的对象是一个<code>BeanDefinition</code>。</p>
<p><code>@Configuration</code> 声明 bean 是通过被 <code>@Bean</code> 修饰的公共方法。此外，<code>@Configuration</code> 允许在同一个类中通过 <code>@Bean</code> 定义内部 bean 依赖。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyService</span> <span style=color:#000>myService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyServiceImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2a6c4c04bf13071ae484b315e9244cd2>2 - CH02-Spring IOC</h1>
<h2 id=基本概念>基本概念</h2>
<p>IoC（Inverse of Control:控制反转）是一种<strong>设计思想</strong>，就是 <strong>将原本在程序中手动创建对象的控制权，交由Spring框架来管理</strong>。 IoC 在其他语言中也有应用，并非 Spring 特有。 <strong>IoC 容器是 Spring 用来实现 IoC 的载体， IoC 容器实际上就是个Map（key，value），Map 中存放的是各种对象</strong>。</p>
<p>将对象之间的相互依赖关系交给 IoC 容器来管理，并由 IoC 容器完成对象的注入。这样可以很大程度上简化应用的开发，把应用从复杂的依赖关系中解放出来。 <strong>IoC 容器就像是一个工厂一样，当我们需要创建一个对象的时候，只需要配置好配置文件/注解即可，完全不用考虑对象是如何被创建出来的。</strong> 在实际项目中一个 Service 类可能有几百甚至上千个类作为它的底层，假如我们需要实例化这个 Service，你可能要每次都要搞清这个 Service 所有底层类的构造函数，这可能会把人逼疯。如果利用 IoC 的话，你只需要配置好，然后在需要的地方引用就行了，这大大增加了项目的可维护性且降低了开发难度。</p>
<p>Spring IOC 通过引入 xml 配置，由 IOC 容器来管理对象的生命周期，依赖关系等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503105756.png style=display:block;width:50% alt=NAME align=center> </div>
<p>从图中可以看出，我们以前获取两个有依赖关系的对象，要用 set 方法，而用容器之后，它们之间的关系就由容器来管理。</p>
<h2 id=什么是-spring-ioc-容器>什么是 Spring IOC 容器？</h2>
<p>Spring 框架的核心是 Spring 容器。容器创建对象，将它们装配在一起，配置它们并管理它们的完整生命周期。Spring 容器使用<strong>依赖注入</strong>来管理组成应用程序的组件。容器通过读取提供的配置元数据来接收对象进行实例化，配置和组装的指令。该元数据可以通过 XML，Java 注解或 Java 代码提供。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503105847.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=什么是依赖注入>什么是依赖注入？</h2>
<p><strong>依赖注入（DI,Dependency Injection）是在编译阶段尚未知所需的功能是来自哪个的类的情况下，将其他对象所依赖的功能对象实例化的模式</strong>。这就需要一种机制用来激活相应的组件以提供特定的功能，所以<strong>依赖注入是控制反转的基础</strong>。否则如果在组件不受框架控制的情况下，框架又怎么知道要创建哪个组件？</p>
<p>依赖注入有以下三种实现方式：</p>
<ol>
<li>构造器注入</li>
<li>Setter方法注入（属性注入）</li>
<li>接口注入</li>
</ol>
<h2 id=spring-中有多少种-ioc-容器>Spring 中有多少种 IOC 容器？</h2>
<p>在 Spring IOC 容器读取 Bean 配置创建 Bean 实例之前，必须对它进行实例化。只有在容器实例化后， 才可以从 IOC 容器里获取 Bean 实例并使用。</p>
<p>Spring 提供了两种类型的 IOC 容器实现</p>
<ul>
<li><strong>BeanFactory</strong>：IOC 容器的基本实现</li>
<li><strong>ApplicationContext</strong>：提供了更多的高级特性，是 BeanFactory 的子接口</li>
</ul>
<p>BeanFactory 是 Spring 框架的基础设施，面向 Spring 本身；ApplicationContext 面向使用 Spring 框架的开发者，几乎所有的应用场合都直接使用 ApplicationContext 而非底层的 BeanFactory；</p>
<p>无论使用何种方式，配置文件是相同的。</p>
<h2 id=beanfactory>BeanFactory</h2>
<p>BeanFactory，从名字上可以看出来它是 bean 的工厂，它负责生产和管理各个 bean 实例。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503110013.png style=display:block;width:50% alt=NAME align=center> </div>
<p>大概了解下这里提到的几个类：</p>
<ul>
<li><strong>ListableBeanFactory</strong>：这个 Listable 的意思就是，通过这个接口，我们可以获取多个 Bean，大家看源码会发现，最顶层 BeanFactory 接口的方法都是获取单个 Bean 的。</li>
<li><strong>HierarchicalBeanFactory</strong>：Hierarchical 单词本身已经能说明问题了，也就是说我们可以在应用中起多个 BeanFactory，然后可以将各个 BeanFactory 设置为父子关系。</li>
<li><strong>AutowireCapableBeanFactory</strong>： 这个名字中的 Autowire 大家都非常熟悉，它就是用来自动装配 Bean 用的，但是仔细看上图，ApplicationContext 并没有继承它，不过不用担心，不使用继承，不代表不可以使用组合，如果你看到 ApplicationContext 接口定义中的最后一个方法 getAutowireCapableBeanFactory() 就知道了。</li>
<li><strong>ConfigurableListableBeanFactory</strong> ：也是一个特殊的接口，看图，特殊之处在于它继承了第二层所有的三个接口，而 ApplicationContext 没有。这点之后会用到。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7202eaa44b8f3d3daee17478a4ca42ec>3 - CH03-Bean加载</h1>
<h2 id=解析流程>解析流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503121759.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=获取流程>获取流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503122924.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=创建流程>创建流程</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503123004.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a8a1a8038660c1cf3b1cbee6a84a454c>4 - CH04-IOC源码</h1>
<h2 id=applicationcontext-实例化-bean-的过程>ApplicationContext 实例化 Bean 的过程</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ApplicationContext</span> <span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:applicationContext.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Hello</span> <span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>ac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sayHello</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。</p>
<p>当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120343.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=启动过程分析>启动过程分析</h3>
<p>第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ClassPathXmlApplicationContext</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Nullable</span> <span style=color:#000>ApplicationContext</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>setConfigLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，就是 <code>refresh()</code>，这里简单说下为什么是 <code>refresh()</code>，而不是 <code>init()</code> 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 <code>refresh()</code> 这个方法重建的，<code>refresh()</code> 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Prepare this context for refreshing.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Tell the subclass to refresh the internal bean factory.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// Prepare the bean factory for use in this context.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Allows post-processing of the bean factory in context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//提供给子类实现一些postProcess的注册，如AbstractRefreshableWebApplicationContext注册一些Servlet相关的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Invoke factory processors registered as beans in the context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//调用所有BeanFactoryProcessor的postProcessBeanFactory()方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Register bean processors that intercept bean creation.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册BeanPostProcessor，BeanPostProcessor作用是用于拦截Bean的创建
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Initialize message source for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化消息Bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize event multicaster for this context.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//初始化上下文的事件多播组建，ApplicationEvent触发时由multicaster通知给ApplicationListener
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Initialize other special beans in specific context subclasses.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//ApplicationContext初始化一些特殊的bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Check for listener beans and register them.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注册事件监听器，事件监听Bean统一注册到multicaster里头，ApplicationEvent事件触发后会由multicaster广播
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Instantiate all remaining (non-lazy-init) singletons.(重点)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 非延迟加载的单例Bean实例化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Last step: publish corresponding event.(最后，广播事件，ApplicationContext 初始化完成)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// Propagate exception to caller.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面，我们开始一步步来肢解这个 <code>refresh()</code> 方法。</p>
<h3 id=创建-bean-容器前的准备工作>创建 Bean 容器前的准备工作</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Prepare this context for refreshing, setting its startup date and
</span><span style=color:#8f5902;font-style:italic> * active flag as well as performing any initialization of property sources.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// Switch to active.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupDate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>active</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Refreshing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize any placeholder property sources in the context environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initPropertySources</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Validate that all properties marked as required are resolvable:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// see ConfigurablePropertyResolver#setRequiredProperties
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 校验 xml 配置文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>validateRequiredProperties</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Store pre-refresh ApplicationListeners...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Reset local application listeners to pre-refresh state.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationListeners</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationListeners</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Allow for the collection of early ApplicationEvents,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// to be published once the multicaster is available...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyApplicationEvents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-bean-容器加载并注册-bean>创建 Bean 容器，加载并注册 Bean</h3>
<p>我们回到 <code>refresh()</code> 方法中的下一行 <code>obtainFreshBeanFactory()</code>。</p>
<p>注意，这个方法是全文最重要的部分之一，这里将会初始化 BeanFactory、加载 Bean、注册 Bean 等等。</p>
<p>当然，这步结束后，Bean 并没有完成初始化。这里指的是 Bean 实例并未在这一步生成。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 关闭旧的 BeanFactory (如果有)，创建新的 BeanFactory，加载 Bean 定义、注册 Bean 等等
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 返回刚刚创建的 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean factory for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>// AbstractRefreshableApplicationContext.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 如果 ApplicationContext 中已经加载过 BeanFactory 了，销毁所有 Bean，关闭 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意，应用中 BeanFactory 本来就是可以多个的，这里可不是说应用全局是否有 BeanFactory，而是当前
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// ApplicationContext 是否有 BeanFactory
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanFactory</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>closeBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 初始化一个 DefaultListableBeanFactory，为什么用这个，我们马上说。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 用于 BeanFactory 的序列化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSerializationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#8f5902;font-style:italic>// 下面这两个方法很重要，别跟丢了，具体细节之后说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的两个配置属性：是否允许 Bean 覆盖、是否允许循环引用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 加载 Bean 到 BeanFactory 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactoryMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I/O error parsing bean definition source for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getDisplayName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>看到这里的时候，我觉得读者就应该站在高处看 ApplicationContext 了，ApplicationContext 继承自 BeanFactory，但是它不应该被理解为 BeanFactory 的实现类，而是说其内部持有一个实例化的 BeanFactory（DefaultListableBeanFactory）。以后所有的 BeanFactory 相关的操作其实是委托给这个实例来处理的。</p>
</blockquote>
<p>我们说说为什么选择实例化 <strong>DefaultListableBeanFactory</strong> ？前面我们说了有个很重要的接口 ConfigurableListableBeanFactory，它实现了 BeanFactory 下面一层的所有三个接口，我把之前的继承图再拿过来大家再仔细看一下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120653.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们可以看到 ConfigurableListableBeanFactory 只有一个实现类 DefaultListableBeanFactory，而且实现类 DefaultListableBeanFactory 还通过实现右边的 AbstractAutowireCapableBeanFactory 通吃了右路。所以结论就是，最底下这个家伙 DefaultListableBeanFactory 基本上是最牛的 BeanFactory 了，这也是为什么这边会使用这个类来实例化的原因。</p>
<blockquote>
<p>如果你想要在程序运行的时候动态往 Spring IOC 容器注册新的 bean，就会使用到这个类。那我们怎么在运行时获得这个实例呢？</p>
<p>之前我们说过 ApplicationContext 接口能获取到 AutowireCapableBeanFactory，就是最右上角那个，然后它向下转型就能得到 DefaultListableBeanFactory 了。</p>
</blockquote>
<p>在继续往下之前，我们需要先了解 BeanDefinition。<strong>我们说 BeanFactory 是 Bean 容器，那么 Bean 又是什么呢？</strong></p>
<p>这里的 BeanDefinition 就是我们所说的 Spring 的 Bean，我们自己定义的各个 Bean 其实会转换成一个个 BeanDefinition 存在于 Spring 的 BeanFactory 中。</p>
<p>所以，如果有人问你 Bean 是什么的时候，你要知道 Bean 在代码层面上可以认为是 BeanDefinition 的实例。</p>
<blockquote>
<p>BeanDefinition 中保存了我们的 Bean 信息，比如这个 Bean 指向的是哪个类、是否是单例的、是否懒加载、这个 Bean 依赖了哪些 Bean 等等。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120722.png style=display:block;width:50% alt=NAME align=center> </div>
<p>BeanDefinition 是一个接口，用于属性承载，比如 <bean> 元素标签拥有 class、scope、lazy-init 等配置。bean的定义方式有千千万万种，无论是何种标签，无论是何种资源定义，无论是何种容器，只要按照 Spring 的规范编写xml配置文件，最终的 bean 定义内部表示都将转换为内部的唯一结构：BeanDefinition。当 BeanDefinition 注册完毕以后，Spring 的 BeanFactory 就可以随时根据需要进行实例化了。</p>
<h5 id=beandefinition-接口定义>BeanDefinition 接口定义</h5>
<p>我们来看下 BeanDefinition 的接口定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BeanDefinition</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AttributeAccessor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 我们可以看到，默认只提供 sington 和 prototype 两种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 很多读者可能知道还有 request, session, globalSession, application, websocket 这几种，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 不过，它们属于基于 web 的扩展。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>SCOPE_SINGLETON</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_SINGLETON</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>String</span> <span style=color:#000>SCOPE_PROTOTYPE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConfigurableBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SCOPE_PROTOTYPE</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 比较不重要，直接跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_APPLICATION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_SUPPORT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ROLE_INFRASTRUCTURE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 设置父 Bean，这里涉及到 bean 继承，不是 java 继承。请参见附录的详细介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：继承父 Bean 的配置信息而已
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>parentName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取父 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getParentName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 Bean 的类名称，将来是要通过反射来生成实例的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanClassName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 获取 Bean 的类名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置 bean 的 scope
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setScope</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>);</span>
   
   <span style=color:#5c35cc;font-weight:700>@Nullable</span>
   <span style=color:#000>String</span> <span style=color:#000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置是否懒加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLazyInit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazyInit</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 依赖的所有的 Bean，注意，这里的依赖不是指属性依赖(如 @Autowire 标记的)，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 是 depends-on=&#34;&#34; 属性设置的值。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 返回该 Bean 的所有依赖
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 设置该 Bean 是否可以注入到其他 Bean 中，只对根据类型注入有效，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果根据名称注入，即使这边设置了 false，也是可以的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireCandidate</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 该 Bean 是否可以注入到其他 Bean 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAutowireCandidate</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 主要的。同一接口的多个实现，如果不指定名字的话，Spring 会优先选择设置 primary 为 true 的 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setPrimary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>primary</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 是否是 primary 的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrimary</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果该 Bean 采用工厂方法生成，指定工厂名称。对工厂不熟悉的读者，请参加附录
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 一句话就是：有些实例不是用反射生成的，而是用工厂模式生成的
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryBeanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 指定工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>factoryMethodName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 获取工厂类中的 工厂方法名称
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span> <span style=color:#000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 构造器参数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ConstructorArgumentValues</span> <span style=color:#000>getConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// Bean 中的属性值，后面给 bean 注入属性值的时候会说到
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 singleton
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSingleton</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 是否 prototype
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPrototype</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 如果这个 Bean 是被设置为 abstract，那么不能实例化，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 常用于作为 父bean 用于继承，其实也很少用......
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAbstract</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getRole</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>String</span> <span style=color:#000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#000>BeanDefinition</span> <span style=color:#000>getOriginatingBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>这个 BeanDefinition 其实已经包含很多的信息了，暂时不清楚所有的方法对应什么东西没关系，希望看完本文后读者可以彻底搞清楚里面的所有东西。</p>
<p>这里接口虽然那么多，但是没有类似 getInstance() 这种方法来获取我们定义的类的实例，真正的我们定义的类生成的实例到哪里去了呢？别着急，这个要很后面才能讲到。</p>
</blockquote>
<p>有了 BeanDefinition 的概念以后，我们再往下看 <code>refreshBeanFactory()</code> 方法中的剩余部分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=customizebeanfactory>customizeBeanFactory()</h4>
<p>customizeBeanFactory(beanFactory) 比较简单，就是配置是否允许 BeanDefinition 覆盖、是否允许循环引用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>customizeBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 定义覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 是否允许 Bean 间的循环依赖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAllowCircularReferences</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span><span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BeanDefinition 的覆盖问题可能会有开发者碰到这个坑，就是在配置文件中定义 bean 时使用了相同的 id 或 name，默认情况下，allowBeanDefinitionOverriding 属性为 null，如果在同一配置文件中重复了，会抛错，但是如果不是同一配置文件中，会发生覆盖。</p>
<p>循环引用也很好理解：A 依赖 B，而 B 依赖 A。或 A 依赖 B，B 依赖 C，而 C 依赖 A。</p>
<p>默认情况下，Spring 允许循环依赖，当然如果你在 A 的构造方法中依赖 B，在 B 的构造方法中依赖 A 是不行的。</p>
<p>至于这两个属性怎么配置？我在附录中进行了介绍，尤其对于覆盖问题，很多人都希望禁止出现 Bean 覆盖，可是 Spring 默认是不同文件的时候可以覆盖的。</p>
<p>之后的源码中还会出现这两个属性，先有个印象就可以了。</p>
<h4 id=loadbeandefinitions加载-bean>loadBeanDefinitions()：加载 Bean</h4>
<p>接下来是最重要的 <code>loadBeanDefinitions(beanFactory)</code> 方法了，这个方法将根据配置，加载各个 Bean，然后放到 BeanFactory 中。</p>
<p>读取配置的操作在 XmlBeanDefinitionReader 中，其负责加载配置、解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 我们可以看到，此方法将通过一个 XmlBeanDefinitionReader 实例来加载各个 Bean。*/</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DefaultListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 给这个 BeanFactory 实例化一个 XmlBeanDefinitionReader
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>beanDefinitionReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XmlBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// Configure the bean definition reader with this context&#39;s
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// resource loading environment.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResourceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEntityResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 初始化 BeanDefinitionReader，其实这个是提供给子类覆写的，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我看了一下，没有类覆写这个方法，我们姑且当做不重要吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>initBeanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 重点来了，继续往下
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitionReader</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在还在这个类中，接下来用刚刚初始化的 Reader 开始来加载 xml 配置，这块代码读者可以选择性跳过，不是很重要。也就是说，下面这个代码块，读者可以很轻松地略过。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XmlBeanDefinitionReader</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigResources</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConfigLocations</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configLocations</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 上面虽然有两个分支，不过第二个分支很快通过解析路径转换为 Resource 以后也会进到这里
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Resource array must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 注意这里是个 for 循环，也就是每个文件是一个 resource
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 继续往下看
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 最后返回 counter，表示总共加载了多少的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 303
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// XmlBeanDefinitionReader 314
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>loadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EncodedResource</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;EncodedResource must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading XML bean definitions from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 用一个 ThreadLocal 来存放配置文件资源
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>EncodedResource</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;Detected cyclic loading of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; - check your import definitions!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEncoding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#8f5902;font-style:italic>// 核心部分是这里，往下面看
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#4e9a06>&#34;IOException parsing XML document from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>encodedResource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentResources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resourcesCurrentlyBeingLoaded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 388 行
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doLoadBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputSource</span> <span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这里就不看了，将 xml 文件转换为 Document 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Document</span> <span style=color:#000>doc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doLoadDocument</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 继续
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// 还在这个文件中，第 505 行
</span><span style=color:#8f5902;font-style:italic>// 返回值：返回从当前配置文件加载了多少数量的 Bean
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resource</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>BeanDefinitionDocumentReader</span> <span style=color:#000>documentReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinitionDocumentReader</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>countBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 这里
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>documentReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>createReaderContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>countBefore</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
          
<span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Document</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XmlReaderContext</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readerContext</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Loading bean definitions&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Element</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDocumentElement</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 从 xml 根节点开始解析文件
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>经过漫长的链路，一个配置文件终于转换为一颗 DOM 树了，注意，这里指的是其中一个配置文件，不是所有的，读者可以看到上面有个 for 循环的。下面开始从根节点开始解析：</p>
<h4 id=doregisterbeandefinitions>doRegisterBeanDefinitions()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// DefaultBeanDefinitionDocumentReader.java
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 我们看名字就知道，BeanDefinitionParserDelegate 必定是一个重要的类，它负责解析 Bean 定义，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里为什么要定义一个 parent? 看到后面就知道了，是递归问题，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 因为 &lt;beans /&gt; 内部是可以定义 &lt;beans /&gt; 的，所以这个方法的 root 其实不一定就是 xml 的根节点，也可以是嵌套在里面的 &lt;beans /&gt; 节点，从源码分析的角度，我们当做根节点就好了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这块说的是根节点 &lt;beans ... profile=&#34;dev&#34; /&gt; 中的 profile 是否是当前环境需要的，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果当前环境配置的 profile 不包含此 profile，那就直接 return 了，不对此 &lt;beans /&gt; 解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 不熟悉 profile 为何物，不熟悉怎么配置 profile 读者的请移步附录区
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PROFILE_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>specifiedProfiles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>profileSpec</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>acceptsProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specifiedProfiles</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInfoEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Skipped XML bean definition file due to specified profiles [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>profileSpec</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] not matching: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>preProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>postProcessXml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 钩子
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>preProcessXml(root)</code> 和 <code>postProcessXml(root)</code> 是给子类用的钩子方法，鉴于没有被使用到，也不是我们的重点，我们直接跳过。</p>
<p>这里涉及到了 profile 的问题，对于不了解的读者，我在附录中对 profile 做了简单的解释，读者可以参考一下。接下来，看核心解析方法</p>
<h4 id=parsebeandefinitionsroot-thisdelegate>parseBeanDefinitions(root, this.delegate)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// default namespace 涉及到的就四个标签 &lt;import /&gt;、&lt;alias /&gt;、&lt;bean /&gt; 和 &lt;beans /&gt;，
</span><span style=color:#8f5902;font-style:italic>// 其他的属于 custom 的
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>NodeList</span> <span style=color:#000>nl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Element</span> <span style=color:#000>ele</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDefaultNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析 default namespace 下面的几个元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 解析其他 namespace 的元素
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseCustomElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码，我们可以看到，对于每个配置来说，分别进入到 <code>parseDefaultElement(ele, delegate);</code> 和 <code>delegate.parseCustomElement(ele);</code> 这两个分支了。</p>
<p><code>parseDefaultElement(ele, delegate)</code> 代表解析的节点是 <code>&lt;import /></code>、<code>&lt;alias /></code>、<code>&lt;bean /></code>、<code>&lt;beans /></code> 这几个。</p>
<blockquote>
<p>这里的四个标签之所以是 default 的，是因为它们是处于这个 namespace 下定义的：</p>
<p><a href=http://www.springframework.org/schema/beans>http://www.springframework.org/schema/beans</a></p>
<p>又到初学者科普时间，不熟悉 namespace 的读者请看下面贴出来的 xml，这里的第二行 <strong>xmlns</strong> 就是咯。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>            http://www.springframework.org/schema/beans
</span><span style=color:#4e9a06>          http://www.springframework.org/schema/beans/spring-beans.xsd&#34;</span>
       <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div><p>而对于其他的标签，将进入到 <code>delegate.parseCustomElement(element)</code> 这个分支。如我们经常会使用到的 <code>&lt;mvc /></code>、<code>&lt;task /></code>、<code>&lt;context /></code>、<code>&lt;aop /></code>等。</p>
<p>这些属于扩展，如果需要使用上面这些 ”非 default“ 标签，那么上面的 xml 头部的地方也要引入相应的 namespace 和 .xsd 文件的路径，如下所示。同时代码中需要提供相应的 parser 来解析，如 MvcNamespaceHandler、TaskNamespaceHandler、ContextNamespaceHandler、AopNamespaceHandler 等。</p>
<p>假如读者想分析 <code>&lt;context:property-placeholder location="classpath:xx.properties" /></code> 的实现原理，就应该到 ContextNamespaceHandler 中找答案。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
      <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
      <span style=color:#c4a000>xmlns:context=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/context&#34;</span>
      <span style=color:#c4a000>xmlns:mvc=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/mvc&#34;</span>
      <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans 
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/beans/spring-beans.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/context/spring-context.xsd
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc   
</span><span style=color:#4e9a06>           http://www.springframework.org/schema/mvc/spring-mvc.xsd  
</span><span style=color:#4e9a06>       &#34;</span>
      <span style=color:#c4a000>default-autowire=</span><span style=color:#4e9a06>&#34;byName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div></blockquote>
<p>回过神来，看看处理 default 标签的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseDefaultElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IMPORT_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;import /&gt; 标签
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>importBeanDefinitionResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ALIAS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;alias /&gt; 标签定义
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// &lt;alias name=&#34;fromName&#34; alias=&#34;toName&#34;/&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processAliasRegistration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BEAN_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 &lt;bean /&gt; 标签定义，这也算是我们的重点吧
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nodeNameEquals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NESTED_BEANS_ELEMENT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果碰到的是嵌套的 &lt;beans /&gt; 标签，需要递归
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>doRegisterBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果每个标签都说，那我不吐血，你们都要吐血了。我们挑我们的重点 <code>&lt;bean /></code> 标签出来说。</p>
<h4 id=processbeandefinition-解析-bean-标签>processBeanDefinition 解析 bean 标签</h4>
<p>下面是 processBeanDefinition 解析 <code>&lt;bean /></code> 标签：</p>
<p>// DefaultBeanDefinitionDocumentReader.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点中的信息提取出来，然后封装到一个 BeanDefinitionHolder 中，细节往下看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 下面的几行先不要看，跳过先，跳过先，跳过先，后面会继续说的
</span><span style=color:#8f5902;font-style:italic></span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Register the final decorated instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// Send registration event.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继续往下看怎么解析之前，我们先看下 <code>&lt;bean /></code> 标签中可以定义哪些属性：</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>类的全限定名</td>
</tr>
<tr>
<td>name</td>
<td>可指定 id、name(用逗号、分号、空格分隔)</td>
</tr>
<tr>
<td>scope</td>
<td>作用域</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>指定构造参数</td>
</tr>
<tr>
<td>properties</td>
<td>设置属性的值</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(默认值)、byName、byType、 constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>是否懒加载(如果被非懒加载的bean依赖了那么其实也就不能懒加载了)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean 属性设置完成后，会调用这个方法</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean 销毁后的回调方法</td>
</tr>
</tbody>
</table>
<p>上面表格中的内容我想大家都非常熟悉吧，如果不熟悉，那就是你不够了解 Spring 的配置了。</p>
<p>简单地说就是像下面这样子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;exampleBean&#34;</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name1, name2, name3&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.javadoop.ExampleBean&#34;</span>
      <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;singleton&#34;</span> <span style=color:#c4a000>lazy-init=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;init&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;cleanup&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- 可以用下面三种形式指定构造参数 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;years&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;7500000&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- property 的几种情况 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanOne&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;ref</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;anotherExampleBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanTwo&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;yetAnotherBean&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;integerProperty&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>当然，除了上面举例出来的这些，还有 factory-bean、factory-method、<code>&lt;lockup-method /></code>、<code>&lt;replaced-method /></code>、<code>&lt;meta /></code>、<code>&lt;qualifier /></code> 这几个，大家是不是熟悉呢？自己检验一下自己对 Spring 中 bean 的了解程度。</p>
<p>有了以上这些知识以后，我们再继续往里看怎么解析 bean 元素，是怎么转换到 BeanDefinitionHolder 的。</p>
<p>// BeanDefinitionParserDelegate.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>String</span> <span style=color:#000>nameAttr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NAME_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>

   <span style=color:#8f5902;font-style:italic>// 将 name 属性的定义按照 “逗号、分号、空格” 切分，形成一个 别名列表数组，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 当然，如果你不定义 name 属性的话，就是空的了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中简单介绍了一下 id 和 name 的配置，大家可以看一眼，有个20秒就可以了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>nameArr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameAttr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameArr</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有指定id, 那么用别名列表的第一个名字作为beanName
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No XML &#39;id&#39; specified - using &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; as bean name and &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; as aliases&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>checkNameUniqueness</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 根据 &lt;bean ...&gt;...&lt;/bean&gt; 中的配置创建 BeanDefinition，然后把配置中的信息都设置到实例中,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 细节后面细说，先知道下面这行结束后，一个 BeanDefinition 实例就出来了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 到这里，整个 &lt;bean /&gt; 标签就算解析结束了，一个 BeanDefinition 就形成了。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果都没有设置 id 和 name，那么此时的 beanName 就会为 null，进入下面这块代码产生
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果读者不感兴趣的话，我觉得不需要关心这块代码，对本文源码分析来说，这些东西不重要
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingBean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 按照我们的思路，这里 containingBean 是 null 的
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span>
                     <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#8f5902;font-style:italic>// 如果我们不定义 id 和 name，那么我们引言里的那个例子：
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   1. beanName 为：com.javadoop.example.MessageServiceImpl#0
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>//   2. beanClassName 为：com.javadoop.example.MessageServiceImpl
</span><span style=color:#8f5902;font-style:italic></span>
               <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generateBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>

               <span style=color:#000>String</span> <span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>();</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isBeanNameInUse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#8f5902;font-style:italic>// 把 beanClassName 设置为 Bean 的别名
</span><span style=color:#8f5902;font-style:italic></span>                  <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClassName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Neither XML &#39;id&#39; nor &#39;name&#39; specified - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;using generated bean name [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliasesArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 返回 BeanDefinitionHolder
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>aliasesArray</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后，我们再看看怎么根据配置创建 BeanDefinition 实例的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#000>String</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLASS_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PARENT_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 创建 BeanDefinition，然后设置类信息而已，很简单，就不贴代码了
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>AbstractBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanDefinition 的一堆属性，这些属性定义在 AbstractBeanDefinition 中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseBeanDefinitionAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>containingBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDescription</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DomUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildElementValueByTagName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DESCRIPTION_ELEMENT</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>       * 下面的一堆是解析 &lt;bean&gt;......&lt;/bean&gt; 内部的子元素，
</span><span style=color:#8f5902;font-style:italic>       * 解析出来以后的信息都放到 bd 的属性中
</span><span style=color:#8f5902;font-style:italic>       */</span>

      <span style=color:#8f5902;font-style:italic>// 解析 &lt;meta /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseMetaElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;lookup-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseLookupOverrideSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;replaced-method /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseReplacedMethodSubElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 解析 &lt;constructor-arg /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseConstructorArgElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;property /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parsePropertyElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 &lt;qualifier /&gt;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parseQualifierElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readerContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extractSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>));</span>

      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoClassDefFoundError</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Class that bean class [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>className</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] depends on not found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unexpected failure during bean definition parsing&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseState</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pop</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经完成了根据 <code>&lt;bean /></code> 配置创建了一个 BeanDefinitionHolder 实例。注意，是一个。</p>
<p>我们回到解析 <code>&lt;bean /></code> 的入口方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Element</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionParserDelegate</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 将 &lt;bean /&gt; 节点转换为 BeanDefinitionHolder，就是上面说的一堆
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBeanDefinitionElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果有自定义属性的话，进行相应的解析，先忽略
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>bdHolder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>decorateBeanDefinitionIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 我们把这步叫做 注册Bean 吧
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>BeanDefinitionReaderUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getRegistry</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to register bean definition with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 注册完成后，发送事件，本文不展开说这个
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>getReaderContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>fireComponentRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanComponentDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bdHolder</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家再仔细看一下这块吧，我们后面就不回来说这个了。这里已经根据一个 <code>&lt;bean /></code> 标签产生了一个 BeanDefinitionHolder 的实例，这个实例里面也就是一个 BeanDefinition 的实例和它的 beanName、aliases 这三个信息，注意，我们的关注点始终在 BeanDefinition 上：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BeanMetadataElement</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>然后我们准备注册这个 BeanDefinition，最后，把这个注册事件发送出去。</p>
<p>下面，我们开始说说注册 Bean 吧。</p>
<h3 id=注册-bean>注册 Bean</h3>
<p>// BeanDefinitionReaderUtils.java</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#8f5902;font-style:italic>// 注册这个 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 如果还有别名的话，也要根据别名全部注册一遍，不然根据别名就会找不到 Bean 了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>definitionHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAliases</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliases</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aliases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// alias -&gt; beanName 保存它们的别名信息，这个很简单，用一个 map 保存一下就可以了，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 获取的时候，会先将 alias 转换为 beanName，然后再查找
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>别名注册的放一边，毕竟它很简单，我们看看怎么注册 Bean。</p>
<p>// DefaultListableBeanFactory.java 793</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanDefinition</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanDefinitionStoreException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Bean name must not be empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;BeanDefinition must not be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AbstractBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>validate</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(...);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// old? 还记得 “允许 bean 覆盖” 这个配置吗？allowBeanDefinitionOverriding
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanDefinition</span> <span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 之后会看到，所有的 Bean 注册后会放入这个 beanDefinitionMap 中
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 处理重复名称的 Bean 定义的情况
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isAllowBeanDefinitionOverriding</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 如果不允许覆盖的话，抛异常
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()...</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRole</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用框架定义的 Bean 覆盖用户自定义的 Bean 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用新的 Bean 覆盖旧的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// log...用同等的 Bean 覆盖旧的 Bean，这里指的是 equals 方法返回 true 的 Bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 覆盖
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 判断是否已经有其他的 Bean 开始初始化了.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注意，&#34;注册Bean&#34; 这个动作结束，Bean 依然还没有初始化，我们后面会有大篇幅说初始化过程，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 在 Spring 容器启动的最后，会 预初始化 所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasBeanCreationStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Cannot modify startup-time collection elements anymore (for stable iteration)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updatedSingletons</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updatedSingletons</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 最正常的应该是进到这个分支。
</span><span style=color:#8f5902;font-style:italic></span>
         <span style=color:#8f5902;font-style:italic>// 将 BeanDefinition 放到这个 map 中，这个 map 保存了所有的 BeanDefinition
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanDefinition</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 ArrayList，所以会按照 bean 配置的顺序保存每一个注册的 Bean 的名字
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 这是个 LinkedHashSet，代表的是手动注册的 singleton bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 注意这里是 remove 方法，到这里的 Bean 当然不是手动注册的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 手动指的是通过调用以下方法注册的 bean ：
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//     registerSingleton(String beanName, Object singletonObject)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这不是重点，解释只是为了不让大家疑惑。Spring 会在后面&#34;手动&#34;注册一些 Bean，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 如 &#34;environment&#34;、&#34;systemProperties&#34; 等 bean，我们自己也可以在运行时注册 Bean 到容器中的
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>manualSingletonNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 这个不重要，在预初始化的时候会用到，不必管它。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>frozenBeanDefinitionNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldBeanDefinition</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>containsSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>resetBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>总结一下，到这里已经初始化了 Bean 容器，<code>&lt;bean /></code> 配置也相应的转换为了一个个 BeanDefinition，然后注册了各个 BeanDefinition 到注册中心，并且发送了注册事件。</p>
<blockquote>
<p>到这里是一个分水岭，前面的内容都还算比较简单，大家要清楚地知道前面都做了哪些事情。</p>
</blockquote>
<h3 id=bean-容器实例化完成后>Bean 容器实例化完成后</h3>
<p>说到这里，我们回到 refresh() 方法，我重新贴了一遍代码，看看我们说到哪了。是的，我们才说完 <code>obtainFreshBeanFactory()</code> 方法。</p>
<p>考虑到篇幅，这里开始大幅缩减掉没必要详细介绍的部分，大家直接看下面的代码中的注释就好了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalStateException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startupShutdownMonitor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
     
      <span style=color:#8f5902;font-style:italic>// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>obtainFreshBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>

      <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 这块待会会展开说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 【这里需要知道 BeanFactoryPostProcessor 这个知识点，Bean 如果实现了此接口，
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 那么在容器初始化以后，Spring 会负责调用里面的 postProcessBeanFactory 方法。】
</span><span style=color:#8f5902;font-style:italic></span>        
         <span style=color:#8f5902;font-style:italic>// 这里是提供给子类的扩展点，到这里的时候，所有的 Bean 都加载、注册完成了，但是都还没有初始化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这步的时候添加一些特殊的 BeanFactoryPostProcessor 的实现类或做点什么事
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>postProcessBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#8f5902;font-style:italic>// 调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 回调方法
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>invokeBeanFactoryPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>          
         
          

         <span style=color:#8f5902;font-style:italic>// 注册 BeanPostProcessor 的实现类，注意看和 BeanFactoryPostProcessor 的区别
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 此接口两个方法: postProcessBeforeInitialization 和 postProcessAfterInitialization
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 两个方法分别在 Bean 初始化之前和初始化之后得到执行。这里仅仅是注册，之后会看到回调这两方法的时机
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的 MessageSource，国际化这里就不展开说了，不然没完没了了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 初始化当前 ApplicationContext 的事件广播器，这里也不展开了
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>initApplicationEventMulticaster</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 从方法名就可以知道，典型的模板方法(钩子方法)，不展开说
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 具体的子类可以在这里初始化一些特殊的 Bean（在初始化 singleton beans 之前）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>onRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 注册事件监听器，监听器需要实现 ApplicationListener 接口。这也不是我们的重点，过
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>registerListeners</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// 重点，重点，重点
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 初始化所有的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>//（lazy-init 的除外）
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 最后，广播事件，ApplicationContext 初始化完成，不展开
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>finishRefresh</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isWarnEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                  <span style=color:#4e9a06>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>

         <span style=color:#8f5902;font-style:italic>// Destroy already created singletons to avoid dangling resources.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 销毁已经初始化的 singleton 的 Beans，以免有些 bean 会一直占用资源
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>destroyBeans</span><span style=color:#ce5c00;font-weight:700>();</span>

         <span style=color:#8f5902;font-style:italic>// Reset &#39;active&#39; flag.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>cancelRefresh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>

         <span style=color:#8f5902;font-style:italic>// 把异常往外抛
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Reset common introspection caches in Spring&#39;s core, since we
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// might not ever need metadata for singleton beans anymore...
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>resetCommonCaches</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=准备-bean-容器-preparebeanfactory>准备 Bean 容器: prepareBeanFactory</h3>
<p>之前我们说过，Spring 把我们在 xml 配置的 bean 都注册以后，会"手动"注册一些特殊的 bean。</p>
<p>这里简单介绍下 <code>prepareBeanFactory(factory)</code> 方法：</p>
<h3 id=preparebeanfactoryfactory>prepareBeanFactory(factory)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Configure the factory&#39;s standard context characteristics,
</span><span style=color:#8f5902;font-style:italic> * such as the context&#39;s ClassLoader and post-processors.
</span><span style=color:#8f5902;font-style:italic> * @param beanFactory the BeanFactory to configure
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>prepareBeanFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 设置 BeanFactory 的类加载器，我们知道 BeanFactory 需要加载类，也就需要类加载器，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这里设置为加载当前 ApplicationContext 类的类加载器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>

   <span style=color:#8f5902;font-style:italic>// 设置 BeanExpressionResolver
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StandardBeanExpressionResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addPropertyEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResourceEditorRegistrar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>()));</span>

   <span style=color:#8f5902;font-style:italic>// 添加一个 BeanPostProcessor，这个 processor 比较简单：
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 实现了 Aware 接口的 beans 在初始化的时候，这个 processor 负责回调，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这个我们很常用，如我们会为了获取 ApplicationContext 而 implement ApplicationContextAware
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意：它不仅仅回调 ApplicationContextAware，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//   还会负责回调 EnvironmentAware、ResourceLoaderAware 等，看下源码就清楚了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationContextAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 下面几行的意思就是，如果某个 bean 依赖于以下几个接口的实现类，在自动装配的时候忽略它们，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// Spring 会通过其他方式来处理这些依赖。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnvironmentAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmbeddedValueResolverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoaderAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisherAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageSourceAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ignoreDependencyInterface</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContextAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 下面几行就是为特殊的几个 bean 赋值，如果有 bean 依赖了以下几个，会注入这边相应的值，
</span><span style=color:#8f5902;font-style:italic>    * 之前我们说过，&#34;当前 ApplicationContext 持有一个 BeanFactory&#34;，这里解释了第一行
</span><span style=color:#8f5902;font-style:italic>    * ApplicationContext 还继承了 ResourceLoader、ApplicationEventPublisher、MessageSource
</span><span style=color:#8f5902;font-style:italic>    * 所以对于这几个依赖，可以赋值为 this，注意 this 是一个 ApplicationContext
</span><span style=color:#8f5902;font-style:italic>    * 那这里怎么没看到为 MessageSource 赋值呢？那是因为 MessageSource 被注册成为了一个普通的 bean
</span><span style=color:#8f5902;font-style:italic>    */</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResourceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationEventPublisher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerResolvableDependency</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 这个 BeanPostProcessor 也很简单，在 bean 实例化后，如果是 ApplicationListener 的子类，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 那么将其添加到 listener 列表中，可以理解成：注册 事件监听器
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ApplicationListenerDetector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>));</span>

   <span style=color:#8f5902;font-style:italic>// 这里涉及到特殊的 bean，名为：loadTimeWeaver，这不是我们的重点，忽略它
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// tips: ltw 是 AspectJ 的概念，指的是在运行期进行织入，这个和 Spring AOP 不一样，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>//    感兴趣的读者请参考我写的关于 AspectJ 的另一篇文章 https://www.javadoop.com/post/aspectj
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOAD_TIME_WEAVER_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LoadTimeWeaverAwareProcessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// Set a temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContextTypeMatchClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassLoader</span><span style=color:#ce5c00;font-weight:700>()));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * 从下面几行代码我们可以知道，Spring 往往很 &#34;智能&#34; 就是因为它会帮我们默认注册一些有用的 bean，
</span><span style=color:#8f5902;font-style:italic>    * 我们也可以选择覆盖
</span><span style=color:#8f5902;font-style:italic>    */</span>

   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;environment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemProperties&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_PROPERTIES_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemProperties</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 如果没有定义 &#34;systemEnvironment&#34; 这个 bean，那么 Spring 会 &#34;手动&#34; 注册一个
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsLocalBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SYSTEM_ENVIRONMENT_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getSystemEnvironment</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面这块代码中，Spring 对一些特殊的 bean 进行了处理，读者如果暂时还不能消化它们也没有关系，慢慢往下看。</p>
<h3 id=初始化所有的-singleton-beans>初始化所有的 singleton beans</h3>
<p>我们的重点当然是 <code>finishBeanFactoryInitialization(beanFactory);</code> 这个巨头了，这里会负责初始化所有的 singleton beans。</p>
<p>注意，后面的描述中，我都会使用<strong>初始化</strong>或<strong>预初始化</strong>来代表这个阶段，Spring 会在这个阶段完成所有的 singleton beans 的实例化。</p>
<p>我们来总结一下，到目前为止，应该说 BeanFactory 已经创建完成，并且所有的实现了 BeanFactoryPostProcessor 接口的 Bean 都已经初始化并且其中的 postProcessBeanFactory(factory) 方法已经得到回调执行了。而且 Spring 已经“手动”注册了一些特殊的 Bean，如 ‘environment’、‘systemProperties’ 等。</p>
<p>剩下的就是初始化 singleton beans 了，我们知道它们是单例的，如果没有设置懒加载，那么 Spring 会在接下来初始化所有的 singleton beans。</p>
<p>// AbstractApplicationContext.java 834</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 初始化剩余的 singleton beans
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finishBeanFactoryInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConfigurableListableBeanFactory</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 首先，初始化名字为 conversionService 的 Bean。本着送佛送到西的精神，我在附录中简单介绍了一下 ConversionService，因为这实在太实用了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 什么，看代码这里没有初始化 Bean 啊！
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 注意了，初始化的动作包装在 beanFactory.getBean(...) 中，这里先不说细节，先往下看吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isTypeMatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConversionService</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CONVERSION_SERVICE_BEAN_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConversionService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register a default embedded value resolver if no bean post-processor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// (such as a PropertyPlaceholderConfigurer bean) registered any before:
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// at this point, primarily for resolution in annotation attribute values.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addEmbeddedValueResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringValueResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>resolveStringValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolvePlaceholders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strVal</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 先初始化 LoadTimeWeaverAware 类型的 Bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 之前也说过，这是 AspectJ 相关的内容，放心跳过吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>weaverAwareNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanNamesForType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LoadTimeWeaverAware</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>weaverAwareName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>weaverAwareNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>weaverAwareName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Stop using the temporary ClassLoader for type matching.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTempClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 没什么别的目的，因为到这一步的时候，Spring 已经开始预初始化 singleton beans 了，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 肯定不希望这个时候还出现 bean 定义解析、加载、注册。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>freezeConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#8f5902;font-style:italic>// 开始初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>beanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面最后一行往里看，我们就又回到 DefaultListableBeanFactory 这个类了，这个类大家应该都不陌生了吧。</p>
<p>// DefaultListableBeanFactory.java 728</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>preInstantiateSingletons</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pre-instantiating singletons in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// this.beanDefinitionNames 保存了所有的 beanNames
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanDefinitionNames</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 触发所有的非懒加载的 singleton beans 的初始化操作
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

      <span style=color:#8f5902;font-style:italic>// 合并父 Bean 中的配置，注意 &lt;bean id=&#34;&#34; class=&#34;&#34; parent=&#34;&#34; /&gt; 中的 parent，用的不多吧，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 考虑到这可能会影响大家的理解，我在附录中解释了一下 &#34;Bean 继承&#34;，不了解的请到附录中看一下
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 非抽象、非懒加载的 singletons。如果配置了 &#39;abstract = true&#39;，那是不需要初始化的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLazyInit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 处理 FactoryBean(读者如果不熟悉 FactoryBean，请移步附录区了解)
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isFactoryBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// FactoryBean 的话，在 beanName 前面加上 ‘&amp;’ 符号。再调用 getBean，getBean 方法别急
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FACTORY_BEAN_PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 判断当前 FactoryBean 是否是 SmartFactoryBean 的实现，此处忽略，直接跳过
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#5c35cc;font-weight:700>@Override</span>
                  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>isEagerInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartFactoryBean</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                     <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SmartFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isEagerInit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 对于普通的 Bean，只要调用 getBean(beanName) 这个方法就可以进行初始化了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>


   <span style=color:#8f5902;font-style:italic>// 到这里说明所有的非懒加载的 singleton beans 已经完成了初始化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 如果我们定义的 bean 是实现了 SmartInitializingSingleton 接口的，那么在这里得到回调，忽略
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>singletonInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonInstance</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SmartInitializingSingleton</span> <span style=color:#000>smartSingleton</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SmartInitializingSingleton</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>singletonInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#5c35cc;font-weight:700>@Override</span>
               <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>smartSingleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterSingletonsInstantiated</span><span style=color:#ce5c00;font-weight:700>();</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来，我们就进入到 getBean(beanName) 方法了，这个方法我们经常用来从 BeanFactory 中获取一个 Bean，而初始化的过程也封装到了这个方法里。</p>
<h2 id=获取-bean>获取 Bean</h2>
<p>容器和 Bean 已经准备好了，接着就是获取 Bean 去使用了。</p>
<h3 id=俯瞰-getbeanstring-源码>俯瞰 getBean(String) 源码</h3>
<p>在本小节，我们先从战略上俯瞰 getBean(String) 方法的实现源码。代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// getBean 是一个空壳方法，所有的逻辑都封装在 doGetBean 方法中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>doGetBean</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 通过 name 获取 beanName。这里不使用 name 直接作为 beanName 有两点原因：
</span><span style=color:#8f5902;font-style:italic>     * 1. name 可能会以 &amp; 字符开头，表明调用者想获取 FactoryBean 本身，而非 FactoryBean 
</span><span style=color:#8f5902;font-style:italic>     *    实现类所创建的 bean。在 BeanFactory 中，FactoryBean 的实现类和其他的 bean 存储
</span><span style=color:#8f5902;font-style:italic>     *    方式是一致的，即 &lt;beanName, bean&gt;，beanName 中是没有 &amp; 这个字符的。所以我们需要
</span><span style=color:#8f5902;font-style:italic>     *    将 name 的首字符 &amp; 移除，这样才能从缓存里取到 FactoryBean 实例。
</span><span style=color:#8f5902;font-style:italic>     * 2. 若 name 是一个别名，则应将别名转换为具体的实例名，也就是 beanName。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transformedBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 注意跟着这个，这个是返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 从缓存中获取单例 bean。Spring 是使用 Map 作为 beanName 和 bean 实例的缓存的，所以这
</span><span style=color:#8f5902;font-style:italic>     * 里暂时可以把 getSingleton(beanName) 等价于 beanMap.get(beanName)。当然，实际的
</span><span style=color:#8f5902;font-style:italic>     * 逻辑并非如此简单，后面再细说。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。
</span><span style=color:#8f5902;font-style:italic>     * BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取 
</span><span style=color:#8f5902;font-style:italic>     * bean 时再实例化，也就是懒加载。
</span><span style=color:#8f5902;font-style:italic>     * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取
</span><span style=color:#8f5902;font-style:italic>     * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数
</span><span style=color:#8f5902;font-style:italic>     * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有
</span><span style=color:#8f5902;font-style:italic>     * 用了，BeanFactory 不会多次实例化单例 bean。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#4e9a06>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果 
</span><span style=color:#8f5902;font-style:italic>         * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的 
</span><span style=color:#8f5902;font-style:italic>         * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回
</span><span style=color:#8f5902;font-style:italic>         * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean 
</span><span style=color:#8f5902;font-style:italic>     * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例
</span><span style=color:#8f5902;font-style:italic>     * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 如果 sharedInstance = null，则到父容器中查找 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BeanFactory</span> <span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getParentBeanFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentBeanFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>containsBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取 name 对应的 beanName，如果 name 是以 &amp; 字符开头，则返回 &amp; + beanName
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>nameToLookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>originalBeanName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 根据 args 是否为空，以决定调用父容器哪个方法获取 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 返回父容器的查询结果
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> 
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentBeanFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nameToLookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>typeCheckOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>markBeanAsCreated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

       <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>       * 稍稍总结一下：
</span><span style=color:#8f5902;font-style:italic>       * 到这里的话，要准备创建 Bean 了，对于 singleton 的 Bean 来说，容器中还没创建过此 Bean；
</span><span style=color:#8f5902;font-style:italic>       * 对于 prototype 的 Bean 来说，本来就是要创建一个新的 Bean。
</span><span style=color:#8f5902;font-style:italic>       */</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 合并父 BeanDefinition 与子 BeanDefinition，后面会单独分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMergedLocalBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>checkMergedBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependsOn</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependsOn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                     * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，
</span><span style=color:#8f5902;font-style:italic>                     * B 又依赖 A，他们的配置如下：
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanA&#34; class=&#34;BeanA&#34; depends-on=&#34;beanB&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   &lt;bean id=&#34;beanB&#34; class=&#34;BeanB&#34; depends-on=&#34;beanA&#34;&gt;
</span><span style=color:#8f5902;font-style:italic>                     *   
</span><span style=color:#8f5902;font-style:italic>                     * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它
</span><span style=color:#8f5902;font-style:italic>                     * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接
</span><span style=color:#8f5902;font-style:italic>                     * 抛出异常
</span><span style=color:#8f5902;font-style:italic>                     */</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDependent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; and &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 注册依赖记录
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>registerDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 先初始化被依赖项 加载 depends-on 依赖 
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>getBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dep</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> 
                    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchBeanDefinitionException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; depends on missing bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dep</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过 
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。
</span><span style=color:#8f5902;font-style:italic>                 * getSingleton(String, ObjectFactory) 方法会在内部调用 
</span><span style=color:#8f5902;font-style:italic>                 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，
</span><span style=color:#8f5902;font-style:italic>                 * 将 bean 放入缓存中。关于 getSingleton 方法的分析，本文先不展开，我会在
</span><span style=color:#8f5902;font-style:italic>                 * 后面的文章中进行分析
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#8f5902;font-style:italic>// 创建 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>});</span>
                <span style=color:#8f5902;font-style:italic>// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建 prototype 类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPrototype</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Object</span> <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>prototypeInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prototypeInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 创建其他类型的 bean 实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>String</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getScope</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Scope</span> <span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scopes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopeName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Object</span> <span style=color:#000>scopedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@Override</span>
                        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>beforePrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>afterPrototypeCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
                    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scopedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalStateException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#4e9a06>&#34;Scope &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>scopeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is not active for the current thread; consider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                            <span style=color:#4e9a06>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cleanupAfterBeanCreationFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 如果需要进行类型转换，则在此处进行转换。类型转换这一块我没细看，就不多说了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTypeConverter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>convertIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeMismatchException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                        <span style=color:#000>ClassUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQualifiedName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanNotOfRequiredTypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 返回 bean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=createbean>createBean</h3>
<p>大家应该也猜到了，接下来当然是分析 createBean 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>第三个参数 args 数组代表创建实例需要的参数，不就是给构造方法用的参数，或者是工厂 Bean 的参数嘛，不过要注意，在我们的初始化阶段，args 是 null。</p>
<p>这回我们要到一个新的类了 AbstractAutowireCapableBeanFactory，看类名，AutowireCapable？类名是不是也说明了点问题了。</p>
<p>主要是为了以下场景，采用 @Autowired 注解注入属性值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MessageServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MessageService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserService</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;messageService&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;com.example.MessageServiceImpl&#34;</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</code></pre></div><p>以上这种属于混用了 xml 和 注解 两种方式的配置方式，Spring 会处理这种情况。</p>
<p>好了，读者要知道这么回事就可以了，继续向前。</p>
<p>// AbstractAutowireCapableBeanFactory.java 447</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Central method of this class: creates a bean instance,
</span><span style=color:#8f5902;font-style:italic> * populates the bean instance, applies post-processors, etc.
</span><span style=color:#8f5902;font-style:italic> * @see #doCreateBean
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 确保 BeanDefinition 中的 Class 被加载
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasBeanClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClassName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolvedClass</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 准备方法覆写，这里又涉及到一个概念：MethodOverrides，它来自于 bean 定义中的 &lt;lookup-method /&gt; 
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 和 &lt;replaced-method /&gt;，如果读者感兴趣，回到 bean 解析的地方看看对这两个标签的解析。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我在附录中也对这两个标签的相关知识点进行了介绍，读者可以移步去看看
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepareMethodOverrides</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanDefinitionStoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Validation of method overrides failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 让 InstantiationAwareBeanPostProcessor 在这一步有机会返回代理，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeforeInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span> 
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;BeanPostProcessor before instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 重头戏，创建 bean
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbdToUse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finished creating instance of bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们继续往里看 doCreateBean 这个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// Instantiate the bean.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>BeanWrapper</span> <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factoryBeanInstanceCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 说明不是 FactoryBean，这里实例化 Bean，这里非常关键，细节之后再说
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 这个就是 Bean 里面的 我们定义的类 的实例，很多地方我直接描述成 &#34;bean 实例&#34;
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 类型
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instanceWrapper</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedTargetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#8f5902;font-style:italic>// 建议跳过吧，涉及接口：MergedBeanDefinitionPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessingLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// MergedBeanDefinitionPostProcessor，这个我真不展开说了，直接跳过吧，很少用的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>applyMergedBeanDefinitionPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                  <span style=color:#4e9a06>&#34;Post-processing of merged bean definition failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Eagerly cache singletons to be able to resolve circular references
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// even when triggered by lifecycle interfaces like BeanFactoryAware.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 下面这块代码是为了解决循环依赖的问题
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
         <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Eagerly caching bean &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span>
               <span style=color:#4e9a06>&#34;&#39; to allow for resolving potential circular references&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Initialize the bean instance.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 这一步也是非常关键的，这一步负责属性装配，因为前面的实例只是实例化了，并没有设值，这里就是设值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 还记得 init-method 吗？还有 InitializingBean 接口？还有 BeanPostProcessor 接口？
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 这里就是处理 bean 初始化完成后的各种回调
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>BeanCreationException</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBeanName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Initialization of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowRawInjectionDespiteWrapping</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasDependentBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDependentBeans</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>actualDependentBeans</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>dependentBean</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>removeSingletonIfCreatedForTypeCheckOnly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dependentBean</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#4e9a06>&#34;Bean with name &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; has been injected into other beans [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collectionToCommaDelimitedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>actualDependentBeans</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;] in its raw version as part of a circular reference, but has eventually been &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;wrapped. This means that said other beans do not use the final version of the &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;bean. This is often the result of over-eager type matching - consider using &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
                     <span style=color:#4e9a06>&#34;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// Register bean as disposable.
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerDisposableBeanIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionValidationException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invalid destruction signature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们已经分析完了 doCreateBean 方法，总的来说，我们已经说完了整个初始化流程。</p>
<p>接下来我们挑 doCreateBean 中的三个细节出来说说。</p>
<p>一个是创建 Bean 实例的 createBeanInstance 方法，一个是依赖注入的 populateBean 方法，还有就是回调方法 initializeBean。</p>
<p>注意了，接下来的这三个方法要认真说那也是极其复杂的，很多地方我就点到为止了，感兴趣的读者可以自己往里看，最好就是碰到不懂的，自己写代码去调试它。</p>
<h4 id=创建-bean-实例>创建 Bean 实例</h4>
<p>我们先看看 createBeanInstance 方法。需要说明的是，这个方法如果每个分支都分析下去，必然也是极其复杂冗长的，我们挑重点说。此方法的目的就是实例化我们指定的类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>createBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// 确保已经加载了此 class
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#8f5902;font-style:italic>// 校验一下这个类的访问权限
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPublic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNonPublicAccessAllowed</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;Bean class isn&#39;t public, and non-public access not allowed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFactoryMethodName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 采用工厂方法实例化，不熟悉这个概念的读者请看附录，注意，不是 FactoryBean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateUsingFactoryMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 如果不是第一次创建，比如第二次创建 prototype bean。
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 这种情况下，我们可以从第一次创建知道，采用无参构造函数，还是构造函数依赖注入 来完成实例化
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>resolved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>autowireNecessary</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentsResolved</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autowireNecessary</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 判断是否采用有参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>determineConstructorsFromBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctors</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_CONSTRUCTOR</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasConstructorArgumentValues</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ObjectUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 构造函数依赖注入
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>autowireConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ctors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 调用无参构造函数
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>挑个简单的<strong>无参构造函数</strong>构造实例来看看：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>instantiateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Object</span> <span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

               <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// 实例化
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 包装一下，返回
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapperImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>initBeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Instantiation of bean failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以看到，关键的地方在于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>beanInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInstantiationStrategy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这里会进行实际的实例化过程，我们进去看看:</p>
<p>// SimpleInstantiationStrategy 59</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>instantiate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RootBeanDefinition</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanFactory</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

   <span style=color:#8f5902;font-style:italic>// 如果不存在方法覆写，那就使用 java 反射进行实例化，否则使用 CGLIB,
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 方法覆写 请参见附录&#34;方法注入&#34;中对 lookup-method 和 replaced-method 的介绍
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodOverrides</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorArgumentLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Specified class is an interface&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedExceptionAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                     <span style=color:#5c35cc;font-weight:700>@Override</span>
                     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                     <span style=color:#ce5c00;font-weight:700>}</span>
                  <span style=color:#ce5c00;font-weight:700>});</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>constructorToUse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredConstructor</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
               <span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolvedConstructorOrFactoryMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanInstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;No default constructor found&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 利用构造方法进行实例化
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instantiateClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructorToUse</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存在方法覆写，利用 CGLIB 来完成实例化，需要依赖于 CGLIB 生成子类，这里就不展开了。
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// tips: 因为如果不使用 CGLIB 的话，存在 override 的情况 JDK 并没有提供相应的实例化支持
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instantiateWithMethodInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>到这里，我们就算实例化完成了。我们开始说怎么进行属性注入。</p>
<h4 id=bean-属性注入>bean 属性注入</h4>
<p>看完了 createBeanInstance(&mldr;) 方法，我们来看看 populateBean(&mldr;) 方法，该方法负责进行属性设值，处理依赖。</p>
<p>// AbstractAutowireCapableBeanFactory 1203</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BeanWrapper</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// bean 实例的所有属性都在这里了
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>PropertyValues</span> <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPropertyValues</span><span style=color:#ce5c00;font-weight:700>();</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
               <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Cannot apply property values to null instance&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#8f5902;font-style:italic>// Skip property population phase for null instance.
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#8f5902;font-style:italic>// 到这步的时候，bean 实例化完成（通过工厂方法或构造方法），但是还没开始属性设值，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// InstantiationAwareBeanPostProcessor 的实现类可以在这里对 bean 进行状态修改，
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// 我也没找到有实际的使用，所以我们暂且忽略这块吧
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 如果返回 false，代表不需要进行后续的属性设值，也不需要再经过其他的 BeanPostProcessor 的处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessAfterInstantiation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>continueWithPropertyPopulation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>continueWithPropertyPopulation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span> <span style=color:#ce5c00;font-weight:700>||</span>
         <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MutablePropertyValues</span> <span style=color:#000>newPvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MutablePropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>

      <span style=color:#8f5902;font-style:italic>// 通过名字找到所有属性值，如果是 bean 依赖，先初始化依赖的 bean。记录依赖关系
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_NAME</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#8f5902;font-style:italic>// 通过类型装配。复杂一些
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResolvedAutowireMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTOWIRE_BY_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>autowireByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>

      <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newPvs</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>needsDepCheck</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDependencyCheck</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>RootBeanDefinition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEPENDENCY_CHECK_NONE</span><span style=color:#ce5c00;font-weight:700>);</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>PropertyDescriptor</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredPds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>filterPropertyDescriptorsForDependencyCheck</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCaching</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasInstAwareBpps</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#000>InstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#8f5902;font-style:italic>// 这里有个非常有用的 BeanPostProcessor 进到这里: AutowiredAnnotationBeanPostProcessor
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#8f5902;font-style:italic>// 对采用 @Autowired、@Value 注解的依赖进行设值，这里的内容也是非常丰富的，不过本文不会展开说了，感兴趣的读者请自行研究
</span><span style=color:#8f5902;font-style:italic></span>               <span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>postProcessPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrappedInstance</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
               <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pvs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
               <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>needsDepCheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>checkDependencies</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>filteredPds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#8f5902;font-style:italic>// 设置 bean 实例的属性值
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>applyPropertyValues</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pvs</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=initializebean>initializeBean</h4>
<p>属性注入完成后，这一步其实就是处理各种回调了，这块代码比较简单。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#5c35cc;font-weight:700>@Override</span>
         <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>getAccessControlContext</span><span style=color:#ce5c00;font-weight:700>());</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果 bean 实现了 BeanNameAware、BeanClassLoaderAware 或 BeanFactoryAware 接口，回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeAwareMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#000>Object</span> <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessBeforeInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsBeforeInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 处理 bean 中定义的 init-method，
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 或者如果 bean 实现了 InitializingBean 接口，调用 afterPropertiesSet() 方法
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>invokeInitMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCreationException</span><span style=color:#ce5c00;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceDescription</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Invocation of init method failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>

   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// BeanPostProcessor 的 postProcessAfterInitialization 回调
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>wrappedBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrappedBean</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>大家发现没有，BeanPostProcessor 的两个回调都发生在这边，只不过中间处理了 init-method，是不是和读者原来的认知有点不一样了？</p>
<h2 id=相关疑问>相关疑问</h2>
<h4 id=spring-的-bean-在什么时候实例化>Spring 的 bean 在什么时候实例化?</h4>
<p>如果你使用BeanFactory，如 XmlBeanFactory 作为 Spring Bean 的工厂类，则所有的 bean 都是在第一次使用该bean 的时候实例化 。</p>
<p>如果你使用 ApplicationContext 作为 Spring Bean 的工厂类，则又分为以下几种情况：</p>
<ol>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 false（默认是false，所以可以不用设置），则ApplicationContext 启动的时候就实例化该 bean，并且将实例化的 bean 放在一个线程安全的 ConcurrentHashMap 结构的缓存中，下次再使用该 Bean 的时候，直接从这个缓存中取</li>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 true，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化</li>
<li>如果 bean 的 scope 是 prototype 的，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化 。</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7f4178b3d93842e955c6e1949a1a8205>5 - CH05-循环依赖</h1>
<h2 id=创建过程>创建过程</h2>
<p>Java 对象的创建步骤很多，可以 <code>new XXX</code>、序列化、<code>clone()</code> 等等， 只是 Spring 是通过反射 + 工厂的方式创建对象并放在容器的，创建好的对象我们一般还会对对象属性进行赋值，才去使用，可以理解是分了两个步骤。</p>
<h2 id=什么是循环依赖>什么是循环依赖</h2>
<p>所谓的循环依赖是指，A 依赖 B，B 又依赖 A，它们之间形成了循环依赖。或者是 A 依赖 B，B 依赖 C，C 又依赖 A，形成了循环依赖。更或者是自己依赖自己。它们之间的依赖关系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134049.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这里以两个类直接相互依赖为例，他们的实现代码可能如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanB</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanA</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanA</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BeanA</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBeanB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanB</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beanB</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>beanB</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>配置信息如下（用注解方式注入同理，只是为了方便理解，用了配置文件）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanA&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanB&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>Spring 启动后，读取如上的配置文件，会按顺序先实例化 A，但是创建的时候又发现它依赖了 B，接着就去实例化 B ，同样又发现它依赖了 A ，这尼玛咋整？无限循环呀</p>
<p>Spring “肯定”不会让这种事情发生的，如前言我们说的 Spring 实例化对象分两步，第一步会先创建一个原始对象，只是没有设置属性，可以理解为"半成品"—— 官方叫 A 对象的早期引用（EarlyBeanReference），所以当实例化 B 的时候发现依赖了 A， B 就会把这个“半成品”设置进去先完成实例化，既然 B 完成了实例化，所以 A 就可以获得 B 的引用，也完成实例化了，这其实就是 Spring 解决循环依赖的思想。</p>
<h2 id=源码实现>源码实现</h2>
<p>在 Spring IOC 容器读取 Bean 配置创建 Bean 实例之前, 必须对它进行实例化。只有在容器实例化后，才可以从 IOC 容器里获取 Bean 实例并使用，循环依赖问题也就是发生在实例化 Bean 的过程中的，所以我们先回顾下获取 Bean 的过程。</p>
<h3 id=获取-bean-流程>获取 Bean 流程</h3>
<p>Spring IOC 容器中获取 bean 实例的简化版流程如下（排除了各种包装和检查的过程）</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134307.png style=display:block;width:50% alt=NAME align=center> </div>
<p>大概的流程顺序：</p>
<ol>
<li>流程从 <code>getBean</code> 方法开始，<code>getBean</code> 是个空壳方法，所有逻辑直接到 <code>doGetBean</code> 方法中</li>
<li><code>transformedBeanName</code> 将 name 转换为真正的 beanName（name 可能是 FactoryBean 以 & 字符开头或者有别名的情况，所以需要转化下）</li>
<li>然后通过 <code>getSingleton(beanName)</code> 方法尝试从缓存中查找是不是有该实例 sharedInstance（单例在 Spring 的同一容器只会被创建一次，后续再获取 bean，就直接从缓存获取即可）</li>
<li>如果有的话，sharedInstance 可能是完全实例化好的 bean，也可能是一个原始的 bean，所以再经 <code>getObjectForBeanInstance</code> 处理即可返回</li>
<li>当然 sharedInstance 也可能是 null，这时候就会执行创建 bean 的逻辑，将结果返回</li>
</ol>
<p>第三步的时候我们提到了一个缓存的概念，这个就是 Spring 为了解决单例的循环依赖问题而设计的 <strong>三级缓存</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** Cache of singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>singletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>256</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>singletonFactories</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>/** Cache of early singleton objects: bean name --&gt; bean instance */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>earlySingletonObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这三级缓存的作用分别是：</p>
<ul>
<li><code>singletonObjects</code>：完成初始化的单例对象的 cache，这里的 bean 经历过 <code>实例化->属性填充->初始化</code> 以及各种后置处理（一级缓存）</li>
<li><code>earlySingletonObjects</code>：存放原始的 bean 对象（<strong>完成实例化但是尚未填充属性和初始化</strong>），仅仅能作为指针提前曝光，被其他 bean 所引用，用于解决循环依赖的 （二级缓存）</li>
<li><code>singletonFactories</code>：在 bean 实例化完之后，属性填充以及初始化之前，如果允许提前曝光，Spring 会将实例化后的 bean 提前曝光，也就是把该 bean 转换成 <code>beanFactory</code> 并加入到 <code>singletonFactories</code>（三级缓存）</li>
</ul>
<p>我们首先从缓存中试着获取 bean，就是从这三级缓存中查找：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从 singletonObjects 获取实例，singletonObjects 中的实例都是准备好的 bean 实例，可以直接使用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//isSingletonCurrentlyInCreation() 判断当前单例bean是否正在创建中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 一级缓存没有，就去二级缓存找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>allowEarlyReference</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 二级缓存也没有，就去三级缓存找
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 三级缓存有的话，就把他移动到二级缓存,.getObject() 后续会讲到
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果缓存没有的话，我们就要创建了，接着我们以单例对象为例，再看下创建 bean 的逻辑（大括号表示内部类调用方法）：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134749.png style=display:block;width:50% alt=NAME align=center> </div>
<ol>
<li>
<p>创建 bean 从以下代码开始，一个匿名内部类方法参数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sharedInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeansException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>destroySingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectForBeanInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedInstance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>getSingleton()</code> 方法内部主要有两个方法</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建 singletonObject
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 将 singletonObject 放入缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p><code>getObject()</code> 匿名内部类的实现真正调用的又是 <code>createBean(beanName, mbd, args)</code></p>
</li>
<li>
<p>往里走，主要的实现逻辑在 <code>doCreateBean</code>方法，先通过 <code>createBeanInstance</code> 创建一个原始 bean 对象</p>
</li>
<li>
<p>接着 <code>addSingletonFactory</code> 添加 bean 工厂对象到 singletonFactories 缓存（三级缓存）</p>
</li>
<li>
<p>通过 <code>populateBean</code> 方法向原始 bean 对象中填充属性，并解析依赖，假设这时候创建 A 之后填充属性时发现依赖 B，然后创建依赖对象 B 的时候又发现依赖 A，还是同样的流程，又去 <code>getBean(A)</code>，这个时候三级缓存已经有了 beanA 的“半成品”，这时就可以把 A 对象的原始引用注入 B 对象（并将其移动到二级缓存）来解决循环依赖问题。这时候 <code>getObject()</code> 方法就算执行结束了，返回完全实例化的 bean</p>
</li>
<li>
<p>最后调用 <code>addSingleton</code> 把完全实例化好的 bean 对象放入 singletonObjects 缓存（一级缓存）中</p>
</li>
</ol>
<h2 id=spring-解决循环依赖>Spring 解决循环依赖</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503134858.png style=display:block;width:50% alt=NAME align=center> </div>
<p>流程其实上边都已经说过了，结合着上图我们再看下具体细节，用大白话再捋一捋：</p>
<ol>
<li>Spring 创建 bean 主要分为两个步骤，创建原始 bean 对象，接着去填充对象属性和初始化</li>
<li>每次创建 bean 之前，我们都会从缓存中查下有没有该 bean，因为是单例，只能有一个</li>
<li>当我们创建 beanA 的原始对象后，并把它放到三级缓存中，接下来就该填充对象属性了，这时候发现依赖了 beanB，接着就又去创建 beanB，同样的流程，创建完 beanB 填充属性时又发现它依赖了 beanA，又是同样的流程，不同的是，这时候可以在三级缓存中查到刚放进去的原始对象 beanA，所以不需要继续创建，用它注入 beanB，完成 beanB 的创建</li>
<li>既然 beanB 创建好了，所以 beanA 就可以完成填充属性的步骤了，接着执行剩下的逻辑，闭环完成</li>
</ol>
<p>但是为什么需要三级缓存，二级缓存不够用吗？</p>
<p>跟源码的时候，发现在创建 beanB 需要引用 beanA 这个“半成品”的时候，就会触发"前期引用"，即如下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ObjectFactory</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>singletonFactory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 三级缓存有的话，就把他移动到二级缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>singletonObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>singletonFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlySingletonObjects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>singletonObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonFactories</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>singletonFactory.getObject()</code> 是一个接口方法，这里具体的实现方法在</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RootBeanDefinition</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSynthetic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>hasInstantiationAwareBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanPostProcessor</span> <span style=color:#000>bp</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getBeanPostProcessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bp</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#000>ibp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>bp</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 这么一大段就这句话是核心，也就是当bean要进行提前曝光时，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 给一个机会，通过重写后置处理器的getEarlyBeanReference方法，来自定义操作bean
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 值得注意的是，如果提前曝光了，但是没有被提前引用，则该后置处理器并不生效!!!
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 这也正式三级缓存存在的意义，否则二级缓存就可以解决循环依赖的问题
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ibp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>它的目的是为了后置处理，如果没有 AOP 后置处理，就不会走进 if 语句，直接返回了 exposedObject ，相当于啥都没干，二级缓存就够用了。</p>
<p>所以又得出结论，这个三级缓存应该和 AOP 有关系，继续。</p>
<p>在 Spring 的源码中<code>getEarlyBeanReference</code> 是 <code>SmartInstantiationAwareBeanPostProcessor</code> 接口的默认方法，真正实现这个方法的只有**<code>AbstractAutoProxyCreator</code>** 这个类，用于提前曝光的 AOP 代理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#000>Object</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>earlyProxyReferences</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#8f5902;font-style:italic>// 对bean进行提前Spring AOP代理
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapIfNecessary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这么说有点干，来个小 demo 吧，我们都知道 <strong>Spring AOP、事务</strong>等都是通过代理对象来实现的，而<strong>事务</strong>的代理对象是由自动代理创建器来自动完成的。也就是说 Spring 最终给我们放进容器里面的是一个代理对象，<strong>而非原始对象</strong>，假设我们有如下一段业务代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>HelloService</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#5c35cc;font-weight:700>@Autowired</span>
   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HelloService</span> <span style=color:#000>helloService</span><span style=color:#ce5c00;font-weight:700>;</span>

   <span style=color:#5c35cc;font-weight:700>@Override</span>
   <span style=color:#5c35cc;font-weight:700>@Transactional</span>
   <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Hello JavaKeeper&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此 <code>Service</code> 类使用到了事务，所以最终会生成一个 JDK 动态代理对象 <code>Proxy</code>。刚好它又存在<strong>自己引用自己</strong>的循环依赖，完美符合我们的场景需求。</p>
<p>我们再自定义一个后置处理，来看下效果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloProcessor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SmartInstantiationAwareBeanPostProcessor</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>BeansException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;提前曝光了：&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，调用方法栈中有我们自己实现的 <code>HelloProcessor</code>，说明这个 bean 会通过 AOP 代理处理。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503135143.png style=display:block;width:50% alt=NAME align=center> </div>
<p>再从源码看下这个自己循环自己的 bean 的创建流程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>doCreateBean</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>){</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
	
	<span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>earlySingletonExposure</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSingleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allowCircularReferences</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isSingletonCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 需要提前暴露（支持循环依赖），就注册一个ObjectFactory到三级缓存
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#8f5902;font-style:italic>// 添加 bean 工厂对象到 singletonFactories 缓存中，并获取原始对象的早期引用
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>//匿名内部方法 getEarlyBeanReference 就是后置处理器	
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// SmartInstantiationAwareBeanPostProcessor 的一个方法，
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 它的功效为：保证自己被循环依赖的时候，即使被别的Bean @Autowire进去的也是代理对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>addSingletonFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>getEarlyBeanReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>));</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// 此处注意：如果此处自己被循环依赖了  那它会走上面的getEarlyBeanReference，从而创建一个代理对象从		三级缓存转移到二级缓存里
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// 注意此时候对象还在二级缓存里，并没有在一级缓存。并且此时后续的这两步操作还是用的 exposedObject，它仍旧是原始对象~~~
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>populateBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>instanceWrapper</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initializeBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exposedObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mbd</span><span style=color:#ce5c00;font-weight:700>);</span>

	<span style=color:#8f5902;font-style:italic>// 因为事务的AOP自动代理创建器在getEarlyBeanReference 创建代理后，initializeBean 就不会再重复创建了，二选一的）
</span><span style=color:#8f5902;font-style:italic></span>    	
	<span style=color:#8f5902;font-style:italic>// 所以经过这两大步后，exposedObject 还是原始对象，通过 getEarlyBeanReference 创建的代理对象还在三级缓存呢
</span><span style=color:#8f5902;font-style:italic></span>	
	<span style=color:#ce5c00;font-weight:700>...</span>
	
	<span style=color:#8f5902;font-style:italic>// 循环依赖校验
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonExposure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 注意此处第二个参数传的false，表示不去三级缓存里再去调用一次getObject()方法了~~~，此时代理对象还在二级缓存，所以这里拿出来的就是个 代理对象
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 最后赋值给exposedObject  然后return出去，进而最终被addSingleton()添加进一级缓存里面去  
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 这样就保证了我们容器里 最终实际上是代理对象，而非原始对象~~~~~
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>Object</span> <span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSingleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>earlySingletonReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
				<span style=color:#000>exposedObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>earlySingletonReference</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>...</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=非单例循环依赖>非单例循环依赖</h3>
<p>看完了单例模式的循环依赖，我们再看下非单例的情况，假设我们的配置文件是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanA&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanB&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;beanB&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;priv.starfish.BeanB&#34;</span> <span style=color:#c4a000>scope=</span><span style=color:#4e9a06>&#34;prototype&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;beanA&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;beanA&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>启动 Spring，结果如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span> <span style=color:#000>defined</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>path</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xml</span><span style=color:#ce5c00;font-weight:700>]:</span> <span style=color:#000>Cannot</span> <span style=color:#000>resolve</span> <span style=color:#000>reference</span> <span style=color:#000>to</span> <span style=color:#000>bean</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000>setting</span> <span style=color:#000>bean</span> <span style=color:#000>property</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanB</span><span style=color:#a40000>&#39;</span> <span style=color:#000>defined</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>path</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>applicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>xml</span><span style=color:#ce5c00;font-weight:700>]:</span> <span style=color:#000>Cannot</span> <span style=color:#000>resolve</span> <span style=color:#000>reference</span> <span style=color:#000>to</span> <span style=color:#000>bean</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000>setting</span> <span style=color:#000>bean</span> <span style=color:#000>property</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>Caused</span> <span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>springframework</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beans</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Error</span> <span style=color:#000>creating</span> <span style=color:#000>bean</span> <span style=color:#000>with</span> <span style=color:#000>name</span> <span style=color:#a40000>&#39;</span><span style=color:#000>beanA</span><span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Requested</span> <span style=color:#000>bean</span> <span style=color:#000>is</span> <span style=color:#000>currently</span> <span style=color:#000>in</span> <span style=color:#000>creation</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Is</span> <span style=color:#000>there</span> <span style=color:#000>an</span> <span style=color:#000>unresolvable</span> <span style=color:#000>circular</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>?</span>
</code></pre></div><p>对于 <code>prototype</code> 作用域的 bean，Spring 容器无法完成依赖注入，因为 Spring 容器不进行缓存 <code>prototype</code> 作用域的 bean ，因此无法提前暴露一个创建中的bean 。</p>
<p>原因也挺好理解的，原型模式每次请求都会创建一个实例对象，即使加了缓存，循环引用太多的话，就比较麻烦了就，所以 Spring 不支持这种方式，直接抛出异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrototypeCurrentlyInCreation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanCurrentlyInCreationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanName</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=构造器循环依赖>构造器循环依赖</h3>
<p>如果您主要使用构造器注入，循环依赖场景是无法解决的。建议你用 setter 注入方式代替构造器注入</p>
<p>其实也不是说只要是构造器注入就会有循环依赖问题，Spring 在创建 Bean 的时候默认是<strong>按照自然排序来进行创建的</strong>，我们暂且把先创建的 bean 叫主 bean，上文的 A 即主 bean，<strong>只要主 bean 注入依赖 bean 的方式是 setter 方式，依赖 bean 的注入方式无所谓，都可以解决，反之亦然</strong></p>
<p>所以上文我们 AB 循环依赖问题，只要 A 的注入方式是 setter ，就不会有循环依赖问题。</p>
<blockquote>
<p><strong>Spring 解决循环依赖依靠的是 Bean 的“中间态”这个概念，而这个中间态指的是已经实例化，但还没初始化的状态。实例化的过程又是通过构造器创建的，如果 A 还没创建好出来，怎么可能提前曝光，所以构造器的循环依赖无法解决，我一直认为应该先有鸡才能有蛋</strong>。</p>
</blockquote>
<h2 id=总结>总结</h2>
<h4 id=b-中提前注入了一个没有经过初始化的-a-类型对象不会有问题吗>B 中提前注入了一个没有经过初始化的 A 类型对象不会有问题吗？</h4>
<p>虽然在创建 B 时会提前给 B 注入了一个还未初始化的 A 对象，但是在创建 A 的流程中一直使用的是注入到 B 中的 A 对象的引用，之后会根据这个引用对 A 进行初始化，所以这是没有问题的。</p>
<h4 id=spring-是如何解决的循环依赖>Spring 是如何解决的循环依赖？</h4>
<p>Spring 为了解决单例的循环依赖问题，使用了三级缓存。其中一级缓存为单例池（<code>singletonObjects</code>），二级缓存为提前曝光对象（<code>earlySingletonObjects</code>），三级缓存为提前曝光对象工厂（<code>singletonFactories</code>）。</p>
<p>假设A、B循环引用，实例化 A 的时候就将其放入三级缓存中，接着填充属性的时候，发现依赖了 B，同样的流程也是实例化后放入三级缓存，接着去填充属性时又发现自己依赖 A，这时候从缓存中查找到早期暴露的 A，没有 AOP 代理的话，直接将 A 的原始对象注入 B，完成 B 的初始化后，进行属性填充和初始化，这时候 B 完成后，就去完成剩下的 A 的步骤，如果有 AOP 代理，就进行 AOP 处理获取代理后的对象 A，注入 B，走剩下的流程。</p>
<h4 id=为什么要使用三级缓存呢二级缓存能解决循环依赖吗>为什么要使用三级缓存呢？二级缓存能解决循环依赖吗？</h4>
<p>如果没有 AOP 代理，二级缓存可以解决问题，但是有 AOP 代理的情况下，只用二级缓存就意味着所有 Bean 在实例化后就要完成 AOP 代理，这样违背了 Spring 设计的原则，Spring 在设计之初就是通过 <code>AnnotationAwareAspectJAutoProxyCreator</code> 这个后置处理器来在 Bean 生命周期的最后一步来完成 AOP 代理，而不是在实例化后就立马进行 AOP 代理。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c6fbf53ed8e298648885933a5a812487>6 - CH07-动态代理</h1>
<p>代理模式是一种设计模式，能够使得在不修改源目标的前提下，额外扩展源目标的功能。即通过访问源目标的代理类，再由代理类去访问源目标。这样一来，要扩展功能，就无需修改源目标的代码了。只需要在代理类上增加就可以了。</p>
<p>其实代理模式的核心思想就是这么简单，在java中，代理又分静态代理和动态代理2种，其中动态代理根据不同实现又区分基于接口的的动态代理和基于子类的动态代理。</p>
<p>其中静态代理由于比较简单，面试中也没啥问的，在代理模式一块，问的最多就是动态代理，而且动态代理也是spring aop的核心思想，spring其他很多功能也是通过动态代理来实现的，比如拦截器，事务控制等。</p>
<p>熟练掌握动态代理技术，能让你业务代码更加精简而优雅。如果你需要写一些中间件的话，那动态代理技术更是必不可少的技能包。</p>
<h2 id=静态代理>静态代理</h2>
<p>在说动态代理前，还是先说说静态代理。</p>
<p>所谓静态代理，就是通过声明一个明确的代理类来访问源对象。</p>
<p>我们有2个接口，Person和Animal。每个接口各有2个实现类，UML如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235143.png style=display:block;width:80% alt=NAME align=center> </div>
<p>每个实现类中代码都差不多一致，用Student来举例（其他类和这个几乎一模一样）</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Student</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wakeup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StrUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;学生[{}]早晨醒来啦&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StrUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;学生[{}]晚上睡觉啦&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>假设我们现在要做一件事，就是在所有的实现类调用<code>wakeup()</code>前增加一行输出<code>早安~</code>，调用<code>sleep()</code>前增加一行输出<code>晚安~</code>。那我们只需要编写2个代理类<code>PersonProxy</code>和<code>AnimalProxy</code>：</p>
<p><strong>PersonProxy:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PersonProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Person</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PersonProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Person</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wakeup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>AnimalProxy:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnimalProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Animal</span> <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnimalProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Animal</span> <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>animal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wakeup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>最终执行代码为：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Person</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>PersonProxy</span> <span style=color:#000>studentProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>studentProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>studentProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Person</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>PersonProxy</span> <span style=color:#000>doctorProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>doctorProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctorProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Animal</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>AnimalProxy</span> <span style=color:#000>dogProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnimalProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>dogProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dogProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>Animal</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>AnimalProxy</span> <span style=color:#000>catProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnimalProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>catProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>catProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-css data-lang=css><span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>学生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>张三</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>学生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>张三</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
<span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>医生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>王教授</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~</span>
<span style=color:#204a87;font-weight:700>医生</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>王教授</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
<span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小狗</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>旺旺</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小狗</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>旺旺</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
<span style=color:#204a87;font-weight:700>早安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小猫</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>咪咪</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>早晨醒来啦</span>
<span style=color:#204a87;font-weight:700>晚安</span><span style=color:#ce5c00;font-weight:700>~~</span>
<span style=color:#204a87;font-weight:700>小猫</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>咪咪</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>晚上睡觉啦</span>
</code></pre></div><p><strong>结论：</strong></p>
<p>静态代理的代码相信已经不用多说了，代码非常简单易懂。这里用了2个代理类，分别代理了<code>Person</code>和<code>Animal</code>接口。</p>
<p>这种模式虽然好理解，但是缺点也很明显：</p>
<ul>
<li>会存在大量的冗余的代理类，这里演示了2个接口，如果有10个接口，就必须定义10个代理类。</li>
<li>不易维护，一旦接口更改，代理类和目标类都需要更改。</li>
</ul>
<h2 id=jdk-动态代理>JDK 动态代理</h2>
<p>动态代理，通俗点说就是：无需声明式的创建java代理类，而是在运行过程中生成"虚拟"的代理类，被ClassLoader加载。从而避免了静态代理那样需要声明大量的代理类。</p>
<p>JDK从1.3版本就开始支持动态代理类的创建。主要核心类只有2个：<code>java.lang.reflect.Proxy</code>和<code>java.lang.reflect.InvocationHandler</code>。</p>
<p>还是前面那个例子，用JDK动态代理类去实现的代码如下：</p>
<p><strong>创建一个JdkProxy类，用于统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JdkProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>JdkProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Person</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Person</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Animal</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdkProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Animal</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>可以看到，相对于静态代理类来说，无论有多少接口，这里只需要一个代理类。核心代码也很简单。唯一需要注意的点有以下2点：</p>
<ul>
<li>
<p>JDK动态代理是需要声明接口的，创建一个动态代理类必须得给这个”虚拟“的类一个接口。可以看到，这时候经动态代理类创造之后的每个bean已经不是原来那个对象了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235402.png style=display:block;width:80% alt=NAME align=center> </div>
</li>
<li>
<p>为什么这里<code>JdkProxy</code>还需要构造传入原有的bean呢？因为处理完附加的功能外，需要执行原有bean的方法，以完成<code>代理</code>的职责。</p>
<p>这里<code>JdkProxy</code>最核心的方法就是</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span>
</code></pre></div><p>其中proxy为代理过之后的对象(并不是原对象)，method为被代理的方法，args为方法的参数。</p>
<p>如果你不传原有的bean，直接用<code>method.invoke(proxy, args)</code>的话，那么就会陷入一个死循环。</p>
</li>
</ul>
<p><strong>可以代理什么</strong></p>
<p>JDK的动态代理是也平时大家使用的最多的一种代理方式。也叫做接口代理。前几天有一个小伙伴在群里问我，动态代理是否一次可以代理一个类，多个类可不可以。</p>
<p>JDK动态代理说白了只是根据接口”凭空“来生成类，至于具体的执行，都被代理到了<code>InvocationHandler</code> 的实现类里。上述例子我是需要继续执行原有bean的逻辑，才将原有的bean构造进来。只要你需要，你可以构造进任何对象到这个代理实现类。也就是说，你可以传入多个对象，或者说你什么类都不代理。只是为某一个接口”凭空“的生成多个代理实例，这多个代理实例最终都会进入<code>InvocationHandler</code>的实现类来执行某一个段共同的代码。</p>
<p>所以，在以往的项目中的一个实际场景就是，我有多个以yaml定义的规则文件，通过对yaml文件的扫描，来为每个yaml规则文件生成一个动态代理类。而实现这个，我只需要事先定义一个接口，和定义<code>InvocationHandler</code>的实现类就可以了，同时把yaml解析过的对象传入。最终这些动态代理类都会进入<code>invoke</code>方法来执行某个共同的逻辑。</p>
<h2 id=cglib-动态代理>Cglib 动态代理</h2>
<p>Spring在5.X之前默认的动态代理实现一直是jdk动态代理。但是从5.X开始，spring就开始默认使用Cglib来作为动态代理实现。并且springboot从2.X开始也转向了Cglib动态代理实现。</p>
<p>是什么导致了spring体系整体转投Cglib呢，jdk动态代理又有什么缺点呢？</p>
<p>那么我们现在就要来说下Cglib的动态代理。</p>
<p>Cglib是一个开源项目，它的底层是字节码处理框架ASM，Cglib提供了比jdk更为强大的动态代理。主要相比jdk动态代理的优势有：</p>
<ul>
<li>jdk动态代理只能基于接口，代理生成的对象只能赋值给接口变量，而Cglib就不存在这个问题，Cglib是通过生成子类来实现的，代理对象既可以赋值给实现类，又可以赋值给接口。</li>
<li>Cglib速度比jdk动态代理更快，性能更好。</li>
</ul>
<p>那何谓通过子类来实现呢？</p>
<p>还是前面那个例子，我们要实现相同的效果。代码如下</p>
<p><strong>创建CglibProxy类，用于统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CglibProxy</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>MethodInterceptor</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Enhancer</span> <span style=color:#000>enhancer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Enhancer</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#8f5902;font-style:italic>//设置需要创建子类的类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//通过字节码技术动态创建子类实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//实现MethodInterceptor接口方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodProxy</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//调用原bean的方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>CglibProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Student</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Doctor</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CglibProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Cat</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>在这里用Cglib作为代理，其思路和jdk动态代理差不多。也需要把原始bean构造传入。原因上面有说，这里不多赘述。</p>
<p>关键的代码在这里</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//设置需要创建子类的类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>//通过字节码技术动态创建子类实例
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>可以看到，Cglib"凭空"的创造了一个原bean的子类，并把Callback指向了this，也就是当前对象，也就是这个proxy对象。从而会调用<code>intercept</code>方法。而在<code>intercept</code>方法里，进行了附加功能的执行，最后还是调用了原始bean的相应方法。</p>
<p>在debug这个生成的代理对象时，我们也能看到，Cglib是凭空生成了原始bean的子类：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235506.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=javassist-动态代理>javassist 动态代理</h2>
<p>Javassist是一个开源的分析、编辑和创建Java字节码的类库，可以直接编辑和生成Java生成的字节码。相对于bcel, asm等这些工具，开发者不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成类。</p>
<p>在日常使用中，javassit通常被用来动态修改字节码。它也能用来实现动态代理的功能。</p>
<p>话不多说，还是一样的例子，我用javassist动态代理来实现一遍</p>
<p><strong>创建JavassitProxy，用作统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JavassitProxy</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InstantiationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ProxyFactory</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProxyFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>ListUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()));</span>

        <span style=color:#000>Class</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createClass</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>MethodHandler</span> <span style=color:#000>mi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proceed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#000>Object</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>setHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mi</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>JavassitProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Student</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Doctor</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavassitProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Cat</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>熟悉的配方，熟悉的味道，大致思路也是类似的。同样把原始bean构造传入。可以看到，javassist也是用”凭空“生成子类的方式类来解决，代码的最后也是调用了原始bean的目标方法完成代理。</p>
<p>javaassit比较有特点的是，可以对所需要代理的方法用filter来设定，里面可以像Criteria构造器那样进行构造。其他的代码，如果你仔细看了之前的代码演示，应该能很轻易看懂了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235531.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=bytebuddy-动态代理>ByteBuddy 动态代理</h2>
<p>ByteBuddy，字节码伙计，一听就很牛逼有不。</p>
<p>ByteBuddy也是一个大名鼎鼎的开源库，和Cglib一样，也是基于ASM实现。还有一个名气更大的库叫Mockito，相信不少人用过这玩意写过测试用例，其核心就是基于ByteBuddy来实现的，可以动态生成mock类，非常方便。另外ByteBuddy另外一个大的应用就是java agent，其主要作用就是在class被加载之前对其拦截，插入自己的代码。</p>
<p>ByteBuddy非常强大，是一个神器。可以应用在很多场景。但是这里，只介绍用ByteBuddy来做动态代理，关于其他使用方式，可能要专门写一篇来讲述，这里先给自己挖个坑。</p>
<p>来，还是熟悉的例子，熟悉的配方。用ByteBuddy我们再来实现一遍前面的例子</p>
<p><strong>创建ByteBuddyProxy，做统一代理：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ByteBuddyProxy</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getProxy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddy</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>subclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementMatchers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>namedOneOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationHandlerAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AopInvocationHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>make</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLoaded</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AopInvocationHandler</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AopInvocationHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wakeup&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;早安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sleep&#34;</span><span style=color:#ce5c00;font-weight:700>)){</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;晚安~~~&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>执行代码：</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ByteBuddyProxy</span> <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;张三&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Student</span> <span style=color:#000>student</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>student</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;王教授&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Doctor</span> <span style=color:#000>doctor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Doctor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>doctor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;旺旺&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteBuddyProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;咪咪&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Cat</span> <span style=color:#000>cat</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProxy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wakeup</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>cat</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>讲解：</strong></p>
<p>思路和之前还是一样，通过仔细观察代码，ByteBuddy也是采用了创造子类的方式来实现动态代理。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211011235556.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=性能对比>性能对比</h2>
<p>前面介绍了4种动态代理对于同一例子的实现。对于代理的模式可以分为2种：</p>
<ul>
<li>JDK动态代理采用接口代理的模式，代理对象只能赋值给接口，允许多个接口</li>
<li>Cglib，Javassist，ByteBuddy这些都是采用了子类代理的模式，代理对象既可以赋值给接口，又可以复制给具体实现类</li>
</ul>
<p>Spring5.X，Springboot2.X只有都采用了Cglib作为动态代理的实现，那是不是cglib性能是最好的呢？</p>
<p>我这里做了一个简单而粗暴的实验，直接把上述4段执行代码进行单线程同步循环多遍，用耗时来确定他们4个的性能。应该能看出些端倪。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=color:#204a87>JDK</span> PROXY循环10000遍所耗时:0.714970125秒
<span style=color:#a40000>Cglib循环10000遍所耗时:0</span>.<span style=color:#a40000>434937833秒</span>
<span style=color:#a40000>Javassist循环10000遍所耗时:1</span>.<span style=color:#a40000>294194708秒</span>
<span style=color:#a40000>ByteBuddy循环10000遍所耗时:9</span>.<span style=color:#a40000>731999042秒</span>
</code></pre></div><p>执行的结果如上</p>
<p>从执行结果来看，的确是cglib效果最好。至于为什么ByteBuddy执行那么慢，不一定是ByteBuddy性能差，也有可能是我测试代码写的有问题，没有找到正确的方式。所以这只能作为一个大致的参考。</p>
<p>看来Spring选择Cglib还是有道理的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0460c594127706aa4329eb8831b746b4>7 - CH08-接口定义</h1>
<h2 id=接口参数>接口参数</h2>
<p><code>SpringMVC</code>中处理控制器参数的接口是<code>HandlerMethodArgumentResolver</code>，此接口有众多子类，分别处理不同(注解类型)的参数，下面只列举几个子类：</p>
<ul>
<li><code>RequestParamMethodArgumentResolver</code>：解析处理使用了<code>@RequestParam</code>注解的参数、<code>MultipartFile</code>类型参数和<code>Simple</code>类型(如<code>long</code>、<code>int</code>等类型)参数。</li>
<li><code>RequestResponseBodyMethodProcessor</code>：解析处理<code>@RequestBody</code>注解的参数。</li>
<li><code>PathVariableMapMethodArgumentResolver</code>：解析处理<code>@PathVariable</code>注解的参数。</li>
</ul>
<p>实际上，一般在解析一个控制器的请求参数的时候，用到的是<code>HandlerMethodArgumentResolverComposite</code>，里面装载了所有启用的<code>HandlerMethodArgumentResolver</code>子类。而<code>HandlerMethodArgumentResolver</code>子类在解析参数的时候使用到<code>HttpMessageConverter</code>（实际上也是一个列表，进行遍历匹配解析）子类进行匹配解析，常见的如<code>MappingJackson2HttpMessageConverter</code>（使用<code>Jackson</code>进行序列化和反序列化）。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221024.png style=display:block;width:80% alt=NAME align=center> </div>
<p>而<code>HandlerMethodArgumentResolver</code>子类到底依赖什么<code>HttpMessageConverter</code>实例实际上是由请求头中的<code>Content-Type</code>（在<code>SpringMVC</code>中统一命名为<code>MediaType</code>，见<code>org.springframework.http.MediaType</code>）决定的，因此我们在处理控制器的请求参数之前必须要明确外部请求的<code>Content-Type</code>到底是什么。上面的逻辑可以直接看源码<code>AbstractMessageConverterMethodArgumentResolver#readWithMessageConverters</code>，思路是比较清晰的。在<code>@RequestMapping</code>注解中，<code>produces</code>和<code>consumes</code>属性就是和请求的<code>Accept</code>或者响应的<code>Content-Type</code>相关的：</p>
<ul>
<li><code>consumes</code>属性：指定处理请求的提交内容类型（<code>Content-Type</code>），例如<code>application/json</code>、<code>text/html</code>等等，只有命中了对应的<code>Content-Type</code>的值才会接受该请求。</li>
<li><code>produces</code>属性：指定返回的内容类型，仅当某个请求的请求头中的（<code>Accept</code>）类型中包含该指定类型才返回，如果返回的是<code>JSON</code>数据一般考虑使用<code>application/json;charset=UTF-8</code>。</li>
</ul>
<p>另外提一点，<code>SpringMVC</code>中默认使用<code>Jackson</code>作为<code>JSON</code>的工具包，如果不是完全理解透整套源码的运作，一般不是十分建议修改默认使用的<code>MappingJackson2HttpMessageConverter</code>（例如有些人喜欢使用<code>FastJson</code>，实现<code>HttpMessageConverter</code>引入<code>FastJson</code>做<code>HTTP</code>消息转换器，其实这种做法并不推荐）。</p>
<h2 id=请求参数接收>请求参数接收</h2>
<p>其实一般的表单或者<code>JSON</code>数据的请求都是相对简单的，一些复杂的处理主要包括<code>URL</code>路径参数、文件上传、数组或者列表类型数据等。另外，关于参数类型中存在日期类型属性（例如<code>java.util.Date</code>、<code>java.sql.Date</code>、<code>java.time.LocalDate</code>、<code>java.time.LocalDateTime</code>、<code>java.time.ZonedDateTime</code>等等），解析的时候一般需要自定义实现的逻辑实现<code>String-->日期类型</code>的转换。其实道理很简单，日期相关的类型对于每个国家、每个时区甚至每个使用者来说认知都不一定相同，所以<code>SpringMVC</code>并没有对于日期时间类型的解析提供一个通用的解决方案。在演示一些例子可能用到下面的模特类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Contact</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contacts</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Contact</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>phone</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面主要以<code>HTTP</code>的<code>GET</code>方法和<code>POST</code>方法提交在<code>SpringMVC</code>体系中正确处理参数的例子进行分析，还会花精力整理<code>SpringMVC</code>体系中<strong>独有的<code>URL</code>路径参数</strong>处理的一些技巧以及最常见的<strong>日期参数</strong>处理的合理实践（对于<code>GET</code>方法和<code>POST</code>方法提交的参数处理，基本囊括了其他如<code>DELETE</code>、<code>PUT</code>等方法的参数处理，随机应变即可）。</p>
<h3 id=get-方法请求参数处理>GET 方法请求参数处理</h3>
<p><code>HTTP(s)</code>协议使用<code>GET</code>方法进行请求的时候，提交的参数位于<code>URL</code>模式的<code>Query</code>部分，也就是<code>URL</code>的<code>?</code>标识符之后的参数，格式是<code>key1=value1&key2=value2</code>。<code>GET</code>方法请求参数可以有多种方法获取：</p>
<ol>
<li>使用<code>@RequestParam</code>注解处理。</li>
<li>使用对象接收，注意对象的属性名称要和<code>Query</code>中的参数名称一致。</li>
<li>使用<code>HttpServletRequest</code>实例提供的方法（<strong>不推荐，存在硬编码</strong>）。</li>
</ol>
<p>假设请求的<code>URL</code>为<code>http://localhost:8080/get?name=doge&age=26</code>，那么控制器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Slf4j</span>
<span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SampleController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/get1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>get1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name:{},age:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/get2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>get2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserVo</span> <span style=color:#000>vo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name:{},age:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>vo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>vo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAge</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/get3&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>get3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>String</span> <span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name:{},age:{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Data</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserVo</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=表单参数>表单参数</h3>
<p>表单参数，一般对应于页面上<code>&lt;form></code>标签内的所有<code>&lt;input></code>标签的<code>name-value</code>聚合而成的参数，一般<code>Content-Type</code>指定为<code>application/x-www-form-urlencoded</code>，表单参数值也就是会进行（<code>URL</code>）编码。下面介绍几种常见的表单参数提交的参数形式。</p>
<ul>
<li>【非对象】- 非对象类型单个参数接收。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221348.png style=display:block;width:80% alt=NAME align=center> </div>
<p>对应的控制器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/post&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>post</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,age = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>说实话，如果有毅力的话，所有的复杂参数的提交最终都可以转化为多个单参数接收，不过这样做会产生十分多冗余的代码，而且可维护性比较低。这种情况下，用到的参数处理器是<code>RequestParamMapMethodArgumentResolver</code>。</p>
<ul>
<li>【对象】 - 对象类型参数接收。</li>
</ul>
<p>我们接着写一个接口用于提交用户信息，用到的是上面提到的模特类，主要包括用户姓名、年龄和联系人信息列表，这个时候，我们目标的控制器最终编码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>saveUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>加入强行指定<code>Content-Type</code>为<code>application/x-www-form-urlencoded</code>，需要构造请求参数格式如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221439.png style=display:block;width:80% alt=NAME align=center> </div>
<p>因为没有使用注解，最终的参数处理器为<code>ServletModelAttributeMethodProcessor</code>，主要是把<code>HttpServletRequest</code>中的表单参数封装到<code>MutablePropertyValues</code>实例中，再通过参数类型实例化（通过构造反射创建<code>User</code>实例），反射匹配属性进行值的填充。另外，请求复杂参数里面的列表属性请求参数看起来比较奇葩，实际上和在<code>.properties</code>文件中添加最终映射到<code>Map</code>类型的参数的写法是一致的，所以对于嵌套数组或者列表类型的第一层索引要写成<code>firstLevel[index].fieldName</code>的形式。那么，能不能把整个请求参数塞在一个字段中提交呢？</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221551.png style=display:block;width:80% alt=NAME align=center> </div>
<p>直接这样做是不行的，因为实际提交的<code>Form</code>表单，<code>key</code>是<code>user</code>字符串，<code>value</code>实际上也是一个字符串，缺少一个<code>String->User</code>类型的转换器，实际上<code>RequestParamMethodArgumentResolver</code>依赖<code>WebConversionService</code>中<code>Converter</code>实例列表进行参数转换，而默认的<code>Converter</code>列表中肯定不会存在自定义转换<code>String->User</code>类型的转换器：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221613.png style=display:block;width:80% alt=NAME align=center> </div>
<p>解决办法还是有的，添加一个自定义的<code>org.springframework.core.convert.converter.Converter</code>实现即可：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringUserConverter</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Converter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowaired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ObjectMapper</span> <span style=color:#000>objectMapper</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>objectMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
               <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面这种做法属于曲线救国的做法，不推荐使用在生产环境，但是<strong>如果有些第三方接口的对接无法避免这种参数</strong>（这个还真碰到多，有一些远古的遗留系统比较容易出现各种奇葩的操作），可以选择这种实现方式。</p>
<ul>
<li>【数组】 - 列表或者数组类型参数。</li>
</ul>
<p>极度不推荐使用在<code>application/x-www-form-urlencoded</code>这种媒体类型的表单提交的形式下强行使用列表或者数组类型参数，除非是为了兼容处理历史遗留系统的参数提交处理。例如提交的参数形式是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;string-1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;string-2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;string-3&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>那么表单参数的形式要写成：</p>
<table>
<thead>
<tr>
<th style=text-align:center>name</th>
<th style=text-align:center>value</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>list[0]</td>
<td style=text-align:center>string-1</td>
</tr>
<tr>
<td style=text-align:center>list[1]</td>
<td style=text-align:center>string-2</td>
</tr>
<tr>
<td style=text-align:center>list[2]</td>
<td style=text-align:center>string-3</td>
</tr>
</tbody>
</table>
<p>控制器的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/list&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;list&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>一个更加复杂的例子如下，假设想要提交的报文格式如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>user = [{&#34;name&#34;:&#34;doge-1&#34;,&#34;age&#34;: 21},{&#34;name&#34;:&#34;doge-2&#34;,&#34;age&#34;: 22}]
</code></pre></div><p>那么表单参数的形式要写成：</p>
<table>
<thead>
<tr>
<th style=text-align:center>name</th>
<th style=text-align:center>value</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>user[0].name</td>
<td style=text-align:center>doge-1</td>
</tr>
<tr>
<td style=text-align:center>user[0].age</td>
<td style=text-align:center>21</td>
</tr>
<tr>
<td style=text-align:center>user[1].name</td>
<td style=text-align:center>doge-2</td>
</tr>
<tr>
<td style=text-align:center>user[1].age</td>
<td style=text-align:center>22</td>
</tr>
</tbody>
</table>
<p>控制器的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>saveUsers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种传参格式其实并不灵活，甚至有可能降低开发效率和参数可读性。</p>
<h3 id=json-参数>JSON 参数</h3>
<p>一般来说，直接在<code>POST</code>请求中的请求体提交一个<code>JSON</code>字符串这种方式对于<code>SpringMVC</code>来说是比较友好的，只需要把<code>Content-Type</code>设置为<code>application/json</code>，然后直接上传一个原始的<code>JSON</code>字符串即可，控制器方法参数使用<code>@RequestBody</code>注解处理：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221750.png style=display:block;width:80% alt=NAME align=center> </div>
<p>后端控制器的代码也比较简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user-2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>saveUser2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为使用了<code>@RequestBody</code>注解，最终使用到的参数处理器为<code>RequestResponseBodyMethodProcessor</code>，实际上会用到<code>MappingJackson2HttpMessageConverter</code>进行参数类型的转换，底层依赖到<code>Jackson</code>相关的包。<strong>推荐使用这种方式，这是最常用也是最稳健的<code>JSON</code>参数处理方式</strong>。</p>
<h2 id=url-路径参数>URL 路径参数</h2>
<p><code>URL</code>路径参数，或者叫请求路径参数是基于<code>URL</code>模板获取到的参数，例如<code>/user/{userId}</code>是一个<code>URL</code>模板（<code>URL</code>模板中的参数占位符是<code>{}</code>），实际请求的<code>URL</code>为<code>/user/1</code>，那么通过匹配实际请求的<code>URL</code>和<code>URL</code>模板就能提取到<code>userId</code>为1。在<code>SpringMVC</code>中，<code>URL</code>模板中的路径参数叫做<code>Path Variable</code>，对应注解<code>@PathVariable</code>，对应的参数处理器为<code>PathVariableMethodArgumentResolver</code>。<strong>注意一点是，@PathVariable的解析是按照value(name)属性进行匹配，和URL参数的顺序是无关的</strong>。举个简单的例子：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012221851.png style=display:block;width:80% alt=NAME align=center> </div>
<p>后台的控制器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user/{name}/{age}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>findUser1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;age&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Integer</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,age = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种用法被广泛使用于<code>Representational State Transfer(REST)</code>的软件架构风格，个人觉得这种风格是比较灵活和清晰的（从<code>URL</code>和请求方法就能完全理解接口的意义和功能）。下面再介绍两种相对特殊的使用方式。</p>
<ul>
<li>带条件的<code>URL</code>参数。</li>
</ul>
<p>其实路径参数支持正则表达式，例如我们在使用<code>/sex/{sex}</code>接口的时候，要求<code>sex</code>必须是<code>F(Female)</code>或者<code>M(Male)</code>，那么我们的URL模板可以定义为<code>/sex/{sex:M|F}</code>，代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/sex/{sex:M|F}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>findUser2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;sex&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>sex</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sex</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sex</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>只有<code>/sex/F</code>或者<code>/sex/M</code>的请求才会进入<code>findUser2()</code>控制器方法，其他该路径前缀的请求都是非法的，会返回404状态码。这里仅仅是介绍了一个最简单的<code>URL</code>参数正则表达式的使用方式，更强大的用法可以自行摸索。</p>
<ul>
<li><code>@MatrixVariable</code>的使用。</li>
</ul>
<p><code>MatrixVariable</code>也是<code>URL</code>参数的一种，对应注解<code>@MatrixVariable</code>，不过它并不是<code>URL</code>中的一个值(这里的值指定是两个"/&ldquo;之间的部分)，而是值的一部分，它通过&rdquo;;&ldquo;进行分隔，通过&rdquo;=&ldquo;进行K-V设置。说起来有点抽象，举个例子：假如我们需要打电话给一个名字为doge，性别是男，分组是码畜的程序员，<code>GET</code>请求的<code>URL</code>可以表示为：<code>/call/doge;gender=male;group=programmer</code>，我们设计的控制器方法如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/call/{name}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#5c35cc;font-weight:700>@MatrixVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;gender&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>gender</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#5c35cc;font-weight:700>@MatrixVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;group&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,gender = %s,group = %s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>gender</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当然，如果你按照上面的例子写好代码，尝试请求一下该接口发现是报错的：<code>400 Bad Request - Missing matrix variable 'gender' for method parameter of type String</code>。这是因为<code>@MatrixVariable</code>注解的使用是不安全的，在<code>SpringMVC</code>中默认是关闭对其支持。要开启对<code>@MatrixVariable</code>的支持，需要设置<code>RequestMappingHandlerMapping#setRemoveSemicolonContent</code>方法为<code>false</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CustomMvcConfiguration</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InitializingBean</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>RequestMappingHandlerMapping</span> <span style=color:#000>requestMappingHandlerMapping</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>requestMappingHandlerMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setRemoveSemicolonContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>除非有很特殊的需要，否则不建议使用<code>@MatrixVariable</code>。</p>
<h2 id=文件上传>文件上传</h2>
<p>文件上传在使用<code>POSTMAN</code>模拟请求的时候需要选择<code>form-data</code>，<code>POST</code>方式进行提交：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222026.png style=display:block;width:80% alt=NAME align=center> </div>
<p>假设在电脑的磁盘<code>D</code>盘根目录有一个图片文件叫<code>doge.jpg</code>，现在要通过本地服务接口把文件上传，控制器的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/file1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestPart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>MultipartFile</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,originName = %s,size = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOriginalFilename</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>控制台输出是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>originName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doge</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>jpg</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>68727</span>
</code></pre></div><p>可能有点疑惑，参数是怎么来的，我们可以用<code>Fildder</code>软件抓个包看下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222119.png style=display:block;width:80% alt=NAME align=center> </div>
<p>可知<code>MultipartFile</code>实例的主要属性分别来自<code>Content-Disposition</code>、<code>Content-Type</code>和<code>Content-Length</code>，另外，<code>InputStream</code>用于读取请求体的最后部分(文件的字节序列)。参数处理器用到的是<code>RequestPartMethodArgumentResolver</code>（记住一点，使用了<code>@RequestPart</code>和<code>MultipartFile</code>一定是使用此参数处理器）。在其他情况下，使用<code>@RequestParam</code>和<code>MultipartFile</code>或者仅仅使用<code>MultipartFile</code>（参数的名字必须和<code>POST</code>表单中的<code>Content-Disposition</code>描述的<code>name</code>一致）也可以接收上传的文件数据，主要是通过<code>RequestParamMethodArgumentResolver</code>进行解析处理的，它的功能比较强大，具体可以看其<code>supportsParameter</code>方法，这两种情况的控制器方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/file2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>file2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MultipartFile</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,originName = %s,size = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOriginalFilename</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>file1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/file3&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>file3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>MultipartFile</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name = %s,originName = %s,size = %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOriginalFilename</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>multipartFile</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=其他参数>其他参数</h2>
<p>其他参数主要包括请求头、<code>Cookie</code>、<code>Model</code>、<code>Map</code>等相关参数，还有一些并不是很常用或者一些相对原生的属性值获取（例如<code>HttpServletRequest</code>、<code>HttpServletResponse</code>或者它们内置的实例方法等）不做讨论。</p>
<h3 id=请求头>请求头</h3>
<p>请求头的值主要通过<code>@RequestHeader</code>注解的参数获取，参数处理器是<code>RequestHeaderMethodArgumentResolver</code>，需要在注解中指定请求头的<code>Key</code>。简单实用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222207.png style=display:block;width:80% alt=NAME align=center> </div>
<p>控制器方法代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/header&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Content-Type&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=cookie>Cookie</h3>
<p><code>Cookie</code>的值主要通过<code>@CookieValue</code>注解的参数获取，参数处理器为<code>ServletCookieValueMethodArgumentResolver</code>，需要在注解中指定<code>Cookie</code>的<code>Key</code>。控制器方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/cookie&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>cookie</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@CookieValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;JSESSIONID&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>sessionId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sessionId</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=model-类型参数>Model 类型参数</h3>
<p><code>Model</code>类型参数的处理器是<code>ModelMethodProcessor</code>，实际上处理此参数是直接返回<code>ModelAndViewContainer</code>实例中的<code>Model</code>（具体是<code>ModelMap</code>类型），因为要桥接不同的接口和类的功能，因此回调的实例是<code>BindingAwareModelMap</code>类型，此类型继承自<code>ModelMap</code>同时实现了<code>Model</code>接口。举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/model&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ModelMap</span> <span style=color:#000>modelMap</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>model</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>modelMap</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意调用此接口，控制台输出<code>INFO</code>日志内容为：<code>true</code>。还要注意一点：<code>ModelMap</code>或者<code>Model</code>中添加的属性项会附加到<code>HttpRequestServlet</code>实例中带到页面中进行渲染，使用模板引擎的前提下可以直接在模板文件内容中直接使用占位符提取这些属性值。</p>
<h3 id=modelattribute-参数>@ModelAttribute 参数</h3>
<p><code>@ModelAttribute</code>注解处理的参数处理器为<code>ModelAttributeMethodProcessor</code>，<code>@ModelAttribute</code>的功能源码的注释如下：</p>
<blockquote>
<p>Annotation that binds a method parameter or method return value to a named model attribute, exposed to a web view.</p>
</blockquote>
<p>简单来说，就是通过<code>key-value</code>形式绑定方法参数或者方法返回值到<code>Model(Map)</code>中，区别下面三种情况：</p>
<ol>
<li><code>@ModelAttribute</code>使用在方法（返回值）上，方法没有返回值（<code>void</code>类型）， <code>Model(Map)</code>参数需要自行设置。</li>
<li><code>@ModelAttribute</code>使用在方法（返回值）上，方法有返回值（非<code>void</code>类型），返回值会添加到<code>Model(Map)</code>参数，<code>key</code>由<code>@ModelAttribute</code>的<code>value</code>指定，否则会使用返回值类型字符串（首写字母变为小写，如返回值类型为<code>Integer</code>，则<code>key</code>为<code>integer</code>）。</li>
<li><code>@ModelAttribute</code>使用在方法参数中，则可以获取同一个控制器中的已经设置的<code>@ModelAttribute</code>对应的值。</li>
</ol>
<p>在一个控制器（使用了<code>@Controller</code>的<code>Spring</code>组件）中，如果存在一到多个使用了<code>@ModelAttribute</code>的方法，这些方法总是在进入控制器方法之前执行，并且执行顺序是由加载顺序决定的（具体的顺序是带参数的优先，并且按照方法首字母升序排序），举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Slf4j</span>
<span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ModelAttributeController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;beforeValue&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;beforeArg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>beforeArg</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beforeArg..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;beforeArgValue&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/modelAttribute&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>modelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;beforeArg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>beforeArg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;modelAttribute..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;beforeArg..........{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beforeArg</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>after</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;afterValue&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ModelAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;afterArg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>afterArg</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;afterArg..........&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;afterArgValue&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调用此接口，控制台输出日志如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>after..........
before..........
afterArg..........
beforeArg..........
modelAttribute..........
beforeArg..........beforeArgValue
{after=afterValue, before=beforeValue, afterArg=afterArgValue, beforeArg=beforeArgValue}
</code></pre></div><p>可以印证排序规则和参数设置、获取的结果和前面的分析是一致的。</p>
<h3 id=errors-或-bindingresult-参数>Errors 或 BindingResult 参数</h3>
<p><code>Errors</code>其实是<code>BindingResult</code>的父接口，<code>BindingResult</code>主要用于回调<code>JSR</code>参数校验异常的属性项，如果<code>JSR303</code>校验异常，一般会抛出<code>MethodArgumentNotValidException</code>异常，并且会返回<code>400(Bad Request)</code>，见全局异常处理器<code>DefaultHandlerExceptionResolver</code>。<code>Errors</code>类型的参数处理器为<code>ErrorsMethodArgumentResolver</code>。举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/errors&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#5c35cc;font-weight:700>@Validated</span> <span style=color:#000>ErrorsModel</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BindingResult</span> <span style=color:#000>bindingResult</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bindingResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectError</span> <span style=color:#000>objectError</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>bindingResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name={},message={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>objectError</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>objectError</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDefaultMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//ErrorsModel
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#5c35cc;font-weight:700>@NoArgsConstructor</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ErrorsModel</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@NotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;id must not be null!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@NotEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;errors name must not be empty!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调用接口控制台<code>Warn</code>日志如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>name=errors,message=errors name must not be empty!
</code></pre></div><p>一般情况下，不建议用这种方式处理JSR校验异常的属性项，因为会涉及到大量的重复的硬编码工作，建议：方式一直接继承<code>ResponseEntityExceptionHandler</code>覆盖对应的方法或者方式二同时使用<code>@ExceptionHandler</code>和<code>@(Rest)ControllerAdvice</code>注解进行异常处理。例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RestControllerAdvice</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ApplicationRestControllerAdvice</span><span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BusinessException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>handleBusinessException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BusinessException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#8f5902;font-style:italic>// 这里处理异常和返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodArgumentNotValidException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>handleMethodArgumentNotValidException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodArgumentNotValidException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#8f5902;font-style:italic>// 这里处理异常和返回值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>值得注意的是，SpringBoot某个版本之后，把JSR303相关的依赖抽离到spring-boot-starter-validation依赖中，如果要使用JSR303相关相关校验功能，必须独立引入此starter</p>
</blockquote>
<h3 id=value-参数>@Value 参数</h3>
<p>控制器方法的参数可以是<code>@Value</code>注解修饰的参数，会从<code>Environment</code>实例中装配和转换属性值到对应的参数中（也就是参数的来源并不是请求体，而是上下文中已经加载和处理完成的环境属性值），参数处理器为<code>ExpressionValueMethodArgumentResolver</code>。举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/value&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${spring.application.name}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;spring.application.name={}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>spring.application.name</code>属性一般在配置文件中指定，在加载配置文件属性的时候添加到全局的<code>Environment</code>中。</p>
<h3 id=map-类型参数>Map 类型参数</h3>
<p><code>Map</code>类型参数的范围相对比较广，对应一系列的参数处理器，注意区别使用了上面提到的部分注解的<code>Map</code>类型和完全不使用注解的<code>Map</code>类型参数，两者的处理方式不相同。下面列举几个相对典型的<code>Map</code>类型参数处理例子。</p>
<h4 id=不使用任何注解的mapstringobject参数><strong>不使用任何注解的<code>Map&lt;String,Object></code>参数</strong></h4>
<p>这种情况下参数实际上直接回调<code>ModelAndViewContainer</code>中的<code>ModelMap</code>实例，参数处理器为<code>MapMethodProcessor</code>，往<code>Map</code>参数中添加的属性将会带到页面中。</p>
<h4 id=使用requestparam注解的mapstringobject参数><strong>使用@RequestParam注解的<code>Map&lt;String,Object></code>参数</strong></h4>
<p>这种情况下的参数处理器为<code>RequestParamMapMethodArgumentResolver</code>，使用的请求方式需要指定<code>Content-Type</code>为<code>x-www-form-urlencoded</code>，不能使用<code>application/json</code>的方式：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222630.png style=display:block;width:80% alt=NAME align=center> </div>
<p>控制器代码为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/map&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>mapArgs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=使用requestheader注解的mapstringobject参数><strong>使用@RequestHeader注解的Map&lt;String,Object>参数</strong></h4>
<p>这种情况下的参数处理器为<code>RequestHeaderMapMethodArgumentResolver</code>，作用是获取请求的所有请求头的<code>Key-Value</code>。</p>
<h4 id=使用pathvariable注解的mapstringobject参数><strong>使用@PathVariable注解的Map&lt;String,Object>参数</strong></h4>
<p>这种情况下的参数处理器为<code>PathVariableMapMethodArgumentResolver</code>，作用是获取所有路径参数封装为<code>Key-Value</code>结构。</p>
<h3 id=multipartfile-集合批量文件上传>MultipartFile 集合：批量文件上传</h3>
<p>批量文件上传的时候，我们一般需要接收一个<code>MultipartFile</code>集合，可以有两种选择：</p>
<ol>
<li>使用<code>MultipartHttpServletRequest</code>参数，直接调用<code>getFiles</code>方法获取<code>MultipartFile</code>列表。</li>
<li>使用<code>@RequestParam</code>注解修饰<code>MultipartFile</code>列表，参数处理器是<code>RequestParamMethodArgumentResolver</code>，其实就是第1种方式的封装而已。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012222724.png style=display:block;width:80% alt=NAME align=center> </div>
<p>控制器方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/parts&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>partArgs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MultipartFile</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parts</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parts</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=日期类型参数处理>日期类型参数处理</h2>
<p>日期参数处理个人认为是请求参数处理中最复杂的，因为一般日期处理的逻辑不是通用的，过多的定制化处理导致很难有一个统一的标准处理逻辑去处理和转换日期类型的参数。不过，这里介绍几个通用的方法，以应对各种奇葩的日期格式。下面介绍的例子中全部使用<code>JDK8</code>中引入的日期时间<code>API</code>，围绕<code>java.util.Date</code>为核心的日期时间<code>API</code>的使用方式类同。</p>
<h3 id=统一以字符串形式接收>统一以字符串形式接收</h3>
<p>这种是最原始但是最奏效的方式，统一以字符串形式接收，然后自行处理类型转换，下面给个小例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateTimeFormatter</span> <span style=color:#000>FORMATTER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>UserDto</span> <span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>UserEntity</span> <span style=color:#000>userEntity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUserId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBirthdayTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBirthdayTime</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FORMATTER</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setGraduationTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGraduationTime</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>FORMATTER</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserEntity</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用字符串接收后再转换的缺点就是模板代码太多，编码风格不够简洁，重复性工作太多，如果有代码洁癖或者类似笔者这样是一个节能主义者，一般不会选用这种方式。</p>
<h3 id=使用注解-datetimeformat-或-jsonformat>使用注解 @DateTimeFormat 或 @JsonFormat</h3>
<p><code>@DateTimeFormat</code>注解配合<code>@RequestBody</code>的参数使用的时候，会发现抛出<code>InvalidFormatException</code>异常，提示转换失败，这是因为在处理此注解的时候，只支持<code>Form</code>表单提交(<code>Content-Type</code>为<code>x-www-form-urlencoded</code>)，例子如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto2</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserDto2</span> <span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//或者像下面这样
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;userId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;birthdayTime&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;graduationTime&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@DateTimeFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>而<code>@JsonFormat</code>注解可使用在<code>Form</code>表单或者<code>JSON</code>请求参数的场景，因此更推荐使用<code>@JsonFormat</code>注解，不过注意需要指定时区(<code>timezone</code>属性，例如在中国是东八区<code>GMT+8</code>)，否则有可能导致出现<strong>时差</strong>，举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>UserDto2</span> <span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto2</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timezone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;GMT+8&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pattern</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timezone</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;GMT+8&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>一般选用LocalDateTime作为日期字段参数的类型，因为它的转换相对于其他JDK8的日期时间类型简单</p>
</blockquote>
<h3 id=jackson-序列化和反序列化定制>Jackson 序列化和反序列化定制</h3>
<p>因为<code>SpringMVC</code>默认使用<code>Jackson</code>处理<code>@RequestBody</code>的参数转换，因此可以通过定制序列化器和反序列化器来实现日期类型的转换，这样我们就可以使用<code>application/json</code>的形式提交请求参数。这里的例子是转换请求<code>JSON</code>参数中的字符串为<code>LocalDateTime</code>类型，属于<code>JSON</code>反序列化，因此需要定制反序列化器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@PostMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/date3&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>date3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestBody</span> <span style=color:#000>UserDto3</span> <span style=color:#000>userDto3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userDto3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserDto3</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonDeserialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>using</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>birthdayTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@JsonDeserialize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>using</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LocalDateTime</span> <span style=color:#000>graduationTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>LocalDateTimeDeserializer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CustomLocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=最佳实践>最佳实践</h3>
<p>前面三种方式都存在硬编码等问题，其实最佳实践是直接修改<code>MappingJackson2HttpMessageConverter</code>中的<code>ObjectMapper</code>对于日期类型处理默认的序列化器和反序列化器，这样就能全局生效，不需要再使用其他注解或者定制序列化方案（当然，有些时候需要特殊处理定制），或者说，在需要特殊处理的场景才使用其他注解或者定制序列化方案。使用钩子接口<code>Jackson2ObjectMapperBuilderCustomizer</code>可以实现对容器中的<code>ObjectMapper</code>单例中的属性定制：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Bean</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Jackson2ObjectMapperBuilderCustomizer</span> <span style=color:#000>jackson2ObjectMapperBuilderCustomizer</span><span style=color:#ce5c00;font-weight:700>(){</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>customizer</span><span style=color:#ce5c00;font-weight:700>-&gt;{</span>
		<span style=color:#000>customizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>serializerByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LocalDateTimeSerializer</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)));</span>
		<span style=color:#000>customizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deserializerByType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LocalDateTimeDeserializer</span><span style=color:#ce5c00;font-weight:700>(</span>
				<span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)));</span>
	<span style=color:#ce5c00;font-weight:700>};</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样就能定制化<code>MappingJackson2HttpMessageConverter</code>中持有的<code>ObjectMapper</code>，上面的<code>LocalDateTime</code>序列化和反序列化器对全局生效。</p>
<h2 id=请求-url-匹配>请求 URL 匹配</h2>
<p>前面基本介绍完了主流的请求参数处理，其实<code>SpringMVC</code>中还会按照<code>URL</code>的模式进行匹配，使用的是<code>Ant</code>路径风格，处理工具类为<code>org.springframework.util.AntPathMatcher</code>，从此类的注释来看，匹配规则主要包括下面四点
：</p>
<ol>
<li><code>?</code>匹配1个字符。</li>
<li><code>*</code>匹配0个或者多个<strong>字符</strong>。</li>
<li><code>**</code>匹配路径中0个或者多个<strong>目录</strong>。</li>
<li>正则支持，如<code>{spring:[a-z]+}</code>将正则表达式[a-z]+匹配到的值，赋值给名为<strong>spring</strong>的路径变量。</li>
</ol>
<p>举些例子：</p>
<p><strong>'?&lsquo;形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern?&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patternd</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patterndd</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patternd</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>s</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
</code></pre></div><p><strong>'*&lsquo;形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern*&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>patternd</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>a</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
</code></pre></div><p><strong>'**&lsquo;形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/**/p&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>p</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>p</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>p</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
</code></pre></div><p><strong>{spring:[a-z]+}形式的URL</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/{key:[a-c]+}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;key&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>a</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>ab</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>abc</span>  <span style=color:#000>200</span> <span style=color:#000>OK</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>abcd</span>  <span style=color:#000>404</span> <span style=color:#000>Not</span> <span style=color:#000>Found</span>
</code></pre></div><p>上面的四种URL模式可以组合使用，千变万化。</p>
<p><code>URL</code>匹配还遵循<strong>精确匹配原则</strong>，也就是存在两个模式对同一个<code>URL</code>都能够匹配成功，则<strong>选取最精确的<code>URL</code>匹配</strong>，进入对应的控制器方法，举个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/**/p&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/pattern/p&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>pattern2</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面两个控制器，如果请求<code>URL</code>为<code>/pattern/p</code>，最终进入的方法为<code>pattern2</code>。上面的例子只是列举了<code>SpringMVC</code>中<code>URL</code>匹配的典型例子，并没有深入展开。</p>
<p>最后，<code>org.springframework.util.AntPathMatcher</code>作为一个工具类，可以单独使用，不仅仅可以用于匹配<code>URL</code>，也可以用于匹配系统文件路径，不过需要使用其带参数构造改变内部的<code>pathSeparator</code>变量，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>AntPathMatcher</span> <span style=color:#000>antPathMatcher</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AntPathMatcher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>separator</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-914aed954c02642f85974bcb8e314a42>8 - CH09-请求过程</h1>
<p>Spring MVC是Spring系列框架中使用频率最高的部分。不管是Spring Boot还是传统的Spring项目，只要是Web项目都会使用到Spring MVC部分。因此程序员一定要熟练掌握MVC部分。本篇博客简要分析Spring MVC处理一个请求的流程。</p>
<p>一个请求从客户端发出到达服务器，然后被处理的整个过程其实是非常复杂的。本博客主要介绍请求到达服务器被核心组件 DispatcherServlet 处理的整理流程（不包括Filter的处理流程）。</p>
<h2 id=处理流程分析>处理流程分析</h2>
<p>Servlet处理一个请求时会调用service()方法，所以DispatcherServlet处理请求的方式也是从service()方法开始（debug的话建议从DispatcherServlet的service方法开始debug）。FrameworkServlet重写了HttpServlet的service方法，这个service方法后面又调用了FrameworkServlet的processRequest()方法，processRequest()调用了DispatcherServlet的doService()方法,最后调用到DispatcherServlet的doDispatcher()方法。整合处理请求的方法调用流程如上，下面看下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#000>HttpMethod</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HttpMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PATCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>httpMethod</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//这边调用了HttpServlet的service（）方法，但由于FrameWorkServle重写了doGet、doPost等方法，所以最终还是会调用到processRequest方法
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>再看看FrameworkServlet的processRequest()方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletResponse</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>)</span>
    		<span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServletException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    	<span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#000>Throwable</span> <span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    	<span style=color:#000>LocaleContext</span> <span style=color:#000>previousLocaleContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LocaleContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocaleContext</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#000>LocaleContext</span> <span style=color:#000>localeContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildLocaleContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    	<span style=color:#000>RequestAttributes</span> <span style=color:#000>previousAttributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequestAttributes</span><span style=color:#ce5c00;font-weight:700>();</span>
    	<span style=color:#000>ServletRequestAttributes</span> <span style=color:#000>requestAttributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildRequestAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    	<span style=color:#000>WebAsyncManager</span> <span style=color:#000>asyncManager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WebAsyncUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAsyncManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerCallableInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FrameworkServlet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RequestBindingInterceptor</span><span style=color:#ce5c00;font-weight:700>());</span>
    
    	<span style=color:#000>initContextHolders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localeContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requestAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    	<span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//这边调用DispatcherServlet的doService()方法
</span><span style=color:#8f5902;font-style:italic></span>    		<span style=color:#000>doService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServletException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    	<span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
    		<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedServletException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Request processing failed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    
    	<span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    		<span style=color:#000>resetContextHolders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousLocaleContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousAttributes</span><span style=color:#ce5c00;font-weight:700>);</span>
    		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestAttributes</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    			<span style=color:#000>requestAttributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestCompleted</span><span style=color:#ce5c00;font-weight:700>();</span>
    		<span style=color:#ce5c00;font-weight:700>}</span>
    
    		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>failureCause</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not complete request&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>failureCause</span><span style=color:#ce5c00;font-weight:700>);</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    			<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asyncManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isConcurrentHandlingStarted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    					<span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Leaving response open for concurrent processing&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    				<span style=color:#ce5c00;font-weight:700>}</span>
    				<span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    					<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Successfully completed request&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    				<span style=color:#ce5c00;font-weight:700>}</span>
    			<span style=color:#ce5c00;font-weight:700>}</span>
    		<span style=color:#ce5c00;font-weight:700>}</span>
    
    		<span style=color:#000>publishRequestHandledEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>failureCause</span><span style=color:#ce5c00;font-weight:700>);</span>
    	<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>doService()方法的具体内容会在后面讲到，这边描述下doDispatcher()的内容，参考了<a href=http://www.cnblogs.com/fangjian0423/p/springMVC-dispatcherServlet.html>博客</a>:</p>
<blockquote>
<p>首先根据请求的路径找到HandlerMethod(带有Method反射属性，也就是对应Controller中的方法)，然后匹配路径对应的拦截器，有了HandlerMethod和拦截器构造个HandlerExecutionChain对象。HandlerExecutionChain对象的获取是通过HandlerMapping接口提供的方法中得到。有了HandlerExecutionChain之后，通过HandlerAdapter对象进行处理得到ModelAndView对象，HandlerMethod内部handle的时候，使用各种HandlerMethodArgumentResolver实现类处理HandlerMethod的参数，使用各种HandlerMethodReturnValueHandler实现类处理返回值。 最终返回值被处理成ModelAndView对象，这期间发生的异常会被HandlerExceptionResolver接口实现类进行处理。</p>
</blockquote>
<p>总结下Spring MVC处理一个请求的过程：</p>
<ul>
<li>首先，搜索应用的上下文对象 WebApplicationContext 并把它作为一个属性（attribute）绑定到该请求上，以便控制器和其他组件能够使用它。</li>
<li>将地区（locale）解析器绑定到请求上，以便其他组件在处理请求（渲染视图、准备数据等）时可以获取区域相关的信息。如果你的应用不需要解析区域相关的信息；</li>
<li>将主题（theme）解析器绑定到请求上，以便其他组件（比如视图等）能够了解要渲染哪个主题文件。同样，如果你不需要使用主题相关的特性，忽略它即可如果你配置了multipart文件处理器，那么框架将查找该文件是不是multipart（分为多个部分连续上传）的。若是，则将该请求包装成一个 MultipartHttpServletRequest 对象，以便处理链中的其他组件对它做进一步的处理。关于Spring对multipart文件传输处理的支持；</li>
<li>为该请求查找一个合适的处理器。如果可以找到对应的处理器，则与该处理器关联的整条执行链（前处理器、后处理器、控制器等）都会被执行，以完成相应模型的准备或视图的渲染如果处理器返回的是一个模型（model），那么框架将渲染相应的视图。若没有返回任何模型（可能是因为前后的处理器出于某些原因拦截了请求等，比如，安全问题），则框架不会渲染任何视图，此时认为对请求的处理可能已经由处理链完成了（这个过程就是doService()和doDispatcher()做的事情）</li>
</ul>
<p>1、 首先用户发送请求——>DispatcherServlet，前端控制器收到请求后自己不进行处理，而是委托给其他的解析器进行处理，作为统一访问点，进行全局的流程控制；</p>
<p>2、 DispatcherServlet——>HandlerMapping，HandlerMapping将会把请求映射为HandlerExecutionChain对象（包含一个Handler处理器（页面控制器）对象、多个HandlerInterceptor拦截器）对象，通过这种策略模式，很容易添加新的映射策略；</p>
<p>3、 DispatcherServlet——>HandlerAdapter，HandlerAdapter将会把处理器包装为适配器，从而支持多种类型的处理器，即适配器设计模式的应用，从而很容易支持很多类型的处理器；</p>
<p>4、 HandlerAdapter——>处理器功能处理方法的调用，HandlerAdapter将会根据适配的结果调用真正的处理器的功能处理方法，完成功能处理；并返回一个ModelAndView对象（包含模型数据、逻辑视图名）；</p>
<p>5、 ModelAndView的逻辑视图名——> ViewResolver，ViewResolver将把逻辑视图名解析为具体的View，通过这种策略模式，很容易更换其他视图技术；</p>
<p>6、 View——>渲染，View会根据传进来的Model模型数据进行渲染，此处的Model实际是一个Map数据结构，因此很容易支持其他视图技术；</p>
<p>7、返回控制权给DispatcherServlet，由DispatcherServlet返回响应给用户，到此一个流程结束。</p>
<h2 id=请求流程图>请求流程图</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211015001538.png style=display:block;width:100% alt=NAME align=center> </div>
<p>还是这个图比较清楚。发现根据代码不太能把这个流程说清楚。而且整个流程很长，代码很多，我就不贴代码了。这里根据这个图再把整个流程中组件的功能总结下：</p>
<ul>
<li>
<p><code>DispatcherServlet</code>：核心控制器，所有请求都会先进入<code>DispatcherServlet</code>进行统一分发，是不是感觉有点像外观模式的感觉；</p>
</li>
<li>
<p><code>HandlerMapping</code>：这个组件的作用就是将用户请求的URL映射成一个<code>HandlerExecutionChain</code>。这个<code>HandlerExecutionChain</code>是<code>HandlerMethod</code>和<code>HandlerInterceptor</code>的组合。Spring在启动的时候会默认注入很多<code>HandlerMapping</code>组件，其中最常用的组件就是<code>RequestMappingHandlerMapping</code>。</p>
<p>上面的<code>HandlerMethod</code>和<code>HandlerInterceptor</code>组件分别对应我们Controller中的方法和拦截器。<strong>拦截器会在HandlerMethod方法执行之前执行</strong></p>
</li>
<li>
<p><code>HandlerAdapter</code>组件，这个组件的主要作用是用来对<code>HandlerMethod</code>中参数的转换，对方法的执行，以及对返回值的转换等等。这里面涉及的细节就很多了，包括<code>HandlerMethodArgumentResolver</code>、<code>HandlerMethodReturnValueHandler</code> 、<code>RequestResponseBodyMethodProcessor</code> 、和<code>HttpMessageConvert</code>等组件。</p>
<p>当<code>HandlerAdapter</code>组件执行完成之后会得到一个<code>ModleAndView</code>组件，这个组件代表视图模型。</p>
</li>
<li>
<p>得到<code>ModleAndView</code>后会执行拦截器的<code>postHandle</code>方法。</p>
</li>
<li>
<p>如果在上面的执行过程中发生任何异常，会由HandlerExceptionResolver进行统一处理。</p>
</li>
<li>
<p>最后模型解析器会对上面的到的<code>ModleAndView</code>进行解析，得到一个一个View返回给客户端。在返回客户端之前还会执行拦截器的<code>afterCompletion</code>方法。</p>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f318ab73b27584f92427d5fdaeaa969e>9 - CH10-配置注入</h1>
<h2 id=直接注入>直接注入</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.userName=someone
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.userName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=默认值>默认值</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>@Value(value = &#34;${susan.test.userName:susan}&#34;)
private String userName;
</code></pre></div><h2 id=静态变量>静态变量</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.userName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setUserName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>UserService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>userName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=变量类型>变量类型</h2>
<p>在 Java 中的基本数据类型有4类8种，然我们一起回顾一下：</p>
<ul>
<li>整型：byte、short、int、long</li>
<li>浮点型：float、double</li>
<li>布尔型：boolean</li>
<li>字符型：char</li>
</ul>
<p>相对应地提供了8种包装类：</p>
<ul>
<li>整型：Byte、Short、Integer、Long</li>
<li>浮点型：Float、Double</li>
<li>布尔型：Boolean</li>
<li>字符型：Character</li>
</ul>
<p>@Value 注解对这8中基本类型和相应的包装类，有非常良好的支持，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.a:1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.b:100}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>short</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.c:3000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.d:4000000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.e:5.2}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.f:6.1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.g:false}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.h:h}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.a:1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.b:100}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Short</span> <span style=color:#000>b1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.c:3000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>c1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.d:4000000}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Long</span> <span style=color:#000>d1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.e:5.2}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Float</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.f:6.1}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Double</span> <span style=color:#000>f1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.g:false}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Boolean</span> <span style=color:#000>g1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.h:h}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Character</span> <span style=color:#000>h1</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=数组类型>数组类型</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${susan.test.array:1,2,3,4,5}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=集合类型>集合类型</h2>
<h3 id=list>List</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.list[0]=10
susan.test.list[1]=11
susan.test.list[2]=12
susan.test.list[3]=13
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;susan.test&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.list}&#39;.split(&#39;,&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=set>Set</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.set=10,11,12,13
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.set}&#39;.split(&#39;,&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>支持空值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.set:}&#39;.empty ? null : &#39;${susan.test.set:}&#39;.split(&#39;,&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=map>Map</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>susan.test.map={&#34;name&#34;:&#34;苏三&#34;, &#34;age&#34;:&#34;18&#34;}
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#39;${susan.test.map:}&#39;.empty ? null : &#39;${susan.test.map:}&#39;}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=注入-bean>注入 Bean</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RoleService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DEFAULT_AGE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>18</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getRoleName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;管理员&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getParentId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>2000</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myAge</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.id}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.getRoleName()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myRoleName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.getParentId()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myParentId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myAge</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myRoleName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myParentId</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=静态类>静态类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{T(java.io.File).separator}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{T(java.lang.Math).random()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>randomValue</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=逻辑运算>逻辑运算</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.roleName + &#39;&#39; + roleService.DEFAULT_AGE}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE &gt; 16 and roleService.roleName.equals(&#39;苏三&#39;)}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE &gt; 16 ? roleService.roleName: &#39;苏三&#39; }&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>realRoleName</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=-与-><code>${}</code> 与 <code>#{}</code></h2>
<h3 id=heading><code>${}</code></h3>
<p>用于获取配置文件中的系统属性值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;${susan.test.userName:susan}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>通过 <code>:</code> 可以设置默认值。如果在配置文件中找不到susan.test.userName的配置，则注入时用默认值。</p>
<h3 id=heading-1><code>#{}</code></h3>
<p>主要用于通过spring的EL表达式，获取bean的属性，或者调用bean的某个方法。还有调用类的静态常量和静态方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.DEFAULT_AGE}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>myAge</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.id}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{roleService.getRoleName()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myRoleName</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{T(java.lang.Math).random()}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>randomValue</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>如果是调用类的静态方法，则需要加T(包名 + 方法名称)。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-edd784317807198b5ce95957ab1805fa>10 - CH11-配置绑定</h1>
<p>使用 <code>@Value("${property}")</code> 注释注入配置属性有时会很麻烦，尤其是当你使用多个属性或你的数据是分层的时候。</p>
<p>Spring Boot 引入了一个可替换的方案 —— @ConfigurationProperties 来注入属性。</p>
<h2 id=javabean-属性绑定>JavaBean 属性绑定</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 我们可以简单地用一个值初始化一个字段来定义一个默认值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Security</span> <span style=color:#000>security</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Security</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Data</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Security</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果这个属性配置的话，默认是“USER”
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singleton</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;USER&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在配置文件中进行如下配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>my</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>remoteAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>security</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>csx</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>passwoed</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>role1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>role2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>最后生成的 Bean 的属性如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;enabled&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;remoteAddress&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;security&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;username&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;csx&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;passwoed&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;roles&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
      <span style=color:#4e9a06>&#34;role1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#4e9a06>&#34;role2&#34;</span>
    <span style=color:#000;font-weight:700>]</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>以上的绑定当时需要提供默认的构造函数，以及get/setter方法。</p>
<p>并且不支持 JavaBean 中的静态成员变量的数据绑定</p>
</blockquote>
<p>另外，@ConfigurationProperties 还有两个其他属性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>ignoreInvalidFields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>ignoreUnknownFields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>ignoreInvalidFields：是否忽略非法值，比如将一个字符串 “foo” 赋值给 bool 值，不忽略的话会报启动异常。</p>
<p>ignoreUnknownFields：对于多余的配置是否会报异常。</p>
<h2 id=构造函数绑定>构造函数绑定</h2>
<p>有些情况下，我们需要绑定的 JavaBean 是不可变的（防止配置注入 Bean 以后，开发者在程序中错误地将配置改掉了）。这种情况下我们可以使用构造函数形式的绑定，只提供 getter 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Getter</span>
<span style=color:#5c35cc;font-weight:700>@ConstructorBinding</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Security</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Security</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Getter</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Security</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Security</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@DefaultValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>password</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>@DefaultValue 可以指定默认值。</p>
<blockquote>
<p>使用构造函数绑定的方式，只能 @EnableConfigurationProperties 或者 @ConfigurationPropertiesScan 的方式激活 Bean。而不能使用 @Component、@Bean 或者 @Import 的方式进行数据绑定。</p>
</blockquote>
<p>如果你的类有多个构造函数，可以直接指定使用哪个。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ConstructorBinding</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InetAddress</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Security</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>enabled</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remoteAddress</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>remoteAddress</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>security</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=激活方式>激活方式</h2>
<p><strong>方式一：添加 @Component 注解</strong></p>
<p>上面的方式需要保证 MyProperties 能被 Spring 扫到。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Data</span>
<span style=color:#5c35cc;font-weight:700>@Component</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;my.service&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>方式二：通过 @Bean 方法</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyProperties</span> <span style=color:#000>myProperties</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>方式三：@EnableConfigurationProperties（推荐）</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@EnableConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>方式四：@ConfigurationPropertiesScan</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@SpringBootApplication</span>
<span style=color:#5c35cc;font-weight:700>@ConfigurationPropertiesScan</span><span style=color:#ce5c00;font-weight:700>({</span> <span style=color:#4e9a06>&#34;com.example.app&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;com.example.another&#34;</span> <span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyApplication</span> <span style=color:#ce5c00;font-weight:700>{</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=引用方式>引用方式</h2>
<p>我们通过配置在 Spring 容器中生成了配置 Bean，那么需要怎么使用他们呢？</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyService</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 依赖注入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MyProperties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRemoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MyProperties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 通过构造函数注入，一般推荐这种方式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyProperties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRemoteAddress</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=给第三方类绑定值>给第三方类绑定值</h2>
<p>假如某些类不是你自己开发的，你也想使用 @ConfigurationProperties 的方式给他绑定值，那么可以进行下面的方式进行配置。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxyBeanMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThirdPartyConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;another&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnotherComponent</span> <span style=color:#000>anotherComponent</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnotherComponent</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=宽松绑定原则relaxed-binding>宽松绑定原则（Relaxed Binding）</h2>
<p>所谓的宽松绑定原则是指：并不是 JavaBean 中的属性必须要和配置文件中的一致才能绑定数据，context-path 也能绑定到 contextPath 属性上。下面举个列子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;my.main-project.person&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyPersonProperties</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFirstName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面的几种方式，都能将配置文件或者环境变量中的值绑定到 firstName 上。</p>
<table>
<thead>
<tr>
<th>形式</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>my.main-project.person.first-name</code></td>
<td>推荐使用在 <code>.properties</code> and <code>.yml</code> files.</td>
</tr>
<tr>
<td><code>my.main-project.person.firstName</code></td>
<td>Standard camel case syntax.</td>
</tr>
<tr>
<td><code>my.main-project.person.first_name</code></td>
<td>推荐使用在 <code>.properties</code> and <code>.yml</code> files.</td>
</tr>
<tr>
<td><code>MY_MAINPROJECT_PERSON_FIRSTNAME</code></td>
<td>推荐使用在系统环境变量读取配置时使用</td>
</tr>
</tbody>
</table>
<h2 id=和-value-对比>和 @Value 对比</h2>
<p>@Value 是 Spring Framework 中的注解，而 @ConfigurationProperties 是在 Spring Boot 中引入的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211015002016.png style=display:block;width:80% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-72976b5fc4d547c63c1244ea27bda80b>11 - CH12-环境变量</h1>
<h2 id=environment-接口介绍>Environment 接口介绍</h2>
<p>在 Spring 中，Environment 接口主要管理应用程序两个方面的内容：profile 和 properties。</p>
<p>profile 可以简单的等同于环境，比如说平时项目中常见的环境有开发（dev）、测试（stg）和生产（prod），Spring 启动的时候可以设置激活具体的环境。<strong>当然，这个 profile 我们还可以为其赋予很多含义，这个主要看你的业务。比如说，你开发的软件会交付给客户A，也会交付给客户B，那么这个 profile 也可以定义成客户的含义</strong>。</p>
<p>properties 是配置，配置的来源有很多，可以是配置文件、JVM 的参数、系统的环境变量、JNDI、Sevlet Contxet 参数以及 Map 对象等，使用 Environment 接口，可以方便的获取这些配置。</p>
<h2 id=bean-definition-profiles>Bean Definition Profiles</h2>
<h3 id=使用-profile>使用 @Profile</h3>
<p>Spring 容器可以根据不同的 profile 配置不同的 Bean。这个特性可以帮助你实现很多灵活的功能，比如：</p>
<ul>
<li>开发环境使用内存数据库，测试和生产环境才使用关系型数据库，比如 Mysql 和 Oracle 等</li>
<li>交互给客户 A 的软件使用 A 特性，交付给客户 B 的软件使用 B 特性</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@Profile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StandaloneDataConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EmbeddedDatabaseBuilder</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmbeddedDatabaseType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>HSQL</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addScript</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/schema.sql&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addScript</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/test-data.sql&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@Profile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;production&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JndiDataConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>destroyMethod</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Context</span> <span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InitialContext</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lookup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java:comp/env/jdbc/datasource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对比上面的两个配置，我们发现 @Profile 非常适合在两个环境下，Bean 的定义完全不一样的情况，如果两个 Bean 的定义是一样的，只是一些参数不一样的话，我们完全可以使用配置文件的方式实现。</p>
<p>@Profile 注解后面的表达式可以是一个简单的字符串，也可以是一个逻辑运算符。@Profile 支持如下的逻辑运算符。</p>
<ul>
<li>!: A logical “not” of the profile</li>
<li>&: A logical “and” of the profiles</li>
<li>|: A logical “or” of the profiles</li>
</ul>
<p>说明：</p>
<blockquote>
<p>If a <code>@Configuration</code> class is marked with <code>@Profile</code>, all of the <code>@Bean</code> methods and <code>@Import</code> annotations associated with that class are bypassed unless one or more of the specified profiles are active. If a <code>@Component</code> or <code>@Configuration</code> class is marked with <code>@Profile({"p1", "p2"})</code>, that class is not registered or processed unless profiles &lsquo;p1&rsquo; or &lsquo;p2&rsquo; have been activated.</p>
</blockquote>
<h3 id=使用-xml-方式配置>使用 xml 方式配置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/beans&#34;</span>
       <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span style=color:#c4a000>xmlns:jdbc=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/jdbc&#34;</span>
       <span style=color:#c4a000>xmlns:jee=</span><span style=color:#4e9a06>&#34;http://www.springframework.org/schema/jee&#34;</span>
       <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;...&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- other bean definitions --&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;jdbc:embedded-database</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;jdbc:script</span> <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/schema.sql&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;jdbc:script</span> <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;classpath:com/bank/config/sql/test-data.sql&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/jdbc:embedded-database&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;production&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;jee:jndi-lookup</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span> <span style=color:#c4a000>jndi-name=</span><span style=color:#4e9a06>&#34;java:comp/env/jdbc/datasource&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</code></pre></div><h3 id=激活-profile>激活 profile</h3>
<p><strong>1. API 方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>AnnotationConfigApplicationContext</span> <span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnnotationConfigApplicationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#8f5902;font-style:italic>// 设置激活的 profile
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>setActiveProfiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SomeConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StandaloneDataConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JndiDataConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p><strong>2. 命令行方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>-Dspring.profiles.active=&#34;profile1,profile2&#34;
</code></pre></div><p><strong>3. 配置文件方式</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>profiles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>active</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dev</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=默认的-profile>默认的 profile</h3>
<p>Spring 默认的 profile 是 <code>default</code>，可以通过 Environment 的 API 进行修改。</p>
<h2 id=propertysource-接口>PropertySource 接口</h2>
<p>PropertySource 接口是对任何形式的 key-value 键值对的抽象。</p>
<h2 id=propertysource>@PropertySource</h2>
<p>@PropertySource 这个注解的作用是将配置文件中的键值对放入Environment。这个注解的作用和传统配置方式中的 context:place-hold一致。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@PropertySource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:/com/myco/app.properties&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#000>Environment</span> <span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#5c35cc;font-weight:700>@Bean</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TestBean</span> <span style=color:#000>testBean</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>TestBean</span> <span style=color:#000>testBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TestBean</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>testBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;testbean.name&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>testBean</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>经过上面这样的配置，我们就可以使用 <code>${key}</code> 这种形式来取变量的值。<strong>有时如果我们没配置 key 的值，Spring 会抛异常。这时我们可以使用 <code>${key:defaultvalue} </code>这种形式配置默认值</strong>。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ab6686a9d87d82772b5814cec7a2b8ef>12 - CH13-缓存注解</h1>
<h2 id=cacheable>@Cacheable</h2>
<p>@Cacheable 的作用 主要针对方法配置，能够根据方法的请求参数对其结果进行缓存</p>
<h3 id=cacheable-作用和配置方法>@Cacheable 作用和配置方法</h3>
<table>
<thead>
<tr>
<th style=text-align:left>参数</th>
<th>解释</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>value</td>
<td>缓存的名称，在spring配置文件中定义，必须指定至少一个</td>
<td>例如: <code>@Cacheable(value="mycache")</code> <code>@Cacheable(value={"cache1","cache2"}</code></td>
</tr>
<tr>
<td style=text-align:left>key</td>
<td>缓存的<code>key</code>，可以为空，如果指定要按照<code>SpEL</code>表达式编写，如果不指定，则缺省按照方法的所有参数进行组合</td>
<td><code>@Cacheable(value="testcache",key="#userName")</code></td>
</tr>
<tr>
<td style=text-align:left>condition</td>
<td>缓存的条件，可以为空，使用<code>SpEL</code>编写，返回<code>true</code>或者<code>false</code>，只有为<code>true</code>才进行缓存</td>
<td><code>@Cacheable(value="testcache",condition="#userName.length()>2")</code></td>
</tr>
</tbody>
</table>
<h3 id=实例>实例</h3>
<p><code>@Cacheable(value=”accountCache”)</code>，这个注释的意思是，当调用这个方法的时候，会从一个名叫 accountCache 的缓存中查询，如果没有，则执行实际的方法（即查询数据库），并将执行的结果存入缓存中，否则返回缓存中的对象。这里的缓存中的 key 就是参数 userName，value 就是 Account 对象。“accountCache”缓存是在 spring*.xml 中定义的名称。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Cacheable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;accountCache&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>// 使用了一个缓存名叫 accountCache 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Account</span> <span style=color:#000>getAccountByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>// 方法内部实现不考虑缓存逻辑，直接实现业务
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;real query account.&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span> 
     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getFromDB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span> 
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><h2 id=cacheput>@CachePut</h2>
<p>@CachePut 的作用 主要针对方法配置，能够根据方法的请求参数对其结果进行缓存，和 @Cacheable 不同的是，它每次都会触发真实方法的调用。</p>
<h3 id=cacheput-作用和配置方法>@CachePut 作用和配置方法</h3>
<table>
<thead>
<tr>
<th style=text-align:left>参数</th>
<th>解释</th>
<th style=text-align:left>example</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>value</td>
<td>缓存的名称，在spring配置文件中定义，必须指定至少一个</td>
<td style=text-align:left><code>@CachePut(value=”my cache”)</code></td>
</tr>
<tr>
<td style=text-align:left>key</td>
<td>缓存的<code>key</code>，可以为空，如果指定要按照<code>SpEL</code>表达式编写，如果不指定，则缺省按照方法的所有参数进行组合</td>
<td style=text-align:left><code>@CachePut(value="testcache",key="#userName")</code></td>
</tr>
<tr>
<td style=text-align:left>condition</td>
<td>缓存的条件，可以为空，使用<code>SpEL</code>编写，返回<code>true</code>或者<code>false</code>，只有为<code>true</code>才进行缓存</td>
<td style=text-align:left><code>@CachePut(value="testcache",condition="#userName.length()>2")</code></td>
</tr>
</tbody>
</table>
<h3 id=实例-1>实例</h3>
<p>@CachePut 注释，这个注释可以确保方法被执行，同时方法的返回值也被记录到缓存中，实现缓存与数据库的同步更新。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;accountCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#account.getName()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>// 更新accountCache 缓存
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Account</span> <span style=color:#000>updateAccount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Account</span> <span style=color:#000>account</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>updateDB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>account</span><span style=color:#ce5c00;font-weight:700>);</span> 
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><h2 id=cacheevict>@CacheEvict</h2>
<p>@CachEvict 的作用 主要针对方法配置，能够根据一定的条件对缓存进行清空</p>
<h3 id=cacheevict-作用和配置方法>@CacheEvict 作用和配置方法</h3>
<table>
<thead>
<tr>
<th style=text-align:left>参数</th>
<th style=text-align:left>解释</th>
<th style=text-align:left>example</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>value</td>
<td style=text-align:left>缓存的名称，在 spring 配置文件中定义,必须指定至少一个</td>
<td style=text-align:left><code>@CacheEvict(value="my cache")</code></td>
</tr>
<tr>
<td style=text-align:left>key</td>
<td style=text-align:left>缓存的<code>key</code>,可以为空，如果指定要按照<code>SpEL</code>表达式编写，如果不指定，则缺省按照方法的所有参数进行组合</td>
<td style=text-align:left><code>@CacheEvict(value="testcache",key="#userName")</code></td>
</tr>
<tr>
<td style=text-align:left>condition</td>
<td style=text-align:left>缓存的条件,可以为空，使用<code>SpEL</code>编写，返回<code>true</code>或者<code>false</code>,只有为<code>true</code>才进行缓存</td>
<td style=text-align:left><code>@CacheEvict(value="testcache",condition="#userName.length()>2")</code></td>
</tr>
<tr>
<td style=text-align:left>allEntries</td>
<td style=text-align:left>是否清空所有缓存内容,缺省为<code>false</code>，如果指定为<code>true</code>，则方法调用后将立即清空所有缓存</td>
<td style=text-align:left><code>@CachEvict(value="testcache",allEntries=true)</code></td>
</tr>
<tr>
<td style=text-align:left>beforeInvocation</td>
<td style=text-align:left>是否在方法执行前就清空，缺省为<code>false</code>，如果指定为<code>true</code>，则在方法还没有执行的时候就清空缓存，缺省情况下，如果方法执行抛出异常，则不会清空缓存</td>
<td style=text-align:left><code>@CachEvict(value="testcache"，beforeInvocation=true)</code></td>
</tr>
</tbody>
</table>
<h3 id=实例-2>实例</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CacheEvict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;accountCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#account.getName()&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>// 清空accountCache 缓存  
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>updateAccount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Account</span> <span style=color:#000>account</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>updateDB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>account</span><span style=color:#ce5c00;font-weight:700>);</span> 
<span style=color:#ce5c00;font-weight:700>}</span> 
  
<span style=color:#5c35cc;font-weight:700>@CacheEvict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;accountCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>allEntries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>// 清空accountCache 缓存
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reload</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>reloadAll</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Cacheable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;accountCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#userName.length() &lt;=4&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>// 缓存名叫 accountCache 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Account</span> <span style=color:#000>getAccountByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
 <span style=color:#8f5902;font-style:italic>// 方法内部实现不考虑缓存逻辑，直接实现业务
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getFromDB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=cacheconfig>@CacheConfig</h2>
<p>所有的 <code>@Cacheable</code> 里面都有一个value＝“xxx”的属性，这显然如果方法多了，写起来也是挺累的，如果可以一次性声明完 那就省事了，
所以，有了 <code>@CacheConfig</code> 这个配置，@CacheConfig is a class-level annotation that allows to share the cache names，如果你在你的方法写别的名字，那么依然以方法的名字为准。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CacheConfig</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;books&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BookRepositoryImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BookRepository</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Cacheable</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Book</span> <span style=color:#000>findBook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ISBN</span> <span style=color:#000>isbn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{...}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=条件缓存>条件缓存</h2>
<p>下面提供一些常用的条件缓存</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//@Cacheable将在执行方法之前( #result还拿不到返回值)判断condition，如果返回true，则查缓存； 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Cacheable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#id lt 10&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>conditionFindById</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span>  
  
<span style=color:#8f5902;font-style:italic>//@CachePut将在执行完方法后（#result就能拿到返回值了）判断condition，如果返回true，则放入缓存； 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#result.username ne &#39;zhang&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>conditionSave</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span>   

<span style=color:#8f5902;font-style:italic>//@CachePut将在执行完方法后（#result就能拿到返回值了）判断unless，如果返回false，则放入缓存；（即跟condition相反）
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>unless</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#result.username eq &#39;zhang&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>conditionSave2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span>   

<span style=color:#8f5902;font-style:italic>//@CacheEvict， beforeInvocation=false表示在方法执行之后调用（#result能拿到返回值了）；且判断condition，如果返回true，则移除缓存；
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CacheEvict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>beforeInvocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#result.username ne &#39;zhang&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>conditionDelete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span>   
</code></pre></div><h2 id=caching>@Caching</h2>
<p>有时候我们可能组合多个Cache注解使用；比如用户新增成功后，我们要添加id–>user；username—>user；email—>user的缓存；此时就需要@Caching组合多个注解标签了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Caching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>put</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.id&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
<span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.username&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
<span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.email&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</code></pre></div><h2 id=自定义缓存注解>自定义缓存注解</h2>
<p>比如之前的那个@Caching组合，会让方法上的注解显得整个代码比较乱，此时可以使用自定义注解把这些注解组合到一个注解中，如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Caching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>put</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.id&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
<span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.username&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
<span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.email&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Inherited</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>UserSaveCache</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样我们在方法上使用如下代码即可，整个代码显得比较干净。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@UserSaveCache</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=扩展>扩展</h2>
<p>比如findByUsername时，不应该只放username–>user，应该连同id—>user和email—>user一起放入；这样下次如果按照id查找直接从缓存中就命中了</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Caching</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#000>cacheable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#5c35cc;font-weight:700>@Cacheable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#username&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>},</span>
    <span style=color:#000>put</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#result.id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#result != null&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
       <span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#result.email&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#result != null&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>findByUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache miss, invoke find by username, username:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其实对于：id—>user；username—->user；email—>user；更好的方式可能是：id—>user；username—>id；email—>id；保证user只存一份；如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cacheName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#user.username&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheValue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#user.username&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span>   


<span style=color:#5c35cc;font-weight:700>@Cacheable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cacheName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#user.username&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheValue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#caches[0].get(#caches[0].get(#username).get())&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>findByUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>)</span>  
</code></pre></div><h2 id=spel-上下文数据>SpEL 上下文数据</h2>
<p>Spring Cache提供了一些供我们使用的SpEL上下文数据，下表直接摘自Spring官方文档：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>位置</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>methodName</td>
<td>root对象</td>
<td>当前被调用的方法名</td>
<td>#root.methodName</td>
</tr>
<tr>
<td>method</td>
<td>root对象</td>
<td>当前被调用的方法</td>
<td>#root.method.name</td>
</tr>
<tr>
<td>target</td>
<td>root对象</td>
<td>当前被调用的目标对象</td>
<td>#root.target</td>
</tr>
<tr>
<td>targetClass</td>
<td>root对象</td>
<td>当前被调用的目标对象类</td>
<td>#root.targetClass</td>
</tr>
<tr>
<td>args</td>
<td>root对象</td>
<td>当前被调用的方法的参数列表</td>
<td>#root.args[0]</td>
</tr>
<tr>
<td>caches</td>
<td>root对象</td>
<td>当前方法调用使用的缓存列表（如@Cacheable(value={“cache1”, “cache2”})），则有两个cache</td>
<td>#root.caches[0].name</td>
</tr>
<tr>
<td>argument name</td>
<td>执行上下文</td>
<td>当前被调用的方法的参数，如findById(Long id)，我们可以通过#id拿到参数</td>
<td>#user.id</td>
</tr>
<tr>
<td>result</td>
<td>执行上下文</td>
<td>方法执行后的返回值（仅当方法执行之后的判断有效，如‘unless’，’cache evict’的beforeInvocation=false）</td>
<td>#result</td>
</tr>
</tbody>
</table>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CacheEvict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
            <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#user.id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
            <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#root.target.canCache() and #root.caches[0].get(#user.id).get().username ne #user.username&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> 
            <span style=color:#000>beforeInvocation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>conditionUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> 
</code></pre></div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>