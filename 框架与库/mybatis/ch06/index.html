<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>CH06-语句解析 | infilos.com</title><meta property="og:title" content="CH06-语句解析">
<meta property="og:description" content="Mapper 映射文件解析的最后一步是解析所有 statement 元素，即 select、insert、update、delete 元素，这些元素中可能会包含动态 SQL，即使用 ${} 占位符或 if、choose、where 等元素动态组成的 SQL。动态 SQL 功能正是 MyBatis 强大的所在，其解析过程也是十分复杂的。
解析工具 为了方便 statement 的解析，MyBatis 提供了一些解析工具。
Token 解析 MyBatis 支持使用 ${} 或 #{} 类型的 token 作为动态参数，不仅文本中可以使用 token，xml 元素中的属性等也可以使用。
GenericTokenParser GenericTokenParser 是 MyBatis 提供的通用 token 解析器，其解析逻辑是根据指定的 token 前缀和后缀搜索 token，并使用传入的 TokenHandler 对文本进行处理。
public String parse(String text) { if (text == null || text.isEmpty()) { return &#34;&#34;; } // search open token 搜索 token 前缀  int start = text.">
<meta property="og:type" content="article">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch06/"><meta property="article:section" content="框架与库">
<meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="CH06-语句解析">
<meta itemprop=description content="Mapper 映射文件解析的最后一步是解析所有 statement 元素，即 select、insert、update、delete 元素，这些元素中可能会包含动态 SQL，即使用 ${} 占位符或 if、choose、where 等元素动态组成的 SQL。动态 SQL 功能正是 MyBatis 强大的所在，其解析过程也是十分复杂的。
解析工具 为了方便 statement 的解析，MyBatis 提供了一些解析工具。
Token 解析 MyBatis 支持使用 ${} 或 #{} 类型的 token 作为动态参数，不仅文本中可以使用 token，xml 元素中的属性等也可以使用。
GenericTokenParser GenericTokenParser 是 MyBatis 提供的通用 token 解析器，其解析逻辑是根据指定的 token 前缀和后缀搜索 token，并使用传入的 TokenHandler 对文本进行处理。
public String parse(String text) { if (text == null || text.isEmpty()) { return &#34;&#34;; } // search open token 搜索 token 前缀  int start = text.">
<meta itemprop=wordCount content="4236">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="CH06-语句解析">
<meta name=twitter:description content="Mapper 映射文件解析的最后一步是解析所有 statement 元素，即 select、insert、update、delete 元素，这些元素中可能会包含动态 SQL，即使用 ${} 占位符或 if、choose、where 等元素动态组成的 SQL。动态 SQL 功能正是 MyBatis 强大的所在，其解析过程也是十分复杂的。
解析工具 为了方便 statement 的解析，MyBatis 提供了一些解析工具。
Token 解析 MyBatis 支持使用 ${} 或 #{} 类型的 token 作为动态参数，不仅文本中可以使用 token，xml 元素中的属性等也可以使用。
GenericTokenParser GenericTokenParser 是 MyBatis 提供的通用 token 解析器，其解析逻辑是根据指定的 token 前缀和后缀搜索 token，并使用传入的 TokenHandler 对文本进行处理。
public String parse(String text) { if (text == null || text.isEmpty()) { return &#34;&#34;; } // search open token 搜索 token 前缀  int start = text.">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
</div>
<div id=content-desktop></div>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-e6a186e69eb6e4b88ee5ba93><span>框架库</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring><span>Spring</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch01-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch01-ioc><span>CH01-IOC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch02-springioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch02-springioc><span>CH02-Spring IOC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch03-bean%E5%8A%A0%E8%BD%BD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch03-beane58aa0e8bdbd><span>CH03-Bean加载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch04-ioc%E6%BA%90%E7%A0%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch04-ioce6ba90e7a081><span>CH04-IOC源码</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch05-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch05-e5beaae78eafe4be9de8b596><span>CH05-循环依赖</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch07><span>CH07-动态代理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch08><span>CH08-接口定义</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch09><span>CH09-请求过程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch10><span>CH10-配置注入</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch11><span>CH11-配置绑定</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch12><span>CH12-环境变量</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93springch13-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93springch13><span>CH13-缓存注解</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-ioc><span>Spring IOC</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch01><span>CH01-获取单例 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch02><span>CH02-创建单例 Bean</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch03><span>CH03-创建原始 Bean 对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch04><span>CH04-解决循环依赖</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch05><span>CH05-原始 Bean 属性填充</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch06><span>CH06-后续初始化工作</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch07><span>CH07-生命周期扩展</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-ioc/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-iocch08><span>CH08-控制加载顺序</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93spring-aop-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93spring-aop><span>Spring AOP</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch01><span>AOP 理论</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/spring-aop/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93spring-aopch02><span>AOP 实战</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e6a186e69eb6e4b88ee5ba93mybatis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93mybatis><span>Mybatis</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch01><span>CH01-整体架构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch02><span>CH02-反射模块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch03><span>CH03-基础支持模块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch04><span>CH04-运行配置解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch05><span>CH05-通用配置解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch06/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch06><span class=td-sidebar-nav-active-item>CH06-语句解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch07><span>CH07-接口层</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch08><span>CH08-执行器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch09><span>CH09-集成 Spring</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch10><span>CH10-整体流程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch11><span>CH11-插件机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch12><span>CH12-代码生成</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch13><span>CH13-多数据源</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93mybatisch14><span>CH14-常用片段</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93hikari-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93hikari><span>Hikari</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich01-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich01><span>基本概念</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich02-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich02><span>开源实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich03-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich03><span>配置参数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich04-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich04><span>JDBC API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich05-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich05><span>性能原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich06-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich06><span>优化原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich07-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich07><span>参数解析</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich08-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich08><span>动态代理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich09-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich09><span>应用实践</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich10-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich10><span>监控度量</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich11-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich11><span>常见问题</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93hikarich12-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/hikari/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93hikarich12><span>扩展技术</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93unified-udf-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93unified-udf><span>Udf Modeling</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/transport-at-linkedin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udftransport-at-linkedin><span>Transport UDF at Linkedin</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/unified-udf/flink-type-system/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93unified-udfflink-type-system><span>Flink Type System</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e6a186e69eb6e4b88ee5ba93parboiled-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e6a186e69eb6e4b88ee5ba93parboiled><span>Parboiled</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch01-motivation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch01-motivation><span>CH01-Motivation</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch02-features/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch02-features><span>CH02-Features</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch03-java-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch03-java-example><span>CH03-Java Example</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch04-scala-example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch04-scala-example><span>CH04-Scala Example</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch05-comparison/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch05-comparison><span>CH05-Comparison</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch06-concepts/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch06-concepts><span>CH06-Concepts</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch07-java-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch07-java-apis><span>CH07-Java APIs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch08-scala-apis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch08-scala-apis><span>CH08-Scala APIs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics-li>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/parboiled/ch09-advanced-topics/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e6a186e69eb6e4b88ee5ba93parboiledch09-advanced-topics><span>CH09-Advanced Topics</span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/infilos/infilos.com/edit/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/mybatis/CH06.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/infilos/infilos.com/new/master/content/zh/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/mybatis/CH06.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/infilos/infilos.com/issues/new?title=CH06-%e8%af%ad%e5%8f%a5%e8%a7%a3%e6%9e%90" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#解析工具>解析工具</a>
<ul>
<li><a href=#token-解析>Token 解析</a></li>
<li><a href=#特殊容器>特殊容器</a></li>
<li><a href=#ognl-参数>OGNL 参数</a></li>
</ul>
</li>
<li><a href=#解析逻辑>解析逻辑</a>
<ul>
<li><a href=#语法驱动>语法驱动</a></li>
<li><a href=#递归解析-include>递归解析 include</a></li>
<li><a href=#解析-selectkey>解析 selectKey</a></li>
<li><a href=#创建-sql-生成对象>创建 sql 生成对象</a></li>
<li><a href=#创建解析对象与生成可执行-sql>创建解析对象与生成可执行 sql</a></li>
</ul>
</li>
<li><a href=#接口解析>接口解析</a></li>
<li><a href=#总结>总结</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/>框架库</a>
</li>
<li class=breadcrumb-item>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/>Mybatis</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/ch06/>CH06-语句解析</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>CH06-语句解析</h1>
<header class=article-meta>
</header>
<p>Mapper 映射文件解析的最后一步是解析所有 statement 元素，即 select、insert、update、delete 元素，这些元素中可能会包含动态 SQL，即使用 ${} 占位符或 if、choose、where 等元素动态组成的 SQL。动态 SQL 功能正是 MyBatis 强大的所在，其解析过程也是十分复杂的。</p>
<h2 id=解析工具>解析工具</h2>
<p>为了方便 statement 的解析，MyBatis 提供了一些解析工具。</p>
<h3 id=token-解析>Token 解析</h3>
<p>MyBatis 支持使用 ${} 或 #{} 类型的 token 作为动态参数，不仅文本中可以使用 token，xml 元素中的属性等也可以使用。</p>
<h4 id=generictokenparser>GenericTokenParser</h4>
<p>GenericTokenParser 是 MyBatis 提供的通用 token 解析器，其解析逻辑是根据指定的 token 前缀和后缀搜索 token，并使用传入的 TokenHandler 对文本进行处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// search open token 搜索 token 前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 没有 token 前缀，返回原文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>src</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toCharArray</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 当前解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 已解析文本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>builder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 当前占位符内的表达式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StringBuilder</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;\\&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果待解析属性前缀被转义，则去掉转义字符，加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// this open token is escaped. remove the backslash and continue.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// found open token. let&#39;s search close token.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 前缀前面的部分加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取对应的后缀索引
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;\\&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 后缀被转义，加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// this close token is escaped. remove the backslash and continue.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 寻找下一个后缀
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 找到后缀，获取占位符内的表达式
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 找不到后缀，前缀之后的部分全部加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// close token was not found.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 能够找到后缀，追加 token 处理器处理后的文本
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
          <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 寻找下一个前缀，重复解析表达式
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 将最后的部分加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 返回解析后的文本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由于 GenericTokenParser 的 token 前后缀和具体解析逻辑都是可指定的，因此基于 GenericTokenParser 可以实现对不同 token 的定制化解析。</p>
<h4 id=tokenhandler>TokenHandler</h4>
<p>TokenHandler 是 token 处理器抽象接口。实现此接口可以定义 token 以何种方式被解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 对 token 进行解析
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param content 待解析 token
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=propertyparser>PropertyParser</h4>
<p>PropertyParser 是 token 解析的一种具体实现，其指定对 <code>${}</code> 类型 token 进行解析，具体解析逻辑由其内部类 VariableTokenHandler 实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 对 ${} 类型 token 进行解析
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param string
</span><span style=color:#8f5902;font-style:italic>   * @param variables
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>VariableTokenHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>VariableTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据配置属性对 ${} token 进行解析
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VariableTokenHandler</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 预先设置的属性
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 是否运行使用默认值，默认为 false
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enableDefaultValue</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 默认值分隔符号，即如待解析属性 ${key:default}，key 的默认值为 default
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>VariableTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>variables</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableDefaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>KEY_ENABLE_DEFAULT_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ENABLE_DEFAULT_VALUE</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultValueSeparator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>KEY_DEFAULT_VALUE_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DEFAULT_VALUE_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enableDefaultValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 如待解析属性 ${key:default}，key 的默认值为 default
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>separatorIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 使用默认值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 不使用默认值
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 返回原文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;${&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>VariableTokenHandler 实现了 TokenHandler 接口，其构造方法允许传入一组 Properties 用于获取 token 表达式的值。如果开启了使用默认值，则表达式 ${key:default} 会在 key 没有映射值的时候使用 default 作为默认值。</p>
<h3 id=特殊容器>特殊容器</h3>
<h4 id=strictmap>StrictMap</h4>
<p>Configuration 中的 StrictMap 继承了 HashMap，相对于 HashMap，其存取键值的要求更为严格。put 方法不允许添加相同的 key，并获取最后一个 <code>.</code> 后的部分作为 shortKey，如果 shortKey 也重复了，其会向容器中添加一个 Ambiguity 对象，当使用 get 方法获取这个 shortKey 对应的值时，就会抛出异常。get 方法对于不存在的 key 也会抛出异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 重复 key 异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; already contains value for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span>
          <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conflictMessageProducer</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conflictMessageProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取最后一个 . 后的部分作为 shortKey
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>shortKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getShortName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// shortKey 不允许重复，否则在获取时异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>V</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// key 不存在抛异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; does not contain value for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 重复的 key 抛异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getSubject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is ambiguous in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span>
                                         <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; (try using the full name including the namespace, or rename one of the entries)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=contextmap>ContextMap</h4>
<p>ContextMap 是 DynamicContext 的静态内部类，用于保存 sql 上下文中的绑定参数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextMap</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2977601501966151582L</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 参数对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MetaObject</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ContextMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetaObject</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterMetaObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 先根据 key 查找原始容器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>strKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 再进入参数对象查找
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMetaObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// issue #61 do not modify the context when reading
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=ognl-参数>OGNL 参数</h3>
<h4 id=ognlcache>OgnlCache</h4>
<p>OGNL 工具支持通过字符串表达式调用 Java 方法，但是其实现需要对 OGNL 表达式进行编译，为了提高性能，MyBatis 提供 OgnlCache 工具类用于对 OGNL 表达式编译结果进行缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据 ognl 表达式和参数计算值
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param root
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Map</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createDefaultContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MEMBER_ACCESS</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CLASS_RESOLVER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OgnlException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error evaluating expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 编译 ognl 表达式并放入缓存
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws OgnlException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>OgnlException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expressionCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 编译 ognl 表达式
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 放入缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>expressionCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=expressionevaluator>ExpressionEvaluator</h4>
<p>ExpressionEvaluator 是 OGNL 表达式计算工具，evaluateBoolean 和 evaluateIterable 方法分别根据传入的表达式和参数计算出一个 boolean 值或一个可迭代对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 计算 ognl 表达式 true / false
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>evaluateBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 ognl 表达式和参数计算值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// true / false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 不为 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>compareTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ZERO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 不为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 计算获得一个可迭代的对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>evaluateIterable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; evaluated to a null value.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 已实现 Iterable 接口
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isArray</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 数组转集合
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// the array may be primitive, so Arrays.asList() may throw
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// a ClassCastException (issue 209).  Do the work manually
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// Curse primitives! :) (JGB)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>answer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>answer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>answer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Map 获取 entry
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error evaluating expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;.  Return value (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) was not iterable.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析逻辑>解析逻辑</h2>
<p>MyBastis 中调用 XMLStatementBuilder#parseStatementNode 方法解析单个 statement 元素。此方法中除了逐个获取元素属性，还对 include 元素、selectKey 元素进行解析，创建了 sql 生成对象 SqlSource，并将 statement 的全部信息聚合到 MappedStatement 对象中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseStatementNode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取 id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 自定义数据库厂商信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>databaseIdMatchesCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 不符合当前数据源对应的数据厂商信息的语句不加载
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 获取元素名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 元素名转为对应的 SqlCommandType 枚举
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlCommandType</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 是否为查询
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSelect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 获取 flushCache 属性，查询默认为 false，其它默认为 true
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flushCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;flushCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>isSelect</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取 useCache 属性，查询默认为 true，其它默认为 false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>useCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;useCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isSelect</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取 resultOrdered 属性，默认为 false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resultOrdered</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultOrdered&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// Include Fragments before parsing
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>XMLIncludeTransformer</span> <span style=color:#000>includeParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLIncludeTransformer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析 include 属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>includeParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#8f5902;font-style:italic>// 参数类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>parameterType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parameterType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 Mapper 语法类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>lang</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lang&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 默认使用 XMLLanguageDriver
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LanguageDriver</span> <span style=color:#000>langDriver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getLanguageDriver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// Parse selectKey after includes and remove them.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 解析 selectKey 元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>processSelectKeyNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 KeyGenerator
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>keyStatementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SelectKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT_KEY_SUFFIX</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>keyStatementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取解析完成的 KeyGenerator 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果开启了 useGeneratedKeys 属性，并且为插入类型的 sql 语句、配置了 keyProperty 属性，则可以批量自动设置属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;useGeneratedKeys&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isUseGeneratedKeys</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSERT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>))</span>
          <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>Jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 生成有效 sql 语句和参数绑定对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// sql 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StatementType</span> <span style=color:#000>statementType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;statementType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PREPARED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#8f5902;font-style:italic>// 分批获取数据的数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Integer</span> <span style=color:#000>fetchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fetchSize&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 执行超时时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Integer</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;timeout&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 参数映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>parameterMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parameterMap&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 返回值映射 map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 结果集类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSetType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ResultSetType</span> <span style=color:#000>resultSetTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveResultSetType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSetType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 插入、更新生成键值的字段
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyProperty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyProperty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 插入、更新生成键值的列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 指定多结果集名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSets&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 新增 MappedStatement
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>fetchSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultSetTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>useCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultOrdered</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultSets</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=语法驱动>语法驱动</h3>
<p>LanguageDriver 是 statement 创建语法驱动，默认实现为 XMLLanguageDriver，其提供 createSqlSource 方法用于使用 XMLScriptBuilder 创建 sql 生成对象。</p>
<h3 id=递归解析-include>递归解析 include</h3>
<p>include 元素是 statement 元素的子元素，通过 refid 属性可以指向在别处定义的 sql fragments。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Properties</span> <span style=color:#000>variablesContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Properties</span> <span style=color:#000>configurationVariables</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 拷贝全局配置中设置的额外配置属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configurationVariables</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>putAll</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 递归解析 statement 元素中的 include 元素
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * Recursively apply includes through all SQL fragments.
</span><span style=color:#8f5902;font-style:italic>   * @param source Include node in DOM tree
</span><span style=color:#8f5902;font-style:italic>   * @param variablesContext Current context for static variables with values
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Properties</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>included</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;include&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// include 元素，从全局配置中找对应的 sql 节点并 clone
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Node</span> <span style=color:#000>toInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findSqlFragment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;refid&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 读取 include 子元素中的 property 元素，获取全部属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>toIncludeContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getVariablesContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>toIncludeContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>toInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>importNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replaceChild</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasChildNodes</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>insertBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFirstChild</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeChild</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>included</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// replace variables in attribute values
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// include 指向的 sql clone 节点，逐个对属性进行解析
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>NamedNodeMap</span> <span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributes</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>Node</span> <span style=color:#000>attr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNodeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// statement 元素中可能包含 include 子元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>included</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>included</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TEXT_NODE</span>
        <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// replace variables in text node
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 替换元素值，如果使用了 ${} 占位符，会对 token 进行解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNodeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 从全局配置中找对应的 sql fragment
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param refid
</span><span style=color:#8f5902;font-style:italic>   * @param variables
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Node</span> <span style=color:#000>findSqlFragment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 解析 refid
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// namespace.refid
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 从全局配置中找对应的 sql fragment
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>XNode</span> <span style=color:#000>nodeToInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nodeToInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>cloneNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// sql fragments 定义在全局配置中的 StrictMap 中，获取不到会抛出异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not find SQL statement to include with refid &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributes</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNamedItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Read placeholders and their values from include node definition.
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * 读取 include 子元素中的 property 元素
</span><span style=color:#8f5902;font-style:italic>   * @param node Include node instance
</span><span style=color:#8f5902;font-style:italic>   * @param inheritedVariablesContext Current context used for replace variables in new variables values
</span><span style=color:#8f5902;font-style:italic>   * @return variables context from include instance (no inherited values)
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Properties</span> <span style=color:#000>getVariablesContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 解析 include 元素中的 property 子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Node</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// include 运行包含 property 元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Replace variables inside
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 不允许添加同名属性
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Variable &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; defined twice in the same include definition&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 聚合属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>newProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在开始解析前，从全局配置中获取全部的属性配置，如果 include 元素中有 property 元素，解析并获取键值，放入 variablesContext 中，在后续处理中针对可能出现的 ${} 类型 token 使用 PropertyParser 进行解析。</p>
<p>因为解析 statement 元素前已经加载过 sql 元素，因此会根据 include 元素的 refid 属性查找对应的 sql fragments，如果全局配置中无法找到就会抛出异常；如果能够找到则克隆 sql 元素并插入到当前 xml 文档中。</p>
<h3 id=解析-selectkey>解析 selectKey</h3>
<p>selectKey 用于指定 sql 在 insert 或 update 语句执行前或执行后生成或获取列值，在 MyBatis 中 selectKey 也被当做 statement 语句进行解析并设置到全局配置中。单个 selectKey 元素会以SelectKeyGenerator 对象的形式进行保存用于后续调用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseSelectKeyNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XNode</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>LanguageDriver</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>StatementType</span> <span style=color:#000>statementType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;statementType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PREPARED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#8f5902;font-style:italic>// 对应字段名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyProperty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyProperty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 对应列名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 是否在父sql执行前执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>executeBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;BEFORE&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AFTER&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#8f5902;font-style:italic>//defaults
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>useCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resultOrdered</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Integer</span> <span style=color:#000>fetchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Integer</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flushCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>parameterMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ResultSetType</span> <span style=color:#000>resultSetTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 创建 sql 生成对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlCommandType</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 将 KeyGenerator 生成 sql 作为 MappedStatement 加入全局对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>fetchSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultSetTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>useCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultOrdered</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>MappedStatement</span> <span style=color:#000>keyStatement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 包装为 SelectKeyGenerator 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SelectKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executeBefore</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 selectKey 解析完成后，按指定的 namespace 规则从全局配置中获取 SelectKeyGenerator 对象，等待创建 MappedStatement 对象。如果未指定 selectKey 元素，但是全局配置中开启了 useGeneratedKeys，并且指定 insert 元素的 useGeneratedKeys 属性为 true，则 MyBatis 会指定 Jdbc3KeyGenerator 作为 useGeneratedKeys 的默认实现。</p>
<h3 id=创建-sql-生成对象>创建 sql 生成对象</h3>
<h4 id=sqlsource>SqlSource</h4>
<p>SqlSource 是 sql 生成抽象接口，其提供 getBoundSql 方法用于根据参数生成有效 sql 语句和参数绑定对象 BoundSql。在生成 statement 元素的解析结果 MappedStatement 对象前，需要先创建 sql 生成对象，即 SqlSource 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlSource</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据参数生成有效 sql 语句和参数绑定对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=sqlnode>SqlNode</h4>
<p>SqlNode 是 sql 节点抽象接口。sql 节点指的是 statement 中的组成部分，如果简单文本、if 元素、where 元素等。SqlNode 提供 apply 方法用于判断当前 sql 节点是否可以加入到生效的 sql 语句中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据条件判断当前 sql 节点是否可以加入到生效的 sql 语句中
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211008223403.png style=display:block;width:70% alt=NAME align=center> </div>
<h4 id=dynamiccontext>DynamicContext</h4>
<p>DynamicContext 是动态 sql 上下文，用于保存绑定参数和生效 sql 节点。DynamicContext 使用 ContextMap 作为参数绑定容器。由于动态 sql 是根据参数条件组合生成 sql，DynamicContext 还提供了对 sqlBuilder 修改和访问方法，用于添加有效 sql 节点和生成 sql 文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 生效的 sql 部分，以空格相连
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringJoiner</span> <span style=color:#000>sqlBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringJoiner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getSql</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=节点解析>节点解析</h4>
<p>将 statement 元素转为 sql 生成对象依赖于 LanguageDriver 的 createSqlSource 方法，此方法中创建 XMLScriptBuilder 对象，并调用 parseScriptNode 方法对 sql 组成节点逐个解析并进行组合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSource</span> <span style=color:#000>parseScriptNode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 递归解析各 sql 节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MixedSqlNode</span> <span style=color:#000>rootSqlNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseDynamicTags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDynamic</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 动态 sql
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DynamicSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 原始文本 sql
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RawSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 处理 statement 各 SQL 组成部分，并进行组合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>MixedSqlNode</span> <span style=color:#000>parseDynamicTags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// SQL 各组成部分
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 遍历子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newXNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CDATA_SECTION_NODE</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TEXT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 sql 文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>TextSqlNode</span> <span style=color:#000>textSqlNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TextSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>textSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDynamic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 判断是否为动态 sql，包含 ${} 占位符即为动态 sql
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>textSqlNode</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>isDynamic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 静态 sql 元素
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticTextSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// issue #628
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 如果是子元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取支持的子元素语法处理器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>NodeHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown element &lt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&gt; in SQL statement.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 根据子元素标签类型使用对应的处理器处理子元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 包含标签元素，认定为动态 SQL
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>isDynamic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MixedSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>parseDynamicTags 方法会对 sql 各组成部分进行分解，如果 statement 元素包含 ${} 类型 token 或含有标签子元素，则认为当前 statement 是动态 sql，随后 isDynamic 属性会被设置为 true。对于文本节点，如 sql 纯文本和仅含 ${} 类型 token 的文本，会被包装为 StaticTextSqlNode 或 TextSqlNode 加入到 sql 节点容器中，而其它元素类型的 sql 节点会经过 NodeHandler 的 handleNode 方法处理过之后才能加入到节点容器中。nodeHandlerMap 定义了不同动态 sql 元素节点与 NodeHandler 的关系：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initNodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trim&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TrimHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;where&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WhereHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SetHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foreach&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;if&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IfHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;choose&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChooseHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;when&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IfHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;otherwise&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OtherwiseHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bind&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=mixedsqlnode>MixedSqlNode</h5>
<p>MixedSqlNode 中定义了一个 SqlNode 集合，用于保存 statement 中包含的全部 sql 节点。其生成有效 sql 的逻辑为逐个判断节点是否有效。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 组合 SQL 各组成部分
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @author Clinton Begin
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MixedSqlNode</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * SQL 各组装成部分
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MixedSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 逐个判断各个 sql 节点是否能生效
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=statictextsqlnode>StaticTextSqlNode</h5>
<p>StaticTextSqlNode 中仅包含静态 sql 文本，在组装时会直接追加到 sql 上下文的有效 sql 中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=textsqlnode>TextSqlNode</h5>
<p>TextSqlNode 中的 sql 文本包含 ${} 类型 token，使用 GenericTokenParser 搜索到 token 后会使用 BindingTokenParser 对 token 进行解析，解析后的文本会被追加到生效 sql 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 搜索 ${} 类型 token 节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 解析 token 并追加解析后的文本到生效 sql 中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>GenericTokenParser</span> <span style=color:#000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TokenHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BindingTokenParser</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Pattern</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BindingTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pattern</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取绑定参数
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;_parameter&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SimpleTypeRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSimpleType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 计算 ognl 表达式的值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>String</span> <span style=color:#000>srtValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// issue #274 return &#34;&#34; instead of &#34;null&#34;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>checkInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srtValue</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>srtValue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=ifsqlnode>IfSqlNode</h5>
<p>if 标签用于在 test 条件生效时才追加标签内的文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userId &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    AND user_id = #｛userId｝
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
</code></pre></div><p>IfSqlNode 保存了 if 元素下的节点内容和 test 表达式，在生成有效 sql 时会根据 OGNL 工具计算 test 表达式是否生效。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 test 表达式判断当前节点是否生效
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>evaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=trimsqlnode>TrimSqlNode</h5>
<p>trim 标签用于解决动态 sql 中由于条件不同不能拼接正确语法的问题。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  SELECT * FROM test
  <span style=color:#204a87;font-weight:700>&lt;trim</span> <span style=color:#c4a000>prefix=</span><span style=color:#4e9a06>&#34;WHERE&#34;</span> <span style=color:#c4a000>prefixOverrides=</span><span style=color:#4e9a06>&#34;AND|OR&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      a = #{a}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;b &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      OR b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;c &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      AND c = #{c}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/trim&gt;</span>
</code></pre></div><p>如果没有 trim 标签，这个 statement 的有效 sql 最终可能会是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#a40000>{</span><span style=color:#000>b</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>但是加上 trim 标签，生成的 sql 语法是正确的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#a40000>{</span><span style=color:#000>b</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>prefix 属性用于指定 trim 节点生成的 sql 语句的前缀，prefixOverrides 则会指定生成的 sql 语句的前缀需要去除的部分，多个需要去除的前缀可以使用 | 隔开。suffix 与 suffixOverrides 的功能类似，但是作用于后缀。</p>
<p>TrimSqlNode 首先调用 parseOverrides 对 prefixOverrides 和 suffixOverrides 进行解析，通过 | 分隔，分别加入字符串集合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parseOverrides</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析 token，按 | 分隔
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringTokenizer</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;|&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countTokens</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreTokens</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存为字符串集合
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextToken</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在调用包含的 SqlNode 的 apply 方法后还会调用 FilteredDynamicContext 的 applyAll 方法处理前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>FilteredDynamicContext</span> <span style=color:#000>filteredDynamicContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加上前缀和和后缀，并去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>filteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于已经生成的 sql 文本，分别根据规则加上和去除指定前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyAll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 加上前缀和和后缀，并去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>applyPrefix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applySuffix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyPrefix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringBuilder</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>prefixApplied</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>prefixApplied</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefixesToOverride</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 文本最前去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>toRemove</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>prefixesToOverride</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 在文本最前插入前缀和空格
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applySuffix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringBuilder</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>suffixApplied</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>suffixApplied</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffixesToOverride</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 文本最后去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>toRemove</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>suffixesToOverride</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 文本最后插入空格和后缀
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffix</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffix</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=wheresqlnode>WhereSqlNode</h5>
<p>where 元素与 trim 元素的功能类似，区别在于 where 元素不提供属性配置可以处理的前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>
    ...
  <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>
</code></pre></div><p>WhereSqlNode 继承了 TrimSqlNode，并指定了需要添加和删除的前缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WhereSqlNode</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TrimSqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prefixList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;AND &#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;OR &#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;AND\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AND\r&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\r&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AND\t&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\t&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>WhereSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlNode</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 默认添加 WHERE 前缀，去除 AND、OR 等前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;WHERE&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prefixList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因此，生成的 sql 语句会自动在最前加上 WHERE，并去除前缀中包含的 AND、OR 等字符串。</p>
<h5 id=setsqlnode>SetSqlNode</h5>
<p>set 标签用于 update 语句中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>	UPDATE test
	<span style=color:#204a87;font-weight:700>&lt;set&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      a = #{a},
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;b &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>
</code></pre></div><p>SetSqlNode 同样继承自 TrimSqlNode，并指定默认添加 SET 前缀，去除 , 前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SetSqlNode</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TrimSqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>COMMA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SetSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>SqlNode</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 默认添加 SET 前缀，去除 , 前缀和后缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;SET&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMA</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMA</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=foreachsqlnode>ForEachSqlNode</h5>
<p>foreach 元素用于指定对集合循环添加 sql 语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;list&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;item&#34;</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;index&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  AND itm = #{item} AND idx #{index}
<span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
</code></pre></div><p>ForEachSqlNode 解析生成有效 sql 的逻辑如下，除了计算 collection 表达式的值、添加前缀、后缀外，还将参数与索引进行了绑定。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取绑定参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>bindings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 计算 ognl 表达式获取可迭代对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>iterable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>evaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateIterable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>collectionExpression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bindings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>iterable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 添加动态语句前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyOpen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 迭代索引
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iterable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>DynamicContext</span> <span style=color:#000>oldContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 首个元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>separator</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>uniqueNumber</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUniqueNumber</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// Issue #709
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// entry 集合项索引为 key，集合项为 value
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 绑定集合项索引关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 绑定集合项关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!((</span><span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isPrefixApplied</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldContext</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 添加动态语句后缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyClose</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 移除原始的表达式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 绑定集合项索引关系
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param o
</span><span style=color:#8f5902;font-style:italic>   * @param i
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 绑定集合项关系
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param o
</span><span style=color:#8f5902;font-style:italic>   * @param i
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于循环中的 #{} 类型 token，ForEachSqlNode 在内部类 FilteredDynamicContext 中定义了解析规则：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;^\\s*&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;(?![^.,:\\s])&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>newContent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;^\\s*&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>itemIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;(?![^.,:\\s])&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;#{&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>});</span>

    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>类似 <code>idx = #{index} AND itm = #{item}</code> 会被替换为 <code>idx = #{__frch_index_1} AND itm = #{__frch_item_1}</code>，而 ForEachSqlNode 也做了参数与索引的绑定，因此在替换时可以快速绑定参数。</p>
<h5 id=choosesqlnode>ChooseSqlNode</h5>
<p>choose 元素用于生成带默认 sql 文本的语句，当 when 元素中的条件都不生效，就可以使用 otherwise 元素的默认文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;choose&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    	AND a = #{a}
    <span style=color:#204a87;font-weight:700>&lt;/when&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;otherwise&gt;</span>
    	AND b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/otherwise&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/choose&gt;</span>
</code></pre></div><p>ChooseSqlNode 是由 choose 节点和 otherwise 节点组合而成的，在生成有效 sql 于语句时会逐个计算 when 节点的 test 表达式，如果返回 true 则生效当前 when 语句中的 sql。如果均不生效则使用 otherwise 语句对应的默认 sql 文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// when 节点根据 test 表达式判断是否生效
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlNode</span> <span style=color:#000>sqlNode</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ifSqlNodes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// when 节点如果都未生效，且存在 otherwise 节点，则使用 otherwise 节点
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultSqlNode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>defaultSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=vardeclsqlnode>VarDeclSqlNode</h5>
<p>bind 元素用于绑定一个 OGNL 表达式到一个动态 sql 变量中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bind</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;pattern&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;&#39;%&#39; + _parameter.getTitle() + &#39;%&#39;&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>VarDeclSqlNode 会计算表达式的值并将参数名和值绑定到参数容器中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 解析 ognl 表达式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#8f5902;font-style:italic>// 绑定参数
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建解析对象与生成可执行-sql>创建解析对象与生成可执行 sql</h3>
<p>statemen 解析完毕后会创建 MappedStatement 对象，statement 的相关属性以及生成的 sql 创建对象都会被保存到该对象中。MappedStatement 还提供了 getBoundSql 方法用于获取可执行 sql 和参数绑定对象，即 BoundSql 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 生成可执行 sql 和参数绑定对象
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#8f5902;font-style:italic>// 获取参数映射
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ParameterMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// check for nested result maps in parameter mappings (issue #30)
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 检查是否有嵌套的 resultMap
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterMapping</span> <span style=color:#000>pm</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>rmId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMapId</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rmId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ResultMap</span> <span style=color:#000>rm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rmId</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rm</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>hasNestedResultMaps</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>rm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNestedResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BoundSql 对象由 DynamicSqlSource 的 getBoundSql 方法生成，在验证各个 sql 节点，生成了有效 sql 后会继续调用 SqlSourceBuilder 将 sql 解析为 StaticSqlSource，即可执行 sql。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DynamicContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 验证各 sql 节点，生成有效 sql
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlSourceBuilder</span> <span style=color:#000>sqlSourceParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSourceBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 将生成的 sql 文本解析为 StaticSqlSource
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSourceParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此时的 sql 文本中仍包含 #{} 类型 token，需要通过 ParameterMappingTokenHandler 进行解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSource</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>originalSql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ParameterMappingTokenHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParameterMappingTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建 #{} 类型 token 搜索对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析 token
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>originalSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建静态 sql 生成对象，并绑定参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>token 的具体解析逻辑为根据表达式的参数名生成对应的参数映射对象，并将表达式转为预编译 sql 的占位符 ?。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建参数映射对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildParameterMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 将表达式转为预编译 sql 占位符
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;?&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终解析完成的 sql 与参数映射关系集合包装为 StaticSqlSource 对象，该对象在随后的逻辑中通过构造方法创建了 BoundSql 对象。</p>
<h2 id=接口解析>接口解析</h2>
<p>除了使用 xml 方式配置 statement，MyBatis 同样支持使用 Java 注解配置。但是相对于 xml 的映射方式，将动态 sql 写在 Java 代码中是不合适的。如果在配置文件中指定了需要注册 Mapper 接口的类或包，MyBatis 会扫描相关类进行注册；在 Mapper 文件解析完成后也会尝试加载 namespace 的同名类，如果存在，则注册为 Mapper 接口。</p>
<p>无论是绑定还是直接注册 Mapper 接口，都是调用 MapperAnnotationBuilder#parse 方法来解析的。此方法中的解析方式与上述 xml 解析方式大致相同，区别只在于相关配置参数是从注解中获取而不是从 xml 元素属性中获取。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 不允许相同接口重复注册
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Type &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is already known to the MapperRegistry.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#8f5902;font-style:italic>// It&#39;s important that the type is added before the parser is run
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// otherwise the binding may automatically be attempted by the
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// mapper parser. If the type is already known, it won&#39;t try.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MapperAnnotationBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperAnnotationBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>loadCompleted</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p><code>statement</code> 解析的最终目的是为每个 <code>statement</code> 创建一个 <code>MappedStatement</code> 对象保存相关定义，在 <code>sql</code> 执行时根据传入参数动态获取可执行 <code>sql</code> 和参数绑定对象。</p>
<ul>
<li><code>org.apache.ibatis.builder.xml.XMLStatementBuilder</code>：解析 <code>Mapper</code> 文件中的 <code>select|insert|update|delete</code> 元素。</li>
<li><code>org.apache.ibatis.parsing.GenericTokenParser.GenericTokenParser</code>：搜索指定格式 <code>token</code> 并进行解析。</li>
<li><code>org.apache.ibatis.parsing.TokenHandler</code>：<code>token</code> 处理器抽象接口。定义 <code>token</code> 以何种方式被解析。</li>
<li><code>org.apache.ibatis.parsing.PropertyParser</code>：<code>${}</code> 类型 <code>token</code> 解析器。</li>
<li><code>org.apache.ibatis.session.Configuration.StrictMap</code>：封装 <code>HashMap</code>，对键值存取有严格要求。</li>
<li><code>org.apache.ibatis.builder.xml.XMLIncludeTransformer</code>：<code>include</code> 元素解析器。</li>
<li><code>org.apache.ibatis.mapping.SqlSource</code>：<code>sql</code> 生成抽象接口。根据传入参数生成有效 <code>sql</code> 语句和参数绑定对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.XMLScriptBuilder</code>：解析 <code>statement</code> 各个 <code>sql</code> 节点并进行组合。</li>
<li><code>org.apache.ibatis.scripting.xmltags.SqlNode</code>：<code>sql</code> 节点抽象接口。用于判断当前 <code>sql</code> 节点是否可以加入到生效的 sql 语句中。</li>
<li><code>org.apache.ibatis.scripting.xmltags.DynamicContext</code>：动态 <code>sql</code> 上下文。用于保存绑定参数和生效 <code>sql</code> 节点。</li>
<li><code>org.apache.ibatis.scripting.xmltags.OgnlCache</code>：<code>ognl</code> 缓存工具，缓存表达式编译结果。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ExpressionEvaluator</code>：<code>ognl</code> 表达式计算工具。</li>
<li><code>org.apache.ibatis.scripting.xmltags.MixedSqlNode</code>：<code>sql</code> 节点组合对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.StaticTextSqlNode</code>：静态 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.TextSqlNode</code>：<code>${}</code> 类型 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.IfSqlNode</code>：<code>if</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.TrimSqlNode</code>：<code>trim</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.WhereSqlNode</code>：<code>where</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.SetSqlNode</code>：<code>set</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ForEachSqlNode</code>：<code>foreach</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ChooseSqlNode</code>：<code>choose</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.VarDeclSqlNode</code>：<code>bind</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.mapping.MappedStatement</code>：<code>statement</code> 解析对象。</li>
<li><code>org.apache.ibatis.mapping.BoundSql</code>：可执行 <code>sql</code> 和参数绑定对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.DynamicSqlSource</code>：根据参数动态生成有效 <code>sql</code> 和绑定参数。</li>
<li><code>org.apache.ibatis.builder.SqlSourceBuilder</code>：解析 <code>#{}</code> 类型 <code>token</code> 并绑定参数对象。</li>
</ul>
<style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style>
<div class=d-print-none>
<h2 class=feedback--title>Feedback</h2>
<p class=feedback--question>Was this page helpful?</p>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
Glad to hear it! Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
Sorry to hear that. Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
</div>
<script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script>
<br>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>