<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.4">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Mybatis | infilos.com</title><meta property="og:title" content="Mybatis">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Mybatis">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Mybatis">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%BA%93/mybatis/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Mybatis</h1>
<ul>
<li>1: <a href=#pg-dd52fe1a10710f0961ee3c2e2b522a33>CH01-整体架构</a></li>
<li>2: <a href=#pg-773d776c2e66e11b838e4ab33514e4c1>CH02-反射模块</a></li>
<li>3: <a href=#pg-499db58c0f961451e8ac888520e1c5fa>CH03-基础支持模块</a></li>
<li>4: <a href=#pg-5b7e738c6d50dab8aea897b0c9b16a6f>CH04-运行配置解析</a></li>
<li>5: <a href=#pg-125a1275eb4845ae03d56a1d156b0d92>CH05-通用配置解析</a></li>
<li>6: <a href=#pg-a9c6c53bbe0dedfdf1ef1b445f90dcb1>CH06-语句解析</a></li>
<li>7: <a href=#pg-76dd90616bec5587f31bc2e5f663b91b>CH07-接口层</a></li>
<li>8: <a href=#pg-c2f0467d2acc81697b3d21a42afa4ddb>CH08-执行器</a></li>
<li>9: <a href=#pg-dd0af738f6f6eeb4e6c0c4aeb3162eaa>CH09-集成 Spring</a></li>
<li>10: <a href=#pg-08516932d642ae0a720b5753a346bba3>CH10-整体流程</a></li>
<li>11: <a href=#pg-14222f79d12931239488c3ab405189f6>CH11-插件机制</a></li>
<li>12: <a href=#pg-68611e2d64eb5f1709d53542acbd61f4>CH12-代码生成</a></li>
<li>13: <a href=#pg-1b4c6af1cc9c41504ec2b73cde59980f>CH13-多数据源</a></li>
<li>14: <a href=#pg-6381d54b4f53832189fba7dda04feff4>CH14-常用片段</a></li>
<li>15: <a href=#pg-793fd8ea7c464da2cc8fff2fb0e503ba>CH15-事务管理原理</a></li>
<li>16: <a href=#pg-7d266cedb46af8162e4941805ad7b1a0>CH16-一级缓存原理</a></li>
<li>17: <a href=#pg-5fa0843facc8832df69a145efc110729>CH17-二级缓存原理</a></li>
<li>18: <a href=#pg-91f758c1e325ae2666e56b9f26b9dbb4>CH18-性能优化</a></li>
</ul>
<div class=content>
<p>参考自 &lt;MyBatis 技术内幕>。</p>
</div>
</div>
<div class=td-content>
<h1 id=pg-dd52fe1a10710f0961ee3c2e2b522a33>1 - CH01-整体架构</h1>
<p>MyBatis 是一款旨在帮助开发人员屏蔽底层重复性原生 JDBC 代码的持久化框架，其支持通过映射文件配置或注解将 ResultSet 映射为 Java 对象。相对于其它 ORM 框架，MyBatis 更为轻量级，支持定制化 SQL
和动态 SQL，方便优化查询性能，同时包含了良好的缓存机制。</p>
<h2 id=整体架构>整体架构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211005234510.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=基础支持层>基础支持层</h3>
<ul>
<li>反射模块：提供封装的反射 API，方便上层调用。</li>
<li>类型转换：为简化配置文件提供了别名机制，并且实现了 Java 类型和 JDBC 类型的互转。</li>
<li>日志模块：能够集成多种第三方日志框架。</li>
<li>资源加载模块：对类加载器进行封装，提供加载类文件和其它资源文件的功能。</li>
<li>数据源模块：提供数据源实现并能够集成第三方数据源模块。</li>
<li>事务管理：可以和 Spring 集成开发，对事务进行管理。</li>
<li>缓存模块：提供一级缓存和二级缓存，将部分请求拦截在缓存层。</li>
<li>Binding 模块：在调用 SqlSession 相应方法执行数据库操作时，需要指定映射文件中的 SQL 节点，MyBatis 通过 Binding 模块将自定义 Mapper 接口与映射文件关联，避免拼写等错误导致在运行时才发现相应异常。</li>
</ul>
<h3 id=核心处理层>核心处理层</h3>
<ul>
<li>配置解析：MyBatis 初始化时会加载配置文件、映射文件和 Mapper 接口的注解信息，解析后会以对象的形式保存到 Configuration 对象中。</li>
<li>SQL 解析与 scripting 模块：MyBatis 支持通过配置实现动态 SQL，即根据不同入参生成 SQL。</li>
<li>SQL 执行与结果解析：Executor 负责维护缓存和事务管理，并将数据库相关操作委托给 StatementHandler，ParmeterHadler 负责完成 SQL 语句的实参绑定并通过 Statement 对象执行 SQL，通过 ResultSet 返回结果，交由 ResultSetHandler 处理。</li>
<li>插件：支持开发者通过插件接口对 MyBatis 进行扩展。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211005234752.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=接口层>接口层</h3>
<p>SqlSession 接口定义了暴露给应用程序调用的 API，接口层在收到请求时会调用核心处理层的相应模块完成具体的数据库操作。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-773d776c2e66e11b838e4ab33514e4c1>2 - CH02-反射模块</h1>
<p>MyBatis 在进行参数处理、结果映射时等操作时，会涉及大量的反射操作。为了简化这些反射相关操作，MyBatis 在 org.apache.ibatis.reflection 包下提供了专门的反射模块，对反射操作做了近一步封装，提供了更为简洁的 API。</p>
<h2 id=缓存类的元信息>缓存类的元信息</h2>
<p>MyBatis 提供 Reflector 类来缓存类的字段名和 getter/setter 方法的元信息，使得反射时有更好的性能。使用方式是将原始类对象传入其构造方法，生成 Reflector 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 如果存在，记录无参构造方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addDefaultConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 记录字段名与get方法、get方法返回值的映射关系
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addGetMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 记录字段名与set方法、set方法参数的映射关系
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addSetMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 针对没有getter/setter方法的字段，通过Filed对象的反射来设置和读取字段值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 可读的字段名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>readablePropertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()]);</span>
    <span style=color:#8f5902;font-style:italic>// 可写的字段名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>writablePropertyNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>setMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>setMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()]);</span>
    <span style=color:#8f5902;font-style:italic>// 保存一份所有字段名大写与原始字段名的映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>readablePropertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>caseInsensitivePropertyMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>writablePropertyNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>caseInsensitivePropertyMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>addGetMethods 和 addSetMethods 分别获取类的所有方法，从符合 getter/setter 规范的方法中解析出字段名，并记录方法的参数类型、返回值类型等信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addGetMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 字段名-get方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>conflictingGetters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 获取类的所有方法，及其实现接口的方法，并根据方法签名去重
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getClassMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 过滤有参方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;get&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)</span>
          <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;is&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 由get属性获取对应的字段名（去除前缀，首字母转小写）
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyNamer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodToProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>addMethodConflict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 保证每个字段只对应一个get方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>resolveGetterConflicts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对 getter/setter 方法进行去重是通过类似 java.lang.String#getSignature:java.lang.reflect.Method 的方法签名来实现的，如果子类在实现过程中，参数、返回值使用了不同的类型（使用原类型的子类），则会导致方法签名不一致，同一字段就会对应不同的 getter/setter 方法，因此需要进行去重。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>resolveGetterConflicts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conflictingGetters</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Method</span> <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 属性名
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 字段对应了多个get方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>winnerType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>candidateType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winnerType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 返回值类型相同
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;Illegal overloaded getter method with ambiguous type for property &#34;</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; in class &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()</span>
                    <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. This breaks the JavaBeans specification and can cause unpredictable results.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;is&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 返回值为boolean的get方法可能有多个，如getIsSave和isSave，优先取is开头的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winnerType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// OK getter type is descendant
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// 可能会出现接口中的方法返回值是List，子类实现方法返回值是ArrayList，使用子类返回值方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>winnerType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>candidateType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>winner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionException</span><span style=color:#ce5c00;font-weight:700>(</span>
              <span style=color:#4e9a06>&#34;Illegal overloaded getter method with ambiguous type for property &#34;</span>
                  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; in class &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()</span>
                  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. This breaks the JavaBeans specification and can cause unpredictable results.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 记录字段名对应的get方法对象和返回值类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>addGetMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>winner</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>去重的方式是使用更规范的方法以及使用子类的方法。在确认字段名对应的唯一 getter/setter 方法后，记录方法名对应的方法、参数、返回值等信息。MethodInvoker 可用于调用 Method 类的 invoke 方法来执行 getter/setter 方法（addSetMethods 记录映射关系的方式与 addGetMethods 大致相同）。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addGetMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 过滤$开头、serialVersionUID的get方法和getClass()方法
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isValidPropertyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 字段名-对应get方法的MethodInvoker对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>Type</span> <span style=color:#000>returnType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TypeParameterResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveReturnType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 字段名-运行时方法的真正返回类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>getTypes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeToClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接下来会执行 addFields 方法，此方法针对没有 getter/setter 方法的字段，通过包装为 SetFieldInvoker 在需要时通过 Field 对象的反射来设置和读取字段值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>fields</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredFields</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span> <span style=color:#000>field</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>fields</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>setMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// issue #379 - removed the check for final because JDK 1.5 allows
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// modification of final fields through reflection (JSR-133). (JGB)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// pr #16 - final static can only be set by the classloader
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>modifiers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFinal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 非final的static变量，没有set方法，可以通过File对象做赋值操作
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>addSetField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>getMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>addGetField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperclass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 递归查找父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addFields</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSuperclass</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=抽象字段赋值与读取>抽象字段赋值与读取</h2>
<p>Invoker 接口用于抽象设置和读取字段值的操作。对于有 getter/setter 方法的字段，通过 MethodInvoker 反射执行；对应其它字段，通过 GetFieldInvoker 和 SetFieldInvoker 操作 Field 对象的 getter/setter 方法反射执行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 用于抽象设置和读取字段值的操作
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * {@link MethodInvoker} 反射执行getter/setter方法
</span><span style=color:#8f5902;font-style:italic> * {@link GetFieldInvoker} {@link SetFieldInvoker} 反射执行Field对象的get/set方法
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author Clinton Begin
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Invoker</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 通过反射设置或读取字段值
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param target
</span><span style=color:#8f5902;font-style:italic>   * @param args
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws IllegalAccessException
</span><span style=color:#8f5902;font-style:italic>   * @throws InvocationTargetException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 字段类型
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getType</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析参数类型>解析参数类型</h2>
<p>针对 Java-Type 体系的多种实现，TypeParameterResolver 提供一系列方法来解析指定类中的字段、方法返回值或方法参数的类型。</p>
<p>Type 接口包含 4 个子接口和 1 个实现类：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211005235708.png style=display:block;width:70% alt=NAME align=center> </div>
<ul>
<li>Class：原始类型</li>
<li>ParameterizedType：泛型类型，如：List<string></li>
<li>TypeVariable：泛型类型变量，如: List<t> 中的 T</li>
<li>GenericArrayType：组成元素是 ParameterizedType 或 TypeVariable 的数组类型，如：List<string>[]、T[]</li>
<li>WildcardType：通配符泛型类型变量，如：List&lt;?> 中的 ?</li>
</ul>
<p>TypeParameterResolver 分别提供 resolveFieldType、resolveReturnType、resolveParamTypes 方法用于解析字段类型、方法返回值类型和方法入参类型，这些方法均调用 resolveType 来获取类型信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 获取类型信息
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param type 根据是否有泛型信息签名选择传入泛型类型或简单类型
</span><span style=color:#8f5902;font-style:italic> * @param srcType 引用字段/方法的类（可能是子类，字段和方法在父类声明）
</span><span style=color:#8f5902;font-style:italic> * @param declaringClass 字段/方法声明的类
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Type</span> <span style=color:#000>resolveType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 泛型类型变量，如：List&lt;T&gt; 中的 T
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 泛型类型，如：List&lt;String&gt;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveParameterizedType</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>GenericArrayType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// TypeVariable/ParameterizedType 数组类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveGenericArrayType</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>GenericArrayType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 原始类型，直接返回
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>resolveTypeVar 用于解析泛型类型变量参数类型，如果字段或方法在当前类中声明，则返回泛型类型的上界或 Object 类型；如果在父类中声明，则递归解析父类；父类也无法解析，则递归解析实现的接口。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Type</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Type</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srcType</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 原始类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srcType</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 泛型类型，如 TestObj&lt;String&gt;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ParameterizedType</span> <span style=color:#000>parameterizedType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 取原始类型TestObj
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>parameterizedType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRawType</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The 2nd arg must be Class or ParameterizedType, but was: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 字段就是在当前引用类中声明的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>bounds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBounds</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 返回泛型类型变量上界，如：T extends String，则返回String
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bounds</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 没有上界返回Object
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// 字段/方法在父类中声明，递归查找父类泛型
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>Type</span> <span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGenericSuperclass</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scanSuperTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// 递归泛型接口
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>superInterfaces</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGenericInterfaces</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>superInterface</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>superInterfaces</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scanSuperTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>superInterface</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过调用 scanSuperTypes 实现递归解析：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Type</span> <span style=color:#000>scanSuperTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Type</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 父类是泛型类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ParameterizedType</span> <span style=color:#000>parentAsType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parentAsClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRawType</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 父类中的泛型类型变量集合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>TypeVariable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parentTypeVars</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentAsClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeParameters</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srcType</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 子类可能对父类泛型变量做过替换，使用替换后的类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parentAsType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>translateParentTypeVars</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ParameterizedType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>srcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>parentAsClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 字段/方法在当前父类中声明
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>parentTypeVars</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>parentTypeVars</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 使用变量对应位置的真正类型（可能已经被替换），如父类 A&lt;T&gt;，子类 B extends A&lt;String&gt;，则返回String
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getActualTypeArguments</span><span style=color:#ce5c00;font-weight:700>()[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 字段/方法声明的类是当前父类的父类，继续递归
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentAsClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parentAsType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superclass</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Class</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 父类是原始类型，继续递归父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resolveTypeVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeVar</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>superclass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>解析方法返回值和方法参数的逻辑大致与解析字段类型相同，MyBatis 源码的TypeParameterResolverTest 类提供了相关的测试用例。</p>
<h2 id=元信息工厂>元信息工厂</h2>
<p>MyBatis 还提供 ReflectorFactory 接口用于实现 Reflector 容器，其默认实现为 DefaultReflectorFactory，其中可以使用 classCacheEnabled 属性来配置是否使用缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultReflectorFactory</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ReflectorFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 是否缓存Reflector类信息
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>classCacheEnabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Reflector缓存容器
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConcurrentMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reflectorMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultReflectorFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isClassCacheEnabled</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setClassCacheEnabled</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classCacheEnabled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取类的Reflector信息
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param type
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Reflector</span> <span style=color:#000>findForClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classCacheEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// synchronized (type) removed see issue #461
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 如果缓存Reflector信息，放入缓存容器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>reflectorMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#204a87;font-weight:700>new</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Reflector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=对象创建工厂>对象创建工厂</h2>
<p>ObjectFactory 接口是 MyBatis 对象创建工厂，其默认实现 DefaultObjectFactory 通过构造器反射创建对象，支持使用无参构造器和有参构造器。</p>
<h2 id=属性工具集>属性工具集</h2>
<p>MyBatis 在映射文件定义 resultMap 支持如下形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;map&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;Order&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;orders[0].items[0].name&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;col1&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;orders[0].items[1].name&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;col2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
	...
<span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
</code></pre></div><p><code>orders[0].items[0].name</code> 这样的表达式是由 PropertyTokenizer 解析的，其构造方法能够对表达式进行解析；同时还实现了 Iterator 接口，能够迭代解析表达式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// orders[0].items[0].name
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// name = orders[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delim</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// children = items[0].name
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullname</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#8f5902;font-style:italic>// orders[0]
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>indexedName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;[&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delim</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// order
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delim</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 是否有children表达式继续迭代
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 分解出的 . 分隔符的 children 表达式可以继续迭代
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PropertyTokenizer</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>PropertyNamer 可以根据 getter/setter 规范解析字段名称；PropertyCopier 则支持对有相同父类的对象，通过反射拷贝字段值。</p>
<h2 id=封装类信息>封装类信息</h2>
<p>MetaClass 类依赖 PropertyTokenizer 和 Reflector 查找表达式是否可以匹配 Java 对象中的字段，以及对应字段是否有 getter/setter 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 验证传入的表达式，是否存在指定的字段
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param name
</span><span style=color:#8f5902;font-style:italic> * @param builder
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>buildProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 映射文件表达式迭代器
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 复杂表达式，如name = items[0].name，则prop.getName() = items
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findPropertyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// items.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 加载内嵌字段类型对应的MetaClass
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>MetaClass</span> <span style=color:#000>metaProp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaClassForProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 迭代子字段
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>metaProp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 非复杂表达式，获取字段名，如：userid-&gt;userId
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findPropertyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=包装字段对象>包装字段对象</h2>
<p>相对于 MetaClass 关注类信息，MetalObject 关注的是对象的信息，除了保存传入的对象本身，还会为对象指定一个 ObjectWrapper 将对象包装起来。ObejctWrapper 体系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211006000300.png style=display:block;width:70% alt=NAME align=center> </div>
<p>ObjectWrapper 的默认实现包括了对 Map、Collection 和普通 JavaBean 的包装。MyBatis 还支持通过 ObjectWrapperFactory 接口对 ObejctWrapper 进行扩展，生成自定义的包装类。MetaObject 对对象的具体操作，就委托给真正的 ObjectWrapper 处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectFactory</span> <span style=color:#000>objectFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ObjectWrapperFactory</span> <span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReflectorFactory</span> <span style=color:#000>reflectorFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>originalObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>objectFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapperFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflectorFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectorFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>// 根据传入object类型不同，指定不同的wrapper
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ObjectWrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ObjectWrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasWrapperFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getWrapperFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CollectionWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BeanWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>例如赋值操作，BeanWrapper 的实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 当前表达式是集合，如：items[0]，就需要获取items集合对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>collection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 在集合的指定索引上赋值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setCollectionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析完成，通过Invoker接口做赋值操作
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setBeanProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>resolveCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 在对象信息中查到此字段对应的集合对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>根据 PropertyTokenizer 对象解析出的当前字段是否存在 index 索引来判断字段是否为集合。如果当前字段对应集合，则需要在对象信息中查到此字段对应的集合对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PropertyTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 如果表达式仍可迭代，递归寻找字段对应的对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MetaObject</span> <span style=color:#000>metaValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaObjectForProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndexedName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metaValue</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SystemMetaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NULL_META_OBJECT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaValue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 字段解析完成
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>objectWrapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果字段是简单类型，BeanWrapper 获取字段对应的对象逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIndex</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 集合类型，递归获取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>collection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getCollectionValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 解析完成，反射读取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBeanProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，仍然是会判断表达式是否迭代完成，如果未解析完字段会不断递归，直至找到对应的类型。前面说到 Reflector 创建过程中将对字段的读取和赋值操作通过 Invoke 接口抽象出来，针对最终获取的字段，此时就会调用 Invoke 接口对字段反射读取对象值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 通过Invoker接口反射执行读取操作
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param prop
</span><span style=color:#8f5902;font-style:italic> * @param object
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>getBeanProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyTokenizer</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Invoker</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getGetInvoker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_ARGUMENTS</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not get property &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>prop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; from &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对象读取完毕再通过 setCollectionValue 方法对集合指定索引进行赋值或通过 setBeanProperty 方法对简单类型反射赋值。MapWrapper 的操作与 BeanWrapper 大致相同，CollectionWrapper 相对更会简单，只支持对原始集合对象进行添加操作。</p>
<h2 id=总结>总结</h2>
<p>MyBatis 根据自身需求，对反射 API 做了近一步封装。其目的是简化反射操作，为对象字段的读取和赋值提供更好的性能。</p>
<ul>
<li>org.apache.ibatis.reflection.Reflector：缓存类的字段名和 getter/setter 方法的元信息，使得反射时有更好的性能。</li>
<li>org.apache.ibatis.reflection.invoker.Invoker：用于抽象设置和读取字段值的操作。</li>
<li>org.apache.ibatis.reflection.TypeParameterResolver：针对 Java-Type 体系的多种实现，解析指定类中的字段、方法返回值或方法参数的类型。</li>
<li>org.apache.ibatis.reflection.ReflectorFactory：反射信息创建工厂抽象接口。</li>
<li>org.apache.ibatis.reflection.DefaultReflectorFactory：默认的反射信息创建工厂。</li>
<li>org.apache.ibatis.reflection.factory.ObjectFactory：MyBatis 对象创建工厂，其默认实现 DefaultObjectFactory 通过构造器反射创建对象。</li>
<li>org.apache.ibatis.reflection.property：property 工具包，针对映射文件表达式进行解析和 Java 对象的反射赋值。</li>
<li>org.apache.ibatis.reflection.MetaClass：依赖 PropertyTokenizer 和 Reflector 查找表达式是否可以匹配 Java 对象中的字段，以及对应字段是否有 getter/setter 方法。</li>
<li>org.apache.ibatis.reflection.MetaObject：对原始对象进行封装，将对象操作委托给 ObjectWrapper 处理。</li>
<li>org.apache.ibatis.reflection.wrapper.ObjectWrapper：对象包装类，封装对象的读取和赋值等操作。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-499db58c0f961451e8ac888520e1c5fa>3 - CH03-基础支持模块</h1>
<h2 id=类型转换>类型转换</h2>
<p>JDBC 规范定义的数据类型与 Java 数据类型并不是完全对应的，所以在 PrepareStatement 为 SQL 语句绑定参数时，需要从 Java 类型转为 JDBC 类型；而从结果集中获取数据时，则需要将 JDBC 类型转为 Java 类型。</p>
<h3 id=类型转换操作>类型转换操作</h3>
<p>MyBatis 中的所有类型转换器都继承自 BaseTypeHandler 抽象类，此类实现了 TypeHandler 接口。接口中定义了 1 个向 PreparedStatement 对象中设置参数的方法和 3 个从结果集中取值的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 为PreparedStatement对象设置参数
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param ps SQL 预编译对象
</span><span style=color:#8f5902;font-style:italic>     * @param i 参数索引
</span><span style=color:#8f5902;font-style:italic>     * @param parameter 参数值
</span><span style=color:#8f5902;font-style:italic>     * @param jdbcType 参数 JDBC类型
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据列名从结果集中取值
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param rs 结果集
</span><span style=color:#8f5902;font-style:italic>     * @param columnName 列名
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>columnName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据索引从结果集中取值
</span><span style=color:#8f5902;font-style:italic>     * @param rs 结果集
</span><span style=color:#8f5902;font-style:italic>     * @param columnIndex 索引
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据索引从存储过程函数中取值
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param cs 存储过程对象
</span><span style=color:#8f5902;font-style:italic>     * @param columnIndex 索引
</span><span style=color:#8f5902;font-style:italic>     * @return
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>T</span> <span style=color:#000>getResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CallableStatement</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=basetypehandler-及其实现>BaseTypeHandler 及其实现</h3>
<p>BaseTypeHandler 实现了 TypeHandler 接口，针对 null 和异常处理做了封装，但是具体逻辑封装成 4 个抽象方法仍交由相应的类型转换器子类实现，以 IntegerTypeHandler 为例，其实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IntegerTypeHandler</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseTypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNonNullParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>getNullableResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>columnName</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>columnName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 如果列值为空值返回控制否则返回原值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasNull</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>getNullableResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasNull</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>getNullableResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CallableStatement</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>columnIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasNull</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其实现主要是调用 JDBC API 设置查询参数或取值，并对 null 等特定情况做特殊处理。</p>
<h3 id=类型转换注册器>类型转换注册器</h3>
<p>TypeHandlerRegistry 是 TypeHandler 的注册类，在其无参构造方法中维护了 JavaType、JdbcType 和 TypeHandler 的关系。其主要使用的容器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * JdbcType - TypeHandler对象
</span><span style=color:#8f5902;font-style:italic>   * 用于将Jdbc类型转为Java类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span>  <span style=color:#000>jdbcTypeHandlerMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EnumMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * JavaType - JdbcType - TypeHandler对象
</span><span style=color:#8f5902;font-style:italic>   * 用于将Java类型转为指定的Jdbc类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>typeHandlerMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * TypeHandler类型 - TypeHandler对象
</span><span style=color:#8f5902;font-style:italic>   * 注册所有的TypeHandler类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>allTypeHandlersMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</code></pre></div><h2 id=别名注册>别名注册</h2>
<h3 id=别名转换器注册>别名转换器注册</h3>
<p>TypeAliasRegistry 提供了多种方式用于为 Java 类型注册别名。包括直接指定别名、注解指定别名、为指定包下类型注册别名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下所有类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下指定类型的别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   * @param superType
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>resolverUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 找出该包下superType所有的子类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IsA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>typeSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClasses</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>typeSet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Ignore inner classes and interfaces (including package-info.java)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// Skip also inner classes. See issue #6
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMemberClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名，默认为简单类名，优先从Alias注解获取
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param type
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 从Alias注解读取别名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Alias</span> <span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliasAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param alias 别名
</span><span style=color:#8f5902;font-style:italic>   * @param value 类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The parameter alias cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// issue #748
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toLowerCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The alias &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is already mapped to the value &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名
</span><span style=color:#8f5902;font-style:italic>   * @param alias 别名
</span><span style=color:#8f5902;font-style:italic>   * @param value 指定类型全名
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error registering type alias &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>所有别名均注册到名为 typeAliases 的容器中。TypeAliasRegistry 的无参构造方法默认为一些常用类型注册了别名，如 Integer、String、byte[] 等。</p>
<h2 id=日志配置>日志配置</h2>
<p>MyBatis 支持与多种日志工具集成，包括 Slf4j、log4j、log4j2、commons-logging 等。这些第三方工具类对应日志的实现各有不同，MyBatis 通过适配器模式抽象了这些第三方工具的集成过程，按照一定的优先级选择具体的日志工具，并将真正的日志实现委托给选择的日志工具。</p>
<h3 id=日志适配接口>日志适配接口</h3>
<p>Log 接口是 MyBatis 的日志适配接口，支持 trace、debug、warn、error 四种级别。</p>
<h3 id=日志工厂>日志工厂</h3>
<p>LogFactory 负责对第三方日志工具进行适配，在类加载时会通过静态代码块按顺序选择合适的日志实现。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 按顺序加载日志实现，如果有某个第三方日志实现可以成功加载，则不继续加载其它实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useSlf4jLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useCommonsLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useLog4J2Logging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useLog4JLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useJdkLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>useNoLogging</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 初始化 logConstructor
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param runnable
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>tryImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logConstructor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 同步执行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 配置第三方日志实现适配器
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param implClass
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setImplementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>implClass</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>candidate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>implClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>Log</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Logging initialized using &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>implClass</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; adapter.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>logConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>candidate</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LogException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error setting Log implementation.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>tryImplementation 按顺序加载第三方日志工具的适配实现，如 Slf4j 的适配器 Slf4jImpl：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Slf4jImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Logger</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>LocationAwareLogger</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// check for slf4j &gt;= 1.6 method signature
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;log&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Marker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Slf4jLocationAwareLoggerImpl</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>LocationAwareLogger</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SecurityException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>NoSuchMethodException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// fail-back to Slf4jLoggerImpl
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// Logger is not LocationAwareLogger or slf4j version &lt; 1.6
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Slf4jLoggerImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果 Slf4jImpl 能成功执行构造方法，则 LogFactory 的 logConstructor 被成功赋值，MyBatis 就找到了合适的日志实现，可以通过 getLog 方法获取 Log 对象。</p>
<h3 id=jdbc-日志代理>JDBC 日志代理</h3>
<p>org.apache.ibatis.logging.jdbc 包提供了 Connection、PrepareStatement、Statement、ResultSet 类中的相关方法执行的日志记录代理。BaseJdbcLogger 在创建时整理了 PreparedStatement 执行的相关方法名，并提供容器保存列值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * PreparedStatement 接口中的 set* 方法名称集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>SET_METHODS</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * PreparedStatement 接口中的 部分执行方法
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>EXECUTE_METHODS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 列名-列值
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>columnMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 列名集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>columnNames</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 列值集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>columnValues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SET_METHODS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredMethods</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collectors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toSet</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;execute&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executeUpdate&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executeQuery&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>EXECUTE_METHODS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;addBatch&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setColumn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>columnMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>columnNames</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>columnValues</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ConnectionLogger、PreparedStatementLogger、StatementLogger、ResultSetLogger 都继承自 BaseJdbcLogger，并实现了 InvocationHandler 接口，在运行时通过 JDK 动态代理实现代理类，针对相关方法执行打印日志。如下是 ConnectionLogger 对 InvocationHandler 接口的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;prepareStatement&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; Preparing: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>removeBreakingWhitespace</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>PreparedStatement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 执行创建PreparedStatement方法，使用PreparedStatementLogger代理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PreparedStatementLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;prepareCall&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; Preparing: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>removeBreakingWhitespace</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>PreparedStatement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PreparedStatementLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;createStatement&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementLogger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果执行 prepareStatement 方法创建 PrepareStatement 对象，则会使用动态代理创建 PreparedStatementLogger 对象增强原有对象。在 PreparedStatementLogger 的代理逻辑中，如果执行的是 executeQuery 或 getResultSet 方法，其返回值 ResultSet 也会包装为 ResultSetLogger 作为代理，其代理逻辑为如果执行 ResultSet 的 next 方法，会打印结果集的行。</p>
<h2 id=资源加载>资源加载</h2>
<h3 id=resources-与-classloaderwrapper>Resources 与 ClassLoaderWrapper</h3>
<p>MyBatis 提供工具类 Resources 用于工具加载，其底层是通过 ClassLoaderWrapper 实现的。ClassLoaderWrapper 组合了一系列的 ClassLoader：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getClassLoaders</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLoader</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>[]{</span>
            <span style=color:#8f5902;font-style:italic>// 指定 ClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#8f5902;font-style:italic>// 默认 ClassLoader，默认为 null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>defaultClassLoader</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#8f5902;font-style:italic>// 当前线程对应的 ClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getContextClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#8f5902;font-style:italic>// 当前类对应的 ClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#8f5902;font-style:italic>// 默认为 SystemClassLoader
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>systemClassLoader</span><span style=color:#ce5c00;font-weight:700>};</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当加载资源时会按组合的 ClassLoader 顺序依次尝试加载资源，例如 classForName 方法的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 按组合顺序依次加载
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>classLoader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 类加载
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// we&#39;ll ignore this until all classloaders fail to locate the class
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassNotFoundException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cannot find class: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=加载指定包下的类>加载指定包下的类</h3>
<p>ResolverUtil 的 find 方法用于按条件加载指定包下的类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 包名.替换为/
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>String</span> <span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getPackagePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 虚拟文件系统加载文件路径
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>VFS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.class&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果指定class文件符合条件，加入容器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>addIfMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ioe</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not read package: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ioe</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ResolverUtil 还提供了一个内部接口 Test 用于判断指定类型是否满足条件，在 ResolverUtil 有两个默认实现：IsA 用于判断是否为指定类型的子类；AnnotatedWith 用于判断类上是否有指定注解。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * A Test that checks to see if each class is assignable to the provided class. Note
</span><span style=color:#8f5902;font-style:italic>   * that this test will match the parent type itself if it is presented for matching.
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * 判断是否为子类
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IsA</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/** Constructs an IsA test using the supplied Class as the parent class/interface. */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>IsA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parentType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/** Returns true if type is assignable to the parent type supplied in the constructor. */</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * A Test that checks to see if each class is annotated with a specific annotation. If it
</span><span style=color:#8f5902;font-style:italic>   * is, then the test returns true, otherwise false.
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * 判断类上是否有指定注解
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnnotatedWith</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/** Constructs an AnnotatedWith test for the specified annotation type. */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AnnotatedWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Annotation</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>annotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/** Returns true if the type is annotated with the class provided to the constructor. */</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotationPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>annotation</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果要加载的类复合条件，则将加载的类对象加入容器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addIfMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>fqn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>externalName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fqn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fqn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Checking to see if class &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>externalName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; matches criteria [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>test</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 加载类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>externalName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 符合条件，加入容器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not examine class &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>fqn</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; due to a &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
        <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; with message: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=数据源实现>数据源实现</h2>
<p>MyBatis 提供了自己的数据源实现，分别为非池化数据源 UnpooledDataSource 和池化数据源 PooledDataSource。两个数据源都实现了 javax.sql.DataSource 接口并分别由 UnpooledDataSourceFactory 和 PooledDataSourceFactory 工厂类创建。两个工厂类又都实现了 DataSourceFactory 接口。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211007160038.png style=display:block;width:70% alt=NAME align=center> </div>
<h3 id=datasourcefactory-实现>DataSourceFactory 实现</h3>
<p>UnpooledDataSourceFactory 实现了 DataSourceFactory 接口的 setProperties 和 getDataSource 方法，分别用于在创建数据源工厂后配置数据源属性和获取数据源，PooledDataSourceFactory 继承了其实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UnpooledDataSourceFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnpooledDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 创建数据源工厂后配置数据源属性
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param props
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Properties</span> <span style=color:#000>driverProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 数据源对象信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MetaObject</span> <span style=color:#000>metaDataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SystemMetaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DRIVER_PROPERTY_PREFIX</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 数据源驱动相关属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>driverProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DRIVER_PROPERTY_PREFIX_LENGTH</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSetter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 属性在数据源类中有相应的set方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 转换类型
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>convertedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>convertValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 反射赋值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>convertedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataSourceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown DataSource property: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driverProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>metaDataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;driverProperties&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>driverProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取数据源
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>getDataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=非池化数据源>非池化数据源</h3>
<p>UnpooledDataSource 在静态语句块中从数据源驱动管理器 DriverManager 获取所有已注册驱动并放入本地容器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从数据库驱动类中获取所有驱动
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Enumeration</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDrivers</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreElements</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Driver</span> <span style=color:#000>driver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextElement</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>registeredDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此数据源获取连接的实现为调用 doGetConnection 方法，每次获取连接时先校验当前驱动是否注册，如果已注册则直接创建新连接，并配置自动提交属性和默认事务隔离级别：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取连接
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param properties
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Connection</span> <span style=color:#000>doGetConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 校验当前驱动是否注册，如果未注册，加载驱动并注册
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>initializeDriver</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 获取数据库连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 配置自动提交和默认事务隔离级别属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>configureConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 校验当前驱动是否注册
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initializeDriver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>registeredDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 当前驱动还未注册
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>driverType</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 加载驱动类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driverClassLoader</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>driverType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>driverClassLoader</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>driverType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// DriverManager requires the driver to be loaded via the system ClassLoader.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// http://www.kfu.com/~nsayer/Java/dyn-jdbc.html
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Driver</span> <span style=color:#000>driverInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>driverType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 注册驱动
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerDriver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DriverProxy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driverInstance</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>registeredDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>driverInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error setting driver on UnpooledDataSource. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 配置自动提交和默认事务隔离级别属性
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param conn
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>configureConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAutoCommit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultTransactionIsolationLevel</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTransactionIsolation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultTransactionIsolationLevel</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=池化数据源>池化数据源</h3>
<p>数据库连接的创建是十分耗时的，在高并发环境下，频繁地创建和关闭连接会为系统带来很大的开销。而使用连接池实现对数据库连接的重用可以显著提高性能，避免反复创建连接。MyBatis 实现的连接池包含了维护连接队列、创建和保存连接、归还连接等功能。</p>
<h4 id=池化连接>池化连接</h4>
<p>PooledConnection 是 MyBatis 的池化连接实现。其构造方法中传入了驱动管理器创建的真正连接，并通过 JDK 动态代理创建了连接的代理对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PooledDataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 真正的数据库连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>realConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 数据源对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 连接创建时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createdTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 连接上次使用时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastUsedTimestamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 数据源有效标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 创建连接代理
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proxyConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>IFACES</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>连接代理的逻辑如下，如果执行 close 方法，并不会真正的关闭连接，而是当作空闲连接交给数据源处理，根据连接池的状态选择将连接放入空闲队列或关闭连接；如果执行其它方法，则会判断当前连接是否有效，如果是无效连接会抛出异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>methodName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CLOSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>CLOSE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 调用连接关闭方法代理逻辑：处理空闲连接，放入空闲队列或关闭
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pushConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// issue #579 toString() should never fail
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// throw an SQLException instead of a Runtime
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 执行其它方法，验证连接是否有效，如果是无效连接，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>realConnection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=连接池状态>连接池状态</h4>
<p>PoolState 维护了数据库连接池状态。其内部维护了两个容器，分别为空闲连接集合和活跃连接集合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 空闲连接集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>idleConnections</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 活跃连接集合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>activeConnections</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</code></pre></div><h4 id=获取连接>获取连接</h4>
<p>池化数据源 PooledDataSource 是依赖 UnpooledDataSource 实现的。其获取连接的方式是调用 popConnection 方法。在获取连接池同步锁后按照以下顺序尝试获取可用连接：</p>
<ul>
<li>从空闲队列获取连接</li>
<li>活跃连接池未满，创建新连接</li>
<li>检查最早的活跃连接是否超时</li>
<li>等待释放连接</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PooledConnection</span> <span style=color:#000>popConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 等待连接标志
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>countedWait</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#8f5902;font-style:italic>// 待获取的池化连接
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>localBadConnectionCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 循环获取连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取连接池的同步锁
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Pool has available connection 连接池中有空闲连接
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Checked out connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; from pool.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Pool does not have available connection 连接池无可用连接
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>poolMaximumActiveConnections</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// Can create new connection 活跃连接数小于设定的最大连接数，创建新的连接（从驱动管理器创建新的连接）
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Created connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// Cannot create new connection 活跃连接数到达最大连接数
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>oldestActiveConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 查询最早入队的活跃连接使用时间（即使用时间最长的活跃连接使用时间）
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>longestCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCheckoutTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>longestCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>poolMaximumCheckoutTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Can claim overdue connection 超出活跃连接最大使用时间
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>claimedOverdueConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
            <span style=color:#8f5902;font-style:italic>// 超时连接累计使用时长
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTimeOfOverdueConnections</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>longestCheckoutTime</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>longestCheckoutTime</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 活跃连接队列移除当前连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 创建的连接未自动提交，执行回滚
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
              <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>                   Just log a message for debug and continue to execute the following
</span><span style=color:#8f5902;font-style:italic>                   statement like nothing happened.
</span><span style=color:#8f5902;font-style:italic>                   Wrap the bad connection with a new PooledConnection, this will help
</span><span style=color:#8f5902;font-style:italic>                   to not interrupt current executing thread and give current thread a
</span><span style=color:#8f5902;font-style:italic>                   chance to join the next competition for another valid/good database
</span><span style=color:#8f5902;font-style:italic>                   connection. At the end of this loop, bad {@link @conn} will be set as null.
</span><span style=color:#8f5902;font-style:italic>                 */</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bad connection. Could not roll back&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 包装新的池化连接
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 设置原连接无效
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>oldestActiveConnection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Claimed overdue connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Must wait
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// 存活连接有效
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>countedWait</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hadToWaitCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
                <span style=color:#000>countedWait</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Waiting as long as &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>poolTimeToWait</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; milliseconds for connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
              <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
              <span style=color:#8f5902;font-style:italic>// 释放锁等待连接，{@link PooledDataSource#pushConnection} 如果有连接空闲，会唤醒等待
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolTimeToWait</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#8f5902;font-style:italic>// 记录等待时长
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedWaitTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ping to server and check the connection is valid or not
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isValid</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 连接有效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 非自动提交的连接，回滚上次任务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assembleConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#8f5902;font-style:italic>// 设置连接新的使用时间
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCheckoutTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#8f5902;font-style:italic>// 添加到活跃连接集合队尾
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 连接请求次数+1
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requestCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
          <span style=color:#8f5902;font-style:italic>// 请求连接花费的时间
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedRequestTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 未获取到连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A bad connection (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) was returned from the pool, getting another connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 因为没有空闲连接导致获取连接失败次数+1
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>badConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
          <span style=color:#8f5902;font-style:italic>// 本次请求获取连接失败数+1
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>localBadConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
          <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>localBadConnectionCount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolMaximumIdleConnections</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>poolMaximumLocalBadConnectionTolerance</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 超出获取连接失败的可容忍次数，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Could not get a good connection to the database.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Could not get a good connection to the database.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果暂时获取不到可用连接，则当前线程进入等待，等待新的空闲连接产生唤醒等待或等待超时后重新尝试获取连接。当尝试次数到达指定上限，会抛出异常跳出等待。</p>
<h4 id=判断连接有效性>判断连接有效性</h4>
<p>如果可以从连接池中获取连接，会调用 PooledConnection#isValid 方法判断连接是否有效，其逻辑为 PooledConnection 对象自身维护的标志有效且连接存活。判断连接存活的实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>pingConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 连接是否关闭
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isClosed</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is BAD: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolPingEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用语句检测连接是否可用开关开启
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolPingConnectionsNotUsedFor</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeElapsedSinceLastUse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>poolPingConnectionsNotUsedFor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 距上次连接使用经历时长超过设置的阈值
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Testing connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; ...&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 验证连接是否可用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Connection</span> <span style=color:#000>realConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStatement</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>poolPingQuery</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// 未自动提交执行回滚
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is GOOD!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Execution of ping query &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>poolPingQuery</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; failed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// 抛出异常，连接不可用，关闭连接
</span><span style=color:#8f5902;font-style:italic></span>              <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>//ignore
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is BAD: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>默认调用 Connection#isClosed 方法判断连接是否存活，如果连接存活，则可以选择执行 SQL 语句来进一步判断连接的有效性。是否进一步验证、验证使用的 SQL 语句、验证的时间条件，都是可配置的。</p>
<h4 id=处理空闲连接>处理空闲连接</h4>
<p>在池化连接的代理连接执行关闭操作时，会转为对空闲连接的处理，其实现逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pushConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取连接池状态同步锁，活跃连接队列移除当前连接
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isValid</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 连接有效
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>poolMaximumIdleConnections</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>expectedConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 空闲连接数小于最大空闲连接数，累计连接使用时长
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCheckoutTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未自动提交连接回滚上次事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 包装成新的代理连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>newConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PooledConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 将新连接放入空闲队列
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 设置相关统计时间戳
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCreatedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLastUsedTimestamp</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#8f5902;font-style:italic>// 老连接设置失效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Returned connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; to pool.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 唤醒等待连接的线程，通知有新连接可以使用
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 空闲连接数达到最大空闲连接数
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulatedCheckoutTime</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCheckoutTime</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未自动提交连接回滚上次事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 关闭多余的连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Closed connection &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 连接设置失效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A bad connection (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealHashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) attempted to return to the pool, discarding connection.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 连接无效次数+1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>badConnectionCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果当前空闲连接数小于最大空闲连接数，则将空闲连接放入空闲队列，否则关闭连接。</p>
<h4 id=处理配置变更>处理配置变更</h4>
<p>在相关配置变更后，MyBatis 会调用 forceCloseAll 关闭连接池中所有存活的连接：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forceCloseAll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取连接池状态同步锁
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>expectedConnectionTypeCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>assembleConnectionTypeCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrl</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPassword</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 移除活跃连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>activeConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 原连接置为无效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>

          <span style=color:#000>Connection</span> <span style=color:#000>realConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未提交连接回滚当前事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 关闭连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 移除空闲连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>PooledConnection</span> <span style=color:#000>conn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>idleConnections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 原连接置为无效
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invalidate</span><span style=color:#ce5c00;font-weight:700>();</span>

          <span style=color:#000>Connection</span> <span style=color:#000>realConn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRealConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 未提交连接回滚当前事务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// 关闭连接
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>realConn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;PooledDataSource forcefully closed/removed all connections.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=缓存实现>缓存实现</h2>
<p>Cache 是 MyBatis 的缓存抽象接口，其要求实现如下方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Cache</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 缓存对象 id
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return The identifier of this cache
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>String</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 设置缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param key Can be any object but usually it is a {@link CacheKey}
</span><span style=color:#8f5902;font-style:italic>     * @param value The result of a select.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 获取缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param key The key
</span><span style=color:#8f5902;font-style:italic>     * @return The object stored in the cache.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 移除缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param key The key
</span><span style=color:#8f5902;font-style:italic>     * @return Not used
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>Object</span> <span style=color:#000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 清空缓存
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * Clears this cache instance.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Optional. This method is not called by the core.
</span><span style=color:#8f5902;font-style:italic>     * 获取缓存项数量
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return The number of elements stored in the cache (not its capacity).
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getSize</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 获取读写锁
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return A ReadWriteLock
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>ReadWriteLock</span> <span style=color:#000>getReadWriteLock</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=基础实现>基础实现</h3>
<p>PerpetualCache 类是基础实现类，核心是基于 HashMap 作为缓存维护容器。在此基础上，MyBatis 实现了多种缓存装饰器，用于满足不同的需求。</p>
<h3 id=缓存装饰器>缓存装饰器</h3>
<h4 id=同步操作>同步操作</h4>
<p>SynchronizedCache 针对缓存操作方法加上了 synchronized 关键字用于进行同步操作。</p>
<h4 id=阻塞操作>阻塞操作</h4>
<p>BlockingCache 在执行获取缓存操作时对 key 加锁，直到写缓存后释放锁，保证了相同 key 同一时刻只有一个线程执行数据库操作，其它线程在缓存层阻塞。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 写缓存完成后释放锁
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>acquireLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 缓存不为空则释放锁，否则继续持有锁，在进行数据库操作后写缓存释放锁
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 删除指定 key 对应的缓存，并释放锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key The key
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// despite of its name, this method is called only to release locks
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取已有的锁或创建新锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>getLockForKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>locks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据 key 获取锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>acquireLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Lock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getLockForKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>acquired</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>acquired</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Couldn&#39;t get a lock in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; for the key &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>  <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; at the cache &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Got interrupted while trying to acquire lock for key &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 释放锁
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>releaseLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>locks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isHeldByCurrentThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=日志记录>日志记录</h4>
<p>LoggingCache 是缓存日志装饰器。查询缓存时会记录查询日志并统计命中率。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 查询缓存时记录查询日志并统计命中率
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param key The key
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 查询数+1
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>requests</span><span style=color:#ce5c00;font-weight:700>++;</span>
  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 命中数+1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>hits</span><span style=color:#ce5c00;font-weight:700>++;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cache Hit Ratio [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getHitRatio</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=定时清理>定时清理</h4>
<p>ScheduledCache 是缓存定时清理装饰器。在执行缓存相关操作时会根据设置的时间间隔判断是否需要清除全部的缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 操作缓存时判断是否需要清除所有缓存。
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>clearWhenStale</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>lastClear</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clearInterval</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=序列化与反序列化>序列化与反序列化</h4>
<p>SerializedCache 是缓存序列化装饰器，其在写入时会将值序列化成对象流，并在读取时进行反序列化。</p>
<h4 id=事务操作>事务操作</h4>
<p>TransactionalCache 是事务缓存装饰器。在事务提交后再将缓存写入，如果发生回滚则不写入。</p>
<h4 id=先进先出>先进先出</h4>
<p>FifoCache 是先进先出缓存装饰器。其按写缓存顺序维护了一个缓存 key 队列，如果缓存项超出指定大小，则删除最先入队的缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 按写缓存顺序维护缓存 key 队列，缓存项超出指定大小，删除最先入队的缓存
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param key
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cycleKeyList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>keyList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>oldestKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeFirst</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldestKey</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=最近最久未使用>最近最久未使用</h4>
<p>LruCache 是缓存最近最久未使用装饰器。其基于 LinkedHashMap 维护了 key 的 LRU 顺序。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// LinkedHashMap 在执行 get 方法后会将对应的 entry 移到队尾来维护使用顺序
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>keyMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>75F</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4267176411845948333L</span><span style=color:#ce5c00;font-weight:700>;</span>

      <span style=color:#5c35cc;font-weight:700>@Override</span>
      <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removeEldestEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>eldest</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tooBig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tooBig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 超出缓存项数量限制，获取最近最久未使用的key
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>eldestKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>eldest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tooBig</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>};</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 更新缓存后检查是否需要删除最近最久未使用的缓存项
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>cycleKeyList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cycleKeyList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>keyMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eldestKey</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eldestKey</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>eldestKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=软引用缓存>软引用缓存</h4>
<p>SoftCache 是缓存软引用装饰器，其使用了软引用 + 强引用队列的方式维护缓存。在写缓存操作中，写入的数据其实时缓存项的软引用包装对象，在 Full GC 时，如果没有一个强引用指向被包装的缓存项或缓存值，并且系统内存不足，缓存项就会被 GC，被回收对象进入指定的引用队列。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 引用队列，用于记录已经被 GC 的 SoftEntry 对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReferenceQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queueOfGarbageCollectedEntries</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 写入缓存。
</span><span style=color:#8f5902;font-style:italic>   * 不直接写缓存的值，而是写入缓存项对应的软引用
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>removeGarbageCollectedItems</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 在 Full GC 时，如果没有一个强引用指向被包装的缓存项或缓存值，并且系统内存不足，缓存项就会被回收，被回收对象进入指定的引用队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SoftEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>queueOfGarbageCollectedEntries</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询已被 GC 的软引用，删除对应的缓存项
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeGarbageCollectedItems</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SoftEntry</span> <span style=color:#000>sv</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SoftEntry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>queueOfGarbageCollectedEntries</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 封装软引用对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SoftEntry</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>SoftEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReferenceQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>garbageCollectionQueue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 声明 value 为软引用对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>garbageCollectionQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// key 为强引用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在读取缓存时，如果软引用被回收，则删除对应的缓存项；否则将缓存项放入一个强引用队列中，该队列会将最新读取的缓存项放入队首，使得真正的缓存项有了强引用指向，其软引用包装就不会被垃圾回收。队列有数量限制，当超出限制时会删除队尾的缓存项。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取缓存。
</span><span style=color:#8f5902;font-style:italic>   * 如果软引用被回收则删除对应的缓存项，如果未回收则加入到有数量限制的 LRU 队列中
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param key The key
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// assumed delegate cache is totally managed by this cache
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>softReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>softReference</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>softReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 软引用已经被回收，删除对应的缓存项
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果未被回收，增将软引用加入到 LRU 队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// See #586 (and #335) modifications need more than a read lock
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 将对应的软引用
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>numberOfHardLinks</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 超出数量限制，删除最近最久未使用的软引用对象
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>hardLinksToAvoidGarbageCollection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeLast</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=弱引用缓存>弱引用缓存</h4>
<p>WeakCache 是缓存弱引用装饰器，使用弱引用 + 强引用队列的方式维护缓存，其实现方式与 SoftCache 是一致的。</p>
<h2 id=binding-模块>Binding 模块</h2>
<p>为了避免因拼写等错误导致在运行期才发现执行方法找不到对应的 SQL 语句，MyBatis 使用 Binding 模块在启动时对执行方法校验，如果找不到对应的语句，则会抛出 BindingException。</p>
<p>MyBatis 一般将执行数据库操作的方法所在的接口称为 Mapper，MapperRegistry 用来注册 Mapper 接口类型与其代理创建工厂的映射，其提供 addMapper 和 addMappers 接口用于注册。Mapper 接口代理工厂是通过 MapperProxyFactory 创建，创建过程依赖 MapperProxy 提供的 JDK 动态代理：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapperProxy</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapperProxy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>mapperInterface</span> <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>mapperProxy</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 使用 Mapper 代理封装 SqlSession 相关操作
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param sqlSession
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MapperProxy</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapperProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperProxy</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodCache</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperProxy</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>MapperProxy 的代理逻辑如下，在 Mapper 接口中的方法真正执行时，会为指定的非 default 方法创建方法信息和 SQL 执行信息缓存：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Object中的方法，直接执行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDefaultMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 当前方法是接口中的非abstract、非static的public方法，即高版本JDK中的default方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invokeDefaultMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 缓存 Mapper接口 对应的方法和 SQL 执行信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MapperMethod</span> <span style=color:#000>mapperMethod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedMapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 执行 SQL
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mapperMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存 Mapper接口 对应的方法和 SQL 执行信息
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param method
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MapperMethod</span> <span style=color:#000>cachedMapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>methodCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>()));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>缓存通过 MapperMethod 类来保存，其构造方法创建了 SqlCommand 和 MethodSignature 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MapperMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Configuration</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// SQL 执行信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlCommand</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取方法参数和返回值相关信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodSignature</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>SqlCommand 会根据接口和方法名找到对应的 SQL statement 对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MappedStatement</span> <span style=color:#000>resolveMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// statementId 为接口名与方法名组合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>statementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 配置中存在此 statementId，返回对应的 statement
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementId</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 此方法就是在对应接口中声明的
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 递归查找父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>superInterface</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInterfaces</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superInterface</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superInterface</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                    <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>而 MethodSignature 会获取方法相关信息，如返回值类型、是否返回 void、是否返回多值等。对于 Param 注解的解析也会保存下来（MyBatis 使用 Param 注解重置参数名）。</p>
<h2 id=总结>总结</h2>
<p>MyBatis 提供了一系列工具和实现，用于为整个框架提供基础支持。</p>
<ul>
<li>类型转换
<ul>
<li>org.apache.ibatis.type.TypeHandler：类型转换器接口，抽象 JDBC 类型和 Java 类型互转逻辑。</li>
<li>org.apache.ibatis.type.BaseTypeHandler：TypeHandler 的抽象实现，针对 null 和异常处理做了封装，具体逻辑仍由相应的类型转换器实现。</li>
<li>org.apache.ibatis.type.TypeHandlerRegistry：TypeHandler 注册类，维护 JavaType、JdbcType 和 TypeHandler 关系。</li>
</ul>
</li>
<li>别名注册
<ul>
<li>org.apache.ibatis.type.TypeAliasRegistry：别名注册类。注册常用类型的别名，并提供多种注册别名的方式。</li>
</ul>
</li>
<li>日志配置
<ul>
<li>org.apache.ibatis.logging.Log：MyBatis 日志适配接口，支持 trace、debug、warn、error 四种级别。</li>
<li>org.apache.ibatis.logging.LogFactory：MyBatis 日志工厂，负责适配第三方日志实现。</li>
<li>org.apache.ibatis.logging.jdbc：SQL 执行日志工具包，针对执行 Connection、PrepareStatement、Statement、ResultSet 类中的相关方法，提供日志记录工具。</li>
</ul>
</li>
<li>资源加载
<ul>
<li>org.apache.ibatis.io.Resources：MyBatis 封装的资源加载工具类。</li>
<li>org.apache.ibatis.io.ClassLoaderWrapper：资源加载底层实现。组合多种 ClassLoader 按顺序尝试加载资源。</li>
<li>org.apache.ibatis.io.ResolverUtil：按条件加载指定包下的类。</li>
</ul>
</li>
<li>数据源实现
<ul>
<li>org.apache.ibatis.datasource.DataSourceFactory：数据源创建工厂接口。</li>
<li>org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory：非池化数据源工厂。</li>
<li>org.apache.ibatis.datasource.pooled.PooledDataSourceFactory：池化数据源工厂。</li>
<li>org.apache.ibatis.datasource.unpooled.UnpooledDataSource：非池化数据源。</li>
<li>org.apache.ibatis.datasource.pooled.PooledDataSource：池化数据源。</li>
<li>org.apache.ibatis.datasource.pooled.PooledConnection：池化连接。</li>
<li>org.apache.ibatis.datasource.pooled.PoolState：连接池状态。</li>
</ul>
</li>
<li>事务实现
<ul>
<li>org.apache.ibatis.transaction.Transaction：事务抽象接口</li>
<li>org.apache.ibatis.session.TransactionIsolationLevel：事务隔离级别。</li>
<li>org.apache.ibatis.transaction.TransactionFactory：事务创建工厂抽象接口。</li>
<li>org.apache.ibatis.transaction.jdbc.JdbcTransaction：封装 JDBC 数据库事务操作。</li>
<li>org.apache.ibatis.transaction.managed.ManagedTransaction：数据库事务操作依赖外部管理。</li>
</ul>
</li>
<li>缓存实现
<ul>
<li>org.apache.ibatis.cache.Cache：缓存抽象接口。</li>
<li>org.apache.ibatis.cache.impl.PerpetualCache：使用 HashMap 作为缓存实现容器的 Cache 基本实现。</li>
<li>org.apache.ibatis.cache.decorators.BlockingCache：缓存阻塞装饰器。保证相同 key 同一时刻只有一个线程执行数据库操作，其它线程在缓存层阻塞。</li>
<li>org.apache.ibatis.cache.decorators.FifoCache：缓存先进先出装饰器。按写缓存顺序维护缓存 key 队列，缓存项超出指定大小，删除最先入队的缓存。</li>
<li>org.apache.ibatis.cache.decorators.LruCache：缓存最近最久未使用装饰器。基于 LinkedHashMap 维护了 key 的 LRU 顺序。</li>
<li>org.apache.ibatis.cache.decorators.LoggingCache：缓存日志装饰器。查询缓存时记录查询日志并统计命中率。</li>
<li>org.apache.ibatis.cache.decorators.ScheduledCache：缓存定时清理装饰器。</li>
<li>org.apache.ibatis.cache.decorators.SerializedCache：缓存序列化装饰器。</li>
<li>org.apache.ibatis.cache.decorators.SynchronizedCache：缓存同步装饰器。在缓存操作方法上使用 synchronized 关键字同步。</li>
<li>org.apache.ibatis.cache.decorators.TransactionalCache：事务缓存装饰器。在事务提交后再将缓存写入，如果发生回滚则不写入。</li>
<li>org.apache.ibatis.cache.decorators.SoftCache：缓存软引用装饰器。使用软引用 + 强引用队列的方式维护缓存。</li>
<li>org.apache.ibatis.cache.decorators.WeakCache：缓存弱引用装饰器。使用弱引用 + 强引用队列的方式维护缓存。</li>
</ul>
</li>
<li>Binding
<ul>
<li>org.apache.ibatis.binding.MapperRegistry： Mapper 接口注册类，管理 Mapper 接口类型和其代理创建工厂的映射。</li>
<li>org.apache.ibatis.binding.MapperProxyFactory：Mapper 接口代理创建工厂。</li>
<li>org.apache.ibatis.binding.MapperProxy：Mapper 接口方法代理逻辑，封装 SqlSession 相关操作。</li>
<li>org.apache.ibatis.binding.MapperMethod：封装 Mapper 接口对应的方法和 SQL 执行信息。</li>
</ul>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5b7e738c6d50dab8aea897b0c9b16a6f>4 - CH04-运行配置解析</h1>
<p>在 Spring 与 MyBatis 的集成中，通常需要声明一个 sqlSessionFactory 用于初始化 MyBatis：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#8f5902;font-style:italic>&lt;!-- 注册 sqlSessionFactory --&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;sqlSessionFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.mybatis.spring.SqlSessionFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;configLocation&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;classpath:config/mybatis-config.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;typeAliasesPackage&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;com.wch.base.domain&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mapperLocations&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;classpath:mapper/*.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</code></pre></div><p>在 bean 初始化的时候会调用 SqlSessionFactoryBean 的 afterPropertiesSet 方法，在此方法中 MyBatis 使用 XMLConfigBuilder 对配置进行解析。</p>
<h2 id=basebuilder-体系>BaseBuilder 体系</h2>
<p>XMLConfigBuilder 是 XML 配置解析的入口，继承自 BaseBuilder，其为 MyBatis 初始化提供了一系列工具方法，如别名转换、类型转换、类加载等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211007161811.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=全局配置对象>全局配置对象</h2>
<p>XMLConfigBuilder 在构造方法中创建了 Configuration 对象，这个对象中用于保存 MyBatis 相关的全部配置，包括运行行为、类型容器、别名容器、注册 Mapper、注册 statement 等。通过 XMLConfigBuilder 的 parse 方法可以看出，配置解析的目的就是为了获取 Configuration 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XPathParser</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建全局配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SQL Mapper Configuration&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置自定义配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 指定环境
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 包装配置 InputStream 的 XPathParser
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Configuration</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parsed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Each XMLConfigBuilder can only be used once.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>parsed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 读取 configuration 元素并解析
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/configuration&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析配置文件>解析配置文件</h2>
<p>配置解析分为多步，详情可参考 XML 配置。MyBatis 源码内置 mybatis-config.xsd 文件用于定义配置文件书写规则。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//issue #117 read properties first
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 解析 properties 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>propertiesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;properties&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 加载 settings 配置并验证是否有效
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>settings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;settings&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 配置自定义虚拟文件系统实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadCustomVfs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 配置自定义日志实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>loadCustomLogImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 typeAliases 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeAliasesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeAliases&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 plugins 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>pluginElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;plugins&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 objectFactory 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>objectFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 objectWrapperFactory 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>objectWrapperFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;objectWrapperFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 reflectorFactory 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>reflectorFactoryElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;reflectorFactory&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 将 settings 配置设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>settingsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// read it after objectFactory and objectWrapperFactory issue #631
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 解析 environments 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>environmentsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;environments&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 databaseIdProvider 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>databaseIdProviderElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseIdProvider&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 typeHandlers 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeHandlerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandlers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 mappers 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>mapperElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mappers&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error parsing SQL Mapper Configuration. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-properties-元素>解析 properties 元素</h3>
<p>properties 元素用于将自定义配置传递给 MyBatis，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;properties</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;com/wch/mybatis/config.properties&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;username&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;wch&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;password&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;Noop&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/properties&gt;</span>
</code></pre></div><p>其加载逻辑为将不同配置转为 Properties 对象，并设置到全局配置中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>propertiesElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取子元素属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>defaults</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 读取 resource 属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 读取 url 属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 不可均为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 加载指定路径文件，转为 properties
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrlAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 添加创建配置的附加属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>vars</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vars</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vars</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaults</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-settings-元素>解析 settings 元素</h3>
<p>setteings 元素中的各子元素定义了 MyBatis 的运行时行为，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;settings&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 缓存开关 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;cacheEnabled&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 懒加载开关 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;lazyLoadingEnabled&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 允许自动生成主键 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;useGeneratedKeys&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 驼峰命名开关 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;setting</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;mapUnderscoreToCamelCase&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    ...
  <span style=color:#204a87;font-weight:700>&lt;/settings&gt;</span>
</code></pre></div><p>这些配置在 Configuration 类中都有对应的 setter 方法。settings 元素的解析方法对配置进行了验证：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Properties</span> <span style=color:#000>settingsAsProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 获取子元素配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// Check that all settings are known to the configuration class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 获取 Configuration 类的相关信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MetaClass</span> <span style=color:#000>metaConfig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MetaClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localReflectorFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>metaConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasSetter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 验证对应的 setter 方法存在，保证配置是有效的
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The setting &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is not known.  Make sure you spelled it correctly (case sensitive).&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果不存在对应的配置，会抛出 BuilderException 异常，如果自定义配置都是生效的，随后会调用 settingsElement 方法将这些运行时行为设置到全局配置中。</p>
<h3 id=解析-typealiases-元素>解析 typeAliases 元素</h3>
<p>typeAliases 元素用于定义类别名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;typeAliases&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;package</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.User&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;User&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.User&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;typeAlias</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.Item&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/typeAliases&gt;</span>
</code></pre></div><p>如果使用 package 元素注册别名，则对应包下的所有类都会注册到 TypeAliasRegistry 别名注册容器中；如果使用 typeAlias 元素，则会注册指定类到别名容器中。注册逻辑如下，如果没有指定别名，则优先从类的 Alias 注解获取别名，如果未在类上定义，则默认使用简单类名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下所有类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册指定包下指定类型的别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param packageName
</span><span style=color:#8f5902;font-style:italic>   * @param superType
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAliases</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>resolverUtil</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 找出该包下superType所有的子类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IsA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>superType</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>packageName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>typeSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolverUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClasses</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>typeSet</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Ignore inner classes and interfaces (including package-info.java)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// Skip also inner classes. See issue #6
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMemberClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名，默认为简单类名，优先从 Alias 注解获取
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param type
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSimpleName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 从Alias注解读取别名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Alias</span> <span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aliasAnnotation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>aliasAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 注册类型别名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param alias 别名
</span><span style=color:#8f5902;font-style:italic>   * @param value 类型
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The parameter alias cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// issue #748
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>alias</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toLowerCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TypeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The alias &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>alias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; is already mapped to the value &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>typeAliases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-plugins-元素>解析 plugins 元素</h3>
<p>插件是 MyBatis 提供的扩展机制之一，通过添加自定义插件可以实现在 SQL 执行过程中的某个时机进行拦截。 plugins 元素用于定义调用拦截器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;plugin</span> <span style=color:#c4a000>interceptor=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.ExamplePlugin&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;ExamplePlugin&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</code></pre></div><p>指定的 interceptor 需要实现 org.apache.ibatis.plugin.Interceptor 接口，在创建对象后被加到全局配置过滤器链中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pluginElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取 interceptor 属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>interceptor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;interceptor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 从子元素中读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Properties</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 加载指定拦截器并创建实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Interceptor</span> <span style=color:#000>interceptorInstance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Interceptor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>interceptorInstance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 加入全局配置拦截器链
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interceptorInstance</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>objectFactory、 objectWrapperFactory、reflectorFactory 元素的解析方式与 plugins 元素类似 ，指定的子类对象创建后被设置到全局对象中。</p>
<h3 id=解析-environments-元素>解析 environments 元素</h3>
<p>在实际生产中，一个项目可能会分为多个不同的环境，通过配置enviroments 元素可以定义不同的数据环境，并在运行时使用指定的环境：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;environments</span> <span style=color:#c4a000>default=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;environment</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;development&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;transactionManager</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;JDBC&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/transactionManager&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;dataSource</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;UNPOOLED&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;driver&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${driver}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;url&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${url}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;username&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${username}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;password&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;${password}&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;/dataSource&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/environment&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;environment</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;prd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    	...
    <span style=color:#204a87;font-weight:700>&lt;/environment&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/environments&gt;</span>
</code></pre></div><p>在解析过程中，只有被 default 属性指定的数据环境才会被加载：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>environmentsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取指定的数据源名
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;default&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 环境配置 id
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSpecifiedEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定环境配置
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// 解析 transactionManager 元素并创建事务工厂实例
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>TransactionFactory</span> <span style=color:#000>txFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionManagerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#8f5902;font-style:italic>// 解析 dataSource 元素并创建数据源工厂实例
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>DataSourceFactory</span> <span style=color:#000>dsFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSourceElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
          <span style=color:#8f5902;font-style:italic>// 创建数据源
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dsFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#8f5902;font-style:italic>// 创建环境
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span> <span style=color:#000>environmentBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txFactory</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 将环境配置信息设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environmentBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 解析 transactionManager 元素并创建事务工厂实例
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws Exception
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionManagerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 指定事务工厂类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 加载事务工厂并创建实例
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>TransactionFactory</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Environment declaration requires a TransactionFactory.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 解析 dataSource 元素并创建数据源工厂实例
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws Exception
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DataSourceFactory</span> <span style=color:#000>dataSourceElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 指定数据源工厂类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 加载数据源工厂并创建实例
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>DataSourceFactory</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSourceFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Environment declaration requires a DataSourceFactory.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-databaseidprovider-元素>解析 databaseIdProvider 元素</h3>
<p>MyBatis 支持通过 databaseIdProvider 元素来指定支持的数据库的 databaseId，这样在映射配置文件中指定 databaseId 就能够与对应的数据源进行匹配：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;databaseIdProvider</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;DB_VENDOR&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;SQL Server&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;sqlserver&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;DB2&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;db2&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;Oracle&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;oracle&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/databaseIdProvider&gt;</span>
</code></pre></div><p>在根据指定类型解析出对应的 DatabaseIdProvider 后，MyBatis 会根据数据源获取对应的厂商信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>databaseIdProviderElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DatabaseIdProvider</span> <span style=color:#000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// awful patch to keep backward compatibility
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;VENDOR&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;DB_VENDOR&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素读取属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 加载数据库厂商信息配置类并创建实例
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DatabaseIdProvider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>databaseIdProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Environment</span> <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取数据库厂商标识
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>databaseIdProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为 DB_VENDOR 被指定为 VendorDatabaseIdProvider 的别名，所以默认的获取厂商信息的逻辑如下，当通过 property 属性指定了数据库产品名则使用指定的名称，否则使用数据库元信息对应的产品名。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据数据源获取对应的厂商信息
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param dataSource
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dataSource cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getDatabaseName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>LogHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not get a databaseId from dataSource&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 如果传入的属性配置包含当前数据库产品名，返回指定的值，否则返回数据库产品名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param dataSource
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getDatabaseName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>productName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDatabaseProductName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>productName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// no match, return null
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>productName</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取数据库产品名
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param dataSource
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getDatabaseProductName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Connection</span> <span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>DatabaseMetaData</span> <span style=color:#000>metaData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMetaData</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseProductName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>con</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>con</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// ignored
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-typehandlers-元素>解析 typeHandlers 元素</h3>
<p>typeHandlers 元素用于配置自定义类型转换器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;typeHandlers&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;typeHandler</span> <span style=color:#c4a000>handler=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.ExampleTypeHandler&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/typeHandlers&gt;</span>
</code></pre></div><p>如果配置的是 package 元素，则会将包下的所有类注册为类型转换器；如果配置的是 typeHandler 元素，则会根据 javaType、jdbcType、handler 属性注册类型转换器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>typeHandlerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;package&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 注册指定包下的类作为类型转换器，如果声明了 MappedTypes 注解则注册为指定 java 类型的转换器
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>String</span> <span style=color:#000>typeHandlerPackage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandlerPackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 获取相关属性
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>String</span> <span style=color:#000>javaTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>jdbcTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbcType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>handlerTypeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;handler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定 java 类型类对象
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定 JDBC 类型并创建实例
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveJdbcType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 加载指定类型转换器类对象
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeHandlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handlerTypeName</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注册类型转换器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=解析-mappers-元素>解析 mappers 元素</h3>
<p>mappers 元素用于定义 Mapper 映射文件和 Mapper 调用接口：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;mappers&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;com/wch/mybatis/UserMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>url=</span><span style=color:#4e9a06>&#34;file://mappers/ItemMapper.xml&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.UserMapper&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;package</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.mappers&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/mappers&gt;</span>
</code></pre></div><p>如果定义的是 mapper 元素并指定了 class 属性，或定义了 package 元素，则会将指定类型在 MapperRegistry 中注册为 Mapper 接口，并使用 MapperAnnotationBuilder 对接口方法进行解析；如果定义的是 mapper 元素并指定了 resource、或 url 属性，则会使用 XMLMapperBuilder 解析。对于 Mapper 接口和映射文件将在下一章进行分析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mapperElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;package&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 注册指定包名下的类为 Mapper 接口
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>String</span> <span style=color:#000>mapperPackage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperPackage</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resource&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;url&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;class&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定资源
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定 Mapper 文件并解析
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>mapperParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>mapperParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定 URL
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUrlAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 加载指定 Mapper 文件并解析
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>mapperParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>mapperParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>mapperClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 注册指定类为 Mapper 接口
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>mapperInterface</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classForName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperClass</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A mapper element may only specify a url, resource or class, but not more than one.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p>XMLConfigBuilder 是 XML 配置解析的入口，通常 MyBatis 启动时会使用此类解析配置文件获取运行时行为。</p>
<ul>
<li>org.apache.ibatis.builder.BaseBuilder：为 MyBatis 初始化过程提供一系列工具方法。如别名转换、类型转换、类加载等。</li>
<li>org.apache.ibatis.builder.xml.XMLConfigBuilder：XML 配置解析入口。</li>
<li>org.apache.ibatis.session.Configuration：MyBatis 全局配置，包括运行行为、类型容器、别名容器、注册 Mapper、注册 statement 等。</li>
<li>org.apache.ibatis.mapping.VendorDatabaseIdProvider：根据数据源获取对应的厂商信息。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-125a1275eb4845ae03d56a1d156b0d92>5 - CH05-通用配置解析</h1>
<p>在上章的配置解析中可以看到 MyBatis 在解析完运行时行为相关配置后会继续解析 Mapper 映射文件和接口，其中参数映射的解析入口为 XMLMapperBuilder 。</p>
<h2 id=映射文件解析>映射文件解析</h2>
<p>XMLMapperBuilder 调用 parse 方法解析 Mapper 映射文件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isResourceLoaded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析 mapper 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configurationElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 加入已解析队列
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addLoadedResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// Mapper 映射文件与对应 namespace 的接口进行绑定
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>bindMapperForNamespace</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 重新引用配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parsePendingResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>parsePendingCacheRefs</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>parsePendingStatements</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-mapper-元素>解析 mapper 元素</h2>
<p>mapper 元素通常需要指定 namespace 用于唯一区别映射文件，不同映射文件支持通过其它映射文件的 namespace 来引用其配置。mapper 元素下可以配置二级缓存（cache、cache-ref）、返回值映射（resultMap）、sql fragments（sql）、statement（select、insert、update、delete）等，MyBatis 源码提供 mybatis-mapper.xsd 文件用于规范映射文件书写规则。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>configurationElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取元素对应的 namespace 名称
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Mapper&#39;s namespace cannot be empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 设置 Mapper 文件对应的 namespace 名称
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 解析 cache-ref 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>cacheRefElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache-ref&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 cache 元素，会覆盖 cache-ref 配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>cacheElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 parameterMap 元素（废弃）
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>parameterMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/parameterMap&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 resultMap 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>resultMapElements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 sql 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/mapper/sql&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 解析 select|insert|update|delete 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>buildStatementFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select|insert|update|delete&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error parsing Mapper XML. The XML location is &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-cache-元素>解析 cache 元素</h2>
<p>如果要为某命名空间开启二级缓存功能，可以通过配置 cache 元素，示例配置如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;cache</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>“PERPETUAL”</span> <span style=color:#c4a000>eviction=</span><span style=color:#4e9a06>&#34;LRU&#34;</span> <span style=color:#c4a000>flushInterval=</span><span style=color:#4e9a06>&#34;60000&#34;</span> <span style=color:#c4a000>size=</span><span style=color:#4e9a06>&#34;512&#34;</span> <span style=color:#c4a000>readOnly=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#c4a000>blocking=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/cache&gt;</span>
</code></pre></div><p>cache 元素的解析逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cacheElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取缓存类型，默认为 PERPETUAL
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;PERPETUAL&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// Configuration 构造方法中已为默认的缓存实现注册别名，从别名转换器中获取类对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 获取失效类型，默认为 LRU
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>eviction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;eviction&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;LRU&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evictionClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>typeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eviction</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 缓存刷新时间间隔
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Long</span> <span style=color:#000>flushInterval</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLongAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;flushInterval&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 缓存项大小
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Integer</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;size&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 是否将序列化成二级制数据
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>readWrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;readOnly&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 缓存不命中进入数据库查询时是否加锁（保证同一时刻相同缓存key只有一个线程执行数据库查询任务）
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>blocking</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;blocking&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 从子元素中加载属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 创建缓存配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>useNewCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>evictionClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushInterval</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>readWrite</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>blocking</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在第三章基础支持模块中已经详细介绍了 MyBatis 实现的各种缓存。从 cache 元素中获取缓存参数配置后会交由 MapperBuilderAssistant#useNewCache 方法处理。MapperBuilderAssistant 方法是一个映射文件解析工具，它负责将映射文件各个元素解析的参数生成配置对象，最终设置到全局配置类 Configuration 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Cache</span> <span style=color:#000>useNewCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evictionClass</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Long</span> <span style=color:#000>flushInterval</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Integer</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>readWrite</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>blocking</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>Properties</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentNamespace</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 基础缓存配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>implementation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>valueOrDefault</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PerpetualCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#8f5902;font-style:italic>// 失效类型，默认 LRU
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addDecorator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>valueOrDefault</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>evictionClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>LruCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#8f5902;font-style:italic>// 定时清理缓存时间间隔
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearInterval</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flushInterval</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 缓存项大小
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 是否将缓存系列化成二级制数据
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readWrite</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readWrite</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 缓存不命中进入数据库查询时是否加锁（保证同一时刻相同缓存key只有一个线程执行数据库查询任务）
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>blocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>blocking</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>properties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>currentCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-cache-ref-元素>解析 cache-ref 元素</h2>
<p>如果希望引用其它 namespace 的缓存配置，可以通过 cache-ref 元素配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;cache-ref</span> <span style=color:#c4a000>namespace=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.OtherMapper&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>其解析逻辑是将当前 namespace 与引用缓存配置的 namespace 在全局配置中进行绑定。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cacheRefElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 当前 namespace - 引用缓存配置的 namespace，在全局配置中进行绑定
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addCacheRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>// 获取缓存配置解析器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>CacheRefResolver</span> <span style=color:#000>cacheRefResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheRefResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;namespace&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析获得引用的缓存配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cacheRefResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveCacheRef</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IncompleteElementException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 指定引用的 namespace 缓存还未加载，暂时放入集合，等待全部 namespace 都加载完成后重新引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addIncompleteCacheRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheRefResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由于存在被引用配置还未被加载，因而无法从全局配置中获取的情况，MyBatis 定义了 IncompleteElementException 在此时抛出，未解析完成的缓存解析对象会被加入到全局配置中的 incompleteCacheRefs 集合中，用于后续处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Cache</span> <span style=color:#000>useCacheRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cache-ref element requires a namespace attribute.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>unresolvedCacheRef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 从全局配置中获取缓存配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No cache for namespace &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; could be found.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>currentCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>unresolvedCacheRef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 可能指定引用的 namespace 缓存还未加载，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;No cache for namespace &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>namespace</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; could be found.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>MyBatis 允许 resultMap、cache-ref、statement 元素延迟加载，以 cache-ref 重新引用的方法 parsePendingCacheRefs 为例，其重新引用逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parsePendingCacheRefs</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 从全局配置中获取未解析的缓存引用配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CacheRefResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>incompleteCacheRefs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIncompleteCacheRefs</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>incompleteCacheRefs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CacheRefResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>incompleteCacheRefs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 逐个重新引用缓存配置
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>iter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resolveCacheRef</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#8f5902;font-style:italic>// 引用成功，删除集合元素
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>iter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IncompleteElementException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 引用的缓存配置不存在
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// Cache ref is still missing a resource...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析-resultmap-元素>解析 resultMap 元素</h2>
<p>resultMap 元素用于定义结果集与结果对象（JavaBean 对象）之间的映射规则。resultMap 下除了 discriminator 的其它元素，都会被解析成 ResultMapping 对象，其解析过程如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMap</span> <span style=color:#000>resultMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalResultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;processing &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValueBasedIdentifier</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 获取返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ofType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>))));</span>
    <span style=color:#8f5902;font-style:italic>// 加载返回值类对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// association 和 case 元素没有显式地指定返回值类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inheritEnclosingType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Discriminator</span> <span style=color:#000>discriminator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>additionalResultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加载子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultChildren</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resultChildren</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;constructor&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 constructor 元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>processConstructorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;discriminator&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 discriminator 元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>discriminator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>processDiscriminatorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 resultMap 元素下的其它元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// id 元素增加标志
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ID</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 解析元素映射关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValueBasedIdentifier</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// extend resultMap id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;extends&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 是否设置自动映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Boolean</span> <span style=color:#000>autoMapping</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;autoMapping&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// resultMap 解析器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ResultMapResolver</span> <span style=color:#000>resultMapResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResultMapResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>discriminator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoMapping</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析生成 ResultMap 对象并设置到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultMapResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolve</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IncompleteElementException</span>  <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 异常稍后处理
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addIncompleteResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapResolver</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以下从不同元素配置的角度分别分析 MyBatis 解析规则。</p>
<h3 id=id--result>id & result</h3>
<p>id 和 result 元素都会将一个列的值映射到一个简单数据类型字段，不同的是 id 元素对应对象的标识属性，在比较对象时会用到。此外还可以设置 typeHandler 属性用于自定义类型转换逻辑。</p>
<p>buildResultMappingFromContext 方法负责将 resultMap 子元素解析为 ResultMapping 对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 解析 resultMap 子元素映射关系
</span><span style=color:#8f5902;font-style:italic>   */</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMapping</span> <span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// constructor 子元素，通过 name 获取参数名
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 列名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;column&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// java 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>javaType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// jdbc 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbcType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 嵌套的 select id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nestedSelect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取嵌套的 resultMap id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nestedResultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 获取指定的不为空才创建实例的列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>notNullColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;notNullColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 列前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>columnPrefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;columnPrefix&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 类型转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 集合的多结果集
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSet&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 指定外键对应的列名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>foreignColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foreignColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 是否懒加载
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lazy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;lazy&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fetchType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLazyLoadingEnabled</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;lazy&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;eager&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 加载返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加载类型转换器类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>typeHandlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加载 jdbc 类型对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveJdbcType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildResultMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nestedSelect</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nestedResultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>notNullColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>columnPrefix</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultSet</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>foreignColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lazy</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ResultMapping 对象保存了列名与 JavaBean 中字段名的对应关系，并明确了 Java 类型和 JDBC 类型，如果指定了类型转换器则使用指定的转化器将结果集字段映射为 Java 对象字段；否则根据 Java 类型和 JDBC 类型到类型转换器注册类中寻找适合的类型转换器。最终影响映射的一系列因素都被保存到 ResultMapping 对象中并加入到全局配置。</p>
<h3 id=constructor>constructor</h3>
<p>使用 constructor 元素允许返回值对象使用指定的构造方法创建而不是默认的构造方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;constructor&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;idArg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;arg</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;productId&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;product_id&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/constructor&gt;</span>
</code></pre></div><p>在解析 constructor 元素时，MyBatis 特别指定了将 constructor 子元素解析为 ResultMapping 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#8f5902;font-style:italic>// 加载子元素
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultChildren</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resultChildren</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;constructor&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析 constructor 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processConstructorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>...</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>	 * 解析 constructor 元素下的子元素
</span><span style=color:#8f5902;font-style:italic>	 */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processConstructorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>argChildren</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>argChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>argChildren</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#8f5902;font-style:italic>// 标明此元素在 constructor 元素中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;idArg&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 此元素映射 id
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ID</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 解析子元素映射关系
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>argChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>解析 constructor 子元素的逻辑与解析 id、result 元素的逻辑是一致的。</p>
<h4 id=association>association</h4>
<p>association 用于配置非简单类型的映射关系。其不仅支持在当前查询中做嵌套映射：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;userResult&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;User&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;id</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;user_id&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;association</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;product&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;product_id&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;productResult&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
</code></pre></div><p>也支持通过 select 属性嵌套其它查询：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;userResult&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;User&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;id</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;user_id&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;association</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;product&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;product_id&#34;</span> <span style=color:#c4a000>select=</span><span style=color:#4e9a06>&#34;queryProduct&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
</code></pre></div><p>在解析 resultMap 子元素方法 buildResultMappingFromContext 的逻辑中，MyBatis 会尝试获取每个子元素的 resultMap 属性，如果未指定，则会调用 processNestedResultMappings 方法，在此方法中对于 asociation 元素来说，如果指定了 select 属性，则映射时只需要获取对应 select 语句的 resultMap；如果未指定，则需要重新调用 resultMapElement 解析结果集映射关系。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMapping</span> <span style=color:#000>buildResultMappingFromContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// 尝试获取嵌套的 resultMap id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nestedResultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 处理嵌套的 resultMap，获取 id
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param resultMappings
</span><span style=color:#8f5902;font-style:italic>   * @param enclosingType
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws Exception
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;association&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;collection&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#4e9a06>&#34;case&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果是 association、collection 或 case 元素并且没有 select 属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// collection 元素没有指定 resultMap 或 javaType 属性，需要验证 resultMap 父元素对应的返回值类型是否有对当前集合的赋值入口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>validateCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 resultMapElement 方法中调用了 inheritEnclosingType 针对未定义返回类型的元素的返回值类型解析：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ResultMap</span> <span style=color:#000>resultMapElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalResultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// 获取返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ofType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>))));</span>
    <span style=color:#8f5902;font-style:italic>// 加载返回值类对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// association 等元素没有显式地指定返回值类型
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inheritEnclosingType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>inheritEnclosingType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;association&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// association 元素没有指定 resultMap 属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;property&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>property</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>enclosingType</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 根据反射信息确定字段的类型
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MetaClass</span> <span style=color:#000>metaResultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MetaClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReflectorFactory</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>metaResultType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSetterType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;case&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultMapNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// case 元素返回值属性与 resultMap 父元素相同
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>enclosingType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 inheritEnclosingType 方法中，如果未定义 resultMap 属性，则会通过反射工具 MetaClass 获取父元素 resultMap 返回类型的类信息，association 元素对应的字段名称的 setter 方法的参数就是其返回值类型。由此 association 元素必定可以关联到其结果集映射。</p>
<h3 id=collection>collection</h3>
<p>collection 元素用于配置集合属性的映射关系，其解析过程与 association 元素大致相同，重要的区别是 collection 元素使用 ofType 属性指定集合元素类型，例如需要映射的 Java 集合为 List<user> users，则配置示例如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>	<span style=color:#204a87;font-weight:700>&lt;collection</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;users&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;
</span><span style=color:#4e9a06>user_id&#34;</span> <span style=color:#c4a000>ofType=</span><span style=color:#4e9a06>&#34;com.wch.mybatis.User&#34;</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;ArrayList&#34;</span> <span style=color:#c4a000>select=</span><span style=color:#4e9a06>&#34;queryUsers&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>javaType熟悉指定的是字段类型，而 ofType 属性指定的才是需要映射的集合存储的类型。</p>
<h3 id=discriminator>discriminator</h3>
<p>discriminator 支持对一个查询可能出现的不同结果集做鉴别，根据具体的条件为 resultMap 动态选择返回值类型。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;discriminator</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;case</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Apple&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;case</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;2&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Banana&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/discriminator&gt;</span>
</code></pre></div><p>discriminator 元素的解析是通过 processDiscriminatorElement 方法完成的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Discriminator</span> <span style=color:#000>processDiscriminatorElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取需要鉴别的字段的相关信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;column&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>javaType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javaType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>jdbcType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbcType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;typeHandler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>javaTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>typeHandlerClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>JdbcType</span> <span style=color:#000>jdbcTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveJdbcType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>discriminatorMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 解析 discriminator 的 case 子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>caseChild</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析不同列值对应的不同 resultMap
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>caseChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>caseChild</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>processNestedResultMappings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caseChild</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>discriminatorMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildDiscriminator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>javaTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeHandlerClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>discriminatorMap</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-resultmap>创建 ResultMap</h3>
<p>在 resultMap 各子元素解析完成，ResultMapResolver 负责将生成的 ResultMapping 集合解析为 ResultMap 对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ResultMap</span> <span style=color:#000>addResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Discriminator</span> <span style=color:#000>discriminator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span> <span style=color:#000>autoMapping</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not find a parent resultmap with id &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>extend</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 获取继承的 ResultMap 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extend</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>extendedResultMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMappings</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>extendedResultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// Remove parent constructor if this resultMap declares a constructor.
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>declaresConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultMapping</span> <span style=color:#000>resultMapping</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 当前 resultMap 指定了构造方法
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>declaresConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaresConstructor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 移除继承的 ResultMap 的构造器映射对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>extendedResultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeIf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMapping</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>resultMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFlags</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ResultFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSTRUCTOR</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>extendedResultMappings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ResultMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMappings</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoMapping</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>discriminator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>discriminator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果当前 ResultMap 指定了 extend 属性，MyBatis 会从全局配置中获取被继承的 ResultMap 的相关映射关系，加入到当前映射关系中。但是如果被继承的 ResultMap 指定了构造器映射关系，当前 ResultMap 会选择移除。</p>
<h2 id=解析-sql-元素>解析 sql 元素</h2>
<p>sql 元素用于定义可重用的 SQL 代码段，这些代码段可以通过 include 元素进行引用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;baseColumns&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	id, name, value
<span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;other&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	${alias}
<span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;query&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Product&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
	SELECT
  	<span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;baseColumns&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>,
  	<span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;other&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;alias&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;other&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
  	<span style=color:#204a87;font-weight:700>&lt;/include&gt;</span>
  FROM
      t_something
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><p>对 sql 元素的解析逻辑如下，符合 databaseId 要求的 sql 元素才会被加载到全局配置中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 解析 sql 元素，将对应的 sql 片段设置到全局配置中
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sqlElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>XNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseIdMatchesCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 符合当前 databaseId 的 sql fragment，加入到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlFragments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 判断 sql 元素是否满足加载条件
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param id
</span><span style=color:#8f5902;font-style:italic> * @param databaseId
</span><span style=color:#8f5902;font-style:italic> * @param requiredDatabaseId
</span><span style=color:#8f5902;font-style:italic> * @return
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>databaseIdMatchesCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requiredDatabaseId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 如果指定了当前数据源的 databaseId
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 被解析 sql 元素的 databaseId 需要符合
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 全局未指定 databaseId，不会加载指定了 databaseId 的 sql 元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// skip this fragment if there is a previous one with a not null databaseId
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlFragments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>XNode</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlFragments</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p>MyBatis 能够轻松实现列值转换为 Java 对象依靠的是其强大的参数映射功能，能够支持集合、关联类型、嵌套等复杂场景的映射。同时缓存配置、sql 片段配置，也为开发者方便的提供了配置入口。</p>
<ul>
<li>org.apache.ibatis.builder.annotation.MapperAnnotationBuilder：解析 Mapper 接口。</li>
<li>org.apache.ibatis.builder.xml.XMLMapperBuilder：解析 Mapper 文件。</li>
<li>org.apache.ibatis.builder.MapperBuilderAssistant：Mapper 文件解析工具。生成元素对象并设置到全局配置中。</li>
<li>org.apache.ibatis.builder.CacheRefResolver：缓存引用配置解析器，应用其它命名空间缓存配置到当前命名空间下。</li>
<li>org.apache.ibatis.builder.IncompleteElementException：当前映射文件引用了其它命名空间下的配置，而该配置还未加载到全局配置中时会抛出此异常。</li>
<li>org.apache.ibatis.mapping.ResultMapping：返回值字段映射关系对象。</li>
<li>org.apache.ibatis.builder.ResultMapResolver：ResultMap 解析器。</li>
<li>org.apache.ibatis.mapping.ResultMap：返回值映射对象。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a9c6c53bbe0dedfdf1ef1b445f90dcb1>6 - CH06-语句解析</h1>
<p>Mapper 映射文件解析的最后一步是解析所有 statement 元素，即 select、insert、update、delete 元素，这些元素中可能会包含动态 SQL，即使用 ${} 占位符或 if、choose、where 等元素动态组成的 SQL。动态 SQL 功能正是 MyBatis 强大的所在，其解析过程也是十分复杂的。</p>
<h2 id=解析工具>解析工具</h2>
<p>为了方便 statement 的解析，MyBatis 提供了一些解析工具。</p>
<h3 id=token-解析>Token 解析</h3>
<p>MyBatis 支持使用 ${} 或 #{} 类型的 token 作为动态参数，不仅文本中可以使用 token，xml 元素中的属性等也可以使用。</p>
<h4 id=generictokenparser>GenericTokenParser</h4>
<p>GenericTokenParser 是 MyBatis 提供的通用 token 解析器，其解析逻辑是根据指定的 token 前缀和后缀搜索 token，并使用传入的 TokenHandler 对文本进行处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// search open token 搜索 token 前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 没有 token 前缀，返回原文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>src</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toCharArray</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 当前解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 已解析文本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>builder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 当前占位符内的表达式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StringBuilder</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;\\&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果待解析属性前缀被转义，则去掉转义字符，加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// this open token is escaped. remove the backslash and continue.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// found open token. let&#39;s search close token.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 前缀前面的部分加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取对应的后缀索引
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;\\&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 后缀被转义，加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// this close token is escaped. remove the backslash and continue.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 寻找下一个后缀
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 找到后缀，获取占位符内的表达式
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 找不到后缀，前缀之后的部分全部加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// close token was not found.
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 能够找到后缀，追加 token 处理器处理后的文本
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
          <span style=color:#8f5902;font-style:italic>// 更新解析偏移量
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>closeToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 寻找下一个前缀，重复解析表达式
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openToken</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 将最后的部分加入已解析文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 返回解析后的文本
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由于 GenericTokenParser 的 token 前后缀和具体解析逻辑都是可指定的，因此基于 GenericTokenParser 可以实现对不同 token 的定制化解析。</p>
<h4 id=tokenhandler>TokenHandler</h4>
<p>TokenHandler 是 token 处理器抽象接口。实现此接口可以定义 token 以何种方式被解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 对 token 进行解析
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param content 待解析 token
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=propertyparser>PropertyParser</h4>
<p>PropertyParser 是 token 解析的一种具体实现，其指定对 <code>${}</code> 类型 token 进行解析，具体解析逻辑由其内部类 VariableTokenHandler 实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 对 ${} 类型 token 进行解析
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param string
</span><span style=color:#8f5902;font-style:italic>   * @param variables
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>VariableTokenHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>VariableTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据配置属性对 ${} token 进行解析
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VariableTokenHandler</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 预先设置的属性
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 是否运行使用默认值，默认为 false
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>enableDefaultValue</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 默认值分隔符号，即如待解析属性 ${key:default}，key 的默认值为 default
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>VariableTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>variables</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>enableDefaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>KEY_ENABLE_DEFAULT_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ENABLE_DEFAULT_VALUE</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultValueSeparator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>KEY_DEFAULT_VALUE_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DEFAULT_VALUE_SEPARATOR</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getPropertyValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>enableDefaultValue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 如待解析属性 ${key:default}，key 的默认值为 default
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>String</span> <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>separatorIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>separatorIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>defaultValueSeparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultValue</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 使用默认值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultValue</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 不使用默认值
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 返回原文本
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;${&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>VariableTokenHandler 实现了 TokenHandler 接口，其构造方法允许传入一组 Properties 用于获取 token 表达式的值。如果开启了使用默认值，则表达式 ${key:default} 会在 key 没有映射值的时候使用 default 作为默认值。</p>
<h3 id=特殊容器>特殊容器</h3>
<h4 id=strictmap>StrictMap</h4>
<p>Configuration 中的 StrictMap 继承了 HashMap，相对于 HashMap，其存取键值的要求更为严格。put 方法不允许添加相同的 key，并获取最后一个 <code>.</code> 后的部分作为 shortKey，如果 shortKey 也重复了，其会向容器中添加一个 Ambiguity 对象，当使用 get 方法获取这个 shortKey 对应的值时，就会抛出异常。get 方法对于不存在的 key 也会抛出异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 重复 key 异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; already contains value for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span>
          <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conflictMessageProducer</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>conflictMessageProducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取最后一个 . 后的部分作为 shortKey
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>shortKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getShortName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// shortKey 不允许重复，否则在获取时异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shortKey</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>V</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// key 不存在抛异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; does not contain value for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 重复的 key 抛异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>Ambiguity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getSubject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is ambiguous in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span>
                                         <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; (try using the full name including the namespace, or rename one of the entries)&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=contextmap>ContextMap</h4>
<p>ContextMap 是 DynamicContext 的静态内部类，用于保存 sql 上下文中的绑定参数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContextMap</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2977601501966151582L</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 参数对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MetaObject</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ContextMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MetaObject</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterMetaObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 先根据 key 查找原始容器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>strKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 再进入参数对象查找
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMetaObject</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// issue #61 do not modify the context when reading
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parameterMetaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strKey</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=ognl-参数>OGNL 参数</h3>
<h4 id=ognlcache>OgnlCache</h4>
<p>OGNL 工具支持通过字符串表达式调用 Java 方法，但是其实现需要对 OGNL 表达式进行编译，为了提高性能，MyBatis 提供 OgnlCache 工具类用于对 OGNL 表达式编译结果进行缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据 ognl 表达式和参数计算值
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param root
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Map</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createDefaultContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MEMBER_ACCESS</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CLASS_RESOLVER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OgnlException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error evaluating expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 编译 ognl 表达式并放入缓存
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws OgnlException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>OgnlException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expressionCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 编译 ognl 表达式
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Ognl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseExpression</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 放入缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>expressionCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=expressionevaluator>ExpressionEvaluator</h4>
<p>ExpressionEvaluator 是 OGNL 表达式计算工具，evaluateBoolean 和 evaluateIterable 方法分别根据传入的表达式和参数计算出一个 boolean 值或一个可迭代对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 计算 ognl 表达式 true / false
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>evaluateBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 ognl 表达式和参数计算值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// true / false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 不为 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Number</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>compareTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ZERO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 不为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 计算获得一个可迭代的对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param expression
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>evaluateIterable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;The expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; evaluated to a null value.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 已实现 Iterable 接口
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isArray</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 数组转集合
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// the array may be primitive, so Arrays.asList() may throw
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// a ClassCastException (issue 209).  Do the work manually
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// Curse primitives! :) (JGB)
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>answer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>answer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>answer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Map 获取 entry
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error evaluating expression &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>expression</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;.  Return value (&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;) was not iterable.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析逻辑>解析逻辑</h2>
<p>MyBastis 中调用 XMLStatementBuilder#parseStatementNode 方法解析单个 statement 元素。此方法中除了逐个获取元素属性，还对 include 元素、selectKey 元素进行解析，创建了 sql 生成对象 SqlSource，并将 statement 的全部信息聚合到 MappedStatement 对象中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseStatementNode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取 id
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 自定义数据库厂商信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>databaseId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>databaseIdMatchesCurrent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requiredDatabaseId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 不符合当前数据源对应的数据厂商信息的语句不加载
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 获取元素名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 元素名转为对应的 SqlCommandType 枚举
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlCommandType</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 是否为查询
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSelect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 获取 flushCache 属性，查询默认为 false，其它默认为 true
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flushCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;flushCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>isSelect</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取 useCache 属性，查询默认为 true，其它默认为 false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>useCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;useCache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isSelect</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取 resultOrdered 属性，默认为 false
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resultOrdered</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultOrdered&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// Include Fragments before parsing
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>XMLIncludeTransformer</span> <span style=color:#000>includeParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLIncludeTransformer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析 include 属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>includeParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>());</span>

    <span style=color:#8f5902;font-style:italic>// 参数类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>parameterType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parameterType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 Mapper 语法类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>lang</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lang&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 默认使用 XMLLanguageDriver
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LanguageDriver</span> <span style=color:#000>langDriver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getLanguageDriver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// Parse selectKey after includes and remove them.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 解析 selectKey 元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>processSelectKeyNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 KeyGenerator
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>keyStatementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SelectKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT_KEY_SUFFIX</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>keyStatementId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取解析完成的 KeyGenerator 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatementId</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果开启了 useGeneratedKeys 属性，并且为插入类型的 sql 语句、配置了 keyProperty 属性，则可以批量自动设置属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBooleanAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;useGeneratedKeys&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isUseGeneratedKeys</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSERT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>))</span>
          <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>Jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 生成有效 sql 语句和参数绑定对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// sql 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StatementType</span> <span style=color:#000>statementType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;statementType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PREPARED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#8f5902;font-style:italic>// 分批获取数据的数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Integer</span> <span style=color:#000>fetchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fetchSize&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 执行超时时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Integer</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;timeout&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 参数映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>parameterMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parameterMap&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 返回值映射 map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultMap&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 结果集类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSetType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSetType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ResultSetType</span> <span style=color:#000>resultSetTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveResultSetType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSetType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 插入、更新生成键值的字段
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyProperty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyProperty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 插入、更新生成键值的列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 指定多结果集名称
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultSets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultSets&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 新增 MappedStatement
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>fetchSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultSetTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>useCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultOrdered</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultSets</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=语法驱动>语法驱动</h3>
<p>LanguageDriver 是 statement 创建语法驱动，默认实现为 XMLLanguageDriver，其提供 createSqlSource 方法用于使用 XMLScriptBuilder 创建 sql 生成对象。</p>
<h3 id=递归解析-include>递归解析 include</h3>
<p>include 元素是 statement 元素的子元素，通过 refid 属性可以指向在别处定义的 sql fragments。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Properties</span> <span style=color:#000>variablesContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Properties</span> <span style=color:#000>configurationVariables</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 拷贝全局配置中设置的额外配置属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configurationVariables</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>putAll</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 递归解析 statement 元素中的 include 元素
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * Recursively apply includes through all SQL fragments.
</span><span style=color:#8f5902;font-style:italic>   * @param source Include node in DOM tree
</span><span style=color:#8f5902;font-style:italic>   * @param variablesContext Current context for static variables with values
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Properties</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>included</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;include&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// include 元素，从全局配置中找对应的 sql 节点并 clone
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Node</span> <span style=color:#000>toInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findSqlFragment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;refid&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 读取 include 子元素中的 property 元素，获取全部属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>toIncludeContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getVariablesContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>toIncludeContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>toInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOwnerDocument</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>importNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replaceChild</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasChildNodes</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>insertBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFirstChild</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>removeChild</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toInclude</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>included</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// replace variables in attribute values
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// include 指向的 sql clone 节点，逐个对属性进行解析
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>NamedNodeMap</span> <span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributes</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>Node</span> <span style=color:#000>attr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNodeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// statement 元素中可能包含 include 子元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>applyIncludes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>included</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>included</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TEXT_NODE</span>
        <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// replace variables in text node
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 替换元素值，如果使用了 ${} 占位符，会对 token 进行解析
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNodeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>variablesContext</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 从全局配置中找对应的 sql fragment
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param refid
</span><span style=color:#8f5902;font-style:italic>   * @param variables
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Node</span> <span style=color:#000>findSqlFragment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 解析 refid
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>variables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// namespace.refid
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 从全局配置中找对应的 sql fragment
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>XNode</span> <span style=color:#000>nodeToInclude</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>refid</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nodeToInclude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>cloneNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// sql fragments 定义在全局配置中的 StrictMap 中，获取不到会抛出异常
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IncompleteElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not find SQL statement to include with refid &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>refid</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributes</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNamedItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getNodeValue</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Read placeholders and their values from include node definition.
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * 读取 include 子元素中的 property 元素
</span><span style=color:#8f5902;font-style:italic>   * @param node Include node instance
</span><span style=color:#8f5902;font-style:italic>   * @param inheritedVariablesContext Current context used for replace variables in new variables values
</span><span style=color:#8f5902;font-style:italic>   * @return variables context from include instance (no inherited values)
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Properties</span> <span style=color:#000>getVariablesContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Properties</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 解析 include 元素中的 property 子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Node</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// include 运行包含 property 元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Replace variables inside
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PropertyParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 不允许添加同名属性
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Variable &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; defined twice in the same include definition&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 聚合属性配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Properties</span> <span style=color:#000>newProperties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inheritedVariablesContext</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaredProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newProperties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在开始解析前，从全局配置中获取全部的属性配置，如果 include 元素中有 property 元素，解析并获取键值，放入 variablesContext 中，在后续处理中针对可能出现的 ${} 类型 token 使用 PropertyParser 进行解析。</p>
<p>因为解析 statement 元素前已经加载过 sql 元素，因此会根据 include 元素的 refid 属性查找对应的 sql fragments，如果全局配置中无法找到就会抛出异常；如果能够找到则克隆 sql 元素并插入到当前 xml 文档中。</p>
<h3 id=解析-selectkey>解析 selectKey</h3>
<p>selectKey 用于指定 sql 在 insert 或 update 语句执行前或执行后生成或获取列值，在 MyBatis 中 selectKey 也被当做 statement 语句进行解析并设置到全局配置中。单个 selectKey 元素会以SelectKeyGenerator 对象的形式进行保存用于后续调用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parseSelectKeyNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>XNode</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>LanguageDriver</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 返回值类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;resultType&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>resultTypeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>StatementType</span> <span style=color:#000>statementType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;statementType&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PREPARED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#8f5902;font-style:italic>// 对应字段名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyProperty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyProperty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 对应列名
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>keyColumn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyColumn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 是否在父sql执行前执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>executeBefore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;BEFORE&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AFTER&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#8f5902;font-style:italic>//defaults
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>useCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resultOrdered</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Integer</span> <span style=color:#000>fetchSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Integer</span> <span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flushCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>parameterMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>String</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ResultSetType</span> <span style=color:#000>resultSetTypeEnum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 创建 sql 生成对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nodeToHandle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlCommandType</span> <span style=color:#000>sqlCommandType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlCommandType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SELECT</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 将 KeyGenerator 生成 sql 作为 MappedStatement 加入全局对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>statementType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlCommandType</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>fetchSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultTypeClass</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>resultSetTypeEnum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flushCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>useCache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultOrdered</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyColumn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>databaseId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>langDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>builderAssistant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyCurrentNamespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>MappedStatement</span> <span style=color:#000>keyStatement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 包装为 SelectKeyGenerator 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SelectKeyGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyStatement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executeBefore</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 selectKey 解析完成后，按指定的 namespace 规则从全局配置中获取 SelectKeyGenerator 对象，等待创建 MappedStatement 对象。如果未指定 selectKey 元素，但是全局配置中开启了 useGeneratedKeys，并且指定 insert 元素的 useGeneratedKeys 属性为 true，则 MyBatis 会指定 Jdbc3KeyGenerator 作为 useGeneratedKeys 的默认实现。</p>
<h3 id=创建-sql-生成对象>创建 sql 生成对象</h3>
<h4 id=sqlsource>SqlSource</h4>
<p>SqlSource 是 sql 生成抽象接口，其提供 getBoundSql 方法用于根据参数生成有效 sql 语句和参数绑定对象 BoundSql。在生成 statement 元素的解析结果 MappedStatement 对象前，需要先创建 sql 生成对象，即 SqlSource 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlSource</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据参数生成有效 sql 语句和参数绑定对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param parameterObject
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=sqlnode>SqlNode</h4>
<p>SqlNode 是 sql 节点抽象接口。sql 节点指的是 statement 中的组成部分，如果简单文本、if 元素、where 元素等。SqlNode 提供 apply 方法用于判断当前 sql 节点是否可以加入到生效的 sql 语句中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 根据条件判断当前 sql 节点是否可以加入到生效的 sql 语句中
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211008223403.png style=display:block;width:70% alt=NAME align=center> </div>
<h4 id=dynamiccontext>DynamicContext</h4>
<p>DynamicContext 是动态 sql 上下文，用于保存绑定参数和生效 sql 节点。DynamicContext 使用 ContextMap 作为参数绑定容器。由于动态 sql 是根据参数条件组合生成 sql，DynamicContext 还提供了对 sqlBuilder 修改和访问方法，用于添加有效 sql 节点和生成 sql 文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 生效的 sql 部分，以空格相连
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringJoiner</span> <span style=color:#000>sqlBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringJoiner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getSql</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=节点解析>节点解析</h4>
<p>将 statement 元素转为 sql 生成对象依赖于 LanguageDriver 的 createSqlSource 方法，此方法中创建 XMLScriptBuilder 对象，并调用 parseScriptNode 方法对 sql 组成节点逐个解析并进行组合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSource</span> <span style=color:#000>parseScriptNode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 递归解析各 sql 节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MixedSqlNode</span> <span style=color:#000>rootSqlNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseDynamicTags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isDynamic</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 动态 sql
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DynamicSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 原始文本 sql
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RawSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 处理 statement 各 SQL 组成部分，并进行组合
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>MixedSqlNode</span> <span style=color:#000>parseDynamicTags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// SQL 各组成部分
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#8f5902;font-style:italic>// 遍历子元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>NodeList</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getChildNodes</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newXNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CDATA_SECTION_NODE</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TEXT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解析 sql 文本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>TextSqlNode</span> <span style=color:#000>textSqlNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TextSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>textSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDynamic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 判断是否为动态 sql，包含 ${} 占位符即为动态 sql
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>textSqlNode</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>isDynamic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 静态 sql 元素
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticTextSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ELEMENT_NODE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// issue #628
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 如果是子元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNode</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getNodeName</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取支持的子元素语法处理器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>NodeHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeName</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown element &lt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>nodeName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&gt; in SQL statement.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 根据子元素标签类型使用对应的处理器处理子元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 包含标签元素，认定为动态 SQL
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>isDynamic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MixedSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>parseDynamicTags 方法会对 sql 各组成部分进行分解，如果 statement 元素包含 ${} 类型 token 或含有标签子元素，则认为当前 statement 是动态 sql，随后 isDynamic 属性会被设置为 true。对于文本节点，如 sql 纯文本和仅含 ${} 类型 token 的文本，会被包装为 StaticTextSqlNode 或 TextSqlNode 加入到 sql 节点容器中，而其它元素类型的 sql 节点会经过 NodeHandler 的 handleNode 方法处理过之后才能加入到节点容器中。nodeHandlerMap 定义了不同动态 sql 元素节点与 NodeHandler 的关系：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initNodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;trim&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TrimHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;where&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WhereHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SetHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foreach&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;if&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IfHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;choose&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChooseHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;when&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IfHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;otherwise&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OtherwiseHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>nodeHandlerMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bind&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindHandler</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=mixedsqlnode>MixedSqlNode</h5>
<p>MixedSqlNode 中定义了一个 SqlNode 集合，用于保存 statement 中包含的全部 sql 节点。其生成有效 sql 的逻辑为逐个判断节点是否有效。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 组合 SQL 各组成部分
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @author Clinton Begin
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MixedSqlNode</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>SqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * SQL 各组装成部分
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MixedSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contents</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 逐个判断各个 sql 节点是否能生效
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=statictextsqlnode>StaticTextSqlNode</h5>
<p>StaticTextSqlNode 中仅包含静态 sql 文本，在组装时会直接追加到 sql 上下文的有效 sql 中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=textsqlnode>TextSqlNode</h5>
<p>TextSqlNode 中的 sql 文本包含 ${} 类型 token，使用 GenericTokenParser 搜索到 token 后会使用 BindingTokenParser 对 token 进行解析，解析后的文本会被追加到生效 sql 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 搜索 ${} 类型 token 节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 解析 token 并追加解析后的文本到生效 sql 中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>GenericTokenParser</span> <span style=color:#000>createParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TokenHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BindingTokenParser</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TokenHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Pattern</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BindingTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pattern</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>injectionFilter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>injectionFilter</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取绑定参数
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;_parameter&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SimpleTypeRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isSimpleType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 计算 ognl 表达式的值
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>String</span> <span style=color:#000>srtValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// issue #274 return &#34;&#34; instead of &#34;null&#34;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>checkInjection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>srtValue</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>srtValue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=ifsqlnode>IfSqlNode</h5>
<p>if 标签用于在 test 条件生效时才追加标签内的文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userId &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    AND user_id = #｛userId｝
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
</code></pre></div><p>IfSqlNode 保存了 if 元素下的节点内容和 test 表达式，在生成有效 sql 时会根据 OGNL 工具计算 test 表达式是否生效。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 test 表达式判断当前节点是否生效
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>evaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateBoolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=trimsqlnode>TrimSqlNode</h5>
<p>trim 标签用于解决动态 sql 中由于条件不同不能拼接正确语法的问题。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  SELECT * FROM test
  <span style=color:#204a87;font-weight:700>&lt;trim</span> <span style=color:#c4a000>prefix=</span><span style=color:#4e9a06>&#34;WHERE&#34;</span> <span style=color:#c4a000>prefixOverrides=</span><span style=color:#4e9a06>&#34;AND|OR&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      a = #{a}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;b &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      OR b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;c &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      AND c = #{c}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/trim&gt;</span>
</code></pre></div><p>如果没有 trim 标签，这个 statement 的有效 sql 最终可能会是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#a40000>{</span><span style=color:#000>b</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>但是加上 trim 标签，生成的 sql 语法是正确的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#a40000>{</span><span style=color:#000>b</span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>prefix 属性用于指定 trim 节点生成的 sql 语句的前缀，prefixOverrides 则会指定生成的 sql 语句的前缀需要去除的部分，多个需要去除的前缀可以使用 | 隔开。suffix 与 suffixOverrides 的功能类似，但是作用于后缀。</p>
<p>TrimSqlNode 首先调用 parseOverrides 对 prefixOverrides 和 suffixOverrides 进行解析，通过 | 分隔，分别加入字符串集合。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parseOverrides</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 解析 token，按 | 分隔
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringTokenizer</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overrides</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;|&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countTokens</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreTokens</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存为字符串集合
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextToken</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在调用包含的 SqlNode 的 apply 方法后还会调用 FilteredDynamicContext 的 applyAll 方法处理前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>FilteredDynamicContext</span> <span style=color:#000>filteredDynamicContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 加上前缀和和后缀，并去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>filteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于已经生成的 sql 文本，分别根据规则加上和去除指定前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyAll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sqlBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENGLISH</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 加上前缀和和后缀，并去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>applyPrefix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applySuffix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyPrefix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringBuilder</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>prefixApplied</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>prefixApplied</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefixesToOverride</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 文本最前去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>toRemove</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>prefixesToOverride</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 在文本最前插入前缀和空格
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prefix</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applySuffix</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringBuilder</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>suffixApplied</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>suffixApplied</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffixesToOverride</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 文本最后去除多余字段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>toRemove</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>suffixesToOverride</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>trimmedUppercaseSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>toRemove</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 文本最后插入空格和后缀
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffix</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>suffix</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=wheresqlnode>WhereSqlNode</h5>
<p>where 元素与 trim 元素的功能类似，区别在于 where 元素不提供属性配置可以处理的前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>
    ...
  <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>
</code></pre></div><p>WhereSqlNode 继承了 TrimSqlNode，并指定了需要添加和删除的前缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WhereSqlNode</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TrimSqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prefixList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;AND &#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;OR &#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;AND\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AND\r&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\r&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;AND\t&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;OR\t&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>WhereSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlNode</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 默认添加 WHERE 前缀，去除 AND、OR 等前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;WHERE&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prefixList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因此，生成的 sql 语句会自动在最前加上 WHERE，并去除前缀中包含的 AND、OR 等字符串。</p>
<h5 id=setsqlnode>SetSqlNode</h5>
<p>set 标签用于 update 语句中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>	UPDATE test
	<span style=color:#204a87;font-weight:700>&lt;set&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      a = #{a},
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;b &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>
</code></pre></div><p>SetSqlNode 同样继承自 TrimSqlNode，并指定默认添加 SET 前缀，去除 , 前缀和后缀。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SetSqlNode</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TrimSqlNode</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>COMMA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>singletonList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SetSqlNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>SqlNode</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 默认添加 SET 前缀，去除 , 前缀和后缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;SET&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMA</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMMA</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=foreachsqlnode>ForEachSqlNode</h5>
<p>foreach 元素用于指定对集合循环添加 sql 语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;list&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;item&#34;</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;index&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  AND itm = #{item} AND idx #{index}
<span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
</code></pre></div><p>ForEachSqlNode 解析生成有效 sql 的逻辑如下，除了计算 collection 表达式的值、添加前缀、后缀外，还将参数与索引进行了绑定。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取绑定参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>bindings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 计算 ognl 表达式获取可迭代对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>iterable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>evaluator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateIterable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>collectionExpression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bindings</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>iterable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 添加动态语句前缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyOpen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 迭代索引
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iterable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>DynamicContext</span> <span style=color:#000>oldContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 首个元素
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>separator</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>uniqueNumber</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUniqueNumber</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// Issue #709
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// entry 集合项索引为 key，集合项为 value
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapEntry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 绑定集合项索引关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 绑定集合项关系
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilteredDynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>uniqueNumber</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>!((</span><span style=color:#000>PrefixedContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>isPrefixApplied</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldContext</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 添加动态语句后缀
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>applyClose</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 移除原始的表达式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 绑定集合项索引关系
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param o
</span><span style=color:#8f5902;font-style:italic>   * @param i
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 绑定集合项关系
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param context
</span><span style=color:#8f5902;font-style:italic>   * @param o
</span><span style=color:#8f5902;font-style:italic>   * @param i
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>applyItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于循环中的 #{} 类型 token，ForEachSqlNode 在内部类 FilteredDynamicContext 中定义了解析规则：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>content</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 对解析的表达式进行替换，如 idx = #{index} AND itm = #{item} 替换为 idx = #{__frch_index_1} AND itm = #{__frch_item_1}
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>String</span> <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;^\\s*&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;(?![^.,:\\s])&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemIndex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>newContent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>replaceFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;^\\s*&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>itemIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;(?![^.,:\\s])&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemizeItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itemIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;#{&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>newContent</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>});</span>

    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>appendSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>类似 <code>idx = #{index} AND itm = #{item}</code> 会被替换为 <code>idx = #{__frch_index_1} AND itm = #{__frch_item_1}</code>，而 ForEachSqlNode 也做了参数与索引的绑定，因此在替换时可以快速绑定参数。</p>
<h5 id=choosesqlnode>ChooseSqlNode</h5>
<p>choose 元素用于生成带默认 sql 文本的语句，当 when 元素中的条件都不生效，就可以使用 otherwise 元素的默认文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>  <span style=color:#204a87;font-weight:700>&lt;choose&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;a &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    	AND a = #{a}
    <span style=color:#204a87;font-weight:700>&lt;/when&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;otherwise&gt;</span>
    	AND b = #{b}
    <span style=color:#204a87;font-weight:700>&lt;/otherwise&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/choose&gt;</span>
</code></pre></div><p>ChooseSqlNode 是由 choose 节点和 otherwise 节点组合而成的，在生成有效 sql 于语句时会逐个计算 when 节点的 test 表达式，如果返回 true 则生效当前 when 语句中的 sql。如果均不生效则使用 otherwise 语句对应的默认 sql 文本。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// when 节点根据 test 表达式判断是否生效
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlNode</span> <span style=color:#000>sqlNode</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ifSqlNodes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// when 节点如果都未生效，且存在 otherwise 节点，则使用 otherwise 节点
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultSqlNode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>defaultSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h5 id=vardeclsqlnode>VarDeclSqlNode</h5>
<p>bind 元素用于绑定一个 OGNL 表达式到一个动态 sql 变量中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;bind</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;pattern&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;&#39;%&#39; + _parameter.getTitle() + &#39;%&#39;&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><p>VarDeclSqlNode 会计算表达式的值并将参数名和值绑定到参数容器中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DynamicContext</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 解析 ognl 表达式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OgnlCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expression</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#8f5902;font-style:italic>// 绑定参数
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建解析对象与生成可执行-sql>创建解析对象与生成可执行 sql</h3>
<p>statemen 解析完毕后会创建 MappedStatement 对象，statement 的相关属性以及生成的 sql 创建对象都会被保存到该对象中。MappedStatement 还提供了 getBoundSql 方法用于获取可执行 sql 和参数绑定对象，即 BoundSql 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 生成可执行 sql 和参数绑定对象
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#8f5902;font-style:italic>// 获取参数映射
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ParameterMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// check for nested result maps in parameter mappings (issue #30)
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 检查是否有嵌套的 resultMap
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterMapping</span> <span style=color:#000>pm</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>rmId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMapId</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rmId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ResultMap</span> <span style=color:#000>rm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rmId</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rm</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>hasNestedResultMaps</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>rm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNestedResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>BoundSql 对象由 DynamicSqlSource 的 getBoundSql 方法生成，在验证各个 sql 节点，生成了有效 sql 后会继续调用 SqlSourceBuilder 将 sql 解析为 StaticSqlSource，即可执行 sql。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BoundSql</span> <span style=color:#000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DynamicContext</span> <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DynamicContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 验证各 sql 节点，生成有效 sql
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>rootSqlNode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>SqlSourceBuilder</span> <span style=color:#000>sqlSourceParser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSourceBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 将生成的 sql 文本解析为 StaticSqlSource
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSource</span> <span style=color:#000>sqlSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSourceParser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBindings</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此时的 sql 文本中仍包含 #{} 类型 token，需要通过 ParameterMappingTokenHandler 进行解析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSource</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>originalSql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ParameterMappingTokenHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ParameterMappingTokenHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>additionalParameters</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建 #{} 类型 token 搜索对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GenericTokenParser</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericTokenParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#{&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 解析 token
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>originalSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建静态 sql 生成对象，并绑定参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StaticSqlSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>token 的具体解析逻辑为根据表达式的参数名生成对应的参数映射对象，并将表达式转为预编译 sql 的占位符 ?。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>handleToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 创建参数映射对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buildParameterMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 将表达式转为预编译 sql 占位符
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;?&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终解析完成的 sql 与参数映射关系集合包装为 StaticSqlSource 对象，该对象在随后的逻辑中通过构造方法创建了 BoundSql 对象。</p>
<h2 id=接口解析>接口解析</h2>
<p>除了使用 xml 方式配置 statement，MyBatis 同样支持使用 Java 注解配置。但是相对于 xml 的映射方式，将动态 sql 写在 Java 代码中是不合适的。如果在配置文件中指定了需要注册 Mapper 接口的类或包，MyBatis 会扫描相关类进行注册；在 Mapper 文件解析完成后也会尝试加载 namespace 的同名类，如果存在，则注册为 Mapper 接口。</p>
<p>无论是绑定还是直接注册 Mapper 接口，都是调用 MapperAnnotationBuilder#parse 方法来解析的。此方法中的解析方式与上述 xml 解析方式大致相同，区别只在于相关配置参数是从注解中获取而不是从 xml 元素属性中获取。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 不允许相同接口重复注册
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Type &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is already known to the MapperRegistry.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#8f5902;font-style:italic>// It&#39;s important that the type is added before the parser is run
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// otherwise the binding may automatically be attempted by the
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// mapper parser. If the type is already known, it won&#39;t try.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MapperAnnotationBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperAnnotationBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>loadCompleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>loadCompleted</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p><code>statement</code> 解析的最终目的是为每个 <code>statement</code> 创建一个 <code>MappedStatement</code> 对象保存相关定义，在 <code>sql</code> 执行时根据传入参数动态获取可执行 <code>sql</code> 和参数绑定对象。</p>
<ul>
<li><code>org.apache.ibatis.builder.xml.XMLStatementBuilder</code>：解析 <code>Mapper</code> 文件中的 <code>select|insert|update|delete</code> 元素。</li>
<li><code>org.apache.ibatis.parsing.GenericTokenParser.GenericTokenParser</code>：搜索指定格式 <code>token</code> 并进行解析。</li>
<li><code>org.apache.ibatis.parsing.TokenHandler</code>：<code>token</code> 处理器抽象接口。定义 <code>token</code> 以何种方式被解析。</li>
<li><code>org.apache.ibatis.parsing.PropertyParser</code>：<code>${}</code> 类型 <code>token</code> 解析器。</li>
<li><code>org.apache.ibatis.session.Configuration.StrictMap</code>：封装 <code>HashMap</code>，对键值存取有严格要求。</li>
<li><code>org.apache.ibatis.builder.xml.XMLIncludeTransformer</code>：<code>include</code> 元素解析器。</li>
<li><code>org.apache.ibatis.mapping.SqlSource</code>：<code>sql</code> 生成抽象接口。根据传入参数生成有效 <code>sql</code> 语句和参数绑定对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.XMLScriptBuilder</code>：解析 <code>statement</code> 各个 <code>sql</code> 节点并进行组合。</li>
<li><code>org.apache.ibatis.scripting.xmltags.SqlNode</code>：<code>sql</code> 节点抽象接口。用于判断当前 <code>sql</code> 节点是否可以加入到生效的 sql 语句中。</li>
<li><code>org.apache.ibatis.scripting.xmltags.DynamicContext</code>：动态 <code>sql</code> 上下文。用于保存绑定参数和生效 <code>sql</code> 节点。</li>
<li><code>org.apache.ibatis.scripting.xmltags.OgnlCache</code>：<code>ognl</code> 缓存工具，缓存表达式编译结果。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ExpressionEvaluator</code>：<code>ognl</code> 表达式计算工具。</li>
<li><code>org.apache.ibatis.scripting.xmltags.MixedSqlNode</code>：<code>sql</code> 节点组合对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.StaticTextSqlNode</code>：静态 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.TextSqlNode</code>：<code>${}</code> 类型 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.IfSqlNode</code>：<code>if</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.TrimSqlNode</code>：<code>trim</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.WhereSqlNode</code>：<code>where</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.SetSqlNode</code>：<code>set</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ForEachSqlNode</code>：<code>foreach</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.ChooseSqlNode</code>：<code>choose</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.VarDeclSqlNode</code>：<code>bind</code> 元素 <code>sql</code> 节点对象。</li>
<li><code>org.apache.ibatis.mapping.MappedStatement</code>：<code>statement</code> 解析对象。</li>
<li><code>org.apache.ibatis.mapping.BoundSql</code>：可执行 <code>sql</code> 和参数绑定对象。</li>
<li><code>org.apache.ibatis.scripting.xmltags.DynamicSqlSource</code>：根据参数动态生成有效 <code>sql</code> 和绑定参数。</li>
<li><code>org.apache.ibatis.builder.SqlSourceBuilder</code>：解析 <code>#{}</code> 类型 <code>token</code> 并绑定参数对象。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-76dd90616bec5587f31bc2e5f663b91b>7 - CH07-接口层</h1>
<h2 id=sql-会话创建工厂>sql 会话创建工厂</h2>
<p><code>SqlSessionFactoryBuilder</code> 经过复杂的解析逻辑之后，会根据全局配置创建 <code>DefaultSqlSessionFactory</code>，该类是 <code>sql</code> 会话创建工厂抽象接口 <code>SqlSessionFactory</code> 的默认实现，其提供了若干 <code>openSession</code> 方法用于打开一个会话，在会话中进行相关数据库操作。这些 <code>openSession</code> 方法最终都会调用 <code>openSessionFromDataSource</code> 或 <code>openSessionFromConnection</code> 创建会话，即基于数据源配置创建还是基于已有连接对象创建。</p>
<h3 id=基于数据源配置创建会话>基于数据源配置创建会话</h3>
<p>要使用数据源打开一个会话需要先从全局配置中获取当前生效的数据源环境配置，如果没有生效配置或没用设置可用的事务工厂，就会创建一个 <code>ManagedTransactionFactory</code> 实例作为默认事务工厂实现，其与 <code>MyBatis</code> 提供的另一个事务工厂实现 <code>JdbcTransactionFactory</code> 的区别在于其生成的事务实现 <code>ManagedTransaction</code> 的提交和回滚方法是空实现，即希望将事务管理交由外部容器管理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSessionFromDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Transaction</span> <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Environment</span> <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 获取事务工厂
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTransactionFactoryFromEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建事务配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建执行器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建 sql 会话
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// may have fetched a connection so lets call close()
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error opening session.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取生效数据源环境配置的事务工厂
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>getTransactionFactoryFromEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Environment</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 未配置数据源环境或事务工厂，默认使用 ManagedTransactionFactory
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ManagedTransactionFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransactionFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>随后会根据入参传入的 <code>execType</code> 选择对应的执行器 <code>Executor</code>，<code>execType</code> 的取值来源于 <code>ExecutorType</code>，这是一个枚举类。在下一章将会详细分析各类 <code>Executor</code> 的作用及其实现。</p>
<p>获取到事务工厂配置和执行器对象后会结合传入的数据源自动提交属性创建 <code>DefaultSqlSession</code>，即 <code>sql</code> 会话对象。</p>
<h3 id=基于数据连接创建会话>基于数据连接创建会话</h3>
<p>基于连接创建会话的流程大致与基于数据源配置创建相同，区别在于自动提交属性 <code>autoCommit</code> 是从连接对象本身获取的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSessionFromConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取自动提交配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Failover to true, as most poor drivers
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// or databases won&#39;t support transactions
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Environment</span> <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEnvironment</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 获取事务工厂
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTransactionFactoryFromEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建事务配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Transaction</span> <span style=color:#000>tx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建执行器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Executor</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tx</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>execType</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建 sql 会话
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error opening session.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=sql-会话>sql 会话</h2>
<p><code>SqlSession</code> 是 <code>MyBatis</code> 面向用户编程的接口，其提供了一系列方法用于执行相关数据库操作，默认实现为 <code>DefaultSqlSession</code>，在该类中，增删查改对应的操作最终会调用 <code>selectList</code>、<code>select</code> 和 <code>update</code> 方法，其分别用于普通查询、执行存储过程和修改数据库记录。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrapCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_RESULT_HANDLER</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error querying database.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 调用存储过程
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrapCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error querying database.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 修改
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>dirty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrapCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error updating database.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以上操作均是根据传入的 <code>statement</code> 名称到全局配置中查找对应的 <code>MappedStatement</code> 对象，并将操作委托给执行器对象 <code>executor</code> 完成。<code>select</code>、<code>selectMap</code> 等方法则是对 <code>selectList</code> 方法返回的结果集做处理来实现的。</p>
<p>此外，提交和回滚方法也是基于 <code>executor</code> 实现的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 提交事务
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCommitOrRollbackRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>dirty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error committing transaction.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 回滚事务
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isCommitOrRollbackRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#000>dirty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error rolling back transaction.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 非自动提交且事务未提交 || 强制提交或回滚 时返回 true
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCommitOrRollbackRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>autoCommit</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>dirty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>force</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在执行 <code>update</code> 方法时，会设置 <code>dirty</code> 属性为 <code>true</code> ，意为事务还未提交，当事务提交或回滚后才会将 <code>dirty</code> 属性修改为 <code>false</code>。如果当前会话不是自动提交且 <code>dirty</code> 熟悉为 <code>true</code>，或者设置了强制提交或回滚的标志，则会将强制标志提交给 <code>executor</code> 处理。</p>
<h2 id=sql-会话管理器>sql 会话管理器</h2>
<p><code>SqlSessionManager</code> 同时实现了 <code>SqlSessionFactory</code> 和 <code>SqlSession</code> 接口，使得其既能够创建 <code>sql</code> 会话，又能够执行 <code>sql</code> 会话的相关数据库操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * sql 会话创建工厂
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * sql 会话代理对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSessionProxy</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 保存线程对应 sql 会话
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>localSqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSessionManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Proxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>SqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>},</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionInterceptor</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSession</span> <span style=color:#000>openSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 设置当前线程对应的 sql 会话
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>startManagedSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>localSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>openSession</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * sql 会话代理逻辑
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SqlSessionInterceptor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionInterceptor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Prevent Synthetic Access
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取当前线程对应的 sql 会话对象并执行对应方法
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlSessionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>localSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果当前线程没有对应的 sql 会话，默认创建不自动提交的 sql 会话
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span> <span style=color:#000>autoSqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>openSession</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autoSqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>autoSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>autoSqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>SqlSessionManager</code> 的构造方法要求 <code>SqlSessionFactory</code> 对象作为入参传入，其各个创建会话的方法实际是由该传入对象完成的。执行 <code>sql</code> 会话的操作由 <code>sqlSessionProxy</code> 对象完成，这是一个由 <code>JDK</code> 动态代理创建的对象，当执行方法时会去 <code>ThreadLocal</code> 对象中查找当前线程有没有对应的 <code>sql</code> 会话对象，如果有则使用已有的会话对象执行，否则创建新的会话对象执行，而线程对应的会话对象需要使用 <code>startManagedSession</code> 方法来维护。</p>
<p>之所以 <code>SqlSessionManager</code> 需要为每个线程维护会话对象，是因为 <code>DefaultSqlSession</code> 是非线程安全的，多线程操作会导致执行错误。如上文中提到的 <code>dirty</code> 属性，其修改是没有经过任何同步操作的。</p>
<h2 id=总结>总结</h2>
<p><code>SqlSession</code> 是 <code>MyBatis</code> 提供的面向开发者编程的接口，其提供了一系列数据库相关操作，并屏蔽了底层细节。使用 <code>MyBatis</code> 的正确方式应该是像 <code>SqlSessionManager</code> 那样为每个线程创建 <code>sql</code> 会话对象，避免造成线程安全问题。</p>
<ul>
<li><code>org.apache.ibatis.session.SqlSessionFactory</code>：<code>sql</code> 会话创建工厂。</li>
<li><code>org.apache.ibatis.session.defaults.DefaultSqlSessionFactory</code>： <code>sql</code> 会话创建工厂默认实现。</li>
<li><code>org.apache.ibatis.session.SqlSession</code>：<code>sql</code> 会话。</li>
<li><code>org.apache.ibatis.session.defaults.DefaultSqlSession</code>：<code>sql</code> 会话默认实现。</li>
<li><code>org.apache.ibatis.session.SqlSessionManager</code>：<code>sql</code> 会话管理器。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c2f0467d2acc81697b3d21a42afa4ddb>8 - CH08-执行器</h1>
<p>执行器 <code>Executor</code> 是 <code>MyBatis</code> 的核心接口之一，接口层提供的相关数据库操作，都是基于 <code>Executor</code> 的子类实现的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211008225409.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=创建执行器>创建执行器</h2>
<p>在创建 <code>sql</code> 会话时，<code>MyBatis</code> 会调用 <code>Configuration#newExecutor</code> 方法创建执行器。枚举类 <code>ExecutorType</code> 定义了三种执行器类型，即 <code>SIMPLE</code>、<code>REUSE</code> 和 <code>Batch</code>，这些执行器的主要区别在于：</p>
<ul>
<li><code>SIMPLE</code> 在每次执行完成后都会关闭 <code>statement</code> 对象；</li>
<li><code>REUSE</code> 会在本地维护一个容器，当前 <code>statement</code> 创建完成后放入容器中，当下次执行相同的 <code>sql</code> 时会复用 <code>statement</code> 对象，执行完毕后也不会关闭；</li>
<li><code>BATCH</code> 会将修改操作记录在本地，等待程序触发或有下一次查询时才批量执行修改操作。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Executor</span> <span style=color:#000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Transaction</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutorType</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 默认类型为 simple
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>defaultExecutorType</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIMPLE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BATCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BatchExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REUSE</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReuseExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 如果全局缓存打开，使用 CachingExecutor 代理执行器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CachingExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#8f5902;font-style:italic>// 应用插件
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行器创建后，如果全局缓存配置是有效的，则会将执行器装饰为 <code>CachingExecutor</code>。</p>
<h2 id=基础执行器>基础执行器</h2>
<p><code>SimpleExecutor</code>、<code>ReuseExecutor</code>、<code>BatchExecutor</code> 均继承自 <code>BaseExecutor</code>。<code>BaseExecutor</code> 实现了 <code>Executor</code> 的全部方法，对缓存、事务、连接处理等提供了一些模板方法，但是针对具体的数据库操作留下了四个抽象方法交由子类实现。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 更新
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 刷新 statement
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doFlushStatements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询获取游标对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Cursor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doQueryCursor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>基础执行器的查询逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executing a query&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>object</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Executor was closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queryStack</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFlushCacheRequired</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 非嵌套查询且设置强制刷新时清除缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>++;</span>
      <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultHandler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 缓存不为空，组装存储过程出参
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>handleLocallyCachedOutputParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 无本地缓存，执行数据库查询
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queryFromDatabase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>queryStack</span><span style=color:#ce5c00;font-weight:700>--;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queryStack</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeferredLoad</span> <span style=color:#000>deferredLoad</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>deferredLoads</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>deferredLoad</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#8f5902;font-style:italic>// issue #601
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>deferredLoads</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocalCacheScope</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>LocalCacheScope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STATEMENT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// issue #482
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 全局配置语句不共享缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询本地缓存，组装存储过程结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>handleLocallyCachedOutputParameters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CALLABLE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存储过程类型，查询缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>cachedParameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>localOutputParameterCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedParameter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MetaObject</span> <span style=color:#000>metaCachedParameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedParameter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MetaObject</span> <span style=color:#000>metaParameter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterMapping</span> <span style=color:#000>parameterMapping</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>ParameterMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IN</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 参数类型为 OUT 或 INOUT 的，组装结果集
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>parameterName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>cachedValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaCachedParameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterName</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>metaParameter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cachedValue</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 查询数据库获取结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queryFromDatabase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 放一个 placeHolder 标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EXECUTION_PLACEHOLDER</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 执行查询
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 查询结果集放入本地缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>localCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>StatementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CALLABLE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果是存储过程查询，将存储过程结果集放入本地缓存
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>localOutputParameterCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行查询时 <code>MyBatis</code> 首先会根据 <code>CacheKey</code> 查询本地缓存，<code>CacheKey</code> 由本次查询的参数生成，本地缓存由 <code>PerpetualCache</code> 实现，这就是 <code>MyBatis</code> 的一级缓存。一级缓存维护对象 <code>localCache</code> 是基础执行器的本地变量，因此只有相同 <code>sql</code> 会话的查询才能共享一级缓存。当一级缓存中没有对应的数据，基础执行器最终会调用 <code>doQuery</code> 方法交由子类去获取数据。</p>
<p>而执行 <code>update</code> 等其它操作时，则会首先清除本地的一级缓存再交由子类执行具体的操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;executing an update&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>object</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Executor was closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 清空本地缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 调用子类执行器逻辑
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=简单执行器>简单执行器</h2>
<p>简单执行器是 <code>MyBatis</code> 的默认执行器。其封装了对 <code>JDBC</code> 的操作，对于查询方法 <code>doQuery</code> 的实现如下，其主要包括创建 <code>statement</code> 处理器、创建 <code>statement</code>、执行查询、关闭 <code>statement</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Configuration</span> <span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// 创建 statement 处理器
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 创建 statement
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementLog</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#8f5902;font-style:italic>// 执行查询
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 关闭 statement
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-statement-处理器>创建 statement 处理器</h3>
<p>全局配置类 <code>Configuration</code> 提供了方法 <code>newStatementHandler</code> 用于创建 <code>statement</code> 处理器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 创建 statement 处理器
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StatementHandler</span> <span style=color:#000>newStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MappedStatement</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// StatementHandler 包装对象，根据 statement 类型创建代理处理器，并将实际操作委托给代理处理器处理
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>StatementHandler</span> <span style=color:#000>statementHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RoutingStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 应用插件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>statementHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StatementHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statementHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实际每次创建的 <code>statement</code> 处理器对象都是由 <code>RoutingStatementHandler</code> 创建的，<code>RoutingStatementHandler</code> 根据当前 <code>MappedStatement</code> 的类型创建具体的 <code>statement</code> 类型处理器。<code>StatementType</code> 定义了 <code>3</code> 个 <code>statement</code> 类型枚举，分别对应 <code>JDBC</code> 的普通语句、预编译语句和存储过程语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RoutingStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 根据 statement 类型选择对应的 statementHandler
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>STATEMENT</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PREPARED</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PreparedStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>CALLABLE</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CallableStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>default</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unknown statement type: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementType</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=创建-statement>创建 statement</h3>
<p>简单执行器中的 <code>Statement</code> 对象是根据上述步骤中生成的 <code>statement</code> 处理器获取的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Statement</span> <span style=color:#000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Log</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 获取代理连接对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 设置 statement 参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Statement</span> <span style=color:#000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>transactionTimeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sql</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>Statement</span> <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 从连接中创建 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>instantiateStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置超时时间
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setStatementTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transactionTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置分批获取数据数量
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>setFetchSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error preparing statement.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=执行查询>执行查询</h3>
<p>创建 statement 对象完成即可通过 JDBC 的 API 执行数据库查询，并从 statement 对象中获取查询结果，根据配置进行转换。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>PreparedStatement</span> <span style=color:#000>ps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreparedStatement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 执行查询
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 处理结果集
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resultSetHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>handleResultSets</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 处理结果集
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>handleResultSets</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>activity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;handling results&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>object</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 多结果集
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>multipleResults</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>resultSetCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ResultSetWrapper</span> <span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getFirstResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// statement 对应的所有 ResultMap 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResultMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultMaps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMaps</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>resultMapCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMaps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 验证结果集不为空时，ResultMap 数量不能为 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>validateResultMapsCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMapCount</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultMapCount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 逐个获取 ResultMap
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resultMaps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 转换结果集，放到 multipleResults 容器中
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>handleResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>multipleResults</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 获取下一个待处理的结果集
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getNextResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>cleanUpAfterHandlingResultSet</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// statement 配置的多结果集类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>resultSets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultSets</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSets</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultSetCount</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>resultSets</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ResultMapping</span> <span style=color:#000>parentMapping</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextResultMaps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultSets</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentMapping</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>String</span> <span style=color:#000>nestedResultMapId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNestedResultMapId</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>ResultMap</span> <span style=color:#000>resultMap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResultMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nestedResultMapId</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>handleResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rsw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parentMapping</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>rsw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getNextResultSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>cleanUpAfterHandlingResultSet</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>resultSetCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>collapseSingleResultList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>multipleResults</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=关闭连接>关闭连接</h3>
<p>查询完成后 <code>statement</code> 对象会被关闭。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 关闭 statement
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param statement
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ignore
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>简单执行器中的其它数据库执行方法与 <code>doQuery</code> 方法实现类似。</p>
<h2 id=复用执行器>复用执行器</h2>
<p><code>ReuseExecutor</code> 相对于 <code>SimpleExecutor</code> 实现了对 <code>statment</code> 对象的复用，其在本地维护了 <code>statementMap</code> 用于保存 <code>sql</code> 语句和 <code>statement</code> 对象的关系。当调用 <code>prepareStatement</code> 方法获取 <code>statement</code> 对象时首先会查找本地是否有对应的 <code>statement</code> 对象，如果有则进行复用，负责重新创建并将 <code>statement</code> 对象放入本地缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 创建 statement 对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param handler
</span><span style=color:#8f5902;font-style:italic>   * @param statementLog
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Statement</span> <span style=color:#000>prepareStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Log</span> <span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>String</span> <span style=color:#000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasStatementFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果本地容器中包含当前 sql 对应的 statement 对象，进行复用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>applyTransactionTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statementLog</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>putStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasStatementFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isClosed</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Statement</span> <span style=color:#000>getStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>提交或回滚会导致执行器调用 <code>doFlushStatements</code> 方法，复用执行器会因此批量关闭本地的 <code>statement</code> 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 批量关闭 statement 对象
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param isRollback
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doFlushStatements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>statementMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=批量执行器>批量执行器</h2>
<p><code>BatchExecutor</code> 相对于 <code>SimpleExecutor</code> ，其 <code>update</code> 操作是批量执行的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Configuration</span> <span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StatementHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newStatementHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DEFAULT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBoundSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>sql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Statement</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentStatement</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 如果当前 sql 与上次传入 sql 相同且为相同的 MappedStatement，复用 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#8f5902;font-style:italic>// 获取最后一个 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置超时时间
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>applyTransactionTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>// 设置参数
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//fix Issues 322
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 获取批量执行结果对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>BatchResult</span> <span style=color:#000>batchResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addParameterObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 创建新的 statement 对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStatementLog</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prepare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTimeout</span><span style=color:#ce5c00;font-weight:700>());</span>
      <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parameterize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>    <span style=color:#8f5902;font-style:italic>//fix Issues 322
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>currentSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>currentStatement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 执行 JDBC 批量添加 sql 语句操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>batch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>BATCH_UPDATE_RETURN_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 批量执行 sql
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param isRollback
</span><span style=color:#8f5902;font-style:italic>   * @return
</span><span style=color:#8f5902;font-style:italic>   * @throws SQLException
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doFlushStatements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 批量执行结果
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BatchResult</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>results</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRollback</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptyList</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>applyTransactionTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>BatchResult</span> <span style=color:#000>batchResult</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 设置执行影响行数
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUpdateCounts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeBatch</span><span style=color:#ce5c00;font-weight:700>());</span>
          <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterObjects</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterObjects</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKeyGenerator</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Jdbc3KeyGenerator</span> <span style=color:#000>jdbc3KeyGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 设置数据库生成的主键
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>jdbc3KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processBatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObjects</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>NoKeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//issue #141
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>parameter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>parameterObjects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>keyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>processAfter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#8f5902;font-style:italic>// Close statement to close cursor #1109
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BatchUpdateException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>StringBuilder</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>())</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; (batch index #&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; failed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; prior sub executor(s) completed successfully, but will be rolled back.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BatchExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>batchResult</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Statement</span> <span style=color:#000>stmt</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>closeStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stmt</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>currentSql</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#000>statementList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>batchResultList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行器提交或回滚事务时会调用 <code>doFlushStatements</code>，从而批量执行提交的 <code>sql</code> 语句并最终批量关闭 <code>statement</code> 对象。</p>
<h2 id=缓存执行器与二级缓存>缓存执行器与二级缓存</h2>
<p><code>CachingExecutor</code> 对基础执行器进行了装饰，其作用就是为查询提供二级缓存。所谓的二级缓存是由 <code>CachingExecutor</code> 维护的，相对默认内置的一级缓存而言的缓存。二者区别如下：</p>
<ul>
<li>一级缓存由基础执行器维护，且不可关闭。二级缓存的配置是开发者可干预的，在 <code>xml</code> 文件或注解中针对 <code>namespace</code> 的缓存配置就是二级缓存配置。</li>
<li>一级缓存在执行器中维护，即不同 <code>sql</code> 会话不能共享一级缓存。二级缓存则是根据 <code>namespace</code> 维护，不同 <code>sql</code> 会话是可以共享二级缓存的。</li>
</ul>
<p><code>CachingExecutor</code> 中的方法大多是通过直接调用其代理的执行器来实现的，而查询操作则会先查询二级缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存事务管理器
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>TransactionalCacheManager</span> <span style=color:#000>tcm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransactionalCacheManager</span><span style=color:#ce5c00;font-weight:700>();</span>

	<span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 查询二级缓存配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>flushCacheIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isUseCache</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>resultHandler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 当前 statement 配置使用二级缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ensureNoOutParams</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 二级缓存中没用数据，调用代理执行器
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#8f5902;font-style:italic>// 将查询结果放入二级缓存
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// issue #578 and #116
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 无二级缓存配置，调用代理执行器获取结果
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flushCacheIfRequired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Cache</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFlushCacheRequired</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 存在 namespace 对应的缓存配置，且当前 statement 配置了刷新缓存，执行清空缓存操作
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 非 select 语句配置了默认刷新
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果对应的 <code>statement</code> 的二级缓存配置有效，则会先通过缓存事务管理器 <code>TransactionalCacheManager</code> 查询二级缓存，如果没有命中则查询一级缓存，仍没有命中才会执行数据库查询。</p>
<h3 id=缓存事务管理器>缓存事务管理器</h3>
<p>缓存执行器对二级缓存的维护是基于缓存事务管理器 <code>TransactionalCacheManager</code> 的，其内部维护了一个 <code>Map</code> 容器，用于保存 <code>namespace</code> 缓存配置与事务缓存对象的映射关系。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TransactionalCacheManager</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存配置 - 缓存事务对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionalCache</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>transactionalCaches</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 清除缓存
</span><span style=color:#8f5902;font-style:italic>   *
</span><span style=color:#8f5902;font-style:italic>   * @param cache
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取缓存
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 写缓存
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存提交
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionalCache</span> <span style=color:#000>txCache</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>transactionalCaches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>txCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 缓存回滚
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionalCache</span> <span style=color:#000>txCache</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>transactionalCaches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>txCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 获取或新建事务缓存对象
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionalCache</span> <span style=color:#000>getTransactionalCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>transactionalCaches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>computeIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionalCache</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#204a87;font-weight:700>new</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>缓存配置映射的事务缓存对象就是前文中提到过的事务缓存装饰器 <code>TransactionalCache</code>。<code>getTransactionalCache</code> 会从维护容器中查找对应的事务缓存对象，如果找不到就创建一个事务缓存对象，即通过事务缓存对象装饰当前缓存配置。</p>
<p>查询缓存时，如果缓存未命中，则将对应的 <code>key</code> 放入未命中队列，执行数据库查询完毕后写缓存时并不是立刻写到缓存配置的本地容器中，而是暂时放入待提交队列中，当触发事务提交时才将提交队列中的缓存数据写到缓存配置中。如果发生回滚，则提交队列中的数据会被清空，从而保证了数据的一致性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// issue #116
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 放入未命中缓存的 key 的队列
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>entriesMissedInCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// issue #146
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clearOnCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 缓存先写入待提交容器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>entriesToAddOnCommit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务提交
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clearOnCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 提交缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>flushPendingEntries</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务回滚
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>unlockMissedEntries</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务提交，提交待提交的缓存。
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flushPendingEntries</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entriesToAddOnCommit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getKey</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entriesMissedInCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>entriesToAddOnCommit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * 事务回滚，清理未命中缓存。
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>unlockMissedEntries</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>entriesMissedInCache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unexpected exception while notifiying a rollback to the cache adapter.&#34;</span>
            <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;Consider upgrading your cache adapter to the latest version.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=二级缓存与一级缓存的互斥性>二级缓存与一级缓存的互斥性</h3>
<p>使用二级缓存要求无论是否配置了事务自动提交，在执行完成后， <code>sql</code> 会话必须手动提交事务才能触发事务缓存管理器维护缓存到缓存配置中，否则二级缓存无法生效。而缓存执行器在触发事务提交时，不仅会调用事务缓存管理器提交，还会调用代理执行器提交事务：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 代理执行器提交
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 事务缓存管理器提交
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>tcm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代理执行器的事务提交方法继承自 <code>BaseExecutor</code>，其 <code>commit</code> 方法中调用了 <code>clearLocalCache</code> 方法清除本地一级缓存。因此二级缓存和一级缓存的使用是互斥的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cannot commit, transaction is already closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 清除本地一级缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>clearLocalCache</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>flushStatements</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>required</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=总结>总结</h2>
<p><code>MyBatis</code> 提供若干执行器封装底层 <code>JDBC</code> 操作和结果集转换，并嵌入 <code>sql</code> 会话维度的一级缓存和 <code>namespace</code> 维度的二级缓存。接口层可以通过调用不同类型的执行器来完成 <code>sql</code> 相关操作。</p>
<ul>
<li><code>org.apache.ibatis.executor.Executor</code>：数据库操作执行器抽象接口。</li>
<li><code>org.apache.ibatis.executor.BaseExecutor</code>：执行器基础抽象实现。</li>
<li><code>org.apache.ibatis.executor.SimpleExecutor</code>：简单类型执行器。</li>
<li><code>org.apache.ibatis.executor.ReuseExecutor</code>：<code>statement</code> 复用执行器。</li>
<li><code>org.apache.ibatis.executor.BatchExecutor</code>：批量执行器。</li>
<li><code>org.apache.ibatis.executor.CachingExecutor</code>：二级缓存执行器。</li>
<li><code>org.apache.ibatis.executor.statement.StatementHandler</code>：<code>statement</code> 处理器抽象接口。</li>
<li><code>org.apache.ibatis.executor.statement.BaseStatementHandler</code>：<code>statement</code> 处理器基础抽象实现。</li>
<li><code>org.apache.ibatis.executor.statement.RoutingStatementHandler</code>：<code>statement</code> 处理器路由对象。</li>
<li><code>org.apache.ibatis.executor.statement.SimpleStatementHandler</code>：简单 <code>statement</code> 处理器。</li>
<li><code>org.apache.ibatis.executor.statement.PreparedStatementHandler</code>：预编译 <code>statement</code> 处理器。</li>
<li><code>org.apache.ibatis.executor.statement.CallableStatementHandler</code>：存储过程 <code>statement</code> 处理器。</li>
<li><code>org.apache.ibatis.cache.TransactionalCacheManager</code>：缓存事务管理器。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dd0af738f6f6eeb4e6c0c4aeb3162eaa>9 - CH09-集成 Spring</h1>
<p><code>mybatis-spring</code> 是 <code>MyBatis</code> 的一个子项目，用于帮助开发者将 <code>MyBatis</code> 无缝集成到 <code>Spring</code> 中。它允许 <code>MyBatis</code> 参与到 <code>Spring</code> 的事务管理中，创建映射器 <code>mapper</code> 和 <code>SqlSession</code> 并注入到 <code>Spring bean</code> 中。</p>
<h2 id=sqlsessionfactorybean>SqlSessionFactoryBean</h2>
<p>在 <code>MyBatis</code> 的基础用法中，是通过 <code>SqlSessionFactoryBuilder</code> 来创建 <code>SqlSessionFactory</code>，最终获得执行接口 <code>SqlSession</code> 的，而在 <code>mybatis-spring</code> 中，则使用 <code>SqlSessionFactoryBean</code> 来创建。其使用方式如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Bean</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBean</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置配置文件路径
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConfigLocation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;config/mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 别名转化类所在的包
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTypeAliasesPackage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.wch.domain&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置数据源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置 mapper 文件路径
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMapperLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mapper/*.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#8f5902;font-style:italic>// 获取 SqlSessionFactory 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>SqlSessionFactoryBean</code> 实现了 <code>FactoryBean</code> 接口，因此可以通过其 <code>getObject</code> 方法获取 <code>SqlSessionFactory</code> 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;dataSource&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;sqlSessionFactoryBuilder&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!(</span><span style=color:#000>configuration</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>configLocation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>),</span>
      <span style=color:#4e9a06>&#34;Property &#39;configuration&#39; and &#39;configLocation&#39; can not specified with together&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>buildSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Configuration</span> <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>XMLConfigBuilder</span> <span style=color:#000>xmlConfigBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configuration</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 使用已配置的全局配置对象和附加属性
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>targetConfiguration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configuration</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVariables</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getVariables</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 使用配置文件路径加载全局配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>xmlConfigBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>targetConfiguration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>xmlConfigBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 新建全局配置对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Property &#39;configuration&#39; or &#39;configLocation&#39; not specified, using default MyBatis Configuration&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>targetConfiguration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configurationProperties</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setVariables</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置对象创建工厂、对象包装工厂、虚拟文件系统实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFactory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setObjectFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setObjectWrapperFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>vfs</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setVfsImpl</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 以包的维度注册别名转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliasesPackage</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 扫描之类包下的符合条件的类对象
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>scanClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliasesPackage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliasesSuperType</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#8f5902;font-style:italic>// 过滤匿名类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤成员类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isMemberClass</span><span style=color:#ce5c00;font-weight:700>()).</span>
        <span style=color:#8f5902;font-style:italic>// 注册别名转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>()::</span><span style=color:#000>registerAlias</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 以类的维度注册别名转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliases</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeAliases</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAlias</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 注册类对象到别名转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeAliasRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>registerAlias</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeAlias</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered type alias: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeAlias</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置插件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>plugins</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>plugins</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>plugin</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addInterceptor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>plugin</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered plugin: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>plugin</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 以包的维度注册类型转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlersPackage</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 扫描指定包下 TypeHandler 的子类
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>scanClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlersPackage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TypeHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span>
        <span style=color:#8f5902;font-style:italic>// 过滤匿名类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymousClass</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#8f5902;font-style:italic>// 过滤抽象类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAbstract</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()))</span>
        <span style=color:#8f5902;font-style:italic>// 注册类对象到类型转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>()::</span><span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 以类的维度注册类型转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>typeHandlers</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 注册类对象到类型转换器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTypeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered type handler: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>typeHandler</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 注册脚本语言驱动
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scriptingLanguageDrivers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scriptingLanguageDrivers</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>languageDriver</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLanguageRegistry</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>languageDriver</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Registered scripting language driver: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>languageDriver</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultScriptingLanguageDriver</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>setDefaultScriptingLanguage</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 配置数据库产品识别转换器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>databaseIdProvider</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// fix #64 set databaseId before parse mapper xmls
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>databaseIdProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDatabaseId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedIOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed getting a databaseId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置缓存配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ofNullable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cache</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>ifPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>addCache</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 如果设置了配置文件路径，则解析并加载到全局配置中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xmlConfigBuilder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>xmlConfigBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Parsed configuration file: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedIOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to parse config resource: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configLocation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置数据源环境
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>environment</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpringManagedTransactionFactory</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#8f5902;font-style:italic>// 解析 xml statement 文件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperLocations</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperLocations</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Property &#39;mapperLocations&#39; was specified but matching resources are not found.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Resource</span> <span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperLocations</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>XMLMapperBuilder</span> <span style=color:#000>xmlMapperBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLMapperBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperLocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>(),</span>
              <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapperLocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlFragments</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>xmlMapperBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NestedIOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failed to parse mapping resource: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Parsed mapper file: &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>mapperLocation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Property &#39;mapperLocations&#39; was not specified.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 创建 sql 会话工厂
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetConfiguration</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>buildSqlSessionFactory</code> 方法会分别对配置文件、别名转换类、<code>mapper</code> 文件等进行解析，逐步配置全局配置对象，并最终调用 <code>SqlSessionFactoryBuilder</code> 创建 <code>SqlSessionFactory</code> 对象。</p>
<h2 id=sqlsessiontemplatge>SqlSessionTemplatge</h2>
<p>在前章分析 <code>MyBatis</code> 接口层时说到 <code>SqlSessionManager</code> 通过 <code>JDK</code> 动态代理为每个线程创建不同的 <code>SqlSession</code> 来解决 <code>DefaultSqlSession</code> 的线程不安全问题。<code>mybatis-spring</code> 的实现与 <code>SqlSessionManager</code> 大致相同，但是其提供了更好的方式与 <code>Spring</code> 事务集成。</p>
<p><code>SqlSessionTemplate</code> 实现了 <code>SqlSession</code> 接口，但是都是委托给成员对象 <code>sqlSessionProxy</code> 来实现的。<code>sqlSessionProxy</code> 在构造方法中使用 <code>JDK</code> 动态代理初始化为代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutorType</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>PersistenceExceptionTranslator</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;sqlSessionFactory&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Property &#39;executorType&#39; is required&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionProxy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>newProxyInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(),</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>SqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span> <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionInterceptor</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>sqlSessionProxy</code> 的代理逻辑如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SqlSessionInterceptor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>InvocationHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>proxy</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 获取 sqlSession
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 执行原始调用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isSqlSessionTransactional</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 如果事务没有交给外部事务管理器管理，进行提交
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Throwable</span> <span style=color:#000>unwrapped</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unwrapThrowable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>unwrapped</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>PersistenceException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 异常为 PersistenceException，使用配置的 exceptionTranslator 来包装异常
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>closeSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#000>Throwable</span> <span style=color:#000>translated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionTranslator</span>
              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>translateExceptionIfPossible</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>PersistenceException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>unwrapped</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>translated</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>unwrapped</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>translated</span><span style=color:#ce5c00;font-weight:700>;</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>unwrapped</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#8f5902;font-style:italic>// 关闭 sql session
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>closeSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=获取-sqlsession>获取 SqlSession</h3>
<p>在执行原始调用前会先根据 <code>SqlSessionUtils#getSqlSession</code> 方法获取 <code>SqlSession</code>，如果通过事务同步管理器 <code>TransactionSynchronizationManager</code> 获取不到 <code>SqlSession</code>，就会使用 <code>SqlSessionFactory</code> 新建一个 <code>SqlSession</code>，并尝试将获取的 <code>SqlSession</code> 注册到 <code>TransactionSynchronizationManager</code> 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SqlSession</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutorType</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>PersistenceExceptionTranslator</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// SqlSessionFactory 和 ExecutorType 参数不可为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_SQL_SESSION_FACTORY_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_EXECUTOR_TYPE_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 尝试从事务同步管理器中获取 SqlSessionHolder
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSessionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionHolder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>TransactionSynchronizationManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取 SqlSession
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSession</span> <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sessionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 新建 SqlSession
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Creating a new SqlSession&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 将新建的 SqlSession 注册到事务同步管理器中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>registerSessionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=事务同步管理器>事务同步管理器</h4>
<p>每次获取 <code>SqlSession</code> 时是新建还是从事务同步管理器中获取决于事务同步管理器是否开启。事务同步管理器用于维护当前线程的同步资源，如判断当前线程是否已经开启了一个事务就需要查询事务同步管理器，以便后续根据事务传播方式决定是新开启一个事务或加入当前事务。<code>Spring</code> 支持使用注解开启事务或编程式事务。</p>
<h5 id=注解开启事务>注解开启事务</h5>
<p>在 <code>Spring</code> 工程中可以通过添加 <code>EnableTransactionManagement</code> 注解来开启 <code>Spring</code> 事务管理。<code>EnableTransactionManagement</code> 注解的参数 <code>mode = AdviceMode.PROXY</code> 默认指定了加载代理事务管理器配置 <code>ProxyTransactionManagementConfiguration</code>，在此配置中其默认地对使用 <code>Transactional</code> 注解的方法进行 <code>AOP</code> 代理。在代理逻辑中，会调用 <code>AbstractPlatformTransactionManager#getTransaction</code> 方法获取当前线程对应的事务，根据当前线程是否有活跃事务、事务传播属性等来配置事务。如果是新创建事务，就会调用 <code>TransactionSynchronizationManager#initSynchronization</code> 方法来初始化当前线程在事务同步管理器中的资源。</p>
<h5 id=编程式事务>编程式事务</h5>
<p>编程开启事务的方式与注解式其实是一样的，区别在于编程式需要手动开启事务，其最终也会为当前线程在事务同步管理器中初始化资源。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// 手动开启事务
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>TransactionStatus</span> <span style=color:#000>txStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultTransactionDefinition</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// invoke...
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>transactionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>transactionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=sqlsession-注册>SqlSession 注册</h4>
<p>如果当前方法开启了事务，那么创建的 <code>SqlSession</code> 就会被注册到事务同步管理器中。<code>SqlSession</code> 会首先被包装为 <code>SqlSessionHolder</code>，其还包含了 <code>SqlSession</code> 对应的执行器类型、异常处理器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionHolder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptionTranslator</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>TransactionSynchronizationManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bindResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#8f5902;font-style:italic>// ...
</span></code></pre></div><p>随后 <code>SqlSessionHolder</code> 对象通过 <code>TransactionSynchronizationManager#bindResource</code> 方法绑定到事务同步管理器中，其实现为将 <code>SqlSessionFactory</code> 和 <code>SqlSessionHolder</code> 绑定到 <code>ThreadLocal</code> 中，从而完成了线程到 <code>SqlSessionFactory</code> 到 <code>SqlSession</code> 的映射。</p>
<h3 id=事务提交与回滚>事务提交与回滚</h3>
<p>如果事务是交给 <code>Spring</code> 事务管理器管理的，那么<code>Spring</code> 会自动在执行成功或异常后对当前事务进行提交或回滚。如果没有配置 <code>Spring</code> 事务管理，那么将会调用 <code>SqlSession</code> 的 <code>commit</code> 方法对事务进行提交。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isSqlSessionTransactional</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 未被事务管理器管理，设置提交
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>而 <code>SqlSessionTemplate</code> 是不允许用来显式地提交或回滚的，其提交或回滚的方法实现为直接抛出 <code>UnsupportedOperationException</code> 异常。</p>
<h3 id=关闭-sqlsession>关闭 SqlSession</h3>
<p>在当前调用结束后 <code>SqlSessionTemplate</code> 会调动 <code>closeSqlSession</code> 方法来关闭 <code>SqlSession</code>，如果事务同步管理器中存在当前线程绑定的 <code>SqlSessionHolder</code>，即当前调用被事务管理器管理，则将 <code>SqlSession</code> 的持有释放掉。如果没被事务管理器管理，则会真实地关闭 <code>SqlSession</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeSqlSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_SQL_SESSION_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NO_SQL_SESSION_FACTORY_SPECIFIED</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>SqlSessionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionHolder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>TransactionSynchronizationManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 被事务管理器管理，释放 SqlSession
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Releasing transactional SqlSession [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>released</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 真实地关闭 SqlSesion
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Closing non transactional SqlSession [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=映射器>映射器</h2>
<h3 id=单个映射器>单个映射器</h3>
<p>在 <code>MyBatis</code> 的基础用法中，<code>MyBatis</code> 配置文件支持使用 <code>mappers</code> 标签的子元素 <code>mapper</code> 或 <code>package</code> 来指定需要扫描的 <code>mapper</code> 接口。被扫描到的接口类将被注册到 <code>MapperRegistry</code> 中，通过 <code>MapperRegistry#getMapper</code> 方法可以获得 <code>Mapper</code> 接口的代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapperProxyFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>knownMappers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapperProxyFactory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Type &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; is not known to the MapperRegistry.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 生成 mapper 接口的代理类
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mapperProxyFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BindingException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error getting mapper instance. Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过代理类的方式可以使得 <code>statement</code> 的 <code>id</code> 直接与接口方法的全限定名关联，消除了 <code>mapper</code> 接口实现类的样板代码。但是此种方式在每次获取 <code>mapper</code> 代理类的时候都需要指定 <code>sqlSession</code> 对象，而 <code>mybatis-spring</code> 中的 <code>sqlSession</code> 对象是 <code>SqlSessionTemplate</code> 代理创建的，为了适配代理逻辑，<code>mybatis-spring</code> 提供了 <code>MapperFactoryBean</code> 来创建代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Bean</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserMapper</span> <span style=color:#000>userMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>MapperFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserMapper</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>factoryBean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapperFactoryBean</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>UserMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>factoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factoryBean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>MapperFactoryBean</code> 继承了 <code>SqlSessionDaoSupport</code>，其会根据传入的 <code>SqlSessionFactory</code> 来创建 <code>SqlSessionTemplate</code>，并使用 <code>SqlSessionTemplate</code> 来生成代理类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 使用 SqlSessionTemplate 来创建代理类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperInterface</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSession</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=批量映射器>批量映射器</h3>
<p>每次手动获取单个映射器的效率是低下的，<code>MyBatis</code> 还提供了 <code>MapperScan</code> 注解用于批量扫描 <code>mapper</code> 接口并通过 <code>MapperFactoryBean</code> 创建代理类，注册为 <code>Spring bean</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.spring.sample.mapper&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppConfig</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>MapperScan</code> 注解解析后注册 <code>Spring bean</code> 的逻辑是由 <code>MapperScannerConfigure</code> 实现的，其实现 了 <code>BeanDefinitionRegistryPostProcessor</code> 接口的 <code>postProcessBeanDefinitionRegistry</code> 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postProcessBeanDefinitionRegistry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionRegistry</span> <span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#000>ClassPathMapperScanner</span> <span style=color:#000>scanner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassPathMapperScanner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>scanner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scan</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tokenizeToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>basePackage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ConfigurableApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONFIG_LOCATION_DELIMITERS</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扫描逻辑由 <code>ClassPathMapperScanner</code> 提供，其继承了 <code>ClassPathBeanDefinitionScanner</code> 扫描指定包下的类并注册为 <code>BeanDefinitionHolder</code> 的能力。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>beanCountAtScanStart</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// 扫描指定包并注册 bean definion
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>

		<span style=color:#8f5902;font-style:italic>// Register annotation config processors, if necessary.
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>includeAnnotationConfig</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#000>AnnotationConfigUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerAnnotationConfigProcessors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinitionCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>beanCountAtScanStart</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 扫描指定包已经获取的 bean 定义
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefinitions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>warn</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;No MyBatis mapper was found in &#39;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span><span style=color:#ce5c00;font-weight:700>)</span>
          <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; package. Please check your configuration.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// 增强 bean 配置
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>processBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processBeanDefinitions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BeanDefinitionHolder</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>GenericBeanDefinition</span> <span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BeanDefinitionHolder</span> <span style=color:#000>holder</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>beanDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>definition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GenericBeanDefinition</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>holder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBeanDefinition</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// 设置 bean class 类型为 MapperFactoryBean
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>definition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBeanClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapperFactoryBeanClass</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>获取到指定 <code>bean</code> 的定义后，重新设置 <code>beanClass</code> 为 <code>MapperFactoryBean</code>，因此在随后的 <code>bean</code> 初始化中，这些被扫描的 <code>mapper</code> 接口可以创建代理类并被注册到 <code>Spring</code> 容器中。</p>
<p>映射器注册完成后，就可以使用引用 <code>Spring bean</code> 的配置来使用 <code>mapper</code> 接口。</p>
<h2 id=总结>总结</h2>
<p><code>mybatis-spring</code> 提供了与 <code>Spring</code> 集成的更高层次的封装。</p>
<ul>
<li><code>SqlSessionFactoryBean</code> 遵循 <code>Spring FactoryBean</code> 的定义，使得 <code>SqlSessionFactory</code> 注册在 <code>Spring</code> 容器中。</li>
<li><code>SqlSessionTemplate</code> 是 <code>SqlSession</code> 另一种线程安全版本的实现，并且能够更好地与 <code>Spring</code> 事务管理集成。</li>
<li><code>MapperFactoryBean</code> 是生成 <code>mapper</code> 接口代理类的 <code>SqlSessionTemplate</code> 版本实现。</li>
<li><code>MapperScannerConfigurer</code> 简化了生成 <code>mapper</code> 接口代理的逻辑，指定扫描的包即可将生成 <code>mapper</code> 接口代理类并注册为 <code>Spring bean</code>。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-08516932d642ae0a720b5753a346bba3>10 - CH10-整体流程</h1>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/iShot2021-10-10%2016.22.29.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=1-通过-resource-加载配置>1. 通过 Resource 加载配置</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.io.Resources</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.session.SqlSession</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.session.SqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.session.SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyBatisUtils</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>String</span> <span style=color:#000>resource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>SqlSession</span> <span style=color:#000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=2-实例化-sqlsessionfactorybuilder-构造器>2. 实例化 sqlSessionFactoryBuilder 构造器</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sqlSessionFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h2 id=3-通过-build-中-xmlconfigbuilder-类解析文件流以及环境和属性>3. 通过 build 中 XmlConfigBuilder 类解析文件流以及环境和属性</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>XMLConfigBuilder</span> <span style=color:#000>parser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>XMLConfigBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><h2 id=4-将配置信息存放到-configuration-中>4. 将配置信息存放到 Configuration 中</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Configuration</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=5-实例化-sqlsessionfactory-实现类-defaultsqlsessionfactory>5. 实例化 SqlSessionFactory 实现类 DefaultSqlSessionFactory</h2>
<h2 id=6-由-transactionfactory-创建一个-transaction-事务对象>6. 由 TransactionFactory 创建一个 Transaction 事务对象</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010162704.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=7-创建执行器-excutor执行-mapper>7. 创建执行器 Excutor，执行 mapper</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010162729.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=8-创建-sqlsession-接口实现类-defaultsqlsession>8. 创建 SqlSession 接口实现类 DefaultSqlSession</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MybatisUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSqlSession</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#000>UserMapper</span> <span style=color:#000>mapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h2 id=9-执行-crud>9. 执行 CRUD</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211010162814.png style=display:block;width:70% alt=NAME align=center> </div>
<h2 id=10-判断是否成功失败则回滚到事务提交器>10. 判断是否成功，失败则回滚到事务提交器</h2>
<h2 id=11-提交事务>11. 提交事务</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h2 id=12-关闭>12. 关闭</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-14222f79d12931239488c3ab405189f6>11 - CH11-插件机制</h1>
<p><code>MyBatis</code>支持用插件对四大核心组件进行拦截，对<code>MyBatis</code>来说插件就是拦截器，用来增强核心组件的功能，增强功能本质上是借助于底层的动态代理实现的，换句话说，<code>MyBatis</code>中的四大对象都是代理对象。</p>
<ul>
<li><code>Executor</code>：用于执行增删改查操作的执行器类</li>
<li><code>StatementHandler</code>：处理数据库SQL语句的类</li>
<li><code>ParameterHandler</code>：处理SQL的参数的类</li>
<li><code>ResultSetHandler</code>：处理SQL的返回结果集的类</li>
</ul>
<p>以下是这四种处理各自能够拦截的方法：</p>
<table>
<thead>
<tr>
<th>对象</th>
<th>描述</th>
<th>可拦截方法</th>
<th>方法作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>Executor</td>
<td>上层对象，包含 SQL 执行全过程</td>
<td>update</td>
<td>执行 update/insert/delete</td>
</tr>
<tr>
<td></td>
<td></td>
<td>query</td>
<td>执行 query</td>
</tr>
<tr>
<td></td>
<td></td>
<td>flushStatements</td>
<td>在 commit 时自动调用，SimpleExecutor/ReuseExecutor/BatchExecutor 处理不同</td>
</tr>
<tr>
<td></td>
<td></td>
<td>commit</td>
<td>提交事务</td>
</tr>
<tr>
<td></td>
<td></td>
<td>rollback</td>
<td>回滚事务</td>
</tr>
<tr>
<td></td>
<td></td>
<td>getTransaction</td>
<td>获取事务</td>
</tr>
<tr>
<td></td>
<td></td>
<td>close</td>
<td>结束事务</td>
</tr>
<tr>
<td></td>
<td></td>
<td>isClosed</td>
<td>判断事务是否关闭</td>
</tr>
<tr>
<td>StatementHandler</td>
<td>执行 SQL 的过程，常用拦截对象</td>
<td>prepare</td>
<td>SQL 预编译</td>
</tr>
<tr>
<td></td>
<td></td>
<td>parameterize</td>
<td>设置 SQL 参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>batch</td>
<td>批处理</td>
</tr>
<tr>
<td></td>
<td></td>
<td>update</td>
<td>增删改操作</td>
</tr>
<tr>
<td></td>
<td></td>
<td>query</td>
<td>查询操作</td>
</tr>
<tr>
<td>ParameterHandler</td>
<td>SQL 参数组装过程</td>
<td>getParameterObject</td>
<td>获取参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>setParameters</td>
<td>设置参数</td>
</tr>
<tr>
<td>ResultSetHandler</td>
<td>执行 SQL 结果的组装</td>
<td>handleResultSets</td>
<td>处理结果集</td>
</tr>
<tr>
<td></td>
<td></td>
<td>handleOutputParameters</td>
<td>处理存储过程出参</td>
</tr>
</tbody>
</table>
<h2 id=插件原理>插件原理</h2>
<ol>
<li><code>MyBatis</code>的插件借助于<strong>责任链</strong>的模式进行对拦截的处理</li>
<li>使用<code>动态代理</code>对目标对象进行包装，达到拦截的目的</li>
</ol>
<h2 id=拦截>拦截</h2>
<p>插件具体是如何拦截并附加额外的功能的呢？以<code>ParameterHandler</code>来说：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ParameterHandlernewParameterHandler</span><span style=color:#ce5c00;font-weight:700>(</span>
  	<span style=color:#000>MappedStatement</span> <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span>
  	<span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span>
  	<span style=color:#000>BoundSql</span> <span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>,</span>
  	<span style=color:#000>InterceptorChain</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>){</span>
	<span style=color:#000>ParameterHandler</span> <span style=color:#000>parameterHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLang</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>createParameterHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mappedStatement</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>sql</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#000>parameterHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ParameterHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parameterHandler</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Objecttarget</span><span style=color:#ce5c00;font-weight:700>){</span>
	<span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Interceptorinterceptor</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>interceptors</span><span style=color:#ce5c00;font-weight:700>){</span>
		<span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>interceptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>plugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>interceptorChain</code>保存了所有的拦截器(interceptors)，是<code>MyBatis</code>初始化的时候创建的。</p>
<p>调用拦截器链中的拦截器依次的对目标进行拦截或增强。</p>
<p><code>interceptor.plugin(target)</code> 中的 target 就可以理解为<code>MyBatis</code>中的四大组件，返回的target是被重重代理后的对象。</p>
<h2 id=插件接口interceptor>插件接口Interceptor</h2>
<ol>
<li><code>intercept()</code>方法，插件的核心方法</li>
<li><code>plugin()</code>方法，生成target的代理对象</li>
<li><code>setProperties()</code>方法，传递插件所需参数</li>
</ol>
<h2 id=插件实例>插件实例</h2>
<p>插件开发需要以下步骤</p>
<ol>
<li>自定义插件需要实现上述接口</li>
<li>增加@Intercepts注解（声明是哪个核心组件的插件，以及对哪些方法进行扩展）</li>
<li>在xml文件中配置插件</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>**</span>
<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>插件签名</span><span style=color:#a40000>，</span><span style=color:#000>告诉MyBatis插件用来拦截那个对象的哪个方法</span>
<span style=color:#ce5c00;font-weight:700>**/</span>
<span style=color:#5c35cc;font-weight:700>@Intercepts</span><span style=color:#ce5c00;font-weight:700>({</span>
	<span style=color:#5c35cc;font-weight:700>@Signature</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>StatementHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;parameterize&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyInterceptsimplementsInterceptor</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>  *拦截目标对象的目标方法
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  *@paraminvocation
</span><span style=color:#8f5902;font-style:italic>  *@return
</span><span style=color:#8f5902;font-style:italic>  *@throwsThrowable
</span><span style=color:#8f5902;font-style:italic>  */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;进入自定义的拦截器，拦截目标对象&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTarget</span><span style=color:#ce5c00;font-weight:700>());</span>
  	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>proceed</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>  *包装目标对象为目标对象创建代理对象
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  *@Paramtarget为要拦截的对象
</span><span style=color:#8f5902;font-style:italic>  *@Return代理对象
</span><span style=color:#8f5902;font-style:italic>  */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>plugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>){</span>
  	<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;自定义plugin方法，将要包装的目标对象&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>
  	<span style=color:#000>returnPlugin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>  *获取配置文件的属性
</span><span style=color:#8f5902;font-style:italic>  *
</span><span style=color:#8f5902;font-style:italic>  *@paramproperties
</span><span style=color:#8f5902;font-style:italic>  */</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>){</span>
  	<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;自定义插件的初始化参数&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在mybatis-config.xml中配置插件</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>    <span style=color:#8f5902;font-style:italic>&lt;!--自定义插件--&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;plugininterceptor</span><span style=color:#a40000>=&#34;com.boxuegu.javaee.mybatissourcelearn.MyIntercepts&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
		<span style=color:#204a87;font-weight:700>&lt;propertyname</span><span style=color:#a40000>=&#34;test&#34;</span><span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;testvalue&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</code></pre></div><p>调用查询方法，查询方法会返回ResultSet</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#8f5902;font-style:italic>//1.加载配置文件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;mybatis-config.xml&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>InputStream</span> <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Resources</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOExceptione</span><span style=color:#ce5c00;font-weight:700>){</span>
    	<span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
  	<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//2.获取sqlSessionFactory
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>=</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>//3.获取sqlSession
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SqlSession</span> <span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>//通过xml文件直接执行sql语句
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//Employeeemployee=sqlSession.selectOne(&#34;com.boxuegu.javaee.mybatissourcelearn.dao.EmployeeMapper.getEmployeeById&#34;,1);
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//alt+shift+Lintroducelocalvariables;
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>newThread</span><span style=color:#ce5c00;font-weight:700>(()-&gt;</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
      <span style=color:#8f5902;font-style:italic>//4.获取mapper接口实现
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>EmployeeMapper</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmployeeMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mapper::::&#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>());</span>

      <span style=color:#8f5902;font-style:italic>//5.执行sql语句
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>Employee</span> <span style=color:#000>employee</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEmployeeById</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>employee</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>finally</span><span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>sqlSession</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=分页插件>分页插件</h2>
<p>MyBatis 自带的 RowBounds 是一次查询所有结果，然后再内存中计算并提取分页，最终返回指定页数的数据。</p>
<p>这种分页方式对于数据量小的还好，如果数据量大就有很大性能影响了。因为这种方式是将数据全部查询出来放到内存里，再进行分页长度的截取，是一种伪分页，是一种逻辑分页。</p>
<p>因此通常会使用 PageHelper 插件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>com.github.pagehelper<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>pagehelper<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>5.3.0<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>在 mybatis-config.xml 中配置插件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
	<span style=color:#204a87;font-weight:700>&lt;plugininterceptor</span><span style=color:#a40000>=&#34;com.github.pagehelper.PageInterceptor&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</code></pre></div><p>执行分页查询：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>PageHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>startPage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>/*pageNum*/</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#8f5902;font-style:italic>/*pageSize*/</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>users</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findAll</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>PageInfo</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pageInfo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PageInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// return pageInfo to controller
</span></code></pre></div><h3 id=实现原理>实现原理</h3>
<p><code>PageHelper</code>是利用Mybatis的插件原理，对<code>Executor</code>接口的<code>query</code>方法进行了拦截。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Intercepts</span><span style=color:#ce5c00;font-weight:700>({</span>
	<span style=color:#5c35cc;font-weight:700>@Signature</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;query&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>MappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>}),</span>
	<span style=color:#5c35cc;font-weight:700>@Signature</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;query&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>MappedStatement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ResultHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CacheKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>}),</span>
<span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PageInterceptor</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Interceptor</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在创建<code>Executor</code>时，如果有插件对<code>Executor</code>进行拦截，则会对<code>Executor</code>对象生成代理，在执行相对应的方法时进行增强处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Executor</span> <span style=color:#000>newExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Transaction</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutorType</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>defaultExecutorType</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIMPLE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Executor</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 根据数据库操作类型创建市级执行器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BATCH</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BatchExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REUSE</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>executorType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReuseExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>transaction</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 根据配置文件中的 settings 节点cacheEnabled配置项确定是否启用缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheEnabled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 如果配置启用该缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 使用CachingExecutor装饰实际的执行器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CachingExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 为执行器增加拦截器（插件），以启用各个拦截器的功能
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>interceptorChain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pluginAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当程序走到<code>DefaultSqlSession</code>中时，会调用<code>Executor</code>的query方法，此时就会触发<code>PageHelper</code>的代理，进入<code>PageHelper</code>的逻辑：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * 获取查询语句
</span><span style=color:#8f5902;font-style:italic>         * 设置MappedStatement映射，见{@link XMLStatementBuilder#parseStatementNode()}
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMappedStatement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>         * 交由执行器进行查询，由于全局配置cacheEnabled默认是打开的，因此此处的executor通常都是CachingExecutor
</span><span style=color:#8f5902;font-style:italic>         * 获取executor，见{@link Configuration#newExecutor(org.apache.ibatis.transaction.Transaction, org.apache.ibatis.session.ExecutorType)}
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrapCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NO_RESULT_HANDLER</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ExceptionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error querying database.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ErrorContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>instance</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>PageHelper</code>拦截器<code>PageInterceptor</code>执行流程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Invocation</span> <span style=color:#000>invocation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#8f5902;font-style:italic>//调用方法判断是否需要进行分页，如果不需要，直接返回结果
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>dialect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//判断是否需要进行count查询
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dialect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>beforeCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//查询总数
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Long</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//处理查询总数，返回true时继续分页查询，false时直接返回
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>dialect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//当查询总数为0时，直接返回空的结果
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dialect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterPage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          	<span style=color:#8f5902;font-style:italic>// 生成不同方言对应的分页 SQL 并执行
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>resultList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ExecutorUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pageQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dialect</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//rowBounds有参数值，不使用分页插件处理时，仍然支持默认的内存分页
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>resultList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>query</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 将查询结果设置到Page对象中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dialect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterPage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resultList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameter</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dialect</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#000>dialect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterAll</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>ExecutorUtil.pageQuery</code>主要是基于不同的数据库方言生成分页查询 SQL，比如最简单的是在原 SQL 后追加 <code>LIMIT ? OFFSET ?</code>。</p>
<h2 id=多插件开发>多插件开发</h2>
<ol>
<li>创建代理对象时，按照插件配置的顺序进行包装</li>
<li>执行目标方法后，是按照代理的逆向进行执行</li>
</ol>
<h2 id=总结>总结</h2>
<p>1.遵循插件尽量不使用的原则，因为会修改底层设计</p>
<p>2.插件是生成的层层代理对象的责任链模式，使用反射机制实现</p>
<p>3.插件的编写要考虑全面，特别是多个插件层层代理的时候</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-68611e2d64eb5f1709d53542acbd61f4>12 - CH12-代码生成</h1>
<h2 id=运行方式>运行方式</h2>
<p><code>Mybatis-Generator</code>的运行方式有很多种：</p>
<ul>
<li>基于<code>mybatis-generator-core-x.x.x.jar</code>和其<code>XML</code>配置文件，通过命令行运行。</li>
<li>通过<code>Ant</code>的<code>Task</code>结合其<code>XML</code>配置文件运行。</li>
<li>通过<code>Maven</code>插件运行。</li>
<li>通过<code>Java</code>代码和其<code>XML</code>配置文件运行。</li>
<li>通过<code>Java</code>代码和编程式配置运行。</li>
<li>通过<code>Eclipse Feature</code>运行。</li>
</ul>
<p>这里只介绍通过<code>Maven</code>插件运行和通过<code>Java</code>代码和其<code>XML</code>配置文件运行这两种方式，两种方式有个特点：都要提前编写好<code>XML</code>配置文件。个人感觉<code>XML</code>配置文件相对直观，后文会花大量篇幅去说明<code>XML</code>配置文件中的配置项及其作用。这里先注意一点：默认的配置文件为<code>ClassPath:generatorConfig.xml</code>。</p>
<h3 id=通过编码和配置文件运行>通过编码和配置文件运行</h3>
<p>通过编码方式去运行插件先需要引入<code>mybatis-generator-core</code>依赖，编写本文的时候最新的版本为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.mybatis.generator<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>mybatis-generator-core<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.4.0<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>假设编写好的<code>XML</code>配置文件是<code>ClassPath</code>下的<code>generator-configuration.xml</code>，那么使用代码生成器的编码方式大致如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>warnings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#8f5902;font-style:italic>// 如果已经存在生成过的文件是否进行覆盖
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>overwrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>File</span> <span style=color:#000>configFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ClassPath路径/generator-configuration.xml&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ConfigurationParser</span> <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Configuration</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configFile</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>DefaultShellCallback</span> <span style=color:#000>callback</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultShellCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overwrite</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>MyBatisGenerator</span> <span style=color:#000>generator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyBatisGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>callback</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h3 id=通过-maven-插件运行>通过 Maven 插件运行</h3>
<p>如果使用<code>Maven</code>插件，那么<strong>不需要</strong>引入<code>mybatis-generator-core</code>依赖，只需要引入一个<code>Maven</code>的插件<code>mybatis-generator-maven-plugin</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;plugins&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;plugin&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.mybatis.generator<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>mybatis-generator-maven-plugin<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.4.0<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;executions&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;execution&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>Generate MyBatis Artifacts<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;goals&gt;</span>
                    <span style=color:#204a87;font-weight:700>&lt;goal&gt;</span>generate<span style=color:#204a87;font-weight:700>&lt;/goal&gt;</span>
                <span style=color:#204a87;font-weight:700>&lt;/goals&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;/execution&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/executions&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;configuration&gt;</span>
            <span style=color:#8f5902;font-style:italic>&lt;!-- 输出详细信息 --&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;verbose&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/verbose&gt;</span>
            <span style=color:#8f5902;font-style:italic>&lt;!-- 覆盖生成文件 --&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;overwrite&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/overwrite&gt;</span>
            <span style=color:#8f5902;font-style:italic>&lt;!-- 定义配置文件 --&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;configurationFile&gt;</span>${basedir}/src/main/resources/generator-configuration.xml<span style=color:#204a87;font-weight:700>&lt;/configurationFile&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/configuration&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/plugin&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/plugins&gt;</span>
</code></pre></div><h2 id=xml-配置详解>XML 配置详解</h2>
<p><code>XML</code>配置文件才是<code>Mybatis-Generator</code>的核心，它用于控制代码生成的所有行为。所有非标签独有的公共配置的<code>Key</code>可以在<code>mybatis-generator-core</code>的<code>PropertyRegistry</code>类中找到。下面是一个相对完整的配置文件的模板：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!DOCTYPE generatorConfiguration
</span><span style=color:#8f5902;font-style:italic>  PUBLIC &#34;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&#34;
</span><span style=color:#8f5902;font-style:italic>  &#34;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&#34;&gt;</span>

<span style=color:#204a87;font-weight:700>&lt;generatorConfiguration&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;properties</span> <span style=color:#c4a000>resource=</span><span style=color:#4e9a06>&#34;db.properties&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;classPathEntry</span> <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;/Program Files/IBM/SQLLIB/java/db2java.zip&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;DB2Tables&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;jdbcConnection</span> <span style=color:#c4a000>driverClass=</span><span style=color:#4e9a06>&#34;COM.ibm.db2.jdbc.app.DB2Driver&#34;</span>
        <span style=color:#c4a000>connectionURL=</span><span style=color:#4e9a06>&#34;jdbc:db2:TEST&#34;</span>
        <span style=color:#c4a000>userId=</span><span style=color:#4e9a06>&#34;db2admin&#34;</span>
        <span style=color:#c4a000>password=</span><span style=color:#4e9a06>&#34;db2admin&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/jdbcConnection&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;plugin</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;org.mybatis.generator.plugins.SerializablePlugin&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;commentGenerator&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressDate&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressAllComments&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/commentGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;javaTypeResolver&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;forceBigDecimals&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/javaTypeResolver&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;javaModelGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;test.model&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;\MBGTestProject\src&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;trimStrings&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/javaModelGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;sqlMapGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;test.xml&#34;</span>  <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;\MBGTestProject\src&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/sqlMapGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;XMLMAPPER&#34;</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;test.dao&#34;</span>  <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;\MBGTestProject\src&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/javaClientGenerator&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;table</span> <span style=color:#c4a000>schema=</span><span style=color:#4e9a06>&#34;DB2ADMIN&#34;</span> <span style=color:#c4a000>tableName=</span><span style=color:#4e9a06>&#34;ALLTYPES&#34;</span> <span style=color:#c4a000>domainObjectName=</span><span style=color:#4e9a06>&#34;Customer&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;useActualColumnNames&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;generatedKey</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;ID&#34;</span> <span style=color:#c4a000>sqlStatement=</span><span style=color:#4e9a06>&#34;DB2&#34;</span> <span style=color:#c4a000>identity=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;columnOverride</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;DATE_FIELD&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;startDate&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;ignoreColumn</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;FRED&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
      <span style=color:#204a87;font-weight:700>&lt;columnOverride</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;LONG_VARCHAR_FIELD&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/table&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;/context&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/generatorConfiguration&gt;</span>
</code></pre></div><p>配置文件中，最外层的标签为<code>&lt;generatorConfiguration></code>，它的子标签包括：</p>
<ul>
<li>0或者1个<code>&lt;properties></code>标签，用于指定全局配置文件，下面可以通过占位符的形式读取<code>&lt;properties></code>指定文件中的值。</li>
<li>0或者N个<code>&lt;classPathEntry></code>标签，<code>&lt;classPathEntry></code>只有一个<code>location</code>属性，用于指定数据源驱动包（<code>jar</code>或者<code>zip</code>）的绝对路径，具体选择什么驱动包取决于连接什么类型的数据源。</li>
<li>1或者N个<code>&lt;context></code>标签，用于运行时的解析模式和具体的代码生成行为，所以这个标签里面的配置是最重要的。</li>
</ul>
<p>下面分别列举和分析一下<code>&lt;context></code>标签和它的主要子标签的一些属性配置和功能。</p>
<h3 id=context-标签>context 标签</h3>
<p><code>&lt;context></code>标签在<code>mybatis-generator-core</code>中对应的实现类为<code>org.mybatis.generator.config.Context</code>，它除了大量的子标签配置之外，比较主要的属性是：</p>
<ul>
<li><code>id</code>：<code>Context</code>示例的唯一<code>ID</code>，用于输出错误信息时候作为唯一标记。</li>
<li><code>targetRuntime</code>：用于执行代码生成模式。</li>
<li><code>defaultModelType</code>：控制 Domain 类的生成行为。执行引擎为 MyBatis3DynamicSql 或者 MyBatis3Kotlin 时忽略此配置，可选值：
<ul>
<li><code>conditional</code>：默认值，类似<code>hierarchical</code>，但是只有一个主键的时候会合并所有属性生成在同一个类。</li>
<li><code>flat</code>：所有内容全部生成在一个对象中。</li>
<li><code>hierarchical</code>：键生成一个XXKey对象，Blob等单独生成一个对象，其他简单属性在一个对象中。</li>
</ul>
</li>
<li><code>targetRuntime</code>属性的可选值比较多，这里做个简单的小结：</li>
</ul>
<p>属性：</p>
<ul>
<li>MyBatis3DynamicSql：默认值，兼容 JDK8+ 和 MyBatis 3.4.2+，不会生成 XML 映射文件，忽略 <code>&lt;sqlMapGenerator></code> 的配置项，也就是 Mapper 全部注解化，依赖于 MyBatis Dynamic SQL 类库。</li>
<li>MyBatis3Kotlin：行为类似于 MyBatis3DynamicSql，不过兼容 Kotlin 的代码生成。</li>
<li>MyBatis3：提供基本的基于动态 SQL 的 CRUD 方法和 XXXByExample 方法，会生成 XML 映射文件。</li>
<li>MyBatis3Simple：提供基本的基于动态 SQL 的 CRUD 方法，会生成 XML 映射文件。</li>
<li>MyBatis3DynamicSqlV1：已经过时，不推荐使用。</li>
</ul>
<p>笔者偏向于把<code>SQL</code>文件和代码分离，所以一般选用<code>MyBatis3</code>或者<code>MyBatis3Simple</code>。例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div><p><code>&lt;context></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>autoDelimitKeywords</code></td>
<td style=text-align:left>是否使用分隔符号括住数据库关键字</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>例如<code>MySQL</code>中会使用反引号括住关键字</td>
</tr>
<tr>
<td style=text-align:left><code>beginningDelimiter</code></td>
<td style=text-align:left>分隔符号的开始符号</td>
<td style=text-align:left><code>"</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>endingDelimiter</code></td>
<td style=text-align:left>分隔符号的结束号</td>
<td style=text-align:left><code>"</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>javaFileEncoding</code></td>
<td style=text-align:left>文件的编码</td>
<td style=text-align:left><code>系统默认值</code></td>
<td style=text-align:left>来源于<code>java.nio.charset.Charset</code></td>
</tr>
<tr>
<td style=text-align:left><code>javaFormatter</code></td>
<td style=text-align:left>类名和文件格式化器</td>
<td style=text-align:left><code>DefaultJavaFormatter</code></td>
<td style=text-align:left>见<code>JavaFormatter</code>和<code>DefaultJavaFormatter</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetJava8</code></td>
<td style=text-align:left>是否JDK8和启动其特性</td>
<td style=text-align:left><code>true</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>kotlinFileEncoding</code></td>
<td style=text-align:left><code>Kotlin</code>文件编码</td>
<td style=text-align:left><code>系统默认值</code></td>
<td style=text-align:left>来源于<code>java.nio.charset.Charset</code></td>
</tr>
<tr>
<td style=text-align:left><code>kotlinFormatter</code></td>
<td style=text-align:left><code>Kotlin</code>类名和文件格式化器</td>
<td style=text-align:left><code>DefaultKotlinFormatter</code></td>
<td style=text-align:left>见<code>KotlinFormatter</code>和<code>DefaultKotlinFormatter</code></td>
</tr>
<tr>
<td style=text-align:left><code>xmlFormatter</code></td>
<td style=text-align:left><code>XML</code>文件格式化器</td>
<td style=text-align:left><code>DefaultXmlFormatter</code></td>
<td style=text-align:left>见<code>XmlFormatter</code>和<code>DefaultXmlFormatter</code></td>
</tr>
</tbody>
</table>
<h3 id=jdbcconnection-标签>jdbcConnection 标签</h3>
<p><code>&lt;jdbcConnection></code>标签用于<strong>指定数据源的连接信息</strong>，它在<code>mybatis-generator-core</code>中对应的实现类为<code>org.mybatis.generator.config.JDBCConnectionConfiguration</code>，主要属性包括：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>driverClass</code></td>
<td style=text-align:left>数据源驱动的全类名</td>
<td style=text-align:left><code>Y</code></td>
</tr>
<tr>
<td style=text-align:left><code>connectionURL</code></td>
<td style=text-align:left><code>JDBC</code>的连接<code>URL</code></td>
<td style=text-align:left><code>Y</code></td>
</tr>
<tr>
<td style=text-align:left><code>userId</code></td>
<td style=text-align:left>连接到数据源的用户名</td>
<td style=text-align:left><code>N</code></td>
</tr>
<tr>
<td style=text-align:left><code>password</code></td>
<td style=text-align:left>连接到数据源的密码</td>
<td style=text-align:left><code>N</code></td>
</tr>
</tbody>
</table>
<h3 id=commentgenerator-标签>commentGenerator 标签</h3>
<p><code>&lt;commentGenerator></code>标签是可选的，用于<strong>控制生成的实体的注释内容</strong>。它在<code>mybatis-generator-core</code>中对应的实现类为<code>org.mybatis.generator.internal.DefaultCommentGenerator</code>，可以通过可选的<code>type</code>属性指定一个自定义的<code>CommentGenerator</code>实现。<code>&lt;commentGenerator></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>suppressAllComments</code></td>
<td style=text-align:left>是否生成注释</td>
<td style=text-align:left><code>false</code></td>
</tr>
<tr>
<td style=text-align:left><code>suppressDate</code></td>
<td style=text-align:left>是否在注释中添加生成的时间戳</td>
<td style=text-align:left><code>false</code></td>
</tr>
<tr>
<td style=text-align:left><code>dateFormat</code></td>
<td style=text-align:left>配合<code>suppressDate</code>使用，指定输出时间戳的格式</td>
<td style=text-align:left><code>java.util.Date#toString()</code></td>
</tr>
<tr>
<td style=text-align:left><code>addRemarkComments</code></td>
<td style=text-align:left>是否输出表和列的<code>Comment</code>信息</td>
<td style=text-align:left><code>false</code></td>
</tr>
</tbody>
</table>
<p>笔者建议保持默认值，也就是什么注释都不输出，生成代码干净的实体。</p>
<h3 id=javatyperesolver-标签>javaTypeResolver 标签</h3>
<p><code>&lt;javaTypeResolver></code>标签是<code>&lt;context></code>的子标签，用于解析和计算数据库列类型和<code>Java</code>类型的映射关系，该标签只包含一个<code>type</code>属性，用于指定<code>org.mybatis.generator.api.JavaTypeResolver</code>接口的实现类。<code>&lt;javaTypeResolver></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>forceBigDecimals</code></td>
<td style=text-align:left>是否强制把所有的数字类型强制使用<code>java.math.BigDecimal</code>类型表示</td>
<td style=text-align:left><code>false</code></td>
</tr>
<tr>
<td style=text-align:left><code>useJSR310Types</code></td>
<td style=text-align:left>是否支持<code>JSR310</code>，主要是<code>JSR310</code>的新日期类型</td>
<td style=text-align:left><code>false</code></td>
</tr>
</tbody>
</table>
<p>如果<code>useJSR310Types</code>属性设置为<code>true</code>，那么生成代码的时候类型映射关系如下（主要针对日期时间类型）：</p>
<table>
<thead>
<tr>
<th style=text-align:left>数据库（JDBC）类型</th>
<th style=text-align:left>Java类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>DATE</code></td>
<td style=text-align:left><code>java.time.LocalDate</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIME</code></td>
<td style=text-align:left><code>java.time.LocalTime</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIMESTAMP</code></td>
<td style=text-align:left><code>java.time.LocalDateTime</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIME_WITH_TIMEZONE</code></td>
<td style=text-align:left><code>java.time.OffsetTime</code></td>
</tr>
<tr>
<td style=text-align:left><code>TIMESTAMP_WITH_TIMEZONE</code></td>
<td style=text-align:left><code>java.time.OffsetDateTime</code></td>
</tr>
</tbody>
</table>
<p>引入<code>mybatis-generator-core</code>后，可以查看<code>JavaTypeResolver</code>的默认实现为<code>JavaTypeResolverDefaultImpl</code>，从它的源码可以得知一些映射关系：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>BIGINT --&gt; Long
BIT --&gt; Boolean
INTEGER --&gt; Integer
SMALLINT --&gt; Short
TINYINT --&gt; Byte
......
</code></pre></div><p>有些时候，我们希望<code>INTEGER</code>、<code>SMALLINT</code>和<code>TINYINT</code>都映射为<code>Integer</code>，那么我们需要覆盖<code>JavaTypeResolverDefaultImpl</code>的构造方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultJavaTypeResolver</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>JavaTypeResolverDefaultImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultJavaTypeResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SMALLINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SMALLINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意一点的是这种自定义实现<code>JavaTypeResolver</code>接口的方式使用编程式运行<code>MBG</code>会相对方便，如果需要使用<code>Maven</code>插件运行，那么需要把上面的<code>DefaultJavaTypeResolver</code>类打包到插件中。</p>
<h3 id=javamodelgenerator-标签>javaModelGenerator 标签</h3>
<p><code>&lt;javaModelGenerator标签></code>标签是<code>&lt;context></code>的子标签，主要用于控制实体（<code>Model</code>）类的代码生成行为。它支持的属性如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>targetPackage</code></td>
<td style=text-align:left>生成的实体类的包名</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>club.throwable.model</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetProject</code></td>
<td style=text-align:left>生成的实体类文件相对于项目（根目录）的位置</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>src/main/java</code></td>
</tr>
</tbody>
</table>
<p><code>&lt;javaModelGenerator标签></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>constructorBased</code></td>
<td style=text-align:left>是否生成一个带有所有字段属性的构造函数</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left><code>MyBatis3Kotlin</code>模式下忽略此属性配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableSubPackages</code></td>
<td style=text-align:left>是否允许通过<code>Schema</code>生成子包</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，例如包名为<code>club.throwable</code>，如果<code>Schema</code>为<code>xyz</code>，那么实体类文件最终会生成在<code>club.throwable.xyz</code>目录</td>
</tr>
<tr>
<td style=text-align:left><code>exampleTargetPackage</code></td>
<td style=text-align:left>生成的伴随实体类的<code>Example</code>类的包名</td>
<td style=text-align:left>-</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>exampleTargetProject</code></td>
<td style=text-align:left>生成的伴随实体类的<code>Example</code>类文件相对于项目（根目录）的位置</td>
<td style=text-align:left>-</td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>immutable</code></td>
<td style=text-align:left>是否不可变</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，则不会生成<code>Setter</code>方法，所有字段都使用<code>final</code>修饰，提供一个带有所有字段属性的构造函数</td>
</tr>
<tr>
<td style=text-align:left><code>rootClass</code></td>
<td style=text-align:left>为生成的实体类添加父类</td>
<td style=text-align:left>-</td>
<td style=text-align:left>通过<code>value</code>指定父类的全类名即可</td>
</tr>
<tr>
<td style=text-align:left><code>trimStrings</code></td>
<td style=text-align:left><code>Setter</code>方法是否对字符串类型进行一次<code>trim</code>操作</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<h3 id=javaclientgenerator-标签>javaClientGenerator 标签</h3>
<p><code>&lt;javaClientGenerator></code>标签是<code>&lt;context></code>的子标签，主要用于控制<code>Mapper</code>接口的代码生成行为。它支持的属性如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>type</code></td>
<td style=text-align:left><code>Mapper</code>接口生成策略</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left><code>&lt;context></code>标签的<code>targetRuntime</code>属性为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时此属性配置忽略</td>
</tr>
<tr>
<td style=text-align:left><code>targetPackage</code></td>
<td style=text-align:left>生成的<code>Mapper</code>接口的包名</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>club.throwable.mapper</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetProject</code></td>
<td style=text-align:left>生成的<code>Mapper</code>接口文件相对于项目（根目录）的位置</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>src/main/java</code></td>
</tr>
</tbody>
</table>
<p><code>type</code>属性的可选值如下：</p>
<ul>
<li><code>ANNOTATEDMAPPER</code>：<code>Mapper</code>接口生成的时候依赖于注解和<code>SqlProviders</code>（也就是纯注解实现），不会生成<code>XML</code>映射文件。</li>
<li><code>XMLMAPPER</code>：<code>Mapper</code>接口生成接口方法，对应的实现代码生成在<code>XML</code>映射文件中（也就是纯映射文件实现）。</li>
<li><code>MIXEDMAPPER</code>：<code>Mapper</code>接口生成的时候复杂的方法实现生成在<code>XML</code>映射文件中，而简单的实现通过注解和<code>SqlProviders</code>实现（也就是注解和映射文件混合实现）。</li>
</ul>
<p>注意两点：</p>
<ul>
<li><code>&lt;context></code>标签的<code>targetRuntime</code>属性指定为<code>MyBatis3Simple</code>的时候，<code>type</code>只能选用<code>ANNOTATEDMAPPER</code>或者<code>XMLMAPPER</code>。</li>
<li><code>&lt;context></code>标签的<code>targetRuntime</code>属性指定为<code>MyBatis3</code>的时候，<code>type</code>可以选用<code>ANNOTATEDMAPPER</code>、<code>XMLMAPPER</code>或者<code>MIXEDMAPPER</code>。</li>
</ul>
<p><code>&lt;javaClientGenerator></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>enableSubPackages</code></td>
<td style=text-align:left>是否允许通过<code>Schema</code>生成子包</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，例如包名为<code>club.throwable</code>，如果<code>Schema</code>为<code>xyz</code>，那么<code>Mapper</code>接口文件最终会生成在<code>club.throwable.xyz</code>目录</td>
</tr>
<tr>
<td style=text-align:left><code>useLegacyBuilder</code></td>
<td style=text-align:left>是否通过<code>SQL Builder</code>生成动态<code>SQL</code></td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left></td>
</tr>
<tr>
<td style=text-align:left><code>rootInterface</code></td>
<td style=text-align:left>为生成的<code>Mapper</code>接口添加父接口</td>
<td style=text-align:left>-</td>
<td style=text-align:left>通过<code>value</code>指定父接口的全类名即可</td>
</tr>
</tbody>
</table>
<h3 id=sqlmapgenerator-标签>sqlMapGenerator 标签</h3>
<p><code>&lt;sqlMapGenerator></code>标签是<code>&lt;context></code>的子标签，主要用于控制<code>XML</code>映射文件的代码生成行为。它支持的属性如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>targetPackage</code></td>
<td style=text-align:left>生成的<code>XML</code>映射文件的包名</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>mappings</code></td>
</tr>
<tr>
<td style=text-align:left><code>targetProject</code></td>
<td style=text-align:left>生成的<code>XML</code>映射文件相对于项目（根目录）的位置</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>src/main/resources</code></td>
</tr>
</tbody>
</table>
<p><code>&lt;sqlMapGenerator></code>标签支持0或N个<code>&lt;property></code>标签，<code>&lt;property></code>的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>enableSubPackages</code></td>
<td style=text-align:left>是否允许通过<code>Schema</code>生成子包</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<h3 id=plugin-标签>plugin 标签</h3>
<p><code>&lt;plugin></code>标签是<code>&lt;context></code>的子标签，用于引入一些插件对代码生成的一些特性进行扩展，该标签只包含一个<code>type</code>属性，用于指定<code>org.mybatis.generator.api.Plugin</code>接口的实现类。内置的插件实现见<a href=http://mybatis.org/generator/reference/plugins.html>Supplied Plugins</a>。例如：引入<code>org.mybatis.generator.plugins.SerializablePlugin</code>插件会让生成的实体类自动实现<code>java.io.Serializable</code>接口并且添加<code>serialVersionUID</code>属性。</p>
<h3 id=table-标签>table 标签</h3>
<p><code>&lt;table></code> 标签是 <code>&lt;context></code> 的子标签，主要用于配置要生成代码的数据库表格，定制一些代码生成行为等等。它支持的属性众多，列举如下：</p>
<table>
<thead>
<tr>
<th style=text-align:left>属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>是否必须</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>tableName</code></td>
<td style=text-align:left>数据库表名称</td>
<td style=text-align:left><code>Y</code></td>
<td style=text-align:left>例如<code>t_order</code></td>
</tr>
<tr>
<td style=text-align:left><code>schema</code></td>
<td style=text-align:left>数据库<code>Schema</code></td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>catalog</code></td>
<td style=text-align:left>数据库<code>Catalog</code></td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>alias</code></td>
<td style=text-align:left>表名称标签</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>如果指定了此值，则查询列的时候结果格式为<code>alias_column</code></td>
</tr>
<tr>
<td style=text-align:left><code>domainObjectName</code></td>
<td style=text-align:left>表对应的实体类名称，可以通过<code>.</code>指定包路径</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>如果指定了<code>bar.User</code>，则包名为<code>bar</code>，实体类名称为<code>User</code></td>
</tr>
<tr>
<td style=text-align:left><code>mapperName</code></td>
<td style=text-align:left>表对应的<code>Mapper</code>接口类名称，可以通过<code>.</code>指定包路径</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>如果指定了<code>bar.UserMapper</code>，则包名为<code>bar</code>，<code>Mapper</code>接口类名称为<code>UserMapper</code></td>
</tr>
<tr>
<td style=text-align:left><code>sqlProviderName</code></td>
<td style=text-align:left>动态<code>SQL</code>提供类<code>SqlProvider</code>的类名称</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>enableInsert</code></td>
<td style=text-align:left>是否允许生成<code>insert</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableSelectByPrimaryKey</code></td>
<td style=text-align:left>是否允许生成<code>selectByPrimaryKey</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableSelectByExample</code></td>
<td style=text-align:left>是否允许生成<code>selectByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableUpdateByPrimaryKey</code></td>
<td style=text-align:left>是否允许生成<code>updateByPrimaryKey</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableDeleteByPrimaryKey</code></td>
<td style=text-align:left>是否允许生成<code>deleteByPrimaryKey</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableDeleteByExample</code></td>
<td style=text-align:left>是否允许生成<code>deleteByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableCountByExample</code></td>
<td style=text-align:left>是否允许生成<code>countByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>enableUpdateByExample</code></td>
<td style=text-align:left>是否允许生成<code>updateByExample</code>方法</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>true</code>，执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>selectByPrimaryKeyQueryId</code></td>
<td style=text-align:left><code>value</code>指定对应的主键列提供列表查询功能</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>selectByExampleQueryId</code></td>
<td style=text-align:left><code>value</code>指定对应的查询<code>ID</code>提供列表查询功能</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3DynamicSql</code>或者<code>MyBatis3Kotlin</code>时忽略此配置</td>
</tr>
<tr>
<td style=text-align:left><code>modelType</code></td>
<td style=text-align:left>覆盖<code>&lt;context></code>的<code>defaultModelType</code>属性</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>见<code>&lt;context></code>的<code>defaultModelType</code>属性</td>
</tr>
<tr>
<td style=text-align:left><code>escapeWildcards</code></td>
<td style=text-align:left>是否对通配符进行转义</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>delimitIdentifiers</code></td>
<td style=text-align:left>标记匹配表名称的时候是否需要使用分隔符去标记生成的SQL</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>delimitAllColumns</code></td>
<td style=text-align:left>是否所有的列都添加分隔符</td>
<td style=text-align:left><code>N</code></td>
<td style=text-align:left>默认值为<code>false</code>，如果设置为<code>true</code>，所有列名会添加起始和结束分隔符</td>
</tr>
</tbody>
</table>
<p><code>&lt;table></code> 标签支持0或N个 <code>&lt;property></code> 标签，<code>&lt;property></code> 的可选属性有：</p>
<table>
<thead>
<tr>
<th style=text-align:left>property属性</th>
<th style=text-align:left>功能描述</th>
<th style=text-align:left>默认值</th>
<th style=text-align:left>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left><code>constructorBased</code></td>
<td style=text-align:left>是否为实体类生成一个带有所有字段的构造函数</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>ignoreQualifiersAtRuntime</code></td>
<td style=text-align:left>是否在运行时忽略别名</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>如果为<code>true</code>，则不会在生成表的时候把<code>schema</code>和<code>catalog</code>作为表的前缀</td>
</tr>
<tr>
<td style=text-align:left><code>immutable</code></td>
<td style=text-align:left>实体类是否不可变</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>modelOnly</code></td>
<td style=text-align:left>是否仅仅生成实体类</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>rootClass</code></td>
<td style=text-align:left>如果配置此属性，则实体类会继承此指定的超类</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>如果有主键属性会把主键属性在超类生成</td>
</tr>
<tr>
<td style=text-align:left><code>rootInterface</code></td>
<td style=text-align:left>如果配置此属性，则实体类会实现此指定的接口</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>或者<code>MyBatis3DynamicSql</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>runtimeCatalog</code></td>
<td style=text-align:left>指定运行时的<code>Catalog</code></td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>当生成表和运行时的表的<code>Catalog</code>不一样的时候可以使用该属性进行配置</td>
</tr>
<tr>
<td style=text-align:left><code>runtimeSchema</code></td>
<td style=text-align:left>指定运行时的<code>Schema</code></td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>当生成表和运行时的表的<code>Schema</code>不一样的时候可以使用该属性进行配置</td>
</tr>
<tr>
<td style=text-align:left><code>runtimeTableName</code></td>
<td style=text-align:left>指定运行时的表名称</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>当生成表和运行时的表的表名称不一样的时候可以使用该属性进行配置</td>
</tr>
<tr>
<td style=text-align:left><code>selectAllOrderByClause</code></td>
<td style=text-align:left>指定字句内容添加到<code>selectAll()</code>方法的<code>order by</code>子句之中</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Simple</code>的时候此属性才适用</td>
</tr>
<tr>
<td style=text-align:left><code>trimStrings</code></td>
<td style=text-align:left>实体类的字符串类型属性会做<code>trim</code>处理</td>
<td style=text-align:left><code>-</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>useActualColumnNames</code></td>
<td style=text-align:left>是否使用列名作为实体类的属性名</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
<tr>
<td style=text-align:left><code>useColumnIndexes</code></td>
<td style=text-align:left><code>XML</code>映射文件中生成的<code>ResultMap</code>使用列索引定义而不是列名称</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>执行引擎为<code>MyBatis3Kotlin</code>或者<code>MyBatis3DynamicSql</code>的时候此属性忽略</td>
</tr>
<tr>
<td style=text-align:left><code>useCompoundPropertyNames</code></td>
<td style=text-align:left>是否把列名和列备注拼接起来生成实体类属性名</td>
<td style=text-align:left><code>false</code></td>
<td style=text-align:left>-</td>
</tr>
</tbody>
</table>
<p><code>&lt;table></code> 标签还支持众多的非 property 的子标签：</p>
<ul>
<li>0或1个<code>&lt;generatedKey></code>用于指定主键生成的规则，指定此标签后会生成一个<code>&lt;selectKey></code>标签：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- column：指定主键列 --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- sqlStatement：查询主键的SQL语句，例如填写了MySql，则使用SELECT LAST_INSERT_ID() --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- type：可选值为pre或者post，pre指定selectKey标签的order为BEFORE，post指定selectKey标签的order为AFTER --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- identity：true的时候，指定selectKey标签的order为AFTER --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;generatedKey</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>sqlStatement=</span><span style=color:#4e9a06>&#34;MySql&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;post&#34;</span> <span style=color:#c4a000>identity=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><ul>
<li>0或1个<code>&lt;domainObjectRenamingRule></code>用于指定实体类重命名规则：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- searchString中正则命中的实体类名部分会替换为replaceString --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;domainObjectRenamingRule</span> <span style=color:#c4a000>searchString=</span><span style=color:#4e9a06>&#34;^Sys&#34;</span> <span style=color:#c4a000>replaceString=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 SysUser会变成User --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 SysUserMapper会变成UserMapper --&gt;</span>
</code></pre></div><ul>
<li>0或1个<code>&lt;columnRenamingRule></code>用于指定列重命名规则：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- searchString中正则命中的列名部分会替换为replaceString --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;columnRenamingRule</span> <span style=color:#c4a000>searchString=</span><span style=color:#4e9a06>&#34;^CUST_&#34;</span> <span style=color:#c4a000>replaceString=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 CUST_BUSINESS_NAME会变成BUSINESS_NAME（useActualColumnNames=true） --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- 例如 CUST_BUSINESS_NAME会变成businessName（useActualColumnNames=false） --&gt;</span>
</code></pre></div><ul>
<li>0或N个<code>&lt;columnOverride></code>用于指定具体列的覆盖映射规则：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- column：指定要覆盖配置的列 --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- property：指定要覆盖配置的属性 --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- delimitedColumnName：是否为列名添加定界符，例如`{column}` --&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!-- isGeneratedAlways：是否一定生成此列 --&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;columnOverride</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;customer_name&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;customerName&#34;</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>typeHandler=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>delimitedColumnName=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#c4a000>isGeneratedAlways=</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
   <span style=color:#8f5902;font-style:italic>&lt;!-- 覆盖table或者javaModelGenerator级别的trimStrings属性配置 --&gt;</span>
   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;trimStrings&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;columnOverride/&gt;</span>
</code></pre></div><ul>
<li>0或N个<code>&lt;ignoreColumn></code>用于指定忽略生成的列：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;ignoreColumn</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;version&#34;</span> <span style=color:#c4a000>delimitedColumnName=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</code></pre></div><h2 id=应用实例>应用实例</h2>
<p>如果需要深度定制一些代码生成行为，建议引入<code>mybatis-generator-core</code>并且通过编程式执行代码生成方法，否则可以选用<code>Maven</code>插件。假设我们在本地数据<code>local</code>有一张<code>t_order</code>表如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>t_order</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UNSIGNED</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;主键&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>order_id</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87>VARCHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;订单ID&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>create_time</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>DATETIME</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;创建时间&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>amount</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87>DECIMAL</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;金额&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>order_status</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TINYINT</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;订单状态&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>UNIQUE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>uniq_order_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;订单表&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>假设项目的结构如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mbg-sample
  - main
   - java
    - club
     - throwable
   - resources
</code></pre></div><p>下面会基于此前提举三个例子。编写基础的<code>XML</code>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span style=color:#8f5902;font-style:italic>&lt;!DOCTYPE generatorConfiguration
</span><span style=color:#8f5902;font-style:italic>        PUBLIC &#34;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&#34;
</span><span style=color:#8f5902;font-style:italic>        &#34;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&#34;&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;generatorConfiguration&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- 驱动包绝对路径 --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;classPathEntry</span>
            <span style=color:#c4a000>location=</span><span style=color:#4e9a06>&#34;I:\Develop\Maven-Repository\mysql\mysql-connector-java\5.1.48\mysql-connector-java-5.1.48.jar&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;这里选择合适的引擎&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;javaFileEncoding&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>

        <span style=color:#8f5902;font-style:italic>&lt;!-- 不输出注释 --&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;commentGenerator&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressDate&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;suppressAllComments&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/commentGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;jdbcConnection</span> <span style=color:#c4a000>driverClass=</span><span style=color:#4e9a06>&#34;com.mysql.jdbc.Driver&#34;</span>
                        <span style=color:#c4a000>connectionURL=</span><span style=color:#4e9a06>&#34;jdbc:mysql://localhost:3306/local&#34;</span>
                        <span style=color:#c4a000>userId=</span><span style=color:#4e9a06>&#34;root&#34;</span>
                        <span style=color:#c4a000>password=</span><span style=color:#4e9a06>&#34;root&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/jdbcConnection&gt;</span>


        <span style=color:#8f5902;font-style:italic>&lt;!-- 不强制把所有的数字类型转化为BigDecimal --&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;javaTypeResolver&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;forceBigDecimals&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/javaTypeResolver&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;javaModelGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;club.throwable.entity&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;src/main/java&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/javaModelGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;sqlMapGenerator</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;mappings&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;src/main/resources&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/sqlMapGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;这里选择合适的Mapper类型&#34;</span> <span style=color:#c4a000>targetPackage=</span><span style=color:#4e9a06>&#34;club.throwable.dao&#34;</span> <span style=color:#c4a000>targetProject=</span><span style=color:#4e9a06>&#34;src/main/java&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;enableSubPackages&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/javaClientGenerator&gt;</span>

        <span style=color:#204a87;font-weight:700>&lt;table</span> <span style=color:#c4a000>tableName=</span><span style=color:#4e9a06>&#34;t_order&#34;</span>
               <span style=color:#c4a000>enableCountByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>enableDeleteByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>enableSelectByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>enableUpdateByExample=</span><span style=color:#4e9a06>&#34;false&#34;</span>
               <span style=color:#c4a000>domainObjectName=</span><span style=color:#4e9a06>&#34;Order&#34;</span>
               <span style=color:#c4a000>mapperName=</span><span style=color:#4e9a06>&#34;OrderMapper&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>&lt;generatedKey</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>sqlStatement=</span><span style=color:#4e9a06>&#34;MySql&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/table&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/context&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/generatorConfiguration&gt;</span>
</code></pre></div><h3 id=纯注解>纯注解</h3>
<p>使用纯注解需要引入<code>mybatis-dynamic-sql</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.mybatis.dynamic-sql<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>mybatis-dynamic-sql<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>1.1.4<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>需要修改两个位置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3DynamicSql&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
...

<span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;ANNOTATEDMAPPER&#34;</span>
<span style=color:#a40000>...</span>
</code></pre></div><p>运行结果会生成三个类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// club.throwable.entity
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Order</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setCreateTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAmount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Byte</span> <span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// club.throwable.dao
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OrderDynamicSqlSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Order</span> <span style=color:#000>order</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Byte</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Order</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SqlTable</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BIGINT</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order_id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;create_time&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BigDecimal</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>SqlColumn</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Byte</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;order_status&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JDBCType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t_order&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@Mapper</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OrderMapper</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>BasicColumn</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>selectList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BasicColumn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>columnList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectStatementProvider</span> <span style=color:#000>selectStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@DeleteProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;delete&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeleteStatementProvider</span> <span style=color:#000>deleteStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@InsertProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;insert&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;SELECT LAST_INSERT_ID()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;record.id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InsertStatementProvider</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>insertStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Results</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;OrderResult&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BIGINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectStatementProvider</span> <span style=color:#000>selectStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@SelectProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;select&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Results</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;OrderResult&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BIGINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#5c35cc;font-weight:700>@Result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>JdbcType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectMany</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectStatementProvider</span> <span style=color:#000>selectStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@UpdateProvider</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SqlProviderAdapter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;update&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UpdateStatementProvider</span> <span style=color:#000>updateStatement</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeleteDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deleteFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>deleteByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> 
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insertSelective</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>toPropertyWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>selectMany</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectDistinct</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectDistinct</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>selectMany</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>selectList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Optional</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>selectOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id_</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UpdateDSLCompleter</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MyBatis3Utils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updateAllColumns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updateSelectiveColumns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UpdateDSL</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UpdateModel</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dsl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>updateByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Generated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.mybatis.generator.api.MyBatisGenerator&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>updateByPrimaryKeySelective</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>equalToWhenPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>where</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isEqualTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=极简-xml-映射文件>极简 XML 映射文件</h3>
<p>极简<code>XML</code>映射文件生成只需要简单修改配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;context</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;default&#34;</span> <span style=color:#c4a000>targetRuntime=</span><span style=color:#4e9a06>&#34;MyBatis3Simple&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
...

<span style=color:#204a87;font-weight:700>&lt;javaClientGenerator</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;XMLMAPPER&#34;</span>
<span style=color:#a40000>...</span>
</code></pre></div><p>生成三个文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// club.throwable.entity
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Order</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getOrderId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getCreateTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setCreateTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BigDecimal</span> <span style=color:#000>getAmount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAmount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BigDecimal</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>amount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Byte</span> <span style=color:#000>getOrderStatus</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setOrderStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Byte</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>orderStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// club.throwable.dao
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OrderMapper</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>deleteByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Order</span> <span style=color:#000>selectByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Order</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>selectAll</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>updateByPrimaryKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Order</span> <span style=color:#000>record</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// mappings
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>&lt;?</span><span style=color:#000>xml</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.0&#34;</span> <span style=color:#000>encoding</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>?&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;!</span><span style=color:#000>DOCTYPE</span> <span style=color:#000>mapper</span> <span style=color:#000>PUBLIC</span> <span style=color:#4e9a06>&#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;</span> <span style=color:#4e9a06>&#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>mapper</span> <span style=color:#000>namespace</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.dao.OrderMapper&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>resultMap</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>id</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BIGINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TIMESTAMP&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;DECIMAL&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>delete</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;deleteByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>delete</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>insert</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;insert&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>selectKey</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;AFTER&#34;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#000>SELECT</span> <span style=color:#000>LAST_INSERT_ID</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>selectKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>insert</span> <span style=color:#000>into</span> <span style=color:#000>t_order</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>order_status</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span>
        <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>update</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;updateByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>update</span> <span style=color:#000>t_order</span>
        <span style=color:#000>set</span> <span style=color:#000>order_id</span>     <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>create_time</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>amount</span>       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>order_status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectAll&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>resultMap</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>id</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BIGINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_id&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderId&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;create_time&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TIMESTAMP&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;createTime&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;DECIMAL&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;amount&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>result</span> <span style=color:#000>column</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;order_status&#34;</span> <span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;orderStatus&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>delete</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;deleteByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>delete</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>insert</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;insert&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>selectKey</span> <span style=color:#000>keyProperty</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BEFORE&#34;</span> <span style=color:#000>resultType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#000>SELECT</span> <span style=color:#000>LAST_INSERT_ID</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>selectKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>insert</span> <span style=color:#000>into</span> <span style=color:#000>t_order</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>values</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span>
        <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>update</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;updateByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;club.throwable.entity.Order&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>update</span> <span style=color:#000>t_order</span>
        <span style=color:#000>set</span> <span style=color:#000>order_id</span>     <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderId</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>VARCHAR</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>create_time</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>createTime</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TIMESTAMP</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>amount</span>       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DECIMAL</span><span style=color:#ce5c00;font-weight:700>},</span>
            <span style=color:#000>order_status</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>orderStatus</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>TINYINT</span><span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectByPrimaryKey&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
        <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jdbcType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>BIGINT</span><span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;selectAll&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>create_time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>order_status</span>
        <span style=color:#000>from</span> <span style=color:#000>t_order</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><h3 id=编程式自定义类型映射>编程式自定义类型映射</h3>
<p>笔者喜欢把所有的非长整型的数字，统一使用<code>Integer</code>接收，因此需要自定义类型映射。编写映射器如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DefaultJavaTypeResolver</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>JavaTypeResolverDefaultImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DefaultJavaTypeResolver</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SMALLINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SMALLINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
        <span style=color:#000>typeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Types</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TINYINT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTypeInformation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;TINYINT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FullyQualifiedJavaType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>())));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此时最好使用编程式运行代码生成器，修改<code>XML</code>配置文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;javaTypeResolver</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;club.throwable.mbg.DefaultJavaTypeResolver&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;forceBigDecimals&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/javaTypeResolver&gt;</span>
...
</code></pre></div><p>运行方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Main</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>warnings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#8f5902;font-style:italic>// 如果已经存在生成过的文件是否进行覆盖
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>overwrite</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ConfigurationParser</span> <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConfigurationParser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Configuration</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseConfiguration</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Main</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/generator-configuration.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>DefaultShellCallback</span> <span style=color:#000>callback</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DefaultShellCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>overwrite</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyBatisGenerator</span> <span style=color:#000>generator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyBatisGenerator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>callback</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>warnings</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>数据库的<code>order_status</code>是<code>TINYINT</code>类型，生成出来的文件中的<code>orderStatus</code>字段全部替换使用<code>Integer</code>类型定义。</p>
<h2 id=总结>总结</h2>
<p>本文相对详尽地介绍了<code>Mybatis Generator</code>的使用方式，具体分析了<code>XML</code>配置文件中主要标签以及标签属性的功能。因为<code>Mybatis</code>在<code>Java</code>的<code>ORM</code>框架体系中还会有一段很长的时间处于主流地位，了解<code>Mybatis Generator</code>可以简化<code>CRUD</code>方法模板代码、实体以及<code>Mapper</code>接口代码生成，从而解放大量生产力。<code>Mybatis Generator</code>有不少第三方的扩展，例如<code>tk.mapper</code>或者<code>mybatis-plus</code>自身的扩展，可能附加的功能不一样，但是基本的使用是一致的。</p>
<h2 id=引用>引用</h2>
<p>原文地址：<a href=https://www.cnblogs.com/throwable/p/12046848.html>https://www.cnblogs.com/throwable/p/12046848.html</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1b4c6af1cc9c41504ec2b73cde59980f>13 - CH13-多数据源</h1>
<p>如果要在查询端实现数据库的主从访问，或者业务较复杂，需要访问不同的数据库，则需要实现多数据源的集成与切换。</p>
<h2 id=配置文件>配置文件</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mybatis.config-location=classpath:mybatis/mybatis-config.xml

spring.datasource.test1.jdbc-url=jdbc:mysql://localhost:3306/test1?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true
spring.datasource.test1.username=root
spring.datasource.test1.password=root
spring.datasource.test1.driver-class-name=com.mysql.cj.jdbc.Driver

spring.datasource.test2.jdbc-url=jdbc:mysql://localhost:3306/test2?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true
spring.datasource.test2.username=root
spring.datasource.test2.password=root
spring.datasource.test2.driver-class-name=com.mysql.cj.jdbc.Driver
</code></pre></div><p>一个 test1 库和一个 test2 库，其中 test1 位主库，在使用的过程中必须指定主库，不然会报错。</p>
<h2 id=数据源配置>数据源配置</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Configuration</span>
<span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.neo.mapper.test1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSessionTemplateRef</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DataSource1Config</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1DataSource&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@ConfigurationProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;spring.datasource.test1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSource</span> <span style=color:#000>testDataSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>DataSourceBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>testSqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test1DataSource&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>SqlSessionFactoryBean</span> <span style=color:#000>bean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionFactoryBean</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setMapperLocations</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PathMatchingResourcePatternResolver</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;classpath:mybatis/mapper/test1/*.xml&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1TransactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DataSourceTransactionManager</span> <span style=color:#000>testTransactionManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test1DataSource&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataSourceTransactionManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#5c35cc;font-weight:700>@Primary</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SqlSessionTemplate</span> <span style=color:#000>testSqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;test1SqlSessionFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SqlSessionTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最关键的地方就是这块了，一层一层注入,首先创建 DataSource，然后创建 SqlSessionFactory 再创建事务，最后包装到 SqlSessionTemplate 中。其中需要指定分库的 mapper 文件地址，以及分库dao层代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@MapperScan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>basePackages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.neo.mapper.test1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sqlSessionTemplateRef</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test1SqlSessionTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这块的注解就是指明了扫描 dao 层，并且给 dao 层注入指定的 SqlSessionTemplate。所有<code>@Bean</code>都需要按照命名指定正确。</p>
<h2 id=dao--mapper>dao & mapper</h2>
<p>dao 层和 xml 需要按照库来分在不同的目录，比如：test1 库 dao 层在 <code>com.neo.mapper.test1</code> 包下，test2 库在<code>com.neo.mapper.test2</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>User1Mapper</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getAll</span><span style=color:#ce5c00;font-weight:700>();</span>
	<span style=color:#000>UserEntity</span> <span style=color:#000>getOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
	<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>mapper：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;mapper</span> <span style=color:#c4a000>namespace=</span><span style=color:#4e9a06>&#34;com.neo.mapper.test1.User1Mapper&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;resultMap</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;com.neo.model.User&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;id</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;id&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;BIGINT&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;userName&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;userName&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;passWord&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;passWord&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;user_sex&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;userSex&#34;</span> <span style=color:#c4a000>javaType=</span><span style=color:#4e9a06>&#34;com.neo.enums.UserSexEnum&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;result</span> <span style=color:#c4a000>column=</span><span style=color:#4e9a06>&#34;nick_name&#34;</span> <span style=color:#c4a000>property=</span><span style=color:#4e9a06>&#34;nickName&#34;</span> <span style=color:#c4a000>jdbcType=</span><span style=color:#4e9a06>&#34;VARCHAR&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/resultMap&gt;</span>
    
    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;Base_Column_List&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        id, userName, passWord, user_sex, nick_name
    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getAll&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span>  <span style=color:#204a87;font-weight:700>&gt;</span>
       SELECT 
       <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;Base_Column_List&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
     FROM users
    <span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getOne&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        SELECT 
       <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;Base_Column_List&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
     FROM users
     WHERE id = #{id}
    <span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>

    <span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;insert&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.neo.model.User&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
       INSERT INTO 
          users
          (userName,passWord,user_sex) 
        VALUES
          (#{userName}, #{passWord}, #{userSex})
    <span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
    
    <span style=color:#204a87;font-weight:700>&lt;update</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;update&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.neo.model.User&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
       UPDATE 
          users 
       SET 
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userName != null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>userName = #{userName},<span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;passWord != null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>passWord = #{passWord},<span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
        nick_name = #{nickName}
       WHERE 
          id = #{id}
    <span style=color:#204a87;font-weight:700>&lt;/update&gt;</span>
    
    <span style=color:#204a87;font-weight:700>&lt;delete</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;delete&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;java.lang.Long&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
       DELETE FROM
           users 
       WHERE 
           id =#{id}
    <span style=color:#204a87;font-weight:700>&lt;/delete&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/mapper&gt;</span>
</code></pre></div><h2 id=测试验证>测试验证</h2>
<p>测试可以使用 SpringBootTest,也可以放到 Controller中，这里只贴 Controller 层的使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@RestController</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserController</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>User1Mapper</span> <span style=color:#000>user1Mapper</span><span style=color:#ce5c00;font-weight:700>;</span>

	<span style=color:#5c35cc;font-weight:700>@Autowired</span>
	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>User2Mapper</span> <span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>;</span>
	
	<span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/getUsers&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getUsers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>user1Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAll</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/getUser&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserEntity</span> <span style=color:#000>getUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOne</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/add&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;update&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserEntity</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>user2Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/delete/{id}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>user1Mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6381d54b4f53832189fba7dda04feff4>14 - CH14-常用片段</h1>
<h2 id=容器循环-foreach>容器循环 foreach</h2>
<p>foreach 元素的属性主要有：</p>
<ul>
<li>item：集合中元素迭代时的别名</li>
<li>index：集合中元素迭代时的索引</li>
<li>open：常用语where语句中，表示以什么开始，比如以'(&lsquo;开始</li>
<li>separator：表示在每次进行迭代时的分隔符</li>
<li>close 常用语where语句中，表示以什么结束</li>
</ul>
<p>在使用 foreach 的时候最关键的也是最容易出错的就是 collection 属性，该属性是必须指定的，但是在不同情况下，该属性的值是不一样的，主要有一下 3 种情况：</p>
<ul>
<li>如果传入的是单参数且参数类型是一个 List 的时候，collection 属性值为 list。</li>
<li>如果传入的是单参数且参数类型是一个 array 数组的时候，collection 的属性值为 array。</li>
<li>如果传入的参数是多个的时候，我们就需要把它们封装成一个 Map 了，当然单参数也可以封装成 map，实际上如果你在传入参数的时候，在 MyBatis 里面也是会把它封装成一个 Map 的，map 的 key 就是参数名，所以这个时候 collection 属性值就是传入的 List 或 array 对象在自己封装的 map 里面的 key.</li>
</ul>
<p>针对最后一条，我们看一下官方的说法：</p>
<blockquote>
<p>注意：你可以将一个 List 实例或者数组作为参数对象传给 MyBatis，当你这么做的时候，MyBatis 会自动将它包装在一个 Map 中并以名称为键。List 实例将会以 “list” 作为键，而数组实例的键将是 “array”。</p>
</blockquote>
<p>所以，不管是多参数还是单参数的 list,array 类型，都可以封装为 map 进行传递。如果传递的是一个 List，则 mybatis 会封装为一个 list 为 key，list 值为 object 的 map，如果是 array，则封装成一个 array 为 key，array 的值为 object 的 map，如果自己封装呢，则 colloection里 放的是自己封装的 map 里的 key 值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//mapper中我们要为这个方法传递的是一个容器,将容器中的元素一个一个的
</span><span style=color:#8f5902;font-style:italic>//拼接到xml的方法中就要使用这个forEach这个标签了
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Entity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>queryById</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>userids</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>//对应的xml中如下
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;queryById&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BaseReslutMap&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
      <span style=color:#000>select</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>FROM</span> <span style=color:#000>entity</span>
      <span style=color:#000>where</span> <span style=color:#000>id</span> <span style=color:#000>in</span> 
      <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>foreach</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;userids&#34;</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;userid&#34;</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;index&#34;</span> <span style=color:#000>open</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#000>separator</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
              <span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>userid</span><span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
  <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><h3 id=foreach-array>foreach array</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getStudentListByClassIds_foreach_array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>classIds</span><span style=color:#ce5c00;font-weight:700>);</span>  
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 7.1 foreach(循环array参数) - 作为where中in的条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentListByClassIds_foreach_array&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST  
      WHERE ST.CLASS_ID IN   
     <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;array&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;classIds&#34;</span>  <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        #{classIds}  
     <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><h3 id=foreach-list>foreach list</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getStudentListByClassIds_foreach_list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>classIdList</span><span style=color:#ce5c00;font-weight:700>);</span> 
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 7.2 foreach(循环List&lt;String&gt;参数) - 作为where中in的条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentListByClassIds_foreach_list&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST  
      WHERE ST.CLASS_ID IN   
     <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;list&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;classIdList&#34;</span>  <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        #{classIdList}  
     <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><h2 id=模糊查询-concat>模糊查询 concat</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//比如说我们想要进行条件查询,但是几个条件不是每次都要使用,那么我们就可以
</span><span style=color:#8f5902;font-style:italic>//通过判断是否拼接到sql中
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>select</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;queryById&#34;</span> <span style=color:#000>resultMap</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;BascResultMap&#34;</span> <span style=color:#000>parameterType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;entity&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#000>SELECT</span> <span style=color:#ce5c00;font-weight:700>*</span>  <span style=color:#000>from</span> <span style=color:#000>entity</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>where</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name!=null&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#000>name</span> <span style=color:#000>like</span> <span style=color:#000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;%&#39;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>#</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>},</span><span style=color:#4e9a06>&#39;%&#39;</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>where</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
  <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>select</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><h2 id=choosewhenotherwise>choose、when、otherwise</h2>
<p>choose 标签是按顺序判断其内部 when 标签中的 test 条件出否成立，如果有一个成立，则 choose 结束。当 choose 中所有 when 的条件都不满则时，则执行 otherwise 中的 sql。类似于 Java 的 switch 语句，choose 为 switch，when 为 case，otherwise 则为 default。</p>
<p>例如下面例子，同样把所有可以限制的条件都写上，方面使用。choose 会从上到下选择一个 when 标签的 test 为 true 的 sql 执行。安全考虑，我们使用 where 将 choose 包起来，放置关键字多于错误。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!--  choose(判断参数) - 按顺序将实体类 User 第一个不为空的属性作为：where条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getUserList_choose&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_user&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.yiibai.pojo.User&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT *  
      FROM User u   
    <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;choose&gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;username !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
                u.username LIKE CONCAT(CONCAT(&#39;%&#39;, #{username, jdbcType=VARCHAR}),&#39;%&#39;)  
            <span style=color:#204a87;font-weight:700>&lt;/when &gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;sex != null and sex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
                AND u.sex = #{sex, jdbcType=INTEGER}  
            <span style=color:#204a87;font-weight:700>&lt;/when &gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;when</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;birthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
                AND u.birthday = #{birthday, jdbcType=DATE}  
            <span style=color:#204a87;font-weight:700>&lt;/when &gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;otherwise&gt;</span>  
            <span style=color:#204a87;font-weight:700>&lt;/otherwise&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;/choose&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>    
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><h2 id=selectkey>selectKey</h2>
<p>在insert语句中，在Oracle经常使用序列、在MySQL中使用函数来自动生成插入表的主键，而且需要方法能返回这个生成主键。使用myBatis的selectKey标签可以实现这个效果。</p>
<p>下面例子，使用 mysql 数据库自定义函数 nextval(&lsquo;student&rsquo;)，用来生成一个 key，并把他设置到传入的实体类中的 studentId 属性上。所以在执行完此方法后，边可以通过这个实体类获取生成的 key。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 插入学生 自动主键--&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;createStudentAutoKey&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.demo.model.StudentEntity&#34;</span> <span style=color:#c4a000>keyProperty=</span><span style=color:#4e9a06>&#34;studentId&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;selectKey</span> <span style=color:#c4a000>keyProperty=</span><span style=color:#4e9a06>&#34;studentId&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;String&#34;</span> <span style=color:#c4a000>order=</span><span style=color:#4e9a06>&#34;BEFORE&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        select nextval(&#39;student&#39;)  
    <span style=color:#204a87;font-weight:700>&lt;/selectKey&gt;</span>  
    INSERT INTO STUDENT_TBL(STUDENT_ID,  
                            STUDENT_NAME,  
                            STUDENT_SEX,  
                            STUDENT_BIRTHDAY,  
                            STUDENT_PHOTO,  
                            CLASS_ID,  
                            PLACE_ID)  
    VALUES (#{studentId},  
            #{studentName},  
            #{studentSex},  
            #{studentBirthday},  
            #{studentPhoto, javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},  
            #{classId},  
            #{placeId})  
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>  
</code></pre></div><p>调用接口方法，和获取自动生成 key：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>StudentEntity</span> <span style=color:#000>entity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>();</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;黎明你好&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentSex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentBirthday</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DateUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1985-05-28&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClassId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;20000001&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setPlaceId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;70000001&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  

<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dynamicSqlMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStudentAutoKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;新增学生ID: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStudentId</span><span style=color:#ce5c00;font-weight:700>());</span>  
</code></pre></div><h2 id=if>if</h2>
<p>if 标签可用在许多类型的 sql 语句中，我们以查询为例。首先看一个很普通的查询：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 查询学生list，like姓名 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentListLikeName&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;StudentEntity&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;studentResultMap&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT * from STUDENT_TBL ST   
WHERE ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName}),&#39;%&#39;)  
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>  
</code></pre></div><p>但是此时如果 studentName 为 null，此语句很可能报错或查询结果为空。此时我们使用 if 动态 sql 语句先进行判断，如果值为 null 或等于空字符串，我们就不进行此条件的判断，增加灵活性。</p>
<p>参数为实体类 StudentEntity。将实体类中所有的属性均进行判断，如果不为空则执行判断条件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 2 if(判断参数) - 将实体类不为空的属性作为where条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentList_if&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST   
     WHERE  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName, jdbcType=VARCHAR}),&#39;%&#39;)  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.STUDENT_SEX = #{studentSex, jdbcType=INTEGER}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.STUDENT_BIRTHDAY = #{studentBirthday, jdbcType=DATE}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != null and classId!= &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.CLASS_ID = #{classId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classEntity != null and classEntity.classId !=null and classEntity.classId !=&#39; &#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.CLASS_ID = #{classEntity.classId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != null and placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.PLACE_ID = #{placeId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeEntity != null and placeEntity.placeId != null and placeEntity.placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.PLACE_ID = #{placeEntity.placeId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentId != null and studentId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        AND ST.STUDENT_ID = #{studentId, jdbcType=VARCHAR}  
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>   
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><p>使用时比较灵活，new 一个这样的实体类，我们需要限制那个条件，只需要附上相应的值就会 where 这个条件，相反不去赋值就可以不在 where 中判断。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select_test_2_1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#000>StudentEntity</span> <span style=color:#000>entity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentSex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentBirthday</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DateUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1985-05-28&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setClassId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;20000001&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#8f5902;font-style:italic>//entity.setPlaceId(&#34;70000001&#34;);  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dynamicSqlMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStudentList_if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StudentEntity</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=if--where>if + where</h2>
<p>当 where 中的条件使用的 if 标签较多时，这样的组合可能会导致错误。我们以在 3.1 中的查询语句为例子，当 java 代码按如下方法调用时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Test</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>select_test_2_1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#000>StudentEntity</span> <span style=color:#000>entity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setStudentSex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudentEntity</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dynamicSqlMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStudentList_if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StudentEntity</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>如果上面例子，参数studentName为null，将不会进行STUDENT_NAME列的判断，则会直接导“WHERE AND”关键字多余的错误SQL。</p>
<p>这时我们可以使用where动态语句来解决。这个“where”标签会知道如果它包含的标签中有返回值的话，它就插入一个‘where’。此外，如果标签返回的内容是以AND 或OR 开头的，则它会剔除掉。</p>
<p>上面例子修改为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 3 select - where/if(判断参数) - 将实体类不为空的属性作为where条件 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentList_whereIf&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST   
    <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName, jdbcType=VARCHAR}),&#39;%&#39;)  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_SEX = #{studentSex, jdbcType=INTEGER}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_BIRTHDAY = #{studentBirthday, jdbcType=DATE}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != null and classId!= &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classEntity != null and classEntity.classId !=null and classEntity.classId !=&#39; &#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classEntity.classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != null and placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeEntity != null and placeEntity.placeId != null and placeEntity.placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeEntity.placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentId != null and studentId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_ID = #{studentId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>    
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>  
</code></pre></div><h2 id=if--set>if + set</h2>
<p>当update语句中没有使用if标签时，如果有一个参数为null，都会导致错误。</p>
<p>当在update语句中使用if标签时，如果前面的if没有执行，则或导致逗号多余错误。使用set标签可以将动态的配置SET 关键字，和剔除追加到条件末尾的任何不相关的逗号。使用if+set标签修改后，如果某项为null则不进行更新，而是保持数据库原值。</p>
<p>如下示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 4 if/set(判断参数) - 将实体类不为空的属性更新 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;update</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;updateStudent_if_set&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    UPDATE STUDENT_TBL  
    <span style=color:#204a87;font-weight:700>&lt;set&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName != null and studentName != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_NAME = #{studentName},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_SEX = #{studentSex},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_BIRTHDAY = #{studentBirthday},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentPhoto != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_PHOTO = #{studentPhoto, javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.CLASS_ID = #{classId}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.PLACE_ID = #{placeId}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>  
    WHERE STUDENT_TBL.STUDENT_ID = #{studentId};      
<span style=color:#204a87;font-weight:700>&lt;/update&gt;</span> 
</code></pre></div><h2 id=if--trim-代替-whereset>if + trim 代替 where/set</h2>
<p>trim是更灵活的去处多余关键字的标签，他可以实践where和set的效果。</p>
<h3 id=trim-代替-where>trim 代替 where</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 5.1if/trim代替where(判断参数) -将实体类不为空的属性作为where条件--&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getStudentList_if_trim&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;resultMap_studentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    SELECT ST.STUDENT_ID,  
           ST.STUDENT_NAME,  
           ST.STUDENT_SEX,  
           ST.STUDENT_BIRTHDAY,  
           ST.STUDENT_PHOTO,  
           ST.CLASS_ID,  
           ST.PLACE_ID  
      FROM STUDENT_TBL ST   
    <span style=color:#204a87;font-weight:700>&lt;trim</span> <span style=color:#c4a000>prefix=</span><span style=color:#4e9a06>&#34;WHERE&#34;</span> <span style=color:#c4a000>prefixOverrides=</span><span style=color:#4e9a06>&#34;AND|OR&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName !=null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            ST.STUDENT_NAME LIKE CONCAT(CONCAT(&#39;%&#39;, #{studentName, jdbcType=VARCHAR}),&#39;%&#39;)  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_SEX = #{studentSex, jdbcType=INTEGER}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_BIRTHDAY = #{studentBirthday, jdbcType=DATE}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != null and classId!= &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classEntity != null and classEntity.classId !=null and classEntity.classId !=&#39; &#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.CLASS_ID = #{classEntity.classId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != null and placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeEntity != null and placeEntity.placeId != null and placeEntity.placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.PLACE_ID = #{placeEntity.placeId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentId != null and studentId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            AND ST.STUDENT_ID = #{studentId, jdbcType=VARCHAR}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/trim&gt;</span>     
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span> 
</code></pre></div><h3 id=trim-代替-set>trim 代替 set</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!-- 5.2 if/trim代替set(判断参数) - 将实体类不为空的属性更新 --&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;update</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;updateStudent_if_trim&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;liming.student.manager.data.model.StudentEntity&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    UPDATE STUDENT_TBL  
    <span style=color:#204a87;font-weight:700>&lt;trim</span> <span style=color:#c4a000>prefix=</span><span style=color:#4e9a06>&#34;SET&#34;</span> <span style=color:#c4a000>suffixOverrides=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentName != null and studentName != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_NAME = #{studentName},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentSex != null and studentSex != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_SEX = #{studentSex},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentBirthday != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_BIRTHDAY = #{studentBirthday},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;studentPhoto != null &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.STUDENT_PHOTO = #{studentPhoto, javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;classId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.CLASS_ID = #{classId},  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;placeId != &#39;&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
            STUDENT_TBL.PLACE_ID = #{placeId}  
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;/trim&gt;</span>  
    WHERE STUDENT_TBL.STUDENT_ID = #{studentId}  
<span style=color:#204a87;font-weight:700>&lt;/update&gt;</span>
</code></pre></div><h2 id=sql-复用>sql 复用</h2>
<p>sql片段标签<sql>：通过该标签可定义能复用的sql语句片段，在执行sql语句标签中直接引用即可。这样既可以提高编码效率，还能有效简化代码，提高可读性</p>
<p>需要配置的属性：id="" &#187;>表示需要改sql语句片段的唯一标识</p>
<p>引用：通过<include refid>标签引用，refid="" 中的值指向需要引用的<sql>中的id=“”属性</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#8f5902;font-style:italic>&lt;!--定义sql片段--&gt;</span>  
<span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;orderAndItem&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    o.order_id,o.cid,o.address,o.create_date,o.orderitem_id,i.orderitem_id,i.product_id,i.count  
  <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>  

 <span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;findOrderAndItemsByOid&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;java.lang.String&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
    select  
<span style=color:#8f5902;font-style:italic>&lt;!--引用sql片段--&gt;</span>  
    <span style=color:#204a87;font-weight:700>&lt;include</span> <span style=color:#c4a000>refid=</span><span style=color:#4e9a06>&#34;orderAndItem&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>  
    from ordertable o  
    join orderitem i on o.orderitem_id = i.orderitem_id  
    where o.order_id = #{orderId}  
  <span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>  
</code></pre></div><h2 id=upsert>upsert</h2>
<h3 id=基于唯一键冲突>基于唯一键冲突</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;createRecord&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;map&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;long&#34;</span> <span style=color:#c4a000>flushCache=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  INSERT INTO MYTABLE (id, name, creator, description)
  VALUES (nextval(&#39;my_seq&#39;), #{name}, #{creator}, #{description})
  ON CONFLICT ON CONSTRAINT (name, creator)
  DO UPDATE SET
    name = #{name},
    creator = #{creator},
    description = #{description}
  RETURNING id
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
</code></pre></div><h3 id=基于主键>基于主键</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;AddTeacher&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;com.mycompany.entity.Teacher&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;selectKey</span> <span style=color:#c4a000>keyProperty=</span><span style=color:#4e9a06>&#34;count&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;int&#34;</span> <span style=color:#c4a000>order=</span><span style=color:#4e9a06>&#34;BEFORE&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        select count(*) from Teacher where teacher_id = #{teacherId}
    <span style=color:#204a87;font-weight:700>&lt;/selectKey&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;count &gt; 0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        update event
        <span style=color:#204a87;font-weight:700>&lt;set&gt;</span>
           <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;teacherName!= null&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>  
                teacher_name= #{teacherName},
           <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;where&gt;</span>
            teacher_id = #{teacherId}
        <span style=color:#204a87;font-weight:700>&lt;/where&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;count==0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
        insert into teacher(teacher_id,teacher_name) values (#{teacherId},#{teacherName})
    <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
</code></pre></div><h3 id=基于唯一键冲突批量执行>基于唯一键冲突批量执行</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ExcelDataMapper</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 根据excel解析的实体，插入到数据库。
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param dbColumnToValueMap &lt;code&gt;Map&lt;String, String&gt;&lt;/code&gt; 表示excel解析的实体。
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dbColumnToValueMap&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dbColumnToValueMap</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;insert</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;upsert&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;map&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
insert into excel_data_info
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;dbColumnToValueMap.keys&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;key&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      ${key}
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
    values
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;dbColumnToValueMap.keys&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;key&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      #{dbColumnToValueMap[${key}]}
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
    on duplicate key update
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;dbColumnToValueMap.keys&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;key&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34; key != &#39;id&#39; &#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
            ${key} = #{dbColumnToValueMap[${key}]}
        <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/insert&gt;</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-793fd8ea7c464da2cc8fff2fb0e503ba>15 - CH15-事务管理原理</h1>
<h2 id=概述>概述</h2>
<p>对数据库的事务而言，应该具有以下几点：创建（create）、提交（commit）、回滚（rollback）、关闭（close）。对应地，MyBatis将事务抽象成了Transaction接口：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223025.png style=display:block;width:80% alt=NAME align=center> </div>
<p>MyBatis的事务管理分为两种形式：</p>
<ul>
<li><strong>使用JDBC的事务管理机制</strong>：即利用java.sql.Connection对象完成对事务的提交（commit()）、回滚（rollback()）、关闭（close()）等。</li>
<li><strong>使用MANAGED的事务管理机制</strong>：这种机制MyBatis自身不会去实现事务管理，而是让程序的容器如（JBOSS，Weblogic）来实现对事务的管理。</li>
</ul>
<p>这两者的类图如下所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223050.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=事务配置>事务配置</h2>
<p>在 MyBatis 中有两种类型的事务管理器（也就是 <code>type="[JDBC|MANAGED]"</code>）：</p>
<ul>
<li><strong>JDBC</strong> – 这个配置直接使用了 JDBC 的提交和回滚设施，它依赖从数据源获得的连接来管理事务作用域。</li>
<li><strong>MANAGED</strong> – 这个配置几乎没做什么。它从不提交或回滚一个连接，而是让容器来管理事务的整个生命周期（比如 JEE 应用服务器的上下文）。 默认情况下它会关闭连接。然而一些容器并不希望连接被关闭，因此需要将 closeConnection 属性设置为 false 来阻止默认的关闭行为。例如:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;transactionManager</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;MANAGED&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;closeConnection&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/transactionManager&gt;</span>
</code></pre></div><blockquote>
<p>如果你正在使用 Spring + MyBatis，则没有必要配置事务管理器，因为 Spring 模块会使用自带的管理器来覆盖前面的配置。</p>
</blockquote>
<p>这两种事务管理器类型都不需要设置任何属性。它们其实是类型别名，换句话说，你可以用 TransactionFactory 接口实现类的全限定名或类型别名代替它们。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>TransactionFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 从 3.5.2 开始，该方法为默认方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 空实现
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>Transaction</span> <span style=color:#000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#000>Transaction</span> <span style=color:#000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在事务管理器实例化后，所有在 XML 中配置的属性将会被传递给 setProperties() 方法。你的实现还需要创建一个 Transaction 接口的实现类，这个接口也很简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Transaction</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>Integer</span> <span style=color:#000>getTimeout</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用这两个接口，你可以完全自定义 MyBatis 对事务的处理。</p>
<h2 id=事务的配置创建和使用>事务的配置、创建和使用</h2>
<h3 id=事务的配置>事务的配置</h3>
<p>我们在使用MyBatis时，一般会在MyBatisXML配置文件中定义类似如下的信息：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223156.png style=display:block;width:80% alt=NAME align=center> </div>
<p><code>&lt;environment></code>节点定义了连接某个数据库的信息，其子节点<code>&lt;transactionManager></code> 的type 会决定我们用什么类型的事务管理机制。</p>
<h3 id=事务工厂的创建>事务工厂的创建</h3>
<p>MyBatis事务的创建是交给TransactionFactory 事务工厂来创建的，如果我们将<code>&lt;transactionManager></code>的type 配置为"JDBC",那么，在MyBatis初始化解析 <code>&lt;environment></code>节点时，会根据type=&ldquo;JDBC"创建一个JdbcTransactionFactory工厂，其源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic> * 解析&lt;transactionManager&gt;节点，创建对应的TransactionFactory 
</span><span style=color:#8f5902;font-style:italic> * @param context 
</span><span style=color:#8f5902;font-style:italic> * @return 
</span><span style=color:#8f5902;font-style:italic> * @throws Exception 
</span><span style=color:#8f5902;font-style:italic> */</span>  
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionFactory</span> <span style=color:#000>transactionManagerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>String</span> <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;type&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#000>Properties</span> <span style=color:#000>props</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildrenAsProperties</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#8f5902;font-style:italic>/* 
</span><span style=color:#8f5902;font-style:italic>         * 在Configuration初始化的时候，会通过以下语句，给JDBC和MANAGED对应的工厂类 
</span><span style=color:#8f5902;font-style:italic>         * typeAliasRegistry.registerAlias(&#34;JDBC&#34;, JdbcTransactionFactory.class); 
</span><span style=color:#8f5902;font-style:italic>         * typeAliasRegistry.registerAlias(&#34;MANAGED&#34;, ManagedTransactionFactory.class); 
</span><span style=color:#8f5902;font-style:italic>         * 下述的resolveClass(type).newInstance()会创建对应的工厂实例 
</span><span style=color:#8f5902;font-style:italic>         */</span>  
        <span style=color:#000>TransactionFactory</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransactionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BuilderException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Environment declaration requires a TransactionFactory.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#ce5c00;font-weight:700>}</span>  

  
        <span style=color:#5c35cc;font-weight:700>@pdai</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>代码已经复制到剪贴板</span>
    
</code></pre></div><p>如上述代码所示，如果type = &ldquo;JDBC&rdquo;,则MyBatis会创建一个JdbcTransactionFactory.class 实例；如果type=&ldquo;MANAGED&rdquo;，则MyBatis会创建一个MangedTransactionFactory.class实例。</p>
<p>MyBatis对<code>&lt;transactionManager></code>节点的解析会生成TransactionFactory实例；而对<code>&lt;dataSource></code>解析会生成datasouce实例，作为<code>&lt;environment></code>节点，会根据TransactionFactory和DataSource实例创建一个Environment对象，代码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>environmentsElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>environment</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;default&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>XNode</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>context</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildren</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>String</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStringAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#8f5902;font-style:italic>//是和默认的环境相同时，解析之  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSpecifiedEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#8f5902;font-style:italic>//1.解析&lt;transactionManager&gt;节点，决定创建什么类型的TransactionFactory  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>TransactionFactory</span> <span style=color:#000>txFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transactionManagerElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;transactionManager&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>  
                <span style=color:#8f5902;font-style:italic>//2. 创建dataSource  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>DataSourceFactory</span> <span style=color:#000>dsFactory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSourceElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evalNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dataSource&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>  
                <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dsFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDataSource</span><span style=color:#ce5c00;font-weight:700>();</span>  
                <span style=color:#8f5902;font-style:italic>//3. 使用了Environment内置的构造器Builder，传递id 事务工厂TransactionFactory和数据源DataSource  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span> <span style=color:#000>environmentBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span>  
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transactionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>txFactory</span><span style=color:#ce5c00;font-weight:700>)</span>  
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setEnvironment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>environmentBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>());</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>  
</code></pre></div><p>Environment表示着一个数据库的连接，生成后的Environment对象会被设置到Configuration实例中，以供后续的使用。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223254.png style=display:block;width:80% alt=NAME align=center> </div>
<p>上述一直在讲事务工厂TransactionFactory来创建的Transaction，现在让我们看一下MyBatis中的TransactionFactory的定义吧。</p>
<h3 id=事务工厂-transactionfactory>事务工厂 TransactionFactory</h3>
<p>事务工厂Transaction定义了创建Transaction的两个方法：一个是通过指定的Connection对象创建Transaction，另外是通过数据源DataSource来创建Transaction。与JDBC 和MANAGED两种Transaction相对应，TransactionFactory有两个对应的实现的子类：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223330.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=事务transaction的创建>事务Transaction的创建</h3>
<p>通过事务工厂TransactionFactory很容易获取到Transaction对象实例。我们以JdbcTransaction为例，看一下JdbcTransactionFactory是怎样生成JdbcTransaction的，代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JdbcTransactionFactory</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TransactionFactory</span> <span style=color:#ce5c00;font-weight:700>{</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Properties</span> <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>     * 根据给定的数据库连接Connection创建Transaction 
</span><span style=color:#8f5902;font-style:italic>     * @param conn Existing database connection 
</span><span style=color:#8f5902;font-style:italic>     * @return 
</span><span style=color:#8f5902;font-style:italic>     */</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Transaction</span> <span style=color:#000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>     * 根据DataSource、隔离级别和是否自动提交创建Transacion 
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     * @param ds 
</span><span style=color:#8f5902;font-style:italic>     * @param level Desired isolation level 
</span><span style=color:#8f5902;font-style:italic>     * @param autoCommit Desired autocommit 
</span><span style=color:#8f5902;font-style:italic>     * @return 
</span><span style=color:#8f5902;font-style:italic>     */</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Transaction</span> <span style=color:#000>newTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JdbcTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>autoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>  
</code></pre></div><p>如上说是，JdbcTransactionFactory会创建JDBC类型的Transaction，即JdbcTransaction。类似地，ManagedTransactionFactory也会创建ManagedTransaction。下面我们会分别深入JdbcTranaction 和ManagedTransaction，看它们到底是怎样实现事务管理的。</p>
<h3 id=jdbctranscation>JdbcTranscation</h3>
<p>JdbcTransaction直接使用JDBC的提交和回滚事务管理机制。它依赖与从dataSource中取得的连接connection 来管理transaction 的作用域，connection对象的获取被延迟到调用getConnection()方法。如果autocommit设置为on，开启状态的话，它会忽略commit和rollback。</p>
<p>直观地讲，就是JdbcTransaction是使用的java.sql.Connection 上的commit和rollback功能，JdbcTransaction只是相当于对java.sql.Connection事务处理进行了一次包装（wrapper），Transaction的事务管理都是通过java.sql.Connection实现的。JdbcTransaction的代码实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>JdbcTransaction</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Transaction</span> <span style=color:#ce5c00;font-weight:700>{</span>  
 
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JdbcTransaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>  
 
    <span style=color:#8f5902;font-style:italic>//数据库连接  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#8f5902;font-style:italic>//数据源  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#8f5902;font-style:italic>//隔离级别  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#8f5902;font-style:italic>//是否为自动提交  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>autoCommmit</span><span style=color:#ce5c00;font-weight:700>;</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JdbcTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>desiredLevel</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>desiredAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>;</span>  
        <span style=color:#000>level</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>desiredLevel</span><span style=color:#ce5c00;font-weight:700>;</span>  
        <span style=color:#000>autoCommmit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>desiredAutoCommit</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JdbcTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>openConnection</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>     * commit()功能 使用connection的commit() 
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException 
</span><span style=color:#8f5902;font-style:italic>     */</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Committing JDBC Connection [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>     * rollback()功能 使用connection的rollback() 
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException 
</span><span style=color:#8f5902;font-style:italic>     */</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Rolling back JDBC Connection [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rollback</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>     * close()功能 使用connection的close() 
</span><span style=color:#8f5902;font-style:italic>     * @throws SQLException 
</span><span style=color:#8f5902;font-style:italic>     */</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>resetAutoCommit</span><span style=color:#ce5c00;font-weight:700>();</span>  
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Closing JDBC Connection [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDesiredAutoCommit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>desiredAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>desiredAutoCommit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Setting autocommit to &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>desiredAutoCommit</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; on JDBC Connection [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAutoCommit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>desiredAutoCommit</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#8f5902;font-style:italic>// Only a very poorly implemented driver would fail here,  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// and there&#39;s not much we can do about that.  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TransactionException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error configuring AutoCommit.  &#34;</span>  
             <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;Your driver may not support getAutoCommit() or setAutoCommit(). &#34;</span>  
             <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;Requested setting: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>desiredAutoCommit</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>resetAutoCommit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAutoCommit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#8f5902;font-style:italic>// MyBatis does not call commit/rollback on a connection if just selects were performed.  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// Some databases start transactions with select statements  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// and they mandate a commit/rollback before closing the connection.  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// A workaround is setting the autocommit to true before closing the connection.  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// Sybase throws an exception here.  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Resetting autocommit to true on JDBC Connection [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAutoCommit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Error resetting autocommit to true &#34;</span>  
             <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;before closing the connection.  Cause: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>openConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Opening JDBC Connection&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>level</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTransactionIsolation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLevel</span><span style=color:#ce5c00;font-weight:700>());</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#000>setDesiredAutoCommit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>autoCommmit</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
<span style=color:#ce5c00;font-weight:700>}</span>  
</code></pre></div><h3 id=managedtransaction>ManagedTransaction</h3>
<p>ManagedTransaction让容器来管理事务Transaction的整个生命周期，意思就是说，使用ManagedTransaction的commit和rollback功能不会对事务有任何的影响，它什么都不会做，它将事务管理的权利移交给了容器来实现。看如下Managed的实现代码大家就会一目了然：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic> *  
</span><span style=color:#8f5902;font-style:italic> * 让容器管理事务transaction的整个生命周期 
</span><span style=color:#8f5902;font-style:italic> * connection的获取延迟到getConnection()方法的调用 
</span><span style=color:#8f5902;font-style:italic> * 忽略所有的commit和rollback操作 
</span><span style=color:#8f5902;font-style:italic> * 默认情况下，可以关闭一个连接connection，也可以配置它不可以关闭一个连接 
</span><span style=color:#8f5902;font-style:italic> * 让容器来管理transaction的整个生命周期 
</span><span style=color:#8f5902;font-style:italic> * @see ManagedTransactionFactory 
</span><span style=color:#8f5902;font-style:italic> */</span>   
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ManagedTransaction</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Transaction</span> <span style=color:#ce5c00;font-weight:700>{</span>  
 
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ManagedTransaction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>  
 
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DataSource</span> <span style=color:#000>dataSource</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>;</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ManagedTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Connection</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ManagedTransaction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataSource</span> <span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TransactionIsolationLevel</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ds</span><span style=color:#ce5c00;font-weight:700>;</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>level</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>;</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>openConnection</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>commit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#8f5902;font-style:italic>// Does nothing  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rollback</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#8f5902;font-style:italic>// Does nothing  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeConnection</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Closing JDBC Connection [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>  
 
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>openConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>SQLException</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDebugEnabled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Opening JDBC Connection&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>dataSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>level</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setTransactionIsolation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>level</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLevel</span><span style=color:#ce5c00;font-weight:700>());</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>注意：如果我们使用MyBatis构建本地程序，即不是WEB程序，若将type设置成"MANAGED&rdquo;，那么，我们执行的任何update操作，即使我们最后执行了commit操作，数据也不会保留，不会对数据库造成任何影响。因为我们将MyBatis配置成了“MANAGED”，即MyBatis自己不管理事务，而我们又是运行的本地程序，没有事务管理功能，所以对数据库的update操作都是无效的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7d266cedb46af8162e4941805ad7b1a0>16 - CH16-一级缓存原理</h1>
<h2 id=什么是一级缓存>什么是一级缓存？</h2>
<p>每当我们使用MyBatis开启一次和数据库的会话，MyBatis会创建出一个SqlSession对象表示一次数据库会话。</p>
<p>在对数据库的一次会话中，我们有可能会反复地执行完全相同的查询语句，如果不采取一些措施的话，每一次查询都会查询一次数据库,而我们在极短的时间内做了完全相同的查询，那么它们的结果极有可能完全相同，由于查询一次数据库的代价很大，这有可能造成很大的资源浪费。</p>
<p>为了解决这一问题，减少资源的浪费，MyBatis会在表示会话的SqlSession对象中建立一个简单的缓存，将每次查询到的结果结果缓存起来，当下次查询的时候，如果判断先前有个完全一样的查询，会直接从缓存中直接将结果取出，返回给用户，不需要再进行一次数据库查询了。</p>
<p>如下图所示，MyBatis一次会话: 一个SqlSession对象中创建一个本地缓存(local cache)，对于每一次查询，都会尝试根据查询的条件去本地缓存中查找是否在缓存中，如果在缓存中，就直接从缓存中取出，然后返回给用户；否则，从数据库读取数据，将查询结果存入缓存并返回给用户。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223514.png style=display:block;width:80% alt=NAME align=center> </div>
<p>对于会话（Session）级别的数据缓存，我们称之为一级数据缓存，简称一级缓存。</p>
<h2 id=mybatis中的一级缓存是怎样组织的>MyBatis中的一级缓存是怎样组织的？</h2>
<blockquote>
<p>即SqlSession中的缓存是怎样组织的？由于MyBatis使用SqlSession对象表示一次数据库的会话，那么，对于会话级别的一级缓存也应该是在SqlSession中控制的。</p>
</blockquote>
<p>实际上, MyBatis只是一个MyBatis对外的接口，SqlSession将它的工作交给了Executor执行器这个角色来完成，负责完成对数据库的各种操作。当创建了一个SqlSession对象时，MyBatis会为这个SqlSession对象创建一个新的Executor执行器，而缓存信息就被维护在这个Executor执行器中，MyBatis将缓存和对缓存相关的操作封装成了Cache接口中。SqlSession、Executor、Cache之间的关系如下列类图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223551.png style=display:block;width:80% alt=NAME align=center> </div>
<p>如上述的类图所示，Executor接口的实现类BaseExecutor中拥有一个Cache接口的实现类PerpetualCache，则对于BaseExecutor对象而言，它将使用PerpetualCache对象维护缓存。</p>
<p>综上，SqlSession对象、Executor对象、Cache对象之间的关系如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223604.png style=display:block;width:80% alt=NAME align=center> </div>
<p>由于Session级别的一级缓存实际上就是使用PerpetualCache维护的，那么PerpetualCache是怎样实现的呢？</p>
<p>PerpetualCache实现原理其实很简单，其内部就是通过一个简单的<code>HashMap&lt;k,v></code> 来实现的，没有其他的任何限制。如下是PerpetualCache的实现代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.apache.ibatis.cache.impl</span><span style=color:#ce5c00;font-weight:700>;</span>  
  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.HashMap</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.Map</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.ReadWriteLock</span><span style=color:#ce5c00;font-weight:700>;</span>  
  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.cache.Cache</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.ibatis.cache.CacheException</span><span style=color:#ce5c00;font-weight:700>;</span>  
  
<span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic> * 使用简单的HashMap来维护缓存 
</span><span style=color:#8f5902;font-style:italic> * @author Clinton Begin 
</span><span style=color:#8f5902;font-style:italic> */</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PerpetualCache</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Cache</span> <span style=color:#ce5c00;font-weight:700>{</span>  
  
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>  
  
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PerpetualCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>removeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ReadWriteLock</span> <span style=color:#000>getReadWriteLock</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cache instances require an ID.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>o</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>  
  
    <span style=color:#000>Cache</span> <span style=color:#000>otherCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cache</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>otherCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cache instances require an ID.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>  
  <span style=color:#ce5c00;font-weight:700>}</span>  
  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><h2 id=一级缓存的生命周期有多长>一级缓存的生命周期有多长？</h2>
<p>MyBatis在开启一个数据库会话时，会创建一个新的SqlSession对象，SqlSession对象中会有一个新的Executor对象，Executor对象中持有一个新的PerpetualCache对象；当会话结束时，SqlSession对象及其内部的Executor对象还有PerpetualCache对象也一并释放掉。</p>
<ul>
<li>如果SqlSession调用了close()方法，会释放掉一级缓存PerpetualCache对象，一级缓存将不可用；</li>
<li>如果SqlSession调用了clearCache()，会清空PerpetualCache对象中的数据，但是该对象仍可使用；</li>
<li>SqlSession中执行了任何一个update操作(update()、delete()、insert()) ，都会清空PerpetualCache对象的数据，但是该对象可以继续使用；</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223620.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=sqlsession-一级缓存的工作流程>SqlSession 一级缓存的工作流程</h2>
<ul>
<li>对于某个查询，根据statementId,params,rowBounds来构建一个key值，根据这个key值去缓存Cache中取出对应的key值存储的缓存结果；</li>
<li>判断从Cache中根据特定的key值取的数据数据是否为空，即是否命中；</li>
<li>如果命中，则直接将缓存结果返回；</li>
<li>如果没命中：
<ul>
<li>去数据库中查询数据，得到查询结果；</li>
<li>将key和查询到的结果分别作为key,value对存储到Cache中；</li>
<li>将查询结果返回；</li>
</ul>
</li>
<li>结束。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019223633.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=cache接口的设计以及cachekey的定义>Cache接口的设计以及CacheKey的定义</h2>
<p>如下图所示，MyBatis定义了一个org.apache.ibatis.cache.Cache接口作为其Cache提供者的SPI(Service Provider Interface) ，所有的MyBatis内部的Cache缓存，都应该实现这一接口。MyBatis定义了一个PerpetualCache实现类实现了Cache接口，实际上，在SqlSession对象里的Executor对象内维护的Cache类型实例对象，就是PerpetualCache子类创建的。</p>
<p>（MyBatis内部还有很多Cache接口的实现，一级缓存只会涉及到这一个PerpetualCache子类，Cache的其他实现将会放到二级缓存中介绍）。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/mybatis-y-cache-6.png style=display:block;width:80% alt=NAME align=center> </div>
<p>我们知道，Cache最核心的实现其实就是一个Map，将本次查询使用的特征值作为key，将查询结果作为value存储到Map中。现在最核心的问题出现了：怎样来确定一次查询的特征值？换句话说就是：怎样判断某两次查询是完全相同的查询？也可以这样说：如何确定Cache中的key值？</p>
<p>MyBatis认为，对于两次查询，如果以下条件都完全一样，那么就认为它们是完全相同的两次查询：</p>
<ul>
<li>传入的 statementId</li>
<li>查询时要求的结果集中的结果范围 （结果的范围通过rowBounds.offset和rowBounds.limit表示）</li>
<li>这次查询所产生的最终要传递给JDBC java.sql.Preparedstatement的Sql语句字符串（boundSql.getSql() ）</li>
<li>传递给java.sql.Statement要设置的参数值</li>
</ul>
<p><strong>现在分别解释上述四个条件</strong>：</p>
<ul>
<li>传入的statementId，对于MyBatis而言，你要使用它，必须需要一个statementId，它代表着你将执行什么样的Sql；</li>
<li>MyBatis自身提供的分页功能是通过RowBounds来实现的，它通过rowBounds.offset和rowBounds.limit来过滤查询出来的结果集，这种分页功能是基于查询结果的再过滤，而不是进行数据库的物理分页；</li>
<li>由于MyBatis底层还是依赖于JDBC实现的，那么，对于两次完全一模一样的查询，MyBatis要保证对于底层JDBC而言，也是完全一致的查询才行。而对于JDBC而言，两次查询，只要传入给JDBC的SQL语句完全一致，传入的参数也完全一致，就认为是两次查询是完全一致的。</li>
<li>上述的第3个条件正是要求保证传递给JDBC的SQL语句完全一致；第4条则是保证传递给JDBC的参数也完全一致；即3、4两条MyBatis最本质的要求就是：调用JDBC的时候，传入的SQL语句要完全相同，传递给JDBC的参数值也要完全相同。</li>
</ul>
<p>综上所述,CacheKey由以下条件决定：<strong>statementId + rowBounds + 传递给JDBC的SQL + 传递给JDBC的参数值</strong>；</p>
<ul>
<li><strong>CacheKey的创建</strong></li>
</ul>
<p>对于每次的查询请求，Executor都会根据传递的参数信息以及动态生成的SQL语句，将上面的条件根据一定的计算规则，创建一个对应的CacheKey对象。</p>
<p>我们知道创建CacheKey的目的，就两个：</p>
<ul>
<li>根据CacheKey作为key,去Cache缓存中查找缓存结果；</li>
<li>如果查找缓存命中失败，则通过此CacheKey作为key，将从数据库查询到的结果作为value，组成key,value对存储到Cache缓存中；</li>
</ul>
<p>CacheKey的构建被放置到了Executor接口的实现类BaseExecutor中，定义如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic> * 所属类:  org.apache.ibatis.executor.BaseExecutor 
</span><span style=color:#8f5902;font-style:italic> * 功能   :   根据传入信息构建CacheKey 
</span><span style=color:#8f5902;font-style:italic> */</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CacheKey</span> <span style=color:#000>createCacheKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MappedStatement</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RowBounds</span> <span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BoundSql</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutorException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Executor was closed.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#000>CacheKey</span> <span style=color:#000>cacheKey</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CacheKey</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#8f5902;font-style:italic>//1.statementId  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#8f5902;font-style:italic>//2. rowBounds.offset  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOffset</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#8f5902;font-style:italic>//3. rowBounds.limit  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rowBounds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLimit</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#8f5902;font-style:italic>//4. SQL语句  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSql</span><span style=color:#ce5c00;font-weight:700>());</span>  
    <span style=color:#8f5902;font-style:italic>//5. 将每一个要传递给JDBC的参数值也更新到CacheKey中  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ParameterMapping</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parameterMappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterMappings</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#000>TypeHandlerRegistry</span> <span style=color:#000>typeHandlerRegistry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConfiguration</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getTypeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// mimic DefaultParameterHandler logic  
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ParameterMapping</span> <span style=color:#000>parameterMapping</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMappings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>ParameterMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OUT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
            <span style=color:#000>String</span> <span style=color:#000>propertyName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterMapping</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>();</span>  
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>boundSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAdditionalParameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>  
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>typeHandlerRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasTypeHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>;</span>  
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#000>MetaObject</span> <span style=color:#000>metaObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMetaObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterObject</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>metaObject</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propertyName</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#8f5902;font-style:italic>//将每一个要传递给JDBC的参数值也更新到CacheKey中  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cacheKey</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li><strong>CacheKey的hashcode生成算法</strong></li>
</ul>
<p>刚才已经提到，Cache接口的实现，本质上是使用的<code>HashMap&lt;k,v></code>,而构建CacheKey的目的就是为了作为<code>HashMap&lt;k,v></code>中的key值。而HashMap是通过key值的hashcode 来组织和存储的，那么，构建CacheKey的过程实际上就是构造其hashCode的过程。下面的代码就是CacheKey的核心hashcode生成算法，感兴趣的话可以看一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isArray</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>Object</span> <span style=color:#000>element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>  
            <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>  
 
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
 
    <span style=color:#8f5902;font-style:italic>//1. 得到对象的hashcode;    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>baseHashCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#8f5902;font-style:italic>//对象计数递增  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>++;</span>  
    <span style=color:#000>checksum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>baseHashCode</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#8f5902;font-style:italic>//2. 对象的hashcode 扩大count倍  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>baseHashCode</span> <span style=color:#ce5c00;font-weight:700>*=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#8f5902;font-style:italic>//3. hashCode * 拓展因子（默认37）+拓展扩大后的对象hashCode值  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>hashcode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>multiplier</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>hashcode</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>baseHashCode</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#000>updateList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>MyBatis认为的完全相同的查询，不是指使用sqlSession查询时传递给算起来Session的所有参数值完完全全相同，你只要保证statementId，rowBounds,最后生成的SQL语句，以及这个SQL语句所需要的参数完全一致就可以了。</p>
<h3 id=一级缓存的性能分析>一级缓存的性能分析</h3>
<ul>
<li><strong>MyBatis对会话（Session）级别的一级缓存设计的比较简单，就简单地使用了HashMap来维护，并没有对HashMap的容量和大小进行限制</strong></li>
</ul>
<p>读者有可能就觉得不妥了：如果我一直使用某一个SqlSession对象查询数据，这样会不会导致HashMap太大，而导致 java.lang.OutOfMemoryError错误啊？ 读者这么考虑也不无道理，不过MyBatis的确是这样设计的。</p>
<p>MyBatis这样设计也有它自己的理由：</p>
<ul>
<li>一般而言SqlSession的生存时间很短。一般情况下使用一个SqlSession对象执行的操作不会太多，执行完就会消亡；</li>
<li>对于某一个SqlSession对象而言，只要执行update操作（update、insert、delete），都会将这个SqlSession对象中对应的一级缓存清空掉，所以一般情况下不会出现缓存过大，影响JVM内存空间的问题；</li>
<li>可以手动地释放掉SqlSession对象中的缓存。</li>
<li><strong>一级缓存是一个粗粒度的缓存，没有更新缓存和缓存过期的概念</strong></li>
</ul>
<p>MyBatis的一级缓存就是使用了简单的HashMap，MyBatis只负责将查询数据库的结果存储到缓存中去， 不会去判断缓存存放的时间是否过长、是否过期，因此也就没有对缓存的结果进行更新这一说了。</p>
<p>根据一级缓存的特性，在使用的过程中，我认为应该注意：</p>
<ul>
<li>对于数据变化频率很大，并且需要高时效准确性的数据要求，我们使用SqlSession查询的时候，要控制好SqlSession的生存时间， SqlSession的生存时间越长，它其中缓存的数据有可能就越旧，从而造成和真实数据库的误差；同时对于这种情况，用户也可以手动地适时清空SqlSession中的缓存；</li>
<li>对于只执行、并且频繁执行大范围的select操作的SqlSession对象，SqlSession对象的生存时间不应过长。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5fa0843facc8832df69a145efc110729>17 - CH17-二级缓存原理</h1>
<p>MyBatis的二级缓存是Application级别的缓存，它可以提高对数据库查询的效率，以提高应用的性能。</p>
<h2 id=整体设计与工作模式>整体设计与工作模式</h2>
<p>当开一个会话时，一个SqlSession对象会使用一个Executor对象来完成会话操作，MyBatis的二级缓存机制的关键就是对这个Executor对象做文章。如果用户配置了"cacheEnabled=true"，那么MyBatis在为SqlSession对象创建Executor对象时，会对Executor对象加上一个装饰者：CachingExecutor，这时SqlSession使用CachingExecutor对象来完成操作请求。CachingExecutor对于查询请求，会先判断该查询请求在Application级别的二级缓存中是否有缓存结果，如果有查询结果，则直接返回缓存结果；如果缓存中没有，再交给真正的Executor对象来完成查询操作，之后CachingExecutor会将真正Executor返回的查询结果放置到缓存中，然后在返回给用户。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019224032.png style=display:block;width:80% alt=NAME align=center> </div>
<p>CachingExecutor是Executor的装饰者，以增强Executor的功能，使其具有缓存查询的功能，这里用到了设计模式中的装饰者模式，CachingExecutor和Executor的接口的关系如下类图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019224047.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=二级缓存的划分>二级缓存的划分</h2>
<p>MyBatis并不是简单地对整个Application就只有一个Cache缓存对象，它将缓存划分的更细，即是Mapper级别的，即每一个Mapper都可以拥有一个Cache对象，具体如下：</p>
<ul>
<li><strong>为每一个Mapper分配一个Cache缓存对象</strong>（使用<code>&lt;cache></code>节点配置）</li>
</ul>
<p>MyBatis将Application级别的二级缓存细分到Mapper级别，即对于每一个Mapper.xml,如果在其中使用了<code>&lt;cache></code> 节点，则MyBatis会为这个Mapper创建一个Cache缓存对象，如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019224115.png style=display:block;width:80% alt=NAME align=center> </div>
<p>注：上述的每一个Cache对象，都会有一个自己所属的namespace命名空间，并且会将Mapper的 namespace作为它们的ID；</p>
<ul>
<li><strong>多个Mapper共用一个Cache缓存对象</strong>（使用<code>&lt;cache-ref></code>节点配置）</li>
</ul>
<p>如果你想让多个Mapper公用一个Cache的话，你可以使用<code>&lt;cache-ref namespace=""></code>节点，来指定你的这个Mapper使用到了哪一个Mapper的Cache缓存。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019224132.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=必须要具备的条件>必须要具备的条件</h2>
<p>MyBatis对二级缓存的支持粒度很细，它会指定某一条查询语句是否使用二级缓存。</p>
<p>虽然在Mapper中配置了<code>&lt;cache></code>,并且为此Mapper分配了Cache对象，这并不表示我们使用Mapper中定义的查询语句查到的结果都会放置到Cache对象之中，我们必须指定Mapper中的某条选择语句是否支持缓存，即如下所示，在<code>&lt;select></code> 节点中配置useCache=&ldquo;true&rdquo;，Mapper才会对此Select的查询支持缓存特性，否则，不会对此Select查询，不会经过Cache缓存。如下所示，Select语句配置了useCache=&ldquo;true&rdquo;，则表明这条Select语句的查询会使用二级缓存。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;selectByMinSalary&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#c4a000>parameterType=</span><span style=color:#4e9a06>&#34;java.util.Map&#34;</span> <span style=color:#c4a000>useCache=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</code></pre></div><p>总之，要想使某条Select查询支持二级缓存，你需要保证：</p>
<ul>
<li>MyBatis支持二级缓存的总开关：全局配置变量参数 cacheEnabled=true</li>
<li>该select语句所在的Mapper，配置了<code>&lt;cache></code> 或<code>&lt;cached-ref></code>节点，并且有效</li>
<li>该select语句的参数 useCache=true</li>
</ul>
<h2 id=一级缓存和二级缓存的使用顺序>一级缓存和二级缓存的使用顺序</h2>
<p>请注意，如果你的MyBatis使用了二级缓存，并且你的Mapper和select语句也配置使用了二级缓存，那么在执行select查询的时候，MyBatis会先从二级缓存中取输入，其次才是一级缓存，即<strong>MyBatis查询数据的顺序是：二级缓存 ———> 一级缓存 ——> 数据库</strong>。</p>
<h2 id=二级缓存实现的选择>二级缓存实现的选择</h2>
<p>MyBatis对二级缓存的设计非常灵活，它自己内部实现了一系列的Cache缓存实现类，并提供了各种缓存刷新策略如LRU，FIFO等等；另外，MyBatis还允许用户自定义Cache接口实现，用户是需要实现org.apache.ibatis.cache.Cache接口，然后将Cache实现类配置在<code>&lt;cache type=""></code>节点的type属性上即可；除此之外，MyBatis还支持跟第三方内存缓存库如Memecached的集成，总之，使用MyBatis的二级缓存有三个选择:</p>
<ul>
<li>MyBatis自身提供的缓存实现；</li>
<li>用户自定义的Cache接口实现；</li>
<li>跟第三方内存缓存库的集成；</li>
</ul>
<h2 id=mybatis自身提供的二级缓存的实现>MyBatis自身提供的二级缓存的实现</h2>
<blockquote>
<p>MyBatis自身提供了丰富的，并且功能强大的二级缓存的实现，它拥有一系列的Cache接口装饰者，可以满足各种对缓存操作和更新的策略。</p>
</blockquote>
<p>MyBatis定义了大量的Cache的装饰器来增强Cache缓存的功能，如下类图所示。</p>
<p>对于每个Cache而言，都有一个容量限制，MyBatis各供了各种策略来对Cache缓存的容量进行控制，以及对Cache中的数据进行刷新和置换。MyBatis主要提供了以下几个刷新和置换策略：</p>
<ul>
<li>LRU：（Least Recently Used）,最近最少使用算法，即如果缓存中容量已经满了，会将缓存中最近最少被使用的缓存记录清除掉，然后添加新的记录；</li>
<li>FIFO：（First in first out）,先进先出算法，如果缓存中的容量已经满了，那么会将最先进入缓存中的数据清除掉；</li>
<li>Scheduled：指定时间间隔清空算法，该算法会以指定的某一个时间间隔将Cache缓存中的数据清空；</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019224211.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=如何细粒度地控制你的mybatis二级缓存>如何细粒度地控制你的MyBatis二级缓存</h2>
<h3 id=一个关于mybatis的二级缓存的实际问题>一个关于MyBatis的二级缓存的实际问题</h3>
<p>现有AMapper.xml中定义了对数据库表 ATable 的CRUD操作，BMapper定义了对数据库表BTable的CRUD操作；</p>
<p>假设 MyBatis 的二级缓存开启，并且 AMapper 中使用了二级缓存，AMapper对应的二级缓存为ACache；</p>
<p>除此之外，AMapper 中还定义了一个跟BTable有关的查询语句，类似如下所述：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;selectATableWithJoin&#34;</span> <span style=color:#c4a000>resultMap=</span><span style=color:#4e9a06>&#34;BaseResultMap&#34;</span> <span style=color:#c4a000>useCache=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>  
      select * from ATable left join BTable on ....  
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><p>执行以下操作：</p>
<ul>
<li>执行AMapper中的"selectATableWithJoin" 操作，此时会将查询到的结果放置到AMapper对应的二级缓存ACache中；</li>
<li>执行BMapper中对BTable的更新操作(update、delete、insert)后，BTable的数据更新；</li>
<li>再执行1完全相同的查询，这时候会直接从AMapper二级缓存ACache中取值，将ACache中的值直接返回；</li>
</ul>
<p>好，<strong>问题就出现在第3步</strong>上：</p>
<p>由于AMapper的“selectATableWithJoin” 对应的SQL语句需要和BTable进行join查找，而在第 2 步BTable的数据已经更新了，但是第 3 步查询的值是第 1 步的缓存值，已经极有可能跟真实数据库结果不一样，即ACache中缓存数据过期了！</p>
<p>总结来看，就是：</p>
<p>对于某些使用了 join连接的查询，如果其关联的表数据发生了更新，join连接的查询由于先前缓存的原因，导致查询结果和真实数据不同步；</p>
<p>从MyBatis的角度来看，这个问题可以这样表述：</p>
<p><strong>对于某些表执行了更新(update、delete、insert)操作后，如何去清空跟这些表有关联的查询语句所造成的缓存</strong>；</p>
<h3 id=当前mybatis二级缓存的工作机制>当前MyBatis二级缓存的工作机制</h3>
<blockquote>
<p>MyBatis二级缓存的一个重要特点：即松散的Cache缓存管理和维护</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211019224242.png style=display:block;width:80% alt=NAME align=center> </div>
<p>一个Mapper中定义的增删改查操作只能影响到自己关联的Cache对象。如上图所示的Mapper namespace1中定义的若干CRUD语句，产生的缓存只会被放置到相应关联的Cache1中，即Mapper namespace2,namespace3,namespace4 中的CRUD的语句不会影响到Cache1。</p>
<p>可以看出，<strong>Mapper之间的缓存关系比较松散，相互关联的程度比较弱</strong>。</p>
<p>现在再回到上面描述的问题，如果我们将AMapper和BMapper共用一个Cache对象，那么，当BMapper执行更新操作时，可以清空对应Cache中的所有的缓存数据，这样的话，数据不是也可以保持最新吗？</p>
<p>确实这个也是一种解决方案，不过，它会使缓存的使用效率变的很低！AMapper和BMapper的任意的更新操作都会将共用的Cache清空，会频繁地清空Cache，导致Cache实际的命中率和使用率就变得很低了，所以这种策略实际情况下是不可取的。</p>
<p>最理想的解决方案就是：</p>
<p><strong>对于某些表执行了更新(update、delete、insert)操作后，如何去清空跟这些表有关联的查询语句所造成的缓存</strong>; 这样，就是以很细的粒度管理MyBatis内部的缓存，使得缓存的使用率和准确率都能大大地提升。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-91f758c1e325ae2666e56b9f26b9dbb4>18 - CH18-性能优化</h1>
<h2 id=动态条件>动态条件</h2>
<p>通过传入参数动态组装条件语句时，条件可能均为空，常见做法是使用 <code>where 1=1</code> 作为占位符，避免所有条件为空时语法错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getFruitInfo&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Fruit&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  SELECT * FROM Fruit
  WHERE 1=1
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;id!= null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    and id = #{id}
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span> 
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;name!= null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    and name = #{name}
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span> 
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><p>如果 id 和 name 均为 null，则整个语句变成了：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Fruit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>这时数据库就无法使用索引等查询优化策略，被迫对每行数据进行扫描，如果表很大，则性能消耗巨大，推荐的做法是使用 <code>WHERE</code> 标签：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getFruitInfo&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;Fruit&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  SELECT * FROM Fruit
  <span style=color:#204a87;font-weight:700>&lt;WHERE&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;id!= null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    id = #{id}
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span> 
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;name!= null&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    and name = #{name}
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span> 
  <span style=color:#204a87;font-weight:700>&lt;/WHERE&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><p>where 元素知道只有在一个以上的 if 条件有值的情况下才去插入 “where” 子句，且最后的内容如果是 “AND” 或 “OR” 开头的，where 元素也能识别并将它们去除。</p>
<h2 id=批量插入>批量插入</h2>
<p>在使用 foreach 执行批量插入时，如果条目很多，会生成一个很长的 sql 语句，然后再使用实际的条目数据带入，构造出要执行的 sql，这个过程会很慢。</p>
<p>推荐的做法是使用 BATCH 模式执行批量插入：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Service</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PersonService</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SqlSessionFactory</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>insertPersions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>persons</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SqlSession</span> <span style=color:#000>session</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sqlSessionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openSession</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutorType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BATCH</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>PersonMapper</span> <span style=color:#000>mapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PersonMapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Person</span> <span style=color:#000>person</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>persons</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>insert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            
            <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commit</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>session</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearCache</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=where-in-foreach>WHERE IN foreach</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getUserInfo&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;com.test.UserList&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  SELECT age FROM user
  WHERE
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userName!= null and userName.size() &gt;0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    user_name IN
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;userName&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;value&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      #{value}
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><p>但列表可能为空，所以总是在调用之前判空。或者有些同学会以如下方式兼容：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;select</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;getUserInfo&#34;</span> <span style=color:#c4a000>resultType=</span><span style=color:#4e9a06>&#34;com.test.UserList&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
  SELECT age FROM user
  WHERE
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userName!= null and userName.size() &gt;0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    user_name IN
    <span style=color:#204a87;font-weight:700>&lt;foreach</span> <span style=color:#c4a000>collection=</span><span style=color:#4e9a06>&#34;userName&#34;</span> <span style=color:#c4a000>item=</span><span style=color:#4e9a06>&#34;value&#34;</span> <span style=color:#c4a000>separator=</span><span style=color:#4e9a06>&#34;,&#34;</span> <span style=color:#c4a000>open=</span><span style=color:#4e9a06>&#34;(&#34;</span> <span style=color:#c4a000>close=</span><span style=color:#4e9a06>&#34;)&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
      #{value}
    <span style=color:#204a87;font-weight:700>&lt;/foreach&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userName!= null and userName.size() ==0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    1=2
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;if</span> <span style=color:#c4a000>test=</span><span style=color:#4e9a06>&#34;userName!= null and userName.size() ==1&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
    user_name = #{users[0].userName}
  <span style=color:#204a87;font-weight:700>&lt;/if&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/select&gt;</span>
</code></pre></div><p>基于 IN 的性能问题，可以将 IN 改为 JOIN。</p>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>