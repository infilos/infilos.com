<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.93.3">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>3PC | infilos.com</title><meta property="og:title" content="3PC">
<meta property="og:description" content="三阶段提交协议最关键要解决的问题就是 Coordinator 和参与者同时挂掉导致数据不一致的问题，所以 3PC 在 2PC 的基础上又添加了一个阶段：CanCommit、PreCommit、DoCommit。
过程  1：CanCommit  事务轮序：Coordinator 向各个参与者发送 CanCommit 请求，询问是否可以执行事务提交操作，并开始等待所有参与者的响应。 参与者向 Coordinator 反馈询问的响应：参与者收到 CanCommit 请求之后，正常情况下，如果自身认为可以顺利执行事务，那么会返回 Yes 响应并进入预备专题，否则返回 No。  2：PreCommit 执行事务预提交：如果 Coordinator 接收到各个参与者的反馈都是 Yes，那么执行事务预提交：
 发送预提交请求：Coordinator 向各参与者发送 PreCommit 请求，进入 prepared 阶段。 事务预提交：参与者接收到 PreCommit 请求之后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中。 参与者向 Coordinator 反馈事务执行的响应：如果各参与者都成功执行了事务操作，那么反馈给 Coordinator ACK 响应，同时开始等待最终指令：提交 commit 或终止 abort，结束流程。  中断事务：如果任何一个参与者向 Coordinator 反馈了 No 响应，或者在等待超时后，Coordinator 无法接收到所有参与者的反馈，那么就会中断事务。
 发送中断请求：Coordinator 向所有参与者发送 abort 请求。 中断事务：无论收到来自 Coordinator 的 abort 请求，还是等待超时，参与者都中断事务。  3：DoCommit 执行提交：">
<meta property="og:type" content="article">
<meta property="og:url" content="/%E5%88%86%E5%B8%83%E5%BC%8F/base/3pc/"><meta property="article:section" content="分布式">
<meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="3PC">
<meta itemprop=description content="三阶段提交协议最关键要解决的问题就是 Coordinator 和参与者同时挂掉导致数据不一致的问题，所以 3PC 在 2PC 的基础上又添加了一个阶段：CanCommit、PreCommit、DoCommit。
过程  1：CanCommit  事务轮序：Coordinator 向各个参与者发送 CanCommit 请求，询问是否可以执行事务提交操作，并开始等待所有参与者的响应。 参与者向 Coordinator 反馈询问的响应：参与者收到 CanCommit 请求之后，正常情况下，如果自身认为可以顺利执行事务，那么会返回 Yes 响应并进入预备专题，否则返回 No。  2：PreCommit 执行事务预提交：如果 Coordinator 接收到各个参与者的反馈都是 Yes，那么执行事务预提交：
 发送预提交请求：Coordinator 向各参与者发送 PreCommit 请求，进入 prepared 阶段。 事务预提交：参与者接收到 PreCommit 请求之后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中。 参与者向 Coordinator 反馈事务执行的响应：如果各参与者都成功执行了事务操作，那么反馈给 Coordinator ACK 响应，同时开始等待最终指令：提交 commit 或终止 abort，结束流程。  中断事务：如果任何一个参与者向 Coordinator 反馈了 No 响应，或者在等待超时后，Coordinator 无法接收到所有参与者的反馈，那么就会中断事务。
 发送中断请求：Coordinator 向所有参与者发送 abort 请求。 中断事务：无论收到来自 Coordinator 的 abort 请求，还是等待超时，参与者都中断事务。  3：DoCommit 执行提交：">
<meta itemprop=wordCount content="123">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="3PC">
<meta name=twitter:description content="三阶段提交协议最关键要解决的问题就是 Coordinator 和参与者同时挂掉导致数据不一致的问题，所以 3PC 在 2PC 的基础上又添加了一个阶段：CanCommit、PreCommit、DoCommit。
过程  1：CanCommit  事务轮序：Coordinator 向各个参与者发送 CanCommit 请求，询问是否可以执行事务提交操作，并开始等待所有参与者的响应。 参与者向 Coordinator 反馈询问的响应：参与者收到 CanCommit 请求之后，正常情况下，如果自身认为可以顺利执行事务，那么会返回 Yes 响应并进入预备专题，否则返回 No。  2：PreCommit 执行事务预提交：如果 Coordinator 接收到各个参与者的反馈都是 Yes，那么执行事务预提交：
 发送预提交请求：Coordinator 向各参与者发送 PreCommit 请求，进入 prepared 阶段。 事务预提交：参与者接收到 PreCommit 请求之后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中。 参与者向 Coordinator 反馈事务执行的响应：如果各参与者都成功执行了事务操作，那么反馈给 Coordinator ACK 响应，同时开始等待最终指令：提交 commit 或终止 abort，结束流程。  中断事务：如果任何一个参与者向 Coordinator 反馈了 No 响应，或者在等待超时后，Coordinator 无法接收到所有参与者的反馈，那么就会中断事务。
 发送中断请求：Coordinator 向所有参与者发送 abort 请求。 中断事务：无论收到来自 Coordinator 的 abort 请求，还是等待超时，参与者都中断事务。  3：DoCommit 执行提交：">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-123062585-1","auto"),ga("send","pageview"))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head><body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand-lg navbar-dark td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span>
<span class=font-weight-bold>infilos.com</span>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li><li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div></li><li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div></li><li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div></li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li></ul><div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div></div></div></nav></header><div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e58886e5b883e5bc8f-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-e58886e5b883e5bc8f><span>分布式</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e58886e5b883e5bc8fbase-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e58886e5b883e5bc8fbase><span>基本构成</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbaseconsistence-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/consistence/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbaseconsistence><span>一致性模型</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbaseacid-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/acid/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbaseacid><span>ACID 隔离级别</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasecap-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/cap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasecap><span>CAP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasebase-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/base/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasebase><span>BASE</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasecalm-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/calm/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasecalm><span>CALM</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasegossip-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/gossip/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasegossip><span>Gossip</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasecrdt-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/crdt/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasecrdt><span>CRDT</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbase2pc-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/2pc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbase2pc><span>2PC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-e58886e5b883e5bc8fbase3pc-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/3pc/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbase3pc><span class=td-sidebar-nav-active-item>3PC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasepaxos-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/paxos/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasepaxos><span>Paxos</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasezab-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/zab/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasezab><span>ZAB</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbaseraft-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/raft/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbaseraft><span>Raft</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe4b880e887b4-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe4b880e887b4><span>分布式一致性</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe4ba8be58aa1-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe4ba8be58aa1><span>分布式事务</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe4ba8be58aa1e696b9e6a188-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%A1%88/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe4ba8be58aa1e696b9e6a188><span>分布式事务</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee4b880e887b4e680a7e585b1e8af86-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E4%B8%80%E8%87%B4%E6%80%A7%E5%85%B1%E8%AF%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee4b880e887b4e680a7e585b1e8af86><span>一致性与共识算法</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe99481-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe99481><span>分布式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee4b880e887b4e680a7e59388e5b88c-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee4b880e887b4e680a7e59388e5b88c><span>一致性哈希算法</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee585a8e5b180e594afe4b880e6a087e8af86-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee585a8e5b180e594afe4b880e6a087e8af86><span>全局唯一标识</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe8b0ace8afaf-li>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%AC%E8%AF%AF/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e58886e5b883e5bc8fbasee58886e5b883e5bc8fe8b0ace8afaf><span>分布式谬误</span></a>
</li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/infilos/infilos.com/edit/master/content/zh/%e5%88%86%e5%b8%83%e5%bc%8f/base/3pc.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/infilos/infilos.com/new/master/content/zh/%e5%88%86%e5%b8%83%e5%bc%8f/base/3pc.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/infilos/infilos.com/issues/new?title=3PC" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a>
</div><div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#过程>过程</a>
<ul>
<li><a href=#1cancommit>1：CanCommit</a></li><li><a href=#2precommit>2：PreCommit</a></li><li><a href=#3docommit>3：DoCommit</a></li></ul></li><li><a href=#分析>分析</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/>分布式</a>
</li><li class=breadcrumb-item>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/>基本构成</a>
</li><li class="breadcrumb-item active" aria-current=page>
<a href=/%E5%88%86%E5%B8%83%E5%BC%8F/base/3pc/>3PC</a>
</li></ol></nav><div class=td-content>
<h1>3PC</h1><header class=article-meta>
</header><p>三阶段提交协议最关键要解决的问题就是 Coordinator 和参与者同时挂掉导致数据不一致的问题，所以 3PC 在 2PC 的基础上又添加了一个阶段：CanCommit、PreCommit、DoCommit。</p><h2 id=过程>过程</h2><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190224210148.png style=display:block;width:50% alt=NAME align=center> </div><h3 id=1cancommit>1：CanCommit</h3><ol>
<li>事务轮序：Coordinator 向各个参与者发送 CanCommit 请求，询问是否可以执行事务提交操作，并开始等待所有参与者的响应。</li><li>参与者向 Coordinator 反馈询问的响应：参与者收到 CanCommit 请求之后，正常情况下，如果自身认为可以顺利执行事务，那么会返回 Yes 响应并进入预备专题，否则返回 No。</li></ol><h3 id=2precommit>2：PreCommit</h3><p><strong>执行事务预提交</strong>：如果 Coordinator 接收到各个参与者的反馈都是 Yes，那么执行事务预提交：</p><ol>
<li>发送预提交请求：Coordinator 向各参与者发送 PreCommit 请求，进入 prepared 阶段。</li><li>事务预提交：参与者接收到 PreCommit 请求之后，会执行事务操作，并将 Undo 和 Redo 信息记录到事务日志中。</li><li>参与者向 Coordinator 反馈事务执行的响应：如果各参与者都成功执行了事务操作，那么反馈给 Coordinator ACK 响应，同时开始等待最终指令：提交 commit 或终止 abort，结束流程。</li></ol><p><strong>中断事务</strong>：如果任何一个参与者向 Coordinator 反馈了 No 响应，或者在等待超时后，Coordinator 无法接收到所有参与者的反馈，那么就会中断事务。</p><ol>
<li>发送中断请求：Coordinator 向所有参与者发送 abort 请求。</li><li>中断事务：无论收到来自 Coordinator 的 abort 请求，还是等待超时，参与者都中断事务。</li></ol><h3 id=3docommit>3：DoCommit</h3><p><strong>执行提交</strong>：</p><ol>
<li>发送提交事务：假设 Coordinator 正常工作，接收到了所有参与者的 ACK，那么他将从预提交阶段进入提交阶段，并向所有参与者发送 DoCommit 请求。</li><li>事务提交：参与者收到 DoCommit 请求之后，正式提交事务，并在完成事务提交之后释放占用的资源。</li><li>反馈事务提交结果：参与者完成事务提交之后，向 Coordinator 发送 ACK。</li><li>完成事务：Coordinator 接收到所有参与者的 ACK，完成事务。</li></ol><p><strong>中断事务</strong>：假设 Coordinator 正常工作，并且有任一参与者反馈 No，或者在等待超时后无法接受到所有参与者的反馈，都会中断事务：</p><ol>
<li>发送中断请求：Coordinator 向所有参与者节点发送 abort 请求。</li><li>事务回滚：参与者收到 abort 请求之后，利用 undo 日志执行事务回滚，并在完成事务回滚后释放占用资源。</li><li>返回事务回滚结果：参与者在完成事务回滚之后，向 Coordinator 发送 ACK。</li><li>中断事务：Coordinator 接收到所有参与者反馈的 ACK，中断事务。</li></ol><h2 id=分析>分析</h2><p>3PC 虽然解决了 Coordinator 与参与者均异常情况下导致数据不一致的问题，3PC 依然带来了其他问题。比如，网络分区问题，在 PreCommit 消息发出后突然两个机房断开网络，这时 Coordinator 所在机会会 abort，另外剩余的参与者的机房则会 commit。</p><p>而且由于 3PC 的设计过于复杂，在解决 2PC 问题的时候也引入了新的问题，因此实际应用并不广泛。</p><h2 id=reference>Reference</h2><ul>
<li><a href=http://matt33.com/2018/07/08/distribute-system-consistency-protocol/>分布式系统的一致性协议之 2PC 和 3PC</a></li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none>
<h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
Glad to hear it! Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p><p class="feedback--response feedback--response-no">
Sorry to hear that. Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=t=>{if(typeof ga!="function")return;const e={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:t};ga(e.command,e.hitType,e.category,e.action,e.label,e.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script>
<br>
</div></main></div></div><footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 infilos.com All Rights Reserved</small>
</div></div></div></footer></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.3f3f4f1e22307ccbb13271a98be2e4dbb8386b7e67c3d606db44d3d0649f485e.js integrity="sha256-Pz9PHiIwfMuxMnGpi+Lk27g4a35nw9YG20TT0GSfSF4=" crossorigin=anonymous></script>
</body></html>